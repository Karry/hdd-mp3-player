MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE  1


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00001 ;   HLAVNI SOUBOR 
                      00002 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00003 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00004 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00005 ;  MP3 PREPRCAVAC
                      00006 ; ================
                      00007 ; 
                      00008 ; Program mp3 prehravace pouzivajici jako zdroj dat ATA disk.
                      00009 ; 
                      00010 ; Umi identifikovat disk, precist libovolny sektor, v MBR  najit oddily se systemem souboru FAT32, 
                      00011 ; nacist spousteci zaznam FAT32, praci s FAT32, komunikaci s vs1001 a prehravani mp3 pres vs1001.
                      00012 ;
                      00013 ;
                      00014 ; dodelat:
                      00015 ;       - podporu ID3v1
                      00016 ;       - pak uz jen vychytavky...      (napr. do vs1001 naprogramovat ekvalizer a nejak ho ovladat...)
                      00017 ;       - najit a zabit chyby
                      00018 ;
                      00019 ; chyby o kterych vim:
                      00020 ;
                      00021 ; vyreseen chyby:
                      00022 ;       - Pri cteni SCI (registru VS1001k) dochazi k praskani na vystupu a obcas k resetovani dekoderu
                      00023 ;               ...vyreseno postavenim konecne faze hardwaru
                      00024 ;       - pri cteni nekterych clusteru jsou precteny clustery jine
                      00025 ;               ...tato chyba byla zpusobena chybnym scitanim (MPLAB SIM se chova jinak nez PIC - decf u
                             picu nemeni priznak Carry!!!)
                      00026 ;       - Obcas se nechce vs1001k resetovat. Snad tomu pomuze mala hardwarova uprava.
                      00027 ;               ...opravdu tomu znacne pomohlo pridani kondiku a odporu na reset jako u PICu (v datashee
                            tu je tato uprava zminovana jen u vs1002.(?))
                      00028 ;
                      00029 ; srpen 2005 - brezen 2006 Karry - lukas.karas@centrum.cz
                      00030 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00031 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00032 
                      00033 
                      00034 ;**********************************************************
                      00035 ;   VERZE 1.1
                      00036 ;**********************************************************
                      00037 ; !!!!!!!! VSECHNY CASOVE SMYCKY JSOU POCITANY NA Fosc=20MHz !!!!!
                      00038 ; !!!!!!!! NASTAVENI USARTu TAKY !!!!!!!
                      00039         LIST            p=PIC16F877A,C=132,n=60
2007   3F3A           00040         __CONFIG        _WDT_OFF & _HS_OSC & _PWRTE_OFF & _BODEN_OFF & _LVP_OFF 
                      00041                         ; LVP_OFF = RB3 jako digitalni I/O
                      00042         errorlevel -302         ; vypnuti Message [302]: Register in operand not in bank 0.
                      00043         errorlevel -306         ; vypnuti Message[306] : Crossing page boundary -- ensure page bits are 
                            set.
                      00044                                                 ; ! zjednoduseni vypisu, ale riziko prehlednuti chyby
                      00045 ;**********************************************************
                      00046 
                      00047         include "P16F877A.inc"  ; definice blbosti kolem procesoru
                      00001         LIST
                      00002 ; P16F877A.INC  Standard Header File, Version 1.00    Microchip Technology, Inc.
                      00398         LIST
                      00048         include "mp3.inc"               ; definice promennych, konstant a portu
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE  2


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00001 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00002 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00003 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00004 ; DEFINICE PORTU
                      00005 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00006 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00007 ;**********************************************************
                      00008 ; ZAPOJENI PORTU:
                      00009 ;       portA - adresove signaly ATA, ERROR_LED, a USART
                      00010 ;                               5     4     3          2    1    0
                      00011 ;                               CS1-  CS0-  ERROR_LED  DA2  DA1  DA0  
                      00012 ;                               (signaly se znaminkem minus jsou aktivni v logicke 0 !!!)
                      00013 ;               portB - ATA datova sbernice (dolnich 8 bitu)
                      00014 ;               7   .. 0
                      00015 ;               DD7 .. DD0
                      00016 ;               portD - ATA datova sbernice (hornich 8 bitu)
                      00017 ;               15   .. 8
                      00018 ;               DD15 .. DD8 
                      00019 ;               portC - MP3 dekoder vs1001g
                      00020 ;                               7          6        5  4  3    2     1  0
                      00021 ;                               USART out  USART in SI SO SCLK BSYNC CS DREQ
                      00022 ;               portE - ridici signaly ATA
                      00023 ;                               2       1      0
                      00024 ;                               DIOR-   DIOW-  RESET-
                      00025 ;                               (signaly se znaminkem minus jsou aktivni v logicke 0 !!!)
                      00026 ;**********************************************************
  00000007            00027 MP3_PORT                equ PORTC
  00000087            00028 MP3_PORT_TRIS   equ TRISC
                      00029 ; BITY MP3_PORT
                      00030 #define MP3_SO          MP3_PORT,4      ; serial output - tady dostavame z dekoderu data
                      00031 #define MP3_SI          MP3_PORT,5      ; serial input  - pokud MP3_CS=1, tak posilame mp3 data, pokud =
                            0, tak posilame prikaz
                      00032 #define MP3_SCLK        MP3_PORT,3      ; clock - nabezna hrana urcuje platnost dat pri seriovem prenosu
                      00033 #define MP3_CS          MP3_PORT,1      ; cable select  - pokud MP3_CS=1, tak po SI posilame mp3 data, p
                            okud =0, tak posilame prikaz
                      00034 #define MP3_DREQ        MP3_PORT,0      ; data request  - pokud =1, tak dekoder pozaduje dalsi mp3 data
                      00035 #define MP3_BSYNC       MP3_PORT,2      ; pro synchronizaci - ma byt nastaven pri prvnim prenasenem bitu
                             kazdeho bytu
                      00036 ;**********************************************************
                      00037 ; pokud jsem dobre pochopil dataSheat dekoderu vs1001, tak staci do nej jen cpat data, a kdyz skonci mp3
                            , tak odeslat 1024 nulovych bytu,
                      00038 ; softwarove resetovat a posilat dalsi mp3...
                      00039 ;
                      00040 ; popis registru obvodu vs1001 najdete na strane 22 dataSheatu 
                      00041 ; v jeho registrech jsou k dispozici data z hlavicky mp3, zdali mp3 ma spravny format, 
                      00042 ; ovladani hlasitosti a dalsi spousty uzitecnych informaci
                      00043 ;**********************************************************
                      00044 ; PORTY DISKU
  00000005            00045 ATA_ADDRESS             equ PORTA
  00000009            00046 ATA_CONTROL             equ PORTE
  00000006            00047 DATA_PORT_LOW           equ PORTB
  00000008            00048 DATA_PORT_HIGH          equ PORTD
                      00049 
  00000085            00050 ATA_ADDRESS_TRIS        equ TRISA
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE  3


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

  00000089            00051 ATA_CONTROL_TRIS        equ TRISE
  00000086            00052 DATA_PORT_LOW_TRIS      equ TRISB
  00000088            00053 DATA_PORT_HIGH_TRIS     equ TRISD
                      00054 
                      00055 ; bity ATA_ADDRESS portu
                      00056 #define ERROR_LED       ATA_ADDRESS,3
                      00057 ; bity ATA_CONTROL portu
                      00058 #define ATA_RESET_N     ATA_CONTROL,0
                      00059 #define ATA_DIOW_N      ATA_CONTROL,1
                      00060 #define ATA_DIOR_N      ATA_CONTROL,2
                      00061 
                      00062 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00063 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00064 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00065 ; DEFINICE KONSTANT
                      00066 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00067 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00068 ; ADRESY ATA REGISTRU:
                      00069 ;                                                                       / CHS adressing
                      00070 ;   +-----------+--------------+-------------------+-----------------+
                      00071 ;   | CS0- CS1- |  DA2 DA1 DA0 | READ              | WRITE           |   
                      00072 ;   +-----------+--------------+-------------------+-----------------+
                      00073 ;   | 1    1    |  x   x   x   | data bush h.imped (validace prikazu)|
                      00074 ;   +-----------+--------------+-------------------+-----------------+
                      00075 ;   | 1    0    |  1   1   0   | alternate status  | device control  |
                      00076 ;   +-----------+--------------+-------------------+-----------------+
                      00077 ;   | 0    1    |  0   0   0   | data              | data            |
                      00078 ;   | 0    1    |  0   0   1   | error             | features        |
                      00079 ;   | 0    1    |  0   1   0   |             sector count            |
                      00080 ;   | 0    1    |  0   1   1   |             LBA bits 0-7            |  sector number
                      00081 ;   | 0    1    |  1   0   0   |             LBA bits 8-15           |  cilinder LOW 
                      00082 ;   | 0    1    |  1   0   1   |             LBA bits 16-23          |  cilinder HIGH
                      00083 ;   | 0    1    |  1   1   0   |         device / LBA bits 24-27*    |  device, head
                      00084 ;   | 0    1    |  1   1   1   | status            | command         |
                      00085 ;   +-----------+--------------+-------------------+-----------------+
                      00086 ;   | 0    0    |  0   0   0   | invalid addres    | invalid addres  |
                      00087 ;   +-----------+--------------+-------------------+-----------------+
                      00088 ;
                      00089 ;   * 7 6 5 4   3     2     1     0 
                      00090 ;     1 L 1 DEV LBA27 LBA26 LBA25 LBA24
                      00091 ;  L=1 -> aresa je LBA , L=0 -> adresa je CHS
                      00092 ;  DEV=0 -> master , DEV=1 -> SLAVE
                      00093 ;
                      00094 ;  pokud disk podporuje LBA 48, tak je zadavani adresy trochu odlisne od LBA27
                      00095 ;**********************************************************
                      00096 ; toto jsou definice adres ATA registru. Staci udat jejich adresu na ATA_ADDRESS port a dat prikaz ke ct
                            eni ci zapisu (DIOR- / DIOW-)
  00000016            00097 D_STATUS_A    equ b'00010110'
  00000016            00098 D_DEVICE_C    equ D_STATUS_A
  00000020            00099 D_DATA_R      equ b'00100000'
  00000021            00100 D_FEATURES    equ b'00100001'
  00000021            00101 D_ERROR       equ D_FEATURES
  00000022            00102 D_SECTOR_C    equ b'00100010'
  00000023            00103 D_LBA1        equ b'00100011'   ; LBA low
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE  4


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

  00000024            00104 D_LBA2        equ b'00100100'   ; LBA middle
  00000025            00105 D_LBA3        equ b'00100101'   ; LBA high
  00000026            00106 D_DEVICE      equ b'00100110'
  00000027            00107 D_STATUS      equ b'00100111'
  00000027            00108 D_COMMAND     equ D_STATUS
                      00109 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00110 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00111 ; ROZLOZENI PAMETI PROGRAMU
                      00112 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00113 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00114 ;       page 0  0x0000 - 0x07FF
                      00115 ;                               - mp3.asm (hlavni smycka)
                      00116 ;                               - ata.asm
                      00117 ;                               - fat32.asm
                      00118 ;                               - aritmetic.asm
                      00119 ;       page 1  0x0800 - 0x0FFF
                      00120 ;                               - vs1001.asm
                      00121 ;                               - commands.asm
                      00122 ;       page 2  0x1000 - 0x17FF
                      00123 ;       page 3  0x1800 - 0x1FFF
                      00124 ;
                      00125 ; Vsechny podprogramy by mely nechat nastaven PCLATH na hodnotu jak se do nich vstoupilo...
                      00126 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00127 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00128 ; DEFINICE PROMENNYCH
                      00129 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00130 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00131 ; MAPA PAMETI: (368 bytu)
                      00132 ;       BANK 0:         0x000 - 0x01F = specialni registry,
                      00133 ;                               0x020 - 0x07F = misto (96bytu) pro nase registry:
                      00134 ;                                       0x020 - 0x034 -> 21bytu pro registry a parametry HDD
                      00135 ;                                       0x035 - 0x03a -> 6bytu pro parametry podprogramu (musime zajisti
                            t, abychom nepouzivali registry, ktere pouzivaji i podprogramy!!!)
                      00136 ;                                       0x03B - 0x04C -> parametry FATky
                      00137 ;                                       0x04D - 0x050 -> registry pro praci s VS1001
                      00138 ;                                       0x051 - 0xXXX -> ---------------------------
                      00139 ;                                       0x05F - 0x06F -> informace potrebne pro prehravani
                      00140 ;                               0x070 - 0x07F -> registry pro potreby preruseni (dostupne z kterekoliv b
                            anky)
                      00141 ;                                       0x070 - 0x072 -> 3 registry slouzici k zalohovani W, STATUS, FSR
                      00142 ;                                       0x073 - 0x076 -> registry pro prikazy a preruseni + zaloha pro P
                            CLATH
                      00143 ;                                       0x077         -> ---------------------------
                      00144 ;                                       0x078 - 0x07F -> 8 bytu zasobniku prikazu (obsahujici data prika
                            zu prisla po USARTU)
                      00145 ;
                      00146 ;       BANK 1:         0x080 - 0x09F = specialni registry,
                      00147 ;                               0x0A0 - 0x0EF = volne misto (80bytu)
                      00148 ;                                       0x0A0 - 0x0AC -> parametry a navratove hodnoty z aritmeto/logick
                            ych podprogramu
                      00149 ;                                       0x0AD - 0x0EF -> --------------------------- (67bytu)
                      00150 ;
                      00151 ;       BANK 2:         0x100 - 0x10F = specialni registry,
                      00152 ;                               0x110 - 0x16F = misto (96bytu) pro nase registry:
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE  5


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00153 ;                                       0x110 - 0x14F -> 64bytu BUFFER_2 (pro dlouhe nazvy souboru, tabu
                            lku oddilu, a treba pro cast fatky)
                      00154 ;                                       0x150         -> pri cteni dlouheho jmena potrebuju v bufferu2 6
                            5 bytu... (ten 65 je tady)
                      00155 ;                                       0x151 - 0x16F -> --------------------------- (31bytu)
                      00156 ;
                      00157 ;       BANK 3:         0x180 - 0x18F = specialni registry,
                      00158 ;                               0x190 - 0x1EF = misto (96bytu) pro nase registry:
                      00159 ;                                       0x190 - 0x1CF -> 64bytu BUFFER_1 (pro ruzna data pri cteni...)
                      00160 ;                                       0x1D0 - 0x1EF -> --------------------------- (32 bytu)
                      00161 
                      00162 ; prectena ci zapisovana data
  00000020            00163 DATA_L                  equ 0x020 ; res 1
  00000021            00164 DATA_H                  equ 0x021
                      00165 ; HODNOTY ATA REGISTRU 
  00000022            00166 ATA_STATUS_A    equ 0x022
  00000023            00167 DEVICE_C                equ 0x023
  00000024            00168 FEATURES                equ 0x024
  00000025            00169 ATA_ERROR               equ 0x025
  00000026            00170 SECTOR_C                equ 0x026
  00000027            00171 LBA1                    equ 0x027       ; alias  SECTOR_N
  00000028            00172 LBA2                    equ 0x028       ; alias  CILINDER_L
  00000029            00173 LBA3                    equ 0x029       ; alias  CILINDER_H
  0000002A            00174 LBA4                    equ 0x02a       ; toto neni registr ATA, ale pouze posledni cast aktualni adresy
  0000002B            00175 DEVICE                  equ 0x02b       ; alias  DEVICE_H
  0000002C            00176 ATA_STATUS              equ 0x02c
  0000002D            00177 COMMAND                 equ 0x02d
                      00178 ;**********************************************************
                      00179 ; BITY ATA REGISTRU
                      00180          ; ATA_STATUS register
  00000007            00181 BSY                             equ 7   ; = 1 -> disk je zaneprazdneny, ostatni registry nemusi obsahova
                            t pravdivou informaci
  00000006            00182 DRDY                    equ 6   ; = 1 -> disk ready (pripraven k praci)
  00000003            00183 DRQ                             equ 3   ; = 1 -> signalizuje, ze jsou pripravena data ke cteni 
  00000000            00184 ERR                             equ 0   ; = 1 -> pri provadeni posledniho prikazu doslo k chybe
                      00185          ; ATA_ERROR register
  00000002            00186 ABRT                    equ 2   ; = 1 -> prikaz aborted (spatny optkode prikazu)
                      00187          ; DEVICE_C (control) register
  00000002            00188 SRST                    equ 2   ; nastavime-li, provedeme soft. reset disku
  00000001            00189 nEIN                    equ 1   ; zakazuje preruseni disku (signal INTRQ)
  00000007            00190 HOB                             equ 7   ; tento bit DEVICE CONTROL se nastavuje pouze pokud disk podporu
                            je LBA 48 a cteme horni cast adresy LBA...
                      00191 ;**********************************************************
  0000002E            00192 ATA_ATTRIBUTES  equ 0x02e       ; Parametry hardisku. 
                      00193 ;Bity maji nasledujici vyznam:
  00000000            00194 ATA_OK                  equ 0   ; 0. bit = 1 -> disk je pritomen, zapnuty a funkcni :-)
  00000001            00195 LBA_SUPPORT             equ 1   ; 1. bit = 1 -> podpora LBA (pokud neni nastaven bit2, tak pouze LBA28 -
                            > disk do 120GB)
  00000002            00196 LBA48_SUPPORT   equ 2   ; 2. bit = 1 -> podpora LBA 48 (disk je zrejme vetsi jak 120GB)
  00000003            00197 BIG_SECTOR              equ 3   ; 3. bit = 1 -> velikost sektoru je vetsi nez 256 !!! (s takovym diskem 
                            zatim tento program neumi)
  00000004            00198 FAT32_LOAD              equ 4   ; 4. bit = 1 -> FATka byla uspesne analyzovana a udaje o ni jsou pravdiv
                            e
                      00199                                                 ; 5. bit  -> nepouzit
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE  6


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00200                                                 ; 6. bit  -> nepouzit (tyto tri bity treba pouziju pro v
                            lastnosti FATky)
  00000007            00201 APPLICABLE              equ 7   ; 7. bit = 1 -> disk je pro nas pouzitelny (LBA, sektor o 512B)
                      00202 
                      00203 
  0000002F            00204 PARAM_MAX_LBA1  equ 0x02F               ; [4B] maximalni hodnota LBA (velikost disku)   
  00000030            00205 PARAM_MAX_LBA2  equ 0x030               ; tady pozor, disky mohou byt adresovany az LBA 48, MBR je ale o
                            mezen na LBA 32 (2TB)
  00000031            00206 PARAM_MAX_LBA3  equ 0x031               ; tak by nemelo smysl vsech 48b kdyz by se nevyuzily. (Navic jse
                            m disk vetsi nez 2TB nevidel :)
  00000032            00207 PARAM_MAX_LBA4  equ 0x032               ; (registr s indexem 1 ma nejnizsi vahu)
                      00208 
  00000033            00209 PARAM_SLOV_V_SEKTORU1   equ 0x33 ; [2B] disky mohou mit velikost sektoru vetsi nez 512 (256sl) 
  00000034            00210 PARAM_SLOV_V_SEKTORU2   equ 0x34 
                      00211 ; pokud je to zapsano takto, nejvyznamejsi bity jsou niz v paneti (PARAM_MAX_LBA + X)
                      00212 ; pokud je zapsano jako skupina LBA1, LBA2, LBA3, LBA4, tak nejvyznamejsi bity jsou v LBA4
                      00213 ;**********************************************************
                      00214 ; pomocne registry pouzivane v podprogramech 
                      00215 ; !!! MUSIME ZAJISTIT ABY NEBYLY POUZIVANY VE VNORENYCH PODPROGRAMECH !!!
  00000035            00216 TEMPW                   equ 0x035
  00000036            00217 TEMP1                   equ 0x036
  00000037            00218 TEMP2                   equ 0x037
  00000038            00219 TEMP3                   equ 0x038
  00000039            00220 TEMP4                   equ 0x039
  0000003A            00221 TEMP5                   equ 0x03A
                      00222 
                      00223 ; !!! pomocne promenne pro spozdovaci smycky jsou na stejnych mistech
                      00224 ; pouzito pro synchronizaci s prog. picdelay
  00000036            00225 TMP1                    equ 0x036
  00000037            00226 TMP2                    equ 0x037
  00000038            00227 TMP0                    equ 0x038
                      00228 ;**********************************************************
                      00229 ; registry pro praci s FATkou
  0000003B            00230 POZICE                  equ 0x03B               ; na ukladani aktualni pozice v slusteru, pripadne jine 
                            kokotiny
  0000003C            00231 CLUSTER1                equ 0x03C
  0000003D            00232 CLUSTER2                equ 0x03D
  0000003E            00233 CLUSTER3                equ 0x03E
  0000003F            00234 CLUSTER4                equ 0x03F
                      00235 
  00000040            00236 POCATEK_DAT1    equ 0x040
  00000041            00237 POCATEK_DAT2    equ 0x041
  00000042            00238 POCATEK_DAT3    equ 0x042
  00000043            00239 POCATEK_DAT4    equ 0x043
                      00240 
  00000044            00241 POCATEK_FAT1    equ 0x044
  00000045            00242 POCATEK_FAT2    equ 0x045
  00000046            00243 POCATEK_FAT3    equ 0x046
  00000047            00244 POCATEK_FAT4    equ 0x047
                      00245 
  00000048            00246 ROOT_DIR_CL1    equ 0x048
  00000049            00247 ROOT_DIR_CL2    equ 0x049
  0000004A            00248 ROOT_DIR_CL3    equ 0x04A
  0000004B            00249 ROOT_DIR_CL4    equ 0x04B
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE  7


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00250 
  0000004C            00251 CLUSTER_SIZE    equ 0x04C               ; velikost clusteru (pocet sektoru na cluster)
                      00252 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00253 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00254 ; DEFINICE PROMENNYCH a KONSTANT PRO PRACI S VS1001
                      00255 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00256 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00257 ; adresy registru VS1001
  00000000            00258 VSADDR_MODE                     equ .0          ; nastaveni VS1001
  00000001            00259 VSADDR_STATUS           equ .1          ; slouzi pouze pro zapnuti / vypnuti analogove casti (MUTE)
  00000003            00260 VSADDR_CLOCKF           equ .3          ; informuje dekoder o jeho krystalu. !! je nutne pro spravne dek
                            odovani !!
  00000004            00261 VSADDR_DECODE_TIME      equ .4          ; obsahuje cas dekodovani aktualni MP3 !! neaktualizuje se pri s
                            kocich (previjeni)
  00000005            00262 VSADDR_AUDATA           equ .5          ; obsahuje informace o datovem toku a vzorkovaci frekvenci MP3
                      00263         ; bit 15 = 1 => STEREO; = 0 => MONO
                      00264         ; bity 12-9 obsahuji vzorkovaci frekvenci v Hz
                      00265         ;       0000 -> neznama vzorkovaci frekvence
                      00266         ;       0001 -> 44 100
                      00267         ;       0010 -> 48 000
                      00268         ;       0011 -> 32 000
                      00269         ;       0100 -> 22 050
                      00270         ;       0101 -> 24 000 
                      00271         ;       0110 -> 16 000
                      00272         ;       0111 -> 11 025
                      00273         ;       1000 -> 12 000
                      00274         ;       1001 ->  8 000
                      00275         ; bity 8-0 obsahuji bitrate v kbps 
                      00276 
  00000006            00277 VSADDR_WRAM             equ .6                  ; Slouzi k zapisovani uzivatelskeho programu, dato se za
                            pise na adresu v WRAMADDR
  00000007            00278 VSADDR_WRAMADDR equ .7                  ; Adresuje uzivatelskou pamet dekoderu
  00000008            00279 VSADDR_HDAT0    equ .8                  ; Obsahuje informace ziskane z hlavicky MP3
  00000009            00280 VSADDR_HDAT1    equ .9                  ; Obsahuje informace ziskane z hlavicky MP3
  0000000A            00281 VSADDR_AIADDR   equ .10                 ; Start uzivatelskeho programu (vis. datasheet)
  0000000B            00282 VSADDR_VOL              equ .11                 ; ovladani hlasitosti (pro oba kanaly) Horni byte je lev
                            y kanal, dolni byte je pravy kanal
                      00283                                                                 ; (hodnota 0000h znamena hlasitost na ma
                            x., FF00h hraje pouze pravy kanal, FFFFh je ticho)
  0000000D            00284 VSADDR_AICTRL0  equ .13                 ; Registr pro ovladani uzivatelskeho programu
  0000000E            00285 VSADDR_AICTRL1  equ .14                 ; Registr pro ovladani uzivatelskeho programu
                      00286 ;**********************************************************
                      00287 ; registry pro praci s VS1001   
                      00288 ; dekoder VS1001 ma vsechny registry 16bitove, proto za jmeno pisu _L /_H (u nekterych registru potrebuj
                            i pouze jednu cast)
  0000004D            00289 VSREG_MODE_L    equ 0x04D
  0000004E            00290 VSREG_STATUS_L  equ 0x04E
  0000004F            00291 VSREG_VOL_L             equ 0x04F               ; pravy kanal
  00000050            00292 VSREG_VOL_H             equ 0x050               ; levy kanal
                      00293 ;**********************************************************
  00000051            00294 FRAGMENT1               equ 0x051
  00000052            00295 FRAGMENT2               equ 0x052
                      00296 ;**********************************************************
  00000053            00297 PREH_D_FRAGMENT1        equ 0x053
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE  8


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

  00000054            00298 PREH_D_FRAGMENT2        equ 0x054       ; 16bit cislo, ktere udava kolik clusteru mp3 dat po sobe je na 
                            disku nefragmentovano
                      00299                 ; pokazde kdyz prehrajeme cluster, tak toto cislo dekrementujeme. Kdyz dosahneme 0, tak 
                            zjistime dalsi 
                      00300                 ; cluster a pocet nefragmentovanych clusteru. (jak dlouha je rada po sobe jdoucich clust
                            eru)
                      00301 ;                               equ 0x055
                      00302 ;                               equ 0x056
                      00303 ;                               equ 0x057
                      00304 ;                               equ 0x058
                      00305 ;**********************************************************
                      00306 ; registry pro ukladani nastaveni hledani
  00000059            00307 HL_PARAMETRY    equ 0x059
                      00308 ;               0. bit = 0 > pokud hledáme soubory, tak pouze MP3
                      00309 ;                                1 > pokud hledáme soubory, vrací všechny soubory
                      00310 ;               1. bit = 0 > hledáme klasicky (nejdríve adresáre, poté soubory
                      00311 ;                                1 > hledáme pouze adresáre, nebo soubory
                      00312 ;               2. bit = 0 > je-li nastaven 1. bit, hledáme pouze adresáøe
                      00313 ;                                1 > je-li nastaven 1. bit, hledáme pouze soubory
                      00314 ;               3. bit = 0 > hledáme podle cisla zaznamu bud následující ci predchozi zaznam
                      00315 ;                                1 > hledáme první záznam v adresáøi
                      00316 ;               4. bit = 0 > hledáme NÁSLEDUJÍCÍ záznam
                      00317 ;                                1 > hledáme PØEDCHOZÍ záznam
                      00318 ;               7. bit - tento bit nelze nastavit uzivatelem
                      00319 ;                               = 0 > adresar je ROOT
                      00320 ;                               = 1 > adresar neni ROOT
                      00321 
  0000005A            00322 HL_ADR_CL1              equ 0x05A
  0000005B            00323 HL_ADR_CL2              equ 0x05B
  0000005C            00324 HL_ADR_CL3              equ 0x05C
  0000005D            00325 HL_ADR_CL4              equ 0x05D       ; v jakem adresari momentalne vyhledavame
                      00326 
  0000005E            00327 ZAZNAMU_vBUFFERU_DISKU  equ 0x05E       ; sem nam procedura SKOC_NA_ZAZNAM vraci kolik po sobe
                      00328                         ; jdoucich zaznamu nam nechala pripravenych v bufferu na disku
                      00329                         ; (znacne totiz zrychluje praci, protoze pokud chceme cist nasledujici zaznam a 
                            mame ho jiz 
                      00330                         ; v bufferu, memusime znova volat SKOC_NA_ZAZNAM ale rovnou FILE_INFO)
                      00331 ;XXXXXXXXX              equ 0x05F
                      00332 ;**********************************************************
                      00333 ; registry pro praci procedur v filesystem (dalsi registry pozivane proceduramy v filesystem jsou CLUSTE
                            R a POZICE)
  00000060            00334 ZAZNAM1                 equ 0x060
  00000061            00335 ZAZNAM2                 equ 0x061       ; poradi zaznamu v adresari
                      00336 ;**********************************************************
                      00337 ; informace potrebne pro prehravani
  00000062            00338 PREH_ADR_CL1            equ 0x062
  00000063            00339 PREH_ADR_CL2            equ 0x063
  00000064            00340 PREH_ADR_CL3            equ 0x064
  00000065            00341 PREH_ADR_CL4            equ 0x065       ; prni cluster adresare, ktery se prave prehrava...
                      00342 
  00000066            00343 PREH_ZAZNAM1            equ 0x066
  00000067            00344 PREH_ZAZNAM2            equ 0x067       ; poradi zaznamu v adresari ktery se zrovna prehrava (soubor mp3
                            )
                      00345 
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE  9


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

  00000068            00346 PREH_CITAC_PREV         equ 0x068       ; pokud je mp3 previjena pomalu, sem se zapisuje kolik sektoru s
                            e jiz previnulo. 
                      00347                                                                 ; (Pøi pomalém pøevíjení je pomìr pøehra
                            ných sektorù ku pøeskoèeným 5:20.)
                      00348 
  00000069            00349 PREH_DATA_CL1           equ 0x069
  0000006A            00350 PREH_DATA_CL2           equ 0x06A
  0000006B            00351 PREH_DATA_CL3           equ 0x06B
  0000006C            00352 PREH_DATA_CL4           equ 0x06C       ; aktualni cluster, ktery se prehrava
  0000006D            00353 PREH_DATA_POZICE        equ 0x06D       ; sektor v clusteru, ktery se prehrava
                      00354 
  0000006E            00355 PREH_STAV0                      equ 0x06E       ; registr obsahuje informace o stavu aktualniho prehrava
                            ni
                      00356                                 ; 0. bit =      0 => stop nebo pausa (nic nehraje)
                      00357                                 ;                       1 => play            (nejaky soubor je prehravan
                            )
                      00358                                 ; 1. bit =      0 => neni zadny soubor k prehravani (nastaveni bitu play
                             nema zadny ucinek)
                      00359                                 ;                       1 => je soubor pripraven k prehravani (muze byt 
                            ale pauza - nic nehraje)
                      00360                                 ; 2. bit =      1 => je nastaven, kdyz se zmeni prehravany soubor (bez v
                            olani prikazu) do doby, nez prijde prikaz na dotaz STAVU... (81h)
                      00361                                 ; 3. bit =      0 => po skonceni souboru se pokracuje v prehravani (zavi
                            si na nastaveni repeatu)
                      00362                                 ;                       1 => po skonceni prehravani souboru se nic nepre
                            hrava (ceka se na prijeti prikazu k prehravani)
                      00363                                 ; 4. bit =      0 => repeat off
                      00364                                 ;                       1 => repeat on
                      00365                                 ; 5. bit =      0 => repeat adresare (prvni cluster adresare musi byt na
                            staven v PREH_ADDR_ZACATEK_CL[1-4] )
                      00366                                 ;                       1 => repeat souboru (po skonceni prehravani soub
                            oru se ten samy soubor zacne prehravat znova)
                      00367                                 ; 6. bit =      0 => 
                      00368                                 ;                       1 => rezervovano (pro nahodny vyber, nebo jiny r
                            ezim prehravani...)
                      00369                                 ; 7. bit =  0 => 
                      00370                                 ;                       1 => rezervovano
  0000006F            00371 PREH_STAV1                      equ 0x06F
                      00372                                 ; 0. bit =  0 => normalni prehravani
                      00373                                 ;                       1 => previjeni mp3 dopredu
                      00374                                 ; 1. bit =  0 => 
                      00375                                 ;                       1 => rezervovano (pro previjeni dozadu)
                      00376                                 ; 2. bit =      zpusob previjeni,       0 => previji se rychle, potichu
                      00377                                 ;                                                               1 => pre
                            viji se pomalu, vzdy se po nejake dobe kratky usek souboru prehraje
                      00378                                 ; 3. bit =      0 => normalni nastaveni zvuku
                      00379                                 ;                       1 => zvyrazneni basu a vysek (moznost dekoderu v
                            s1001 "bass/treble enhancer")
                      00380                                 ; 4. bit =      0 => NO MUTE
                      00381                                 ;                       1 => MUTE
                      00382                                 ; 5., 6., 7. bit 
                      00383                                 ;                       => rezervovano
                      00384 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00385 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 10


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00386 ; registry pro potreby preruseni + prace s prikazy (jsou totiz dostupne odkudkoliv)
  00000070            00387 TEMP_WORKING    equ 0x070
  00000071            00388 TEMP_STATUS             equ 0x071
  00000072            00389 TEMP_FSR                equ 0x072
  00000073            00390 PRIJATYCH_DAT   equ 0x073               ; ukazuje kolik je platnych dat v zasobniku prikazu (0 -> zasobn
                            ik je prazdny)
  00000074            00391 PRIJATE_DATO    equ 0x074               ; pomocna promenna v preruseni
  00000075            00392 STAV_PRIKAZU    equ 0x075               ; pomocny registr signalizujici stav prikazu umisteneho v zasobn
                            iku prikazu
                      00393                                                                 ; pokud zadna procedura nenastavi do 1, 
                            je prikaz v tuto chvili neplatny
                      00394                                                                 ; pokud prikaz je pro proceduru ale nama
                             zatim dost parametru, muji tento byt nastavit take do 1
  00000076            00395 TEMP_PCLATH             equ 0x076
                      00396 ; 0x078 - 0x07F         -> zasobnik prikazu (data prisla po USARTU)
                      00397 ;**********************************************************
                      00398 ; BANK_1        s touto bankou pracuji procedury provadejici 32 bitove 
                      00399 ;                       aritmeto/logicke operace
  000000A0            00400 OPERAND_X1              equ 0x0A0
  000000A1            00401 OPERAND_X2              equ 0x0A1
  000000A2            00402 OPERAND_X3              equ 0x0A2
  000000A3            00403 OPERAND_X4              equ 0x0A3
                      00404 
  000000A4            00405 OPERAND_Y1              equ 0x0A4
  000000A5            00406 OPERAND_Y2              equ 0x0A5
  000000A6            00407 OPERAND_Y3              equ 0x0A6
  000000A7            00408 OPERAND_Y4              equ 0x0A7
                      00409 
  000000A8            00410 VYSLEDEK1               equ 0x0A8
  000000A9            00411 VYSLEDEK2               equ 0x0A9
  000000AA            00412 VYSLEDEK3               equ 0x0AA
  000000AB            00413 VYSLEDEK4               equ 0x0AB
                      00414 
  000000AC            00415 PRETECENI               equ 0x0AC
                      00416 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00417 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00418 ; MAKRA
                      00419 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00420 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00421 BANK_0  macro                                   ; prepnuti do banky 0 v pameti dat
                      00422                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
                      00423                 bcf     STATUS,RP0    
                      00424                 endm
                      00425 BANK_1  macro                                   ; prepnuti do banky 1 v pameti dat
                      00426                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
                      00427                 bsf     STATUS,RP0    
                      00428                 endm
                      00429 BANK_2  macro                                   ; prepnuti do banky 2 v pameti dat
                      00430                 bsf     STATUS,RP1              ; BANK2  RP1:RP0 = 10
                      00431                 bcf     STATUS,RP0    
                      00432                 endm
                      00433 BANK_3  macro                                   ; prepnuti do banky 3 v pameti dat
                      00434                 bsf     STATUS,RP1              ; BANK3  RP1:RP0 = 11
                      00435                 bsf     STATUS,RP0    
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 11


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00436                 endm
                      00437 ; INDF_BANK_x slouzi k prepinani bank pro neprime adresovani pomoci INDF a FSR
                      00438 INDF_BANK_0     macro               
                      00439                         bcf STATUS,IRP    
                      00440                         endm
                      00441 INDF_BANK_1     macro               
                      00442                         bcf STATUS,IRP    
                      00443                         endm
                      00444 INDF_BANK_2     macro             
                      00445                         bsf STATUS,IRP    
                      00446                         endm
                      00447 INDF_BANK_3     macro             
                      00448                         bsf STATUS,IRP    
                      00449                         endm
                      00450 ;**********************************************************
                      00451 PROG_PAGE_0     macro             
                      00452                         bcf PCLATH,3
                      00453                         bcf PCLATH,4
                      00454                         endm
                      00455 PROG_PAGE_1     macro             
                      00456                         bsf PCLATH,3
                      00457                         bcf PCLATH,4
                      00458                         endm
                      00459 PROG_PAGE_2     macro             
                      00460                         bcf PCLATH,3
                      00461                         bsf PCLATH,4
                      00462                         endm
                      00463 PROG_PAGE_3     macro             
                      00464                         bsf PCLATH,3
                      00465                         bsf PCLATH,4
                      00466                         endm
                      00467 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00049 
                      00050 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00051 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00052 ; PROGRAM
                      00053 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00054 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00055 ;**********************************************************
0000                  00056  org 0x0000                                     ; PAGE 0
0000   2810           00057         goto START
0004                  00058  org 0x0004                                     ; PAGE 0
0004   00F0           00059         movwf TEMP_WORKING
0005   0803           00060         movfw STATUS
0006   00F1           00061         movwf TEMP_STATUS
0007   0804           00062         movfw FSR
0008   00F2           00063         movwf TEMP_FSR
0009   080A           00064         movfw PCLATH
000A   00F6           00065         movwf TEMP_PCLATH
000B   018A           00066         clrf PCLATH
                      00067         BANK_0
000C   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
000D   1283               M                 bcf     STATUS,RP0    
                      00068         INDF_BANK_0
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 12


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

000E   1383               M                         bcf STATUS,IRP    
000F   29D3           00069         goto INTERRUPT
                      00070 ;**********************************************************
0010                  00071  org 0x0010                                     ; PAGE 0
                      00072         include "mp3.asm"               ; hlavni programova smycka
0010                  00001 START
0010   2178           00002         call INIT_CONFIG        ; nakonfiguruje preruseni, WDT, USART, pull ups...
0011   2165           00003         call INIT_PORT          ; nastavy trisy, a porty do vychozi polohy
                      00004 
0012   2369           00005         call DELAY_25us         ; chvili pockame, protoze napjeti zdroje co mam doma (stary PC-AT zdroj)
0013   2369           00006         call DELAY_25us         ; zezacatku dost kolisa...
0014   2369           00007         call DELAY_25us
                      00008 
                      00009 ;       call POZDRAV                            ; abych se u kompu nenudil
                      00010 
                      00011         PROG_PAGE_1
0015   158A               M                         bsf PCLATH,3
0016   120A               M                         bcf PCLATH,4
0017   20D2           00012         call VS_INIT
                      00013         PROG_PAGE_0
0018   118A               M                         bcf PCLATH,3
0019   120A               M                         bcf PCLATH,4
                      00014 
001A   22C3           00015         call ATA_RESET                          ; resetujeme disk, koukneme zda tu nejakej mame
001B   1C2E           00016         btfss ATA_ATTRIBUTES,ATA_OK
001C   281A           00017         goto $-2                                        ; pokud neni pripojen disk, tak se jej pokousime
                             neustale najit...
001D   0000           00018         nop                                                     ; ...pokud tam zadny disk neni, tak bych
                            om se stejne ani sem nemeli dostat, protoze budem porad cekat na WAIT_FOR_READY
                      00019 
001E   2316           00020         call IDENTIFY_DEVICE            ; koukneme co disk umi
                      00021 
001F                  00022 CEK_PRIKAZ_01h
                      00023         PROG_PAGE_1
001F   158A               M                         bsf PCLATH,3
0020   120A               M                         bcf PCLATH,4
0021   20E6           00024         call CEKEJ_PRIKAZ
                      00025         PROG_PAGE_0
0022   118A               M                         bcf PCLATH,3
0023   120A               M                         bcf PCLATH,4
                      00026 
                      00027 
0024   0878           00028         movfw 0x078                                     ; prvni byte prikazoveho zasobniku
0025   01F3           00029         clrf PRIJATYCH_DAT                      ; prikaz byl vybran -> prazdny zasobnik
0026   3C01           00030         sublw h'01'                                     ; ...pokud to byl prikaz 01h...
0027   1D03           00031         btfss STATUS,Z
0028   281F           00032         goto CEK_PRIKAZ_01h
                      00033 
0029   082E           00034         movfw ATA_ATTRIBUTES            ; ...vodesleme zpet vlastnosti disku a jeho jmenovku (vis. popis
                             protokolu)
002A   2193           00035         call WR_USART
002B   21AE           00036         call ODESLI_MODEL_NUMBER        ; odesleme jmeno disku 
                      00037 
002C   2374           00038         call SCAN_MBR                           ; najdeme oddily s FAT32 a jejich seznam dame do bufferu
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 13


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                             2
002D                  00039 CEK_PRIKAZ_02h_03h
                      00040         PROG_PAGE_1
002D   158A               M                         bsf PCLATH,3
002E   120A               M                         bcf PCLATH,4
002F   20E6           00041         call CEKEJ_PRIKAZ                       ; pockame si na prikaz
0030   01F5           00042         clrf STAV_PRIKAZU                       ; smazeme registr signalizujici platnost prikazu
0031   20EB           00043         call PRIKAZ_02h                         ; testujeme zda prisel prikaz 02h, pokud ano tak jej pro
                            vedeme a nastavime platnost prikazu
0032   210C           00044         call PRIKAZ_03h                         ; ---//---
                      00045         PROG_PAGE_0
0033   118A               M                         bcf PCLATH,3
0034   120A               M                         bcf PCLATH,4
0035   1C75           00046         btfss STAV_PRIKAZU,0            ; Pokud si zadna z procedur prikaz neprevzala, ...
0036   01F3           00047         clrf PRIJATYCH_DAT                      ; ...vymazeme zasobnik prikazu. (prikaz neni pro tuto ch
                            vili platny)
0037   1E2E           00048         btfss ATA_ATTRIBUTES,FAT32_LOAD ; cekame dokud nedojde k nasteni nejakeho oddilu
0038   282D           00049         goto CEK_PRIKAZ_02h_03h         ; pokud byl oddil vporadku nacten, pokracujeme...
                      00050 
0039   01EE           00051         clrf PREH_STAV0
                      00052 ;*******************************************************************************************************
                            *************
                      00053 ;*******************************************************************************************************
                            *************
                      00054 ;*******************************************************************************************************
                            *************
                      00055 ;*******************************************************************************************************
                            *************
003A                  00056 BIG_LOOP
                      00057         ; Tady ta smycka beha po nacteni disku a nejake FATky porad dokola.
                      00058         ; Pri kazdem prubehu smyckou vyresime prikazy, ktere prisly, a pokud prehravame 
                      00059         ; nejakou mp3 tak dekoder nakrmime jednim sektorem...
                      00060         ; Mimo to je v teto smycce osefovano, ze kdyz skonci mp3, nacteme dalsi... (v zavislosti na nast
                            aveni repeatu)
003A   0873           00061         movfw PRIJATYCH_DAT
003B   39FF           00062         andlw h'FF'
003C   1903           00063         btfsc STATUS,Z
003D   2853           00064         goto BIG_LOOP__NENI_PRIKAZ
                      00065         
003E   01F5           00066         clrf STAV_PRIKAZU                       ; smazeme registr signalizujici platnost prikazu
                      00067         ; Pokud jsme tady, tak prisel nejaky prikaz, jdem predat prikaz jednotlivym proceduram
                      00068         PROG_PAGE_1
003F   158A               M                         bsf PCLATH,3
0040   120A               M                         bcf PCLATH,4
0041   212A           00069         call PRIKAZ_04h                         ; testujeme zda prisel prikaz 04h, pokud ano tak jej pro
                            vedeme a nastavime platnost prikazu
0042   2137           00070         call PRIKAZ_05h                         ; --- // ---
0043   2168           00071         call PRIKAZ_06h                         ; --- // ---
0044   218A           00072         call PRIKAZ_07h                         ; --- // ---
0045   21B1           00073         call PRIKAZ_08h                         ; --- // ---
0046   21DF           00074         call PRIKAZ_09h                         ; --- // ---
0047   2212           00075         call PRIKAZ_0Ah                         ; --- // ---
0048   2240           00076         call PRIKAZ_0Bh                         ; --- // ---
0049   2262           00077         call PRIKAZ_0Ch                         ; --- // ---
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 14


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00078 
004A   229E           00079         call PRIKAZ_80h                         ; --- // ---
004B   230A           00080         call PRIKAZ_81h                         ; --- // ---
004C   2329           00081         call PRIKAZ_82h                         ; --- // ---
004D   233F           00082         call PRIKAZ_83h                         ; --- // ---
004E   2373           00083         call PRIKAZ_84h                         ; --- // ---
                      00084         PROG_PAGE_0
004F   118A               M                         bcf PCLATH,3
0050   120A               M                         bcf PCLATH,4
                      00085         
0051   1C75           00086         btfss STAV_PRIKAZU,0            ; Pokud si zadna z procedur prikaz neprevzala, ...
0052   01F3           00087         clrf PRIJATYCH_DAT                      ; ...vymazeme zasobnik prikazu. (prikaz neni pro tuto ch
                            vili platny)
                      00088 
0053                  00089 BIG_LOOP__NENI_PRIKAZ
                      00090 
0053   1C6E           00091         btfss PREH_STAV0,0                      ; Pokud je zvoleno play,...
0054   28CC           00092         goto MP3_NOT_PLAY
                      00093 
0055   1CEE           00094         btfss PREH_STAV0,1                      ; ...a je co prehravat...
0056   28CC           00095         goto MP3_NOT_PLAY
                      00096         
0057   086D           00097         movfw PREH_DATA_POZICE
0058   024C           00098         subwf CLUSTER_SIZE,W
0059   1D03           00099         btfss STATUS,Z                          ; ...podivame se zda jiz nejsme na konci clusteru...
005A   288F           00100         goto SEND_MP3_DATA
                      00101 
005B   0853           00102         movfw PREH_D_FRAGMENT1          ; ...pokud ano, podivame se zda nejsme na posledni casti fragmen
                            tu...
005C   0454           00103         iorwf PREH_D_FRAGMENT2,w
005D   1D03           00104         btfss STATUS,Z
005E   287F           00105         goto BIG_LOOP_DEC_FRAGMENT      ; ...pokud ne, tak PREH_D_FRAGMENT1-- ; PREH_DATA_CL++
                      00106 
005F   0869           00107         movfw PREH_DATA_CL1                     ; ...pokud jo, tak si najdeme dalsi cluster v retezci.
0060   00BC           00108         movwf CLUSTER1
0061   086A           00109         movfw PREH_DATA_CL2
0062   00BD           00110         movwf CLUSTER2
0063   086B           00111         movfw PREH_DATA_CL3
0064   00BE           00112         movwf CLUSTER3
0065   086C           00113         movfw PREH_DATA_CL4
0066   00BF           00114         movwf CLUSTER4
                      00115 
0067   01ED           00116         clrf PREH_DATA_POZICE
0068   255E           00117         call NEXT_CLUSTER
0069   083C           00118         movfw CLUSTER1
006A   00E9           00119         movwf PREH_DATA_CL1
006B   083D           00120         movfw CLUSTER2
006C   00EA           00121         movwf PREH_DATA_CL2
006D   083E           00122         movfw CLUSTER3
006E   00EB           00123         movwf PREH_DATA_CL3
006F   083F           00124         movfw CLUSTER4
0070   00EC           00125         movwf PREH_DATA_CL4
                      00126         
0071   1C3B           00127         btfss POZICE,0                          ; Pokud byl cluster posledni v retezci...
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 15


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0072   2879           00128         goto BIG_LOOP_DALSI_FRAGMENT
                      00129 
0073   20CD           00130         call DALSI_SKLADBA                      ; ...tak najdeme dalsi soubor co se ma prehrat (pokud je
                             nastaven repeat a dalsi kraviny)
                      00131         ; otestujeme zda se ma nejaka dalsi mp3 prehravat
0074   1C6E           00132         btfss PREH_STAV0,0                      ; Je zvoleno play?
0075   28CC           00133         goto MP3_NOT_PLAY
0076   1CEE           00134         btfss PREH_STAV0,1                      ; Je co prehravat?
0077   28CC           00135         goto MP3_NOT_PLAY
0078   288F           00136         goto SEND_MP3_DATA
                      00137 
0079                  00138 BIG_LOOP_DALSI_FRAGMENT
0079   25E6           00139         call ZJISTI_FRAGMENT
                      00140 
007A   0851           00141         movfw FRAGMENT1
007B   00D3           00142         movwf PREH_D_FRAGMENT1
007C   0852           00143         movfw FRAGMENT2
007D   00D4           00144         movwf PREH_D_FRAGMENT2
                      00145 
                      00146         ;movlw 'F'
                      00147         ;call WR_USART
                      00148 
007E   288F           00149         goto SEND_MP3_DATA
007F                  00150 BIG_LOOP_DEC_FRAGMENT
                      00151         ; PREH_D_FRAGMENT1 --
007F   3001           00152         movlw .1
0080   02D3           00153         subwf PREH_D_FRAGMENT1,f
0081   1803           00154         btfsc STATUS,C
0082   2884           00155         goto $+2
0083   02D4           00156         subwf PREH_D_FRAGMENT2,f
                      00157 
                      00158         ; PREH_DATA_CL ++
0084   0AE9           00159         incf PREH_DATA_CL1,f
0085   1D03           00160         btfss STATUS,Z
0086   288E           00161         goto $+8
0087   0AEA           00162         incf PREH_DATA_CL2,f
0088   1D03           00163         btfss STATUS,Z
0089   288E           00164         goto $+5
008A   0AEB           00165         incf PREH_DATA_CL3,f
008B   1D03           00166         btfss STATUS,Z
008C   288E           00167         goto $+2
008D   0AEC           00168         incf PREH_DATA_CL4,f
                      00169 
008E   01ED           00170         clrf PREH_DATA_POZICE
                      00171 
008F                  00172 SEND_MP3_DATA
008F   1C6F           00173         btfss PREH_STAV1,0                      ; 0. bit = 1 => previjeni mp3 dopredu
0090   28AA           00174         goto NOT_MP3_REWIND_FORWARD
0091   14CD           00175         bsf VSREG_MODE_L,1                      ; fast forward on
                      00176 
0092   1D6F           00177         btfss PREH_STAV1,2                      ; 2. bit = 1 => previji se pomalu, vzdy se po nejake dob
                            e kratky usek souboru prehraje  
0093   289E           00178         goto MP3_REWIND_FORWARD
                      00179 
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 16


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0094   0868           00180         movfw PREH_CITAC_PREV           ; MP3 previjime pomalu...
0095   3C14           00181         sublw .20                                       ; ...podivame se kolik sektoru jsme previnuly...
0096   1803           00182         btfsc STATUS,C                          ; ...pokud jich je vic jak 20...
0097   289E           00183         goto MP3_REWIND_FORWARD         ; 
                      00184         
0098   10CD           00185         bcf VSREG_MODE_L,1                      ; ...tak dalsi pustime normalne. (fast forward off)
                      00186 
0099   0868           00187         movfw PREH_CITAC_PREV
009A   3C19           00188         sublw .25
009B   1D03           00189         btfss STATUS,Z                          ; pokud jsme jich uz normalne pustily 5, ... (25-20)
009C   289E           00190         goto MP3_REWIND_FORWARD
                      00191 
009D   01E8           00192         clrf PREH_CITAC_PREV            ; ...vymazeme citac previjeni (zas nejaky sektory pustime rychle
                            )
009E                  00193 MP3_REWIND_FORWARD
009E   3000           00194         movlw VSADDR_MODE
009F   00B6           00195         movwf TEMP1
00A0   084D           00196         movfw VSREG_MODE_L
00A1   00B7           00197         movwf TEMP2
00A2   01B8           00198         clrf TEMP3
                      00199         PROG_PAGE_1     
00A3   158A               M                         bsf PCLATH,3
00A4   120A               M                         bcf PCLATH,4
00A5   2063           00200         call VS_WR_REG
                      00201         PROG_PAGE_0
00A6   118A               M                         bcf PCLATH,3
00A7   120A               M                         bcf PCLATH,4
                      00202         
00A8   196F           00203         btfsc PREH_STAV1,2                      ; 2. bit = 1 => previji se pomalu, vzdy se po nejake dob
                            e kratky usek souboru prehraje  
00A9   0AE8           00204         incf PREH_CITAC_PREV,f
00AA                  00205 NOT_MP3_REWIND_FORWARD
                      00206 
00AA   0869           00207         movfw PREH_DATA_CL1                     ; Mame zjisteny cluster a jeho cast, kterou mame prehrav
                            at...
00AB   00BC           00208         movwf CLUSTER1
00AC   086A           00209         movfw PREH_DATA_CL2
00AD   00BD           00210         movwf CLUSTER2
00AE   086B           00211         movfw PREH_DATA_CL3
00AF   00BE           00212         movwf CLUSTER3
00B0   086C           00213         movfw PREH_DATA_CL4
00B1   00BF           00214         movwf CLUSTER4
00B2   086D           00215         movfw PREH_DATA_POZICE
00B3   00BB           00216         movwf POZICE
                      00217 
00B4   24FB           00218         call CLUSTER_TO_LBA                     ; zjistime si skutecnou polohu dat na disku...
00B5   3001           00219         movlw .1
00B6   00A6           00220         movwf SECTOR_C
00B7   22DE           00221         call READ_SECTOR                        ; dame prikaz precist data...
                      00222 
00B8   1487           00223         bsf MP3_CS                                      ; po SI posilam data
00B9   3000           00224         movlw .0                                        ; posilame celkem 256 slov
00BA   00B6           00225         movwf TEMP1             
00BB                  00226 SEND_MP3_WORD
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 17


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00227         PROG_PAGE_1
00BB   158A               M                         bsf PCLATH,3
00BC   120A               M                         bcf PCLATH,4
00BD   20AB           00228         call WAIT_FOR_VSDREQ
                      00229         PROG_PAGE_0
00BE   118A               M                         bcf PCLATH,3
00BF   120A               M                         bcf PCLATH,4
00C0   2286           00230         call READ_DATA
00C1   0820           00231         movfw DATA_L
                      00232         PROG_PAGE_1
00C2   158A               M                         bsf PCLATH,3
00C3   120A               M                         bcf PCLATH,4
00C4   2000           00233         call VS_WR_BYTE
00C5   0821           00234         movfw DATA_H
00C6   2000           00235         call VS_WR_BYTE
                      00236         PROG_PAGE_0
00C7   118A               M                         bcf PCLATH,3
00C8   120A               M                         bcf PCLATH,4
00C9   0BB6           00237         decfsz TEMP1,f  
00CA   28BB           00238         goto SEND_MP3_WORD
                      00239 
00CB   0AED           00240         incf PREH_DATA_POZICE,f
00CC                  00241 MP3_NOT_PLAY
                      00242 
00CC   283A           00243         goto BIG_LOOP
                      00244 ;*******************************************************************************************************
                            *************
                      00245 ;*******************************************************************************************************
                            *************
                      00246 ;*******************************************************************************************************
                            *************
                      00247 ;*******************************************************************************************************
                            *************
00CD                  00248 DALSI_SKLADBA
                      00249         ; tato procedura je volana, kdyz skonci mp3, aby nasla v adresari dalsi mp3 ktera se ma prehrava
                            t...
00CD   106E           00250         bcf PREH_STAV0,0                ; 0. bit =      0 => stop nebo pausa (nic nehraje)
00CE   10EE           00251         bcf PREH_STAV0,1                ; 1. bit =      0 => neni zadny soubor k prehravani (nastaveni b
                            itu play nema zadny ucinek)
00CF   116E           00252         bcf PREH_STAV0,2                ; 2. bit =      1 => je nastaven, kdyz se zmeni prehravany soubo
                            r (bez volani prikazu) do doby, nez prijde prikaz na dotaz STAVU... (81h)
00D0   106F           00253         bcf PREH_STAV1,0                ; 0. bit =  0 => normalni prehravani (mp3 se nepreviji)
00D1   19EE           00254         btfsc PREH_STAV0,3              ; 3. bit =      0 => po skonceni souboru se pokracuje v prehrava
                            ni (zavisi na nastaveni repeatu)
00D2   0008           00255         return
                      00256 
                      00257 ; PREH_STAV0
                      00258 ;       4. bit =        0 => repeat off
                      00259 ;                               1 => repeat on
                      00260 ;       5. bit =        0 => repeat adresare (prvni cluster adresare musi byt nastaven v PREH_ADDR_ZACAT
                            EK_CL[1-4] )
                      00261 ;                               1 => repeat souboru (po skonceni prehravani souboru se ten samy soubor z
                            acne prehravat znova)
00D3   1E6E           00262         btfss PREH_STAV0,4
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 18


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

00D4   2907           00263         goto DALSI_SKLADBA_NO_R_S
00D5   1EEE           00264         btfss PREH_STAV0,5
00D6   2907           00265         goto DALSI_SKLADBA_NO_R_S       
00D7                  00266 DALSI_SKLADBA_REPAT_SOUBORU
00D7   0862           00267         movfw PREH_ADR_CL1
00D8   00BC           00268         movwf CLUSTER1
00D9   0863           00269         movfw PREH_ADR_CL2
00DA   00BD           00270         movwf CLUSTER2
00DB   0864           00271         movfw PREH_ADR_CL3
00DC   00BE           00272         movwf CLUSTER3
00DD   0865           00273         movfw PREH_ADR_CL4
00DE   00BF           00274         movwf CLUSTER4
00DF   0866           00275         movfw PREH_ZAZNAM1
00E0   00E0           00276         movwf ZAZNAM1
00E1   0867           00277         movfw PREH_ZAZNAM2
00E2   00E1           00278         movwf ZAZNAM2
                      00279 
                      00280         PROG_PAGE_1
00E3   158A               M                         bsf PCLATH,3
00E4   120A               M                         bcf PCLATH,4
00E5   23E1           00281         call SKOC_NA_ZAZNAM
                      00282         PROG_PAGE_0
00E6   118A               M                         bcf PCLATH,3
00E7   120A               M                         bcf PCLATH,4
00E8   183B           00283         btfsc POZICE,0                          ; tento test by tu byt nemusel, protoze jsme jiz tento s
                            oubor hrali, jeden ale nikdy nevi...
00E9   0008           00284         return
                      00285         PROG_PAGE_1
00EA   158A               M                         bsf PCLATH,3
00EB   120A               M                         bcf PCLATH,4
00EC   2461           00286         call FILE_INFO
                      00287         PROG_PAGE_0
00ED   118A               M                         bcf PCLATH,3
00EE   120A               M                         bcf PCLATH,4
                      00288 
                      00289         INDF_BANK_2
00EF   1783               M                         bsf STATUS,IRP    
                      00290         ; ...nastavime jej jako prehravany soubor.
00F0   301C           00291         movlw 0x1C                                      ; 13. byte bufferu 2
00F1   0084           00292         movwf FSR
00F2   0800           00293         movfw INDF
00F3   00E9           00294         movwf PREH_DATA_CL1
00F4   00BC           00295         movwf CLUSTER1
00F5   0A84           00296         incf FSR,f
00F6   0800           00297         movfw INDF
00F7   00EA           00298         movwf PREH_DATA_CL2
00F8   00BD           00299         movwf CLUSTER2
00F9   0A84           00300         incf FSR,f
00FA   0800           00301         movfw INDF
00FB   00EB           00302         movwf PREH_DATA_CL3
00FC   00BE           00303         movwf CLUSTER3
00FD   0A84           00304         incf FSR,f
00FE   0800           00305         movfw INDF
00FF   00EC           00306         movwf PREH_DATA_CL4
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 19


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0100   00BF           00307         movwf CLUSTER4
                      00308 
0101   25E6           00309         call ZJISTI_FRAGMENT
                      00310 
0102   0851           00311         movfw FRAGMENT1
0103   00D3           00312         movwf PREH_D_FRAGMENT1
0104   0852           00313         movfw FRAGMENT2
0105   00D4           00314         movwf PREH_D_FRAGMENT2
                      00315 
0106   2953           00316         goto DALSI_SKLADBA_PLAY         ; nic jineho nemusime nastavovat, protoze hrajeme ten samy soubo
                            r co predtim
0107                  00317 DALSI_SKLADBA_NO_R_S
                      00318 ; PREH_STAV0
                      00319 ;       4. bit =        0 => repeat off
                      00320 ;                               1 => repeat on
                      00321 ;       5. bit =        0 => repeat adresare (prvni cluster adresare musi byt nastaven v PREH_ADDR_ZACAT
                            EK_CL[1-4] )
                      00322 ;                               1 => repeat souboru (po skonceni prehravani souboru se ten samy soubor z
                            acne prehravat znova)
                      00323         ; tak ted jdem hledat dalsi soubor v adresari...
                      00324         
                      00325 ;       HL_PARAMETRY    -- parametry hledani
                      00326 ;       HL_ADR_CL[1-4]  -- prnvi cluster prohledavaneho adresare
                      00327 ;       ZAZNAM[1-2]             -- zaznam od ktereho hledame
0107   3006           00328         movlw b'00000110'
0108   00D9           00329         movwf HL_PARAMETRY
0109   0862           00330         movfw PREH_ADR_CL1
010A   00DA           00331         movwf HL_ADR_CL1
010B   0863           00332         movfw PREH_ADR_CL2
010C   00DB           00333         movwf HL_ADR_CL2
010D   0864           00334         movfw PREH_ADR_CL3
010E   00DC           00335         movwf HL_ADR_CL3
010F   0865           00336         movfw PREH_ADR_CL4
0110   00DD           00337         movwf HL_ADR_CL4
0111   0866           00338         movfw PREH_ZAZNAM1
0112   00E0           00339         movwf ZAZNAM1
0113   0867           00340         movfw PREH_ZAZNAM2
0114   00E1           00341         movwf ZAZNAM2
                      00342         
                      00343         PROG_PAGE_1
0115   158A               M                         bsf PCLATH,3
0116   120A               M                         bcf PCLATH,4
0117   24F9           00344         call HLEDEJ
                      00345         PROG_PAGE_0     
0118   118A               M                         bcf PCLATH,3
0119   120A               M                         bcf PCLATH,4
                      00346 
                      00347         INDF_BANK_2
011A   1783               M                         bsf STATUS,IRP    
011B   3030           00348         movlw 0x30
011C   0084           00349         movwf FSR
011D   0800           00350         movfw INDF
011E   3C06           00351         sublw h'06'
011F   1903           00352         btfsc STATUS,Z
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 20


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0120   2936           00353         goto DALSI_SKLADBA_MAME_SOUBOR
                      00354 
                      00355         ; zadny dalsi mp3 soubor v adresari neni...
0121   1E6E           00356         btfss PREH_STAV0,4                              ; ..podivame se, zda neni nastaven repeat slozky
0122   0008           00357         return
                      00358 
                      00359         ; je nastaven repeat slozky a uz neni co prehravat. Jdem hledat prvni mp3 ve slozce...
                      00360 
                      00361         ; HL_PARAMETRY
                      00362         ;               7. bit - tento bit nelze nastavit uzivatelem
                      00363         ;                               = 0 > adresar je ROOT
                      00364         ;                               = 1 > adresar neni ROOT 
0123   3006           00365         movlw b'00000110'                               ; parametry hledani, pokud hledame prvni mp3 adr
                            esari ktery neni ROOT 
                      00366                                                                         ; (prvni zaznam je ukazatel na p
                            redchozi adresar)
0124   1FD9           00367         btfss HL_PARAMETRY,7
0125   300E           00368         movlw b'00001110'                               ; parametry hledani, pokud hledame prvni mp3 v R
                            OOT adresari (prvni zaznam)
0126   00D9           00369         movwf HL_PARAMETRY
                      00370 
0127   3001           00371         movlw h'01'                                             ; prvni cluster prohledavaneho adresare 
                            mame jiz nastaven,
0128   00E0           00372         movwf ZAZNAM1                                   ; parametry taky, ted jen zaznam od klereho hled
                            ame... 
0129   01E1           00373         clrf ZAZNAM2                                    ; (pokud hledame v ROOTu, hledame prvni zaznam)
                      00374 
                      00375         PROG_PAGE_1
012A   158A               M                         bsf PCLATH,3
012B   120A               M                         bcf PCLATH,4
012C   24F9           00376         call HLEDEJ
                      00377         PROG_PAGE_0     
012D   118A               M                         bcf PCLATH,3
012E   120A               M                         bcf PCLATH,4
                      00378 
                      00379         INDF_BANK_2
012F   1783               M                         bsf STATUS,IRP    
0130   3030           00380         movlw 0x30
0131   0084           00381         movwf FSR
0132   0800           00382         movfw INDF
0133   3C06           00383         sublw h'06'
0134   1D03           00384         btfss STATUS,Z
0135   0008           00385         return                                                  ; sem bychom se nemeli dostat, protoze k
                            dyz uz neco hralo, tak tu nejaky soubor musi byt?!
                      00386         ;goto DALSI_SKLADBA_MAME_SOUBOR
0136                  00387 DALSI_SKLADBA_MAME_SOUBOR
                      00388         INDF_BANK_2
0136   1783               M                         bsf STATUS,IRP    
0137   303C           00389         movlw 0x3C
0138   0084           00390         movwf FSR
0139   0800           00391         movfw INDF
013A   00E9           00392         movwf PREH_DATA_CL1
013B   00BC           00393         movwf CLUSTER1
013C   0A84           00394         incf FSR,f
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 21


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

013D   0800           00395         movfw INDF
013E   00EA           00396         movwf PREH_DATA_CL2
013F   00BD           00397         movwf CLUSTER2
0140   0A84           00398         incf FSR,f
0141   0800           00399         movfw INDF
0142   00EB           00400         movwf PREH_DATA_CL3
0143   00BE           00401         movwf CLUSTER3
0144   0A84           00402         incf FSR,f
0145   0800           00403         movfw INDF
0146   00EC           00404         movwf PREH_DATA_CL4
0147   00BF           00405         movwf CLUSTER4
0148   0A84           00406         incf FSR,f
0149   0800           00407         movfw INDF
014A   00E6           00408         movwf PREH_ZAZNAM1
014B   0A84           00409         incf FSR,f
014C   0800           00410         movfw INDF
014D   00E7           00411         movwf PREH_ZAZNAM2
                      00412 
014E   25E6           00413         call ZJISTI_FRAGMENT
                      00414 
014F   0851           00415         movfw FRAGMENT1
0150   00D3           00416         movwf PREH_D_FRAGMENT1
0151   0852           00417         movfw FRAGMENT2
0152   00D4           00418         movwf PREH_D_FRAGMENT2
                      00419 
                      00420 
0153                  00421 DALSI_SKLADBA_PLAY
0153   01ED           00422         clrf PREH_DATA_POZICE
0154   146E           00423         bsf PREH_STAV0,0
0155   14EE           00424         bsf PREH_STAV0,1                        ; nastavime si vlastosti prehravani: (PREH_STAV[0-1])
0156   156E           00425         bsf PREH_STAV0,2
                      00426 
                      00427         PROG_PAGE_1
0157   158A               M                         bsf PCLATH,3
0158   120A               M                         bcf PCLATH,4
0159   207F           00428         call VS_SOFT_RESET
                      00429 
015A   10CD           00430         bcf VSREG_MODE_L,1                      ; prehravame normalni rychlosti 
015B   106F           00431         bcf PREH_STAV1,0                        ; prehravame normalni rychlosti 
                      00432         
015C   3000           00433         movlw VSADDR_MODE
015D   00B6           00434         movwf TEMP1
015E   084D           00435         movfw VSREG_MODE_L
015F   00B7           00436         movwf TEMP2
0160   01B8           00437         clrf TEMP3
0161   2063           00438         call VS_WR_REG
                      00439         PROG_PAGE_0
0162   118A               M                         bcf PCLATH,3
0163   120A               M                         bcf PCLATH,4
                      00440         
0164   0008           00441         return
                      00442 ;*******************************************************************************************************
                            *************
0165                  00443 INIT_PORT
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 22


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00444         BANK_1
0165   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0166   1683               M                 bsf     STATUS,RP0    
                      00445 
0167   3091           00446         movlw b'10010001'                       ; bity SO a DREQ jako vstupy (signaly z dekoderu)
0168   0087           00447         movwf MP3_PORT_TRIS
0169   3000           00448         movlw b'00000000'                       ; adresovani disku jako vystupy
016A   0085           00449         movwf ATA_ADDRESS_TRIS          
016B   3000           00450         movlw .0
016C   0089           00451         movwf ATA_CONTROL_TRIS          ; ovladani disku jako vystupy
016D   30FF           00452         movlw 0xff
016E   0086           00453         movwf DATA_PORT_LOW_TRIS        ; datovou sbernici jako vstupy
016F   0088           00454         movwf DATA_PORT_HIGH_TRIS       
                      00455         BANK_0
0170   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0171   1283               M                 bcf     STATUS,RP0    
                      00456         
0172   3007           00457         movlw b'00000111'       ; signal reset-, diow- a dior- jsou aktivni v log. 0 !!!
0173   0089           00458         movwf ATA_CONTROL
0174   3037           00459         movlw b'00110111'       ; CS1-, CS0- = 1 => datova sbernice disku je odpojena
0175   0085           00460         movwf ATA_ADDRESS
0176   0187           00461         clrf MP3_PORT   
0177   0008           00462         return
                      00463 ;**********************************************************
0178                  00464 INIT_CONFIG     ; nakonfiguruje preruseni, WDT, USART, pull ups....
                      00465         BANK_1
0178   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0179   1683               M                 bsf     STATUS,RP0    
017A   30C7           00466         movlw b'11000111'       ; ...pull up a podobny koniny
                      00467                 ; PORTB Pull-up Enable bit              1 = pull up enabled
                      00468                 ; Interrupt Edge Select bit             1 = interrupt on rising edge of RB0/INT pin
                      00469                 ; TMR0 Clock Source Select bit  0 = Internal instruction cycle clock (CLKO)
                      00470                 ; TMR0 Source Edge Select bit   0 = Increment on low-to-high transition on RA4/T0CKI pin
                      00471                 ; Prescaler Assignment bit              0 = Prescaler is assigned to the Timer0 module
                      00472                 ; PS2:PS0: Prescaler Rate Select bits   111 = TMR0 Rate 1 : 256; WDT Rate 1 : 128
017B   0081           00473         movwf OPTION_REG
                      00474         
017C   3020           00475         movlw b'00100000'       ; povolime preruseni od USARTu (kdyz neco dostanem)
017D   008C           00476         movwf PIE1      
017E   3000           00477         movlw b'00000000'       ; ostatni vnejsi preruseni vymaskujeme
017F   008D           00478         movwf PIE2                      
                      00479 
0180   30C0           00480         movlw b'11000000'       ; povolime preruseni na vnejsi zarizeni (USART)                         
0181   008B           00481         movwf INTCON
                      00482 
0182   3026           00483         movlw b'00100110'       ;konfigurace USARTu (asynchronni, 8bit, bez parity, rychle - (BRGH = 1))
0183   0098           00484         movwf TXSTA
                      00485         BANK_0
0184   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0185   1283               M                 bcf     STATUS,RP0    
0186   3090           00486         movlw b'10010000'       ;zapnu USART
0187   0098           00487         movwf RCSTA
                      00488         BANK_1
0188   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 23


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0189   1683               M                 bsf     STATUS,RP0    
018A   3081           00489         movlw .129              ; Fosc = 20 MHz, BRGH=1 => rychlost = 9615 bps
                      00490         ;movlw .103     ; Fosc = 16 MHz, BRGH=1 => rychlost = 9615 bps
018B   0099           00491         movwf SPBRG     
                      00492 
018C   3007           00493         movlw b'00000111'
018D   009F           00494         movwf ADCON1            ; vsechny vstupy (RA,RE) jako digitalni
                      00495         BANK_0  
018E   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
018F   1283               M                 bcf     STATUS,RP0    
0190   019F           00496         clrf ADCON0                     ; pro jistotu (vypneme A/D prevodniky)
                      00497 
0191   01F3           00498         clrf PRIJATYCH_DAT      ; zasobnik prikazu prazdny...
0192   0008           00499         return
                      00500 ;**********************************************************
0193                  00501 WR_USART        ; odesle slovo ve workingu po USARTu
                      00502                         ; prijimani dat je reseno prez preruseni...
                      00503         BANK_1  
0193   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0194   1683               M                 bsf     STATUS,RP0    
0195   1C98           00504         btfss TXSTA,1 
0196   2993           00505         goto WR_USART   ; cekame do chvile nez bude pripraven transmit buffer 
                      00506 
                      00507         BANK_0  
0197   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0198   1283               M                 bcf     STATUS,RP0    
0199   0099           00508         movwf TXREG
019A   0008           00509         return
                      00510 ;**********************************************************
                      00511 ; tento podprogram bude pro budouci praci zbytecny, je zde jen proto, abych na PC videl ze program byl s
                            pusten...
019B                  00512 POZDRAV  ; odesle po seriove lince pozdrav
019B   3041           00513         movlw 'A'       
019C   2193           00514         call WR_USART
019D   3068           00515         movlw 'h'
019E   2193           00516         call WR_USART
019F   306F           00517         movlw 'o'
01A0   2193           00518         call WR_USART
01A1   306A           00519         movlw 'j'
01A2   2193           00520         call WR_USART
01A3   3021           00521         movlw '!'
01A4   2193           00522         call WR_USART
01A5   0008           00523         return
                      00524 ;**********************************************************
                      00525 ; odesle data, ktera jdou z disku USARTEM. Pocet dat je v reg. TEMP1
01A6                  00526 ODESLI_DATA
01A6   2286           00527         call READ_DATA  
01A7   0820           00528         movfw DATA_L
01A8   2193           00529         call WR_USART
01A9   0821           00530         movfw DATA_H
01AA   2193           00531         call WR_USART   
01AB   0BB6           00532         decfsz TEMP1,F
01AC   29A6           00533         goto ODESLI_DATA
01AD   0008           00534         return
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 24


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00535 ;**********************************************************
01AE                  00536 ODESLI_MODEL_NUMBER     ; Podprogram IDENTIFY_DEVICE nam do bufferu 1 hodil jmeno disku
                      00537                         ; mi jej ted odesleme USARTem, aby mohl byt zobrazen na displeji
                      00538         INDF_BANK_3     ; BUFFER_1 je v bance 3
01AE   1783               M                         bsf STATUS,IRP    
01AF   3090           00539         movlw 0x90      ; na adrese 90
01B0   0084           00540         movwf FSR
01B1   3014           00541         movlw .20       ; budeme odesilat 20 slov (40 znaku)
01B2   00B6           00542         movwf TEMP1
01B3                  00543 ODESLI_MODEL_NUMBER_ODESILANI
01B3   0800           00544         movfw INDF
01B4   00B7           00545         movwf TEMP2     ; data do bufferu byla vkladana stylem DATA_L, DATA_H, DATA_L, DATA_H...
01B5   0A84           00546         incf FSR,F      ; ASCII hodnoty jsou ale razeny stylem DATA_H, DATA_L, DATA_H, DATA_L...
01B6   0800           00547         movfw INDF      ; proto to pisu tak slozite...
01B7   0A84           00548         incf FSR,F
                      00549         
01B8   2193           00550         call WR_USART
01B9   0837           00551         movfw TEMP2
01BA   2193           00552         call WR_USART   
                      00553 
01BB   0BB6           00554         decfsz TEMP1,F
01BC   29B3           00555         goto ODESLI_MODEL_NUMBER_ODESILANI
                      00556 
                      00557         INDF_BANK_0     
01BD   1383               M                         bcf STATUS,IRP    
01BE   0008           00558         return
                      00559 ;**********************************************************
01BF                  00560 ODESLI_BUFF2_HIGH
                      00561         ; odesle z horni poloviny bufferu2 tolik bytu, kolik je v TEMP1
                      00562         INDF_BANK_2     ; BUFFER_2 je v bance 2
01BF   1783               M                         bsf STATUS,IRP    
01C0   3030           00563         movlw 0x30      ; horni pulka od adresy 30h
01C1   0084           00564         movwf FSR
01C2                  00565 ODESLI_BUFF2_HIGH_ODESILANI
01C2   0800           00566         movfw INDF
01C3   2193           00567         call WR_USART
01C4   0A84           00568         incf FSR,F      
01C5   0BB6           00569         decfsz TEMP1,F
01C6   29C2           00570         goto ODESLI_BUFF2_HIGH_ODESILANI
                      00571 
                      00572         INDF_BANK_0             
01C7   1383               M                         bcf STATUS,IRP    
01C8   0008           00573         return
                      00574 ;**************************************************************************
01C9                  00575 ODESLI_BUFFER2
                      00576         ; v TEMP1 ocakava hodnotu kolik bytu ma odeslat
                      00577         INDF_BANK_2     ; BUFFER_2 je v bance 2
01C9   1783               M                         bsf STATUS,IRP    
01CA   3010           00578         movlw 0x10      ; na adrese 10
01CB   0084           00579         movwf FSR
01CC                  00580 ODESLI_BUFFER2_ODESILANI
01CC   0800           00581         movfw INDF
01CD   2193           00582         call WR_USART
01CE   0A84           00583         incf FSR,F      
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 25


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

01CF   0BB6           00584         decfsz TEMP1,F
01D0   29CC           00585         goto ODESLI_BUFFER2_ODESILANI
                      00586 
                      00587         INDF_BANK_0             
01D1   1383               M                         bcf STATUS,IRP    
01D2   0008           00588         return
                      00589 ;**********************************************************
01D3                  00590 INTERRUPT                                       ; sem se skace po zavolani preruseni (uz jsou vyreseny u
                            lohy dulezitych registru)
01D3   1E8C           00591         btfss PIR1,RCIF                 ; Meli bychom mit povoleno sice jen jedno preruseni (od USARTU),
                             jeden ale nikdy nevi, proto ten test
01D4   29E1           00592         goto END_OF_INTERRUPT   ; Pokud nejde o preruseni od USARTU, tak koncime...
01D5   081A           00593         movfw RCREG                             ; !!! vynulovat pøíznak !!!     
01D6   00F4           00594         movwf PRIJATE_DATO
                      00595 
01D7   0873           00596         movfw PRIJATYCH_DAT
01D8   3C07           00597         sublw .7                                ; pokud je v zasobniku uz plno (PRIJATYCH_DAT=8), tak ko
                            ncime
01D9   1C03           00598         btfss STATUS,C
01DA   29E1           00599         goto END_OF_INTERRUPT   ; Zasobnik je plny, nic prijimat nebudeme
                      00600 
01DB   0873           00601         movfw PRIJATYCH_DAT
01DC   3E78           00602         addlw 0x78                              ; zacatek zasobniku prikazu
01DD   0084           00603         movwf FSR
01DE   0874           00604         movfw PRIJATE_DATO              ; prijmuta data -> do W
01DF   0080           00605         movwf INDF                              ; prijate dato na prvni volne misto v zasobniku
                      00606         
01E0   0AF3           00607         incf  PRIJATYCH_DAT,F   ; pricteme k indikaci zasobniku
                      00608 ;       movlw '['
                      00609 ;       call WR_USART
                      00610 ;       movfw PRIJATYCH_DAT
                      00611 ;       addlw .48
                      00612 ;       call WR_USART
                      00613 ;       movlw ']'
                      00614 ;       call WR_USART   
01E1                  00615 END_OF_INTERRUPT                        ; sem skocime kdyz mame vsechny veci kolem preruseni vyrizeny
01E1   0876           00616         movfw TEMP_PCLATH
01E2   008A           00617         movwf PCLATH
01E3   0872           00618         movfw TEMP_FSR
01E4   0084           00619         movwf FSR
01E5   0871           00620         movfw TEMP_STATUS
01E6   0083           00621         movwf STATUS
01E7   0870           00622         movfw TEMP_WORKING
01E8   0009           00623         retfie
                      00624 ;**********************************************************
01E9                  00625 DELAY_2ms
                      00626 ; (Fosc = 20 MHz , instr. cyklus= 200 ns) 2 000us / 0.2  us = 10 000 instrukcnich cyklu
                      00627 ;Variables: TMP1, TMP0
                      00628 ;Delay 10001 cycles
01E9   3010           00629         MOVLW 0x10  ;16 DEC
01EA   00B6           00630         MOVWF TMP1
01EB   30CF           00631         MOVLW 0x0CF  ;207 DEC
01EC   00B8           00632         MOVWF TMP0
01ED   0BB8           00633         DECFSZ TMP0,F
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 26


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

01EE   29ED           00634         GOTO $-1
01EF   0BB6           00635         DECFSZ TMP1,F
01F0   29EB           00636         GOTO $-5
                      00637 ;End of Delay
01F1   0008           00638         return
                      00639 ;**********************************************************
01F2                  00640 DELAY_200ms
                      00641 ; (Fosc = 20 MHz , instr. cyklus= 200 ns) 200 000us / 0.2  us = 1 000 000 instrukcnich cyklu
                      00642 ;Variables: TMP2, TMP1, TMP0
                      00643 ;Delay 1000000 cycles
01F2   3015           00644         MOVLW 0x15  ;21 DEC
01F3   00B7           00645         MOVWF TMP2
01F4   3059           00646         MOVLW 0x59  ;89 DEC
01F5   00B6           00647         MOVWF TMP1
01F6   30B1           00648         MOVLW 0x0B1  ;177 DEC
01F7   00B8           00649         MOVWF TMP0
01F8   0BB8           00650         DECFSZ TMP0,F
01F9   29F8           00651         GOTO $-1
01FA   0BB6           00652         DECFSZ TMP1,F
01FB   29F6           00653         GOTO $-5
01FC   0BB7           00654         DECFSZ TMP2,F
01FD   29F4           00655         GOTO $-9
                      00656 ;End of Delay
01FE   0008           00657         return
                      00658 ;**********************************************************
01FF                  00659 DELAY_500ms
                      00660 ; (Fosc = 16 MHz , instr. cyklus= 250 ns) 500 000us / 0.25 us = 2 000 000 instrukcnich cyklu
                      00661 ; (Fosc = 20 MHz , instr. cyklus= 200 ns) 500 000us / 0.2  us = 2 500 000 instrukcnich cyklu
                      00662 ;Variables: TMP2, TMP1, TMP0
                      00663 ;Delay 2500001 cycles
01FF   3028           00664         MOVLW 0x28  ;40 DEC
0200   00B7           00665         MOVWF TMP2
0201   307E           00666         MOVLW 0x7E  ;126 DEC
0202   00B6           00667         MOVWF TMP1
0203   30A4           00668         MOVLW 0x0A4  ;164 DEC
0204   00B8           00669         MOVWF TMP0
0205   0BB8           00670         DECFSZ TMP0,F
0206   2A05           00671         GOTO $-1
0207   0BB6           00672         DECFSZ TMP1,F
0208   2A03           00673         GOTO $-5
0209   0BB7           00674         DECFSZ TMP2,F
020A   2A01           00675         GOTO $-9
                      00676 ;End of Delay
020B   0008           00677         return
                      00678 ;**********************************************************
                      00073         include "ata.asm"               ; podprogramy na ovladani ATA disku
                      00001 ;**********************************************************
                      00002 ;**********************************************************
                      00003 ;**********************************************************
                      00004 ; OBSLUZNE PODPROGRAMY PRO ATA
                      00005 ;**********************************************************
                      00006 ;**********************************************************
                      00007 ;**********************************************************
                      00008 
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 27


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00009 ;**********************************************************
                      00010 ; cteni a zapis ATA registru 
                      00011 ;**********************************************************
020C                  00012 RD_STATUS         
020C   3027           00013         movlw D_STATUS      ; Status 
020D   2263           00014         call RUTR 
020E   00AC           00015         movwf ATA_STATUS
020F   0008           00016         return
                      00017 ;*****************************************
0210                  00018 RD_ERROR
0210   3021           00019         movlw D_ERROR      ; Error
0211   2263           00020         call RUTR
0212   00A5           00021         movwf ATA_ERROR
0213   0008           00022         return
                      00023 ;*****************************************
0214                  00024 RD_STATUS_A     
0214   3016           00025         movlw D_STATUS_A    ; Alternate Status 
0215   2263           00026         call RUTR 
0216   00A2           00027         movwf ATA_STATUS_A
0217   0008           00028         return
                      00029 ;*****************************************
0218                  00030 RD_SC
0218   3022           00031         movlw D_SECTOR_C    ; Sector Count
0219   2263           00032         call RUTR
021A   00A6           00033         movwf SECTOR_C
021B   0008           00034         return
                      00035 ;*****************************************
021C                  00036 RD_LBA1
021C   3023           00037         movlw D_LBA1    ; Sector Number 
021D   2263           00038         call RUTR                
021E   00A7           00039         movwf LBA1 
021F   0008           00040         return
                      00041 ;*****************************************
0220                  00042 RD_LBA2
0220   3024           00043         movlw D_LBA2  ; Cylinder Low
0221   2263           00044         call RUTR
0222   00A8           00045         movwf LBA2
0223   0008           00046         return
                      00047 ;*****************************************
0224                  00048 RD_LBA3
0224   3025           00049         movlw D_LBA3  ; Cylinder High   
0225   2263           00050         call RUTR
0226   00A9           00051         movwf LBA3
0227   0008           00052         return
                      00053 ;*****************************************
0228                  00054 RD_DEVICE
0228   3026           00055         movlw D_DEVICE  ; Device Head
0229   2263           00056         call RUTR
022A   00AB           00057         movwf DEVICE
022B   0008           00058         return
                      00059 ;*****************************************
                      00060 ;*****************************************
022C                  00061 WR_DC
022C   0823           00062         movf DEVICE_C,w     ; Device Control
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 28


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

022D   00B5           00063         movwf TEMPW
022E   3016           00064         movlw D_DEVICE_C
022F   2270           00065         call RUTW
0230   0008           00066         return
                      00067 ;*****************************************
0231                  00068 WR_COMMAND          
0231   082D           00069         movf COMMAND,w      ; Command       
0232   00B5           00070         movwf TEMPW
0233   3027           00071         movlw D_COMMAND
0234   2270           00072         call RUTW
0235   0008           00073         return
                      00074 ;*****************************************
0236                  00075 WR_SC                    
0236   0826           00076     movf SECTOR_C,w     ; Sector Count
0237   00B5           00077         movwf TEMPW
0238   3022           00078         movlw D_SECTOR_C     
0239   2270           00079         call RUTW
023A   0008           00080         return
                      00081 ;*****************************************
023B                  00082 WR_LBA1
023B   0827           00083         movf LBA1,w     
023C   00B5           00084         movwf TEMPW
023D   3023           00085         movlw D_LBA1    
023E   2270           00086         call RUTW
023F   0008           00087         return
                      00088 ;*****************************************
0240                  00089 WR_LBA2
0240   0828           00090         movf LBA2,w   ; Cylinder Low
0241   00B5           00091         movwf TEMPW
0242   3024           00092         movlw D_LBA2
0243   2270           00093         call RUTW
0244   0008           00094         return
                      00095 ;*****************************************
0245                  00096 WR_LBA3
0245   0829           00097         movf LBA3,w   ; Cylinder High
0246   00B5           00098         movwf TEMPW
0247   3025           00099         movlw D_LBA3
0248   2270           00100         call RUTW
0249   0008           00101         return
                      00102 ;*****************************************
024A                  00103 WR_DEVICE
024A   082B           00104         movf DEVICE,w     ; Device Head 
024B   00B5           00105         movwf TEMPW
024C   3026           00106         movlw D_DEVICE
024D   2270           00107         call RUTW
024E   0008           00108         return
                      00109 ;*****************************************
024F                  00110 WR_FEATURES
024F   0824           00111         movf FEATURES,w     ; Features
0250   00B5           00112         movwf TEMPW
0251   3021           00113         movlw D_FEATURES
0252   2270           00114         call RUTW
0253   0008           00115         return
                      00116 ;*****************************************
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 29


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00117 ; zapise vsechny registry potrebne k vykonani prikazu (adresove registry a prikaz)
0254                  00118 WR_BLOCK
                      00119 ;       call WAIT_FOR_READY_FOR_COMMAND
0254   220C           00120         call RD_STATUS
0255   182C           00121         btfsc ATA_STATUS,ERR
0256   2A5B           00122         goto $+5                                        ; Nastal error disku. Co budeme delat? S*r*m* na
                             to a jdeme dal
0257   1BAC           00123         btfsc ATA_STATUS,BSY
0258   2A54           00124         goto $-4                                        ; Bsy <> 0, cekame dal 
0259   1F2C           00125         btfss ATA_STATUS,DRDY
025A   2A54           00126         goto $-6
                      00127 
025B   224F           00128         call WR_FEATURES
025C   2236           00129         call WR_SC
025D   223B           00130         call WR_LBA1
025E   2240           00131         call WR_LBA2
025F   2245           00132         call WR_LBA3
0260   224A           00133         call WR_DEVICE
0261   2231           00134         call WR_COMMAND
0262   0008           00135         return
                      00136 ;*****************************************
                      00137 ; ve workingu mame adresu registru ktery mame precist, 
                      00138 ; pak v nem vracime jeho hodnotu...
0263                  00139 RUTR          
0263   0085           00140         movwf ATA_ADDRESS                  ; adresa pozadovaneho registru
                      00141 
                      00142         BANK_1
0264   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0265   1683               M                 bsf     STATUS,RP0    
0266   30FF           00143     movlw 0xFF
0267   0086           00144     movwf DATA_PORT_LOW_TRIS   ; z datove zbernice cteme
0268   0088           00145     movwf DATA_PORT_HIGH_TRIS
                      00146         BANK_0
0269   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
026A   1283               M                 bcf     STATUS,RP0    
                      00147 
026B   1109           00148         bcf ATA_DIOR_N
026C   0000           00149     nop                                                 ; PIO delay min. 120ns (PIO 4)  
026D   0806           00150     movfw DATA_PORT_LOW                 ; Read DD0..D7 IDE
026E   1509           00151         bsf ATA_DIOR_N
                      00152 
026F   0008           00153     return
                      00154 ;**********************************************************
                      00155 ; ve workingu mame adresu registru ktery mame zapsat,
                      00156 ; a v reg. TEMPW hodnotu kterou mame do tohoto registru zapsat
0270                  00157 RUTW
0270   0085           00158         movwf ATA_ADDRESS
                      00159 
                      00160         BANK_1
0271   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0272   1683               M                 bsf     STATUS,RP0    
0273   3000           00161     movlw 0x0
0274   0086           00162     movwf DATA_PORT_LOW_TRIS   ; do datove sbernice zapisujeme
0275   0088           00163     movwf DATA_PORT_HIGH_TRIS
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 30


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00164         BANK_0
0276   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0277   1283               M                 bcf     STATUS,RP0    
                      00165 
0278   0835           00166     movf TEMPW,w        
0279   0086           00167     movwf DATA_PORT_LOW                 ; Write DD0..DD7 IDE 
027A   0188           00168         clrf DATA_PORT_HIGH
                      00169 
027B   1089           00170         bcf ATA_DIOW_N
027C   0000           00171         nop
027D   1489           00172         bsf ATA_DIOW_N
                      00173           
                      00174         BANK_1
027E   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
027F   1683               M                 bsf     STATUS,RP0    
0280   30FF           00175     movlw 0xff
0281   0086           00176     movwf DATA_PORT_LOW_TRIS   ; datova sbernice na cteni
0282   0088           00177     movwf DATA_PORT_HIGH_TRIS
                      00178         BANK_0
0283   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0284   1283               M                 bcf     STATUS,RP0    
                      00179 
0285   0008           00180         return
                      00181 ;**********************************************************
0286                  00182 READ_DATA
                      00183 ;       call WAIT_FOR_DATA      ; tento odskok do dalsich podprogramu si nemohu, dovolit, protoze mam je
                            n 8bit STACK
                      00184         ; Wait: ( Bsy=0 AND Drq=1 ) OR err=1
                      00185         ; 7   6    5  4   3   2    1   0
                      00186         ; BSY DRDY DF DSC DRQ CORR IDX ERR
                      00187         ; (cekame az disk bude mit pro nas prichystana data)
0286   3027           00188         movlw D_STATUS      ; Status 
0287   2263           00189         call RUTR 
0288   00AC           00190         movwf ATA_STATUS
0289   182C           00191         btfsc ATA_STATUS,ERR
028A   2A8F           00192         goto READ_DATA_CTEME            ; Nastal error disku. Co budeme delat? S*r*m* na to a data prect
                            eme...
                      00193 
028B   1BAC           00194         btfsc ATA_STATUS,BSY
028C   2A86           00195         goto READ_DATA                          ; Bsy <> 0, cekame dal 
                      00196         
028D   1DAC           00197         btfss ATA_STATUS,DRQ
028E   2A86           00198         goto READ_DATA                          ; Drq <> 1, cekame dal 
                      00199         
028F                  00200 READ_DATA_CTEME
                      00201 
028F   3020           00202     movlw D_DATA_R
0290   0085           00203         movwf ATA_ADDRESS
                      00204 
                      00205         BANK_1
0291   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0292   1683               M                 bsf     STATUS,RP0    
0293   30FF           00206     movlw 0xFF
0294   0086           00207     movwf DATA_PORT_LOW_TRIS   ; z datove zbernice cteme
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 31


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0295   0088           00208     movwf DATA_PORT_HIGH_TRIS
                      00209         BANK_0
0296   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0297   1283               M                 bcf     STATUS,RP0    
                      00210 
0298   1109           00211         bcf ATA_DIOR_N
0299   0000           00212     nop                                                 ; PIO delay min. 120ns (PIO 4)  
029A   0000           00213         nop
029B   0806           00214     movfw DATA_PORT_LOW                 ; Read DD0..D7 IDE
029C   00A0           00215         movwf DATA_L
029D   0808           00216     movfw DATA_PORT_HIGH                ; Read DD8..D15 IDE
029E   00A1           00217         movwf DATA_H
029F   1509           00218         bsf ATA_DIOR_N
                      00219 
02A0   0008           00220     return
                      00221 ;**********************************************************
                      00222 ; stava se, ze obcas nas zajima jen cast vracenych dat, tak ty ktere nas nezajimaji, preskocime
                      00223 ; ocakava parametr v registru TEMP1 (kolik slov ma preskocit)
                      00224 ; pokud TEMP1 = 0 tak preskoci 256 slov
02A1                  00225 PRESKOC
02A1   2286           00226         call READ_DATA
02A2   0BB6           00227         decfsz TEMP1,F
02A3   2AA1           00228         goto PRESKOC
02A4   0008           00229         return
                      00230 ;**********************************************************
                      00231 ; rekne disku na ze pristi instrukce, registry, data.... budou pro mastera
02A5                  00232 SELECT_DEVICE
02A5   30E0           00233         movlw b'11100000'       ; adresy budou v LBA, budeme pracovat s masterem
02A6   00AB           00234         movwf DEVICE
02A7   224A           00235         call WR_DEVICE
02A8   0008           00236         return
                      00237 ;**********************************************************
02A9                  00238 ZAPIS_DO_BUFFERU_1      ; buffer1 ma 64B a je v bance 3 na adrese 0x190 - 0x1CF
                      00239                                         ; jako parametr dostanem TEMP1, kde je pocet bytu k zapisu
                      00240                                         ; maximalni hodnota v TEMP1 muze byt 32 (1 slovo = 2 byty)
                      00241         INDF_BANK_3             ; neprime adresovani na banku 3
02A9   1783               M                         bsf STATUS,IRP    
02AA   3090           00242         movlw 0x90              ; adresa ja 190, devaty byt urcuje banku (0,1 / 2,3) fsr je tedy 90
02AB   0084           00243         movwf FSR               
02AC                  00244 ZAPIS_DO_BUFFERU_1__ZAPIS
02AC   2286           00245         call READ_DATA
                      00246         
02AD   0820           00247         movfw DATA_L
02AE   0080           00248         movwf INDF
02AF   0A84           00249         incf FSR,F
02B0   0821           00250         movfw DATA_H
02B1   0080           00251         movwf INDF
02B2   0A84           00252         incf FSR,F
                      00253 
02B3   0BB6           00254         decfsz TEMP1,F
02B4   2AAC           00255         goto ZAPIS_DO_BUFFERU_1__ZAPIS
                      00256 
                      00257         INDF_BANK_0     
02B5   1383               M                         bcf STATUS,IRP    
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 32


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

02B6   0008           00258         return
                      00259 ;**********************************************************
02B7                  00260 CLEAR_BUFFER2           ; BUFFER2 je 64bytu dat v bance 2 na adrese 0x110 - 0x14F
                      00261                                         ; pouziva TEMP1
02B7   3040           00262         movlw .64
02B8   00B6           00263         movwf TEMP1
                      00264         INDF_BANK_2             ; neprime adresovani na banku 2
02B9   1783               M                         bsf STATUS,IRP    
02BA   3010           00265         movlw 0x10
02BB   0084           00266         movwf FSR
02BC   3000           00267         movlw .0
                      00268 
02BD                  00269 CLEAR_BEFFER2__CLEAR
02BD   0080           00270         movwf INDF
02BE   0A84           00271         incf FSR,F
02BF   0BB6           00272         decfsz TEMP1,F
02C0   2ABD           00273         goto CLEAR_BEFFER2__CLEAR
                      00274 
                      00275         INDF_BANK_0             ; neprime adresovani na banku 0
02C1   1383               M                         bcf STATUS,IRP    
02C2   0008           00276         return
                      00277 ;**********************************************************
02C3                  00278 ATA_RESET
                      00279         ; Resetuje disk zjisti, zda vubec nejaky disk je pripojen
02C3   01AE           00280         clrf ATA_ATTRIBUTES     ; registr obsahujici bity rikajici co disk umi
                      00281 
02C4   1009           00282         bcf ATA_RESET_N         ; resetujeme disk
02C5   2369           00283         call DELAY_25us         ; signal reset musi byt min. 25us
02C6   1409           00284         bsf ATA_RESET_N         ; koncime s resetem disku
                      00285 
02C7   236E           00286         call WAIT_FOR_READY     ; vynulujeme device bit v DEVICE registru (disk musi byt master!), ...
02C8   22A5           00287         call SELECT_DEVICE      ; ...nastavime bit L - LBA addressing
                      00288 
02C9   236E           00289         call WAIT_FOR_READY
02CA   3002           00290         movlw b'00000010'       ; zakazeme preruseni (ted mam na mysli signal INTRQ z disku)
02CB   00A3           00291         movwf DEVICE_C          ; bit nIEN = 1 -> zakazeme preruseni disku (stejne nemame signal INTRQ p
                            ripojen)
02CC   222C           00292         call WR_DC                      ; zapiseme hodnotu do registru DEVICE CONTROL
                      00293 
02CD   30E0           00294         movlw b'11100000'       ; adresy budou v LBA, budeme pracovat s masterem
02CE   00AB           00295         movwf DEVICE
02CF   01A6           00296         clrf SECTOR_C
02D0   01A7           00297         clrf LBA1       
02D1   01A8           00298         clrf LBA2
02D2   01A9           00299         clrf LBA3
02D3   01A4           00300         clrf FEATURES
02D4   3000           00301         movlw h'00'                     ; code prikazu nop
02D5   00AD           00302         movwf COMMAND
02D6   2254           00303         call WR_BLOCK           ; ted provedeme prvni prikaz (nop) a podivame se co nam disk vrati
                      00304 
02D7   236E           00305         call WAIT_FOR_READY
02D8   2228           00306         call RD_DEVICE          ; Precteme reg. device. Pokud je disk OK, tak by nam mel vratit to, co j
                            sme do nej predtim zapsaly
02D9   082B           00307         movfw DEVICE
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 33


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

02DA   3CE0           00308         sublw b'11100000'
02DB   1903           00309         btfsc STATUS,Z          ; pokud DEVICE <> b'11100000', tak tu bud disk nemame, nebo je nejakej r
                            ozsypanej, nebo je spatne svicivanej (treba SLAVE)
02DC   142E           00310         bsf ATA_ATTRIBUTES,ATA_OK       ; 0. bit = 1 -> disk je pritomen, zapnuty a funkcni...
                      00311 
02DD   0008           00312         return          
                      00313 ;**********************************************************
02DE                  00314 READ_SECTOR
                      00315         ; Tento podprogram prevezme parametry SECTOR_C (kolik sec. mame precist)
                      00316         ; a LBA1 - LBA4, kde je ulozena LBA adresa sectoru od ktereho mame cist
                      00317         ; Postara se o spravne zadani adresy do disku (LBA28 / LBA48) a zavolani prikazu ke cteni...
                      00318         ; Samotne cteni se musi obslouzit v jine casti programu (podle toho co cteme...)
                      00319 
                      00320 ;       call WAIT_FOR_READY
                      00321         ; Cekame az Bsy bit = 0 
02DE   220C           00322         call RD_STATUS
02DF   182C           00323         btfsc ATA_STATUS,ERR
02E0   2AE3           00324         goto $+3                                        ; Nastal error disku. Co budeme delat? S*r*m* na
                             to a jdeme dal
02E1   1BAC           00325         btfsc ATA_STATUS,BSY
02E2   2ADE           00326         goto $-4                                        ; Bsy <> 0, cekame dal 
                      00327 
                      00328 
                      00329 ;       call SELECT_DEVICE
02E3   30E0           00330         movlw b'11100000'       ; adresy budou v LBA, budeme pracovat s masterem
02E4   00AB           00331         movwf DEVICE
02E5   224A           00332         call WR_DEVICE
                      00333 
                      00334 ;       call WAIT_FOR_READY_FOR_COMMAND
02E6   220C           00335         call RD_STATUS
02E7   182C           00336         btfsc ATA_STATUS,ERR
02E8   2AED           00337         goto $+5                                        ; Nastal error disku. Co budeme delat? S*r*m* na
                             to a jdeme dal
02E9   1BAC           00338         btfsc ATA_STATUS,BSY
02EA   2AE6           00339         goto $-4                                        ; Bsy <> 0, cekame dal 
02EB   1F2C           00340         btfss ATA_STATUS,DRDY
02EC   2AE6           00341         goto $-6
                      00342 
02ED   192E           00343         btfsc ATA_ATTRIBUTES,LBA48_SUPPORT
02EE   2AFE           00344         goto READ_SECTOR_LBA48
                      00345 
02EF                  00346 READ_SECTOR_LBA27               ; zadavani adresy v LBA28 je celkem jednoduche, LBA bity 24-27 jsou obsa
                            zene v dolnich 4 bitech DEVICE reg.
02EF   01A4           00347         clrf FEATURES
02F0   224F           00348         call WR_FEATURES
02F1   2236           00349         call WR_SC
02F2   223B           00350         call WR_LBA1
02F3   2240           00351         call WR_LBA2
02F4   2245           00352         call WR_LBA3
02F5   082A           00353         movfw LBA4                      ; Z nejvyssi casti adresy...
02F6   390F           00354         andlw b'00001111'       ; ...pouzijeme pouze dolni 4bity...
02F7   38E0           00355         iorlw b'11100000'       ; ...horni 3bity nastavime (LBA adresovani, master)...
02F8   00AB           00356         movwf DEVICE            ; ...a zapiseme do DEVICE.
02F9   224A           00357         call WR_DEVICE
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 34


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

02FA   3020           00358         movlw 0x20                      ; Read sector. OPCODE - 20h (with retries) or 21h (without retri
                            es)
02FB   00AD           00359         movwf COMMAND           ; ...podle me to znamena ze prikaz 20h se bude pri neuspechu pokouset zn
                            ova o cteni....
02FC   2231           00360         call WR_COMMAND         ; ...protoze se v novejsich spicifacich jiz prikaz 21h nevyskytuje, pouz
                            ivam ke cteni 20h.
02FD   0008           00361         return
                      00362 
02FE                  00363 READ_SECTOR_LBA48
                      00364         ; !!! Pripominam ze to co zde pisu (o LBA48) vim ze specifikace ATA8, v praxi jsem LBA48 na zadn
                            em disku jeste nezkousel !!!
                      00365         ; Zadavani adresy pri LBA48 se o neco lisi nez LBA28. Do registru LBA 1,2,3 se data zadavaji 2x.
                             
                      00366         ; Prvi zadavani znamena horni cast adresy, druhe zadavani dolni cast adresy.
                      00367         ; Znova sem pisu ze v tomto programu vyuzijeme jen LBA o 32bitech (2TB) a ne celych LBA48
02FE   3000           00368         movlw .0
02FF   00B5           00369         movwf TEMPW
0300   3022           00370         movlw D_SECTOR_C    ; vyssi cast parametru SECTOR_C = 0
0301   2270           00371         call RUTW       
0302   2236           00372         call WR_SC                      ; nizci cast parametru SECTOR_C
                      00373 
0303   3000           00374         movlw .0
0304   00B5           00375         movwf TEMPW
0305   3025           00376         movlw D_LBA3            ; LBA bity 47:40
0306   2270           00377         call RUTW
0307   3000           00378         movlw .0
0308   00B5           00379         movwf TEMPW
0309   3024           00380         movlw D_LBA2            ; LBA bity 39:32
030A   2270           00381         call RUTW
030B   082A           00382         movfw LBA4
030C   00B5           00383         movwf TEMPW
030D   3023           00384         movlw D_LBA1            ; LBA bity 31:24
030E   2270           00385         call RUTW
                      00386 
030F   2245           00387         call WR_LBA3            ; LBA bity 23:16
0310   2240           00388         call WR_LBA2            ; LBA bity 15:8
0311   223B           00389         call WR_LBA1            ; LBA bity  7:0
0312   3024           00390         movlw h'24'                     ; pri LBA48 se musi pouzit tohoto prikazu ke cteni (READ SECTOR(
                            S) EXT - 24h, PIO data-in)
0313   00AD           00391         movwf COMMAND
0314   2231           00392         call WR_COMMAND
0315   0008           00393         return
                      00394 ;**********************************************************
0316                  00395 IDENTIFY_DEVICE
                      00396         ; ted uz vime, ze mame pripojen nejaky disk, tento podprogram provede prikaz 
                      00397         ; identify device a zjisti co je disk zac. Nektere dulezite informace ulozi 
                      00398         ; (nastavi byty v ATA_ATTRIBUTES) a jmenovku disku hodi do bufferu
                      00399 
                      00400         ; rekneme disku, ze s nim chcem pracovat (s masterem)
0316   236E           00401         call WAIT_FOR_READY
0317   22A5           00402         call SELECT_DEVICE
                      00403         
                      00404         ; podivame se zda tu vubec disk je a co podporuje (LBA)
0318   236E           00405         call WAIT_FOR_READY     ; celame nez bude disk opet ready pro dalsi prikazy
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 35


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00406 
0319   30E0           00407         movlw b'11100000'       ; adresy budou v LBA, budeme pracovat s masterem
031A   00AB           00408         movwf DEVICE
031B   01A6           00409         clrf SECTOR_C
031C   01A7           00410         clrf LBA1       
031D   01A8           00411         clrf LBA2
031E   01A9           00412         clrf LBA3
031F   01A4           00413         clrf FEATURES
0320   30EC           00414         movlw 0xEC                      ; code prikazu IDENTIFY DEVICE
0321   00AD           00415         movwf COMMAND
0322   2254           00416         call WR_BLOCK
                      00417 
                      00418         ; pokud se neco nepodelalo, dostanem 256 16ti bitovych slov kde je napsano co disk umi a co je t
                            o zac...
                      00419         ; slova cisluji od nuly, (tzn. ze slov je 0-255)
0323   301B           00420         movlw .27               ; prvnich 27 slov je pro nas nepotrebnych
0324   00B6           00421         movwf TEMP1
0325   22A1           00422         call PRESKOC
                      00423         
                      00424         ; [27-46] model mumber (ASCI retezec s nazvem disku)
                      00425         ; tady precteme 20 slov a rovnou je odesleme do pric
                      00426                 ; pokud nekde od disku dostavame ASCII retezec jsou data nasledujici: 
                      00427                 ; pr. disk nam posila string “Copyright”
                      00428                 ;               1. DATA_H = 'C' 
                      00429                 ;               1. DATA_l = 'o'
                      00430                 ;               2. DATA_H = 'P' 
                      00431                 ;               2. DATA_l = 'y'
0326   3014           00432         movlw .20               ; dalsich 20 slov obsahuje 40 s ASCII znaku s nazvem disku
0327   00B6           00433         movwf TEMP1
0328   22A9           00434         call ZAPIS_DO_BUFFERU_1
                      00435                 
                      00436         ; ted jsme uz precetli 47 slov z 256 :-)
0329   3002           00437         movlw .2                ; dalsi 2 slova jsou nam k nicemu
032A   00B6           00438         movwf TEMP1
032B   22A1           00439         call PRESKOC
                      00440                 
032C   2286           00441         call READ_DATA  ; slovo 49 - capabilities (schopnosti)
                      00442                         ; 15:14 Reserved for the IDENTIFY PACKET DEVICE command.
                      00443                         ;    13 1 = Standby timer values as specified in this standard are supported
                      00444                         ;       0 = Standby timer values shall be managed by the device
                      00445                         ;    12 Reserved for the IDENTIFY PACKET DEVICE command.
                      00446                         ;    11 1 = IORDY supported
                      00447                         ;       0 = IORDY may be supported
                      00448                         ;    10 1 = IORDY may be disabled
                      00449                         ;     9 1 = LBA supported
                      00450                         ;     8 1 = DMA supported.
                      00451                         ;   7:0 Retired 
032D   18A1           00452         btfsc DATA_H,1  ;bit 9 = 1 -> LBA supported
032E   14AE           00453         bsf ATA_ATTRIBUTES,LBA_SUPPORT
                      00454 
                      00455         ;precetli jsme 50 slov
032F   300A           00456         movlw .10
0330   00B6           00457         movwf TEMP1
0331   22A1           00458         call PRESKOC
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 36


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00459         
0332   2286           00460         call READ_DATA  ; 60
0333   0820           00461         movfw DATA_L
0334   00AF           00462         movwf PARAM_MAX_LBA1            ; nejnizsi cast adresy
0335   0821           00463         movfw DATA_H
0336   00B0           00464         movwf PARAM_MAX_LBA2    
                      00465         
0337   2286           00466         call READ_DATA  ; 61
0338   0820           00467         movfw DATA_L
0339   00B1           00468         movwf PARAM_MAX_LBA3
033A   0821           00469         movfw DATA_H
033B   00B2           00470         movwf PARAM_MAX_LBA4            ; nejvyssi cast adresy
                      00471         
                      00472         ;precetli jsme 62 slov, zbyva 194
033C   3015           00473         movlw .21
033D   00B6           00474         movwf TEMP1
033E   22A1           00475         call PRESKOC
                      00476 
                      00477         ; 83 slov, na rade je slovo 83 (pripominam ze slova jsou cislovana od nuly)
033F   2286           00478         call READ_DATA  ; 83 - command supported. Tady nas zajima bit 10 - 1 = 48-bit Address feature se
                            t supported
0340   1921           00479         btfsc DATA_H,2  ; pokud disk umi LBA 48 pripiseme tuto skutecnost do ATA_ATTRIBUTES
0341   152E           00480         bsf ATA_ATTRIBUTES,LBA48_SUPPORT
                      00481 
                      00482         ;precetli jsme 84 slov
0342   3010           00483         movlw .16
0343   00B6           00484         movwf TEMP1
0344   22A1           00485         call PRESKOC
                      00486                 
0345   1D2E           00487         btfss ATA_ATTRIBUTES,LBA48_SUPPORT
0346   2B52           00488         goto INIT_ATA__NOT_SUPPORT_LBA48
                      00489                         ; pokud je podporovano LBA 48, nachazi se ve slovech [100-103] skutecny pocet se
                            ktoru 
                      00490                         ; do slov 60-61 by se sice vesel pocet sektoru u disku do 2TB, podle standardu s
                            e tam ale zapisuje pouze hodnota max pro LBA 28 (cca 120 GB)
                      00491                         ; mi precteme ale jen nejnizsi 2 slova, predpokladam totiz ze disk neni vetsi ja
                            k 2TB
0347   2286           00492                         call READ_DATA  ; 100
0348   0820           00493                         movfw DATA_L
0349   00AF           00494                         movwf PARAM_MAX_LBA1            ; nejnizsi cast adresy
034A   0821           00495                         movfw DATA_H
034B   00B0           00496                         movwf PARAM_MAX_LBA2    
                      00497 
034C   2286           00498                         call READ_DATA  ; 101
034D   0820           00499                         movfw DATA_L
034E   00B1           00500                         movwf PARAM_MAX_LBA3
034F   0821           00501                         movfw DATA_H
0350   00B2           00502                         movwf PARAM_MAX_LBA4            ; nejvyssi cast adresy                  
0351   2B55           00503                 goto INIT_ATA__DALSI
0352                  00504 INIT_ATA__NOT_SUPPORT_LBA48
0352   3002           00505         movlw .2        ; 100, 101
0353   00B6           00506         movwf TEMP1
0354   22A1           00507         call PRESKOC    
0355                  00508 INIT_ATA__DALSI
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 37


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00509         ; precetli jsme 102 slov
0355   3004           00510         movlw .4        ; 102, 103, 104, 105
0356   00B6           00511         movwf TEMP1
0357   22A1           00512         call PRESKOC
                      00513 
0358   2286           00514         call READ_DATA  ; slovo 106 - pokud bit 15=0 a bit 14=1, tak obsahuje pravdive informace
                      00515                                                 ; pro nas je podstatne, ze pokud je bit 12 = 1, tak sekt
                            or je vetsi nez 256 slov
                      00516                                                 ; pokud je sektor vetsi nez 256 slov, je jeho velikost v
                            e slovech [117-118]
0359   1BA1           00517         btfsc DATA_H,7
035A   2B5F           00518         goto INIT_ATA__DALSI2
035B   1F21           00519         btfss DATA_H,6
035C   2B5F           00520         goto INIT_ATA__DALSI2
035D   1A21           00521         btfsc DATA_H,4
035E   15AE           00522         bsf ATA_ATTRIBUTES,BIG_SECTOR
035F                  00523 INIT_ATA__DALSI2
                      00524         ; precteno 107, zbyva 149
035F   3095           00525         movlw .149      ; 107 - 256
0360   00B6           00526         movwf TEMP1
0361   22A1           00527         call PRESKOC
                      00528                 
                      00529         ; ted vime co mame za disk, tak se na to jdem podivat...
                      00530         ; pokud disk splnuje vsechny nase pozadavky, tak nastavime 7 bit v ATA_ATTRIBUTES
0362   13AE           00531         bcf ATA_ATTRIBUTES,APPLICABLE   
0363   1CAE           00532         btfss ATA_ATTRIBUTES,LBA_SUPPORT
0364   0008           00533         return
                      00534         ; pokud jsme tady, disk podporuje LBA (dneska se jich uz moc nevidi, co by LBA neumeli)
0365   19AE           00535         btfsc ATA_ATTRIBUTES,BIG_SECTOR
0366   0008           00536         return
                      00537         ; mazec, disk ma velikost sektoru 256 slov, vetsi naroky na disk nemam :-)
0367   17AE           00538         bsf ATA_ATTRIBUTES,APPLICABLE ; disk umi to co potrebujeme...   
                      00539 
0368   0008           00540         return
                      00541 ;**************************************************************************
                      00542 ;**********************************************************
                      00543 ; CEKACI PROCEDURY
                      00544 ;**********************************************************
0369                  00545 DELAY_25us
                      00546         ; pouziva TEMP1
                      00547         ; (Fosc = 20 MHz , instr. cyklus= 0.20 us) 25us / 0.20 us = 125 instrukcnich cyklu
                      00548         ; (Fosc = 16 MHz , instr. cyklus= 0.25 us) 25us / 0.25 us = 100 instrukcnich cyklu
                      00549         ; (Fosc = 04 MHz , instr. cyklus= 1.00 us) 25us / 1.00 us =  25 instrukcnich cyklu      
0369   302A           00550         MOVLW 0x2A  ;42 DEC -> Delay 127 cycles
                      00551         ;MOVLW 0x21   ;33 DEC -> Delay 100 cycles
                      00552         ;MOVLW 0x08  ;25 DEC -> Delay  25 cycles
036A   00B6           00553         MOVWF TEMP1
036B   0BB6           00554         DECFSZ TEMP1,F
036C   2B6B           00555         GOTO $-1
                      00556         ;End of Delay
036D   0008           00557         return
                      00558 ;**************************************************************************
036E                  00559 WAIT_FOR_READY
                      00560         ; Cekame az Bsy bit = 0 
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 38


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00561         ; (cekame az disk nebude zaneprazdnen)
036E   220C           00562         call RD_STATUS
036F   082C           00563         movfw ATA_STATUS
0370   3980           00564         andlw b'10000000'
0371   1903           00565         btfsc STATUS,Z
0372   0008           00566         return
0373   2B6E           00567         goto WAIT_FOR_READY
                      00568 ;**************************************************************************
                      00569 ;WAIT_FOR_READY_FOR_COMMAND
                      00570 ;       call WAIT_FOR_READY
                      00571 ;       btfss ATA_STATUS,DRDY
                      00572 ;       goto WAIT_FOR_READY_FOR_COMMAND
                      00573 ;       return
                      00574 ;**************************************************************************
                      00074         include "fat32.asm"     ; podprogramy na nacteni a praci s FAT32
                      00001 ;**********************************************************
                      00002 ;**********************************************************
                      00003 ;**********************************************************
                      00004 ; OBSLUZNE PODPROGRAMY PRO FAT32, HLEDANI ODDILU
                      00005 ;**********************************************************
                      00006 ;**********************************************************
                      00007 ;**********************************************************
                      00008 
                      00009 ;**************************************************************************
0374                  00010 SCAN_MBR
                      00011         ; Tato procedura ma na prvni pohled jednoduchy ukol, podiva se do MBR a do BUFFERU 2 hodi nasled
                            ujici data:
                      00012         ; 4 x 16 bytovy zaznam, kde kazdy zaznam reprezentuje jeden oddil se systemem FAT32
                      00013         ; struktura zaznamu je nasledujici:             1  byt (pokud = 0 tak v zaznamu neni zaznam o od
                            dilu, pokud = FFh , je zaznam o oddilu)
                      00014         ;                                                                               4  byty = adresa
                             kde se nachazi spousteci zaznam oddilu
                      00015         ;                                                                               11 bytu = jmenov
                            ka oddilu s FAT32 (neni dulezita, jen aby bylo co vypsat na display :-)
0374   22B7           00016         call CLEAR_BUFFER2
                      00017 
0375   01A7           00018         clrf LBA1
0376   01A8           00019         clrf LBA2
0377   01A9           00020         clrf LBA3
0378   01AA           00021         clrf LBA4                               ; jako prvni cteme MBR
                      00022 
0379   01BB           00023         clrf POZICE                             ; kolik zaznamu o oddilech uz bylo zapsano do bufferu2
037A                  00024 SCAN_BR                                         
                      00025         ; tady na tom navesti mame zadanou adresu MBR nebo BR nejakeho rozsireneho oddilu
037A   3001           00026         movlw .1
037B   00A6           00027         movwf SECTOR_C
037C   22DE           00028         call READ_SECTOR                ; cteme MBR nebo BR rozsireneho oddilu
                      00029 
037D   30DF           00030         movlw .223                              ; 223 slov = 446 bytu
037E   00B6           00031         movwf TEMP1
037F   22A1           00032         call PRESKOC                    ; na prvnich 446 bytech MBR je zavadeci program systemu (samozre
                            jme, pokud na disku system je)
0380   3020           00033         movlw .32
0381   00B6           00034         movwf TEMP1
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 39


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0382   22A9           00035         call ZAPIS_DO_BUFFERU_1 ; do bufferu si dame vsechny zaznamy BR (16*4=64bytu / 32slov)
0383   3001           00036         movlw .1
0384   00B6           00037         movwf TEMP1
0385   22A1           00038         call PRESKOC
                      00039         ; tak ted jsme precetli cely MBR/BR a zaznamy o jeho oddilech mame v BEFFERU 1, tak se jdem na n
                            e podivat...
                      00040         
                      00041         ; Nejdriv si ale hodime aktualni LBA adresu do operandu Y pro aritmeticke operace
                      00042         INDF_BANK_1                             ; neprime adresovani na banku 1 (aritmeticke operace)
0386   1383               M                         bcf STATUS,IRP    
0387   30A4           00043         movlw 0xA4                              ; FSR na OPERAND_Y
0388   0084           00044         movwf FSR       
0389   0827           00045         movfw LBA1
038A   0080           00046         movwf INDF
038B   0A84           00047         incf FSR,F
038C   0828           00048         movfw LBA2
038D   0080           00049         movwf INDF
038E   0A84           00050         incf FSR,F
038F   0829           00051         movfw LBA3
0390   0080           00052         movwf INDF
0391   0A84           00053         incf FSR,F
0392   082A           00054         movfw LBA4
0393   0080           00055         movwf INDF
0394   0A84           00056         incf FSR,F
                      00057 
                      00058         INDF_BANK_3                             ; neprime adresovani na banku 3 (buffer 1)      
0395   1783               M                         bsf STATUS,IRP    
0396   3094           00059         movlw 0x94                              ; 90h (buffer1) + 4 (pozice kde je ulozen identifikator 
                            souboroveho systemu prvniho zaznamu BR)
0397   0084           00060         movwf FSR
0398   0800           00061         movfw INDF
0399   3C0C           00062         sublw h'0C'                             ; Pokud se FileSystem <> 0Ch...
039A   1D03           00063         btfss STATUS,Z
039B   3C01           00064         sublw .1                                ; ...ani 0Bh...
039C   1D03           00065         btfss STATUS,Z
039D   2BC3           00066         goto SCAN_MBR__HLEDEJ_ROZSIRENY_ODDIL   ; ...tak hledej rozsireny oddil.
                      00067 
                      00068         ; pokud jsme v teto casti programu, tak prvni zaznam MBR/BR obsahuje oddil FAT32, s reprezentaci
                             adres stylem LBA
                      00069         ; Tady pozor, v MBR/BR neni zapsana LBA adresa oddilu, ale relativni vzdalenost (offset) od MBR/
                            BR.
                      00070         ; To znamena, ze k adrese v (M)BR musime pricist offset oddilu.
                      00071         BANK_1
039E   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
039F   1683               M                 bsf     STATUS,RP0    
03A0   3098           00072         movlw 0x98                              ; offset prvniho zaznamu 
03A1   0084           00073         movwf FSR
03A2   0800           00074         movfw INDF
03A3   00A0           00075         movwf OPERAND_X1
03A4   0A84           00076         incf FSR,F
03A5   0800           00077         movfw INDF
03A6   00A1           00078         movwf OPERAND_X2
03A7   0A84           00079         incf FSR,F
03A8   0800           00080         movfw INDF
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 40


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

03A9   00A2           00081         movwf OPERAND_X3
03AA   0A84           00082         incf FSR,F
03AB   0800           00083         movfw INDF
03AC   00A3           00084         movwf OPERAND_X4
                      00085         BANK_0
03AD   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
03AE   1283               M                 bcf     STATUS,RP0    
                      00086 
03AF   269C           00087         call SOUCET
                      00088 
                      00089         INDF_BANK_1                             ; neprime adresovani na banku 1 (aritmeticke operace)
03B0   1383               M                         bcf STATUS,IRP    
03B1   30A8           00090         movlw 0xA8                              ; FSR na VYSLEDEK
03B2   0084           00091         movwf FSR       
03B3   0800           00092         movfw INDF
03B4   00A7           00093         movwf LBA1
03B5   0A84           00094         incf FSR,F
03B6   0800           00095         movfw INDF
03B7   00A8           00096         movwf LBA2
03B8   0A84           00097         incf FSR,F
03B9   0800           00098         movfw INDF
03BA   00A9           00099         movwf LBA3
03BB   0A84           00100         incf FSR,F
03BC   0800           00101         movfw INDF
03BD   00AA           00102         movwf LBA4
03BE   0A84           00103         incf FSR,F
                      00104 
03BF   23EE           00105         call ZKONTROLUJ_ODDIL_FAT32     ; pokud skutecne adresa v LBA1-4 ukazuje na zacatek oddilu s FAT
                            32, tak da do bufferu2 jmenovku a adresu oddilu
                      00106         INDF_BANK_3
03C0   1783               M                         bsf STATUS,IRP    
03C1   30A4           00107         movlw 0xA4                                      ; 90h (buffer 1) + 16 (velikost 1. zaznamu) + 4 
                            (identifikator souboroveho systemu 2. zaznamu)
03C2   0084           00108         movwf FSR
03C3                  00109 SCAN_MBR__HLEDEJ_ROZSIRENY_ODDIL                ; jdem v zaznamech MBR/BR hledat rozsireny oddil
                      00110         ; pokud byl v prvnim zaznamu oddil typu FAT32, tak nam  tad FSR ukazuje na FileSystem 2. zaznamu
                            ...
                      00111         ; ...pokud 1. zaznam nebyl typu FAT32, tak nam FSR ukazuje na FileSystem 1. zaznamu.
                      00112         ; Kazdopadne se ted podivame na dalsi zaznam a pokud obsahuje rozsireny oddil, skocime na jeho a
                            dresu a dame goto SCAN_BR ...
03C3   0800           00113         movfw INDF
03C4   3C05           00114         sublw h'05'                             ; Pokud se FileSystem <> 05h (rozsireny oddil CHS)...
03C5   1D03           00115         btfss STATUS,Z
03C6   3C0A           00116         sublw h'0A'                             ; ...ani se <> 0Fh (5+A=F) (rozsireny oddil LBA)...
03C7   1D03           00117         btfss STATUS,Z
03C8   2BED           00118         goto SCAN_MBR__KONEC    ; ...tak koncime...
                      00119 
03C9   0804           00120         movfw FSR                               ; ...pokud tu ale mame rozsireny oddil,...
03CA   3E04           00121         addlw .4                                ; ...tak se jdem podivat na jeho adresu.
03CB   0084           00122         movwf FSR
                      00123 
                      00124         BANK_1
03CC   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
03CD   1683               M                 bsf     STATUS,RP0    
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 41


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00125         INDF_BANK_3
03CE   1783               M                         bsf STATUS,IRP    
03CF   0800           00126         movfw INDF
03D0   00A0           00127         movwf OPERAND_X1
03D1   0A84           00128         incf FSR,F
03D2   0800           00129         movfw INDF
03D3   00A1           00130         movwf OPERAND_X2
03D4   0A84           00131         incf FSR,F
03D5   0800           00132         movfw INDF
03D6   00A2           00133         movwf OPERAND_X3
03D7   0A84           00134         incf FSR,F
03D8   0800           00135         movfw INDF
03D9   00A3           00136         movwf OPERAND_X4
                      00137         BANK_0
03DA   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
03DB   1283               M                 bcf     STATUS,RP0    
                      00138 
03DC   269C           00139         call SOUCET
                      00140 
                      00141         INDF_BANK_1                             ; neprime adresovani na banku 1 (aritmeticke operace)
03DD   1383               M                         bcf STATUS,IRP    
03DE   30A8           00142         movlw 0xA8                              ; FSR na VYSLEDEK
03DF   0084           00143         movwf FSR       
03E0   0800           00144         movfw INDF
03E1   00A7           00145         movwf LBA1
03E2   0A84           00146         incf FSR,F
03E3   0800           00147         movfw INDF
03E4   00A8           00148         movwf LBA2
03E5   0A84           00149         incf FSR,F
03E6   0800           00150         movfw INDF
03E7   00A9           00151         movwf LBA3
03E8   0A84           00152         incf FSR,F
03E9   0800           00153         movfw INDF
03EA   00AA           00154         movwf LBA4
03EB   0A84           00155         incf FSR,F
                      00156         
03EC   2B7A           00157         goto SCAN_BR                    ; S rozirenym oddilem provedeme totez co s MBR
03ED                  00158 SCAN_MBR__KONEC
03ED   0008           00159         return
                      00160 ;**************************************************************************
03EE                  00161 ZKONTROLUJ_ODDIL_FAT32
                      00162         ; tak ted bychom mely mit v LBA 1-4 adresu spousteciho zaznamu oddilu s FAT32, tak to jdem overi
                            t...
                      00163         ; ...a pokud tam doopravdy spousteci zaznam je, tak dame jmenovku a informace do bufferu 2 na po
                            zici jaka je v rag. POZICE
                      00164         INDF_BANK_2
03EE   1783               M                         bsf STATUS,IRP    
03EF   083B           00165         movfw POZICE
03F0   00B6           00166         movwf TEMP1
03F1   1003           00167         bcf STATUS,C
03F2   0DB6           00168         rlf TEMP1,F
03F3   0DB6           00169         rlf TEMP1,F
03F4   0DB6           00170         rlf TEMP1,F
03F5   0DB6           00171         rlf TEMP1,F                             ; TEMP1 := POZICE *16
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 42


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

03F6   0836           00172         movfw TEMP1
03F7   3E11           00173         addlw 0x11                              ; TEMP1 + pozice bufferu 2 + 1 (pozice kam budeme do buf
                            feru 2 davat adresu oddilu)
03F8   0084           00174         movwf FSR
                      00175 
03F9   0827           00176         movfw LBA1
03FA   0080           00177         movwf INDF
03FB   0A84           00178         incf FSR,F
03FC   0828           00179         movfw LBA2
03FD   0080           00180         movwf INDF
03FE   0A84           00181         incf FSR,F
03FF   0829           00182         movfw LBA3
0400   0080           00183         movwf INDF
0401   0A84           00184         incf FSR,F
0402   082A           00185         movfw LBA4
0403   0080           00186         movwf INDF
0404   0A84           00187         incf FSR,F                              ; adresa oddilu je ulozena do bufferu 2, ted tam jdem da
                            vat jmenovku oddilu
                      00188 
0405   3001           00189         movlw .1
0406   00A6           00190         movwf SECTOR_C
0407   22DE           00191         call READ_SECTOR
0408   3023           00192         movlw h'23'
0409   00B6           00193         movwf TEMP1
040A   22A1           00194         call PRESKOC                    ; informace o FATce co nas ted zrovna moc nezejimaji
                      00195         ; na offsetu 47 je ulozena jmenovka oddilu (11znaku), ted jsme na offsetu 46
                      00196 
040B   2286           00197         call READ_DATA
040C   0821           00198         movfw DATA_H
040D   0080           00199         movwf INDF                              ; 1. znak ze jmenovky svazku
040E   0A84           00200         incf FSR,F
                      00201 
040F   3005           00202         movlw .5                                ; dalsich 10 bytu je zbytek jmenovky
0410   00B6           00203         movwf TEMP1
0411                  00204 ZKONTROLUJ_ODDIL_FAT32__JMENOVKA
0411   2286           00205         call READ_DATA
0412   0820           00206         movfw DATA_L
0413   0080           00207         movwf INDF
0414   0A84           00208         incf FSR,F
0415   0821           00209         movfw DATA_H
0416   0080           00210         movwf INDF
0417   0A84           00211         incf FSR,F
0418   0BB6           00212         decfsz TEMP1,F
0419   2C11           00213         goto ZKONTROLUJ_ODDIL_FAT32__JMENOVKA
041A   3010           00214         movlw .16
041B   0284           00215         subwf FSR,F                                     ; aby fsr ukazoval na priznak o pravdivosti (FSR
                             := FSR - 16)
                      00216 
041C   2286           00217         call READ_DATA
041D   0820           00218         movfw DATA_L
041E   3C46           00219         sublw 'F'               
041F   1D03           00220         btfss STATUS,Z
0420   2C36           00221         goto ZKONTROLUJ_ODDIL_FAT32__KONEC
0421   0821           00222         movfw DATA_H
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 43


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0422   3C41           00223         sublw 'A'               
0423   1D03           00224         btfss STATUS,Z
0424   2C36           00225         goto ZKONTROLUJ_ODDIL_FAT32__KONEC
                      00226 
0425   2286           00227         call READ_DATA
0426   0820           00228         movfw DATA_L
0427   3C54           00229         sublw 'T'               
0428   1D03           00230         btfss STATUS,Z
0429   2C36           00231         goto ZKONTROLUJ_ODDIL_FAT32__KONEC
042A   0821           00232         movfw DATA_H
042B   3C33           00233         sublw '3'               
042C   1D03           00234         btfss STATUS,Z
042D   2C36           00235         goto ZKONTROLUJ_ODDIL_FAT32__KONEC
                      00236 
042E   2286           00237         call READ_DATA
042F   0820           00238         movfw DATA_L
0430   3C32           00239         sublw '2'
0431   1D03           00240         btfss STATUS,Z
0432   2C36           00241         goto ZKONTROLUJ_ODDIL_FAT32__KONEC
                      00242         ; tak, ted uz opravdu vime, ze na tomto sektoru se nachazi spousteci zaznam svazku se souborovym
                             systemem FAT32
                      00243 
0433   30FF           00244         movlw h'FF'
0434   0080           00245         movwf INDF
0435   0ABB           00246         incf POZICE,F                           ; sektor skutecne obsahoval spousteci zaznam svazku...
0436                  00247 ZKONTROLUJ_ODDIL_FAT32__KONEC
0436   0008           00248         return
                      00249 ;**************************************************************************
0437                  00250 NACTI_FAT32
                      00251         ; V LBA1-4 bychom meli dostat adresu prvniho sektoru FAT32 oddilu, kde by se mely nalezat inform
                            ace o fatce
                      00252         ; pokud je FATka pro nas pouzitelna (Clustery nejsou moc velke, sektor = 512B ...) nastavime bit
                             FAT32_LOAD v ATA_ATTRIBUTES
0437   122E           00253         bcf ATA_ATTRIBUTES,FAT32_LOAD
0438   01C0           00254         clrf POCATEK_DAT1
0439   01C1           00255         clrf POCATEK_DAT2
043A   01C2           00256         clrf POCATEK_DAT3
043B   01C3           00257         clrf POCATEK_DAT4
043C   01C4           00258         clrf POCATEK_FAT1
043D   01C5           00259         clrf POCATEK_FAT2
043E   01C6           00260         clrf POCATEK_FAT3
043F   01C7           00261         clrf POCATEK_FAT4
0440   01C8           00262         clrf ROOT_DIR_CL1
0441   01C9           00263         clrf ROOT_DIR_CL2
0442   01CA           00264         clrf ROOT_DIR_CL3
0443   01CB           00265         clrf ROOT_DIR_CL4
                      00266 
                      00267 
0444   01A4           00268         clrf FEATURES
0445   3001           00269         movlw .1
0446   00A6           00270         movwf SECTOR_C
0447   22DE           00271         call READ_SECTOR
                      00272 
0448   3005           00273         movlw .5
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 44


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0449   00B6           00274         movwf TEMP1
044A   22A1           00275         call PRESKOC
                      00276 
044B   2286           00277         call READ_DATA                          ; 10 bytu precteno
044C   0821           00278         movfw DATA_H                            ; 11,12 byte - velikost sektoru (tady by melo byt 512, a
                            le co kdyby ne...)
044D   39FF           00279         andlw h'FF'
044E   1D03           00280         btfss STATUS,Z
044F   2CFA           00281         goto NACTI_FAT32__KONEC         ; pokud 11 byte neni nula, koncime (velikost sektoru se nerovna 
                            512)
                      00282 
0450   2286           00283         call READ_DATA                          ; ctu 12. a 13. byte
0451   0820           00284         movfw DATA_L
0452   3C02           00285         sublw h'02'
0453   1D03           00286         btfss STATUS,Z
0454   2CFA           00287         goto NACTI_FAT32__KONEC         ; pokud 12 byte neni 2, koncime (velikost sektoru se nerovna 512
                            )
                      00288 
0455   0821           00289         movfw DATA_H                            ; byte 13. SectorsPerCluster
0456   00CC           00290         movwf CLUSTER_SIZE
0457   3C80           00291         sublw .128                              ; nas program neumi vic jak 128 (Velikost clusteru = 64K
                            B)
0458   1C03           00292         btfss STATUS,C
0459   2CFA           00293         goto NACTI_FAT32__KONEC         ; pokud mame clustery vetsi jak 64KB, tak koncime
                      00294 
045A   2286           00295         call READ_DATA                          ; ctu 14. a 15. byte
045B   0820           00296         movfw DATA_L
045C   00C4           00297         movwf POCATEK_FAT1                      ; tady se nachazi pocet rezervovanych sektoru, pak k ZAC
                            ATEK_FAT pricteme adresu zacatku sektoru a mame zacatek fat...
045D   0821           00298         movfw DATA_H
045E   00C5           00299         movwf POCATEK_FAT2
                      00300         
045F   2286           00301         call READ_DATA                          ; ctu 16. a 17. byte
0460   0820           00302         movfw DATA_L                            ; Pocet FAT. byva temer vzdy 2, kdyby ale ne, tak by nam
                             to delalo docela bordel...
0461   3C02           00303         sublw .2
0462   1D03           00304         btfss STATUS,Z
0463   2CFA           00305         goto NACTI_FAT32__KONEC
                      00306 
0464   3009           00307         movlw .9
0465   00B6           00308         movwf TEMP1
0466   22A1           00309         call PRESKOC                            ; 18 - 35
                      00310 
0467   2286           00311         call READ_DATA                          ; 36,37 -> velikost FAT (pocet sektoru)
0468   0820           00312         movfw DATA_L
0469   00C0           00313         movwf POCATEK_DAT1
046A   0821           00314         movfw DATA_H
046B   00C1           00315         movwf POCATEK_DAT2      
046C   2286           00316         call READ_DATA                          ; 38,39 -> velikost FAT (pocet sektoru)
046D   0820           00317         movfw DATA_L
046E   00C2           00318         movwf POCATEK_DAT3
046F   0821           00319         movfw DATA_H
0470   00C3           00320         movwf POCATEK_DAT4
                      00321 
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 45


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0471   2286           00322         call READ_DATA                          ; 40,41
0472   2286           00323         call READ_DATA                          ; 42,43
                      00324 
0473   2286           00325         call READ_DATA                          ; 44,45
0474   0820           00326         movfw DATA_L
0475   00C8           00327         movwf ROOT_DIR_CL1
0476   0821           00328         movfw DATA_H
0477   00C9           00329         movwf ROOT_DIR_CL2
0478   2286           00330         call READ_DATA                          ; 46,47
0479   0820           00331         movfw DATA_L
047A   00CA           00332         movwf ROOT_DIR_CL3
047B   0821           00333         movfw DATA_H
047C   00CB           00334         movwf ROOT_DIR_CL4
                      00335 
047D   3011           00336         movlw .17
047E   00B6           00337         movwf TEMP1
047F   22A1           00338         call PRESKOC                            ; 48 - 81
                      00339 
                      00340         ; ted jeste takova mala kontrola...
0480   2286           00341         call READ_DATA
0481   0820           00342         movfw DATA_L
0482   3C46           00343         sublw 'F'               
0483   1D03           00344         btfss STATUS,Z
0484   2CFA           00345         goto NACTI_FAT32__KONEC
0485   0821           00346         movfw DATA_H
0486   3C41           00347         sublw 'A'               
0487   1D03           00348         btfss STATUS,Z
0488   2CFA           00349         goto NACTI_FAT32__KONEC
0489   2286           00350         call READ_DATA
048A   0820           00351         movfw DATA_L
048B   3C54           00352         sublw 'T'               
048C   1D03           00353         btfss STATUS,Z
048D   2CFA           00354         goto NACTI_FAT32__KONEC
048E   0821           00355         movfw DATA_H
048F   3C33           00356         sublw '3'               
0490   1D03           00357         btfss STATUS,Z
0491   2CFA           00358         goto NACTI_FAT32__KONEC
0492   2286           00359         call READ_DATA
0493   0820           00360         movfw DATA_L
0494   3C32           00361         sublw '2'
0495   1D03           00362         btfss STATUS,Z
0496   2CFA           00363         goto NACTI_FAT32__KONEC
                      00364         ; tak, ted uz opravdu vime, ze na tomto sektoru se nachazi spousteci zaznam svazku se souborovym
                             systemem FAT32...
                      00365         ; tak ted jdem vypocitat ty nejdulezitejsi cisla pro praci s FATkou...
                      00366 
                      00367         INDF_BANK_1                                     ; aritmeto/logicke operace
0497   1383               M                         bcf STATUS,IRP    
0498   30A0           00368         movlw 0xA0                                      ; OPERAND_X
0499   0084           00369         movwf FSR
049A   0844           00370         movfw POCATEK_FAT1
049B   0080           00371         movwf INDF
049C   0A84           00372         incf FSR,F
049D   0845           00373         movfw POCATEK_FAT2
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 46


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

049E   0080           00374         movwf INDF
049F   0A84           00375         incf FSR,F
04A0   0846           00376         movfw POCATEK_FAT3
04A1   0080           00377         movwf INDF
04A2   0A84           00378         incf FSR,F
04A3   0847           00379         movfw POCATEK_FAT4
04A4   0080           00380         movwf INDF
04A5   0A84           00381         incf FSR,F
04A6   0827           00382         movfw LBA1                                      ; OPERAND_Y
04A7   0080           00383         movwf INDF
04A8   0A84           00384         incf FSR,F
04A9   0828           00385         movfw LBA2
04AA   0080           00386         movwf INDF
04AB   0A84           00387         incf FSR,F
04AC   0829           00388         movfw LBA3
04AD   0080           00389         movwf INDF
04AE   0A84           00390         incf FSR,F
04AF   082A           00391         movfw LBA4
04B0   0080           00392         movwf INDF
04B1   0A84           00393         incf FSR,F
04B2   269C           00394         call SOUCET                                     ; pricteme k zacatku oddilu pocet rezervovanych 
                            sektoru (obvykle 32) a mame z toho POCATEK_FAT
04B3   0800           00395         movfw INDF
04B4   00C4           00396         movwf POCATEK_FAT1
04B5   0A84           00397         incf FSR,F
04B6   0800           00398         movfw INDF
04B7   00C5           00399         movwf POCATEK_FAT2
04B8   0A84           00400         incf FSR,F
04B9   0800           00401         movfw INDF
04BA   00C6           00402         movwf POCATEK_FAT3
04BB   0A84           00403         incf FSR,F
04BC   0800           00404         movfw INDF
04BD   00C7           00405         movwf POCATEK_FAT4
04BE   0A84           00406         incf FSR,F
                      00407 
                      00408         ; v POCATEK_DAT ted mame hodnotu "velikost fat", tu vynasobime 2 a pricteme POCATEK_FAT. Tak zis
                            kame POCATEK_DAT
04BF   30A0           00409         movlw 0xA0                                      ; OPERAND_X
04C0   0084           00410         movwf FSR
04C1   0840           00411         movfw POCATEK_DAT1
04C2   0080           00412         movwf INDF
04C3   0A84           00413         incf FSR,F
04C4   0841           00414         movfw POCATEK_DAT2
04C5   0080           00415         movwf INDF
04C6   0A84           00416         incf FSR,F
04C7   0842           00417         movfw POCATEK_DAT3
04C8   0080           00418         movwf INDF
04C9   0A84           00419         incf FSR,F
04CA   0843           00420         movfw POCATEK_DAT4
04CB   0080           00421         movwf INDF
04CC   0A84           00422         incf FSR,F
04CD   270A           00423         call POSUNDOLEVA_1                      ; X := X * 2 -> POCATEK_DAT := 2 * "velikost fat"
                      00424                                                                 ; ted jeste staci pricist POCATEK_FAT
04CE   0844           00425         movfw POCATEK_FAT1
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 47


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

04CF   0080           00426         movwf INDF
04D0   0A84           00427         incf FSR,F
04D1   0845           00428         movfw POCATEK_FAT2
04D2   0080           00429         movwf INDF
04D3   0A84           00430         incf FSR,F
04D4   0846           00431         movfw POCATEK_FAT3
04D5   0080           00432         movwf INDF
04D6   0A84           00433         incf FSR,F
04D7   0847           00434         movfw POCATEK_FAT4
04D8   0080           00435         movwf INDF
04D9   0A84           00436         incf FSR,F
04DA   269C           00437         call SOUCET
                      00438 
                      00439         ;   tady je pro me jedna zcela nepochopitelna vlastnost FATky, a to to, ze prvni dva zaznamy (nu
                            lty a prvni)
                      00440         ;   ve FAT tabulce jsou obsazeny nejakyma srotama (identifikator FATky), coz by nebylo to nejhor
                            si, ale data na disku
                      00441         ;   zacinaji jiz na nultym clusteru. (POCATEK_DAT) Dochazi tedy k tomu, ze nulty cluster na disk
                            u je reprezentovan na druhe
                      00442         ;   pozici ve fatce a to cislem dve!!! Od udaje ve fatce bychom musime tedy vzdy odecist hodnotu
                             2
                      00443         ;   a ziskali bychom skutecnou polohu dat na disku.... (Je to pekne na vyliz!!!!!!!!)
                      00444         ;   Ja to tady resim tak, ze zacatek dat posunu o 2 clustery niz (POCATEK_DAT := POCATEK_DAT - 2
                            *VELIKOST_CLUSTERU),
                      00445         ;   aby udaje souhlasily a my nemuseli nic prepocitavat. 
                      00446         ;   Pak tu nastava jeste jeden problem, ROOT adresar byva adresovan jako by byl na clusteru 0, p
                            roto pokazdy kdyz je 
                      00447         ;   nekde cislo clusteru 0, tak skocime na prvni cluster root adresare. (Vetsinou 2. cluster)
                      00448         ;   O tomto jevu jsem nikde necetl, ale proste to tak je. Z toho vyplyva, ze zadny soubor nemuze
                             byt na slusteru 1...
                      00449         
                      00450         ; Tak ted mame v POCATEK_DAT = POCATEK_FAT + (velikostFat * 2)
                      00451         ; a ted jeste musime odecist 2 * velikost_clusteru
                      00452 
04DB   0D4C           00453         rlf CLUSTER_SIZE,W              ; W := CLUSTER_SIZE * 2
                      00454         BANK_1
04DC   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
04DD   1683               M                 bsf     STATUS,RP0    
04DE   00A4           00455         movwf OPERAND_Y1
04DF   01A5           00456         clrf OPERAND_Y2
04E0   01A6           00457         clrf OPERAND_Y3
04E1   01A7           00458         clrf OPERAND_Y4
04E2   0828           00459         movfw VYSLEDEK1
04E3   00A0           00460         movwf OPERAND_X1
04E4   0829           00461         movfw VYSLEDEK2
04E5   00A1           00462         movwf OPERAND_X2
04E6   082A           00463         movfw VYSLEDEK3
04E7   00A2           00464         movwf OPERAND_X3
04E8   082B           00465         movfw VYSLEDEK4
04E9   00A3           00466         movwf OPERAND_X4
                      00467         BANK_0
04EA   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
04EB   1283               M                 bcf     STATUS,RP0    
04EC   26C8           00468         call ROZDIL                             ; VYSLEDEK := POCATEK_FAT + (2 * velikostFat) - (2 * CLU
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 48


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                            STER_SIZE)
04ED   0800           00469         movfw INDF
04EE   00C0           00470         movwf POCATEK_DAT1
04EF   0A84           00471         incf FSR,F
04F0   0800           00472         movfw INDF
04F1   00C1           00473         movwf POCATEK_DAT2
04F2   0A84           00474         incf FSR,F
04F3   0800           00475         movfw INDF
04F4   00C2           00476         movwf POCATEK_DAT3
04F5   0A84           00477         incf FSR,F
04F6   0800           00478         movfw INDF
04F7   00C3           00479         movwf POCATEK_DAT4
04F8   0A84           00480         incf FSR,F
                      00481         
                      00482         ; Tak ted uz to konecne mame, muzeme se pustit do prohlizeni adresaru a souboru...
                      00483 
04F9   162E           00484         bsf ATA_ATTRIBUTES,FAT32_LOAD   
04FA                  00485 NACTI_FAT32__KONEC
04FA   0008           00486         return  
                      00487 ;**************************************************************************
04FB                  00488 CLUSTER_TO_LBA
                      00489         ; vezme hodnoty v CLUSTER[1-4] a POZICE (sektor v clusteru) a do LBA 1-4 vypocita skutecnou pozi
                            ci na disku
                      00490         ; pro spravnou funkci musi byt POZICE < CLUSTER_SIZE (POZICE muze byt v rozsahu 0 .. CLUSTER_SIZ
                            E - 1)
                      00491         ; LBA := POCATEK_DAT + (CLUSTER * CLUSTER_SIZE) + POZICE
                      00492         INDF_BANK_1                             ; neprime adresovani do banku1
04FB   1383               M                         bcf STATUS,IRP    
04FC   30A0           00493         movlw 0xA0                                      ; OPERAND_X
04FD   0084           00494         movwf FSR
04FE   083C           00495         movfw CLUSTER1
04FF   0080           00496         movwf INDF
0500   0A84           00497         incf FSR,F
0501   083D           00498         movfw CLUSTER2
0502   0080           00499         movwf INDF
0503   0A84           00500         incf FSR,F
0504   083E           00501         movfw CLUSTER3
0505   0080           00502         movwf INDF
0506   0A84           00503         incf FSR,F
0507   083F           00504         movfw CLUSTER4
0508   0080           00505         movwf INDF
0509   0A84           00506         incf FSR,F
                      00507 
                      00508         ; Nejdriv se koukneme zda-li CLUSTER se nerovna 0, to bychom pak vratily 
                      00509         ; pozici na prvnim clusteru root adresare...
050A   27B1           00510         call NULA                                               ; if (X =  0) then PRETECENI := 0 else P
                            RETECENI := 1
                      00511         BANK_1
050B   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
050C   1683               M                 bsf     STATUS,RP0    
050D   182C           00512         btfsc PRETECENI,0
050E   2D1F           00513         goto CLUSTER_TO_LBA_NO_ROOT
                      00514         BANK_0
050F   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 49


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0510   1283               M                 bcf     STATUS,RP0    
0511   30A0           00515         movlw 0xA0                                      ; OPERAND_X
0512   0084           00516         movwf FSR
0513   0848           00517         movfw ROOT_DIR_CL1
0514   0080           00518         movwf INDF
0515   0A84           00519         incf FSR,F
0516   0849           00520         movfw ROOT_DIR_CL2
0517   0080           00521         movwf INDF
0518   0A84           00522         incf FSR,F
0519   084A           00523         movfw ROOT_DIR_CL3
051A   0080           00524         movwf INDF
051B   0A84           00525         incf FSR,F
051C   084B           00526         movfw ROOT_DIR_CL4
051D   0080           00527         movwf INDF
051E   0A84           00528         incf FSR,F
                      00529                 
051F                  00530 CLUSTER_TO_LBA_NO_ROOT
                      00531         BANK_0
051F   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0520   1283               M                 bcf     STATUS,RP0    
                      00532         ; CLUSTER_SIZE je vzdy exponentem 2 (1,2,4,8,16,32,64,128), proto tento jednoduchy zapis
0521   18CC           00533         btfsc CLUSTER_SIZE,1            ; 2
0522   270A           00534         call POSUNDOLEVA_1                      ; X := X * 2
0523   194C           00535         btfsc CLUSTER_SIZE,2            ; 4
0524   2712           00536         call POSUNDOLEVA_2                      ; X := X * 4
0525   19CC           00537         btfsc CLUSTER_SIZE,3            ; 8
0526   271B           00538         call POSUNDOLEVA_3                      ; X := X * 8
0527   1A4C           00539         btfsc CLUSTER_SIZE,4            ; 16
0528   2725           00540         call POSUNDOLEVA_4                      ; X := X * 4
0529   1ACC           00541         btfsc CLUSTER_SIZE,5            ; 32
052A   2730           00542         call POSUNDOLEVA_5                      ; X := X * 32
052B   1B4C           00543         btfsc CLUSTER_SIZE,6            ; 64
052C   273C           00544         call POSUNDOLEVA_6                      ; X := X * 64
052D   1BCC           00545         btfsc CLUSTER_SIZE,7            ; 128
052E   2749           00546         call POSUNDOLEVA_7                      ; X := X * 128
                      00547         
052F   0840           00548         movfw POCATEK_DAT1
0530   0080           00549         movwf INDF                                      ; OPERAND_Y
0531   0A84           00550         incf FSR,F
0532   0841           00551         movfw POCATEK_DAT2
0533   0080           00552         movwf INDF
0534   0A84           00553         incf FSR,F
0535   0842           00554         movfw POCATEK_DAT3
0536   0080           00555         movwf INDF
0537   0A84           00556         incf FSR,F
0538   0843           00557         movfw POCATEK_DAT4
0539   0080           00558         movwf INDF
053A   0A84           00559         incf FSR,F
                      00560 
053B   269C           00561         call SOUCET                                     ; VYSLEDEK := POCATEK_DAT + (CLUSTER * CLUSTER_S
                            IZE)
                      00562 
                      00563         ; zbyva tedy k vysledku pricist POZICE a dat nasledny vysledek do LBA    
053C   083B           00564         movfw POZICE
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 50


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00565         BANK_1
053D   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
053E   1683               M                 bsf     STATUS,RP0    
053F   00A4           00566         movwf OPERAND_Y1
0540   01A5           00567         clrf OPERAND_Y2
0541   01A6           00568         clrf OPERAND_Y3
0542   01A7           00569         clrf OPERAND_Y4
0543   0828           00570         movfw VYSLEDEK1
0544   00A0           00571         movwf OPERAND_X1
0545   0829           00572         movfw VYSLEDEK2
0546   00A1           00573         movwf OPERAND_X2
0547   082A           00574         movfw VYSLEDEK3
0548   00A2           00575         movwf OPERAND_X3
0549   082B           00576         movfw VYSLEDEK4
054A   00A3           00577         movwf OPERAND_X4        
                      00578         BANK_0
054B   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
054C   1283               M                 bcf     STATUS,RP0    
054D   269C           00579         call SOUCET
                      00580 
                      00581         INDF_BANK_1                             ; neprime adresovani do banku1
054E   1383               M                         bcf STATUS,IRP    
054F   30A8           00582         movlw 0xA8                                      ; VYSLEDEK
0550   0084           00583         movwf FSR
0551   0800           00584         movfw INDF
0552   00A7           00585         movwf LBA1
0553   0A84           00586         incf FSR,F
0554   0800           00587         movfw INDF
0555   00A8           00588         movwf LBA2
0556   0A84           00589         incf FSR,F
0557   0800           00590         movfw INDF
0558   00A9           00591         movwf LBA3
0559   0A84           00592         incf FSR,F
055A   0800           00593         movfw INDF
055B   00AA           00594         movwf LBA4
055C   0A84           00595         incf FSR,F
                      00596         
055D   0008           00597         return
                      00598 ;**************************************************************************
055E                  00599 NEXT_CLUSTER
                      00600         ; V CLUSTER prijme cislo clusteru, podiva se do FATky na disku a v CLUSTER vrati 
                      00601         ; hodnotu clustru, ktery nasleduje v retezu clusteru.
                      00602         ; Pokud pozadovany cluster byl posledni v retezu vrati v reg. POZICE konstantu FFh
                      00603         ; Pokud soucasny cluster je prazdny (coz by se stat nemelo) vrati taky v POZICE FFh
                      00604         ; Jinak, pokud s vse povede, dame do POZICE 0
                      00605 
                      00606         ; ! PODPROGRAM NETESTUJE ZDA NEBYLO ZADANO VETSI CISLO NEZ JE POCET CLUSTERU !!!
                      00607         
055E   01BB           00608         clrf POZICE
                      00609         ; LBA := [(CLUSTER * 4) / 512 ] + POCATEK_FAT
                      00610         ; LBA := ( CLUSTER / 128 ) + POCATEK_FAT
                      00611         ; offset := CLUSTER mod 128 
                      00612         INDF_BANK_1                             ; neprime adresovani do banku1
055F   1383               M                         bcf STATUS,IRP    
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 51


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0560   30A0           00613         movlw 0xA0                                      ; OPERAND_X
0561   0084           00614         movwf FSR
0562   083C           00615         movfw CLUSTER1
0563   0080           00616         movwf INDF
0564   0A84           00617         incf FSR,F
0565   083D           00618         movfw CLUSTER2
0566   0080           00619         movwf INDF
0567   0A84           00620         incf FSR,F
0568   083E           00621         movfw CLUSTER3
0569   0080           00622         movwf INDF
056A   0A84           00623         incf FSR,F
056B   083F           00624         movfw CLUSTER4
056C   0080           00625         movwf INDF
                      00626 
                      00627         ; Nejdriv se koukneme zda-li CLUSTER se nerovna 0, to pak musime jako cluster brat prvni cluster
                             ROOT adr.
056D   27B1           00628         call NULA                                               ; if (X =  0) then PRETECENI := 0 else P
                            RETECENI := 1
                      00629         BANK_1
056E   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
056F   1683               M                 bsf     STATUS,RP0    
0570   182C           00630         btfsc PRETECENI,0
0571   2D82           00631         goto NEXT_CLUSTER_NO_ROOT
                      00632         BANK_0
0572   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0573   1283               M                 bcf     STATUS,RP0    
0574   30A0           00633         movlw 0xA0                                      ; OPERAND_X
0575   0084           00634         movwf FSR
0576   0848           00635         movfw ROOT_DIR_CL1
0577   0080           00636         movwf INDF
0578   0A84           00637         incf FSR,F
0579   0849           00638         movfw ROOT_DIR_CL2
057A   0080           00639         movwf INDF
057B   0A84           00640         incf FSR,F
057C   084A           00641         movfw ROOT_DIR_CL3
057D   0080           00642         movwf INDF
057E   0A84           00643         incf FSR,F
057F   084B           00644         movfw ROOT_DIR_CL4
0580   0080           00645         movwf INDF
0581   0A84           00646         incf FSR,F
                      00647                 
0582                  00648 NEXT_CLUSTER_NO_ROOT
                      00649         BANK_0
0582   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0583   1283               M                 bcf     STATUS,RP0    
                      00650         
0584   27A2           00651         call POSUNDOPRAVA_7     ; X := X div 128  ; PRETECENI := X mod 128
0585   30AC           00652         movlw 0xAC                                      ; PRETECENI
0586   0084           00653         movwf FSR
0587   0800           00654         movfw INDF
0588   00B6           00655         movwf TEMP1
                      00656 
0589   30A4           00657         movlw 0xA4                                      ; OPERAND_Y
058A   0084           00658         movwf FSR
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 52


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

058B   0844           00659         movfw POCATEK_FAT1
058C   0080           00660         movwf INDF
058D   0A84           00661         incf FSR,F
058E   0845           00662         movfw POCATEK_FAT2
058F   0080           00663         movwf INDF
0590   0A84           00664         incf FSR,F
0591   0846           00665         movfw POCATEK_FAT3
0592   0080           00666         movwf INDF
0593   0A84           00667         incf FSR,F
0594   0847           00668         movfw POCATEK_FAT4
0595   0080           00669         movwf INDF
0596   0A84           00670         incf FSR,F
                      00671 
0597   269C           00672         call SOUCET
                      00673         
0598   0800           00674         movfw INDF                                      ; FSR ukazuje na VYSLEDEK
0599   00A7           00675         movwf LBA1
059A   0A84           00676         incf FSR,F
059B   0800           00677         movfw INDF
059C   00A8           00678         movwf LBA2
059D   0A84           00679         incf FSR,F
059E   0800           00680         movfw INDF
059F   00A9           00681         movwf LBA3
05A0   0A84           00682         incf FSR,F
05A1   0800           00683         movfw INDF
05A2   00AA           00684         movwf LBA4
05A3   0A84           00685         incf FSR,F
                      00686         
05A4   01A4           00687         clrf FEATURES
05A5   3001           00688         movlw .1
05A6   00A6           00689         movwf SECTOR_C
05A7   22DE           00690         call READ_SECTOR
                      00691 
05A8   1003           00692         bcf STATUS,C                            ; TEMP1 := CLUSTER mod 128 (TEMP1 je v intervalu 0..127)
05A9   0D36           00693         rlf TEMP1,W                                     ; W := TEMP1 * 2
05AA   00B6           00694         movwf TEMP1
05AB   39FF           00695         andlw h'FF'
05AC   1D03           00696         btfss STATUS,Z
05AD   22A1           00697         call PRESKOC                            ; pokud je zaznam o clusteru na nulte pozici v sektoru, 
                            nic preskakovat nebudem...
                      00698 
                      00699 
05AE   30A0           00700         movlw 0xA0                                      ; OPERAND_X
05AF   0084           00701         movwf FSR               
05B0   2286           00702         call READ_DATA  
05B1   0820           00703         movfw DATA_L
05B2   0080           00704         movwf INDF
05B3   00BC           00705         movwf CLUSTER1
05B4   0A84           00706         incf FSR,F
05B5   0821           00707         movfw DATA_H
05B6   0080           00708         movwf INDF
05B7   00BD           00709         movwf CLUSTER2
05B8   0A84           00710         incf FSR,F      
05B9   2286           00711         call READ_DATA  
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 53


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

05BA   0820           00712         movfw DATA_L
05BB   0080           00713         movwf INDF
05BC   00BE           00714         movwf CLUSTER3
05BD   0A84           00715         incf FSR,F
05BE   0821           00716         movfw DATA_H
05BF   0080           00717         movwf INDF
05C0   00BF           00718         movwf CLUSTER4
05C1   0A84           00719         incf FSR,F
                      00720 
                      00721         ; ted mame hodnotu clusteru ktery nam byl na pocatku predan v reg. CLUSTER, podivame se zda neby
                            l nasledkem 
                      00722         ; nejake chyby prazdny, nebo zda neni posledni v alokacnim retezu
05C2   27B1           00723         call NULA                                               ; if (OPERAND_X =  0) then PRETECENI := 
                            0 else PRETECENI := 1
                      00724         BANK_1
05C3   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
05C4   1683               M                 bsf     STATUS,RP0    
05C5   182C           00725         btfsc PRETECENI,0
05C6   2DCC           00726         goto NEXT_CLUSTER_NEPRAZDNY
                      00727         BANK_0
05C7   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
05C8   1283               M                 bcf     STATUS,RP0    
05C9   30FF           00728         movlw h'FF'
05CA   00BB           00729         movwf POZICE
05CB   2DE3           00730         goto NEXT_CLUSTER_KONEC                 ; Nevim sice jak by se toto mohlo stat, ale cluster byl 
                            prazdny, proto neni jiz co resit..
05CC                  00731 NEXT_CLUSTER_NEPRAZDNY
                      00732         BANK_0
05CC   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
05CD   1283               M                 bcf     STATUS,RP0    
                      00733         ; Ted se podivame zda cluster nebyl posledni v alokacnim retezu -> cluster >= 0x0FFFFFF7
05CE   30F7           00734         movlw 0xF7
05CF   0080           00735         movwf INDF
05D0   0A84           00736         incf FSR,F
05D1   30FF           00737         movlw 0xFF
05D2   0080           00738         movwf INDF
05D3   0A84           00739         incf FSR,F
05D4   30FF           00740         movlw 0xFF
05D5   0080           00741         movwf INDF
05D6   0A84           00742         incf FSR,F
05D7   300F           00743         movlw 0x0F
05D8   0080           00744         movwf INDF
05D9   0A84           00745         incf FSR,F
                      00746         
05DA   26C8           00747         call ROZDIL                                             ; VYSLEDEK := X - Y 
                      00748                                                                         ; pri podteceni PRETECENI = 1 ( 
                            VYSLEDEK < 0 => PRETECENI = 1 )
                      00749         BANK_1
05DB   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
05DC   1683               M                 bsf     STATUS,RP0    
05DD   182C           00750         btfsc PRETECENI,0
05DE   2DE3           00751         goto NEXT_CLUSTER_KONEC
                      00752         BANK_0
05DF   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 54


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

05E0   1283               M                 bcf     STATUS,RP0    
05E1   30FF           00753         movlw h'FF'
05E2   00BB           00754         movwf POZICE
05E3                  00755 NEXT_CLUSTER_KONEC
                      00756         BANK_0
05E3   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
05E4   1283               M                 bcf     STATUS,RP0    
05E5   0008           00757         return
                      00758 ;**************************************************************************
05E6                  00759 ZJISTI_FRAGMENT
                      00760 ; v CLUSTER[1-4] prijme cislo clusteru a do FRAGMENT[1-2] umisti kolik clusteru 
                      00761 ; po tomto clusteru nasledujich tvori jeden fragment
                      00762 ; (pokud je retezec tvoren pouze z tohoto clusteru, je vraceno cislo 0)
                      00763 
                      00764 ; Pokud soucasny cluster je prazdny (coz by se stat nemelo) vrati v POZICE FFh
                      00765 ; Jinak, pokud s vse povede, dame do POZICE 0
                      00766 
                      00767 ; ! PODPROGRAM NENI POUZITELNY PRO CLUSTER 0 (prvni cluster ROOT adresare)
                      00768 ; ! PODPROGRAM NETESTUJE ZDA NEBYLO ZADANO VETSI CISLO NEZ JE POCET CLUSTERU !!!
                      00769         
05E6   01BB           00770         clrf POZICE
05E7   01D2           00771         clrf FRAGMENT2
                      00772         ;movlw .1
                      00773         ;movwf FRAGMENT1
05E8   01D1           00774         clrf FRAGMENT1
                      00775         ; LBA := [(CLUSTER * 4) / 512 ] + POCATEK_FAT
                      00776         ; LBA := ( CLUSTER / 128 ) + POCATEK_FAT
                      00777         ; offset := CLUSTER mod 128 
                      00778         INDF_BANK_1                             ; neprime adresovani do banku1
05E9   1383               M                         bcf STATUS,IRP    
05EA   30A0           00779         movlw 0xA0                                      ; OPERAND_X
05EB   0084           00780         movwf FSR
05EC   083C           00781         movfw CLUSTER1
05ED   00DA           00782         movwf HL_ADR_CL1                        ; v HL_ADR_CL[1-4] mam hodnotu clusteru na predchozim za
                            znamu, proto si prvni cluster dame sem
05EE   0080           00783         movwf INDF
05EF   0A84           00784         incf FSR,F
05F0   083D           00785         movfw CLUSTER2
05F1   00DB           00786         movwf HL_ADR_CL2
05F2   0080           00787         movwf INDF
05F3   0A84           00788         incf FSR,F
05F4   083E           00789         movfw CLUSTER3
05F5   00DC           00790         movwf HL_ADR_CL3
05F6   0080           00791         movwf INDF
05F7   0A84           00792         incf FSR,F
05F8   083F           00793         movfw CLUSTER4
05F9   00DD           00794         movwf HL_ADR_CL4
05FA   0080           00795         movwf INDF
                      00796 
05FB   27A2           00797         call POSUNDOPRAVA_7                     ; X := X div 128  ; PRETECENI := X mod 128
05FC   30AC           00798         movlw 0xAC                                      ; PRETECENI
05FD   0084           00799         movwf FSR
05FE   0800           00800         movfw INDF
05FF   00BA           00801         movwf TEMP5                                     ; TEMP5 := CLUSTER mod 128 (TEMP5 je v intervalu
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 55


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                             0..127)
                      00802 ;       bcf STATUS,C                            
                      00803 ;       rlf TEMP2,W                                     ; W := TEMP1 * 2
                      00804 
0600   30A4           00805         movlw 0xA4                                      ; OPERAND_Y
0601   0084           00806         movwf FSR
0602   0844           00807         movfw POCATEK_FAT1
0603   0080           00808         movwf INDF
0604   0A84           00809         incf FSR,F
0605   0845           00810         movfw POCATEK_FAT2
0606   0080           00811         movwf INDF
0607   0A84           00812         incf FSR,F
0608   0846           00813         movfw POCATEK_FAT3
0609   0080           00814         movwf INDF
060A   0A84           00815         incf FSR,F
060B   0847           00816         movfw POCATEK_FAT4
060C   0080           00817         movwf INDF
060D   0A84           00818         incf FSR,F
                      00819 
060E   269C           00820         call SOUCET
                      00821         
060F   0800           00822         movfw INDF                                      ; FSR ukazuje na VYSLEDEK
0610   00A7           00823         movwf LBA1
0611   0A84           00824         incf FSR,F
0612   0800           00825         movfw INDF
0613   00A8           00826         movwf LBA2
0614   0A84           00827         incf FSR,F
0615   0800           00828         movfw INDF
0616   00A9           00829         movwf LBA3
0617   0A84           00830         incf FSR,F
0618   0800           00831         movfw INDF
0619   00AA           00832         movwf LBA4
061A   0A84           00833         incf FSR,F
                      00834 
061B   01A4           00835         clrf FEATURES
061C   3001           00836         movlw .1
061D   00A6           00837         movwf SECTOR_C
061E   22DE           00838         call READ_SECTOR
                      00839 
061F   1003           00840         bcf STATUS,C
0620   0D3A           00841         rlf TEMP5,w
0621   00B6           00842         movwf TEMP1                                     ; TEMP1 := TEMP5 * 2
0622   083A           00843         movfw TEMP5
0623   39FF           00844         andlw h'FF'
0624   1D03           00845         btfss STATUS,Z
0625   22A1           00846         call PRESKOC                            ; pokud je zaznam o clusteru na nulte pozici v sektoru, 
                            nic preskakovat nebudem...
                      00847                                                                 ; preskakujeme pouze na zacatku, pak jdo
                            u hezky za sebou
0626   2E2B           00848         goto ZJISTI_FRAGMENT_CLUSTER
0627                  00849 ZJISTI_FRAGMENT_CTI_SECTOR
                      00850 
0627   01A4           00851         clrf FEATURES
0628   3001           00852         movlw .1
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 56


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0629   00A6           00853         movwf SECTOR_C
062A   22DE           00854         call READ_SECTOR
                      00855 
062B                  00856 ZJISTI_FRAGMENT_CLUSTER
062B   30A0           00857         movlw 0xA0                                      ; OPERAND_X
062C   0084           00858         movwf FSR               
062D   2286           00859         call READ_DATA  
062E   0820           00860         movfw DATA_L
062F   0080           00861         movwf INDF
0630   0A84           00862         incf FSR,F
0631   0821           00863         movfw DATA_H
0632   0080           00864         movwf INDF
0633   0A84           00865         incf FSR,F      
0634   2286           00866         call READ_DATA  
0635   0820           00867         movfw DATA_L
0636   0080           00868         movwf INDF
0637   0A84           00869         incf FSR,F
0638   0821           00870         movfw DATA_H
0639   0080           00871         movwf INDF
063A   0A84           00872         incf FSR,F
                      00873 
                      00874 
                      00875         ; ted mame hodnotu clusteru v OPERAND_X. pokud je posledni v retezci, nebo je prazdny, tak konci
                            me
063B   27B1           00876         call NULA                                               ; if (OPERAND_X =  0) then PRETECENI := 
                            0 else PRETECENI := 1
                      00877         BANK_1
063C   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
063D   1683               M                 bsf     STATUS,RP0    
063E   182C           00878         btfsc PRETECENI,0
063F   2E43           00879         goto ZJISTI_FRAGMENT_NEPRAZDNY
                      00880         BANK_0
0640   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0641   1283               M                 bcf     STATUS,RP0    
0642   2E99           00881         goto ZJISTI_FRAGMENT_KONEC                      ; Nevim sice jak by se toto mohlo stat, ale clus
                            ter byl prazdny, proto neni jiz co resit..
0643                  00882 ZJISTI_FRAGMENT_NEPRAZDNY
                      00883         BANK_0
0643   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0644   1283               M                 bcf     STATUS,RP0    
                      00884 
                      00885         ; Ted se podivame zda cluster nebyl posledni v alokacnim retezu -> cluster >= 0x0FFFFFF7
0645   30F7           00886         movlw 0xF7
0646   0080           00887         movwf INDF
0647   0A84           00888         incf FSR,F
0648   30FF           00889         movlw 0xFF
0649   0080           00890         movwf INDF
064A   0A84           00891         incf FSR,F
064B   30FF           00892         movlw 0xFF
064C   0080           00893         movwf INDF
064D   0A84           00894         incf FSR,F
064E   300F           00895         movlw 0x0F
064F   0080           00896         movwf INDF
0650   0A84           00897         incf FSR,F
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 57


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00898         
0651   26C8           00899         call ROZDIL                                             ; VYSLEDEK := X - Y 
                      00900                                                                         ; pri podteceni PRETECENI = 1 ( 
                            VYSLEDEK < 0 => PRETECENI = 1 )
                      00901         BANK_1
0652   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0653   1683               M                 bsf     STATUS,RP0    
0654   1C2C           00902         btfss PRETECENI,0                               ; pokud je vysledek zaporny, je neni cluster pos
                            ledni a my pokracujeme...
0655   2E99           00903         goto ZJISTI_FRAGMENT_KONEC
                      00904         BANK_0
0656   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0657   1283               M                 bcf     STATUS,RP0    
                      00905 
0658   30A4           00906         movlw 0xA4                                              ; OPERAND_Y
0659   0084           00907         movwf FSR               
065A   085A           00908         movfw HL_ADR_CL1                                ; v HL_ADR_CL[1-4] mam hodnotu clusteru na predc
                            hozim zaznamu
065B   0080           00909         movwf INDF
065C   0A84           00910         incf FSR,F
065D   085B           00911         movfw HL_ADR_CL2
065E   0080           00912         movwf INDF
065F   0A84           00913         incf FSR,F
0660   085C           00914         movfw HL_ADR_CL3
0661   0080           00915         movwf INDF
0662   0A84           00916         incf FSR,F
0663   085D           00917         movfw HL_ADR_CL4
0664   0080           00918         movwf INDF
                      00919 
                      00920 
0665   26C8           00921         call ROZDIL                                             ; VYSLEDEK := SOUCASNY_CL - PREDCHOZI_CL
                      00922                                                                         ; vysledek se musi rovnat 1
                      00923         BANK_1
0666   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0667   1683               M                 bsf     STATUS,RP0    
0668   082B           00924         movfw VYSLEDEK4
0669   042A           00925         iorwf VYSLEDEK3,W
066A   0429           00926         iorwf VYSLEDEK2,W
066B   1D03           00927         btfss STATUS,Z
066C   2E99           00928         goto ZJISTI_FRAGMENT_KONEC
066D   0828           00929         movfw VYSLEDEK1
066E   3C01           00930         sublw .1
066F   1D03           00931         btfss STATUS,Z
0670   2E99           00932         goto ZJISTI_FRAGMENT_KONEC
                      00933         BANK_0
0671   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0672   1283               M                 bcf     STATUS,RP0    
                      00934 
                      00935         ; OK, ted vime, ze predchozi cluster byl o jednu mensi, nez soucasny...
                      00936         ; podivame se zda neni FRAGMENT moc velky...
0673   1BD2           00937         btfsc FRAGMENT2,7
0674   2E99           00938         goto ZJISTI_FRAGMENT_KONEC
                      00939         
                      00940         ; FRAGMENT++
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 58


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0675   0AD1           00941         incf FRAGMENT1,f
0676   1903           00942         btfsc STATUS,Z
0677   0AD2           00943         incf FRAGMENT2,f
                      00944 
0678   30A0           00945         movlw 0xA0                                              ; OPERAND_X
0679   0084           00946         movwf FSR               
067A   0800           00947         movfw INDF
067B   00DA           00948         movwf HL_ADR_CL1                                ; v HL_ADR_CL[1-4] mam hodnotu clusteru na predc
                            hozim zaznamu
067C   0A84           00949         incf FSR,F
067D   0800           00950         movfw INDF
067E   00DB           00951         movwf HL_ADR_CL2
067F   0A84           00952         incf FSR,F
0680   0800           00953         movfw INDF
0681   00DC           00954         movwf HL_ADR_CL3
0682   0A84           00955         incf FSR,F
0683   0800           00956         movfw INDF
0684   00DD           00957         movwf HL_ADR_CL4
                      00958 
                      00959 
0685   0ABA           00960         incf TEMP5,f
0686   083A           00961         movfw TEMP5
0687   3C80           00962         sublw .128
0688   1D03           00963         btfss STATUS,Z
0689   2E2B           00964         goto ZJISTI_FRAGMENT_CLUSTER
                      00965 
068A   01BA           00966         clrf TEMP5
                      00967 
                      00968         ; LBA++
068B   3001           00969         movlw .1
068C   07A7           00970         addwf LBA1,f
068D   1C03           00971         btfss STATUS,C
068E   2E96           00972         goto ZJISTI_FRAGMENT_INC_KONEC
068F   07A8           00973         addwf LBA2,f
0690   1C03           00974         btfss STATUS,C
0691   2E96           00975         goto ZJISTI_FRAGMENT_INC_KONEC
0692   07A9           00976         addwf LBA3,f
0693   1C03           00977         btfss STATUS,C
0694   2E96           00978         goto ZJISTI_FRAGMENT_INC_KONEC
0695   07AA           00979         addwf LBA4,f
0696                  00980 ZJISTI_FRAGMENT_INC_KONEC
                      00981 
                      00982         BANK_0
0696   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0697   1283               M                 bcf     STATUS,RP0    
0698   2E27           00983         goto ZJISTI_FRAGMENT_CTI_SECTOR
                      00984 
0699                  00985 ZJISTI_FRAGMENT_KONEC
                      00986         BANK_0
0699   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
069A   1283               M                 bcf     STATUS,RP0    
069B   0008           00987         return
                      00988 ;**************************************************************************
                      00075         include "aritmetic.asm" ; podprogramy vykonavajici zakladni aritmetologicke operace
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 59


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00001 ;**********************************************************
                      00002 ;**********************************************************
                      00003 ;**********************************************************
                      00004 ; Obsahuje podrogramy realizujici zakladni aritmeticke operace
                      00005 ; pouzivane v mp3 preprcavaci. Vsechny operace se provadi 
                      00006 ; s 32bitovymi cisly.
                      00007 ; 
                      00008 ; Pro praci aritmetickych procedur je rezervovana BANKA 1 !!!!!
                      00009 ;**********************************************************
                      00010 ;**********************************************************
                      00011 ;**********************************************************
069C                  00012 SOUCET
                      00013 ; provede soucet hodnoty v registrech OPERAND_X[1..4] 
                      00014 ; s hodnotou v OPERAND_Y[1..4] a umisti do VYSLEDEK[1..4] 
                      00015 ; pokud dojde k preteceni, nastavi se PRETECENI do 1
                      00016 ; (byty s indexem 1 maji nejnizsi vahu)
                      00017         BANK_1
069C   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
069D   1683               M                 bsf     STATUS,RP0    
069E   01AC           00018         clrf PRETECENI
                      00019 
069F   0820           00020         movfw OPERAND_X1
06A0   0724           00021         addwf OPERAND_Y1,W
06A1   00A8           00022         movwf VYSLEDEK1
06A2   1803           00023         btfsc STATUS,C
06A3   14AC           00024                 bsf PRETECENI,1
                      00025 
06A4   0821           00026         movfw OPERAND_X2
06A5   0725           00027         addwf OPERAND_Y2,W
06A6   00A9           00028         movwf VYSLEDEK2
06A7   3001           00029         movlw .1
06A8   1803           00030         btfsc STATUS,C
06A9   142C           00031                 bsf PRETECENI,0
06AA   18AC           00032         btfsc PRETECENI,1
06AB   07A9           00033                 addwf VYSLEDEK2,F
06AC   1803           00034         btfsc STATUS,C
06AD   142C           00035                 bsf PRETECENI,0
06AE   10AC           00036         bcf PRETECENI,1
                      00037 
06AF   0822           00038         movfw OPERAND_X3
06B0   0726           00039         addwf OPERAND_Y3,W
06B1   00AA           00040         movwf VYSLEDEK3
06B2   3001           00041         movlw .1
06B3   1803           00042         btfsc STATUS,C
06B4   14AC           00043                 bsf PRETECENI,1
06B5   182C           00044         btfsc PRETECENI,0
06B6   07AA           00045                 addwf VYSLEDEK3,F
06B7   1803           00046         btfsc STATUS,C
06B8   14AC           00047                 bsf PRETECENI,1
06B9   102C           00048         bcf PRETECENI,0
                      00049 
06BA   0823           00050         movfw OPERAND_X4
06BB   0727           00051         addwf OPERAND_Y4,W
06BC   00AB           00052         movwf VYSLEDEK4
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 60


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

06BD   3001           00053         movlw .1
06BE   1803           00054         btfsc STATUS,C
06BF   142C           00055                 bsf PRETECENI,0
06C0   18AC           00056         btfsc PRETECENI,1
06C1   07AB           00057                 addwf VYSLEDEK4,F
06C2   1803           00058         btfsc STATUS,C
06C3   142C           00059                 bsf PRETECENI,0
06C4   10AC           00060         bcf PRETECENI,1 
                      00061 
                      00062         BANK_0
06C5   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
06C6   1283               M                 bcf     STATUS,RP0    
06C7   0008           00063         return
                      00064 ;**********************************************************
                      00065 ;**********************************************************
06C8                  00066 ROZDIL  ; VYSLEDEK := X - Y
                      00067                 ; pri podteceni PRETECENI = 1 ( VYSLEDEK < 0 => PRETECENI = 1 )
                      00068         BANK_1
06C8   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
06C9   1683               M                 bsf     STATUS,RP0    
06CA   01AC           00069         clrf PRETECENI
                      00070 
06CB   0824           00071         movfw OPERAND_Y1
06CC   0220           00072         subwf OPERAND_X1,W      ; W = X - Y     
06CD   00A8           00073         movwf VYSLEDEK1
06CE   1C03           00074         btfss STATUS,C
06CF   14AC           00075                 bsf PRETECENI,1
                      00076         
06D0   0825           00077         movfw OPERAND_Y2
06D1   0221           00078         subwf OPERAND_X2,W      ; W = X - Y     
06D2   00A9           00079         movwf VYSLEDEK2
06D3   3001           00080         movlw .1
06D4   1C03           00081         btfss STATUS,C
06D5   142C           00082                 bsf PRETECENI,0
06D6   18AC           00083         btfsc PRETECENI,1
06D7   02A9           00084                 subwf VYSLEDEK2,F
06D8   1C03           00085         btfss STATUS,C
06D9   142C           00086                 bsf PRETECENI,0
06DA   10AC           00087         bcf PRETECENI,1 
                      00088         
06DB   0826           00089         movfw OPERAND_Y3
06DC   0222           00090         subwf OPERAND_X3,W      ; W = X - Y     
06DD   00AA           00091         movwf VYSLEDEK3
06DE   3001           00092         movlw .1
06DF   1C03           00093         btfss STATUS,C
06E0   14AC           00094                 bsf PRETECENI,1
06E1   182C           00095         btfsc PRETECENI,0
06E2   02AA           00096                 subwf VYSLEDEK3,F
06E3   1C03           00097         btfss STATUS,C
06E4   14AC           00098                 bsf PRETECENI,1
06E5   102C           00099         bcf PRETECENI,0
                      00100         
06E6   0827           00101         movfw OPERAND_Y4
06E7   0223           00102         subwf OPERAND_X4,W      ; W = X - Y     
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 61


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

06E8   00AB           00103         movwf VYSLEDEK4
06E9   3001           00104         movlw .1
06EA   1C03           00105         btfss STATUS,C
06EB   142C           00106                 bsf PRETECENI,0
06EC   18AC           00107         btfsc PRETECENI,1
06ED   02AB           00108                 subwf VYSLEDEK4,F
06EE   1C03           00109         btfss STATUS,C
06EF   142C           00110                 bsf PRETECENI,0
06F0   10AC           00111         bcf PRETECENI,1 
                      00112         
                      00113         BANK_0
06F1   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
06F2   1283               M                 bcf     STATUS,RP0    
06F3   0008           00114         return
                      00115 ;**********************************************************
06F4                  00116 DEKREMENTUJ     ; X := X - 1
                      00117         BANK_1
06F4   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
06F5   1683               M                 bsf     STATUS,RP0    
06F6   3001           00118         movlw .1
                      00119 
06F7   02A0           00120         subwf OPERAND_X1,f
06F8   1803           00121         btfsc STATUS,C
06F9   2F01           00122         goto DEKREMENTUJ_KONEC
                      00123         
06FA   02A1           00124         subwf OPERAND_X2,f
06FB   1803           00125         btfsc STATUS,C
06FC   2F01           00126         goto DEKREMENTUJ_KONEC
                      00127 
06FD   02A2           00128         subwf OPERAND_X3,f
06FE   1803           00129         btfsc STATUS,C
06FF   2F01           00130         goto DEKREMENTUJ_KONEC
                      00131 
0700   02A3           00132         subwf OPERAND_X4,f
0701                  00133 DEKREMENTUJ_KONEC
                      00134         BANK_0
0701   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0702   1283               M                 bcf     STATUS,RP0    
0703   0008           00135         return
                      00136 ;**********************************************************
0704                  00137 POSUNDOLEVA     ; X := (X * 2) mod 0xFFFFFFFF , PRETECENI := (X * 2) div 0xFFFFFFFF
                      00138                         ; tento podprogram nepouzivat, primo v hlavnim programu
                      00139                         ; musi se nastavit BANK_1 a vymazat PRETECENI!!!
                      00140                         ; (je pouze pro pouziti v nasobicich podprogramech)
                      00141                         ; pouzivat jen POSUNDOLEVA_1, 2, 3, 4 
0704   0DA0           00142         rlf OPERAND_X1,F
0705   0DA1           00143         rlf OPERAND_X2,F
0706   0DA2           00144         rlf OPERAND_X3,F
0707   0DA3           00145         rlf OPERAND_X4,F
0708   0DAC           00146         rlf PRETECENI,F 
0709   0008           00147         return
                      00148 ;**********************************************************
070A                  00149 POSUNDOLEVA_1   ; X := X * 2
                      00150                                 ; X > 0xFFFF FFFF => PRETECENI obsahuje bity navic
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 62


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00151         BANK_1
070A   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
070B   1683               M                 bsf     STATUS,RP0    
070C   01AC           00152         clrf PRETECENI
070D   1003           00153         bcf STATUS,C
                      00154         
070E   2704           00155         call POSUNDOLEVA
                      00156 
                      00157         BANK_0
070F   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0710   1283               M                 bcf     STATUS,RP0    
0711   0008           00158         return
                      00159 ;**********************************************************
0712                  00160 POSUNDOLEVA_2   ; X := X * 4
                      00161                                 ; X > 0xFFFF FFFF => PRETECENI obsahuje bity navic
                      00162         BANK_1
0712   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0713   1683               M                 bsf     STATUS,RP0    
0714   01AC           00163         clrf PRETECENI
0715   1003           00164         bcf STATUS,C
                      00165         
0716   2704           00166         call POSUNDOLEVA
0717   2704           00167         call POSUNDOLEVA
                      00168 
                      00169         BANK_0
0718   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0719   1283               M                 bcf     STATUS,RP0    
071A   0008           00170         return
                      00171 ;**********************************************************
071B                  00172 POSUNDOLEVA_3   ; X := X * 8
                      00173                                 ; X > 0xFFFF FFFF => PRETECENI obsahuje bity navic
                      00174         BANK_1
071B   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
071C   1683               M                 bsf     STATUS,RP0    
071D   01AC           00175         clrf PRETECENI
071E   1003           00176         bcf STATUS,C
                      00177         
071F   2704           00178         call POSUNDOLEVA
0720   2704           00179         call POSUNDOLEVA
0721   2704           00180         call POSUNDOLEVA
                      00181 
                      00182         BANK_0
0722   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0723   1283               M                 bcf     STATUS,RP0    
0724   0008           00183         return
                      00184 ;**********************************************************
0725                  00185 POSUNDOLEVA_4   ; X := X * 16
                      00186                                 ; X > 0xFFFF FFFF => PRETECENI obsahuje bity navic
                      00187         BANK_1
0725   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0726   1683               M                 bsf     STATUS,RP0    
0727   01AC           00188         clrf PRETECENI
0728   1003           00189         bcf STATUS,C
                      00190         
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 63


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0729   2704           00191         call POSUNDOLEVA
072A   2704           00192         call POSUNDOLEVA
072B   2704           00193         call POSUNDOLEVA
072C   2704           00194         call POSUNDOLEVA
                      00195 
                      00196         BANK_0
072D   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
072E   1283               M                 bcf     STATUS,RP0    
072F   0008           00197         return
                      00198 ;**********************************************************
0730                  00199 POSUNDOLEVA_5   ; X := X * 32
                      00200                                 ; X > 0xFFFF FFFF => PRETECENI obsahuje bity navic
                      00201         BANK_1
0730   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0731   1683               M                 bsf     STATUS,RP0    
0732   01AC           00202         clrf PRETECENI
0733   1003           00203         bcf STATUS,C
                      00204         
0734   2704           00205         call POSUNDOLEVA
0735   2704           00206         call POSUNDOLEVA
0736   2704           00207         call POSUNDOLEVA
0737   2704           00208         call POSUNDOLEVA
0738   2704           00209         call POSUNDOLEVA
                      00210 
                      00211         BANK_0
0739   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
073A   1283               M                 bcf     STATUS,RP0    
073B   0008           00212         return
                      00213 ;**********************************************************
073C                  00214 POSUNDOLEVA_6   ; X := X * 64
                      00215                                 ; X > 0xFFFF FFFF => PRETECENI obsahuje bity navic
                      00216         BANK_1
073C   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
073D   1683               M                 bsf     STATUS,RP0    
073E   01AC           00217         clrf PRETECENI
073F   1003           00218         bcf STATUS,C
                      00219         
0740   2704           00220         call POSUNDOLEVA
0741   2704           00221         call POSUNDOLEVA
0742   2704           00222         call POSUNDOLEVA
0743   2704           00223         call POSUNDOLEVA
0744   2704           00224         call POSUNDOLEVA
0745   2704           00225         call POSUNDOLEVA
                      00226 
                      00227         BANK_0
0746   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0747   1283               M                 bcf     STATUS,RP0    
0748   0008           00228         return
                      00229 ;**********************************************************
0749                  00230 POSUNDOLEVA_7   ; X := X * 128
                      00231                                 ; X > 0xFFFF FFFF => PRETECENI obsahuje bity navic
                      00232         BANK_1
0749   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
074A   1683               M                 bsf     STATUS,RP0    
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 64


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

074B   01AC           00233         clrf PRETECENI
074C   1003           00234         bcf STATUS,C
                      00235         
074D   2704           00236         call POSUNDOLEVA
074E   2704           00237         call POSUNDOLEVA
074F   2704           00238         call POSUNDOLEVA
0750   2704           00239         call POSUNDOLEVA
0751   2704           00240         call POSUNDOLEVA
0752   2704           00241         call POSUNDOLEVA
0753   2704           00242         call POSUNDOLEVA
                      00243 
                      00244         BANK_0
0754   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0755   1283               M                 bcf     STATUS,RP0    
0756   0008           00245         return
                      00246 ;**********************************************************
0757                  00247 POSUNDOPRAVA    ; X := X div 2 , PRETECENI := X mod 2
                      00248                         ; tento podprogram nepouzivat, primo v hlavnim programu
                      00249                         ; musi se nastavit BANK_1 a vymazat PRETECENI!!!
                      00250                         ; (je pouze pro pouziti v nasobicich podprogramech)
                      00251                         ; pouzivat jen POSUNDOPRAVA_1, 2, 3, 4 
0757   1003           00252         bcf STATUS,C
0758   0CA3           00253         rrf OPERAND_X4,F
0759   0CA2           00254         rrf OPERAND_X3,F
075A   0CA1           00255         rrf OPERAND_X2,F
075B   0CA0           00256         rrf OPERAND_X1,F
075C   0008           00257         return
                      00258 ;**********************************************************
075D                  00259 POSUNDOPRAVA_1  ; X := X div 2
                      00260                                 ; PRETECENI := X mod 2
                      00261         BANK_1
075D   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
075E   1683               M                 bsf     STATUS,RP0    
075F   0820           00262         movfw OPERAND_X1
0760   3901           00263         andlw b'00000001'
0761   00AC           00264         movwf PRETECENI         ; PRETECENI := X mod 2
                      00265         
0762   2757           00266         call POSUNDOPRAVA
                      00267 
                      00268         BANK_0
0763   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0764   1283               M                 bcf     STATUS,RP0    
0765   0008           00269         return
                      00270 ;**********************************************************
0766                  00271 POSUNDOPRAVA_2  ; X := X div 4
                      00272                                 ; PRETECENI := X mod 4
                      00273         BANK_1
0766   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0767   1683               M                 bsf     STATUS,RP0    
0768   0820           00274         movfw OPERAND_X1
0769   3903           00275         andlw b'00000011'
076A   00AC           00276         movwf PRETECENI         ; PRETECENI := X mod 4
                      00277         
076B   2757           00278         call POSUNDOPRAVA
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 65


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

076C   2757           00279         call POSUNDOPRAVA
                      00280 
                      00281         BANK_0
076D   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
076E   1283               M                 bcf     STATUS,RP0    
076F   0008           00282         return
                      00283 ;**********************************************************
0770                  00284 POSUNDOPRAVA_3  ; X := X div 8
                      00285                                 ; PRETECENI := X mod 8
                      00286         BANK_1
0770   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0771   1683               M                 bsf     STATUS,RP0    
0772   0820           00287         movfw OPERAND_X1
0773   3907           00288         andlw b'00000111'
0774   00AC           00289         movwf PRETECENI         ; PRETECENI := X mod 8
                      00290         
0775   2757           00291         call POSUNDOPRAVA
0776   2757           00292         call POSUNDOPRAVA
0777   2757           00293         call POSUNDOPRAVA
                      00294 
                      00295         BANK_0
0778   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0779   1283               M                 bcf     STATUS,RP0    
077A   0008           00296         return
                      00297 ;**********************************************************
077B                  00298 POSUNDOPRAVA_4  ; X := X div 16
                      00299                                 ; PRETECENI := X mod 16
                      00300         BANK_1
077B   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
077C   1683               M                 bsf     STATUS,RP0    
077D   0820           00301         movfw OPERAND_X1
077E   390F           00302         andlw b'00001111'
077F   00AC           00303         movwf PRETECENI         ; PRETECENI := X mod 16
                      00304         
0780   2757           00305         call POSUNDOPRAVA
0781   2757           00306         call POSUNDOPRAVA
0782   2757           00307         call POSUNDOPRAVA
0783   2757           00308         call POSUNDOPRAVA
                      00309 
                      00310         BANK_0
0784   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0785   1283               M                 bcf     STATUS,RP0    
0786   0008           00311         return
                      00312 ;**********************************************************
0787                  00313 POSUNDOPRAVA_5  ; X := X div 32
                      00314                                 ; PRETECENI := X mod 32
                      00315         BANK_1
0787   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0788   1683               M                 bsf     STATUS,RP0    
0789   0820           00316         movfw OPERAND_X1
078A   391F           00317         andlw b'00011111'
078B   00AC           00318         movwf PRETECENI         ; PRETECENI := X mod 32
                      00319         
078C   2757           00320         call POSUNDOPRAVA
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 66


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

078D   2757           00321         call POSUNDOPRAVA
078E   2757           00322         call POSUNDOPRAVA
078F   2757           00323         call POSUNDOPRAVA
0790   2757           00324         call POSUNDOPRAVA
                      00325 
                      00326         BANK_0
0791   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0792   1283               M                 bcf     STATUS,RP0    
0793   0008           00327         return
                      00328 ;**********************************************************
0794                  00329 POSUNDOPRAVA_6  ; X := X div 64
                      00330                                 ; PRETECENI := X mod 64
                      00331         BANK_1
0794   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0795   1683               M                 bsf     STATUS,RP0    
0796   0820           00332         movfw OPERAND_X1
0797   393F           00333         andlw b'00111111'
0798   00AC           00334         movwf PRETECENI         ; PRETECENI := X mod 64
                      00335         
0799   2757           00336         call POSUNDOPRAVA
079A   2757           00337         call POSUNDOPRAVA
079B   2757           00338         call POSUNDOPRAVA
079C   2757           00339         call POSUNDOPRAVA
079D   2757           00340         call POSUNDOPRAVA
079E   2757           00341         call POSUNDOPRAVA
                      00342 
                      00343         BANK_0
079F   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
07A0   1283               M                 bcf     STATUS,RP0    
07A1   0008           00344         return
                      00345 ;**********************************************************
07A2                  00346 POSUNDOPRAVA_7  ; X := X div 128
                      00347                                 ; PRETECENI := X mod 128
                      00348         BANK_1
07A2   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
07A3   1683               M                 bsf     STATUS,RP0    
07A4   0820           00349         movfw OPERAND_X1
07A5   397F           00350         andlw b'01111111'
07A6   00AC           00351         movwf PRETECENI         ; PRETECENI := X mod 128
                      00352         
07A7   2757           00353         call POSUNDOPRAVA
07A8   2757           00354         call POSUNDOPRAVA
07A9   2757           00355         call POSUNDOPRAVA
07AA   2757           00356         call POSUNDOPRAVA
07AB   2757           00357         call POSUNDOPRAVA
07AC   2757           00358         call POSUNDOPRAVA
07AD   2757           00359         call POSUNDOPRAVA
                      00360 
                      00361         BANK_0
07AE   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
07AF   1283               M                 bcf     STATUS,RP0    
07B0   0008           00362         return
                      00363 ;**********************************************************
07B1                  00364 NULA    ; if (X =  0) then PRETECENI := 0
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 67


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00365                 ; if (X <> 0) then PRETECENI := 1
                      00366                 ; obsah X zustane nezmenen
                      00367         BANK_1
07B1   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
07B2   1683               M                 bsf     STATUS,RP0    
07B3   01AC           00368         clrf PRETECENI
07B4   30FF           00369         movlw h'FF'     
                      00370 
07B5   05A0           00371         andwf OPERAND_X1,F
07B6   1D03           00372         btfss STATUS,Z
07B7   142C           00373                 bsf PRETECENI,0
07B8   05A1           00374         andwf OPERAND_X2,F
07B9   1D03           00375         btfss STATUS,Z
07BA   142C           00376                 bsf PRETECENI,0
07BB   05A2           00377         andwf OPERAND_X3,F
07BC   1D03           00378         btfss STATUS,Z
07BD   142C           00379                 bsf PRETECENI,0
07BE   05A3           00380         andwf OPERAND_X4,F
07BF   1D03           00381         btfss STATUS,Z
07C0   142C           00382                 bsf PRETECENI,0         
                      00383 
                      00384         BANK_0
07C1   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
07C2   1283               M                 bcf     STATUS,RP0    
07C3   0008           00385         return
                      00386 ;**********************************************************
                      00076  
0800                  00077  org 0x0800                                     ; PAGE 1
                      00078 ;#IF VS1001==1
                      00079         include "vs1001.asm"    ; podprogramy na ovladani mp3 decoderu
                      00001 ;**********************************************************
                      00002 ;**********************************************************
                      00003 ;**********************************************************
                      00004 ; OBSLUZNE PODPROGRAMY PRO MP3 DECODER vs1001g
                      00005 ;**********************************************************
                      00006 ;**********************************************************
                      00007 ;**********************************************************
                      00008 
                      00009 ; MP3_PORT              
                      00010 ; MP3_PORT_TRIS 
                      00011 
                      00012 ; BITY MP3_PORT
                      00013 ; #define MP3_SO                MP3_PORT,0      ; serial output - tady dostavame z dekoderu data
                      00014 ; #define MP3_SI                MP3_PORT,1      ; serial input  - pokud MP3_CS=1, tak posilame mp3 data,
                             pokud =0, tak posilame prikaz
                      00015 ; #define MP3_SCLK              MP3_PORT,2      ; clock - nabezna hrana urcuje platnost dat pri seriovem
                             prenosu
                      00016 ; #define MP3_CS                MP3_PORT,3      ; cable select  - pokud MP3_CS=1, tak po SI posilame mp3
                             data, pokud =0, tak posilame prikaz
                      00017 ; #define MP3_DREQ              MP3_PORT,4      ; data request  - pokud =1, tak dekoder pozaduje dalsi m
                            p3 data (vic jak 32B)
                      00018 ; #define MP3_BSYNC             MP3_PORT,5      ; pro synchronizaci - ma byt nastaven pri prvnim prenase
                            nem bitu kazdeho bytu
                      00019 
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 68


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00020 ;**********************************************************
                      00021 ; co nejrychleji vodesle hodnotu ve W smerem k dekoderu (obsluhuje signaly DSYNC, SI, SCLK)
0800                  00022 VS_WR_BYTE
                      00023         ; k praci pouziva TEMPW
0800   00B5           00024         movwf TEMPW             ; dato co mame odeslat si hodime do tempu...
                      00025 
0801   1507           00026         bsf MP3_BSYNC   ; bude nasledovat prvni bit bytu, proto nastavime BSYNC
                      00027 
                      00028         ; 7. bit bytu
0802   1187           00029         bcf MP3_SCLK    ; shodime SCLK
0803   1287           00030         bcf MP3_SI              ; nevime zda bit bude 0 nebo 1, SI nulujeme
0804   0DB5           00031         rlf TEMPW,f             ; odesilame od nejvyssiho bitu k nejnizsimu
0805   1803           00032         btfsc STATUS,C
0806   1687           00033         bsf MP3_SI
0807   1587           00034         bsf MP3_SCLK
0808   1107           00035         bcf MP3_BSYNC
                      00036         
                      00037         ; 6. bit bytu
0809   1187           00038         bcf MP3_SCLK    ; shodime SCLK
080A   1287           00039         bcf MP3_SI              ; nevime zda bit bude 0 nebo 1, SI nulujeme
080B   0DB5           00040         rlf TEMPW,f             ; odesilame od nejvyssiho bitu k nejnizsimu
080C   1803           00041         btfsc STATUS,C
080D   1687           00042         bsf MP3_SI
080E   1587           00043         bsf MP3_SCLK
                      00044 
                      00045         ; 5. bit bytu
080F   1187           00046         bcf MP3_SCLK    ; shodime SCLK
0810   1287           00047         bcf MP3_SI              ; nevime zda bit bude 0 nebo 1, SI nulujeme
0811   0DB5           00048         rlf TEMPW,f             ; odesilame od nejvyssiho bitu k nejnizsimu
0812   1803           00049         btfsc STATUS,C
0813   1687           00050         bsf MP3_SI
0814   1587           00051         bsf MP3_SCLK
                      00052 
                      00053         ; 4. bit bytu
0815   1187           00054         bcf MP3_SCLK    ; shodime SCLK
0816   1287           00055         bcf MP3_SI              ; nevime zda bit bude 0 nebo 1, SI nulujeme
0817   0DB5           00056         rlf TEMPW,f             ; odesilame od nejvyssiho bitu k nejnizsimu
0818   1803           00057         btfsc STATUS,C
0819   1687           00058         bsf MP3_SI
081A   1587           00059         bsf MP3_SCLK
                      00060 
                      00061         ; 3. bit bytu
081B   1187           00062         bcf MP3_SCLK    ; shodime SCLK
081C   1287           00063         bcf MP3_SI              ; nevime zda bit bude 0 nebo 1, SI nulujeme
081D   0DB5           00064         rlf TEMPW,f             ; odesilame od nejvyssiho bitu k nejnizsimu
081E   1803           00065         btfsc STATUS,C
081F   1687           00066         bsf MP3_SI
0820   1587           00067         bsf MP3_SCLK
                      00068 
                      00069         ; 2. bit bytu
0821   1187           00070         bcf MP3_SCLK    ; shodime SCLK
0822   1287           00071         bcf MP3_SI              ; nevime zda bit bude 0 nebo 1, SI nulujeme
0823   0DB5           00072         rlf TEMPW,f             ; odesilame od nejvyssiho bitu k nejnizsimu
0824   1803           00073         btfsc STATUS,C
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 69


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0825   1687           00074         bsf MP3_SI
0826   1587           00075         bsf MP3_SCLK
                      00076 
                      00077         ; 1. bit bytu
0827   1187           00078         bcf MP3_SCLK    ; shodime SCLK
0828   1287           00079         bcf MP3_SI              ; nevime zda bit bude 0 nebo 1, SI nulujeme
0829   0DB5           00080         rlf TEMPW,f             ; odesilame od nejvyssiho bitu k nejnizsimu
082A   1803           00081         btfsc STATUS,C
082B   1687           00082         bsf MP3_SI
082C   1587           00083         bsf MP3_SCLK
                      00084 
                      00085         ; 0. bit bytu
082D   1187           00086         bcf MP3_SCLK    ; shodime SCLK
082E   1287           00087         bcf MP3_SI              ; nevime zda bit bude 0 nebo 1, SI nulujeme
082F   0DB5           00088         rlf TEMPW,f             ; odesilame od nejvyssiho bitu k nejnizsimu
0830   1803           00089         btfsc STATUS,C
0831   1687           00090         bsf MP3_SI
0832   1587           00091         bsf MP3_SCLK
                      00092 
0833   1187           00093         bcf MP3_SCLK
0834   0008           00094         return
                      00095 ;**********************************************************
                      00096 ; co nejrychleji prijme dato z vs1001 a umisti jej do W
0835                  00097 VS_RD_BYTE
                      00098         ; k praci pouziva TEMPW
                      00099 
0835   01B5           00100         clrf TEMPW              ; vymazeme, sem budeme strkat dato co nam prijde...
0836   1187           00101         bcf MP3_SCLK    ; shodime SCLK
0837   1507           00102         bsf MP3_BSYNC   ; bude nasledovat prvni bit bytu, proto nastavime BSYNC
0838   1003           00103         bcf STATUS,C    ; nulujeme priznak CARRY, staci to delat jen na zacatku, protoze TEMW mame prazd
                            ny...
                      00104 
                      00105         ; 7. bit bytu
0839   1587           00106         bsf MP3_SCLK    ; nabezna hrana SCLK
083A   1A07           00107         btfsc MP3_SO
083B   1403           00108         bsf STATUS,C    ; pokud je SO v jednice nastavime C...
083C   0DB5           00109         rlf TEMPW,f
083D   1187           00110         bcf MP3_SCLK    ; shodime SCLK
                      00111 
083E   1107           00112         bcf MP3_BSYNC
                      00113 
                      00114         ; 6. bit bytu
083F   1587           00115         bsf MP3_SCLK    ; nabezna hrana SCLK
0840   1A07           00116         btfsc MP3_SO
0841   1403           00117         bsf STATUS,C    ; pokud je SO v jednice nastavime C...
0842   0DB5           00118         rlf TEMPW,f
0843   1187           00119         bcf MP3_SCLK    ; shodime SCLK  
                      00120 
                      00121         ; 5. bit bytu
0844   1587           00122         bsf MP3_SCLK    ; nabezna hrana SCLK
0845   1A07           00123         btfsc MP3_SO
0846   1403           00124         bsf STATUS,C    ; pokud je SO v jednice nastavime C...
0847   0DB5           00125         rlf TEMPW,f
0848   1187           00126         bcf MP3_SCLK    ; shodime SCLK  
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 70


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00127 
                      00128         ; 4. bit bytu
0849   1587           00129         bsf MP3_SCLK    ; nabezna hrana SCLK
084A   1A07           00130         btfsc MP3_SO
084B   1403           00131         bsf STATUS,C    ; pokud je SO v jednice nastavime C...
084C   0DB5           00132         rlf TEMPW,f
084D   1187           00133         bcf MP3_SCLK    ; shodime SCLK  
                      00134 
                      00135         ; 3. bit bytu
084E   1587           00136         bsf MP3_SCLK    ; nabezna hrana SCLK
084F   1A07           00137         btfsc MP3_SO
0850   1403           00138         bsf STATUS,C    ; pokud je SO v jednice nastavime C...
0851   0DB5           00139         rlf TEMPW,f
0852   1187           00140         bcf MP3_SCLK    ; shodime SCLK  
                      00141 
                      00142         ; 2. bit bytu
0853   1587           00143         bsf MP3_SCLK    ; nabezna hrana SCLK
0854   1A07           00144         btfsc MP3_SO
0855   1403           00145         bsf STATUS,C    ; pokud je SO v jednice nastavime C...
0856   0DB5           00146         rlf TEMPW,f
0857   1187           00147         bcf MP3_SCLK    ; shodime SCLK  
                      00148 
                      00149         ; 1. bit bytu
0858   1587           00150         bsf MP3_SCLK    ; nabezna hrana SCLK
0859   1A07           00151         btfsc MP3_SO
085A   1403           00152         bsf STATUS,C    ; pokud je SO v jednice nastavime C...
085B   0DB5           00153         rlf TEMPW,f
085C   1187           00154         bcf MP3_SCLK    ; shodime SCLK  
                      00155 
                      00156         ; 0. bit bytu
085D   1587           00157         bsf MP3_SCLK    ; nabezna hrana SCLK
085E   1A07           00158         btfsc MP3_SO
085F   1403           00159         bsf STATUS,C    ; pokud je SO v jednice nastavime C...
0860   0D35           00160         rlf TEMPW,W
0861   1187           00161         bcf MP3_SCLK    ; shodime SCLK  
                      00162 
                      00163         ; movfw TEMPW ; tuto operaci jiz nemusime provadet, protoze jsme posledni rotaci hodily do W (rl
                            f TEMPW,W)
0862   0008           00164         return
                      00165 ;**********************************************************
                      00166 ; do TEMP1 dame adresu registru 
                      00167 ; do TEMP2 dame dolni slabiku zapisovaneho slova
                      00168 ; do TEMP3 dame horni slabiku zapisovaneho slova
0863                  00169 VS_WR_REG       ; zapise 16bitove slovo (TEMP2,TEMP3) do registru mp3 dekoderu (TEMP1)
                      00170                         ; 16bit dato se odesila od nejvyssiho bitu (15,14...8,7...1,0)
                      00171                         ; kde TEMP3 = bity 15-8 ; TEMP2 = bity 7-0
                      00172 ; pri praci pouziva TEMP1, TEMP2, TEMP3, TEMPW
0863   1C07           00173         btfss MP3_DREQ
0864   2863           00174         goto $-1
                      00175         ; v datasheetu k VS1001k o tom sice nic nepisou, v diskuzi na ikoras.iglu.cz mi bylo al porazeno
                            , 
                      00176         ; ze necekani na DREQ pri cteni/zapisu registru muze zpusobovat praskani n vystupu...
                      00177 
0865   1087           00178         bcf MP3_CS                      ; po SI posilame prikaz
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 71


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0866   3002           00179         movlw b'00000010'       ; write
0867   2000           00180         call VS_WR_BYTE 
0868   0836           00181         movfw TEMP1                     ; adresa zapisovaneho registru
0869   2000           00182         call VS_WR_BYTE
086A   0838           00183         movfw TEMP3             ; horni slabika
086B   2000           00184         call VS_WR_BYTE
086C   0837           00185         movfw TEMP2             ; dolni slabika
086D   2000           00186         call VS_WR_BYTE
                      00187 
086E   20E1           00188         call DELAY_5us          ; pozor, prepise TEMP1
086F   1487           00189         bsf MP3_CS
0870   0008           00190         return
                      00191 ;**********************************************************
                      00192 ; do TEMP1 dame adresu registru 
                      00193 ; v TEMP2 nam vrati dolni slabiku precteneho slova
                      00194 ; v TEMP3 nam vrati horni slabiku precteneho slova
0871                  00195 VS_RD_REG       ; precte 16bitove slovo (TEMP3,TEMP2) z registru mp3 dekoderu (TEMP1)
                      00196                         ; kde TEMP3 = bity 15-8 ; TEMP2 = bity 7-0
                      00197 ; pri praci pouziva TEMP1, TEMP2, TEMP3, TEMPW
0871   1C07           00198         btfss MP3_DREQ
0872   2871           00199         goto $-1
                      00200         ; v datasheetu k VS1001k o tom sice nic nepisou, v diskuzi na ikoras.iglu.cz mi bylo al porazeno
                            , 
                      00201         ; ze necekani na DREQ pri cteni/zapisu registru muze zpusobovat praskani n vystupu...
                      00202 
0873   1087           00203         bcf MP3_CS                      ; po SI posilame prikaz
0874   3003           00204         movlw b'00000011'       ; read
0875   2000           00205         call VS_WR_BYTE 
0876   0836           00206         movfw TEMP1                     ; adresa cteneho registru
0877   2000           00207         call VS_WR_BYTE
0878   2035           00208         call VS_RD_BYTE
0879   00B8           00209         movwf TEMP3             ; horni slabika
087A   2035           00210         call VS_RD_BYTE
087B   00B7           00211         movwf TEMP2             ; dolni slabika
                      00212 
087C   20E1           00213         call DELAY_5us          ; pozor, prepise TEMP1
087D   1487           00214         bsf MP3_CS
087E   0008           00215         return
                      00216 ;**********************************************************
087F                  00217 VS_SOFT_RESET   ; provede softwarovy reset dekoderu (pri zapnuti a pote po skonceni kazde mp3)
                      00218         PROG_PAGE_0
087F   118A               M                         bcf PCLATH,3
0880   120A               M                         bcf PCLATH,4
0881   21F2           00219         call DELAY_200ms
                      00220         PROG_PAGE_1
0882   158A               M                         bsf PCLATH,3
0883   120A               M                         bcf PCLATH,4
                      00221 
0884   3000           00222         movlw VSADDR_MODE
0885   00B6           00223         movwf TEMP1
0886   154D           00224         bsf VSREG_MODE_L,2      ; soft reset=1
0887   084D           00225         movfw VSREG_MODE_L
0888   00B7           00226         movwf TEMP2
0889   3000           00227         movlw .0                        ; MODE_H
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 72


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

088A   00B8           00228         movwf TEMP3
088B   2063           00229         call VS_WR_REG
                      00230 
                      00231         PROG_PAGE_0
088C   118A               M                         bcf PCLATH,3
088D   120A               M                         bcf PCLATH,4
088E   21E9           00232         call DELAY_2ms
                      00233         PROG_PAGE_1
088F   158A               M                         bsf PCLATH,3
0890   120A               M                         bcf PCLATH,4
0891   209C           00234         call VS_SEND_1024_NULL  
                      00235 
0892   114D           00236         bcf VSREG_MODE_L,2      ; soft reset=0
0893   0008           00237         return
                      00238 ;**********************************************************
0894                  00239 VS_SEND_32_NULL
0894   20AB           00240         call WAIT_FOR_VSDREQ
0895   3020           00241         movlw .32
0896   00B7           00242         movwf TEMP2
                      00243         
0897   3000           00244         movlw .0
0898   2000           00245         call VS_WR_BYTE
0899   0BB7           00246         decfsz TEMP2,F
089A   2897           00247         goto $-3
089B   0008           00248         return
                      00249 ;**********************************************************
089C                  00250 VS_SEND_1024_NULL
089C   1487           00251         bsf MP3_CS                      ; po SI posilam data
089D   3020           00252         movlw .32
089E   00B6           00253         movwf TEMP1
                      00254 
089F   2094           00255         call VS_SEND_32_NULL
08A0   0BB6           00256         decfsz TEMP1,F
08A1   289F           00257         goto $-2
                      00258          
08A2   0008           00259         return
                      00260 ;**********************************************************
08A3                  00261 VS_SET_VOLUME
08A3   300B           00262         movlw VSADDR_VOL
08A4   00B6           00263         movwf TEMP1
                      00264 
08A5   084F           00265         movfw VSREG_VOL_L
08A6   00B7           00266         movwf TEMP2
08A7   0850           00267         movfw VSREG_VOL_H
08A8   00B8           00268         movwf TEMP3
08A9   2063           00269         call VS_WR_REG
08AA   0008           00270         return          
                      00271 ;**********************************************************
08AB                  00272 WAIT_FOR_VSDREQ
08AB   1C07           00273         btfss MP3_DREQ
08AC   28AB           00274         goto WAIT_FOR_VSDREQ
08AD   0008           00275         return
                      00276 ;**********************************************************
08AE                  00277 VS_END_BEEP
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 73


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

08AE   20AB           00278         call WAIT_FOR_VSDREQ
                      00279 
08AF   3045           00280         movlw h'45'
08B0   2000           00281         call VS_WR_BYTE
08B1   3078           00282         movlw h'78'
08B2   2000           00283         call VS_WR_BYTE
08B3   3069           00284         movlw h'69'
08B4   2000           00285         call VS_WR_BYTE
08B5   3074           00286         movlw h'74'                     ; odeslanim tohoto kodu sinusovku ukoncime...
08B6   2000           00287         call VS_WR_BYTE
08B7   3000           00288         movlw .0
08B8   2000           00289         call VS_WR_BYTE
08B9   3000           00290         movlw .0
08BA   2000           00291         call VS_WR_BYTE
08BB   3000           00292         movlw .0
08BC   2000           00293         call VS_WR_BYTE
08BD   3000           00294         movlw .0
08BE   2000           00295         call VS_WR_BYTE
                      00296 
08BF   0008           00297         return
                      00298 ;**********************************************************
08C0                  00299 VS_BEEP
                      00300 ;       call VS_SOFT_RESET
                      00301 ;       call WAIT_FOR_VSDREQ
                      00302 
08C0   1487           00303         bsf MP3_CS                      ; po SI posilam data
08C1   3053           00304         movlw h'53'
08C2   2000           00305         call VS_WR_BYTE
08C3   30EF           00306         movlw h'EF'
08C4   2000           00307         call VS_WR_BYTE
08C5   306E           00308         movlw h'6E'
08C6   2000           00309         call VS_WR_BYTE
08C7   303E           00310         movlw .62                       ; ctyr bytova testovaci sekvence. Tento posledni byte znamena, 
08C8   2000           00311         call VS_WR_BYTE         ; ze s pouzitim vzorkovaci frekvence 16kHz bude generovan ton 1kHz
08C9   3000           00312         movlw .0
08CA   2000           00313         call VS_WR_BYTE
08CB   3000           00314         movlw .0
08CC   2000           00315         call VS_WR_BYTE
08CD   3000           00316         movlw .0
08CE   2000           00317         call VS_WR_BYTE
08CF   3000           00318         movlw .0                        ; testovaci kod musi byt nasledovan 4 nulamy
08D0   2000           00319         call VS_WR_BYTE
                      00320 
08D1   0008           00321         return
                      00322 ;**********************************************************
08D2                  00323 VS_INIT
08D2   01CD           00324         clrf VSREG_MODE_L
08D3   01CE           00325         clrf VSREG_STATUS_L
08D4   3040           00326         movlw h'40'
08D5   00CF           00327         movwf VSREG_VOL_L               ; VOL=0x40 => nenastavuji maximalni hlasitost, protoze kdyz jsou
                             pripojena sluchatka, tak by z toho jeden ohluchl...
08D6   00D0           00328         movwf VSREG_VOL_H
                      00329 
08D7   207F           00330         call VS_SOFT_RESET              ; resetujeme
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 74


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00331         
08D8   3003           00332         movlw .3
08D9   00BA           00333         movwf TEMP5
08DA   20A3           00334         call VS_SET_VOLUME              ; nastavime hlasitost
08DB   20C0           00335         call VS_BEEP
08DC   0BBA           00336         decfsz TEMP5,f
08DD   28DA           00337         goto $-3
                      00338         ; asi proto, ze nemam osetreny hardwarovy reset dekoderu, se mu obcas nechce nastartovat....
                      00339         ; proto jej 5x za sebou resetuji a zapinam pokusnou sinusovku...
                      00340         
08DE   20AE           00341         call VS_END_BEEP
08DF   207F           00342         call VS_SOFT_RESET              ; resetujeme
                      00343 
08E0   0008           00344         return
                      00345 ;**********************************************************
08E1                  00346 DELAY_5us
                      00347         ; pouziva TEMP1
                      00348         ; (Fosc = 20 MHz , instr. cyklus= 0.20 us) 5us / 0.20 us = 25 instrukcnich cyklu
                      00349         ; (Fosc = 16 MHz , instr. cyklus= 0.25 us) 5us / 0.25 us = 20 instrukcnich cyklu
                      00350 ;Variable: TMP0
                      00351 ;Delay 25 cycles
08E1   3008           00352         MOVLW 0x08  ;8 DEC
08E2   00B6           00353         MOVWF TEMP1
08E3   0BB6           00354         DECFSZ TEMP1,F
08E4   28E3           00355         GOTO $-1
                      00356 ;End of Delay
08E5   0008           00357         return
                      00358 ;**********************************************************
                      00080 ;#ENDIF
                      00081         include "commands.asm"  ; podprogramy na obsluhu prikazu (od ridiciho procesoru)
                      00001 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
                      00002 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
                      00003 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
                      00004 ; tady jsou procedury resici jednotlive prikazy
                      00005 ; Pokud je v zasobniku prikaz pro nejakou proceduru, musi tato procedura nastavit byt STAV_PRIKAZU do 1 
                            (i kdyz treba nema vsechny parametry)
                      00006 ; Pokud procedura najde svuj prikaz a jsou prijate vsechny parametry, musi odeslat nejakou odpoved po US
                            ARTu a smazat reg. PRIJATYCH_DAT!!!
                      00007 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
08E6                  00008 CEKEJ_PRIKAZ                                    ; ceka dokud nedostaneme nejaky prikaz
08E6   0873           00009         movfw PRIJATYCH_DAT
08E7   39FF           00010         andlw h'FF'
08E8   1903           00011         btfsc STATUS,Z                          ; koukneme se zda prisel nejaky prikaz...
08E9   28E6           00012         goto CEKEJ_PRIKAZ
08EA   0008           00013         return
                      00014 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
08EB                  00015 PRIKAZ_02h                                              ; 02h - vrat oddily se systemem FAT32
08EB   0878           00016         movfw 0x078                                     ; prvni byte zasobniku prikazu
08EC   3C02           00017         sublw h'02'                                     
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 75


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

08ED   1D03           00018         btfss STATUS,Z
08EE   0008           00019         return                                          ; nebyl prijat prikaz 02h
08EF   1475           00020         bsf STAV_PRIKAZU,0                      ; mame tu prikaz 02h, nastavime byt STAV_PRIKAZU
08F0   0873           00021         movfw PRIJATYCH_DAT
08F1   3C01           00022         sublw .1                                        ; pro prikaz 02h museji prijit 2 byty (prikaz + 
                            1 parametr)
08F2   1803           00023         btfsc STATUS,C
08F3   0008           00024         return                                          ; jeste nemame vsechny parametry
                      00025         ; Prisel prikaz 02h s jednim parametrem (vrat oddily se systemem FAT32)
                      00026 
08F4   0879           00027         movfw 0x079                                     ; parametr prikazu 02h (cislo svazku, jehoz para
                            metry chceme vratit)
08F5   3903           00028         andlw b'00000011'                       ; parametr musi byt v rozsahu 0-3
08F6   00B6           00029         movwf TEMP1
08F7   1003           00030         bcf STATUS,C
08F8   0DB6           00031         rlf TEMP1,F
08F9   0DB6           00032         rlf TEMP1,F
08FA   0DB6           00033         rlf TEMP1,F
08FB   0D36           00034         rlf TEMP1,W                                     ; parametr vynasobime 16
08FC   3E10           00035         addlw 0x10                                      ; buffer 2 je v bance 2 na adrese 0x10
08FD   0084           00036         movwf FSR
                      00037         INDF_BANK_2
08FE   1783               M                         bsf STATUS,IRP    
08FF   3010           00038         movlw .16                                       ; budeme odesilat 16 bytu
0900   00B6           00039         movwf TEMP1
0901                  00040 PRIKAZ_02h__ODESILANI_ODDILU
0901   0800           00041         movfw INDF
                      00042         PROG_PAGE_0
0902   118A               M                         bcf PCLATH,3
0903   120A               M                         bcf PCLATH,4
0904   2193           00043         call WR_USART
                      00044         PROG_PAGE_1
0905   158A               M                         bsf PCLATH,3
0906   120A               M                         bcf PCLATH,4
0907   0A84           00045         incf FSR,F
0908   0BB6           00046         decfsz TEMP1,F
0909   2901           00047         goto PRIKAZ_02h__ODESILANI_ODDILU
090A   01F3           00048         clrf PRIJATYCH_DAT
090B   0008           00049         return
                      00050 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
090C                  00051 PRIKAZ_03h                                              ; 03h – nastav oddil
090C   0878           00052         movfw 0x078                                     ; prvni byte zasobniku prikazu
090D   3C03           00053         sublw h'03'                                     
090E   1D03           00054         btfss STATUS,Z
090F   0008           00055         return                                          ; nebyl prijat prikaz 03h
0910   1475           00056         bsf STAV_PRIKAZU,0                      ; mame tu prikaz 03h, nastavime byt STAV_PRIKAZU
0911   0873           00057         movfw PRIJATYCH_DAT
0912   3C04           00058         sublw .4                                        ; pro prikaz 03h museji prijit 5 byty (prikaz + 
                            4byty parametr)
0913   1803           00059         btfsc STATUS,C
0914   0008           00060         return                                          ; jeste nemame vsechny parametry
                      00061         ; Prisel prikaz 03h s 4bytovym parametrem (nacti oddily se systemem FAT32)
                      00062 
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 76


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0915   0879           00063         movfw 0x079                                     ; parametrem prikazu 03h ma byt 4bytova adresa z
                            acatku svazku, ktery se ma nacist
0916   00A7           00064         movwf LBA1
0917   087A           00065         movfw 0x07A
0918   00A8           00066         movwf LBA2
0919   087B           00067         movfw 0x07B
091A   00A9           00068         movwf LBA3
091B   087C           00069         movfw 0x07C
091C   00AA           00070         movwf LBA4
                      00071         PROG_PAGE_0
091D   118A               M                         bcf PCLATH,3
091E   120A               M                         bcf PCLATH,4
091F   2437           00072         call NACTI_FAT32                        ; nacte parametry zvoleneho oddilu
                      00073         PROG_PAGE_1
0920   158A               M                         bsf PCLATH,3
0921   120A               M                         bcf PCLATH,4
                      00074 
0922   082E           00075         movfw ATA_ATTRIBUTES
                      00076         PROG_PAGE_0
0923   118A               M                         bcf PCLATH,3
0924   120A               M                         bcf PCLATH,4
0925   2193           00077         call WR_USART
                      00078         PROG_PAGE_1
0926   158A               M                         bsf PCLATH,3
0927   120A               M                         bcf PCLATH,4
0928   01F3           00079         clrf PRIJATYCH_DAT                      ; vyprazdnime zasobnik
0929   0008           00080         return
                      00081 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
092A                  00082 PRIKAZ_04h                                              ; 04h – vrat velikost clusteru
092A   0878           00083         movfw 0x078                                     ; prvni byte zasobniku prikazu
092B   3C04           00084         sublw h'04'                                     
092C   1D03           00085         btfss STATUS,Z
092D   0008           00086         return                                          ; nebyl prijat prikaz 04h
092E   1475           00087         bsf STAV_PRIKAZU,0                      ; mame tu prikaz 04h, nastavime byt STAV_PRIKAZU
                      00088         ; pro prikaz 04h nejsou definovany zadne parametry, proto jiz nic jineho netestujeme
                      00089 
092F   084C           00090         movfw CLUSTER_SIZE
                      00091         PROG_PAGE_0
0930   118A               M                         bcf PCLATH,3
0931   120A               M                         bcf PCLATH,4
0932   2193           00092         call WR_USART
                      00093         PROG_PAGE_1
0933   158A               M                         bsf PCLATH,3
0934   120A               M                         bcf PCLATH,4
0935   01F3           00094         clrf PRIJATYCH_DAT                      ; vyprazdnime zasobnik
0936   0008           00095         return
                      00096 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
0937                  00097 PRIKAZ_05h                                              ; 05h – zjisti, zda je cluster prvni v adresari
0937   0878           00098         movfw 0x078                                     ; prvni byte zasobniku prikazu
0938   3C05           00099         sublw h'05'
0939   1D03           00100         btfss STATUS,Z
093A   0008           00101         return                                          ; nebyl prijat prikaz 05h
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 77


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

093B   1475           00102         bsf STAV_PRIKAZU,0                      ; mame tu prikaz 05h, nastavime byt STAV_PRIKAZU
093C   0873           00103         movfw PRIJATYCH_DAT
093D   3C06           00104         sublw .6                                        ; pro prikaz 05h musi prijit 7 bytu (prikaz + 6b
                            ytu parametr)
093E   1803           00105         btfsc STATUS,C
093F   0008           00106         return                                          ; jeste nemame vsechny parametry
                      00107         ; Prisel prikaz 05h s 6bytovym parametrem 
                      00108 
0940   0879           00109         movfw 0x079                                     ; nejnizsi cast clusteru adresare
0941   00BC           00110         movwf CLUSTER1
0942   087A           00111         movfw 0x07A
0943   00BD           00112         movwf CLUSTER2
0944   087B           00113         movfw 0x07B
0945   00BE           00114         movwf CLUSTER3
0946   087C           00115         movfw 0x07C
0947   00BF           00116         movwf CLUSTER4
0948   23A7           00117         call PRVNI_CL_ADRESARE
                      00118 
0949   1C3B           00119         btfss POZICE,0
094A   2951           00120         goto PRIKAZ_05h_PAR1_OK
                      00121 
094B                  00122 PRIKAZ_05h_PAR1_NOT_OK
                      00123         INDF_BANK_2
094B   1783               M                         bsf STATUS,IRP    
094C   3010           00124         movlw 0x10                                      ; 1. byte bufferu 2
094D   0084           00125         movwf FSR
094E   3081           00126         movlw h'81'                                     ; jako prvni byte odpovedi dame 81h (Zadany clus
                            ter neobsahuje adresar)
094F   0080           00127         movwf INDF
0950   295F           00128         goto PRIKAZ_05h_KONEC
0951                  00129 PRIKAZ_05h_PAR1_OK
                      00130 
0951   087D           00131         movfw 0x07D
0952   00E0           00132         movwf ZAZNAM1
0953   087E           00133         movfw 0x07E
0954   00E1           00134         movwf ZAZNAM2
                      00135 
0955   23E1           00136         call SKOC_NA_ZAZNAM
0956   1C3B           00137         btfss POZICE,0
0957   295E           00138         goto PRIKAZ_05h_PAR2_OK
                      00139 
0958                  00140 PRIKAZ_05h_PAR2_NOT_OK
                      00141         INDF_BANK_2
0958   1783               M                         bsf STATUS,IRP    
0959   3010           00142         movlw 0x10                                      ; 1. byte bufferu 2
095A   0084           00143         movwf FSR
095B   3080           00144         movlw h'80'                                     ; jako prvni byte odpovedi dame 80h (Zadany zazn
                            am mimo rozsah)
095C   0080           00145         movwf INDF
095D   295F           00146         goto PRIKAZ_05h_KONEC
095E                  00147 PRIKAZ_05h_PAR2_OK
                      00148 
095E   2461           00149         call FILE_INFO
                      00150 
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 78


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

095F                  00151 PRIKAZ_05h_KONEC
                      00152         ; At uz bylo v zaznamu cokoli, odesleme 16 bytu z BUFFERU 2
095F   3010           00153         movlw .16
0960   00B6           00154         movwf TEMP1
                      00155         PROG_PAGE_0
0961   118A               M                         bcf PCLATH,3
0962   120A               M                         bcf PCLATH,4
0963   21C9           00156         call ODESLI_BUFFER2                     ; odesleme si zaznam o souboru  
                      00157         PROG_PAGE_1
0964   158A               M                         bsf PCLATH,3
0965   120A               M                         bcf PCLATH,4
                      00158 
0966   01F3           00159         clrf PRIJATYCH_DAT                      ; vyprazdnime zasobnik prikazu
0967   0008           00160         return
                      00161 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
0968                  00162 PRIKAZ_06h                                              ; 06h – vrat cislo dalsiho clusteru v alokacnim 
                            retezu
0968   0878           00163         movfw 0x078                                     ; prvni byte zasobniku prikazu
0969   3C06           00164         sublw h'06'                                     
096A   1D03           00165         btfss STATUS,Z
096B   0008           00166         return                                          ; nebyl prijat prikaz 06h
096C   1475           00167         bsf STAV_PRIKAZU,0                      ; mame tu prikaz 06h, nastavime byt STAV_PRIKAZU
096D   0873           00168         movfw PRIJATYCH_DAT
096E   3C04           00169         sublw .4                                        ; pro prikaz 06h museji prijit 5 bytu (prikaz + 
                            4byty parametr)
096F   1803           00170         btfsc STATUS,C
0970   0008           00171         return                                          ; jeste nemame vsechny parametry
                      00172         ; Prisel prikaz 06h s 4bytovym parametrem 
                      00173 
0971   0879           00174         movfw 0x079                                     ; nejnizsi cast clusteru
0972   00BC           00175         movwf CLUSTER1
0973   087A           00176         movfw 0x07A
0974   00BD           00177         movwf CLUSTER2
0975   087B           00178         movfw 0x07B
0976   00BE           00179         movwf CLUSTER3
0977   087C           00180         movfw 0x07C
0978   00BF           00181         movwf CLUSTER4
                      00182         PROG_PAGE_0
0979   118A               M                         bcf PCLATH,3
097A   120A               M                         bcf PCLATH,4
097B   255E           00183         call NEXT_CLUSTER
097C   083B           00184         movfw POZICE                            ; pokud POZICE = 00h, je vse v poradku (vratime c. dalsi
                            ho clusteru v retezci). 
                      00185                                                                 ; Pokud POZICE = FFh byl predany cluster
                             posledni v retezu, nebo byl prazdny...
097D   2193           00186         call WR_USART
097E   083C           00187         movfw CLUSTER1
097F   2193           00188         call WR_USART
0980   083D           00189         movfw CLUSTER2
0981   2193           00190         call WR_USART
0982   083E           00191         movfw CLUSTER3
0983   2193           00192         call WR_USART
0984   083F           00193         movfw CLUSTER4
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 79


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0985   2193           00194         call WR_USART
                      00195         PROG_PAGE_1
0986   158A               M                         bsf PCLATH,3
0987   120A               M                         bcf PCLATH,4
                      00196         
0988   01F3           00197         clrf PRIJATYCH_DAT                      ; vyprazdnime zasobnik prikazu
0989   0008           00198         return
                      00199 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
098A                  00200 PRIKAZ_07h                                              ; 07h – cti cluster
098A   0878           00201         movfw 0x078                                     ; prvni byte zasobniku prikazu
098B   3C07           00202         sublw h'07'                                     
098C   1D03           00203         btfss STATUS,Z
098D   0008           00204         return                                          ; nebyl prijat prikaz 07h
098E   1475           00205         bsf STAV_PRIKAZU,0                      ; mame tu prikaz 07h, nastavime byt STAV_PRIKAZU
098F   0873           00206         movfw PRIJATYCH_DAT
0990   3C04           00207         sublw .4                                        ; pro prikaz 07h museji prijit 5 bytu (prikaz + 
                            4byty parametr)
0991   1803           00208         btfsc STATUS,C
0992   0008           00209         return                                          ; jeste nemame vsechny parametry
                      00210         ; Prisel prikaz 07h s 4bytovym parametrem 
                      00211 
0993   0879           00212         movfw 0x079                                     ; nejnizsi cast clusteru
0994   00BC           00213         movwf CLUSTER1
0995   087A           00214         movfw 0x07A
0996   00BD           00215         movwf CLUSTER2
0997   087B           00216         movfw 0x07B
0998   00BE           00217         movwf CLUSTER3
0999   087C           00218         movfw 0x07C
099A   00BF           00219         movwf CLUSTER4
099B   01BB           00220         clrf POZICE
                      00221         PROG_PAGE_0
099C   118A               M                         bcf PCLATH,3
099D   120A               M                         bcf PCLATH,4
099E   24FB           00222         call CLUSTER_TO_LBA                     ; zjistime si skutecnou polohu pozadovaneho clusteru na 
                            disku...
099F   084C           00223         movfw CLUSTER_SIZE
09A0   00A6           00224         movwf SECTOR_C                          ; tentokrat cteme cely cluster a ne sector
09A1   22DE           00225         call READ_SECTOR;S
                      00226         PROG_PAGE_1
09A2   158A               M                         bsf PCLATH,3
09A3   120A               M                         bcf PCLATH,4
                      00227 
09A4   084C           00228         movfw CLUSTER_SIZE
09A5   00B7           00229         movwf TEMP2                                     ; kolik sektoru budeme odesilat
                      00230 
09A6                  00231 PRIKAZ_07h__ODESLI_SECTOR
09A6   3000           00232         movlw .0                                        ; budeme odesilat cely sector (256slov = 512bytu
                            )
09A7   00B6           00233         movwf TEMP1
                      00234         PROG_PAGE_0
09A8   118A               M                         bcf PCLATH,3
09A9   120A               M                         bcf PCLATH,4
09AA   21A6           00235         call ODESLI_DATA
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 80


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00236         PROG_PAGE_1
09AB   158A               M                         bsf PCLATH,3
09AC   120A               M                         bcf PCLATH,4
09AD   0BB7           00237         decfsz TEMP2,F                          ; a to tolikrat, kolik ma cluster sektroru
09AE   29A6           00238         goto PRIKAZ_07h__ODESLI_SECTOR
                      00239         
09AF   01F3           00240         clrf PRIJATYCH_DAT                      ; vyprazdnime zasobnik prikazu
09B0   0008           00241         return
                      00242 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
09B1                  00243 PRIKAZ_08h                                              ; 08h – zjisti velikost souboru
09B1   0878           00244         movfw 0x078                                     ; prvni byte zasobniku prikazu
09B2   3C08           00245         sublw h'08'
09B3   1D03           00246         btfss STATUS,Z
09B4   0008           00247         return                                          ; nebyl prijat prikaz 08h
09B5   1475           00248         bsf STAV_PRIKAZU,0                      ; mame tu prikaz 08h, nastavime byt STAV_PRIKAZU
09B6   0873           00249         movfw PRIJATYCH_DAT
09B7   3C06           00250         sublw .6                                        ; pro prikaz 08h musi prijit 7 bytu (prikaz + 6b
                            ytu parametr)
09B8   1803           00251         btfsc STATUS,C
09B9   0008           00252         return                                          ; jeste nemame vsechny parametry
                      00253         ; Prisel prikaz 08h s 6bytovym parametrem 
                      00254 
09BA   0879           00255         movfw 0x079                                     ; nejnizsi cast clusteru adresare
09BB   00BC           00256         movwf CLUSTER1
09BC   087A           00257         movfw 0x07A
09BD   00BD           00258         movwf CLUSTER2
09BE   087B           00259         movfw 0x07B
09BF   00BE           00260         movwf CLUSTER3
09C0   087C           00261         movfw 0x07C
09C1   00BF           00262         movwf CLUSTER4
09C2   23A7           00263         call PRVNI_CL_ADRESARE
                      00264 
09C3   1C3B           00265         btfss POZICE,0
09C4   29C8           00266         goto PRIKAZ_08h_PAR1_OK
                      00267 
09C5                  00268 PRIKAZ_08h_PAR1_NOT_OK
09C5   3081           00269         movlw h'81'                                     ; jako prvni byte odpovedi dame 81h (Zadany clus
                            ter neobsahuje adresar)
09C6   00B6           00270         movwf TEMP1
09C7   29D4           00271         goto PRIKAZ_08h_KONEC
09C8                  00272 PRIKAZ_08h_PAR1_OK
                      00273 
09C8   087D           00274         movfw 0x07D
09C9   00E0           00275         movwf ZAZNAM1
09CA   087E           00276         movfw 0x07E
09CB   00E1           00277         movwf ZAZNAM2
                      00278 
09CC   23E1           00279         call SKOC_NA_ZAZNAM
09CD   1C3B           00280         btfss POZICE,0
09CE   29D2           00281         goto PRIKAZ_08h_PAR2_OK
                      00282 
09CF                  00283 PRIKAZ_08h_PAR2_NOT_OK
09CF   3080           00284         movlw h'80'                                     ; jako prvni byte odpovedi dame 80h (Zadany zazn
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 81


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                            am mimo rozsah)
09D0   00B6           00285         movwf TEMP1
09D1   29D4           00286         goto PRIKAZ_08h_KONEC
09D2                  00287 PRIKAZ_08h_PAR2_OK
                      00288 
09D2   24DC           00289         call FILE_SIZE
09D3   01B6           00290         clrf TEMP1
                      00291 
09D4                  00292 PRIKAZ_08h_KONEC
                      00293         ; At uz bylo v zaznamu cokoli, odesleme 4 byty z BUFFERU 2
09D4   0836           00294         movfw TEMP1
                      00295         PROG_PAGE_0
09D5   118A               M                         bcf PCLATH,3
09D6   120A               M                         bcf PCLATH,4
09D7   2193           00296         call WR_USART
09D8   3004           00297         movlw .4
09D9   00B6           00298         movwf TEMP1
09DA   21C9           00299         call ODESLI_BUFFER2                     ; odesleme si zaznam o souboru  
                      00300         PROG_PAGE_1
09DB   158A               M                         bsf PCLATH,3
09DC   120A               M                         bcf PCLATH,4
                      00301 
09DD   01F3           00302         clrf PRIJATYCH_DAT                      ; vyprazdnime zasobnik prikazu
09DE   0008           00303         return
                      00304 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
09DF                  00305 PRIKAZ_09h                                              ; 09h – hledej zaznam
09DF   0878           00306         movfw 0x078                                     ; prvni byte zasobniku prikazu
09E0   3C09           00307         sublw h'09'
09E1   1D03           00308         btfss STATUS,Z
09E2   0008           00309         return                                          ; nebyl prijat prikaz 09h
09E3   1475           00310         bsf STAV_PRIKAZU,0                      ; mame tu prikaz 09h, nastavime byt STAV_PRIKAZU
09E4   0873           00311         movfw PRIJATYCH_DAT
09E5   3C07           00312         sublw .7                                        ; pro prikaz 09h musi prijit 8 bytu (prikaz + 7b
                            ytu parametr)
09E6   1803           00313         btfsc STATUS,C
09E7   0008           00314         return                                          ; jeste nemame vsechny parametry
                      00315         ; Prisel prikaz 09h s 5bytovym parametrem 
                      00316 
09E8   0879           00317         movfw 0x079                                     ; nejnizsi cast clusteru adresare
09E9   00BC           00318         movwf CLUSTER1
09EA   087A           00319         movfw 0x07A
09EB   00BD           00320         movwf CLUSTER2
09EC   087B           00321         movfw 0x07B
09ED   00BE           00322         movwf CLUSTER3
09EE   087C           00323         movfw 0x07C
09EF   00BF           00324         movwf CLUSTER4
09F0   23A7           00325         call PRVNI_CL_ADRESARE
                      00326 
09F1   183B           00327         btfsc POZICE,0
09F2   2A03           00328         goto PRIKAZ_09h_SPATNY_PAR
                      00329 
09F3   0879           00330         movfw 0x079                                     ; nejnizsi cast clusteru adresare
09F4   00DA           00331         movwf HL_ADR_CL1
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 82


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

09F5   087A           00332         movfw 0x07A
09F6   00DB           00333         movwf HL_ADR_CL2
09F7   087B           00334         movfw 0x07B
09F8   00DC           00335         movwf HL_ADR_CL3
09F9   087C           00336         movfw 0x07C
09FA   00DD           00337         movwf HL_ADR_CL4
                      00338 
09FB   087D           00339         movfw 0x07D
09FC   00E0           00340         movwf ZAZNAM1
09FD   087E           00341         movfw 0x07E
09FE   00E1           00342         movwf ZAZNAM2
                      00343 
09FF   087F           00344         movfw 0x07F
0A00   00D9           00345         movwf HL_PARAMETRY
                      00346 
0A01   24F9           00347         call HLEDEJ             ; mocna procedura, ktera man podle zadanych parametru vyhleda pozadovany
                             zaznam 
                      00348                                         ; a umisti jej do bufferu2 na offset 32 (od zacatku bufferu)
0A02   2A09           00349         goto PRIKAZ_09h_KONEC
0A03                  00350 PRIKAZ_09h_SPATNY_PAR
                      00351         BANK_2
0A03   1703               M                 bsf     STATUS,RP1              ; BANK2  RP1:RP0 = 10
0A04   1283               M                 bcf     STATUS,RP0    
0A05   3081           00352         movlw h'81'
0A06   00B0           00353         movwf 0x130
                      00354         BANK_0
0A07   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0A08   1283               M                 bcf     STATUS,RP0    
0A09                  00355 PRIKAZ_09h_KONEC
0A09   3012           00356         movlw .18
0A0A   00B6           00357         movwf TEMP1     
                      00358 
                      00359         PROG_PAGE_0
0A0B   118A               M                         bcf PCLATH,3
0A0C   120A               M                         bcf PCLATH,4
0A0D   21BF           00360         call ODESLI_BUFF2_HIGH
                      00361         PROG_PAGE_1
0A0E   158A               M                         bsf PCLATH,3
0A0F   120A               M                         bcf PCLATH,4
                      00362 
0A10   01F3           00363         clrf PRIJATYCH_DAT                      ; vyprazdnime zasobnik prikazu
0A11   0008           00364         return
                      00365 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
0A12                  00366 PRIKAZ_0Ah                                              ; 0Ah – precti dlouhe jmeno
0A12   0878           00367         movfw 0x078                                     ; prvni byte zasobniku prikazu
0A13   3C0A           00368         sublw h'0A'
0A14   1D03           00369         btfss STATUS,Z
0A15   0008           00370         return                                          ; nebyl prijat prikaz 0Ah
0A16   1475           00371         bsf STAV_PRIKAZU,0                      ; mame tu prikaz 0Ah, nastavime byt STAV_PRIKAZU
0A17   0873           00372         movfw PRIJATYCH_DAT
0A18   3C06           00373         sublw .6                                        ; pro prikaz 0Ah musi prijit 7 bytu (prikaz + 6b
                            ytu parametr)
0A19   1803           00374         btfsc STATUS,C
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 83


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0A1A   0008           00375         return                                          ; jeste nemame vsechny parametry
                      00376         ; Prisel prikaz 0Ah s 6bytovym parametrem 
                      00377 
0A1B   0879           00378         movfw 0x079                                     ; nejnizsi cast clusteru adresare
0A1C   00DA           00379         movwf HL_ADR_CL1
0A1D   00BC           00380         movwf CLUSTER1
0A1E   087A           00381         movfw 0x07A
0A1F   00DB           00382         movwf HL_ADR_CL2
0A20   00BD           00383         movwf CLUSTER2
0A21   087B           00384         movfw 0x07B
0A22   00DC           00385         movwf HL_ADR_CL3
0A23   00BE           00386         movwf CLUSTER3
0A24   087C           00387         movfw 0x07C
0A25   00DD           00388         movwf HL_ADR_CL4
0A26   00BF           00389         movwf CLUSTER4
0A27   23A7           00390         call PRVNI_CL_ADRESARE
                      00391 
0A28   1C3B           00392         btfss POZICE,0
0A29   2A30           00393         goto PRIKAZ_0Ah_PAR1_OK
                      00394 
0A2A                  00395 PRIKAZ_0Ah_PAR1_NOT_OK
                      00396         INDF_BANK_2
0A2A   1783               M                         bsf STATUS,IRP    
0A2B   3010           00397         movlw 0x10                                      ; 1. byte bufferu 2
0A2C   0084           00398         movwf FSR
0A2D   3081           00399         movlw h'81'                                     ; jako prvni byte odpovedi dame 81h (Zadany clus
                            ter neobsahuje adresar)
0A2E   00BB           00400         movwf POZICE
0A2F   2A35           00401         goto PRIKAZ_0Ah_KONEC
0A30                  00402 PRIKAZ_0Ah_PAR1_OK
0A30   087D           00403         movfw 0x07D
0A31   00E0           00404         movwf ZAZNAM1
0A32   087E           00405         movfw 0x07E
0A33   00E1           00406         movwf ZAZNAM2
                      00407 
0A34   26D0           00408         call LONG_NAME
0A35                  00409 PRIKAZ_0Ah_KONEC
                      00410         PROG_PAGE_0
0A35   118A               M                         bcf PCLATH,3
0A36   120A               M                         bcf PCLATH,4
0A37   083B           00411         movfw POZICE
0A38   2193           00412         call WR_USART   
                      00413         ; At uz bylo v zaznamu cokoli, odesleme 65 bytu z BUFFERU 2
0A39   3041           00414         movlw .65
0A3A   00B6           00415         movwf TEMP1
0A3B   21C9           00416         call ODESLI_BUFFER2                     ; odesleme si zaznam o souboru  
                      00417         PROG_PAGE_1
0A3C   158A               M                         bsf PCLATH,3
0A3D   120A               M                         bcf PCLATH,4
                      00418 
0A3E   01F3           00419         clrf PRIJATYCH_DAT                      ; vyprazdnime zasobnik prikazu
0A3F   0008           00420         return
                      00421 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 84


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0A40                  00422 PRIKAZ_0Bh                                              ; 0Bh – zjisti velikost fragmentu
0A40   0878           00423         movfw 0x078                                     ; prvni byte zasobniku prikazu
0A41   3C0B           00424         sublw h'0b'                                     
0A42   1D03           00425         btfss STATUS,Z
0A43   0008           00426         return                                          ; nebyl prijat prikaz 0Bh
0A44   1475           00427         bsf STAV_PRIKAZU,0                      ; mame tu prikaz 0Bh, nastavime byt STAV_PRIKAZU
0A45   0873           00428         movfw PRIJATYCH_DAT
0A46   3C04           00429         sublw .4                                        ; pro prikaz 0Bh museji prijit 5 bytu (prikaz + 
                            4byty parametr)
0A47   1803           00430         btfsc STATUS,C
0A48   0008           00431         return                                          ; jeste nemame vsechny parametry
                      00432         ; Prisel prikaz 0Bh s 4bytovym parametrem 
                      00433 
0A49   0879           00434         movfw 0x079                                     ; nejnizsi cast clusteru
0A4A   00BC           00435         movwf CLUSTER1
0A4B   087A           00436         movfw 0x07A
0A4C   00BD           00437         movwf CLUSTER2
0A4D   087B           00438         movfw 0x07B
0A4E   00BE           00439         movwf CLUSTER3
0A4F   087C           00440         movfw 0x07C
0A50   00BF           00441         movwf CLUSTER4
                      00442 
                      00443         PROG_PAGE_0
0A51   118A               M                         bcf PCLATH,3
0A52   120A               M                         bcf PCLATH,4
0A53   25E6           00444         call ZJISTI_FRAGMENT
                      00445         PROG_PAGE_1
0A54   158A               M                         bsf PCLATH,3
0A55   120A               M                         bcf PCLATH,4
                      00446 ; v CLUSTER[1-4] prijme cislo clusteru a do FRAGMENT[1-2] umisti kolik clusteru 
                      00447 ; po tomto clusteru nasledujich (vcetne) tvori jeden fragment
                      00448 
                      00449 ; Pokud soucasny cluster je prazdny (coz by se stat nemelo) vrati v POZICE FFh
                      00450 ; Jinak, pokud s vse povede, dame do POZICE 0
                      00451 
                      00452 ; ! PODPROGRAM NENI POUZITELNY PRO CLUSTER 0 (prvni cluster ROOT adresare)
                      00453 ; ! PODPROGRAM NETESTUJE ZDA NEBYLO ZADANO VETSI CISLO NEZ JE POCET CLUSTERU !!!
                      00454         
                      00455         PROG_PAGE_0
0A56   118A               M                         bcf PCLATH,3
0A57   120A               M                         bcf PCLATH,4
0A58   083B           00456         movfw POZICE 
0A59   2193           00457         call WR_USART
0A5A   0851           00458         movfw FRAGMENT1
0A5B   2193           00459         call WR_USART
0A5C   0852           00460         movfw FRAGMENT2
0A5D   2193           00461         call WR_USART
                      00462         PROG_PAGE_1
0A5E   158A               M                         bsf PCLATH,3
0A5F   120A               M                         bcf PCLATH,4
                      00463         
0A60   01F3           00464         clrf PRIJATYCH_DAT                      ; vyprazdnime zasobnik prikazu
0A61   0008           00465         return
                      00466 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 85


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                            XXXXXXXXXXXXXXXXXXXXX
0A62                  00467 PRIKAZ_0Ch                                              ; 0Ch – najdi záznam o tomto adresáøi v nadøazen
                            ém adresáøi
0A62   0878           00468         movfw 0x078                                     ; prvni byte zasobniku prikazu
0A63   3C0C           00469         sublw h'0C'                                     
0A64   1D03           00470         btfss STATUS,Z
0A65   0008           00471         return                                          ; nebyl prijat prikaz 0Ch
0A66   1475           00472         bsf STAV_PRIKAZU,0                      ; mame tu prikaz 0Ch, nastavime byt STAV_PRIKAZU
0A67   0873           00473         movfw PRIJATYCH_DAT
0A68   3C04           00474         sublw .4                                        ; pro prikaz 0Ch museji prijit 5 bytu (prikaz + 
                            4byty parametr)
0A69   1803           00475         btfsc STATUS,C
0A6A   0008           00476         return                                          ; jeste nemame vsechny parametry
                      00477         ; Prisel prikaz 0Ch s 4bytovym parametrem 
                      00478 
0A6B   0879           00479         movfw 0x079                                     ; nejnizsi cast clusteru
0A6C   00BC           00480         movwf CLUSTER1
0A6D   087A           00481         movfw 0x07A
0A6E   00BD           00482         movwf CLUSTER2
0A6F   087B           00483         movfw 0x07B
0A70   00BE           00484         movwf CLUSTER3
0A71   087C           00485         movfw 0x07C
0A72   00BF           00486         movwf CLUSTER4
                      00487 
0A73   083C           00488         movfw CLUSTER1
0A74   043D           00489         iorwf CLUSTER2,W
0A75   043E           00490         iorwf CLUSTER3,W
0A76   043F           00491         iorwf CLUSTER4,W
0A77   1903           00492         btfsc STATUS,Z
0A78   2A83           00493         goto PRIKAZ_0Ch_JEROOT          ; pokud CLUSTER[1-4]=0, tak se jedna o 1. cluster ROOT adr., pro
                            to nemusime dale resit co tam je...
                      00494 
0A79   23A7           00495         call PRVNI_CL_ADRESARE          ; V POZICE vrati 00h, pokud cluster je prvni cluster nejakeho ad
                            resare, FFh, pokud neobsahuje adresar
0A7A   083B           00496         movfw POZICE
0A7B   39FF           00497         andlw h'FF'
0A7C   1D03           00498         btfss STATUS,Z
0A7D   2A81           00499         goto PRIKAZ_0Ch_NENI_ZACATEK_ADR        
                      00500 
0A7E   275A           00501         call HLEDEJ_V_NADRAZENEM
                      00502 
0A7F   3000           00503         movlw h'00'
0A80   2A84           00504         goto PRIKAZ_0Ch_ODESLI
0A81                  00505 PRIKAZ_0Ch_NENI_ZACATEK_ADR
0A81   3081           00506         movlw h'81'
0A82   2A84           00507         goto PRIKAZ_0Ch_ODESLI
0A83                  00508 PRIKAZ_0Ch_JEROOT
0A83   3001           00509         movlw h'01'
0A84                  00510 PRIKAZ_0Ch_ODESLI
                      00511 
                      00512         PROG_PAGE_0
0A84   118A               M                         bcf PCLATH,3
0A85   120A               M                         bcf PCLATH,4
0A86   2193           00513         call WR_USART
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 86


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00514 
                      00515         INDF_BANK_3
0A87   1783               M                         bsf STATUS,IRP    
0A88   3090           00516         movlw h'90'
0A89   0084           00517         movwf FSR
                      00518 
0A8A   0800           00519         movfw INDF
0A8B   2193           00520         call WR_USART
0A8C   0A84           00521         incf FSR,f
0A8D   0800           00522         movfw INDF
0A8E   2193           00523         call WR_USART
0A8F   0A84           00524         incf FSR,f
0A90   0800           00525         movfw INDF
0A91   2193           00526         call WR_USART
0A92   0A84           00527         incf FSR,f
0A93   0800           00528         movfw INDF
0A94   2193           00529         call WR_USART
0A95   0A84           00530         incf FSR,f
                      00531 
0A96   0860           00532         movfw ZAZNAM1
0A97   2193           00533         call WR_USART
0A98   0861           00534         movfw ZAZNAM2
0A99   2193           00535         call WR_USART
                      00536         PROG_PAGE_1
0A9A   158A               M                         bsf PCLATH,3
0A9B   120A               M                         bcf PCLATH,4
                      00537         
0A9C   01F3           00538         clrf PRIJATYCH_DAT                      ; vyprazdnime zasobnik prikazu
0A9D   0008           00539         return
                      00540 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
0A9E                  00541 PRIKAZ_80h                                              ; 80h – hraj mp3 soubor
0A9E   0878           00542         movfw 0x078                                     ; prvni byte zasobniku prikazu
0A9F   3C80           00543         sublw h'80'
0AA0   1D03           00544         btfss STATUS,Z
0AA1   0008           00545         return                                          ; nebyl prijat prikaz 80h
0AA2   1475           00546         bsf STAV_PRIKAZU,0                      ; mame tu prikaz 80h, nastavime byt STAV_PRIKAZU
0AA3   0873           00547         movfw PRIJATYCH_DAT
0AA4   3C06           00548         sublw .6                                        ; pro prikaz 80h musi prijit 7 bytu (prikaz + 6b
                            ytu parametr)
0AA5   1803           00549         btfsc STATUS,C
0AA6   0008           00550         return                                          ; jeste nemame vsechny parametry
                      00551         ; Prisel prikaz 80h s 6bytovym parametrem 
                      00552 
0AA7   0879           00553         movfw 0x079                                     ; nejnizsi cast clusteru adresare
0AA8   00BC           00554         movwf CLUSTER1
0AA9   087A           00555         movfw 0x07A
0AAA   00BD           00556         movwf CLUSTER2
0AAB   087B           00557         movfw 0x07B
0AAC   00BE           00558         movwf CLUSTER3
0AAD   087C           00559         movfw 0x07C
0AAE   00BF           00560         movwf CLUSTER4
0AAF   23A7           00561         call PRVNI_CL_ADRESARE
                      00562 
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 87


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0AB0   1C3B           00563         btfss POZICE,0
0AB1   2AB8           00564         goto PRIKAZ_80h_PAR1_OK
                      00565 
0AB2                  00566 PRIKAZ_80h_PAR1_NOT_OK
                      00567         INDF_BANK_2
0AB2   1783               M                         bsf STATUS,IRP    
0AB3   3010           00568         movlw 0x10                                      ; 1. byte bufferu 2
0AB4   0084           00569         movwf FSR
0AB5   3081           00570         movlw h'81'                                     ; jako prvni byte odpovedi dame 81h (Zadany clus
                            ter neobsahuje adresar)
0AB6   0080           00571         movwf INDF
0AB7   2AFF           00572         goto PRIKAZ_80h_KONEC
0AB8                  00573 PRIKAZ_80h_PAR1_OK
                      00574 
0AB8   087D           00575         movfw 0x07D
0AB9   00E0           00576         movwf ZAZNAM1
0ABA   087E           00577         movfw 0x07E
0ABB   00E1           00578         movwf ZAZNAM2
                      00579 
0ABC   23E1           00580         call SKOC_NA_ZAZNAM
0ABD   1C3B           00581         btfss POZICE,0
0ABE   2AC5           00582         goto PRIKAZ_80h_PAR2_OK
                      00583 
0ABF                  00584 PRIKAZ_80h_PAR2_NOT_OK
                      00585         INDF_BANK_2
0ABF   1783               M                         bsf STATUS,IRP    
0AC0   3010           00586         movlw 0x10                                      ; 1. byte bufferu 2
0AC1   0084           00587         movwf FSR
0AC2   3080           00588         movlw h'80'                                     ; jako prvni byte odpovedi dame 80h (Zadany zazn
                            am mimo rozsah)
0AC3   0080           00589         movwf INDF
0AC4   2AFF           00590         goto PRIKAZ_80h_KONEC
0AC5                  00591 PRIKAZ_80h_PAR2_OK
                      00592 
0AC5   2461           00593         call FILE_INFO
                      00594 
                      00595         INDF_BANK_2
0AC6   1783               M                         bsf STATUS,IRP    
0AC7   3010           00596         movlw 0x10                                      ; 1. byte bufferu 2
0AC8   0084           00597         movwf FSR
0AC9   0800           00598         movfw INDF
0ACA   3C06           00599         sublw h'06'                                     ; pokud na zadanem miste se nachazi soubor s pri
                            ponou mp3...
0ACB   1D03           00600         btfss STATUS,Z
0ACC   2AFF           00601         goto PRIKAZ_80h_KONEC
                      00602                         
                      00603         ; ...nastavime jej jako prehravany soubor.
0ACD   301C           00604         movlw 0x1C                                      ; 13. byte bufferu 2
0ACE   0084           00605         movwf FSR
0ACF   0800           00606         movfw INDF
0AD0   00E9           00607         movwf PREH_DATA_CL1
0AD1   00BC           00608         movwf CLUSTER1
0AD2   0A84           00609         incf FSR,f
0AD3   0800           00610         movfw INDF
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 88


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0AD4   00EA           00611         movwf PREH_DATA_CL2
0AD5   00BD           00612         movwf CLUSTER2
0AD6   0A84           00613         incf FSR,f
0AD7   0800           00614         movfw INDF
0AD8   00EB           00615         movwf PREH_DATA_CL3
0AD9   00BE           00616         movwf CLUSTER3
0ADA   0A84           00617         incf FSR,f
0ADB   0800           00618         movfw INDF
0ADC   00EC           00619         movwf PREH_DATA_CL4
0ADD   00BF           00620         movwf CLUSTER4
                      00621 
                      00622         PROG_PAGE_0
0ADE   118A               M                         bcf PCLATH,3
0ADF   120A               M                         bcf PCLATH,4
0AE0   25E6           00623         call ZJISTI_FRAGMENT
                      00624         PROG_PAGE_1
0AE1   158A               M                         bsf PCLATH,3
0AE2   120A               M                         bcf PCLATH,4
                      00625 ; v CLUSTER[1-4] prijme cislo clusteru a do FRAGMENT[1-2] umisti kolik clusteru 
                      00626 ; po tomto clusteru nasledujich (vcetne) tvori jeden fragment
                      00627 
                      00628 ; Pokud soucasny cluster je prazdny (coz by se stat nemelo) vrati v POZICE FFh
                      00629 ; Jinak, pokud s vse povede, dame do POZICE 0
                      00630 
                      00631 ; ! PODPROGRAM NENI POUZITELNY PRO CLUSTER 0 (prvni cluster ROOT adresare)
                      00632 ; ! PODPROGRAM NETESTUJE ZDA NEBYLO ZADANO VETSI CISLO NEZ JE POCET CLUSTERU !!!
0AE3   0851           00633         movfw FRAGMENT1
0AE4   00D3           00634         movwf PREH_D_FRAGMENT1
0AE5   0852           00635         movfw FRAGMENT2
0AE6   00D4           00636         movwf PREH_D_FRAGMENT2
                      00637         
0AE7   087D           00638         movfw 0x07D
0AE8   00E6           00639         movwf PREH_ZAZNAM1
0AE9   087E           00640         movfw 0x07E
0AEA   00E7           00641         movwf PREH_ZAZNAM2
                      00642 
0AEB   0879           00643         movfw 0x079                                     ; nejnizsi cast clusteru adresare
0AEC   00E2           00644         movwf PREH_ADR_CL1
0AED   087A           00645         movfw 0x07A
0AEE   00E3           00646         movwf PREH_ADR_CL2
0AEF   087B           00647         movfw 0x07B
0AF0   00E4           00648         movwf PREH_ADR_CL3
0AF1   087C           00649         movfw 0x07C
0AF2   00E5           00650         movwf PREH_ADR_CL4
                      00651         ; aktualni prehravany soubor i prehravana slozka byly nastaveny...
                      00652 
0AF3   01ED           00653         clrf PREH_DATA_POZICE
0AF4   146E           00654         bsf PREH_STAV0,0
0AF5   14EE           00655         bsf PREH_STAV0,1                        ; nastavime si vlastosti prehravani: (PREH_STAV[0-1])
                      00656 
0AF6   10CD           00657         bcf VSREG_MODE_L,1                      ; prehravame normalni rychlosti 
0AF7   106F           00658         bcf PREH_STAV1,0                        ; prehravame normalni rychlosti 
                      00659         
0AF8   207F           00660         call VS_SOFT_RESET
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 89


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00661 
0AF9   3000           00662         movlw VSADDR_MODE
0AFA   00B6           00663         movwf TEMP1
0AFB   084D           00664         movfw VSREG_MODE_L
0AFC   00B7           00665         movwf TEMP2
0AFD   01B8           00666         clrf TEMP3
0AFE   2063           00667         call VS_WR_REG
                      00668 
0AFF                  00669 PRIKAZ_80h_KONEC
                      00670         ; At uz bylo v zaznamu cokoli, odesleme 1 byt z BUFFERU 2
                      00671         INDF_BANK_2
0AFF   1783               M                         bsf STATUS,IRP    
0B00   3010           00672         movlw 0x10                                      ; 1. byte bufferu 2
0B01   0084           00673         movwf FSR
0B02   0800           00674         movfw INDF
                      00675         PROG_PAGE_0
0B03   118A               M                         bcf PCLATH,3
0B04   120A               M                         bcf PCLATH,4
0B05   2193           00676         call WR_USART   
                      00677         PROG_PAGE_1
0B06   158A               M                         bsf PCLATH,3
0B07   120A               M                         bcf PCLATH,4
                      00678         
0B08   01F3           00679         clrf PRIJATYCH_DAT                      ; vyprazdnime zasobnik prikazu
0B09   0008           00680         return
                      00681 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
0B0A                  00682 PRIKAZ_81h                                              ; 81h – vrat stav prehravaneho souboru
0B0A   0878           00683         movfw 0x078                                     ; prvni byte zasobniku prikazu
0B0B   3C81           00684         sublw h'81'
0B0C   1D03           00685         btfss STATUS,Z
0B0D   0008           00686         return                                          ; nebyl prijat prikaz 81h
0B0E   1475           00687         bsf STAV_PRIKAZU,0                      ; mame tu prikaz 81h, nastavime byt STAV_PRIKAZU
                      00688         ; pro prikaz 81h nejsou definovany zadne parametry, proto jiz nic jineho netestujeme
                      00689 
0B0F   086E           00690         movfw PREH_STAV0
                      00691         PROG_PAGE_0
0B10   118A               M                         bcf PCLATH,3
0B11   120A               M                         bcf PCLATH,4
0B12   2193           00692         call WR_USART
                      00693         PROG_PAGE_1
0B13   158A               M                         bsf PCLATH,3
0B14   120A               M                         bcf PCLATH,4
                      00694 
0B15   086F           00695         movfw PREH_STAV1
                      00696         PROG_PAGE_0
0B16   118A               M                         bcf PCLATH,3
0B17   120A               M                         bcf PCLATH,4
0B18   2193           00697         call WR_USART
                      00698         PROG_PAGE_1
0B19   158A               M                         bsf PCLATH,3
0B1A   120A               M                         bcf PCLATH,4
                      00699 
0B1B   116E           00700         bcf PREH_STAV0,2                        ; 2. bit je nastaven, kdyz se zmeni prehravany soubor (b
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 90


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                            ez volani prikazu) do doby, nez prijde prikaz na dotaz STAVU... (81h)
                      00701 
0B1C   3004           00702         movlw VSADDR_DECODE_TIME
0B1D   00B6           00703         movwf TEMP1
0B1E   2071           00704         call VS_RD_REG                          ; zjistime si aktualni pozici v souboru v sekundach
0B1F   0837           00705         movfw TEMP2
                      00706         PROG_PAGE_0
0B20   118A               M                         bcf PCLATH,3
0B21   120A               M                         bcf PCLATH,4
0B22   2193           00707         call WR_USART
0B23   0838           00708         movfw TEMP3
0B24   2193           00709         call WR_USART
                      00710         PROG_PAGE_1
0B25   158A               M                         bsf PCLATH,3
0B26   120A               M                         bcf PCLATH,4
                      00711 
                      00712 ;       movlw VSADDR_STATUS
                      00713 ;       movwf TEMP1
                      00714 ;       call VS_RD_REG
                      00715 ;       movfw TEMP2
                      00716 ;       PROG_PAGE_0
                      00717 ;       call WR_USART
                      00718 ;       PROG_PAGE_1
                      00719 
0B27   01F3           00720         clrf PRIJATYCH_DAT                      ; vyprazdnime zasobnik
0B28   0008           00721         return
                      00722 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
0B29                  00723 PRIKAZ_82h                                              ; 82h – nastav hlasitost
0B29   0878           00724         movfw 0x078                                     ; prvni byte zasobniku prikazu
0B2A   3C82           00725         sublw h'82'
0B2B   1D03           00726         btfss STATUS,Z
0B2C   0008           00727         return                                          ; nebyl prijat prikaz 82h
0B2D   1475           00728         bsf STAV_PRIKAZU,0                      ; mame tu prikaz 82h, nastavime byt STAV_PRIKAZU
0B2E   0873           00729         movfw PRIJATYCH_DAT
0B2F   3C02           00730         sublw .2                                        ; pro prikaz 82h museji prijit 3 byty (prikaz + 
                            2byty parametr)
0B30   1803           00731         btfsc STATUS,C
0B31   0008           00732         return                                          ; jeste nemame vsechny parametry
                      00733         ; Prisel prikaz 82h s 2bytovym parametrem 
                      00734 
0B32   0879           00735         movfw 0x079                                     ; hlasitost pro levy kanal
0B33   00D0           00736         movwf VSREG_VOL_H
0B34   087A           00737         movfw 0x07A                                     ; hlasitost pro pravy kanal
0B35   00CF           00738         movwf VSREG_VOL_L
0B36   20A3           00739         call VS_SET_VOLUME                      ; nastavime hlasitost   
                      00740 
0B37   30FF           00741         movlw h'FF'
                      00742         PROG_PAGE_0
0B38   118A               M                         bcf PCLATH,3
0B39   120A               M                         bcf PCLATH,4
0B3A   2193           00743         call WR_USART
                      00744         PROG_PAGE_1
0B3B   158A               M                         bsf PCLATH,3
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 91


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0B3C   120A               M                         bcf PCLATH,4
0B3D   01F3           00745         clrf PRIJATYCH_DAT                      ; vyprazdnime zasobnik
0B3E   0008           00746         return
                      00747 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
0B3F                  00748 PRIKAZ_83h                                              ; 83h – vrat informace o prehravanem souboru
0B3F   0878           00749         movfw 0x078                                     ; prvni byte zasobniku prikazu
0B40   3C83           00750         sublw h'83'
0B41   1D03           00751         btfss STATUS,Z
0B42   0008           00752         return                                          ; nebyl prijat prikaz 83h
0B43   1475           00753         bsf STAV_PRIKAZU,0                      ; mame tu prikaz 83h, nastavime byt STAV_PRIKAZU
                      00754         ; pro prikaz 83h nejsou definovane zadne parametry, proto jiz nic jineho netestujeme
                      00755 
0B44   3005           00756         movlw VSADDR_AUDATA
0B45   00B6           00757         movwf TEMP1
0B46   2071           00758         call VS_RD_REG
0B47   0837           00759         movfw TEMP2
                      00760         PROG_PAGE_0
0B48   118A               M                         bcf PCLATH,3
0B49   120A               M                         bcf PCLATH,4
0B4A   2193           00761         call WR_USART
0B4B   0838           00762         movfw TEMP3
0B4C   2193           00763         call WR_USART   
                      00764         PROG_PAGE_1
0B4D   158A               M                         bsf PCLATH,3
0B4E   120A               M                         bcf PCLATH,4
                      00765         ; odeslali jsme AUDATA
                      00766 
0B4F   3008           00767         movlw VSADDR_HDAT0
0B50   00B6           00768         movwf TEMP1
0B51   2071           00769         call VS_RD_REG
0B52   0837           00770         movfw TEMP2
                      00771         PROG_PAGE_0
0B53   118A               M                         bcf PCLATH,3
0B54   120A               M                         bcf PCLATH,4
0B55   2193           00772         call WR_USART
0B56   0838           00773         movfw TEMP3
0B57   2193           00774         call WR_USART   
                      00775         PROG_PAGE_1
0B58   158A               M                         bsf PCLATH,3
0B59   120A               M                         bcf PCLATH,4
                      00776         ; odeslali jsme HDAT0
                      00777 
0B5A   3009           00778         movlw VSADDR_HDAT1
0B5B   00B6           00779         movwf TEMP1
0B5C   2071           00780         call VS_RD_REG
0B5D   0837           00781         movfw TEMP2
                      00782         PROG_PAGE_0
0B5E   118A               M                         bcf PCLATH,3
0B5F   120A               M                         bcf PCLATH,4
0B60   2193           00783         call WR_USART
0B61   0838           00784         movfw TEMP3
0B62   2193           00785         call WR_USART   
                      00786         ; odeslali jsme HDAT1
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 92


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00787 
0B63   0862           00788         movfw PREH_ADR_CL1
0B64   2193           00789         call WR_USART
0B65   0863           00790         movfw PREH_ADR_CL2
0B66   2193           00791         call WR_USART
0B67   0864           00792         movfw PREH_ADR_CL3
0B68   2193           00793         call WR_USART
0B69   0865           00794         movfw PREH_ADR_CL4
0B6A   2193           00795         call WR_USART
                      00796 
0B6B   0866           00797         movfw PREH_ZAZNAM1
0B6C   2193           00798         call WR_USART
0B6D   0867           00799         movfw PREH_ZAZNAM2
0B6E   2193           00800         call WR_USART
                      00801         PROG_PAGE_1
0B6F   158A               M                         bsf PCLATH,3
0B70   120A               M                         bcf PCLATH,4
                      00802 
0B71   01F3           00803         clrf PRIJATYCH_DAT                      ; vyprazdnime zasobnik
0B72   0008           00804         return
                      00805 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
0B73                  00806 PRIKAZ_84h                                              ; 84h – nastav stav prehravani
0B73   0878           00807         movfw 0x078                                     ; prvni byte zasobniku prikazu
0B74   3C84           00808         sublw h'84'
0B75   1D03           00809         btfss STATUS,Z
0B76   0008           00810         return                                          ; nebyl prijat prikaz 84h
0B77   1475           00811         bsf STAV_PRIKAZU,0                      ; mame tu prikaz 84h, nastavime byt STAV_PRIKAZU
0B78   0873           00812         movfw PRIJATYCH_DAT
0B79   3C02           00813         sublw .2                                        ; pro prikaz 8h museji prijit 3 byty (prikaz + 2
                            byty parametr)
0B7A   1803           00814         btfsc STATUS,C
0B7B   0008           00815         return                                          ; jeste nemame vsechny parametry
                      00816         ; Prisel prikaz 84h s 2bytovym parametrem 
                      00817 
0B7C   086E           00818         movfw PREH_STAV0
0B7D   3906           00819         andlw b'00000110'
0B7E   00EE           00820         movwf PREH_STAV0
0B7F   0879           00821         movfw 0x079                                     ; parametr 1
0B80   39F9           00822         andlw b'11111001'                       ; nektere bity vymaskujeme (vsechny nelze ovladat prikaz
                            em)
0B81   046E           00823         iorwf PREH_STAV0,w      
0B82   00EE           00824         movwf PREH_STAV0
                      00825 
0B83   087A           00826         movfw 0x07A                                     ; parametr 2
0B84   00EF           00827         movwf PREH_STAV1
                      00828 
0B85   10CD           00829         bcf VSREG_MODE_L,1                      ; prehravame normalni rychlosti (zda se mp3 prevyji je r
                            eseno v hlavni smycce podle stavu registru PREH_STAV1)
0B86   13CD           00830         bcf VSREG_MODE_L,7                      ;bass/treble enhancer
0B87   19EF           00831         btfsc PREH_STAV1,3                      ; 3. bit =      1 => zvyrazneni basu a vysek (moznost de
                            koderu vs1001 "bass/treble enhancer")
0B88   17CD           00832         bsf VSREG_MODE_L,7                      ;bass/treble enhancer
                      00833         
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 93


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0B89   3000           00834         movlw VSADDR_MODE
0B8A   00B6           00835         movwf TEMP1
0B8B   084D           00836         movfw VSREG_MODE_L
0B8C   00B7           00837         movwf TEMP2
0B8D   01B8           00838         clrf TEMP3
0B8E   2063           00839         call VS_WR_REG
                      00840         
0B8F   3001           00841         movlw VSADDR_STATUS
0B90   2071           00842         call VS_RD_REG
0B91   0837           00843         movfw TEMP2
0B92   00CE           00844         movwf VSREG_STATUS_L
                      00845 
0B93   114E           00846         bcf VSREG_STATUS_L,2            ; Bit 2 is analog powerdown bit.
0B94   1A6F           00847         btfsc PREH_STAV1,4                      ; 4. bit = 1 => MUTE
0B95   154E           00848         bsf VSREG_STATUS_L,2            ; Bit 2 is analog powerdown bit.
                      00849         
0B96   3001           00850         movlw VSADDR_STATUS
0B97   00B6           00851         movwf TEMP1
0B98   084E           00852         movfw VSREG_STATUS_L
0B99   00B7           00853         movwf TEMP2
0B9A   01B8           00854         clrf TEMP3
0B9B   2063           00855         call VS_WR_REG
                      00856 
0B9C   1E6F           00857         btfss PREH_STAV1,4                      ; 4. bit = 1 => MUTE
0B9D   20A3           00858         call VS_SET_VOLUME                      ; nastavime hlasitost
                      00859                                                                 ; nevim sice proc, ale kdyz prepisu VS r
                            eg. STATUS, zmeni se hlasitost
                      00860 
                      00861         PROG_PAGE_0
0B9E   118A               M                         bcf PCLATH,3
0B9F   120A               M                         bcf PCLATH,4
0BA0   30FF           00862         movlw h'FF'
0BA1   2193           00863         call WR_USART
                      00864         PROG_PAGE_1
0BA2   158A               M                         bsf PCLATH,3
0BA3   120A               M                         bcf PCLATH,4
0BA4   01E8           00865         clrf PREH_CITAC_PREV
0BA5   01F3           00866         clrf PRIJATYCH_DAT                      ; vyprazdnime zasobnik
0BA6   0008           00867         return
                      00868 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
                      00082         include "filesystem.asm"; podprogramy pro praci s adresari a setrideni obsahu adresaru
                      00001 ;**********************************************************
                      00002 ;**********************************************************
                      00003 ;**********************************************************
                      00004 ; podprogramy pro praci s adresari a setrideni obsahu adresaru
                      00005 ;**********************************************************
                      00006 ;**********************************************************
                      00007 ;**********************************************************
                      00008 
                      00009 ;**************************************************************************
0BA7                  00010 PRVNI_CL_ADRESARE
                      00011         ; V CLUSTER[1-4] prijme cislo clusteru. Zkontroluje, zda zadany sluster obsahuje zacatek adresar
                            e
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 94


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00012         ; V POZICE vrati 00h, pokud cluster je prvni cluster nejakeho adresare, FFh, pokud neobsahuje ad
                            resar
0BA7   01BB           00013         clrf POZICE
                      00014 
0BA8   083C           00015         movfw CLUSTER1
0BA9   043D           00016         iorwf CLUSTER2,W
0BAA   043E           00017         iorwf CLUSTER3,W
0BAB   043F           00018         iorwf CLUSTER4,W
0BAC   1903           00019         btfsc STATUS,Z
0BAD   0008           00020         return                          ; pokud CLUSTER[1-4]=0, tak se jedna o 1. cluster ROOT adr., pro
                            to nemusime dale resit co tam je...
                      00021         
                      00022         PROG_PAGE_0
0BAE   118A               M                         bcf PCLATH,3
0BAF   120A               M                         bcf PCLATH,4
0BB0   24FB           00023         call CLUSTER_TO_LBA
0BB1   3001           00024         movlw .1
0BB2   00A6           00025         movwf SECTOR_C
0BB3   22DE           00026         call READ_SECTOR        ; precteme udajny prvni sektor z prvniho clusteru adresare      
                      00027         PROG_PAGE_1
0BB4   158A               M                         bsf PCLATH,3
0BB5   120A               M                         bcf PCLATH,4
                      00028 
                      00029         ; Tady vychazime z toho, ze kazdy adresar krome ROOTu ma jako prvni zaznam ukazatel na sebe (jak
                            o jmeno je jedna tecka)
                      00030         ; Mohlo by se sice stat, ze bychom narazili na soubor, ktery zacina retezcem ".          " to by
                            ch ale neresil...
0BB6   30FF           00031         movlw h'FF'
0BB7   00BB           00032         movwf POZICE
                      00033 
                      00034         PROG_PAGE_0
0BB8   118A               M                         bcf PCLATH,3
0BB9   120A               M                         bcf PCLATH,4
0BBA   2286           00035         call READ_DATA
                      00036         PROG_PAGE_1
0BBB   158A               M                         bsf PCLATH,3
0BBC   120A               M                         bcf PCLATH,4
0BBD   0820           00037         movfw DATA_L
0BBE   3C2E           00038         sublw '.'               ; 1. znak
0BBF   1D03           00039         btfss STATUS,Z
0BC0   2BE0           00040         goto PRVNI_CL_ADRESARE_KONEC
0BC1   0821           00041         movfw DATA_H
0BC2   3C20           00042         sublw h'20'             ; 2. znak
0BC3   1D03           00043         btfss STATUS,Z
0BC4   2BE0           00044         goto PRVNI_CL_ADRESARE_KONEC
                      00045 
0BC5   3004           00046         movlw .4                ; dalsich 8 znaku maji byt mezery
0BC6   00B6           00047         movwf TEMP1
                      00048         
0BC7                  00049 PRVNI_CL_ADRESARE_MEZERY
                      00050         PROG_PAGE_0
0BC7   118A               M                         bcf PCLATH,3
0BC8   120A               M                         bcf PCLATH,4
0BC9   2286           00051         call READ_DATA
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 95


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00052         PROG_PAGE_1
0BCA   158A               M                         bsf PCLATH,3
0BCB   120A               M                         bcf PCLATH,4
0BCC   0820           00053         movfw DATA_L
0BCD   3C20           00054         sublw h'20'
0BCE   1D03           00055         btfss STATUS,Z
0BCF   2BE0           00056         goto PRVNI_CL_ADRESARE_KONEC
0BD0   0821           00057         movfw DATA_H
0BD1   3C20           00058         sublw h'20'
0BD2   1D03           00059         btfss STATUS,Z
0BD3   2BE0           00060         goto PRVNI_CL_ADRESARE_KONEC
0BD4   0BB6           00061         decfsz TEMP1,f
0BD5   2BC7           00062         goto PRVNI_CL_ADRESARE_MEZERY
                      00063 
                      00064         PROG_PAGE_0
0BD6   118A               M                         bcf PCLATH,3
0BD7   120A               M                         bcf PCLATH,4
0BD8   2286           00065         call READ_DATA
                      00066         PROG_PAGE_1
0BD9   158A               M                         bsf PCLATH,3
0BDA   120A               M                         bcf PCLATH,4
0BDB   0820           00067         movfw DATA_L
0BDC   3C20           00068         sublw h'20'
0BDD   1D03           00069         btfss STATUS,Z
0BDE   2BE0           00070         goto PRVNI_CL_ADRESARE_KONEC
                      00071 
0BDF   01BB           00072         clrf POZICE     
0BE0                  00073 PRVNI_CL_ADRESARE_KONEC
0BE0   0008           00074         return
                      00075 ;**************************************************************************
0BE1                  00076 SKOC_NA_ZAZNAM
                      00077         ; !!!! pozor, tato procedura potrebuje min. 5 mist ve STACKu (vcetne sama sebe)
                      00078 
                      00079         ; V CLUSTER[1-4] prijme cislo clusteru na kterem se nachazi zacatek adresare
                      00080         ; V ZAZNAM[1-2] prijme cislo zaznamu 
                      00081         ; - pokud ZAZNAM[1-2] ukazuji mimo adresar, vrati v POZICE FFh (jinak 00h)
                      00082         ; - pokud byl zaznam nalezen,
                      00083         ;       da disku prikaz k jeho precteni a skoci az k zaznamu...
                      00084         ;       ...v bufferu disku budeme mit teda 32bytu dat ktere prezentuji jeden zaznam ve slozce
0BE1   0860           00085         movfw ZAZNAM1
                      00086         BANK_1
0BE2   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0BE3   1683               M                 bsf     STATUS,RP0    
0BE4   00A0           00087         movwf OPERAND_X1
                      00088         BANK_0
0BE5   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0BE6   1283               M                 bcf     STATUS,RP0    
0BE7   0861           00089         movfw ZAZNAM2
                      00090         BANK_1
0BE8   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0BE9   1683               M                 bsf     STATUS,RP0    
0BEA   00A1           00091         movwf OPERAND_X2
0BEB   01A2           00092         clrf OPERAND_X3
0BEC   01A3           00093         clrf OPERAND_X4
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 96


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00094         BANK_0                                  ; OPERAND_X := ZAZNAM
0BED   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0BEE   1283               M                 bcf     STATUS,RP0    
                      00095         
                      00096         PROG_PAGE_0
0BEF   118A               M                         bcf PCLATH,3
0BF0   120A               M                         bcf PCLATH,4
0BF1   277B           00097         call POSUNDOPRAVA_4             ; OPERAND_X := OPERAND_X div 16
                      00098         ; tady mame v PRETECENI kolikaty zaznam v sektoru chceme
                      00099         BANK_1
0BF2   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0BF3   1683               M                 bsf     STATUS,RP0    
0BF4   082C           00100         movfw PRETECENI
                      00101         BANK_0
0BF5   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0BF6   1283               M                 bcf     STATUS,RP0    
0BF7   00BA           00102         movwf TEMP5
                      00103         BANK_1
0BF8   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0BF9   1683               M                 bsf     STATUS,RP0    
0BFA   01AC           00104         clrf PRETECENI                          ; pokud CLUSTER_SIZE = 1 tak preteceni := 0 a X zustane 
                            stejne
                      00105         BANK_0
0BFB   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0BFC   1283               M                 bcf     STATUS,RP0    
                      00106 
0BFD   18CC           00107         btfsc CLUSTER_SIZE,1            ; 2
0BFE   275D           00108         call POSUNDOPRAVA_1                     ; X := X div 2
0BFF   194C           00109         btfsc CLUSTER_SIZE,2            ; 4
0C00   2766           00110         call POSUNDOPRAVA_2                     ; X := X div 4
0C01   19CC           00111         btfsc CLUSTER_SIZE,3            ; 8
0C02   2770           00112         call POSUNDOPRAVA_3                     ; X := X div 8
0C03   1A4C           00113         btfsc CLUSTER_SIZE,4            ; 16
0C04   277B           00114         call POSUNDOPRAVA_4                     ; X := X div 4
0C05   1ACC           00115         btfsc CLUSTER_SIZE,5            ; 32
0C06   2787           00116         call POSUNDOPRAVA_5                     ; X := X div 32
0C07   1B4C           00117         btfsc CLUSTER_SIZE,6            ; 64
0C08   2794           00118         call POSUNDOPRAVA_6                     ; X := X div 64
0C09   1BCC           00119         btfsc CLUSTER_SIZE,7            ; 128
0C0A   27A2           00120         call POSUNDOPRAVA_7                     ; X := X div 128
                      00121         ; tady mame v PRETECENI na kolikatem sektoru v clusteru je hledany zaznam
                      00122         BANK_1
0C0B   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0C0C   1683               M                 bsf     STATUS,RP0    
0C0D   082C           00123         movfw PRETECENI
                      00124         BANK_0
0C0E   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0C0F   1283               M                 bcf     STATUS,RP0    
0C10   00B9           00125         movwf TEMP4
                      00126 
                      00127         ; OPERAND_X := (ZAZNAM div 16) div CLUSTER_SIZE
                      00128         ; ted v OPERAND_X mame hodnotu kolik clusteru mame od zacatku adresare preskocit...
0C11                  00129 SKOC_NA_ZAZNAM_PRESKOC_CL
                      00130         PROG_PAGE_0
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 97


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0C11   118A               M                         bcf PCLATH,3
0C12   120A               M                         bcf PCLATH,4
0C13   27B1           00131         call NULA
                      00132         PROG_PAGE_1
0C14   158A               M                         bsf PCLATH,3
0C15   120A               M                         bcf PCLATH,4
                      00133         BANK_1
0C16   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0C17   1683               M                 bsf     STATUS,RP0    
0C18   1C2C           00134         btfss PRETECENI,0
0C19   2C3F           00135         goto SKOC_NA_ZAZNAM_MAME_CL     
                      00136         BANK_0
0C1A   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0C1B   1283               M                 bcf     STATUS,RP0    
                      00137 
                      00138         INDF_BANK_1
0C1C   1383               M                         bcf STATUS,IRP    
0C1D   30A0           00139         movlw 0xA0
0C1E   0084           00140         movwf FSR
0C1F   0800           00141         movfw INDF
0C20   00B7           00142         movwf TEMP2
0C21   0A84           00143         incf FSR,F
0C22   0800           00144         movfw INDF
0C23   00B8           00145         movwf TEMP3
                      00146 
                      00147         PROG_PAGE_0
0C24   118A               M                         bcf PCLATH,3
0C25   120A               M                         bcf PCLATH,4
0C26   255E           00148         call NEXT_CLUSTER
                      00149         PROG_PAGE_1
0C27   158A               M                         bsf PCLATH,3
0C28   120A               M                         bcf PCLATH,4
0C29   183B           00150         btfsc POZICE,0          ; pokud s vse povedlo, mame v POZICE 0
0C2A   2C5E           00151         goto SKOC_NA_ZAZNAM_MIMO_ROZSAH
                      00152 
                      00153         INDF_BANK_1
0C2B   1383               M                         bcf STATUS,IRP    
0C2C   30A0           00154         movlw 0xA0
0C2D   0084           00155         movwf FSR
0C2E   0837           00156         movfw TEMP2
0C2F   0080           00157         movwf INDF
0C30   0A84           00158         incf FSR,F
0C31   0838           00159         movfw TEMP3
0C32   0080           00160         movwf INDF
                      00161         BANK_1
0C33   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0C34   1683               M                 bsf     STATUS,RP0    
0C35   01A2           00162         clrf OPERAND_X3
0C36   01A3           00163         clrf OPERAND_X4
                      00164         BANK_0  
0C37   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0C38   1283               M                 bcf     STATUS,RP0    
                      00165 
                      00166         PROG_PAGE_0
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 98


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0C39   118A               M                         bcf PCLATH,3
0C3A   120A               M                         bcf PCLATH,4
0C3B   26F4           00167         call DEKREMENTUJ        ; X := X - 1
                      00168         PROG_PAGE_1
0C3C   158A               M                         bsf PCLATH,3
0C3D   120A               M                         bcf PCLATH,4
                      00169 
0C3E   2C11           00170         goto SKOC_NA_ZAZNAM_PRESKOC_CL
                      00171 
0C3F                  00172 SKOC_NA_ZAZNAM_MAME_CL
                      00173         BANK_0
0C3F   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0C40   1283               M                 bcf     STATUS,RP0    
                      00174 
0C41   0839           00175         movfw TEMP4                                     ; v kolikatem sektoru v clusteru je hledany zazn
                            am
0C42   00BB           00176         movwf POZICE 
                      00177         PROG_PAGE_0
0C43   118A               M                         bcf PCLATH,3
0C44   120A               M                         bcf PCLATH,4
0C45   24FB           00178         call CLUSTER_TO_LBA                     ; zjistime si skutecnou polohu zaznamu na disku
0C46   3001           00179         movlw .1
0C47   00A6           00180         movwf SECTOR_C
0C48   22DE           00181         call READ_SECTOR                        ; dame prikaz precist sektor
                      00182         PROG_PAGE_1
0C49   158A               M                         bsf PCLATH,3
0C4A   120A               M                         bcf PCLATH,4
                      00183 
0C4B   3010           00184         movlw .16
0C4C   00DE           00185         movwf ZAZNAMU_vBUFFERU_DISKU
0C4D   083A           00186         movfw TEMP5
0C4E   02DE           00187         subwf ZAZNAMU_vBUFFERU_DISKU,f          ; ZAZNAMU_vBUFFERU_DISKU := 16 - TEMP5
                      00188 
0C4F   083A           00189         movfw TEMP5                                     ; kolikaty zaznam v casti adersare (sektoru) mam
                            e precist [0..15]
0C50   390F           00190         andlw b'00001111'
0C51   00B6           00191         movwf TEMP1                                     ; rozsah by mel byt spravne, pro jistotu jej ale
                             orizneme [0..15]
0C52   39FF           00192         andlw h'FF'
0C53   1903           00193         btfsc STATUS,Z                          ; pokud chceme prvni zaznam ze sektoru...
0C54   2C5B           00194         goto SKOC_NA_ZAZNAM_MAME_ZAZNAM         ; ...koncime
                      00195 
0C55   0EB6           00196         swapf TEMP1,F                           ; protoze kazdy zaznam o souboru ma 32B=16slov, tak musi
                            me TEMP1 vynasobit 16...
                      00197         PROG_PAGE_0
0C56   118A               M                         bcf PCLATH,3
0C57   120A               M                         bcf PCLATH,4
0C58   22A1           00198         call PRESKOC                            ; a tolik slov preskocit (tolik slov je pro nas nepotreb
                            nych)
                      00199         PROG_PAGE_1
0C59   158A               M                         bsf PCLATH,3
0C5A   120A               M                         bcf PCLATH,4
                      00200 
0C5B                  00201 SKOC_NA_ZAZNAM_MAME_ZAZNAM
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 99


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0C5B   3000           00202         movlw h'00'
0C5C   00BB           00203         movwf POZICE 
0C5D   2C60           00204         goto SKOC_NA_ZAZNAM_KONEC
0C5E                  00205 SKOC_NA_ZAZNAM_MIMO_ROZSAH
0C5E   30FF           00206         movlw h'FF'
0C5F   00BB           00207         movwf POZICE 
0C60                  00208 SKOC_NA_ZAZNAM_KONEC
0C60   0008           00209         return
                      00210 ;**************************************************************************
0C61                  00211 FILE_INFO
                      00212         ; z disku nam ted ma prijit 32bytu dat, ktere reprezentuji jeden zaznam ve slozce
                      00213         ; tato procedura zaznam precte, analyzuje, a do bufferu 2 da nasledujici informace:
                      00214         ;               1.     byte ->  = 00h -> zaznam je prazdny; 
                      00215         ;                                               = 01h -> zaznam je adresar; 
                      00216         ;                                               = 02h -> zaznam je soubor; 
                      00217         ;                                               = 06h -> zaznam je soubor s priponou MP3
                      00218         ;               2..9   byte -> 8 znaku dlouhe jmeno ("DOSovsky" tvar - napr. slouzka "dokumenty"
                             = "DOKUME~1" )
                      00219         ;               10..12 byte -> u souboru tri znaky pripony (u adresaru vetsinou mezery - 20h 20h
                             20h)
                      00220         ;               13..16 byte -> 1. cluster souboru
                      00221         ; Pokud se jedna o adresar, a zaznam o pripone se nerovna 0x202020 (tri mezery), tak skutecne jm
                            eno adresare je : ADRESAR.PRI
                      00222         INDF_BANK_2
0C61   1783               M                         bsf STATUS,IRP    
0C62   3010           00223         movlw 0x10                                      ; 1. byte bufferu 2
0C63   0084           00224         movwf FSR
0C64   3000           00225         movlw .0                                        ; zatim nevime co zaznam obsahuje, tak ho oznaci
                            me jako prazdny
0C65   0080           00226         movwf INDF
0C66   0A84           00227         incf FSR,F      
                      00228 
0C67   3005           00229         movlw .5                                        ; 5 slov = 10 bytu -> 8 znaku jmena souboru/sloz
                            ky + 2 znaky pripony
0C68   00B6           00230         movwf TEMP1
0C69                  00231 FILE_INFO__READ_NAME
                      00232         PROG_PAGE_0
0C69   118A               M                         bcf PCLATH,3
0C6A   120A               M                         bcf PCLATH,4
0C6B   2286           00233         call READ_DATA                          ; 2 znaky jmena souboru/slozky, nebo pripony souboru
                      00234         PROG_PAGE_1
0C6C   158A               M                         bsf PCLATH,3
0C6D   120A               M                         bcf PCLATH,4
0C6E   0820           00235         movfw DATA_L
0C6F   0080           00236         movwf INDF
0C70   0A84           00237         incf FSR,F
0C71   0821           00238         movfw DATA_H
0C72   0080           00239         movwf INDF
0C73   0A84           00240         incf FSR,F
0C74   03B6           00241         decf TEMP1,F
0C75   1D03           00242         btfss STATUS,Z
0C76   2C69           00243         goto FILE_INFO__READ_NAME       
                      00244 
                      00245         PROG_PAGE_0
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 100


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0C77   118A               M                         bcf PCLATH,3
0C78   120A               M                         bcf PCLATH,4
0C79   2286           00246         call READ_DATA                          ; posledni znak pripony a byt s atributy souboru
                      00247         PROG_PAGE_1
0C7A   158A               M                         bsf PCLATH,3
0C7B   120A               M                         bcf PCLATH,4
0C7C   0820           00248         movfw DATA_L
0C7D   0080           00249         movwf INDF
                      00250 
0C7E   3011           00251         movlw 0x11                                      ; 2. byte bufferu 2 -> 1. znak jmena souboru
0C7F   0084           00252         movwf FSR
0C80   0800           00253         movfw INDF                                      ; ted ve W mame 1. znak jmena souboru/slozky
0C81   39FF           00254         andlw h'FF'
0C82   1903           00255         btfsc STATUS,Z
0C83   2CD4           00256         goto FILE_INFO__CTI20_KONEC             ; pokud 1. znak jmena souboru = 00h, je zaznam prazdny
0C84   3CE5           00257         sublw h'E5'
0C85   1903           00258         btfsc STATUS,Z
0C86   2CD4           00259         goto FILE_INFO__CTI20_KONEC             ; pokud 1. znak jmena souboru = E5h, je zaznam prazdny
                      00260         
                      00261         ; pokud jsme tady, tak zaznam obsahuje soubor, adresar, dlouhe jmeno souboru, nebo jmenovku disk
                            u 
                      00262         ; (jsou dva zpusoby jak zapsat jmenovku svazku, bud do spousteciho zaznamu, nebo jako polozku RO
                            OT adresare)
0C87   0821           00263         movfw DATA_H                            ; byt s atributy souboru
0C88   390F           00264         andlw h'0F'
0C89   3C0F           00265         sublw h'0F'                                     ; if (atributy and 0Fh) = 0Fh -> zaznam s dlouhy
                            m nazvem souboru
0C8A   1903           00266         btfsc STATUS,Z
0C8B   2CD4           00267         goto FILE_INFO__CTI20_KONEC             ; pokud zaznam je dlouhy nazav souboru, koncime
0C8C   19A1           00268         btfsc DATA_H,3
0C8D   2CD4           00269         goto FILE_INFO__CTI20_KONEC             ; if (atributy and 08h) = 08h -> jmenovka disku
0C8E   1A21           00270         btfsc DATA_H,4                          ; if (atributy and 10h) = 10h -> adresar
0C8F   2CA5           00271         goto FILE_INFO__DIR
                      00272 
0C90   3002           00273         movlw h'02'                                     ; zaznam je soubor
0C91   00B6           00274         movwf TEMP1
                      00275         ; tady vime, ze zaznam je soubor, tak se podivame, zda to neni mp3
0C92   3019           00276         movlw 0x19                                      ; 10. byt bufferu 2 -> 1. znak pripony souboru
0C93   0084           00277         movwf FSR
                      00278 
0C94   0800           00279         movfw INDF
0C95   3C4D           00280         sublw 'M'                                       ; (jmena souboru v "DOSovskem" tvaru maji vzdy v
                            elka pismena)
0C96   1D03           00281         btfss STATUS,Z
0C97   2CA7           00282         goto FILE_INFO__FILE
0C98   0A84           00283         incf FSR,F
0C99   0800           00284         movfw INDF
0C9A   3C50           00285         sublw 'P'
0C9B   1D03           00286         btfss STATUS,Z
0C9C   2CA7           00287         goto FILE_INFO__FILE
0C9D   0A84           00288         incf FSR,F
0C9E   0800           00289         movfw INDF
0C9F   3C33           00290         sublw '3'
0CA0   1D03           00291         btfss STATUS,Z
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 101


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0CA1   2CA7           00292         goto FILE_INFO__FILE
                      00293 
0CA2   3006           00294         movlw h'06'                                     ; ted je jasne, ze soubor je mp3
0CA3   00B6           00295         movwf TEMP1
0CA4   2CA7           00296         goto FILE_INFO__FILE
                      00297 
0CA5                  00298 FILE_INFO__DIR
0CA5   3001           00299         movlw h'01'                                     ; zaznam je adresar
0CA6   00B6           00300         movwf TEMP1
                      00301 
0CA7                  00302 FILE_INFO__FILE
                      00303         ; tady mame v TEMP 1 jednu z nasledujicich hodnot:
                      00304         ; 01h -> zaznam je adresar; 02h -> zaznam je soubor; 06h -> zaznam je soubor s priponou MP3
0CA7   3010           00305         movlw 0x10                                      ; 1. byt bufferu 2 -> identifikace zaznamu
0CA8   0084           00306         movwf FSR
0CA9   0836           00307         movfw TEMP1
0CAA   0080           00308         movwf INDF
                      00309 
0CAB   3004           00310         movlw .4
0CAC   00B6           00311         movwf TEMP1
                      00312         PROG_PAGE_0
0CAD   118A               M                         bcf PCLATH,3
0CAE   120A               M                         bcf PCLATH,4
0CAF   22A1           00313         call PRESKOC                            ; nasledujicich 8 bytu ze zaznamu je pro nas k nicemu (o
                            bsahuji cas posledni upravy, otevreni a buh vi co jeste...)
                      00314         PROG_PAGE_1
0CB0   158A               M                         bsf PCLATH,3
0CB1   120A               M                         bcf PCLATH,4
                      00315 
0CB2   301E           00316         movlw 0x1E                                      ; 15. byt bufferu 2 -> 2. byt prvniho clusteru
0CB3   0084           00317         movwf FSR
                      00318         PROG_PAGE_0
0CB4   118A               M                         bcf PCLATH,3
0CB5   120A               M                         bcf PCLATH,4
0CB6   2286           00319         call READ_DATA                          ; jedno slovo -> horni cast cisla prvniho clusteru
                      00320         PROG_PAGE_1
0CB7   158A               M                         bsf PCLATH,3
0CB8   120A               M                         bcf PCLATH,4
0CB9   0820           00321         movfw DATA_L
0CBA   0080           00322         movwf INDF
0CBB   0A84           00323         incf FSR,F
0CBC   0821           00324         movfw DATA_H
0CBD   0080           00325         movwf INDF
                      00326 
                      00327         PROG_PAGE_0
0CBE   118A               M                         bcf PCLATH,3
0CBF   120A               M                         bcf PCLATH,4
0CC0   2286           00328         call READ_DATA                          ; cas vytvoreni   (1 word)
0CC1   2286           00329         call READ_DATA                          ; datum vytvoreni (1 word)
                      00330 
0CC2   301C           00331         movlw 0x1C                                      ; 13. byt bufferu 2 -> 0. byt prvniho clusteru
0CC3   0084           00332         movwf FSR
0CC4   2286           00333         call READ_DATA                          ; jedno slovo -> dolni cast cisla prvniho clusteru
                      00334         PROG_PAGE_1
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 102


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0CC5   158A               M                         bsf PCLATH,3
0CC6   120A               M                         bcf PCLATH,4
0CC7   0820           00335         movfw DATA_L
0CC8   0080           00336         movwf INDF
0CC9   0A84           00337         incf FSR,F
0CCA   0821           00338         movfw DATA_H
0CCB   0080           00339         movwf INDF
                      00340         
                      00341         ; Pak jsou v zaznamu jeste 4 byty, ktere obsahuji velikost souboru. Ty mi sice nepotrebujeme,
                      00342         ; musime je ale precist, aby jsme precetli vsech 32 bytu zaznamu
0CCC   3002           00343         movlw .2
0CCD   00B6           00344         movwf TEMP1
                      00345         PROG_PAGE_0
0CCE   118A               M                         bcf PCLATH,3
0CCF   120A               M                         bcf PCLATH,4
0CD0   22A1           00346         call PRESKOC
                      00347         PROG_PAGE_1
0CD1   158A               M                         bsf PCLATH,3
0CD2   120A               M                         bcf PCLATH,4
0CD3   0008           00348         return
0CD4                  00349 FILE_INFO__CTI20_KONEC
0CD4   300A           00350         movlw .10
0CD5   00B6           00351         movwf TEMP1
                      00352         PROG_PAGE_0
0CD6   118A               M                         bcf PCLATH,3
0CD7   120A               M                         bcf PCLATH,4
0CD8   22A1           00353         call PRESKOC
                      00354         PROG_PAGE_1
0CD9   158A               M                         bsf PCLATH,3
0CDA   120A               M                         bcf PCLATH,4
0CDB   0008           00355         return
                      00356 ;**************************************************************************
0CDC                  00357 FILE_SIZE
                      00358         ; z disku nam ted ma prijit 32bytu dat, ktere reprezentuji jeden zaznam ve slozce
                      00359         ; Zaznam by mel byt soubor, podprogram toto nekontroluje (zda zaznam neni adresar)
                      00360         ; Na zacatek bufferu 1 da 4 byty obsahujici velikost zaznamu
0CDC   300E           00361         movlw .14                                       ; my ted potrebujeme jen posledni 4 byty ze zazn
                            amu, tam se nachazi velikost souboru
0CDD   00B6           00362         movwf TEMP1
                      00363         PROG_PAGE_0
0CDE   118A               M                         bcf PCLATH,3
0CDF   120A               M                         bcf PCLATH,4
0CE0   22A1           00364         call PRESKOC
                      00365         PROG_PAGE_1
0CE1   158A               M                         bsf PCLATH,3
0CE2   120A               M                         bcf PCLATH,4
                      00366 
                      00367         INDF_BANK_2
0CE3   1783               M                         bsf STATUS,IRP    
0CE4   3010           00368         movlw 0x10                                      ; 1. byte bufferu 1
0CE5   0084           00369         movwf FSR
                      00370 
                      00371         PROG_PAGE_0
0CE6   118A               M                         bcf PCLATH,3
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 103


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0CE7   120A               M                         bcf PCLATH,4
0CE8   2286           00372         call READ_DATA
0CE9   0820           00373         movfw DATA_L
0CEA   0080           00374         movwf INDF
0CEB   0A84           00375         incf FSR,F
0CEC   0821           00376         movfw DATA_H
0CED   0080           00377         movwf INDF
0CEE   0A84           00378         incf FSR,F
                      00379 
0CEF   2286           00380         call READ_DATA
                      00381         PROG_PAGE_1
0CF0   158A               M                         bsf PCLATH,3
0CF1   120A               M                         bcf PCLATH,4
0CF2   0820           00382         movfw DATA_L
0CF3   0080           00383         movwf INDF
0CF4   0A84           00384         incf FSR,F
0CF5   0821           00385         movfw DATA_H
0CF6   0080           00386         movwf INDF
0CF7   0A84           00387         incf FSR,F
                      00388 
0CF8   0008           00389         return
                      00390 ;**************************************************************************
0CF9                  00391 HLEDEJ
                      00392 ; !!!! pozor, tato procedura potrebuje min. 6 mist ve STACKu (vcetne sama sebe)
                      00393 
                      00394 ; mocna procedura, ktera nam podle zadanych parametru vyhleda pozadovany zaznam 
                      00395 ; a umisti jej do bufferu2 na offset 32 (do horni poloviny bufferu)
                      00396 
                      00397 ; ZAZNAM V DRUHE POLOVINE BUFFERU2 MA NASLEDUJICI STRUKTURU:
                      00398 ;       1. byte:        = 00h -> zadny vyhovujici zaznam nebyl nalezen
                      00399 ;                               = 01h -> zaznam je adresar
                      00400 ;                               = 02h -> zaznam je soubor; 
                      00401 ;                               = 06h -> zaznam je soubor s priponou MP3
                      00402 ;       2..9   byte -> 8 znaku dlouhe jmeno ("DOSovsky" tvar - napr. slouzka "dokumenty" = "DOKUME~1" )
                      00403 ;       10..12 byte -> u souboru tri znaky pripony (u adresaru vetsinou mezery - 20h 20h 20h)
                      00404 ;       13..16 byte -> 1. cluster souboru
                      00405 ;       17..18 byte -> cislo zaznamu v adresari
                      00406 
                      00407 ;       HL_PARAMETRY    -- parametry hledani
                      00408 ;       HL_ADR_CL[1-4]  -- prnvi cluster prohledavaneho adresare
                      00409 ;       ZAZNAM[1-2]             -- zaznam od ktereho hledame
                      00410 
                      00411 ; Filozofie je takova, ze v bufferu 1 mame ulozen zaznam vuci kteremu vyhledavame (ZAZ_REF),
                      00412 ; v dolni polovine bufferu 2 mame ulozen zaznam, ktery jsme prave precetli (ZAZ_A)
                      00413 ; a v hodni polovine bufferu 2 zaznam, ktery zatim byl nejblize k pozadovanemu zaznamu (ZAZ_N).
                      00414 
                      00415 ; Hruby vyvojak by pak mohl vypadat takto:
                      00416 ;******************************************************************************************************
                      00417 ; if ((HL_PARAMETRY = [prvni]):
                      00418 ;       if (CLUSTER = ROOT):
                      00419 ;               HL_PARAMETRY := [dalsi]
                      00420 ;               ZAZ_REF := 0x0000000.....
                      00421 ;               goto hledej_hledani
                      00422 ;       else:
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 104


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00423 ;               ZAZ_N naplnit daty ze zaznamu 1 // prvni polozkou vsech adresaru krome ROOTu jsou ".."
                      00424 ;               goto hledej_konec
                      00425 ;       endif;
                      00426 ; endif;
                      00427 
                      00428 ; if ((CLUSTER != ROOT) and (ZAZNAM<2)):
                      00429 ;               if (HL_PARAMETRY = [dalsi]):
                      00430 ;                       ZAZ_REF := 0x0000000.....
                      00431 ;                       goto hledej_hledani
                      00432 ;               else:
                      00433 ;                       goto hledej_konec
                      00434 ;               endif;
                      00435 ; endif;
                      00436 ;
                      00437 ; ZAZ_REF naplnit daty ze zaznamu ZAZNAM
                      00438 ; ZAZNAM := 0
                      00439 ; if (CLUSTER != ROOT):
                      00440 ;               ZAZNAM :=2
                      00441 ; end;
                      00442 ;
                      00443 ; repeat
                      00444 ;       nacti_zaznam
                      00445 ;       IF     (hledame dalsi zaznam)     AND (ZAZ_A > ZAZ_REF) AND ((ZAZ_A < ZAZ_N) OR (ZAZ_N is empty)
                            ):
                      00446 ;                       ZAZ_N := ZAZ_A
                      00447 ;       ELSEIF (hledame predchozi zaznam) AND (ZAZ_A < ZAZ_REF) AND (ZAZ_A > ZAZ_N):
                      00448 ;                       ZAZ_N := ZAZ_A
                      00449 ;       ENDIF
                      00450 ;       zaznam++
                      00451 ; until (byl zaznam posledni)
                      00452 ;
                      00453 ; if (HL_PARAMETRY = [predchozi]) and (ZAZ_N = 00000) and (!ROOT):
                      00454 ;       ZAZ_N naplnit daty ze zaznamu 1
                      00455 ; endif;
                      00456 ; KONEC
                      00457 ;******************************************************************************************************
                      00458         PROG_PAGE_0
0CF9   118A               M                         bcf PCLATH,3
0CFA   120A               M                         bcf PCLATH,4
0CFB   22B7           00459         call CLEAR_BUFFER2              ; vymazeme si buffer2, abychom tam nemeli bordel
                      00460         PROG_PAGE_1
0CFC   158A               M                         bsf PCLATH,3
0CFD   120A               M                         bcf PCLATH,4
0CFE   265D           00461         call CLEAR_BUFFER1              ; vymazeme si buffer1, abychom tam nemeli bordel
                      00462 
0CFF   085A           00463         movfw HL_ADR_CL1
0D00   00BC           00464         movwf CLUSTER1
0D01   085B           00465         movfw HL_ADR_CL2
0D02   00BD           00466         movwf CLUSTER2
0D03   085C           00467         movfw HL_ADR_CL3
0D04   00BE           00468         movwf CLUSTER3
0D05   085D           00469         movfw HL_ADR_CL4
0D06   00BF           00470         movwf CLUSTER4
                      00471 
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 105


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00472         ; protoze to budeme v nasledujicim kodu potrebova, nastavime si 7. bit HL_PARAMETRY podle toho, 
                      00473         ; zda predany adresar je ROOT ci nikoliv
0D07   13D9           00474         bcf HL_PARAMETRY,7
0D08   30FF           00475         movlw h'FF'     
0D09   05BC           00476         andwf CLUSTER1,F
0D0A   1D03           00477         btfss STATUS,Z
0D0B   17D9           00478                 bsf HL_PARAMETRY,7
0D0C   05BD           00479         andwf CLUSTER2,F
0D0D   1D03           00480         btfss STATUS,Z
0D0E   17D9           00481                 bsf HL_PARAMETRY,7
0D0F   05BE           00482         andwf CLUSTER3,F
0D10   1D03           00483         btfss STATUS,Z
0D11   17D9           00484                 bsf HL_PARAMETRY,7
0D12   05BF           00485         andwf CLUSTER4,F
0D13   1D03           00486         btfss STATUS,Z
0D14   17D9           00487                 bsf HL_PARAMETRY,7
                      00488 
                      00489 
0D15   1DD9           00490         btfss HL_PARAMETRY,3                    ; if ((HL_PARAMETRY = [prvni]):
0D16   2D23           00491         goto HLEDEJ_NEHLEDAME_PRVNI
0D17   1BD9           00492         btfsc HL_PARAMETRY,7                    ;               IF (CLUSTER = ROOT):
0D18   2D1B           00493         goto HLEDEJ_ELSE1
0D19   1259           00494         bcf HL_PARAMETRY,4
0D1A   2D39           00495         goto HLEDEJ_HLEDANI
0D1B                  00496 HLEDEJ_ELSE1                                            ;               ELSE:
0D1B   3001           00497         movlw .1
0D1C   00E0           00498         movwf ZAZNAM1
0D1D   01E1           00499         clrf ZAZNAM2
0D1E   23E1           00500         call SKOC_NA_ZAZNAM     
0D1F   2461           00501         call FILE_INFO
0D20   258B           00502         call ZAPIS_C_ZAZNAMU
0D21   26A7           00503         call BUF2_LOW_TO_HIGH
0D22   2D8A           00504         goto HLEDEJ_KONEC                               ;               ENDIF;
0D23                  00505 HLEDEJ_NEHLEDAME_PRVNI                          ; ENDIF 
                      00506 
0D23   1FD9           00507         btfss HL_PARAMETRY,7
0D24   2D33           00508         goto HLEDEJ_IF2_ENDIF
0D25   0861           00509         movfw ZAZNAM2 
0D26   39FF           00510         andlw h'FF'
0D27   1D03           00511         btfss STATUS,Z
0D28   2D33           00512         goto HLEDEJ_IF2_ENDIF
0D29   0860           00513         movfw ZAZNAM1
0D2A   39FF           00514         andlw h'FF'
0D2B   1903           00515         btfsc STATUS,Z
0D2C   2D30           00516         goto IF2
0D2D   3C01           00517         sublw .1
0D2E   1D03           00518         btfss STATUS,Z
0D2F   2D33           00519         goto HLEDEJ_IF2_ENDIF                   ; if ((CLUSTER != ROOT) and (ZAZNAM < 2)):
0D30                  00520 IF2
0D30   1A59           00521         btfsc HL_PARAMETRY,4                    ;               if (HL_PARAMETRY = [predchozi]):
0D31   2D8A           00522         goto HLEDEJ_KONEC                               ;               ... else:
0D32   2D39           00523         goto HLEDEJ_HLEDANI                             ;               ... endif;
0D33                  00524 HLEDEJ_IF2_ENDIF                                        ; endif
                      00525 
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 106


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0D33   23E1           00526         call SKOC_NA_ZAZNAM             ; - pokud ZAZNAM[1-2] ukazuji mimo adresar, vrati v POZICE FFh (
                            jinak 00h)
0D34   183B           00527         btfsc POZICE,0
0D35   2D8A           00528         goto HLEDEJ_KONEC       
0D36   2461           00529         call FILE_INFO
0D37   258B           00530         call ZAPIS_C_ZAZNAMU    
0D38   2669           00531         call BUF2_TO_BUF1
                      00532 
0D39                  00533 HLEDEJ_HLEDANI  
0D39   01E0           00534         clrf ZAZNAM1
0D3A   01E1           00535         clrf ZAZNAM2
0D3B   1BD9           00536         btfsc HL_PARAMETRY,7
0D3C   14E0           00537         bsf ZAZNAM1,1                   ; if (!ROOT): ZAZNAM = 2; endif;
0D3D   01DE           00538         clrf ZAZNAMU_vBUFFERU_DISKU
0D3E                  00539 HLEDEJ_REPEAT
0D3E   085A           00540         movfw HL_ADR_CL1
0D3F   00BC           00541         movwf CLUSTER1
0D40   085B           00542         movfw HL_ADR_CL2
0D41   00BD           00543         movwf CLUSTER2
0D42   085C           00544         movfw HL_ADR_CL3
0D43   00BE           00545         movwf CLUSTER3
0D44   085D           00546         movfw HL_ADR_CL4
0D45   00BF           00547         movwf CLUSTER4
                      00548 
                      00549 
0D46   01BB           00550         clrf POZICE
0D47   085E           00551         movfw ZAZNAMU_vBUFFERU_DISKU
0D48   39FF           00552         andlw h'FF'
0D49   1903           00553         btfsc STATUS,Z                  ; pokud jeste nejake po sobe jdouci zaznamy jsou pripraveny v bu
                            fferu disku, tak nemusime volat SKOC_NA_ZAZNAM
0D4A   23E1           00554         call SKOC_NA_ZAZNAM             ; - pokud ZAZNAM[1-2] ukazuji mimo adresar, vrati v POZICE FFh (
                            jinak 00h)
0D4B   183B           00555         btfsc POZICE,0
0D4C   2D6F           00556         goto HLEDEJ_END_REPEAT
                      00557 
0D4D   03DE           00558         decf ZAZNAMU_vBUFFERU_DISKU,f   ; ted jeden zaznam precteme, proto jich bude v bufferu disku o j
                            eden min
0D4E   2461           00559         call FILE_INFO
0D4F   258B           00560         call ZAPIS_C_ZAZNAMU
                      00561 
0D50   0AE0           00562         incf ZAZNAM1,f
0D51   1903           00563         btfsc STATUS,Z
0D52   0AE1           00564         incf ZAZNAM2,f
                      00565 
0D53   2598           00566         call VYHOVUJE_ZAZNAM
0D54   1C36           00567         btfss TEMP1,0
0D55   2D3E           00568         goto HLEDEJ_REPEAT
                      00569         
                      00570 ;       movlw .16
                      00571 ;       movwf TEMP1
                      00572 ;       PROG_PAGE_0
                      00573 ;       call ODESLI_BUFFER2                     ; odesleme si zaznam o souboru  
                      00574 ;       call DELAY_500ms    
                      00575 ;       PROG_PAGE_1
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 107


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00576 
                      00577 ;       IF     (hledame dalsi zaznam)
                      00578 ;               IF (ZAZ_A > ZAZ_REF) AND ((ZAZ_A < ZAZ_N) OR (ZAZ_N is empty)):
                      00579 ;                       ZAZ_N := ZAZ_A
                      00580 ;               ENDIF
                      00581 ;       ELSEIF (hledame predchozi zaznam)
                      00582 ;               IF (ZAZ_A < ZAZ_REF) AND (ZAZ_A > ZAZ_N):
                      00583 ;                       ZAZ_N := ZAZ_A
                      00584 ;               ENDIF
                      00585 ;       ENDIF
0D56   25CD           00586         call COMPARE_BUFF1_BUFF2
                      00587         ; porovna nazvy souboru na zacatku bufferu1 s bufferem2
                      00588         ; pokud v abecede je driv nazev v bufferu1 da to TEMP1 0x01
                      00589         ; pokud v abecede je driv nazev v bufferu2 da to TEMP1 0x02
                      00590         ; pokud se nazvy shoduji da do TEMP1 0x00
0D57   1A59           00591         btfsc HL_PARAMETRY,4            ;       IF     (hledame dalsi zaznam)
0D58   2D68           00592         goto HLEDEJ_ELSE3
0D59   1C36           00593         btfss TEMP1,0                           ;               IF (ZAZ_A > ZAZ_REF)
0D5A   2D6E           00594         goto HLEDEJ_ENDIF3
                      00595 
                      00596         BANK_2
0D5B   1703               M                 bsf     STATUS,RP1              ; BANK2  RP1:RP0 = 10
0D5C   1283               M                 bcf     STATUS,RP0    
0D5D   0830           00597         movfw 0x30
                      00598         BANK_0
0D5E   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0D5F   1283               M                 bcf     STATUS,RP0    
0D60   39FF           00599         andlw h'FF'
0D61   1903           00600         btfsc STATUS,Z
0D62   2D66           00601         goto HLEDEJ_IF4
                      00602 
0D63   25BA           00603         call COMPARE_BUFF2_L_H
                      00604         ; porovna nazvy souboru na zacatku bufferu2 a na konci bufferu2
                      00605         ; pokud v abecede je driv nazev v horni polovine buff2 da to TEMP1 0x01
                      00606         ; pokud v abecede je driv nazev v dolni polovine buff2 da to TEMP1 0x02
                      00607         ; pokud se nazvy shoduji da do TEMP1 0x00
0D64   1CB6           00608         btfss TEMP1,1
0D65   2D6E           00609         goto HLEDEJ_ENDIF3
0D66                  00610 HLEDEJ_IF4                                              ;               AND ((ZAZ_A < ZAZ_N) OR (ZAZ_N i
                            s empty)):
0D66   26A7           00611         call BUF2_LOW_TO_HIGH           ;                               ZAZ_N := ZAZ_A
0D67   2D6E           00612         goto HLEDEJ_ENDIF3                      ;               ENDIF
0D68                  00613 HLEDEJ_ELSE3                                    ;       ELSEIF (hledame predchozi zaznam)
0D68   1CB6           00614         btfss TEMP1,1                           ;               IF (ZAZ_A < ZAZ_REF)
0D69   2D6E           00615         goto HLEDEJ_ENDIF3
0D6A   25BA           00616         call COMPARE_BUFF2_L_H
0D6B   1C36           00617         btfss TEMP1,0                           ;               AND (ZAZ_A > ZAZ_N):
0D6C   2D6E           00618         goto HLEDEJ_ENDIF3
0D6D   26A7           00619         call BUF2_LOW_TO_HIGH           ;                               ZAZ_N := ZAZ_A
0D6E                  00620 HLEDEJ_ENDIF3                                   ;       ENDIF
                      00621         
0D6E   2D3E           00622         goto HLEDEJ_REPEAT
0D6F                  00623 HLEDEJ_END_REPEAT
                      00624 
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 108


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00625 ; if (HL_PARAMETRY = [predchozi]) and (ZAZ_N = 00000) and (!ROOT):
                      00626 ;       ZAZ_N naplnit daty ze zaznamu 1
                      00627 ; endif;
0D6F   1E59           00628         btfss HL_PARAMETRY,4            ; if (HL_PARAMETRY = [predchozi])
0D70   2D8A           00629         goto HLEDEJ_KONEC
0D71   1FD9           00630         btfss HL_PARAMETRY,7            ;       and (!ROOT)
0D72   2D8A           00631         goto HLEDEJ_KONEC
                      00632         BANK_2
0D73   1703               M                 bsf     STATUS,RP1              ; BANK2  RP1:RP0 = 10
0D74   1283               M                 bcf     STATUS,RP0    
0D75   0830           00633         movfw 0x30
                      00634         BANK_0
0D76   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0D77   1283               M                 bcf     STATUS,RP0    
0D78   39FF           00635         andlw h'FF'
0D79   1D03           00636         btfss STATUS,Z                          ;       and (ZAZ_N is empty):
0D7A   2D8A           00637         goto HLEDEJ_KONEC
                      00638 
0D7B   085A           00639         movfw HL_ADR_CL1
0D7C   00BC           00640         movwf CLUSTER1
0D7D   085B           00641         movfw HL_ADR_CL2
0D7E   00BD           00642         movwf CLUSTER2
0D7F   085C           00643         movfw HL_ADR_CL3
0D80   00BE           00644         movwf CLUSTER3
0D81   085D           00645         movfw HL_ADR_CL4
0D82   00BF           00646         movwf CLUSTER4
0D83   3001           00647         movlw .1
0D84   00E0           00648         movwf ZAZNAM1
0D85   01E1           00649         clrf ZAZNAM2
0D86   23E1           00650         call SKOC_NA_ZAZNAM     
0D87   2461           00651         call FILE_INFO
0D88   258B           00652         call ZAPIS_C_ZAZNAMU
0D89   26A7           00653         call BUF2_LOW_TO_HIGH
                      00654 
0D8A                  00655 HLEDEJ_KONEC                                    ; endif;
0D8A   0008           00656         return
                      00657 ;**************************************************************************
0D8B                  00658 ZAPIS_C_ZAZNAMU
                      00659         ; podprogram FILE_INFO nam dava vsechny mozny informace o souboru, krome cisla zaznamu, 
                      00660         ; proto si toto cislo musime zapsat sami do bufferu2
0D8B   0860           00661         movfw ZAZNAM1
                      00662         BANK_2
0D8C   1703               M                 bsf     STATUS,RP1              ; BANK2  RP1:RP0 = 10
0D8D   1283               M                 bcf     STATUS,RP0    
0D8E   00A0           00663         movwf 0x120
                      00664         BANK_0
0D8F   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0D90   1283               M                 bcf     STATUS,RP0    
0D91   0861           00665         movfw ZAZNAM2
                      00666         BANK_2
0D92   1703               M                 bsf     STATUS,RP1              ; BANK2  RP1:RP0 = 10
0D93   1283               M                 bcf     STATUS,RP0    
0D94   00A1           00667         movwf 0x121
                      00668         BANK_0
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 109


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0D95   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0D96   1283               M                 bcf     STATUS,RP0    
0D97   0008           00669         return
                      00670 ;**************************************************************************
0D98                  00671 VYHOVUJE_ZAZNAM
                      00672         ; pokud zaznam ZAZ_A v bufferu2 vyhovuje hledani, nastavi bit TEMP1,0
0D98   01B6           00673         clrf TEMP1
                      00674         BANK_2
0D99   1703               M                 bsf     STATUS,RP1              ; BANK2  RP1:RP0 = 10
0D9A   1283               M                 bcf     STATUS,RP0    
0D9B   0810           00675         movfw 0x110
                      00676         BANK_0
0D9C   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0D9D   1283               M                 bcf     STATUS,RP0    
                      00677         ;               1.     byte ->  = 00h -> zaznam je prazdny; 
                      00678         ;                                               = 01h -> zaznam je adresar; 
                      00679         ;                                               = 02h -> zaznam je soubor; 
                      00680         ;                                               = 06h -> zaznam je soubor s priponou MP3
0D9E   00B7           00681         movwf TEMP2
0D9F   39FF           00682         andlw h'FF'
0DA0   1903           00683         btfsc STATUS,Z
0DA1   0008           00684         return                          ; pokud je zaznam prazdny, tak jej proste neberem
                      00685 ;HL_PARAMETRY   equ 0x059
                      00686 ;               0. bit = 0 > pokud hledáme soubory, tak pouze MP3
                      00687 ;                                1 > pokud hledáme soubory, vrací všechny soubory
                      00688 ;               1. bit = 0 > hledáme klasicky (nejdøíve adresáøe, poté soubory
                      00689 ;                                1 > hledáme pouze adresáøe, nebo soubory
                      00690 ;               2. bit = 0 > je-li nastaven 1. bit, hledáme pouze adresáøe
                      00691 ;                                1 > je-li nastaven 1. bit, hledáme pouze soubory
0DA2   1CD9           00692         btfss HL_PARAMETRY,1
0DA3   2DB1           00693         goto VYHOV_ZAZ_SOUBiADR
0DA4   1D59           00694         btfss HL_PARAMETRY,2
0DA5   2DAE           00695         goto VYHOV_ZAZ_ONLY_ADR
0DA6   1C59           00696         btfss HL_PARAMETRY,0
0DA7   2DAB           00697         goto VYHOV_ZAZ_ONLY_MP3
0DA8                  00698 VYHOV_ZAZ_ALL_FILES
0DA8   1C37           00699         btfss TEMP2,0
0DA9   1436           00700         bsf TEMP1,0
0DAA   0008           00701         return          
0DAB                  00702 VYHOV_ZAZ_ONLY_MP3
0DAB   1937           00703         btfsc TEMP2,2
0DAC   1436           00704         bsf TEMP1,0
0DAD   0008           00705         return
0DAE                  00706 VYHOV_ZAZ_ONLY_ADR
0DAE   1837           00707         btfsc TEMP2,0
0DAF   1436           00708         bsf TEMP1,0
0DB0   0008           00709         return
0DB1                  00710 VYHOV_ZAZ_SOUBiADR
0DB1   1C59           00711         btfss HL_PARAMETRY,0
0DB2   2DB5           00712         goto VYHOV_ZAZ_SOUBiADR_MP3
0DB3   1436           00713         bsf TEMP1,0
0DB4   0008           00714         return
0DB5                  00715 VYHOV_ZAZ_SOUBiADR_MP3
0DB5   1837           00716         btfsc TEMP2,0
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 110


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0DB6   1436           00717         bsf TEMP1,0
0DB7   1937           00718         btfsc TEMP2,2
0DB8   1436           00719         bsf TEMP1,0
0DB9   0008           00720         return
                      00721 ;**************************************************************************
0DBA                  00722 COMPARE_BUFF2_L_H
                      00723 ; porovna nazvy souboru na zacatku bufferu2 a na konci bufferu2
                      00724 ; pokud v abecede je driv nazev v horni polovine buff2 da to TEMP1 0x01
                      00725 ; pokud v abecede je driv nazev v dolni polovine buff2 da to TEMP1 0x02
                      00726 ; pokud se nazvy shoduji da do TEMP1 0x00
0DBA   01B6           00727         clrf TEMP1
                      00728         INDF_BANK_2                     ; stejne jako INDF_BANK_2
0DBB   1783               M                         bsf STATUS,IRP    
                      00729         BANK_0
0DBC   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0DBD   1283               M                 bcf     STATUS,RP0    
0DBE   3010           00730         movlw 0x10
0DBF   0084           00731         movwf FSR
0DC0   0800           00732         movfw INDF
0DC1   3903           00733         andlw h'03'                     ; ted nerozlisuji mezi souborem mp3 a ostatnimi soubory
0DC2   00B7           00734         movwf TEMP2
                      00735 
0DC3   3030           00736         movlw 0x30
0DC4   0084           00737         movwf FSR
0DC5   0800           00738         movfw INDF
0DC6   3903           00739         andlw h'03'                     ; ted nerozlisuji mezi souborem mp3 a ostatnimi soubory 
0DC7   0237           00740         subwf TEMP2,W           ; prni byte z bufferu 2 - prvni byte z bufferu 1
                      00741 
0DC8   1903           00742         btfsc STATUS,Z
0DC9   2DE0           00743         goto COMPARE_B1_B2_BYT2         ; prvni byt signalizujici typ byl shodny, pokracujeme bytem druh
                            ym (prvni byt nazvu)
0DCA   1C03           00744         btfss STATUS,C
0DCB   2E58           00745         goto COMPARE_B1_B2_BUFF2        ; hodnota v bufferu 1 byla vetsi, proto je v abecede dal...
0DCC   2E53           00746         goto COMPARE_B1_B2_BUFF1
                      00747 ; tato procedura je temer shodna s tou nasledujici, proto jen zadame jinou hodnotu do FSR
                      00748 ; (misto pro buffer1 na horni pulku bufferu2) a nechame probehnout stejny kus kodu...
                      00749 ;**************************************************************************
0DCD                  00750 COMPARE_BUFF1_BUFF2
                      00751 ; porovna nazvy souboru na zacatku bufferu1 s bufferem2
                      00752 ; pokud v abecede je driv nazev v bufferu1 da to TEMP1 0x01
                      00753 ; pokud v abecede je driv nazev v bufferu2 da to TEMP1 0x02
                      00754 ; pokud se nazvy shoduji da do TEMP1 0x00
                      00755 
                      00756 ; zaznamy v obou bufferech vypadaji nasledovne:
                      00757 ;               1.     byte ->  = 00h -> zaznam je prazdny; 
                      00758 ;                                               = 01h -> zaznam je adresar; 
                      00759 ;                                               = 02h -> zaznam je soubor; 
                      00760 ;                                               = 06h -> zaznam je soubor s priponou MP3
                      00761 ;               2..9   byte -> 8 znaku dlouhe jmeno ("DOSovsky" tvar - napr. slouzka "dokumenty" = "DOKU
                            ME~1" )
                      00762 ;               10..12 byte -> u souboru tri znaky pripony (u adresaru vetsinou mezery - 20h 20h 20h)
                      00763 ;               13..16 byte -> 1. cluster souboru
0DCD   01B6           00764         clrf TEMP1
                      00765         INDF_BANK_3                     ; stejne jako INDF_BANK_2
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 111


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0DCE   1783               M                         bsf STATUS,IRP    
                      00766         BANK_0
0DCF   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0DD0   1283               M                 bcf     STATUS,RP0    
0DD1   3010           00767         movlw 0x10
0DD2   0084           00768         movwf FSR
0DD3   0800           00769         movfw INDF
0DD4   3903           00770         andlw h'03'                     ; ted nerozlisuji mezi souborem mp3 a ostatnimi soubory
0DD5   00B7           00771         movwf TEMP2
                      00772 
0DD6   3090           00773         movlw 0x90
0DD7   0084           00774         movwf FSR
0DD8   0800           00775         movfw INDF
0DD9   3903           00776         andlw h'03'                     ; ted nerozlisuji mezi souborem mp3 a ostatnimi soubory 
0DDA   0237           00777         subwf TEMP2,W           ; prni byte z bufferu 2 - prvni byte z bufferu 1
                      00778 
0DDB   1903           00779         btfsc STATUS,Z
0DDC   2DE0           00780         goto COMPARE_B1_B2_BYT2 ; prvni byt signalizujici typ byl shodny, pokracujeme bytem druhym (prvn
                            i byt nazvu)
0DDD   1C03           00781         btfss STATUS,C
0DDE   2E58           00782         goto COMPARE_B1_B2_BUFF2        ; hodnota v bufferu 1 byla vetsi, proto je v abecede dal...
0DDF   2E53           00783         goto COMPARE_B1_B2_BUFF1
                      00784 
0DE0                  00785 COMPARE_B1_B2_BYT2
                      00786         BANK_2
0DE0   1703               M                 bsf     STATUS,RP1              ; BANK2  RP1:RP0 = 10
0DE1   1283               M                 bcf     STATUS,RP0    
0DE2   0A84           00787         incf FSR,F
0DE3   0800           00788         movfw INDF
0DE4   0211           00789         subwf 0x111,W                           ; 2. byte z bufferu 2 - 2. byte z bufferu 1
0DE5   1903           00790         btfsc STATUS,Z
0DE6   2DEA           00791         goto COMPARE_B1_B2_BYT3
0DE7   1C03           00792         btfss STATUS,C
0DE8   2E58           00793         goto COMPARE_B1_B2_BUFF2        ; hodnota v bufferu 1 byla vetsi, proto je v abecede dal...
0DE9   2E53           00794         goto COMPARE_B1_B2_BUFF1
                      00795 
0DEA                  00796 COMPARE_B1_B2_BYT3
                      00797         BANK_2
0DEA   1703               M                 bsf     STATUS,RP1              ; BANK2  RP1:RP0 = 10
0DEB   1283               M                 bcf     STATUS,RP0    
0DEC   0A84           00798         incf FSR,F
0DED   0800           00799         movfw INDF
0DEE   0212           00800         subwf 0x112,W                           ; 3. byte z bufferu 2 - 3. byte z bufferu 1
0DEF   1903           00801         btfsc STATUS,Z
0DF0   2DF4           00802         goto COMPARE_B1_B2_BYT4
0DF1   1C03           00803         btfss STATUS,C
0DF2   2E58           00804         goto COMPARE_B1_B2_BUFF2        ; hodnota v bufferu 1 byla vetsi, proto je v abecede dal...
0DF3   2E53           00805         goto COMPARE_B1_B2_BUFF1
                      00806 
0DF4                  00807 COMPARE_B1_B2_BYT4
                      00808         BANK_2
0DF4   1703               M                 bsf     STATUS,RP1              ; BANK2  RP1:RP0 = 10
0DF5   1283               M                 bcf     STATUS,RP0    
0DF6   0A84           00809         incf FSR,F
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 112


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0DF7   0800           00810         movfw INDF
0DF8   0213           00811         subwf 0x113,W                           ; 4. byte z bufferu 2 - 4. byte z bufferu 1
0DF9   1903           00812         btfsc STATUS,Z
0DFA   2DFE           00813         goto COMPARE_B1_B2_BYT5
0DFB   1C03           00814         btfss STATUS,C
0DFC   2E58           00815         goto COMPARE_B1_B2_BUFF2        ; hodnota v bufferu 1 byla vetsi, proto je v abecede dal...
0DFD   2E53           00816         goto COMPARE_B1_B2_BUFF1
                      00817 
0DFE                  00818 COMPARE_B1_B2_BYT5
                      00819         BANK_2
0DFE   1703               M                 bsf     STATUS,RP1              ; BANK2  RP1:RP0 = 10
0DFF   1283               M                 bcf     STATUS,RP0    
0E00   0A84           00820         incf FSR,F
0E01   0800           00821         movfw INDF
0E02   0214           00822         subwf 0x114,W                           ; 5. byte z bufferu 2 - 5. byte z bufferu 1
0E03   1903           00823         btfsc STATUS,Z
0E04   2E08           00824         goto COMPARE_B1_B2_BYT6
0E05   1C03           00825         btfss STATUS,C
0E06   2E58           00826         goto COMPARE_B1_B2_BUFF2        ; hodnota v bufferu 1 byla vetsi, proto je v abecede dal...
0E07   2E53           00827         goto COMPARE_B1_B2_BUFF1
                      00828 
0E08                  00829 COMPARE_B1_B2_BYT6
                      00830         BANK_2
0E08   1703               M                 bsf     STATUS,RP1              ; BANK2  RP1:RP0 = 10
0E09   1283               M                 bcf     STATUS,RP0    
0E0A   0A84           00831         incf FSR,F
0E0B   0800           00832         movfw INDF
0E0C   0215           00833         subwf 0x115,W                           ; 6. byte z bufferu 2 - 6. byte z bufferu 1
0E0D   1903           00834         btfsc STATUS,Z
0E0E   2E12           00835         goto COMPARE_B1_B2_BYT7
0E0F   1C03           00836         btfss STATUS,C
0E10   2E58           00837         goto COMPARE_B1_B2_BUFF2        ; hodnota v bufferu 1 byla vetsi, proto je v abecede dal...
0E11   2E53           00838         goto COMPARE_B1_B2_BUFF1
                      00839 
0E12                  00840 COMPARE_B1_B2_BYT7
                      00841         BANK_2
0E12   1703               M                 bsf     STATUS,RP1              ; BANK2  RP1:RP0 = 10
0E13   1283               M                 bcf     STATUS,RP0    
0E14   0A84           00842         incf FSR,F
0E15   0800           00843         movfw INDF
0E16   0216           00844         subwf 0x116,W                           ; 7. byte z bufferu 2 - 7. byte z bufferu 1
0E17   1903           00845         btfsc STATUS,Z
0E18   2E1C           00846         goto COMPARE_B1_B2_BYT8
0E19   1C03           00847         btfss STATUS,C
0E1A   2E58           00848         goto COMPARE_B1_B2_BUFF2        ; hodnota v bufferu 1 byla vetsi, proto je v abecede dal...
0E1B   2E53           00849         goto COMPARE_B1_B2_BUFF1
                      00850 
0E1C                  00851 COMPARE_B1_B2_BYT8
                      00852         BANK_2
0E1C   1703               M                 bsf     STATUS,RP1              ; BANK2  RP1:RP0 = 10
0E1D   1283               M                 bcf     STATUS,RP0    
0E1E   0A84           00853         incf FSR,F
0E1F   0800           00854         movfw INDF
0E20   0217           00855         subwf 0x117,W                           ; 8. byte z bufferu 2 - 8. byte z bufferu 1
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 113


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0E21   1903           00856         btfsc STATUS,Z
0E22   2E26           00857         goto COMPARE_B1_B2_BYT9
0E23   1C03           00858         btfss STATUS,C
0E24   2E58           00859         goto COMPARE_B1_B2_BUFF2        ; hodnota v bufferu 1 byla vetsi, proto je v abecede dal...
0E25   2E53           00860         goto COMPARE_B1_B2_BUFF1
                      00861 
0E26                  00862 COMPARE_B1_B2_BYT9
                      00863         BANK_2
0E26   1703               M                 bsf     STATUS,RP1              ; BANK2  RP1:RP0 = 10
0E27   1283               M                 bcf     STATUS,RP0    
0E28   0A84           00864         incf FSR,F
0E29   0800           00865         movfw INDF
0E2A   0218           00866         subwf 0x118,W                           ; 9. byte z bufferu 2 - 9. byte z bufferu 1
0E2B   1903           00867         btfsc STATUS,Z
0E2C   2E30           00868         goto COMPARE_B1_B2_BYT10
0E2D   1C03           00869         btfss STATUS,C
0E2E   2E58           00870         goto COMPARE_B1_B2_BUFF2        ; hodnota v bufferu 1 byla vetsi, proto je v abecede dal...
0E2F   2E53           00871         goto COMPARE_B1_B2_BUFF1
                      00872 
0E30                  00873 COMPARE_B1_B2_BYT10
                      00874         BANK_2
0E30   1703               M                 bsf     STATUS,RP1              ; BANK2  RP1:RP0 = 10
0E31   1283               M                 bcf     STATUS,RP0    
0E32   0A84           00875         incf FSR,F
0E33   0800           00876         movfw INDF
0E34   0219           00877         subwf 0x119,W                           ; 10. byte z bufferu 2 - 10. byte z bufferu 1
0E35   1903           00878         btfsc STATUS,Z
0E36   2E3A           00879         goto COMPARE_B1_B2_BYT11
0E37   1C03           00880         btfss STATUS,C
0E38   2E58           00881         goto COMPARE_B1_B2_BUFF2        ; hodnota v bufferu 1 byla vetsi, proto je v abecede dal...
0E39   2E53           00882         goto COMPARE_B1_B2_BUFF1
                      00883 
0E3A                  00884 COMPARE_B1_B2_BYT11
                      00885         BANK_2
0E3A   1703               M                 bsf     STATUS,RP1              ; BANK2  RP1:RP0 = 10
0E3B   1283               M                 bcf     STATUS,RP0    
0E3C   0A84           00886         incf FSR,F
0E3D   0800           00887         movfw INDF
0E3E   021A           00888         subwf 0x11A,W                           ; 11. byte z bufferu 2 - 11. byte z bufferu 1
0E3F   1903           00889         btfsc STATUS,Z
0E40   2E44           00890         goto COMPARE_B1_B2_BYT12
0E41   1C03           00891         btfss STATUS,C
0E42   2E58           00892         goto COMPARE_B1_B2_BUFF2        ; hodnota v bufferu 1 byla vetsi, proto je v abecede dal...
0E43   2E53           00893         goto COMPARE_B1_B2_BUFF1
                      00894 
0E44                  00895 COMPARE_B1_B2_BYT12
                      00896         BANK_2
0E44   1703               M                 bsf     STATUS,RP1              ; BANK2  RP1:RP0 = 10
0E45   1283               M                 bcf     STATUS,RP0    
0E46   0A84           00897         incf FSR,F
0E47   0800           00898         movfw INDF
0E48   021B           00899         subwf 0x11B,W                           ; 12. byte z bufferu 2 - 12. byte z bufferu 1
0E49   1903           00900         btfsc STATUS,Z
0E4A   2E4E           00901         goto COMPARE_B1_B2_SHODNE
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 114


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0E4B   1C03           00902         btfss STATUS,C
0E4C   2E58           00903         goto COMPARE_B1_B2_BUFF2        ; hodnota v bufferu 1 byla vetsi, proto je v abecede dal...
0E4D   2E53           00904         goto COMPARE_B1_B2_BUFF1
                      00905 
0E4E                  00906 COMPARE_B1_B2_SHODNE
                      00907         BANK_0
0E4E   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0E4F   1283               M                 bcf     STATUS,RP0    
0E50   3000           00908         movlw h'00'
0E51   00B6           00909         movwf TEMP1     
0E52   0008           00910         return
0E53                  00911 COMPARE_B1_B2_BUFF1
                      00912         BANK_0
0E53   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0E54   1283               M                 bcf     STATUS,RP0    
0E55   3001           00913         movlw h'01'
0E56   00B6           00914         movwf TEMP1     
0E57   0008           00915         return
0E58                  00916 COMPARE_B1_B2_BUFF2
                      00917         BANK_0
0E58   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0E59   1283               M                 bcf     STATUS,RP0    
0E5A   3002           00918         movlw h'02'
0E5B   00B6           00919         movwf TEMP1
0E5C   0008           00920         return
                      00921 ;**************************************************************************
0E5D                  00922 CLEAR_BUFFER1           ; BUFFER1 je 64bytu dat v bance 3 na adrese 0x190 - 0x1CF
                      00923                                         ; pouziva TEMP1
0E5D   3040           00924         movlw .64
0E5E   00B6           00925         movwf TEMP1
                      00926         INDF_BANK_3             ; neprime adresovani na banku 3
0E5F   1783               M                         bsf STATUS,IRP    
0E60   3090           00927         movlw 0x90
0E61   0084           00928         movwf FSR
0E62   3000           00929         movlw .0
                      00930 
0E63                  00931 CLEAR_BEFFER1__CLEAR
0E63   0080           00932         movwf INDF
0E64   0A84           00933         incf FSR,F
0E65   0BB6           00934         decfsz TEMP1,F
0E66   2E63           00935         goto CLEAR_BEFFER1__CLEAR
                      00936 
                      00937         INDF_BANK_0             ; neprime adresovani na banku 0
0E67   1383               M                         bcf STATUS,IRP    
0E68   0008           00938         return
                      00939 ;**************************************************************************
0E69                  00940 BUF2_TO_BUF1
                      00941         ; hodi 18 dat z dolni pulky bufferu 2 do dolni pulky bufferu 1
                      00942         ; 0x110 -> 0x190
                      00943         INDF_BANK_3
0E69   1783               M                         bsf STATUS,IRP    
                      00944         BANK_2
0E6A   1703               M                 bsf     STATUS,RP1              ; BANK2  RP1:RP0 = 10
0E6B   1283               M                 bcf     STATUS,RP0    
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 115


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0E6C   3090           00945         movlw 0x90
0E6D   0084           00946         movwf FSR
                      00947 
0E6E   0810           00948         movfw 0x110
0E6F   0080           00949         movwf INDF
0E70   0A84           00950         incf FSR,F
0E71   0811           00951         movfw 0x111
0E72   0080           00952         movwf INDF
0E73   0A84           00953         incf FSR,F
0E74   0812           00954         movfw 0x112
0E75   0080           00955         movwf INDF
0E76   0A84           00956         incf FSR,F
0E77   0813           00957         movfw 0x113
0E78   0080           00958         movwf INDF
0E79   0A84           00959         incf FSR,F
0E7A   0814           00960         movfw 0x114
0E7B   0080           00961         movwf INDF
0E7C   0A84           00962         incf FSR,F
0E7D   0815           00963         movfw 0x115
0E7E   0080           00964         movwf INDF
0E7F   0A84           00965         incf FSR,F
0E80   0816           00966         movfw 0x116
0E81   0080           00967         movwf INDF
0E82   0A84           00968         incf FSR,F
0E83   0817           00969         movfw 0x117
0E84   0080           00970         movwf INDF
0E85   0A84           00971         incf FSR,F
0E86   0818           00972         movfw 0x118
0E87   0080           00973         movwf INDF
0E88   0A84           00974         incf FSR,F
0E89   0819           00975         movfw 0x119
0E8A   0080           00976         movwf INDF
0E8B   0A84           00977         incf FSR,F
0E8C   081A           00978         movfw 0x11A
0E8D   0080           00979         movwf INDF
0E8E   0A84           00980         incf FSR,F
0E8F   081B           00981         movfw 0x11B
0E90   0080           00982         movwf INDF
0E91   0A84           00983         incf FSR,F
0E92   081C           00984         movfw 0x11C
0E93   0080           00985         movwf INDF
0E94   0A84           00986         incf FSR,F
0E95   081D           00987         movfw 0x11D
0E96   0080           00988         movwf INDF
0E97   0A84           00989         incf FSR,F
0E98   081E           00990         movfw 0x11E
0E99   0080           00991         movwf INDF
0E9A   0A84           00992         incf FSR,F
0E9B   081F           00993         movfw 0x11F
0E9C   0080           00994         movwf INDF
0E9D   0A84           00995         incf FSR,F
                      00996 
0E9E   0820           00997         movfw 0x120
0E9F   0080           00998         movwf INDF
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 116


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0EA0   0A84           00999         incf FSR,F
0EA1   0821           01000         movfw 0x121
0EA2   0080           01001         movwf INDF
0EA3   0A84           01002         incf FSR,F
                      01003         BANK_0
0EA4   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0EA5   1283               M                 bcf     STATUS,RP0    
0EA6   0008           01004         return
                      01005 ;**************************************************************************
0EA7                  01006 BUF2_LOW_TO_HIGH
                      01007         ; hodi 18 dat z dolni pulky bufferu 2 do horni pulky bufferu 2
                      01008         ; 0x110 - 0x121 -> 0x130 - 0x141
                      01009         BANK_2
0EA7   1703               M                 bsf     STATUS,RP1              ; BANK2  RP1:RP0 = 10
0EA8   1283               M                 bcf     STATUS,RP0    
0EA9   0810           01010         movfw 0x110
0EAA   00B0           01011         movwf 0x130
0EAB   0811           01012         movfw 0x111
0EAC   00B1           01013         movwf 0x131
0EAD   0812           01014         movfw 0x112
0EAE   00B2           01015         movwf 0x132
0EAF   0813           01016         movfw 0x113
0EB0   00B3           01017         movwf 0x133
0EB1   0814           01018         movfw 0x114
0EB2   00B4           01019         movwf 0x134
0EB3   0815           01020         movfw 0x115
0EB4   00B5           01021         movwf 0x135
0EB5   0816           01022         movfw 0x116
0EB6   00B6           01023         movwf 0x136
0EB7   0817           01024         movfw 0x117
0EB8   00B7           01025         movwf 0x137
0EB9   0818           01026         movfw 0x118
0EBA   00B8           01027         movwf 0x138
0EBB   0819           01028         movfw 0x119
0EBC   00B9           01029         movwf 0x139
0EBD   081A           01030         movfw 0x11A
0EBE   00BA           01031         movwf 0x13A
0EBF   081B           01032         movfw 0x11B
0EC0   00BB           01033         movwf 0x13B
0EC1   081C           01034         movfw 0x11C
0EC2   00BC           01035         movwf 0x13C
0EC3   081D           01036         movfw 0x11D
0EC4   00BD           01037         movwf 0x13D
0EC5   081E           01038         movfw 0x11E
0EC6   00BE           01039         movwf 0x13E
0EC7   081F           01040         movfw 0x11F
0EC8   00BF           01041         movwf 0x13F
                      01042 
0EC9   0820           01043         movfw 0x120
0ECA   00C0           01044         movwf 0x140
0ECB   0821           01045         movfw 0x121
0ECC   00C1           01046         movwf 0x141
                      01047         BANK_0
0ECD   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 117


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0ECE   1283               M                 bcf     STATUS,RP0    
0ECF   0008           01048         return
                      01049 ;**************************************************************************
0ED0                  01050 LONG_NAME
                      01051 ; Tato procedura prevezme v HL_ADR_CL[1-4] cislo prvniho clusteru adresare a v ZAZNAM[1-2] cislo zaznamu
                             
                      01052 ; od kteremu se pokusi najit dlouhe jmeno. Toto dlouhe jmeno umisti do bufferu 2
                      01053 ; Dlouhe jmeno je ukonceno nulovym bytem. Pokud v bufferu 2 se nulovy byt nevyskytuje, je delka dlouheho
                      01054 ; jmena delsi ci rovna 65.
                      01055 ; V POZICE vraci 00h pri nenalezeni dlouheho jmena a 01h pri pravdepodobnem nalezeni dlouheho jmena.
                      01056 
                      01057 ; 65 znaku neni moc, neco se tam ale vejde "1-3. G & D - Purify (Gabriel & Dresden Remix) featuring Ball
                            igom"   (ingo.mp3)
                      01058 ; vyvojak:
                      01059 ;
                      01060 ; CLEAR_BUFFER2
                      01061 ;
                      01062 ; ZAZNAMU_vBUFFERU_DISKU := 0
                      01063 ; IF (ZAZNAM < 5):                                      // zaznamy cislujeme od 0, 
                      01064 ;       HL_PARAMETRY := ZAZNAM;
                      01065 ;       ZAZNAM := 0
                      01066 ; else:
                      01067 ;       ZAZNAM := ZAZNAM - 5                    // protoze chceme prohledat 5 predchozich
                      01068 ;       HL_PARAMETRY := 5
                      01069 ; endif
                      01070 ;
                      01071 ; while (HL_PARAMETRY <> 0)
                      01072 ;       if (ZAZNAMU_vBUFFERU_DISKU = 0):
                      01073 ;               SKOC_NA_ZAZNAM
                      01074 ;       endif;
                      01075 
                      01076 ;////////////////////
                      01077 ; if (BUFF1[0] != 0) and (BUFF1[0] != E5h) and (BUFF1[11] = 0Fh):
                      01078 ;               // v bufferu1 mame zaznam obsahujici dlouhe jmeno 
                      01079 ;               FSR := (HL_PARAMETRY * 13) + 3
                      01080 ;               INDF := BUFF1[1]
                      01081 ;               inc FSR
                      01082 ;               INDF := BUFF1[3]
                      01083 ;               inc FSR
                      01084 ;               ...
                      01085 ; else:
                      01086 ;               CLEAR_BUFFER2   // zaznam neobsahuje dlouhe jmeno, proto jsou vsechny predchozi zaznamy 
                            k nicemu
                      01087 ; endif;
                      01088 ;////////////////////
                      01089 
                      01090 ;       HL_PARAMETRY --
                      01091 ;       ZAZNAM ++
                      01092 ;       ZAZNAMU_vBUFFERU_DISKU --
                      01093 ; endwhile
                      01094         PROG_PAGE_0
0ED0   118A               M                         bcf PCLATH,3
0ED1   120A               M                         bcf PCLATH,4
0ED2   22B7           01095         call CLEAR_BUFFER2                              ;               CLEAR_BUFFER2   // zaznam neobsa
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 118


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                            huje dlouhe jmeno, proto jsou vsechny predchozi zaznamy k nicemu
                      01096         PROG_PAGE_1
0ED3   158A               M                         bsf PCLATH,3
0ED4   120A               M                         bcf PCLATH,4
                      01097 
0ED5   01DE           01098         clrf ZAZNAMU_vBUFFERU_DISKU             ; ZAZNAMU_vBUFFERU_DISKU := 0
0ED6   01BB           01099         clrf POZICE
0ED7   0860           01100         movfw ZAZNAM1
0ED8   3C04           01101         sublw .4
0ED9   1C03           01102         btfss STATUS,C
0EDA   2EE3           01103         goto LONG_NAME_ELSE1
0EDB   0861           01104         movfw ZAZNAM2
0EDC   39FF           01105         andlw h'FF'
0EDD   1D03           01106         btfss STATUS,Z                                  ; IF (ZAZNAM < 5):                              
                                    // zaznamy cislujeme od 0, 
0EDE   2EE3           01107         goto LONG_NAME_ELSE1
                      01108 
0EDF   0860           01109         movfw ZAZNAM1
0EE0   00D9           01110         movwf HL_PARAMETRY                              ;       HL_PARAMETRY := ZAZNAM;
0EE1   01E0           01111         clrf ZAZNAM1                                    ;       ZAZNAM := 0
0EE2   2EE9           01112         goto LONG_NAME_ENDIF1
0EE3                  01113 LONG_NAME_ELSE1                                         ; else:
0EE3   3005           01114         movlw .5
0EE4   02E0           01115         subwf ZAZNAM1,F                                 ;       ZAZNAM := ZAZNAM - 5                    
                            // protoze chceme prohledat 5 predchozich
0EE5   1C03           01116         btfss STATUS,C
0EE6   03E1           01117         decf ZAZNAM2,F
0EE7   3005           01118         movlw .5
0EE8   00D9           01119         movwf HL_PARAMETRY                              ;       HL_PARAMETRY := 5
0EE9                  01120 LONG_NAME_ENDIF1                                        ; endif
                      01121 
0EE9                  01122 LONG_NAME_WHILE                                         ; while (HL_PARAMETRY <> 0)
0EE9   0859           01123         movfw HL_PARAMETRY
0EEA   39FF           01124         andlw h'FF'
0EEB   1903           01125         btfsc STATUS,Z
0EEC   2F54           01126         goto LONG_NAME_ENDWHILE
                      01127         
0EED   085A           01128         movfw HL_ADR_CL1
0EEE   00BC           01129         movwf CLUSTER1
0EEF   085B           01130         movfw HL_ADR_CL2
0EF0   00BD           01131         movwf CLUSTER2
0EF1   085C           01132         movfw HL_ADR_CL3
0EF2   00BE           01133         movwf CLUSTER3
0EF3   085D           01134         movfw HL_ADR_CL4
0EF4   00BF           01135         movwf CLUSTER4
                      01136 
0EF5   085E           01137         movfw ZAZNAMU_vBUFFERU_DISKU
0EF6   39FF           01138         andlw h'FF'
0EF7   1903           01139         btfsc STATUS,Z                                  ;       if (ZAZNAMU_vBUFFERU_DISKU = 0):
0EF8   23E1           01140         call SKOC_NA_ZAZNAM                     ;               SKOC_NA_ZAZNAM  endif;
                      01141         
0EF9   183B           01142         btfsc POZICE,0          ; SKOC_NA_ZAZNAM - pokud ZAZNAM[1-2] ukazuji mimo adresar, vrati v POZIC
                            E FFh (jinak 00h)
0EFA   2F57           01143         goto LONG_NAME_MIMO_ROZSAH
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 119


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      01144 
                      01145 ;////////////////////////////////
                      01146 ;       //tady probehne cteni zaznamu, zjisteni, zda jde o dlouhe jmeno a jeho cteni;   
0EFB   3010           01147         movlw .16
0EFC   00B6           01148         movwf TEMP1
                      01149         PROG_PAGE_0
0EFD   118A               M                         bcf PCLATH,3
0EFE   120A               M                         bcf PCLATH,4
0EFF   22A9           01150         call ZAPIS_DO_BUFFERU_1                 ; kazdy zaznam v adresari ma 32 bytu
                      01151         PROG_PAGE_1
0F00   158A               M                         bsf PCLATH,3
0F01   120A               M                         bcf PCLATH,4
                      01152 
                      01153         BANK_3
0F02   1703               M                 bsf     STATUS,RP1              ; BANK3  RP1:RP0 = 11
0F03   1683               M                 bsf     STATUS,RP0    
0F04   0810           01154         movfw 0x190
0F05   39FF           01155         andlw h'FF'
0F06   1903           01156         btfsc STATUS,Z
0F07   2F47           01157         goto LONG_NAME_ELSE2
0F08   3CE5           01158         sublw h'E5'
0F09   1903           01159         btfsc STATUS,Z
0F0A   2F47           01160         goto LONG_NAME_ELSE2
0F0B   081B           01161         movfw 0x19B
0F0C   3C0F           01162         sublw h'0F'
0F0D   1D03           01163         btfss STATUS,Z
0F0E   2F47           01164         goto LONG_NAME_ELSE2
0F0F                  01165 LONG_NAME_IF2                                           ; if (BUFF1[0] != 0) and (BUFF1[0] != E5h) and (
                            BUFF1[11] = 0Fh):
                      01166         BANK_0                                                  ;               // v bufferu1 mame zazna
                            m obsahujici dlouhe jmeno 
0F0F   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0F10   1283               M                 bcf     STATUS,RP0    
0F11   0859           01167         movfw HL_PARAMETRY
0F12   00B6           01168         movwf TEMP1
0F13   3000           01169         movlw .0
0F14                  01170 LONG_NAME_NASOBENI
0F14   3E0D           01171         addlw .13
0F15   0BB6           01172         decfsz TEMP1,f
0F16   2F14           01173         goto LONG_NAME_NASOBENI
0F17   3E03           01174         addlw .3        
0F18   0084           01175         movwf FSR                                               ;               FSR := (HL_PARAMETRY * 1
                            3) + 3
                      01176 
                      01177         BANK_3
0F19   1703               M                 bsf     STATUS,RP1              ; BANK3  RP1:RP0 = 11
0F1A   1683               M                 bsf     STATUS,RP0    
                      01178         INDF_BANK_2
0F1B   1783               M                         bsf STATUS,IRP    
0F1C   0811           01179         movfw 0x190+.1
0F1D   0080           01180         movwf INDF
0F1E   0A84           01181         incf FSR,F
0F1F   0813           01182         movfw 0x190+.3
0F20   0080           01183         movwf INDF
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 120


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0F21   0A84           01184         incf FSR,F
0F22   0815           01185         movfw 0x190+.5
0F23   0080           01186         movwf INDF
0F24   0A84           01187         incf FSR,F
0F25   0817           01188         movfw 0x190+.7
0F26   0080           01189         movwf INDF
0F27   0A84           01190         incf FSR,F
0F28   0819           01191         movfw 0x190+.9
0F29   0080           01192         movwf INDF
0F2A   0A84           01193         incf FSR,F
0F2B   081E           01194         movfw 0x190+.14
0F2C   0080           01195         movwf INDF
0F2D   0A84           01196         incf FSR,F
0F2E   0820           01197         movfw 0x190+.16
0F2F   0080           01198         movwf INDF
0F30   0A84           01199         incf FSR,F
0F31   0822           01200         movfw 0x190+.18
0F32   0080           01201         movwf INDF
0F33   0A84           01202         incf FSR,F
0F34   0824           01203         movfw 0x190+.20
0F35   0080           01204         movwf INDF
0F36   0A84           01205         incf FSR,F
0F37   0826           01206         movfw 0x190+.22
0F38   0080           01207         movwf INDF
0F39   0A84           01208         incf FSR,F
0F3A   0828           01209         movfw 0x190+.24
0F3B   0080           01210         movwf INDF
0F3C   0A84           01211         incf FSR,F
0F3D   082C           01212         movfw 0x190+.28
0F3E   0080           01213         movwf INDF
0F3F   0A84           01214         incf FSR,F
0F40   082E           01215         movfw 0x190+.30
0F41   0080           01216         movwf INDF
0F42   0A84           01217         incf FSR,F
                      01218         INDF_BANK_0
0F43   1383               M                         bcf STATUS,IRP    
                      01219         BANK_0
0F44   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0F45   1283               M                 bcf     STATUS,RP0    
0F46   2F4E           01220         goto LONG_NAME_ENDIF2
0F47                  01221 LONG_NAME_ELSE2                                         ; else:
                      01222         BANK_0
0F47   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0F48   1283               M                 bcf     STATUS,RP0    
                      01223         PROG_PAGE_0
0F49   118A               M                         bcf PCLATH,3
0F4A   120A               M                         bcf PCLATH,4
0F4B   22B7           01224         call CLEAR_BUFFER2                              ;               CLEAR_BUFFER2   // zaznam neobsa
                            huje dlouhe jmeno, proto jsou vsechny predchozi zaznamy k nicemu
                      01225         PROG_PAGE_1
0F4C   158A               M                         bsf PCLATH,3
0F4D   120A               M                         bcf PCLATH,4
0F4E                  01226 LONG_NAME_ENDIF2                                        ; endif;
                      01227 ;////////////////////////////////
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 121


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      01228 
0F4E   0AE0           01229         incf ZAZNAM1,F
0F4F   1903           01230         btfsc STATUS,Z
0F50   0AE1           01231         incf ZAZNAM2,F                                  ;       ZAZNAM ++
0F51   03D9           01232         decf HL_PARAMETRY,F                             ;       HL_PARAMETRY --
0F52   03DE           01233         decf ZAZNAMU_vBUFFERU_DISKU,F   ;       ZAZNAMU_vBUFFERU_DISKU --
0F53   2EE9           01234         goto LONG_NAME_WHILE
0F54                  01235 LONG_NAME_ENDWHILE                                      ; endwhile
0F54   3001           01236         movlw .1
0F55   00BB           01237         movwf POZICE
0F56   0008           01238         return
0F57                  01239 LONG_NAME_MIMO_ROZSAH
0F57   3000           01240         movlw .0
0F58   00BB           01241         movwf POZICE
0F59   0008           01242         return
                      01243 ;**************************************************************************
0F5A                  01244 HLEDEJ_V_NADRAZENEM
                      01245 ; v CLUSTER prijme prvni cluster adresare
                      01246 
                      01247 ; v nadrazenem adresari se pokusi najit zaznam odkazujici na tento adresar
                      01248 ; na zacatek BUFFERU 1 da cislo clusteru se zacatkem nadrazeneho adresare, 
                      01249 ; do HL_ADR_CL da prvni cluster hledaneho adresare a v ZAZNAM vratime cislo 
                      01250 ; zaznamu odkazujici na HL_ADR_CL
0F5A   083C           01251         movfw CLUSTER1
0F5B   00DA           01252         movwf HL_ADR_CL1
0F5C   083D           01253         movfw CLUSTER2
0F5D   00DB           01254         movwf HL_ADR_CL2
0F5E   083E           01255         movfw CLUSTER3
0F5F   00DC           01256         movwf HL_ADR_CL3
0F60   083F           01257         movfw CLUSTER4
0F61   00DD           01258         movwf HL_ADR_CL4
                      01259 
0F62   01BB           01260         clrf POZICE
                      01261         PROG_PAGE_0
0F63   118A               M                         bcf PCLATH,3
0F64   120A               M                         bcf PCLATH,4
0F65   24FB           01262         call CLUSTER_TO_LBA
0F66   3001           01263         movlw .1
0F67   00A6           01264         movwf SECTOR_C
0F68   22DE           01265         call READ_SECTOR        ; precteme prvni sektor z prvniho clusteru adresare     
0F69   301A           01266         movlw .26                       ; prvnich 26 slov je ted nepotrebnych
0F6A   00B6           01267         movwf TEMP1
0F6B   22A1           01268         call PRESKOC
                      01269 
0F6C   2286           01270         call READ_DATA
0F6D   0820           01271         movfw DATA_L
0F6E   00BE           01272         movwf CLUSTER3
0F6F   0821           01273         movfw DATA_H
0F70   00BF           01274         movwf CLUSTER4
                      01275 
0F71   3002           01276         movlw .2                        ; dalsi 4 byty jsou ted nepotrebne
0F72   00B6           01277         movwf TEMP1
0F73   22A1           01278         call PRESKOC
                      01279 
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 122


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0F74   2286           01280         call READ_DATA
0F75   0820           01281         movfw DATA_L
0F76   00BC           01282         movwf CLUSTER1
0F77   0821           01283         movfw DATA_H
0F78   00BD           01284         movwf CLUSTER2
                      01285         PROG_PAGE_1
0F79   158A               M                         bsf PCLATH,3
0F7A   120A               M                         bcf PCLATH,4
                      01286 
                      01287         ; v CLUSTER ted mame cislo prvniho clusteru nadrazeneho adresare. Umistime jej na zacatek BUFFER
                            U 1
                      01288         INDF_BANK_3
0F7B   1783               M                         bsf STATUS,IRP    
0F7C   3090           01289         movlw h'90'
0F7D   0084           01290         movwf FSR
0F7E   083C           01291         movfw CLUSTER1
0F7F   0080           01292         movwf INDF
0F80   0A84           01293         incf FSR,f
0F81   083D           01294         movfw CLUSTER2
0F82   0080           01295         movwf INDF
0F83   0A84           01296         incf FSR,f
0F84   083E           01297         movfw CLUSTER3
0F85   0080           01298         movwf INDF
0F86   0A84           01299         incf FSR,f
0F87   083F           01300         movfw CLUSTER4
0F88   0080           01301         movwf INDF
0F89   0A84           01302         incf FSR,f
                      01303         
0F8A   01E0           01304         clrf ZAZNAM1
0F8B   01E1           01305         clrf ZAZNAM2
0F8C                  01306 HLEDEJVNAD_CLUSTER
0F8C   01BB           01307         clrf POZICE
0F8D                  01308 HLEDEJVNAD_SECTOR
                      01309         PROG_PAGE_0
0F8D   118A               M                         bcf PCLATH,3
0F8E   120A               M                         bcf PCLATH,4
0F8F   24FB           01310         call CLUSTER_TO_LBA
0F90   3001           01311         movlw .1
0F91   00A6           01312         movwf SECTOR_C
0F92   22DE           01313         call READ_SECTOR
                      01314         PROG_PAGE_1
0F93   158A               M                         bsf PCLATH,3
0F94   120A               M                         bcf PCLATH,4
                      01315 
0F95   3010           01316         movlw .16
0F96   00B7           01317         movwf TEMP2
0F97                  01318 HLEDEJVNAD_ZAZNAM
0F97   01B8           01319         clrf TEMP3                                      ; pokud bude zaznam vyhovovat, bude TEMP3 0
                      01320         PROG_PAGE_0
0F98   118A               M                         bcf PCLATH,3
0F99   120A               M                         bcf PCLATH,4
0F9A   2286           01321         call READ_DATA
0F9B   0820           01322         movfw DATA_L
0F9C   39FF           01323         andlw h'FF'
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 123


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0F9D   1903           01324         btfsc STATUS,Z                          ; pokud 1. znak jmena souboru = 00h, je zaznam prazdny
0F9E   1438           01325         bsf TEMP3,0
                      01326 
0F9F   0820           01327         movfw DATA_L
0FA0   3CE5           01328         sublw h'E5'
0FA1   1903           01329         btfsc STATUS,Z                          ; pokud 1. znak jmena souboru = E5h, je zaznam prazdny
0FA2   1438           01330         bsf TEMP3,0
                      01331 
0FA3   3004           01332         movlw .4
0FA4   00B6           01333         movwf TEMP1
0FA5   22A1           01334         call PRESKOC                            ; jmeno (8) a priponu (3) ted nepotrebujeme
                      01335 
0FA6   2286           01336         call READ_DATA
0FA7   0821           01337         movfw DATA_H
0FA8   3910           01338         andlw h'10'
0FA9   3C10           01339         sublw h'10'
0FAA   1D03           01340         btfss STATUS,Z                          ; if (atributy and 10h) = 10h -> adresar
0FAB   1438           01341         bsf TEMP3,0
                      01342 
0FAC   3004           01343         movlw .4
0FAD   00B6           01344         movwf TEMP1
0FAE   22A1           01345         call PRESKOC                            ; dalsich 8 bytu je nam k nicemu
                      01346 
0FAF   2286           01347         call READ_DATA
0FB0   0820           01348         movfw DATA_L
0FB1   025C           01349         subwf HL_ADR_CL3,w
0FB2   1D03           01350         btfss STATUS,Z
0FB3   1438           01351         bsf TEMP3,0
0FB4   0821           01352         movfw DATA_H
0FB5   025D           01353         subwf HL_ADR_CL4,w
0FB6   1D03           01354         btfss STATUS,Z
0FB7   1438           01355         bsf TEMP3,0
                      01356 
0FB8   3002           01357         movlw .2                                        ; dalsi 4 byty jsou ted nepotrebne
0FB9   00B6           01358         movwf TEMP1
0FBA   22A1           01359         call PRESKOC
                      01360 
0FBB   2286           01361         call READ_DATA
0FBC   0820           01362         movfw DATA_L
0FBD   025A           01363         subwf HL_ADR_CL1,w
0FBE   1D03           01364         btfss STATUS,Z
0FBF   1438           01365         bsf TEMP3,0
0FC0   0821           01366         movfw DATA_H
0FC1   025B           01367         subwf HL_ADR_CL2,w
0FC2   1D03           01368         btfss STATUS,Z
0FC3   1438           01369         bsf TEMP3,0
                      01370 
0FC4   3002           01371         movlw .2                                        ; musime precist i posledni 4 byty ze zaznamu
0FC5   00B6           01372         movwf TEMP1
0FC6   22A1           01373         call PRESKOC
                      01374         PROG_PAGE_1
0FC7   158A               M                         bsf PCLATH,3
0FC8   120A               M                         bcf PCLATH,4
                      01375         
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 124


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0FC9   0838           01376         movfw TEMP3
0FCA   39FF           01377         andlw h'FF'
0FCB   1903           01378         btfsc STATUS,Z
0FCC   2FE0           01379         goto HLEDEJVNAD_KONEC           ; pokud se cluster shodoval, koncime
                      01380 
0FCD   0AE0           01381         incf ZAZNAM1,f
0FCE   1903           01382         btfsc STATUS,Z
0FCF   0AE1           01383         incf ZAZNAM2,f                          ; ZAZNAM ++
                      01384 
0FD0   0BB7           01385         decfsz TEMP2,f
0FD1   2F97           01386         goto HLEDEJVNAD_ZAZNAM
                      01387 
0FD2   0ABB           01388         incf POZICE,f
0FD3   083B           01389         movfw POZICE
0FD4   024C           01390         subwf CLUSTER_SIZE,w
0FD5   1D03           01391         btfss STATUS,Z
0FD6   2F8D           01392         goto HLEDEJVNAD_SECTOR
                      01393 
                      01394         PROG_PAGE_0
0FD7   118A               M                         bcf PCLATH,3
0FD8   120A               M                         bcf PCLATH,4
0FD9   255E           01395         call NEXT_CLUSTER
                      01396         PROG_PAGE_1
0FDA   158A               M                         bsf PCLATH,3
0FDB   120A               M                         bcf PCLATH,4
0FDC   083B           01397         movfw POZICE
0FDD   39FF           01398         andlw h'FF'
0FDE   1903           01399         btfsc STATUS,Z
0FDF   2F8C           01400         goto HLEDEJVNAD_CLUSTER
                      01401 
0FE0                  01402 HLEDEJVNAD_KONEC
0FE0   0008           01403         return
                      01404 ;**************************************************************************
1000                  00083  org 0x1000                                     ; PAGE 2
1000   0000           00084         nop                                             ; (aby nas prekladac varoval, az dosahneme teto 
                            stranky)
1800                  00085  org 0x1800                                     ; PAGE 3
1800   0000           00086         nop                                             ; (aby nas prekladac varoval, az dosahneme teto 
                            stranky)
                      00087 ;**********************************************************
                      00088         END
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 125


SYMBOL TABLE
  LABEL                             VALUE 

ABRT                              00000002
ACKDT                             00000005
ACKEN                             00000004
ACKSTAT                           00000006
ADCON0                            0000001F
ADCON1                            0000009F
ADCS0                             00000006
ADCS1                             00000007
ADDEN                             00000003
ADFM                              00000007
ADIE                              00000006
ADIF                              00000006
ADON                              00000000
ADRESH                            0000001E
ADRESL                            0000009E
APPLICABLE                        00000007
ATA_ADDRESS                       00000005
ATA_ADDRESS_TRIS                  00000085
ATA_ATTRIBUTES                    0000002E
ATA_CONTROL                       00000009
ATA_CONTROL_TRIS                  00000089
ATA_DIOR_N                        ATA_CONTROL,2
ATA_DIOW_N                        ATA_CONTROL,1
ATA_ERROR                         00000025
ATA_OK                            00000000
ATA_RESET                         000002C3
ATA_RESET_N                       ATA_CONTROL,0
ATA_STATUS                        0000002C
ATA_STATUS_A                      00000022
BANK_0                            
BANK_1                            
BANK_2                            
BANK_3                            
BCLIE                             00000003
BCLIF                             00000003
BF                                00000000
BIG_LOOP                          0000003A
BIG_LOOP_DALSI_FRAGMENT           00000079
BIG_LOOP_DEC_FRAGMENT             0000007F
BIG_LOOP__NENI_PRIKAZ             00000053
BIG_SECTOR                        00000003
BRGH                              00000002
BSY                               00000007
BUF2_LOW_TO_HIGH                  00000EA7
BUF2_TO_BUF1                      00000E69
C                                 00000000
C1INV                             00000004
C1OUT                             00000006
C2INV                             00000005
C2OUT                             00000007
CCP1CON                           00000017
CCP1IE                            00000002
CCP1IF                            00000002
CCP1M0                            00000000
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 126


SYMBOL TABLE
  LABEL                             VALUE 

CCP1M1                            00000001
CCP1M2                            00000002
CCP1M3                            00000003
CCP1X                             00000005
CCP1Y                             00000004
CCP2CON                           0000001D
CCP2IE                            00000000
CCP2IF                            00000000
CCP2M0                            00000000
CCP2M1                            00000001
CCP2M2                            00000002
CCP2M3                            00000003
CCP2X                             00000005
CCP2Y                             00000004
CCPR1H                            00000016
CCPR1L                            00000015
CCPR2H                            0000001C
CCPR2L                            0000001B
CEKEJ_PRIKAZ                      000008E6
CEK_PRIKAZ_01h                    0000001F
CEK_PRIKAZ_02h_03h                0000002D
CHS0                              00000003
CHS1                              00000004
CHS2                              00000005
CIS                               00000003
CKE                               00000006
CKP                               00000004
CLEAR_BEFFER1__CLEAR              00000E63
CLEAR_BEFFER2__CLEAR              000002BD
CLEAR_BUFFER1                     00000E5D
CLEAR_BUFFER2                     000002B7
CLUSTER1                          0000003C
CLUSTER2                          0000003D
CLUSTER3                          0000003E
CLUSTER4                          0000003F
CLUSTER_SIZE                      0000004C
CLUSTER_TO_LBA                    000004FB
CLUSTER_TO_LBA_NO_ROOT            0000051F
CM0                               00000000
CM1                               00000001
CM2                               00000002
CMCON                             0000009C
CMIE                              00000006
CMIF                              00000006
COMMAND                           0000002D
COMPARE_B1_B2_BUFF1               00000E53
COMPARE_B1_B2_BUFF2               00000E58
COMPARE_B1_B2_BYT10               00000E30
COMPARE_B1_B2_BYT11               00000E3A
COMPARE_B1_B2_BYT12               00000E44
COMPARE_B1_B2_BYT2                00000DE0
COMPARE_B1_B2_BYT3                00000DEA
COMPARE_B1_B2_BYT4                00000DF4
COMPARE_B1_B2_BYT5                00000DFE
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 127


SYMBOL TABLE
  LABEL                             VALUE 

COMPARE_B1_B2_BYT6                00000E08
COMPARE_B1_B2_BYT7                00000E12
COMPARE_B1_B2_BYT8                00000E1C
COMPARE_B1_B2_BYT9                00000E26
COMPARE_B1_B2_SHODNE              00000E4E
COMPARE_BUFF1_BUFF2               00000DCD
COMPARE_BUFF2_L_H                 00000DBA
CREN                              00000004
CSRC                              00000007
CVR0                              00000000
CVR1                              00000001
CVR2                              00000002
CVR3                              00000003
CVRCON                            0000009D
CVREN                             00000007
CVROE                             00000006
CVRR                              00000005
D                                 00000005
DALSI_SKLADBA                     000000CD
DALSI_SKLADBA_MAME_SOUBOR         00000136
DALSI_SKLADBA_NO_R_S              00000107
DALSI_SKLADBA_PLAY                00000153
DALSI_SKLADBA_REPAT_SOUBORU       000000D7
DATA_ADDRESS                      00000005
DATA_H                            00000021
DATA_L                            00000020
DATA_PORT_HIGH                    00000008
DATA_PORT_HIGH_TRIS               00000088
DATA_PORT_LOW                     00000006
DATA_PORT_LOW_TRIS                00000086
DC                                00000001
DEKREMENTUJ                       000006F4
DEKREMENTUJ_KONEC                 00000701
DELAY_200ms                       000001F2
DELAY_25us                        00000369
DELAY_2ms                         000001E9
DELAY_500ms                       000001FF
DELAY_5us                         000008E1
DEVICE                            0000002B
DEVICE_C                          00000023
DRDY                              00000006
DRQ                               00000003
D_A                               00000005
D_COMMAND                         00000027
D_DATA_R                          00000020
D_DEVICE                          00000026
D_DEVICE_C                        00000016
D_ERROR                           00000021
D_FEATURES                        00000021
D_LBA1                            00000023
D_LBA2                            00000024
D_LBA3                            00000025
D_SECTOR_C                        00000022
D_STATUS                          00000027
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 128


SYMBOL TABLE
  LABEL                             VALUE 

D_STATUS_A                        00000016
EEADR                             0000010D
EEADRH                            0000010F
EECON1                            0000018C
EECON2                            0000018D
EEDATA                            0000010C
EEDATH                            0000010E
EEIE                              00000004
EEIF                              00000004
EEPGD                             00000007
END_OF_INTERRUPT                  000001E1
ERR                               00000000
ERROR_LED                         ATA_ADDRESS,3
F                                 00000001
FAT32_LOAD                        00000004
FEATURES                          00000024
FERR                              00000002
FILE_INFO                         00000C61
FILE_INFO__CTI20_KONEC            00000CD4
FILE_INFO__DIR                    00000CA5
FILE_INFO__FILE                   00000CA7
FILE_INFO__READ_NAME              00000C69
FILE_SIZE                         00000CDC
FRAGMENT1                         00000051
FRAGMENT2                         00000052
FSR                               00000004
GCEN                              00000007
GIE                               00000007
GO                                00000002
GO_DONE                           00000002
HLEDEJ                            00000CF9
HLEDEJVNAD_CLUSTER                00000F8C
HLEDEJVNAD_KONEC                  00000FE0
HLEDEJVNAD_SECTOR                 00000F8D
HLEDEJVNAD_ZAZNAM                 00000F97
HLEDEJ_ELSE1                      00000D1B
HLEDEJ_ELSE3                      00000D68
HLEDEJ_ENDIF3                     00000D6E
HLEDEJ_END_REPEAT                 00000D6F
HLEDEJ_HLEDANI                    00000D39
HLEDEJ_IF2_ENDIF                  00000D33
HLEDEJ_IF4                        00000D66
HLEDEJ_KONEC                      00000D8A
HLEDEJ_NEHLEDAME_PRVNI            00000D23
HLEDEJ_REPEAT                     00000D3E
HLEDEJ_V_NADRAZENEM               00000F5A
HL_ADR_CL1                        0000005A
HL_ADR_CL2                        0000005B
HL_ADR_CL3                        0000005C
HL_ADR_CL4                        0000005D
HL_PARAMETRY                      00000059
HOB                               00000007
I2C_DATA                          00000005
I2C_READ                          00000002
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 129


SYMBOL TABLE
  LABEL                             VALUE 

I2C_START                         00000003
I2C_STOP                          00000004
IBF                               00000007
IBOV                              00000005
IDENTIFY_DEVICE                   00000316
IF2                               00000D30
INDF                              00000000
INDF_BANK_0                       
INDF_BANK_1                       
INDF_BANK_2                       
INDF_BANK_3                       
INIT_ATA__DALSI                   00000355
INIT_ATA__DALSI2                  0000035F
INIT_ATA__NOT_SUPPORT_LBA48       00000352
INIT_CONFIG                       00000178
INIT_PORT                         00000165
INTCON                            0000000B
INTE                              00000004
INTEDG                            00000006
INTERRUPT                         000001D3
INTF                              00000001
IRP                               00000007
LBA1                              00000027
LBA2                              00000028
LBA3                              00000029
LBA4                              0000002A
LBA48_SUPPORT                     00000002
LBA_SUPPORT                       00000001
LONG_NAME                         00000ED0
LONG_NAME_ELSE1                   00000EE3
LONG_NAME_ELSE2                   00000F47
LONG_NAME_ENDIF1                  00000EE9
LONG_NAME_ENDIF2                  00000F4E
LONG_NAME_ENDWHILE                00000F54
LONG_NAME_IF2                     00000F0F
LONG_NAME_MIMO_ROZSAH             00000F57
LONG_NAME_NASOBENI                00000F14
LONG_NAME_WHILE                   00000EE9
MP3_BSYNC                         MP3_PORT,2
MP3_CS                            MP3_PORT,1
MP3_DREQ                          MP3_PORT,0
MP3_NOT_PLAY                      000000CC
MP3_PORT                          00000007
MP3_PORT_TRIS                     00000087
MP3_REWIND_FORWARD                0000009E
MP3_SCLK                          MP3_PORT,3
MP3_SI                            MP3_PORT,5
MP3_SO                            MP3_PORT,4
NACTI_FAT32                       00000437
NACTI_FAT32__KONEC                000004FA
NEXT_CLUSTER                      0000055E
NEXT_CLUSTER_KONEC                000005E3
NEXT_CLUSTER_NEPRAZDNY            000005CC
NEXT_CLUSTER_NO_ROOT              00000582
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 130


SYMBOL TABLE
  LABEL                             VALUE 

NOT_A                             00000005
NOT_ADDRESS                       00000005
NOT_BO                            00000000
NOT_BOR                           00000000
NOT_DONE                          00000002
NOT_MP3_REWIND_FORWARD            000000AA
NOT_PD                            00000003
NOT_POR                           00000001
NOT_RBPU                          00000007
NOT_RC8                           00000006
NOT_T1SYNC                        00000002
NOT_TO                            00000004
NOT_TX8                           00000006
NOT_W                             00000002
NOT_WRITE                         00000002
NULA                              000007B1
OBF                               00000006
ODESLI_BUFF2_HIGH                 000001BF
ODESLI_BUFF2_HIGH_ODESILANI       000001C2
ODESLI_BUFFER2                    000001C9
ODESLI_BUFFER2_ODESILANI          000001CC
ODESLI_DATA                       000001A6
ODESLI_MODEL_NUMBER               000001AE
ODESLI_MODEL_NUMBER_ODESILANI     000001B3
OERR                              00000001
OPERAND_X1                        000000A0
OPERAND_X2                        000000A1
OPERAND_X3                        000000A2
OPERAND_X4                        000000A3
OPERAND_Y1                        000000A4
OPERAND_Y2                        000000A5
OPERAND_Y3                        000000A6
OPERAND_Y4                        000000A7
OPTION_REG                        00000081
P                                 00000004
PARAM_MAX_LBA1                    0000002F
PARAM_MAX_LBA2                    00000030
PARAM_MAX_LBA3                    00000031
PARAM_MAX_LBA4                    00000032
PARAM_SLOV_V_SEKTORU1             00000033
PARAM_SLOV_V_SEKTORU2             00000034
PCFG0                             00000000
PCFG1                             00000001
PCFG2                             00000002
PCFG3                             00000003
PCL                               00000002
PCLATH                            0000000A
PCON                              0000008E
PEIE                              00000006
PEN                               00000002
PIE1                              0000008C
PIE2                              0000008D
PIR1                              0000000C
PIR2                              0000000D
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 131


SYMBOL TABLE
  LABEL                             VALUE 

POCATEK_DAT1                      00000040
POCATEK_DAT2                      00000041
POCATEK_DAT3                      00000042
POCATEK_DAT4                      00000043
POCATEK_FAT1                      00000044
POCATEK_FAT2                      00000045
POCATEK_FAT3                      00000046
POCATEK_FAT4                      00000047
PORTA                             00000005
PORTB                             00000006
PORTC                             00000007
PORTD                             00000008
PORTE                             00000009
POSUNDOLEVA                       00000704
POSUNDOLEVA_1                     0000070A
POSUNDOLEVA_2                     00000712
POSUNDOLEVA_3                     0000071B
POSUNDOLEVA_4                     00000725
POSUNDOLEVA_5                     00000730
POSUNDOLEVA_6                     0000073C
POSUNDOLEVA_7                     00000749
POSUNDOPRAVA                      00000757
POSUNDOPRAVA_1                    0000075D
POSUNDOPRAVA_2                    00000766
POSUNDOPRAVA_3                    00000770
POSUNDOPRAVA_4                    0000077B
POSUNDOPRAVA_5                    00000787
POSUNDOPRAVA_6                    00000794
POSUNDOPRAVA_7                    000007A2
POZDRAV                           0000019B
POZICE                            0000003B
PR2                               00000092
PREH_ADR_CL1                      00000062
PREH_ADR_CL2                      00000063
PREH_ADR_CL3                      00000064
PREH_ADR_CL4                      00000065
PREH_CITAC_PREV                   00000068
PREH_DATA_CL1                     00000069
PREH_DATA_CL2                     0000006A
PREH_DATA_CL3                     0000006B
PREH_DATA_CL4                     0000006C
PREH_DATA_POZICE                  0000006D
PREH_D_FRAGMENT1                  00000053
PREH_D_FRAGMENT2                  00000054
PREH_STAV0                        0000006E
PREH_STAV1                        0000006F
PREH_ZAZNAM1                      00000066
PREH_ZAZNAM2                      00000067
PRESKOC                           000002A1
PRETECENI                         000000AC
PRIJATE_DATO                      00000074
PRIJATYCH_DAT                     00000073
PRIKAZ_02h                        000008EB
PRIKAZ_02h__ODESILANI_ODDILU      00000901
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 132


SYMBOL TABLE
  LABEL                             VALUE 

PRIKAZ_03h                        0000090C
PRIKAZ_04h                        0000092A
PRIKAZ_05h                        00000937
PRIKAZ_05h_KONEC                  0000095F
PRIKAZ_05h_PAR1_NOT_OK            0000094B
PRIKAZ_05h_PAR1_OK                00000951
PRIKAZ_05h_PAR2_NOT_OK            00000958
PRIKAZ_05h_PAR2_OK                0000095E
PRIKAZ_06h                        00000968
PRIKAZ_07h                        0000098A
PRIKAZ_07h__ODESLI_SECTOR         000009A6
PRIKAZ_08h                        000009B1
PRIKAZ_08h_KONEC                  000009D4
PRIKAZ_08h_PAR1_NOT_OK            000009C5
PRIKAZ_08h_PAR1_OK                000009C8
PRIKAZ_08h_PAR2_NOT_OK            000009CF
PRIKAZ_08h_PAR2_OK                000009D2
PRIKAZ_09h                        000009DF
PRIKAZ_09h_KONEC                  00000A09
PRIKAZ_09h_SPATNY_PAR             00000A03
PRIKAZ_0Ah                        00000A12
PRIKAZ_0Ah_KONEC                  00000A35
PRIKAZ_0Ah_PAR1_NOT_OK            00000A2A
PRIKAZ_0Ah_PAR1_OK                00000A30
PRIKAZ_0Bh                        00000A40
PRIKAZ_0Ch                        00000A62
PRIKAZ_0Ch_JEROOT                 00000A83
PRIKAZ_0Ch_NENI_ZACATEK_ADR       00000A81
PRIKAZ_0Ch_ODESLI                 00000A84
PRIKAZ_80h                        00000A9E
PRIKAZ_80h_KONEC                  00000AFF
PRIKAZ_80h_PAR1_NOT_OK            00000AB2
PRIKAZ_80h_PAR1_OK                00000AB8
PRIKAZ_80h_PAR2_NOT_OK            00000ABF
PRIKAZ_80h_PAR2_OK                00000AC5
PRIKAZ_81h                        00000B0A
PRIKAZ_82h                        00000B29
PRIKAZ_83h                        00000B3F
PRIKAZ_84h                        00000B73
PROG_PAGE_0                       
PROG_PAGE_1                       
PROG_PAGE_2                       
PROG_PAGE_3                       
PRVNI_CL_ADRESARE                 00000BA7
PRVNI_CL_ADRESARE_KONEC           00000BE0
PRVNI_CL_ADRESARE_MEZERY          00000BC7
PS0                               00000000
PS1                               00000001
PS2                               00000002
PSA                               00000003
PSPIE                             00000007
PSPIF                             00000007
PSPMODE                           00000004
R                                 00000002
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 133


SYMBOL TABLE
  LABEL                             VALUE 

RBIE                              00000003
RBIF                              00000000
RC8_9                             00000006
RC9                               00000006
RCD8                              00000000
RCEN                              00000003
RCIE                              00000005
RCIF                              00000005
RCREG                             0000001A
RCSTA                             00000018
RD                                00000000
RD_DEVICE                         00000228
RD_ERROR                          00000210
RD_LBA1                           0000021C
RD_LBA2                           00000220
RD_LBA3                           00000224
RD_SC                             00000218
RD_STATUS                         0000020C
RD_STATUS_A                       00000214
READ_DATA                         00000286
READ_DATA_CTEME                   0000028F
READ_SECTOR                       000002DE
READ_SECTOR_LBA27                 000002EF
READ_SECTOR_LBA48                 000002FE
READ_WRITE                        00000002
ROOT_DIR_CL1                      00000048
ROOT_DIR_CL2                      00000049
ROOT_DIR_CL3                      0000004A
ROOT_DIR_CL4                      0000004B
ROZDIL                            000006C8
RP0                               00000005
RP1                               00000006
RSEN                              00000001
RUTR                              00000263
RUTW                              00000270
RX9                               00000006
RX9D                              00000000
R_W                               00000002
S                                 00000003
SCAN_BR                           0000037A
SCAN_MBR                          00000374
SCAN_MBR__HLEDEJ_ROZSIRENY_ODDIL  000003C3
SCAN_MBR__KONEC                   000003ED
SECTOR_C                          00000026
SELECT_DEVICE                     000002A5
SEN                               00000000
SEND_MP3_DATA                     0000008F
SEND_MP3_WORD                     000000BB
SKOC_NA_ZAZNAM                    00000BE1
SKOC_NA_ZAZNAM_KONEC              00000C60
SKOC_NA_ZAZNAM_MAME_CL            00000C3F
SKOC_NA_ZAZNAM_MAME_ZAZNAM        00000C5B
SKOC_NA_ZAZNAM_MIMO_ROZSAH        00000C5E
SKOC_NA_ZAZNAM_PRESKOC_CL         00000C11
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 134


SYMBOL TABLE
  LABEL                             VALUE 

SMP                               00000007
SOUCET                            0000069C
SPBRG                             00000099
SPEN                              00000007
SREN                              00000005
SRST                              00000002
SSPADD                            00000093
SSPBUF                            00000013
SSPCON                            00000014
SSPCON2                           00000091
SSPEN                             00000005
SSPIE                             00000003
SSPIF                             00000003
SSPM0                             00000000
SSPM1                             00000001
SSPM2                             00000002
SSPM3                             00000003
SSPOV                             00000006
SSPSTAT                           00000094
START                             00000010
STATUS                            00000003
STAV_PRIKAZU                      00000075
SYNC                              00000004
T0CS                              00000005
T0IE                              00000005
T0IF                              00000002
T0SE                              00000004
T1CKPS0                           00000004
T1CKPS1                           00000005
T1CON                             00000010
T1INSYNC                          00000002
T1OSCEN                           00000003
T1SYNC                            00000002
T2CKPS0                           00000000
T2CKPS1                           00000001
T2CON                             00000012
TEMP1                             00000036
TEMP2                             00000037
TEMP3                             00000038
TEMP4                             00000039
TEMP5                             0000003A
TEMPW                             00000035
TEMP_FSR                          00000072
TEMP_PCLATH                       00000076
TEMP_STATUS                       00000071
TEMP_WORKING                      00000070
TMP0                              00000038
TMP1                              00000036
TMP2                              00000037
TMR0                              00000001
TMR0IE                            00000005
TMR0IF                            00000002
TMR1CS                            00000001
TMR1H                             0000000F
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 135


SYMBOL TABLE
  LABEL                             VALUE 

TMR1IE                            00000000
TMR1IF                            00000000
TMR1L                             0000000E
TMR1ON                            00000000
TMR2                              00000011
TMR2IE                            00000001
TMR2IF                            00000001
TMR2ON                            00000002
TOUTPS0                           00000003
TOUTPS1                           00000004
TOUTPS2                           00000005
TOUTPS3                           00000006
TRISA                             00000085
TRISB                             00000086
TRISC                             00000087
TRISD                             00000088
TRISE                             00000089
TRISE0                            00000000
TRISE1                            00000001
TRISE2                            00000002
TRMT                              00000001
TX8_9                             00000006
TX9                               00000006
TX9D                              00000000
TXD8                              00000000
TXEN                              00000005
TXIE                              00000004
TXIF                              00000004
TXREG                             00000019
TXSTA                             00000098
UA                                00000001
VSADDR_AIADDR                     0000000A
VSADDR_AICTRL0                    0000000D
VSADDR_AICTRL1                    0000000E
VSADDR_AUDATA                     00000005
VSADDR_CLOCKF                     00000003
VSADDR_DECODE_TIME                00000004
VSADDR_HDAT0                      00000008
VSADDR_HDAT1                      00000009
VSADDR_MODE                       00000000
VSADDR_STATUS                     00000001
VSADDR_VOL                        0000000B
VSADDR_WRAM                       00000006
VSADDR_WRAMADDR                   00000007
VSREG_MODE_L                      0000004D
VSREG_STATUS_L                    0000004E
VSREG_VOL_H                       00000050
VSREG_VOL_L                       0000004F
VS_BEEP                           000008C0
VS_END_BEEP                       000008AE
VS_INIT                           000008D2
VS_RD_BYTE                        00000835
VS_RD_REG                         00000871
VS_SEND_1024_NULL                 0000089C
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 136


SYMBOL TABLE
  LABEL                             VALUE 

VS_SEND_32_NULL                   00000894
VS_SET_VOLUME                     000008A3
VS_SOFT_RESET                     0000087F
VS_WR_BYTE                        00000800
VS_WR_REG                         00000863
VYHOVUJE_ZAZNAM                   00000D98
VYHOV_ZAZ_ALL_FILES               00000DA8
VYHOV_ZAZ_ONLY_ADR                00000DAE
VYHOV_ZAZ_ONLY_MP3                00000DAB
VYHOV_ZAZ_SOUBiADR                00000DB1
VYHOV_ZAZ_SOUBiADR_MP3            00000DB5
VYSLEDEK1                         000000A8
VYSLEDEK2                         000000A9
VYSLEDEK3                         000000AA
VYSLEDEK4                         000000AB
W                                 00000000
WAIT_FOR_READY                    0000036E
WAIT_FOR_VSDREQ                   000008AB
WCOL                              00000007
WR                                00000001
WREN                              00000002
WRERR                             00000003
WR_BLOCK                          00000254
WR_COMMAND                        00000231
WR_DC                             0000022C
WR_DEVICE                         0000024A
WR_FEATURES                       0000024F
WR_LBA1                           0000023B
WR_LBA2                           00000240
WR_LBA3                           00000245
WR_SC                             00000236
WR_USART                          00000193
Z                                 00000002
ZAPIS_C_ZAZNAMU                   00000D8B
ZAPIS_DO_BUFFERU_1                000002A9
ZAPIS_DO_BUFFERU_1__ZAPIS         000002AC
ZAZNAM1                           00000060
ZAZNAM2                           00000061
ZAZNAMU_vBUFFERU_DISKU            0000005E
ZJISTI_FRAGMENT                   000005E6
ZJISTI_FRAGMENT_CLUSTER           0000062B
ZJISTI_FRAGMENT_CTI_SECTOR        00000627
ZJISTI_FRAGMENT_INC_KONEC         00000696
ZJISTI_FRAGMENT_KONEC             00000699
ZJISTI_FRAGMENT_NEPRAZDNY         00000643
ZKONTROLUJ_ODDIL_FAT32            000003EE
ZKONTROLUJ_ODDIL_FAT32__JMENOVKA  00000411
ZKONTROLUJ_ODDIL_FAT32__KONEC     00000436
_BODEN_OFF                        00003FBF
_BODEN_ON                         00003FFF
_CPD_OFF                          00003FFF
_CPD_ON                           00003EFF
_CP_ALL                           00001FFF
_CP_OFF                           00003FFF
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 137


SYMBOL TABLE
  LABEL                             VALUE 

_DEBUG_OFF                        00003FFF
_DEBUG_ON                         000037FF
_HS_OSC                           00003FFE
_LP_OSC                           00003FFC
_LVP_OFF                          00003F7F
_LVP_ON                           00003FFF
_PWRTE_OFF                        00003FFF
_PWRTE_ON                         00003FF7
_RC_OSC                           00003FFF
_WDT_OFF                          00003FFB
_WDT_ON                           00003FFF
_WRT_1FOURTH                      00003BFF
_WRT_256                          00003DFF
_WRT_HALF                         000039FF
_WRT_OFF                          00003FFF
_XT_OSC                           00003FFD
__16F877A                         00000001
nEIN                              00000001


MEMORY USAGE MAP ('X' = Used,  '-' = Unused)

0000 : X---XXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0040 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0080 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
00C0 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0100 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0140 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0180 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
01C0 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0200 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0240 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0280 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
02C0 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0300 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0340 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0380 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
03C0 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0400 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0440 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0480 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
04C0 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0500 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0540 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0580 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
05C0 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0600 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 138


MEMORY USAGE MAP ('X' = Used,  '-' = Unused)


0640 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0680 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
06C0 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0700 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0740 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0780 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
07C0 : XXXX------------ ---------------- ---------------- ----------------
0800 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0840 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0880 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
08C0 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0900 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0940 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0980 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
09C0 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0A00 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0A40 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0A80 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0AC0 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0B00 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0B40 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0B80 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0BC0 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0C00 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0C40 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0C80 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0CC0 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0D00 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0D40 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0D80 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0DC0 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0E00 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0E40 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0E80 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0EC0 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0F00 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0F40 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0F80 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0FC0 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX X--------------- ----------------
1000 : X--------------- ---------------- ---------------- ----------------
1800 : X--------------- ---------------- ---------------- ----------------
2000 : -------X-------- ---------------- ---------------- ----------------

All other memory blocks unused.

Program Memory Words Used:  4004
Program Memory Words Free:  4188


MPASM 03.90 Released                                 MAIN.ASM   3-7-2006  13:41:04         PAGE 139





Errors   :     0
Warnings :     0 reported,     0 suppressed
Messages :     0 reported,   390 suppressed

