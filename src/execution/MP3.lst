MPASM 03.90 Released                                  MP3.ASM   10-27-2005  22:54:11         PAGE  1


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0000                  00001 c;********************************************************************
                      00002 ; Zkusebni program na cteni dat z ATA disku.                      
                      00003 ; Casem mozna bude prekousavat FAT32 a prehravat z disku MP3.
                      00004 ; To je zatim jen ale sen
                      00005 ;                                                                
                      00006 ; srpen 2005 - zari 2005 Karry - lukas.karas@centrum.cz
                      00007 ;********************************************************************
                      00008 
                      00009 ;**********************************************************
                      00010 ;   HLAVNI SOUBOR 
                      00011 ;**********************************************************
                      00012 ; !!!!!!!! VSECHNY CASOVE SMYCKY JSOU POCITANY NA Fosc=16MHz !!!!!
                      00013 ; !!!!!!!! NASTAVENI USARTu TAKY !!!!!!!
                      00014         LIST            p=PIC16f877,C=132,n=60
2007   3F3A           00015         __CONFIG        _WDT_OFF & _HS_OSC & _PWRTE_OFF & _BODEN_OFF & _LVP_OFF 
                      00016                         ; LVP_OFF = RB3 jako digitalni I/O
                      00017         errorlevel -302      ; vypnuti Message [302]: Register in operand not in
                      00018                       ; bank 0.
                      00019                       ; ! zjednoduseni vypisu, ale riziko prehlednuti chyby
                      00020 
                      00021         include "P16F877.inc"   ; definice blbosti kolem procesoru
                      00001         LIST
                      00002 ; P16F877.INC  Standard Header File, Version 1.00    Microchip Technology, Inc.
                      00373         LIST
                      00022         include "mp3.inc"               ; definice promennych a portu
                      00001 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00002 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00003 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00004 ; DEFINICE PORTU
                      00005 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00006 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00007 ;**********************************************************
                      00008 ; ZAPOJENI PORTU:
                      00009 ;       portA - MP3 dekoder vs1001g (alespon doufam ze sezenem tenhle typ, je totiz naprosto spickovej!!
                            !)
                      00010 ;                               5      4     3   2     1         0
                      00011 ;                               BSYNC  DREQ  CS  SCLK  SI/SDATA  SO
                      00012 ;               portB - ATA datova sbernice (dolnich 8 bitu)
                      00013 ;               7   .. 0
                      00014 ;               DD7 .. DD0
                      00015 ;               portD - ATA datova sbernice (hornich 8 bitu)
                      00016 ;               15   .. 8
                      00017 ;               DD15 .. DD8 
                      00018 ;               portC - adresove signaly ATA, ERROR_LED, a USART
                      00019 ;                               7          6         5     4     3          2    1    0
                      00020 ;                               USART out  USART in  CS1-  CS0-  ERROR_LED  DA2  DA1  DA0  
                      00021 ;                               (signaly se znaminkem minus jsou aktivni v logicke 0 !!!)
                      00022 ;               portE - ridici signaly ATA
                      00023 ;                               2       1      0
                      00024 ;                               DIOR-   DIOW-  RESET-
                      00025 ;                               (signaly se znaminkem minus jsou aktivni v logicke 0 !!!)
                      00026 ;**********************************************************
  00000005            00027 MP3_PORT                equ PORTA
  00000085            00028 MP3_PORT_TRIS   equ TRISA
MPASM 03.90 Released                                  MP3.ASM   10-27-2005  22:54:11         PAGE  2


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00029 ; BITY MP3_PORT
                      00030 #define MP3_SO          MP3_PORT,0      ; serial output - tady dostavame z dekoderu data
                      00031 #define MP3_SI          MP3_PORT,1      ; serial input  - pokud MP3_CS=1, tak posilame mp3 data, pokud =
                            0, tak posilame prikaz
                      00032 #define MP3_SCLK        MP3_PORT,2      ; clock - nabezna hrana urcuje platnost dat pri seriovem prenosu
                      00033 #define MP3_CS          MP3_PORT,3      ; cable select  - pokud MP3_CS=1, tak po SI posilame mp3 data, p
                            okud =0, tak posilame prikaz
                      00034 #define MP3_DREQ        MP3_PORT,4      ; data request  - pokud =1, tak dekoder pozaduje dalsi mp3 data
                      00035 #define MP3_BSYNC       MP3_PORT,5      ; pro synchronizaci - ma byt nastaven pri prvnim prenasenem bitu
                             kazdeho bytu
                      00036 ;**********************************************************
                      00037 ; pokud jsem dobre pochopil dataSheat dekoderu vs1001, tak staci do nej jen cpat data, a kdyz skonci mp3
                            , tak odeslat 1024 nulovych bytu,
                      00038 ; softwarove resetovat a posilat dalsi mp3...
                      00039 ;
                      00040 ; popis registru obvodu vs1001 najdete na strane 22 dataSheatu 
                      00041 ; v jeho registrech jsou k dispozici data z hlavicky mp3, zdali mp3 ma spravny format, 
                      00042 ; ovladani hlasitosti a dalsi spousty uzitecnych informaci
                      00043 ;**********************************************************
                      00044 ; PORTY DISKU
  00000007            00045 ATA_ADDRESS             equ PORTC
  00000009            00046 ATA_CONTROL             equ PORTE
  00000006            00047 DATA_PORT_LOW           equ PORTB
  00000008            00048 DATA_PORT_HIGH          equ PORTD
                      00049 
                      00050 
  00000087            00051 ATA_ADDRESS_TRIS        equ TRISC
  00000089            00052 ATA_CONTROL_TRIS        equ TRISE
  00000086            00053 DATA_PORT_LOW_TRIS      equ TRISB
  00000088            00054 DATA_PORT_HIGH_TRIS     equ TRISD
                      00055 
                      00056 ; bity ATA_ADDRESS portu
                      00057 #define ERROR_LED       ATA_ADDRESS,3
                      00058 ; bity ATA_CONTROL portu
                      00059 #define ATA_RESET_N     ATA_CONTROL,0
                      00060 #define ATA_DIOW_N      ATA_CONTROL,1
                      00061 #define ATA_DIOR_N      ATA_CONTROL,2
                      00062 
                      00063 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00064 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00065 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00066 ; DEFINICE KONSTANT
                      00067 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00068 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00069 ; ADRESY ATA REGISTRU:
                      00070 ;                                                                       / CHS adressing
                      00071 ;   +-----------+--------------+-------------------+-----------------+
                      00072 ;   | CS0- CS1- |  DA2 DA1 DA0 | READ              | WRITE           |   
                      00073 ;   +-----------+--------------+-------------------+-----------------+
                      00074 ;   | 1    1    |  x   x   x   | data bush h.imped (validace prikazu)|
                      00075 ;   +-----------+--------------+-------------------+-----------------+
                      00076 ;   | 1    0    |  1   1   0   | alternate status  | device control  |
                      00077 ;   +-----------+--------------+-------------------+-----------------+
                      00078 ;   | 0    1    |  0   0   0   | data              | data            |
MPASM 03.90 Released                                  MP3.ASM   10-27-2005  22:54:11         PAGE  3


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00079 ;   | 0    1    |  0   0   1   | error             | features        |
                      00080 ;   | 0    1    |  0   1   0   |             sector count            |
                      00081 ;   | 0    1    |  0   1   1   |             LBA bits 0-7            |  sector number
                      00082 ;   | 0    1    |  1   0   0   |             LBA bits 8-15           |  cilinder LOW 
                      00083 ;   | 0    1    |  1   0   1   |             LBA bits 16-23          |  cilinder HIGH
                      00084 ;   | 0    1    |  1   1   0   |         device / LBA bits 24-27*    |  device, head
                      00085 ;   | 0    1    |  1   1   1   | status            | command         |
                      00086 ;   +-----------+--------------+-------------------+-----------------+
                      00087 ;   | 0    0    |  0   0   0   | invalid addres    | invalid addres  |
                      00088 ;   +-----------+--------------+-------------------+-----------------+
                      00089 ;
                      00090 ;   * 7 6 5 4   3     2     1     0 
                      00091 ;     1 L 1 DEV LBA27 LBA26 LBA25 LBA24
                      00092 ;  L=1 -> aresa je LBA , L=0 -> adresa je CHS
                      00093 ;  DEV=0 -> master , DEV=1 -> SLAVE
                      00094 ;
                      00095 ;  pokud disk podporuje LBA 48, tak je zadavani adresy trochu odlisne od LBA27
                      00096 ;**********************************************************
                      00097 ; toto jsou definice adres ATA registru. Staci udat jejich adresu na ATA_ADDRESS port a dat prikaz ke ct
                            eni ci zapisu (DIOR- / DIOW-)
  00000016            00098 D_STATUS_A    equ b'00010110'
  00000016            00099 D_DEVICE_C    equ D_STATUS_A
  00000020            00100 D_DATA_R      equ b'00100000'
  00000021            00101 D_FEATURES    equ b'00100001'
  00000021            00102 D_ERROR       equ D_FEATURES
  00000022            00103 D_SECTOR_C    equ b'00100010'
  00000023            00104 D_LBA1        equ b'00100011'   ; LBA low
  00000024            00105 D_LBA2        equ b'00100100'   ; LBA middle
  00000025            00106 D_LBA3        equ b'00100101'   ; LBA high
  00000026            00107 D_DEVICE      equ b'00100110'
  00000027            00108 D_STATUS      equ b'00100111'
  00000027            00109 D_COMMAND     equ D_STATUS
                      00110 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00111 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00112 ; DEFINICE PROMENNYCH
                      00113 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00114 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00115 ; MAPA PAMETI: (368 bytu)
                      00116 ;       BANK 0:         0x000 - 0x01F = specialni registry,
                      00117 ;                               0x020 - 0x07F = misto (96bytu) pro nase registry:
                      00118 ;                                       0x020 - 0x034 -> 21bytu pro registry a parametry HDD
                      00119 ;                                       0x035 - 0x03a -> 6bytu pro parametry podprogramu (musime zajisti
                            t, abychom nepouzivali registry, ktere pouzivaji i podprogramy!!!)
                      00120 ;                                       0x03B - 0x069 -> 50bytu rezervovano pro parametry oddilu, pozici
                             v mp3 a dalsi blbosti
                      00121 ;                               0x070 - 0x07F -> registry pro potreby preruseni (dostupne z kterekoliv b
                            anky)
                      00122 ;                                       0x070 - 0x071 -> 2registry slouzici k zalohovani W a STATUS
                      00123 ;                                       0x072 - 0x077 -> vlajka prikazu, ....
                      00124 ;                                       0x078 - 0x07F -> 8bytu obsahujici data prikazu prisla po USARTU
                      00125 ;
                      00126 ;       BANK 1:         0x080 - 0x09F = specialni registry,
                      00127 ;                               0x0A0 - 0x0EF = volne misto (80bytu)
                      00128 ;                                       0x0A0 - 0x0AC -> parametry a navratove hodnoty z aritmeto/logick
MPASM 03.90 Released                                  MP3.ASM   10-27-2005  22:54:11         PAGE  4


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                            ych podprogramu
                      00129 ;                                       0x0AD - 0x0EF -> 67bytu nepouzito
                      00130 ;
                      00131 ;       BANK 2:         0x100 - 0x10F = specialni registry,
                      00132 ;                               0x110 - 0x16F = misto (96bytu) pro nase registry:
                      00133 ;                                       0x110 - 0x14F -> 64bytu BUFFER_2 pro dlouhe nazvy souboru, tabul
                            ku oddilu, a treba pro cast fatky
                      00134 ;                                       0x150 - 0x16F -> 32bytu nepouzito
                      00135 ;
                      00136 ;       BANK 3:         0x180 - 0x18F = specialni registry,
                      00137 ;                               0x190 - 0x1EF = misto (96bytu) pro nase registry:
                      00138 ;                                       0x190 - 0x1CF -> 64bytu BUFFER_1 pro ruzna data pri cteni...
                      00139 ;                                       0x1D0 - 0x1EF -> 32 bytu nepouzito
                      00140 
                      00141 ; prectena ci zapisovana data
  00000020            00142 DATA_L                  equ 0x020 ; res 1
  00000021            00143 DATA_H                  equ 0x021
                      00144 ; HODNOTY ATA REGISTRU 
  00000022            00145 ATA_STATUS_A    equ 0x022
  00000023            00146 DEVICE_C                equ 0x023
  00000024            00147 FEATURES                equ 0x024
  00000025            00148 ATA_ERROR               equ 0x025
  00000026            00149 SECTOR_C                equ 0x026
  00000027            00150 LBA1                    equ 0x027       ; alias  SECTOR_N
  00000028            00151 LBA2                    equ 0x028       ; alias  CILINDER_L
  00000029            00152 LBA3                    equ 0x029       ; alias  CILINDER_H
  0000002A            00153 LBA4                    equ 0x02a       ; toto neni registr ATA, ale pouze posledni cast aktualni adresy
  0000002B            00154 DEVICE                  equ 0x02b       ; alias  DEVICE_H
  0000002C            00155 ATA_STATUS              equ 0x02c
  0000002D            00156 COMMAND                 equ 0x02d
                      00157 ;**********************************************************
                      00158 ; BITY ATA REGISTRU
                      00159          ; ATA_STATUS register
  00000007            00160 BSY                             equ 7   ; = 1 -> disk je zaneprazdneny, ostatni registry nemusi obsahova
                            t pravdivou informaci
  00000006            00161 DRDY                    equ 6   ; = 1 -> disk ready (pripraven k praci)
  00000003            00162 DRQ                             equ 3   ; = 1 -> signalizuje, ze jsou pripravena data ke cteni 
  00000000            00163 ERR                             equ 0   ; = 1 -> pri provadeni posledniho prikazu doslo k chybe
                      00164          ; ATA_ERROR register
  00000002            00165 ABRT                    equ 2   ; = 1 -> prikaz aborted (spatny optkode prikazu)
                      00166          ; DEVICE_C (control) register
  00000002            00167 SRST                    equ 2   ; nastavime-li, provedeme soft. reset disku
  00000001            00168 nEIN                    equ 1   ; zakazuje preruseni disku (signal INTRQ)
  00000007            00169 HOB                             equ 7   ; tento bit DEVICE CONTROL se nastavuje pouze pokud disk podporu
                            je LBA 48 a cteme horni cast adresy LBA...
                      00170 ;**********************************************************
  0000002E            00171 ATA_ATTRIBUTES  equ 0x02e       ; Parametry hardisku. 
                      00172 ;Bity maji nasledujici vyznam:
  00000000            00173 ATA_OK                  equ 0   ; 0. bit = 1 -> disk je pritomen, zapnuty a funkcni :-)
  00000001            00174 LBA_SUPPORT             equ 1   ; 1. bit = 1 -> podpora LBA (pokud neni nastaven bit2, tak pouze LBA28 -
                            > disk do 120GB)
  00000002            00175 LBA48_SUPPORT   equ 2   ; 2. bit = 1 -> podpora LBA 48 (disk je zrejme vetsi jak 120GB)
  00000003            00176 BIG_SECTOR              equ 3   ; 3. bit = 1 -> velikost sektoru je vetsi nez 256 !!! (s takovym diskem 
                            zatim tento program neumi)
MPASM 03.90 Released                                  MP3.ASM   10-27-2005  22:54:11         PAGE  5


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

  00000004            00177 FAT32_LOAD              equ 4   ; 4. bit = 1 -> FATka byla uspesne analyzovana a udaje o ni jsou pravdiv
                            e
                      00178                                                 ; 5. bit  -> nepouzit
                      00179                                                 ; 6. bit  -> nepouzit (tyto tri bity treba pouziju pro v
                            lastnosti FATky)
  00000007            00180 APPLICABLE              equ 7   ; 7. bit = 1 -> disk je pro nas pouzitelny (LBA, sektor o 512B)
                      00181 
                      00182 
  0000002F            00183 PARAM_MAX_LBA1  equ 0x02F               ; [4B] maximalni hodnota LBA (velikost disku)   
  00000030            00184 PARAM_MAX_LBA2  equ 0x030               ; tady pozor, disky mohou byt adresovany az LBA 48, MBR je ale o
                            mezen na LBA 32 (2TB)
  00000031            00185 PARAM_MAX_LBA3  equ 0x031               ; tak by nemelo smysl vsech 48b kdyz by se nevyuzily. (Navic jse
                            m disk vetsi nez 2TB nevidel :)
  00000032            00186 PARAM_MAX_LBA4  equ 0x032               ; (registr s indexem 1 ma nejnizsi vahu)
                      00187 
  00000033            00188 PARAM_SLOV_V_SEKTORU1   equ 0x33 ; [2B] disky mohou mit velikost sektoru vetsi nez 512 (256sl) 
  00000034            00189 PARAM_SLOV_V_SEKTORU2   equ 0x34 
                      00190 ; pokud je to zapsano takto, nejvyznamejsi bity jsou niz v paneti (PARAM_MAX_LBA + X)
                      00191 ; pokud je zapsano jako skupina LBA1, LBA2, LBA3, LBA4, tak nejvyznamejsi bity jsou v LBA4
                      00192 ;**********************************************************
                      00193 ; pomocne registry pouzivane v podprogramech 
                      00194 ; !!! MUSIME ZAJISTIT ABY NEBYLY POUZIVANY VE VNORENYCH PODPROGRAMECH !!!
  00000035            00195 TEMPW                   equ 0x035
  00000036            00196 TEMP1                   equ 0x036
  00000037            00197 TEMP2                   equ 0x037
  00000038            00198 TEMP3                   equ 0x038
  00000039            00199 TEMP4                   equ 0x039
  0000003A            00200 TEMP5                   equ 0x03A
                      00201 
                      00202 ; !!! pomocne promenne pro spozdovaci smycky jsou na stejnych mistech
                      00203 ; pouzito pro synchronizaci s prog. picdelay
  00000036            00204 TMP1                    equ 0x036
  00000037            00205 TMP2                    equ 0x037
  00000038            00206 TMP0                    equ 0x038
                      00207 ;**********************************************************
                      00208 ; registry pro raci s FATkou
  0000003B            00209 POZICE                  equ 0x03B               ; na ukladani aktualni pozice v slusteru, pripadne jine 
                            kokotiny
  0000003C            00210 CLUSTER1                equ 0x03C
  0000003D            00211 CLUSTER2                equ 0x03D
  0000003E            00212 CLUSTER3                equ 0x03E
  0000003F            00213 CLUSTER4                equ 0x03F
                      00214 
  00000040            00215 POCATEK_DAT1    equ 0x040
  00000041            00216 POCATEK_DAT2    equ 0x041
  00000042            00217 POCATEK_DAT3    equ 0x042
  00000043            00218 POCATEK_DAT4    equ 0x043
                      00219 
  00000044            00220 POCATEK_FAT1    equ 0x044
  00000045            00221 POCATEK_FAT2    equ 0x045
  00000046            00222 POCATEK_FAT3    equ 0x046
  00000047            00223 POCATEK_FAT4    equ 0x047
                      00224 
  00000048            00225 ROOT_DIR_CL1    equ 0x048
MPASM 03.90 Released                                  MP3.ASM   10-27-2005  22:54:11         PAGE  6


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

  00000049            00226 ROOT_DIR_CL2    equ 0x049
  0000004A            00227 ROOT_DIR_CL3    equ 0x04A
  0000004B            00228 ROOT_DIR_CL4    equ 0x04B
                      00229 
  0000003B            00230 CLUSTER_SIZE    equ 0x03B               ; velikost clusteru (pocet sektoru na claster)
                      00231 
                      00232 ;**********************************************************
                      00233 ; registry pro potreby preruseni (jsou totiz dostupne odkudkoliv)
  00000070            00234 TEMP_WORKING    equ 0x070
  00000071            00235 TEMP_STATUS             equ 0x071
  00000071            00236 PRIJATE_DATO    equ 0x071
                      00237 ;**********************************************************
                      00238 ; BANK_1        s touto bankou pracuji procedury provadejici 32 bitove 
                      00239 ;                       aritmeto/logicke operace
  000000A0            00240 OPERAND_X1              equ 0x0A0
  000000A1            00241 OPERAND_X2              equ 0x0A1
  000000A2            00242 OPERAND_X3              equ 0x0A2
  000000A3            00243 OPERAND_X4              equ 0x0A3
                      00244 
  000000A4            00245 OPERAND_Y1              equ 0x0A4
  000000A5            00246 OPERAND_Y2              equ 0x0A5
  000000A6            00247 OPERAND_Y3              equ 0x0A6
  000000A7            00248 OPERAND_Y4              equ 0x0A7
                      00249 
  000000A8            00250 VYSLEDEK1               equ 0x0A8
  000000A9            00251 VYSLEDEK2               equ 0x0A9
  000000AA            00252 VYSLEDEK3               equ 0x0AA
  000000AB            00253 VYSLEDEK4               equ 0x0AB
                      00254 
  000000AC            00255 PRETECENI               equ 0x0AC
                      00256 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00257 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00258 ; MAKRA
                      00259 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00260 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00261 BANK_0  macro                                   ; prepnuti do banky 0 v pameti dat
                      00262                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
                      00263                 bcf     STATUS,RP0    
                      00264                 endm
                      00265 BANK_1  macro                                   ; prepnuti do banky 1 v pameti dat
                      00266                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
                      00267                 bsf     STATUS,RP0    
                      00268                 endm
                      00269 BANK_2  macro                                   ; prepnuti do banky 2 v pameti dat
                      00270                 bsf     STATUS,RP1              ; BANK2  RP1:RP0 = 10
                      00271                 bcf     STATUS,RP0    
                      00272                 endm
                      00273 BANK_3  macro                                   ; prepnuti do banky 3 v pameti dat
                      00274                 bsf     STATUS,RP1              ; BANK3  RP1:RP0 = 11
                      00275                 bsf     STATUS,RP0    
                      00276                 endm
                      00277 ; INDF_BANK_x slouzi k prepinani bank pro neprime adresovani pomoci INDF a FSR
                      00278 INDF_BANK_0     macro               
                      00279                         bcf STATUS,IRP    
MPASM 03.90 Released                                  MP3.ASM   10-27-2005  22:54:11         PAGE  7


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00280                         endm
                      00281 INDF_BANK_1     macro               
                      00282                         bcf STATUS,IRP    
                      00283                         endm
                      00284 INDF_BANK_2     macro             
                      00285                         bsf STATUS,IRP    
                      00286                         endm
                      00287 INDF_BANK_3     macro             
                      00288                         bsf STATUS,IRP    
                      00289                         endm
                      00290 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00023 
                      00024 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00025 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00026 ; PROGRAM
                      00027 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00028 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
0000                  00029         org 0
0000   2C24           00030         goto START
0004                  00031         org     4
0004   2CB4           00032         goto INTERRUPT
                      00033 ;**********************************************************
                      00034 
                      00035         include "ata.asm"               ; podprogramy na ovladani ATA disku
                      00001 ;**********************************************************
                      00002 ;**********************************************************
                      00003 ;**********************************************************
                      00004 ; OBSLUZNE PODPROGRAMY PRO ATA
                      00005 ;**********************************************************
                      00006 ;**********************************************************
                      00007 ;**********************************************************
                      00008 
                      00009 ;**********************************************************
                      00010 ; cteni a zapis ATA registru 
                      00011 ;**********************************************************
0005                  00012 RD_STATUS         
0005   3027           00013         movlw D_STATUS      ; Status 
0006   2056           00014         call RUTR 
0007   00AC           00015         movwf ATA_STATUS
0008   0008           00016         return
                      00017 ;*****************************************
0009                  00018 RD_ERROR
0009   3021           00019         movlw D_ERROR      ; Error
000A   2056           00020         call RUTR
000B   00A5           00021         movwf ATA_ERROR
000C   0008           00022         return
                      00023 ;*****************************************
000D                  00024 RD_STATUS_A     
000D   3016           00025         movlw D_STATUS_A    ; Alternate Status 
000E   2056           00026         call RUTR 
000F   00A2           00027         movwf ATA_STATUS_A
0010   0008           00028         return
                      00029 ;*****************************************
0011                  00030 RD_SC
MPASM 03.90 Released                                  MP3.ASM   10-27-2005  22:54:11         PAGE  8


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0011   3022           00031         movlw D_SECTOR_C    ; Sector Count
0012   2056           00032         call RUTR
0013   00A6           00033         movwf SECTOR_C
0014   0008           00034         return
                      00035 ;*****************************************
0015                  00036 RD_LBA1
0015   3023           00037         movlw D_LBA1    ; Sector Number 
0016   2056           00038         call RUTR                
0017   00A7           00039         movwf LBA1 
0018   0008           00040         return
                      00041 ;*****************************************
0019                  00042 RD_LBA2
0019   3024           00043         movlw D_LBA2  ; Cylinder Low
001A   2056           00044         call RUTR
001B   00A8           00045         movwf LBA2
001C   0008           00046         return
                      00047 ;*****************************************
001D                  00048 RD_LBA3
001D   3025           00049         movlw D_LBA3  ; Cylinder High   
001E   2056           00050         call RUTR
001F   00A9           00051         movwf LBA3
0020   0008           00052         return
                      00053 ;*****************************************
0021                  00054 RD_DEVICE
0021   3026           00055         movlw D_DEVICE  ; Device Head
0022   2056           00056         call RUTR
0023   00AB           00057         movwf DEVICE
0024   0008           00058         return
                      00059 ;*****************************************
                      00060 ;*****************************************
0025                  00061 WR_DC
0025   0823           00062         movf DEVICE_C,w     ; Device Control
0026   00B5           00063         movwf TEMPW
0027   3016           00064         movlw D_DEVICE_C
0028   2063           00065         call RUTW
0029   0008           00066         return
                      00067 ;*****************************************
002A                  00068 WR_COMMAND          
002A   082D           00069         movf COMMAND,w      ; Command       
002B   00B5           00070         movwf TEMPW
002C   3027           00071         movlw D_COMMAND
002D   2063           00072         call RUTW
002E   0008           00073         return
                      00074 ;*****************************************
002F                  00075 WR_SC                    
002F   0826           00076     movf SECTOR_C,w     ; Sector Count
0030   00B5           00077         movwf TEMPW
0031   3022           00078         movlw D_SECTOR_C     
0032   2063           00079         call RUTW
0033   0008           00080         return
                      00081 ;*****************************************
0034                  00082 WR_LBA1
0034   0827           00083         movf LBA1,w     
0035   00B5           00084         movwf TEMPW
MPASM 03.90 Released                                  MP3.ASM   10-27-2005  22:54:11         PAGE  9


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0036   3023           00085         movlw D_LBA1    
0037   2063           00086         call RUTW
0038   0008           00087         return
                      00088 ;*****************************************
0039                  00089 WR_LBA2
0039   0828           00090         movf LBA2,w   ; Cylinder Low
003A   00B5           00091         movwf TEMPW
003B   3024           00092         movlw D_LBA2
003C   2063           00093         call RUTW
003D   0008           00094         return
                      00095 ;*****************************************
003E                  00096 WR_LBA3
003E   0829           00097         movf LBA3,w   ; Cylinder High
003F   00B5           00098         movwf TEMPW
0040   3025           00099         movlw D_LBA3
0041   2063           00100         call RUTW
0042   0008           00101         return
                      00102 ;*****************************************
0043                  00103 WR_DEVICE
0043   082B           00104         movf DEVICE,w     ; Device Head 
0044   00B5           00105         movwf TEMPW
0045   3026           00106         movlw D_DEVICE
0046   2063           00107         call RUTW
0047   0008           00108         return
                      00109 ;*****************************************
0048                  00110 WR_FEATURES
0048   0824           00111         movf FEATURES,w     ; Features
0049   00B5           00112         movwf TEMPW
004A   3021           00113         movlw D_FEATURES
004B   2063           00114         call RUTW
004C   0008           00115         return
                      00116 ;*****************************************
                      00117 ; zapise vsechny registry potrebne k vykonani prikazu (adresove registry a prikaz)
004D                  00118 WR_BLOCK
004D   215C           00119         call WAIT_FOR_READY_FOR_COMMAND
004E   2048           00120         call WR_FEATURES
004F   202F           00121         call WR_SC
0050   2034           00122         call WR_LBA1
0051   2039           00123         call WR_LBA2
0052   203E           00124         call WR_LBA3
0053   2043           00125         call WR_DEVICE
0054   202A           00126         call WR_COMMAND
0055   0008           00127         return
                      00128 ;*****************************************
                      00129 ; ve workingu mame adresu registru ktery mame precist, 
                      00130 ; pak v nem vracime jeho hodnotu...
0056                  00131 RUTR          
0056   0087           00132         movwf ATA_ADDRESS                  ; adresa pozadovaneho registru
                      00133 
                      00134         BANK_1
0057   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0058   1683               M                 bsf     STATUS,RP0    
0059   30FF           00135     movlw 0xFF
005A   0086           00136     movwf DATA_PORT_LOW_TRIS   ; z datove zbernice cteme
MPASM 03.90 Released                                  MP3.ASM   10-27-2005  22:54:11         PAGE 10


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

005B   0088           00137     movwf DATA_PORT_HIGH_TRIS
                      00138         BANK_0
005C   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
005D   1283               M                 bcf     STATUS,RP0    
                      00139 
005E   1109           00140         bcf ATA_DIOR_N
005F   0000           00141     nop                                                 ; PIO delay min. 120ns (PIO 4)  
0060   0806           00142     movfw DATA_PORT_LOW                 ; Read DD0..D7 IDE
0061   1509           00143         bsf ATA_DIOR_N
                      00144 
0062   0008           00145     return
                      00146 ;**********************************************************
                      00147 ; ve workingu mame adresu registru ktery mame zapsat,
                      00148 ; a v reg. TEMPW hodnotu kterou mame do tohoto registru zapsat
0063                  00149 RUTW
0063   0087           00150         movwf ATA_ADDRESS
                      00151 
                      00152         BANK_1
0064   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0065   1683               M                 bsf     STATUS,RP0    
0066   3000           00153     movlw 0x0
0067   0086           00154     movwf DATA_PORT_LOW_TRIS   ; do datove sbernice zapisujeme
0068   0088           00155     movwf DATA_PORT_HIGH_TRIS
                      00156         BANK_0
0069   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
006A   1283               M                 bcf     STATUS,RP0    
                      00157 
006B   0835           00158     movf TEMPW,w        
006C   0086           00159     movwf DATA_PORT_LOW                 ; Write DD0..DD7 IDE 
006D   0188           00160         clrf DATA_PORT_HIGH
                      00161 
006E   1089           00162         bcf ATA_DIOW_N
006F   0000           00163         nop
0070   1489           00164         bsf ATA_DIOW_N
                      00165           
                      00166         BANK_1
0071   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0072   1683               M                 bsf     STATUS,RP0    
0073   30FF           00167     movlw 0xff
0074   0086           00168     movwf DATA_PORT_LOW_TRIS   ; datova sbernice na cteni
0075   0088           00169     movwf DATA_PORT_HIGH_TRIS
                      00170         BANK_0
0076   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0077   1283               M                 bcf     STATUS,RP0    
                      00171 
0078   0008           00172         return
                      00173 ;**********************************************************
0079                  00174 READ_DATA
0079   214D           00175         call WAIT_FOR_DATA
                      00176 
007A   3020           00177     movlw D_DATA_R
007B   0087           00178         movwf ATA_ADDRESS
                      00179 
                      00180         BANK_1
MPASM 03.90 Released                                  MP3.ASM   10-27-2005  22:54:11         PAGE 11


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

007C   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
007D   1683               M                 bsf     STATUS,RP0    
007E   30FF           00181     movlw 0xFF
007F   0086           00182     movwf DATA_PORT_LOW_TRIS   ; z datove zbernice cteme
0080   0088           00183     movwf DATA_PORT_HIGH_TRIS
                      00184         BANK_0
0081   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0082   1283               M                 bcf     STATUS,RP0    
                      00185 
0083   1109           00186         bcf ATA_DIOR_N
0084   0000           00187     nop                                                 ; PIO delay min. 120ns (PIO 4)  
0085   0000           00188         nop
0086   0806           00189     movfw DATA_PORT_LOW                 ; Read DD0..D7 IDE
0087   00A0           00190         movwf DATA_L
0088   0808           00191     movfw DATA_PORT_HIGH                ; Read DD8..D15 IDE
0089   00A1           00192         movwf DATA_H
008A   1509           00193         bsf ATA_DIOR_N
                      00194 
008B   0008           00195     return
                      00196 ;**********************************************************
                      00197 ; stava se, ze obcas nas zajima jen cast vracenych dat, tak ty ktere nas nezajimaji, preskocime
                      00198 ; ocakava parametr v registru TEMP1 (kolik slov ma preskocit)
008C                  00199 PRESKOC
008C   2079           00200         call READ_DATA
008D   0BB6           00201         decfsz TEMP1,F
008E   288C           00202         goto PRESKOC
008F   0008           00203         return
                      00204 ;**********************************************************
                      00205 ; rekne disku na ze pristi instrukce, registry, data.... budou pro mastera
0090                  00206 SELECT_DEVICE
0090   30E0           00207         movlw b'11100000'       ; adresy budou v LBA, budeme pracovat s masterem
0091   00AB           00208         movwf DEVICE
0092   2043           00209         call WR_DEVICE
0093   0008           00210         return
                      00211 ;**********************************************************
0094                  00212 ZAPIS_DO_BUFFERU_1      ; buffer1 ma 64B a je v bance 3 na adrese 0x190 - 0x1CF
                      00213                                         ; jako parametr dostanem TEMP1, kde je pocet bytu k zapisu
                      00214                                         ; maximalni hodnota v TEMP1 muze byt 32 (1 slovo = 2 byty)
                      00215         INDF_BANK_3             ; neprime adresovani na banku 3
0094   1783               M                         bsf STATUS,IRP    
0095   3090           00216         movlw 0x90              ; adresa ja 190, devaty byt urcuje banku (0,1 / 2,3) fsr je tedy 90
0096   0084           00217         movwf FSR               
0097                  00218 ZAPIS_DO_BUFFERU_1__ZAPIS
0097   2079           00219         call READ_DATA
                      00220         
0098   0820           00221         movfw DATA_L
0099   0080           00222         movwf INDF
009A   0A84           00223         incf FSR,F
009B   0821           00224         movfw DATA_H
009C   0080           00225         movwf INDF
009D   0A84           00226         incf FSR,F
                      00227 
009E   0BB6           00228         decfsz TEMP1,F
009F   2897           00229         goto ZAPIS_DO_BUFFERU_1__ZAPIS
MPASM 03.90 Released                                  MP3.ASM   10-27-2005  22:54:11         PAGE 12


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00230 
                      00231         INDF_BANK_0     
00A0   1383               M                         bcf STATUS,IRP    
00A1   0008           00232         return
                      00233 ;**********************************************************
00A2                  00234 CLEAR_BUFFER2           ; BUFFER2 je 64bytu dat v bance 2 na adrese 0x110 - 0x14F
                      00235                                         ; pouziva TEMP1
00A2   3040           00236         movlw .64
00A3   00B6           00237         movwf TEMP1
                      00238         INDF_BANK_2             ; neprime adresovani na banku 2
00A4   1783               M                         bsf STATUS,IRP    
00A5   3010           00239         movlw 0x10
00A6   0084           00240         movwf FSR
00A7   3000           00241         movlw .0
                      00242 
00A8                  00243 CLEAR_BEFFER2__CLEAR
00A8   0080           00244         movwf INDF
00A9   0A84           00245         incf FSR,F
00AA   0BB6           00246         decfsz TEMP1,F
00AB   28A8           00247         goto CLEAR_BEFFER2__CLEAR
                      00248 
                      00249         INDF_BANK_0             ; neprime adresovani na banku 0
00AC   1383               M                         bcf STATUS,IRP    
00AD   0008           00250         return
                      00251 ;**********************************************************
00AE                  00252 ATA_RESET
                      00253         ; Resetuje disk zjisti, zda vubec nejaky disk je pripojen
00AE   01AE           00254         clrf ATA_ATTRIBUTES     ; registr obsahujici bity rikajici co disk umi
                      00255 
00AF   1009           00256         bcf ATA_RESET_N         ; resetujeme disk
00B0   2148           00257         call DELAY_25us         ; signal reset musi byt min. 25us
00B1   1409           00258         bsf ATA_RESET_N         ; koncime s resetem disku
                      00259 
00B2   2156           00260         call WAIT_FOR_READY     ; vynulujeme device bit v DEVICE registru (disk musi byt master!), ...
00B3   2090           00261         call SELECT_DEVICE      ; ...nastavime bit L - LBA addressing
                      00262 
00B4   2156           00263         call WAIT_FOR_READY
00B5   3002           00264         movlw b'00000010'       ; zakazeme preruseni (ted mam na mysli signal INTRQ z disku)
00B6   00A3           00265         movwf DEVICE_C          ; bit nIEN = 1 -> zakazeme preruseni disku (stejne nemame signal INTRQ p
                            ripojen)
00B7   2025           00266         call WR_DC                      ; zapiseme hodnotu do registru DEVICE CONTROL
                      00267 
00B8   30E0           00268         movlw b'11100000'       ; adresy budou v LBA, budeme pracovat s masterem
00B9   00AB           00269         movwf DEVICE
00BA   01A6           00270         clrf SECTOR_C
00BB   01A7           00271         clrf LBA1       
00BC   01A8           00272         clrf LBA2
00BD   01A9           00273         clrf LBA3
00BE   01A4           00274         clrf FEATURES
00BF   3000           00275         movlw h'00'                     ; code prikazu nop
00C0   00AD           00276         movwf COMMAND
00C1   204D           00277         call WR_BLOCK           ; ted provedeme prvni prikaz (nop) a podivame se co nam disk vrati
                      00278 
00C2   2156           00279         call WAIT_FOR_READY
MPASM 03.90 Released                                  MP3.ASM   10-27-2005  22:54:11         PAGE 13


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

00C3   2021           00280         call RD_DEVICE          ; Precteme reg. device. Pokud je disk OK, tak by nam mel vratit to, co j
                            sme do nej predtim zapsaly
00C4   082B           00281         movfw DEVICE
00C5   3CE0           00282         sublw b'11100000'
00C6   1903           00283         btfsc STATUS,Z          ; pokud DEVICE <> b'11100000', tak tu bud disk nemame, nebo je nejakej r
                            ozsypanej, nebo je spatne svicivanej (treba SLAVE)
00C7   142E           00284         bsf ATA_ATTRIBUTES,ATA_OK       ; 0. bit = 1 -> disk je pritomen, zapnuty a funkcni...
                      00285 
00C8   0008           00286         return          
                      00287 ;**********************************************************
00C9                  00288 READ_SECTOR
                      00289         ; Tento podprogram prevezme parametry SECTOR_C (kolik sec. mame precist)
                      00290         ; a LBA1 - LBA4, kde je ulozena LBA adresa sectoru od ktereho mame cist
                      00291         ; Postara se o spravne zadani adresy do disku (LBA28 / LBA48) a zavolani prikazu ke cteni...
                      00292         ; Samotne cteni se musi obslouzit v jine casti programu (podle toho co cteme...)
00C9   2156           00293         call WAIT_FOR_READY
00CA   2090           00294         call SELECT_DEVICE
00CB   215C           00295         call WAIT_FOR_READY_FOR_COMMAND
00CC   192E           00296         btfsc ATA_ATTRIBUTES,LBA48_SUPPORT
00CD   28DD           00297         goto READ_SECTOR_LBA48
                      00298 
00CE                  00299 READ_SECTOR_LBA27               ; zadavani adresy v LBA28 je celkem jednoduche, LBA bity 24-27 jsou obsa
                            zene v dolnich 4 bitech DEVICE reg.
00CE   01A4           00300         clrf FEATURES
00CF   2048           00301         call WR_FEATURES
00D0   202F           00302         call WR_SC
00D1   2034           00303         call WR_LBA1
00D2   2039           00304         call WR_LBA2
00D3   203E           00305         call WR_LBA3
00D4   082A           00306         movfw LBA4                      ; Z nejvyssi casti adresy...
00D5   390F           00307         andlw b'00001111'       ; ...pouzijeme pouze dolni 4bity...
00D6   38E0           00308         iorlw b'11100000'       ; ...horni 3bity nastavime (LBA adresovani, master)...
00D7   00AB           00309         movwf DEVICE            ; ...a zapiseme do DEVICE.
00D8   2043           00310         call WR_DEVICE
00D9   3020           00311         movlw 0x20                      ; Read sector. OPCODE - 20h (with retries) or 21h (without retri
                            es)
00DA   00AD           00312         movwf COMMAND           ; ...podle me to znamena ze prikaz 20h se bude pri neuspechu pokouset zn
                            ova o cteni....
00DB   202A           00313         call WR_COMMAND         ; ...protoze se v novejsich spicifacich jiz prikaz 21h nevyskytuje, pouz
                            ivam ke cteni 20h.
00DC   0008           00314         return
                      00315 
00DD                  00316 READ_SECTOR_LBA48
                      00317         ; !!! Pripominam ze to co zde pisu (o LBA48) vim ze specifikace ATA8, v praxi jsem LBA48 na zadn
                            em disku jeste nezkousel !!!
                      00318         ; Zadavani adresy pri LBA48 se o neco lisi nez LBA28. Do registru LBA 1,2,3 se data zadavaji 2x.
                             
                      00319         ; Prvi zadavani znamena horni cast adresy, druhe zadavani dolni cast adresy.
                      00320         ; Znova sem pisu ze v tomto programu vyuzijeme jen LBA o 32bitech (2TB) a ne celych LBA48
00DD   3000           00321         movlw .0
00DE   00B5           00322         movwf TEMPW
00DF   3022           00323         movlw D_SECTOR_C    ; vyssi cast parametru SECTOR_C = 0
00E0   2063           00324         call RUTW       
00E1   202F           00325         call WR_SC                      ; nizci cast parametru SECTOR_C
MPASM 03.90 Released                                  MP3.ASM   10-27-2005  22:54:11         PAGE 14


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00326 
00E2   3000           00327         movlw .0
00E3   00B5           00328         movwf TEMPW
00E4   3025           00329         movlw D_LBA3            ; LBA bity 47:40
00E5   2063           00330         call RUTW
00E6   3000           00331         movlw .0
00E7   00B5           00332         movwf TEMPW
00E8   3024           00333         movlw D_LBA2            ; LBA bity 39:32
00E9   2063           00334         call RUTW
00EA   082A           00335         movfw LBA4
00EB   00B5           00336         movwf TEMPW
00EC   3023           00337         movlw D_LBA1            ; LBA bity 31:24
00ED   2063           00338         call RUTW
                      00339 
00EE   203E           00340         call WR_LBA3            ; LBA bity 23:16
00EF   2039           00341         call WR_LBA2            ; LBA bity 15:8
00F0   2034           00342         call WR_LBA1            ; LBA bity  7:0
00F1   3024           00343         movlw h'24'                     ; pri LBA48 se musi pouzit tohoto prikazu ke cteni (READ SECTOR(
                            S) EXT - 24h, PIO data-in)
00F2   00AD           00344         movwf COMMAND
00F3   202A           00345         call WR_COMMAND
00F4   0008           00346         return
                      00347 ;**********************************************************
00F5                  00348 IDENTIFY_DEVICE
                      00349         ; ted uz vime, ze mame pripojen nejaky disk, tento podprogram provede prikaz 
                      00350         ; identify device a zjisti co je disk zac. Nektere dulezite informace ulozi 
                      00351         ; (nastavi byty v ATA_ATTRIBUTES) a jmenovku disku hodi do bufferu
                      00352 
                      00353         ; rekneme disku, ze s nim chcem pracovat (s masterem)
00F5   2156           00354         call WAIT_FOR_READY
00F6   2090           00355         call SELECT_DEVICE
                      00356         
                      00357         ; podivame se zda tu vubec disk je a co podporuje (LBA)
00F7   2156           00358         call WAIT_FOR_READY     ; celame nez bude disk opet ready pro dalsi prikazy
                      00359 
00F8   30E0           00360         movlw b'11100000'       ; adresy budou v LBA, budeme pracovat s masterem
00F9   00AB           00361         movwf DEVICE
00FA   01A6           00362         clrf SECTOR_C
00FB   01A7           00363         clrf LBA1       
00FC   01A8           00364         clrf LBA2
00FD   01A9           00365         clrf LBA3
00FE   01A4           00366         clrf FEATURES
00FF   30EC           00367         movlw 0xEC                      ; code prikazu IDENTIFY DEVICE
0100   00AD           00368         movwf COMMAND
0101   204D           00369         call WR_BLOCK
                      00370 
                      00371         ; pokud se neco nepodelalo, dostanem 256 16ti bitovych slov kde je napsano co disk umi a co je t
                            o zac...
                      00372         ; slova cisluji od nuly, (tzn. ze slov je 0-255)
0102   301B           00373         movlw .27               ; prvnich 27 slov je pro nas nepotrebnych
0103   00B6           00374         movwf TEMP1
0104   208C           00375         call PRESKOC
                      00376         
                      00377         ; [27-46] model mumber (ASCI retezec s nazvem disku)
MPASM 03.90 Released                                  MP3.ASM   10-27-2005  22:54:11         PAGE 15


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00378         ; tady precteme 20 slov a rovnou je odesleme do pric
                      00379                 ; pokud nekde od disku dostavame ASCII retezec jsou data nasledujici: 
                      00380                 ; pr. disk nam posila string Copyright
                      00381                 ;               1. DATA_H = 'C' 
                      00382                 ;               1. DATA_l = 'o'
                      00383                 ;               2. DATA_H = 'P' 
                      00384                 ;               2. DATA_l = 'y'
0105   3014           00385         movlw .20               ; dalsich 20 slov obsahuje 40 s ASCII znaku s nazvem disku
0106   00B6           00386         movwf TEMP1
0107   2094           00387         call ZAPIS_DO_BUFFERU_1
                      00388                 
                      00389         ; ted jsme uz precetli 47 slov z 256 :-)
0108   3002           00390         movlw .2                ; dalsi 2 slova jsou nam k nicemu
0109   00B6           00391         movwf TEMP1
010A   208C           00392         call PRESKOC
                      00393                 
010B   2079           00394         call READ_DATA  ; slovo 49 - capabilities (schopnosti)
                      00395                         ; 15:14 Reserved for the IDENTIFY PACKET DEVICE command.
                      00396                         ;    13 1 = Standby timer values as specified in this standard are supported
                      00397                         ;       0 = Standby timer values shall be managed by the device
                      00398                         ;    12 Reserved for the IDENTIFY PACKET DEVICE command.
                      00399                         ;    11 1 = IORDY supported
                      00400                         ;       0 = IORDY may be supported
                      00401                         ;    10 1 = IORDY may be disabled
                      00402                         ;     9 1 = LBA supported
                      00403                         ;     8 1 = DMA supported.
                      00404                         ;   7:0 Retired 
010C   18A1           00405         btfsc DATA_H,1  ;bit 9 = 1 -> LBA supported
010D   14AE           00406         bsf ATA_ATTRIBUTES,LBA_SUPPORT
                      00407 
                      00408         ;precetli jsme 50 slov
010E   300A           00409         movlw .10
010F   00B6           00410         movwf TEMP1
0110   208C           00411         call PRESKOC
                      00412         
0111   2079           00413         call READ_DATA  ; 60
0112   0820           00414         movfw DATA_L
0113   00AF           00415         movwf PARAM_MAX_LBA1            ; nejnizsi cast adresy
0114   0821           00416         movfw DATA_H
0115   00B0           00417         movwf PARAM_MAX_LBA2    
                      00418         
0116   2079           00419         call READ_DATA  ; 61
0117   0820           00420         movfw DATA_L
0118   00B1           00421         movwf PARAM_MAX_LBA3
0119   0821           00422         movfw DATA_H
011A   00B2           00423         movwf PARAM_MAX_LBA4            ; nejvyssi cast adresy
                      00424         
                      00425         ;precetli jsme 62 slov, zbyva 194
011B   3015           00426         movlw .21
011C   00B6           00427         movwf TEMP1
011D   208C           00428         call PRESKOC
                      00429 
                      00430         ; 83 slov, na rade je slovo 83 (pripominam ze slova jsou cislovana od nuly)
011E   2079           00431         call READ_DATA  ; 83 - command supported. Tady nas zajima bit 10 - 1 = 48-bit Address feature se
MPASM 03.90 Released                                  MP3.ASM   10-27-2005  22:54:11         PAGE 16


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                            t supported
011F   1921           00432         btfsc DATA_H,2  ; pokud disk umi LBA 48 pripiseme tuto skutecnost do ATA_ATTRIBUTES
0120   152E           00433         bsf ATA_ATTRIBUTES,LBA48_SUPPORT
                      00434 
                      00435         ;precetli jsme 84 slov
0121   3010           00436         movlw .16
0122   00B6           00437         movwf TEMP1
0123   208C           00438         call PRESKOC
                      00439                 
0124   1D2E           00440         btfss ATA_ATTRIBUTES,LBA48_SUPPORT
0125   2931           00441         goto INIT_ATA__NOT_SUPPORT_LBA48
                      00442                         ; pokud je podporovano LBA 48, nachazi se ve slovech [100-103] skutecny pocet se
                            ktoru 
                      00443                         ; do slov 60-61 by se sice vesel pocet sektoru u disku do 2TB, podle standardu s
                            e tam ale zapisuje pouze hodnota max pro LBA 28 (cca 120 GB)
                      00444                         ; mi precteme ale jen nejnizsi 2 slova, predpokladam totiz ze disk neni vetsi ja
                            k 2TB
0126   2079           00445                         call READ_DATA  ; 100
0127   0820           00446                         movfw DATA_L
0128   00AF           00447                         movwf PARAM_MAX_LBA1            ; nejnizsi cast adresy
0129   0821           00448                         movfw DATA_H
012A   00B0           00449                         movwf PARAM_MAX_LBA2    
                      00450 
012B   2079           00451                         call READ_DATA  ; 101
012C   0820           00452                         movfw DATA_L
012D   00B1           00453                         movwf PARAM_MAX_LBA3
012E   0821           00454                         movfw DATA_H
012F   00B2           00455                         movwf PARAM_MAX_LBA4            ; nejvyssi cast adresy                  
0130   2934           00456                 goto INIT_ATA__DALSI
0131                  00457 INIT_ATA__NOT_SUPPORT_LBA48
0131   3002           00458         movlw .2        ; 100, 101
0132   00B6           00459         movwf TEMP1
0133   208C           00460         call PRESKOC    
0134                  00461 INIT_ATA__DALSI
                      00462         ; precetli jsme 102 slov
0134   3004           00463         movlw .4        ; 102, 103, 104, 105
0135   00B6           00464         movwf TEMP1
0136   208C           00465         call PRESKOC
                      00466 
0137   2079           00467         call READ_DATA  ; slovo 106 - pokud bit 15=0 a bit 14=1, tak obsahuje pravdive informace
                      00468                                                 ; pro nas je podstatne, ze pokud je bit 12 = 1, tak sekt
                            or je vetsi nez 256 slov
                      00469                                                 ; pokud je sektor vetsi nez 256 slov, je jeho velikost v
                            e slovech [117-118]
0138   1BA1           00470         btfsc DATA_H,7
0139   293E           00471         goto INIT_ATA__DALSI2
013A   1F21           00472         btfss DATA_H,6
013B   293E           00473         goto INIT_ATA__DALSI2
013C   1A21           00474         btfsc DATA_H,4
013D   15AE           00475         bsf ATA_ATTRIBUTES,BIG_SECTOR
013E                  00476 INIT_ATA__DALSI2
                      00477         ; precteno 107, zbyva 149
013E   3095           00478         movlw .149      ; 107 - 256
013F   00B6           00479         movwf TEMP1
MPASM 03.90 Released                                  MP3.ASM   10-27-2005  22:54:11         PAGE 17


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0140   208C           00480         call PRESKOC
                      00481                 
                      00482         ; ted vime co mame za disk, tak se na to jdem podivat...
                      00483         ; pokud disk splnuje vsechny nase pozadavky, tak nastavime 7 bit v ATA_ATTRIBUTES
0141   13AE           00484         bcf ATA_ATTRIBUTES,APPLICABLE   
0142   1CAE           00485         btfss ATA_ATTRIBUTES,LBA_SUPPORT
0143   0008           00486         return
                      00487         ; pokud jsme tady, disk podporuje LBA (dneska se jich uz moc nevidi, co by LBA neumeli)
0144   19AE           00488         btfsc ATA_ATTRIBUTES,BIG_SECTOR
0145   0008           00489         return
                      00490         ; mazec, disk ma velikost sektoru 256 slov, vetsi naroky na disk nemam :-)
0146   17AE           00491         bsf ATA_ATTRIBUTES,APPLICABLE ; disk umi to co potrebujeme...   
                      00492 
0147   0008           00493         return
                      00494 ;**************************************************************************
                      00495 ;**********************************************************
                      00496 ; CEKACI PROCEDURY
                      00497 ;**********************************************************
0148                  00498 DELAY_25us
                      00499         ; pouziva TEMP1
                      00500         ; (Fosc = 20 MHz , instr. cyklus= 0.20 us) 25us / 0.20 us = 125 instrukcnich cyklu
                      00501         ; (Fosc = 16 MHz , instr. cyklus= 0.25 us) 25us / 0.25 us = 100 instrukcnich cyklu
                      00502         ; (Fosc = 04 MHz , instr. cyklus= 1.00 us) 25us / 1.00 us =  25 instrukcnich cyklu      
                      00503         ;MOVLW 0x2A  ;42 DEC -> Delay 127 cycles
0148   3021           00504         MOVLW 0x21   ;33 DEC -> Delay 100 cycles
                      00505         ;MOVLW 0x08  ;25 DEC -> Delay  25 cycles
0149   00B6           00506         MOVWF TEMP1
014A   0BB6           00507         DECFSZ TEMP1,F
014B   294A           00508         GOTO $-1
                      00509         ;End of Delay
014C   0008           00510         return
                      00511 ;**************************************************************************
014D                  00512 WAIT_FOR_DATA
                      00513         ; Wait: ( Bsy=0 AND Drq=1 ) OR err=1
                      00514         ; 7   6    5  4   3   2    1   0
                      00515         ; BSY DRDY DF DSC DRQ CORR IDX ERR
                      00516         ; (cekame az disk bude mit pro nas prichystana data)
014D   2156           00517         call WAIT_FOR_READY
014E   082C           00518         movfw ATA_STATUS
014F   3988           00519         andlw b'10001000'
0150   3C08           00520         sublw b'00001000'
0151   1903           00521         btfsc STATUS,Z
0152   0008           00522         return
0153   1C2C           00523         btfss ATA_STATUS,ERR
0154   294D           00524         goto WAIT_FOR_DATA
0155   0008           00525         return
                      00526 ;**************************************************************************
0156                  00527 WAIT_FOR_READY
                      00528         ; Cekame az Bsy bit = 0 
                      00529         ; (cekame az disk nebude zaneprazdnen)
0156   2005           00530         call RD_STATUS
0157   082C           00531         movfw ATA_STATUS
0158   3980           00532         andlw b'10000000'
0159   1903           00533         btfsc STATUS,Z
MPASM 03.90 Released                                  MP3.ASM   10-27-2005  22:54:11         PAGE 18


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

015A   0008           00534         return
015B   2956           00535         goto WAIT_FOR_READY
                      00536 ;**************************************************************************
015C                  00537 WAIT_FOR_READY_FOR_COMMAND
015C   2156           00538         call WAIT_FOR_READY
015D   1F2C           00539         btfss ATA_STATUS,DRDY
015E   295C           00540         goto WAIT_FOR_READY_FOR_COMMAND
015F   0008           00541         return
                      00542 ;**************************************************************************
                      00036         include "fat32.asm"     ; podprogramy na nacteni a praci s FAT32
                      00001 ;**********************************************************
                      00002 ;**********************************************************
                      00003 ;**********************************************************
                      00004 ; OBSLUZNE PODPROGRAMY PRO FAT32, HLEDANI ODDILU
                      00005 ;**********************************************************
                      00006 ;**********************************************************
                      00007 ;**********************************************************
                      00008 
                      00009 ;**************************************************************************
0160                  00010 SCAN_MBR
                      00011         ; Tato procedura ma na prvni pohled jednoduchy ukol, podiva se do MBR a do BUFFERU 2 hodi nasled
                            ujici data:
                      00012         ; 4 x 16 bytovy zaznam, kde kazdy zaznam reprezentuje jeden oddil se systemem FAT32
                      00013         ; struktura zaznamu je nasledujici:             1  byt (pokud = 0 tak v zaznamu neni zaznam o od
                            dilu, pokud = FFh , je zaznam o oddilu)
                      00014         ;                                                                               4  byty = adresa
                             kde se nachazi spousteci zaznam oddilu
                      00015         ;                                                                               11 bytu = jmenov
                            ka oddilu s FAT32 (neni dulezita, jen aby bylo co vypsat na display :-)
0160   20A2           00016         call CLEAR_BUFFER2
                      00017 
0161   01A7           00018         clrf LBA1
0162   01A8           00019         clrf LBA2
0163   01A9           00020         clrf LBA3
0164   01AA           00021         clrf LBA4                               ; jako prvni cteme MBR
                      00022 
0165   01BB           00023         clrf POZICE                             ; kolik zaznamu o oddilech uz bylo zapsano do bufferu2
0166                  00024 SCAN_BR                                         
                      00025         ; tady na tom navesti mame zadanou adresu MBR nebo BR nejakeho rozsireneho oddilu
0166   3001           00026         movlw .1
0167   00A6           00027         movwf SECTOR_C
0168   20C9           00028         call READ_SECTOR                ; cteme MBR nebo BR rozsireneho oddilu
                      00029 
0169   30DF           00030         movlw .223                              ; 223 slov = 446 bytu
016A   00B6           00031         movwf TEMP1
016B   208C           00032         call PRESKOC                    ; na prvnich 446 bytech MBR je zavadeci program systemu (samozre
                            jme, pokud na disku system je)
016C   3020           00033         movlw .32
016D   00B6           00034         movwf TEMP1
016E   2094           00035         call ZAPIS_DO_BUFFERU_1 ; do bufferu si dame vsechny zaznamy BR (16*4=64bytu / 32slov)
016F   3001           00036         movlw .1
0170   00B6           00037         movwf TEMP1
0171   208C           00038         call PRESKOC
                      00039         ; tak ted jsme precetli cely MBR/BR a zaznamy o jeho oddilech mame v BEFFERU 1, tak se jdem na n
MPASM 03.90 Released                                  MP3.ASM   10-27-2005  22:54:11         PAGE 19


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                            e podivat...
                      00040         
                      00041         ; Nejdriv si ale hodime aktualni LBA adresu do operandu Y pro aritmeticke operace
                      00042         INDF_BANK_1                             ; neprime adresovani na banku 1 (aritmeticke operace)
0172   1383               M                         bcf STATUS,IRP    
0173   30A4           00043         movlw 0xA4                              ; FSR na OPERAND_Y
0174   0084           00044         movwf FSR       
0175   0827           00045         movfw LBA1
0176   0080           00046         movwf INDF
0177   0A84           00047         incf FSR,F
0178   0828           00048         movfw LBA2
0179   0080           00049         movwf INDF
017A   0A84           00050         incf FSR,F
017B   0829           00051         movfw LBA3
017C   0080           00052         movwf INDF
017D   0A84           00053         incf FSR,F
017E   082A           00054         movfw LBA4
017F   0080           00055         movwf INDF
0180   0A84           00056         incf FSR,F
                      00057 
                      00058         INDF_BANK_3                             ; neprime adresovani na banku 3 (buffer 1)      
0181   1783               M                         bsf STATUS,IRP    
0182   3094           00059         movlw 0x94                              ; 90h (buffer1) + 4 (pozice kde je ulozen identifikator 
                            souboroveho systemu prvniho zaznamu BR)
0183   0084           00060         movwf FSR
0184   0800           00061         movfw INDF
0185   3C0B           00062         sublw h'0B'                             ; Pokud se FileSystem <> 0Bh...
0186   1D03           00063         btfss STATUS,Z
0187   3C01           00064         sublw .1                                ; ...nebo 0Ch...
0188   1D03           00065         btfss STATUS,Z
0189   29AF           00066         goto SCAN_MBR__HLEDEJ_ROZSIRENY_ODDIL   ; ...tak hledej rozsireny oddil.
                      00067 
                      00068         ; pokud jsme v teto casti programu, tak prvni zaznam MBR/BR obsahuje oddil FAT32, s reprezentaci
                             adres stylem LBA
                      00069         ; Tady pozor, v MBR/BR neni zapsana LBA adresa oddilu, ale relativni vzdalenost (offset) od MBR/
                            BR.
                      00070         ; To znamena, ze k adrese v (M)BR musime pricist offset oddilu.
                      00071         BANK_1
018A   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
018B   1683               M                 bsf     STATUS,RP0    
018C   3098           00072         movlw 0x98                              ; offset prvniho zaznamu 
018D   0084           00073         movwf FSR
018E   0800           00074         movfw INDF
018F   00A0           00075         movwf OPERAND_X1
0190   0A84           00076         incf FSR,F
0191   0800           00077         movfw INDF
0192   00A1           00078         movwf OPERAND_X2
0193   0A84           00079         incf FSR,F
0194   0800           00080         movfw INDF
0195   00A2           00081         movwf OPERAND_X3
0196   0A84           00082         incf FSR,F
0197   0800           00083         movfw INDF
0198   00A3           00084         movwf OPERAND_X4
                      00085         BANK_0
MPASM 03.90 Released                                  MP3.ASM   10-27-2005  22:54:11         PAGE 20


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0199   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
019A   1283               M                 bcf     STATUS,RP0    
                      00086 
019B   234F           00087         call SOUCET
                      00088 
                      00089         INDF_BANK_1                             ; neprime adresovani na banku 1 (aritmeticke operace)
019C   1383               M                         bcf STATUS,IRP    
019D   30A8           00090         movlw 0xA8                              ; FSR na VYSLEDEK
019E   0084           00091         movwf FSR       
019F   0800           00092         movfw INDF
01A0   00A7           00093         movwf LBA1
01A1   0A84           00094         incf FSR,F
01A2   0800           00095         movfw INDF
01A3   00A8           00096         movwf LBA2
01A4   0A84           00097         incf FSR,F
01A5   0800           00098         movfw INDF
01A6   00A9           00099         movwf LBA3
01A7   0A84           00100         incf FSR,F
01A8   0800           00101         movfw INDF
01A9   00AA           00102         movwf LBA4
01AA   0A84           00103         incf FSR,F
                      00104 
01AB   21DA           00105         call ZKONTROLUJ_ODDIL_FAT32     ; pokud skutecne adresa v LBA1-4 ukazuje na zacatek oddilu s FAT
                            32, tak da do bufferu2 jmenovku a adresu oddilu
                      00106         INDF_BANK_3
01AC   1783               M                         bsf STATUS,IRP    
01AD   30A4           00107         movlw 0xA4                                      ; 90h (buffer 1) + 16 (velikost 1. zaznamu) + 4 
                            (identifikator souboroveho systemu 2. zaznamu)
01AE   0084           00108         movwf FSR
01AF                  00109 SCAN_MBR__HLEDEJ_ROZSIRENY_ODDIL                ; jdem v zaznamech MBR/BR hledat rozsireny oddil
                      00110         ; pokud byl v prvnim zaznamu oddil typu FAT32, tak nam  tad FSR ukazuje na FileSystem 2. zaznamu
                            ...
                      00111         ; ...pokud 1. zaznam nebyl typu FAT32, tak nam FSR ukazuje na FileSystem 1. zaznamu.
                      00112         ; Kazdopadne se ted podivame na dalsi zaznam a pokud obsahuje rozsireny oddil, skocime na jeho a
                            dresu a dame goto SCAN_BR ...
01AF   0800           00113         movfw INDF
01B0   3C05           00114         sublw h'05'                             ; Pokud se FileSystem <> 05h (rozsireny oddil CHS)...
01B1   1D03           00115         btfss STATUS,Z
01B2   3C0A           00116         sublw h'0A'                             ; ...ani se <> 0Fh (5+A=F) (rozsireny oddil LBA)...
01B3   1D03           00117         btfss STATUS,Z
01B4   29D9           00118         goto SCAN_MBR__KONEC    ; ...tak koncime...
                      00119 
01B5   0804           00120         movfw FSR                               ; ...pokud tu ale mame rozsireny oddil,...
01B6   3E04           00121         addlw .4                                ; ...tak se jdem podivat na jeho adresu.
01B7   0084           00122         movwf FSR
                      00123 
                      00124         BANK_1
01B8   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
01B9   1683               M                 bsf     STATUS,RP0    
                      00125         INDF_BANK_3
01BA   1783               M                         bsf STATUS,IRP    
01BB   0800           00126         movfw INDF
01BC   00A0           00127         movwf OPERAND_X1
01BD   0A84           00128         incf FSR,F
MPASM 03.90 Released                                  MP3.ASM   10-27-2005  22:54:11         PAGE 21


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

01BE   0800           00129         movfw INDF
01BF   00A1           00130         movwf OPERAND_X2
01C0   0A84           00131         incf FSR,F
01C1   0800           00132         movfw INDF
01C2   00A2           00133         movwf OPERAND_X3
01C3   0A84           00134         incf FSR,F
01C4   0800           00135         movfw INDF
01C5   00A3           00136         movwf OPERAND_X4
                      00137         BANK_0
01C6   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
01C7   1283               M                 bcf     STATUS,RP0    
                      00138 
01C8   234F           00139         call SOUCET
                      00140 
                      00141         INDF_BANK_1                             ; neprime adresovani na banku 1 (aritmeticke operace)
01C9   1383               M                         bcf STATUS,IRP    
01CA   30A8           00142         movlw 0xA8                              ; FSR na VYSLEDEK
01CB   0084           00143         movwf FSR       
01CC   0800           00144         movfw INDF
01CD   00A7           00145         movwf LBA1
01CE   0A84           00146         incf FSR,F
01CF   0800           00147         movfw INDF
01D0   00A8           00148         movwf LBA2
01D1   0A84           00149         incf FSR,F
01D2   0800           00150         movfw INDF
01D3   00A9           00151         movwf LBA3
01D4   0A84           00152         incf FSR,F
01D5   0800           00153         movfw INDF
01D6   00AA           00154         movwf LBA4
01D7   0A84           00155         incf FSR,F
                      00156         
01D8   2966           00157         goto SCAN_BR                    ; S rozirenym oddilem provedeme totez co s MBR
01D9                  00158 SCAN_MBR__KONEC
01D9   0008           00159         return
                      00160 ;**************************************************************************
01DA                  00161 ZKONTROLUJ_ODDIL_FAT32
                      00162         ; tak ted bychom mely mit v LBA 1-4 adresu spousteciho zaznamu oddilu s FAT32, tak to jdem overi
                            t...
                      00163         ; ...a pokud tam doopravdy spousteci zaznam je, tak dame jmenovku a informace do bufferu 2 na po
                            zici jaka je v rag. POZICE
                      00164         INDF_BANK_2
01DA   1783               M                         bsf STATUS,IRP    
01DB   083B           00165         movfw POZICE
01DC   00B6           00166         movwf TEMP1
01DD   1003           00167         bcf STATUS,C
01DE   0DB6           00168         rlf TEMP1,F
01DF   0DB6           00169         rlf TEMP1,F
01E0   0DB6           00170         rlf TEMP1,F
01E1   0DB6           00171         rlf TEMP1,F                             ; TEMP1 := POZICE *16
01E2   0836           00172         movfw TEMP1
01E3   3E11           00173         addlw 0x11                              ; TEMP1 + pozice bufferu 2 + 1 (pozice kam budeme do buf
                            feru 2 davat adresu oddilu)
01E4   0084           00174         movwf FSR
                      00175 
MPASM 03.90 Released                                  MP3.ASM   10-27-2005  22:54:11         PAGE 22


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

01E5   0827           00176         movfw LBA1
01E6   0080           00177         movwf INDF
01E7   0A84           00178         incf FSR,F
01E8   0828           00179         movfw LBA2
01E9   0080           00180         movwf INDF
01EA   0A84           00181         incf FSR,F
01EB   0829           00182         movfw LBA3
01EC   0080           00183         movwf INDF
01ED   0A84           00184         incf FSR,F
01EE   082A           00185         movfw LBA4
01EF   0080           00186         movwf INDF
01F0   0A84           00187         incf FSR,F                              ; adresa oddilu je ulozena do bufferu 2, ted tam jdem da
                            vat jmenovku oddilu
                      00188 
01F1   3001           00189         movlw .1
01F2   00A6           00190         movwf SECTOR_C
01F3   20C9           00191         call READ_SECTOR
01F4   3023           00192         movlw h'23'
01F5   00B6           00193         movwf TEMP1
01F6   208C           00194         call PRESKOC                    ; informace o FATce co nas ted zrovna moc nezejimaji
                      00195         ; na offsetu 47 je ulozena jmenovka oddilu (11znaku), ted jsme na offsetu 46
                      00196 
01F7   2079           00197         call READ_DATA
01F8   0821           00198         movfw DATA_H
01F9   0080           00199         movwf INDF                              ; 1. znak ze jmenovky svazku
01FA   0A84           00200         incf FSR,F
                      00201 
01FB   3005           00202         movlw .5                                ; dalsich 10 bytu je zbytek jmenovky
01FC   00B6           00203         movwf TEMP1
01FD                  00204 ZKONTROLUJ_ODDIL_FAT32__JMENOVKA
01FD   2079           00205         call READ_DATA
01FE   0820           00206         movfw DATA_L
01FF   0080           00207         movwf INDF
0200   0A84           00208         incf FSR,F
0201   0821           00209         movfw DATA_H
0202   0080           00210         movwf INDF
0203   0A84           00211         incf FSR,F
0204   0BB6           00212         decfsz TEMP1,F
0205   29FD           00213         goto ZKONTROLUJ_ODDIL_FAT32__JMENOVKA
0206   3010           00214         movlw .16
0207   0284           00215         subwf FSR,F                                     ; aby fsr ukazoval na priznak o pravdivosti (FSR
                             := FSR - 16)
                      00216 
0208   2079           00217         call READ_DATA
0209   0820           00218         movfw DATA_L
020A   3C46           00219         sublw 'F'               
020B   1D03           00220         btfss STATUS,Z
020C   2A22           00221         goto ZKONTROLUJ_ODDIL_FAT32__KONEC
020D   0821           00222         movfw DATA_H
020E   3C41           00223         sublw 'A'               
020F   1D03           00224         btfss STATUS,Z
0210   2A22           00225         goto ZKONTROLUJ_ODDIL_FAT32__KONEC
                      00226 
0211   2079           00227         call READ_DATA
MPASM 03.90 Released                                  MP3.ASM   10-27-2005  22:54:11         PAGE 23


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0212   0820           00228         movfw DATA_L
0213   3C54           00229         sublw 'T'               
0214   1D03           00230         btfss STATUS,Z
0215   2A22           00231         goto ZKONTROLUJ_ODDIL_FAT32__KONEC
0216   0821           00232         movfw DATA_H
0217   3C33           00233         sublw '3'               
0218   1D03           00234         btfss STATUS,Z
0219   2A22           00235         goto ZKONTROLUJ_ODDIL_FAT32__KONEC
                      00236 
021A   2079           00237         call READ_DATA
021B   0820           00238         movfw DATA_L
021C   3C32           00239         sublw '2'
021D   1D03           00240         btfss STATUS,Z
021E   2A22           00241         goto ZKONTROLUJ_ODDIL_FAT32__KONEC
                      00242         ; tak, ted uz opravdu vime, ze na tomto sektoru se nachazi spousteci zaznam svazku se souborovym
                             systemem FAT32
                      00243 
021F   30FF           00244         movlw h'FF'
0220   0080           00245         movwf INDF
0221   0ABB           00246         incf POZICE,F                           ; sektor skutecne obsahoval spousteci zaznam svazku...
0222                  00247 ZKONTROLUJ_ODDIL_FAT32__KONEC
0222   0008           00248         return
                      00249 ;**************************************************************************
0223                  00250 NACTI_FAT32
                      00251         ; V LBA1-4 bychom meli dostat adresu prvniho sektoru FAT32 oddilu, kde by se mely nalezat inform
                            ace o fatce
                      00252         ; pokud je FATka pro nas pouzitelna (Clustery nejsou moc velke, sektor = 512B ...) nastavime bit
                             FAT32_LOAD v ATA_ATTRIBUTES
0223   122E           00253         bcf ATA_ATTRIBUTES,FAT32_LOAD
0224   01C0           00254         clrf POCATEK_DAT1
0225   01C1           00255         clrf POCATEK_DAT2
0226   01C2           00256         clrf POCATEK_DAT3
0227   01C3           00257         clrf POCATEK_DAT4
0228   01C4           00258         clrf POCATEK_FAT1
0229   01C5           00259         clrf POCATEK_FAT2
022A   01C6           00260         clrf POCATEK_FAT3
022B   01C7           00261         clrf POCATEK_FAT4
022C   01C8           00262         clrf ROOT_DIR_CL1
022D   01C9           00263         clrf ROOT_DIR_CL2
022E   01CA           00264         clrf ROOT_DIR_CL3
022F   01CB           00265         clrf ROOT_DIR_CL4
                      00266 
                      00267 
0230   01A4           00268         clrf FEATURES
0231   3001           00269         movlw .1
0232   00A6           00270         movwf SECTOR_C
0233   20C9           00271         call READ_SECTOR
                      00272 
0234   3005           00273         movlw .5
0235   00B6           00274         movwf TEMP1
0236   208C           00275         call PRESKOC
                      00276 
0237   2079           00277         call READ_DATA                          ; 10 bytu precteno
0238   0821           00278         movfw DATA_H                            ; 11,12 byte - velikost sektoru (tady by melo byt 512, a
MPASM 03.90 Released                                  MP3.ASM   10-27-2005  22:54:11         PAGE 24


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                            le co kdyby ne...)
0239   39FF           00279         andlw h'FF'
023A   1D03           00280         btfss STATUS,Z
023B   2AE6           00281         goto NACTI_FAT32__KONEC         ; pokud 11 byte neni nula, koncime (velikost sektoru se nerovna 
                            512)
                      00282 
023C   2079           00283         call READ_DATA                          ; ctu 12. a 13. byte
023D   0820           00284         movfw DATA_L
023E   3C02           00285         sublw h'02'
023F   1D03           00286         btfss STATUS,Z
0240   2AE6           00287         goto NACTI_FAT32__KONEC         ; pokud 12 byte neni 2, koncime (velikost sektoru se nerovna 512
                            )
                      00288 
0241   0821           00289         movfw DATA_H                            ; byte 13. SectorsPerCluster
0242   00BB           00290         movwf CLUSTER_SIZE
0243   3C20           00291         sublw .32                                       ; nas program neumi vic jak 32 (Velikost cluster
                            u = 16KB)
0244   1C03           00292         btfss STATUS,C
0245   2AE6           00293         goto NACTI_FAT32__KONEC         ; pokud mame clustery vetsi jak 16KB, tak koncime
                      00294 
0246   2079           00295         call READ_DATA                          ; ctu 14. a 15. byte
0247   0820           00296         movfw DATA_L
0248   00C4           00297         movwf POCATEK_FAT1                      ; tady se nachazi pocet rezervovanych sektoru, pak k ZAC
                            ATEK_FAT pricteme adresu zacatku sektoru a mame zacatek fat...
0249   0821           00298         movfw DATA_H
024A   00C5           00299         movwf POCATEK_FAT2
                      00300         
024B   2079           00301         call READ_DATA                          ; ctu 16. a 17. byte
024C   0820           00302         movfw DATA_L                            ; Pocet FAT. byva temer vzdy 2, kdyby ale ne, tak by nam
                             to delalo docela bordel...
024D   3C02           00303         sublw .2
024E   1D03           00304         btfss STATUS,Z
024F   2AE6           00305         goto NACTI_FAT32__KONEC
                      00306 
0250   3009           00307         movlw .9
0251   00B6           00308         movwf TEMP1
0252   208C           00309         call PRESKOC                            ; 18 - 35
                      00310 
0253   2079           00311         call READ_DATA                          ; 36,37 -> velikost FAT (pocet sektoru)
0254   0820           00312         movfw DATA_L
0255   00C0           00313         movwf POCATEK_DAT1
0256   0821           00314         movfw DATA_H
0257   00C1           00315         movwf POCATEK_DAT2      
0258   2079           00316         call READ_DATA                          ; 38,39 -> velikost FAT (pocet sektoru)
0259   0820           00317         movfw DATA_L
025A   00C2           00318         movwf POCATEK_DAT3
025B   0821           00319         movfw DATA_H
025C   00C3           00320         movwf POCATEK_DAT4
                      00321 
025D   2079           00322         call READ_DATA                          ; 40,41
025E   2079           00323         call READ_DATA                          ; 42,43
                      00324 
025F   2079           00325         call READ_DATA                          ; 44,45
0260   0820           00326         movfw DATA_L
MPASM 03.90 Released                                  MP3.ASM   10-27-2005  22:54:11         PAGE 25


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0261   00C8           00327         movwf ROOT_DIR_CL1
0262   0821           00328         movfw DATA_H
0263   00C9           00329         movwf ROOT_DIR_CL2
0264   2079           00330         call READ_DATA                          ; 46,47
0265   0820           00331         movfw DATA_L
0266   00CA           00332         movwf ROOT_DIR_CL3
0267   0821           00333         movfw DATA_H
0268   00CB           00334         movwf ROOT_DIR_CL4
                      00335 
0269   3011           00336         movlw .17
026A   00B6           00337         movwf TEMP1
026B   208C           00338         call PRESKOC                            ; 48 - 81
                      00339 
                      00340         ; ted jeste takova mala kontrola...
026C   2079           00341         call READ_DATA
026D   0820           00342         movfw DATA_L
026E   3C46           00343         sublw 'F'               
026F   1D03           00344         btfss STATUS,Z
0270   2AE6           00345         goto NACTI_FAT32__KONEC
0271   0821           00346         movfw DATA_H
0272   3C41           00347         sublw 'A'               
0273   1D03           00348         btfss STATUS,Z
0274   2AE6           00349         goto NACTI_FAT32__KONEC
0275   2079           00350         call READ_DATA
0276   0820           00351         movfw DATA_L
0277   3C54           00352         sublw 'T'               
0278   1D03           00353         btfss STATUS,Z
0279   2AE6           00354         goto NACTI_FAT32__KONEC
027A   0821           00355         movfw DATA_H
027B   3C33           00356         sublw '3'               
027C   1D03           00357         btfss STATUS,Z
027D   2AE6           00358         goto NACTI_FAT32__KONEC
027E   2079           00359         call READ_DATA
027F   0820           00360         movfw DATA_L
0280   3C32           00361         sublw '2'
0281   1D03           00362         btfss STATUS,Z
0282   2AE6           00363         goto NACTI_FAT32__KONEC
                      00364         ; tak, ted uz opravdu vime, ze na tomto sektoru se nachazi spousteci zaznam svazku se souborovym
                             systemem FAT32...
                      00365         ; tak ted jdem vypocitat ty nejdulezitejsi cisla pro praci s FATkou...
                      00366 
                      00367         INDF_BANK_1                                     ; aritmeto/logicke operace
0283   1383               M                         bcf STATUS,IRP    
0284   30A0           00368         movlw 0xA0                                      ; OPERAND_X
0285   0084           00369         movwf FSR
0286   0844           00370         movfw POCATEK_FAT1
0287   0080           00371         movwf INDF
0288   0A84           00372         incf FSR,F
0289   0845           00373         movfw POCATEK_FAT2
028A   0080           00374         movwf INDF
028B   0A84           00375         incf FSR,F
028C   0846           00376         movfw POCATEK_FAT3
028D   0080           00377         movwf INDF
028E   0A84           00378         incf FSR,F
MPASM 03.90 Released                                  MP3.ASM   10-27-2005  22:54:11         PAGE 26


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

028F   0847           00379         movfw POCATEK_FAT4
0290   0080           00380         movwf INDF
0291   0A84           00381         incf FSR,F
0292   0827           00382         movfw LBA1                                      ; OPERAND_Y
0293   0080           00383         movwf INDF
0294   0A84           00384         incf FSR,F
0295   0828           00385         movfw LBA2
0296   0080           00386         movwf INDF
0297   0A84           00387         incf FSR,F
0298   0829           00388         movfw LBA3
0299   0080           00389         movwf INDF
029A   0A84           00390         incf FSR,F
029B   082A           00391         movfw LBA4
029C   0080           00392         movwf INDF
029D   0A84           00393         incf FSR,F
029E   234F           00394         call SOUCET                                     ; pricteme k zacatku oddilu pocet rezervovanych 
                            sektoru (obvykle 32) a mame z toho POCATEK_FAT
029F   0800           00395         movfw INDF
02A0   00C4           00396         movwf POCATEK_FAT1
02A1   0A84           00397         incf FSR,F
02A2   0800           00398         movfw INDF
02A3   00C5           00399         movwf POCATEK_FAT2
02A4   0A84           00400         incf FSR,F
02A5   0800           00401         movfw INDF
02A6   00C6           00402         movwf POCATEK_FAT3
02A7   0A84           00403         incf FSR,F
02A8   0800           00404         movfw INDF
02A9   00C7           00405         movwf POCATEK_FAT4
02AA   0A84           00406         incf FSR,F
                      00407 
                      00408         ; v POCATEK_DAT ted mame hodnotu "velikost fat", tu vynasobime 2 a pricteme POCATEK_FAT. Tak zis
                            kame POCATEK_DAT
02AB   30A0           00409         movlw 0xA0                                      ; OPERAND_X
02AC   0084           00410         movwf FSR
02AD   0840           00411         movfw POCATEK_DAT1
02AE   0080           00412         movwf INDF
02AF   0A84           00413         incf FSR,F
02B0   0841           00414         movfw POCATEK_DAT2
02B1   0080           00415         movwf INDF
02B2   0A84           00416         incf FSR,F
02B3   0842           00417         movfw POCATEK_DAT3
02B4   0080           00418         movwf INDF
02B5   0A84           00419         incf FSR,F
02B6   0843           00420         movfw POCATEK_DAT4
02B7   0080           00421         movwf INDF
02B8   0A84           00422         incf FSR,F
02B9   23A7           00423         call POSUNDOLEVA_1                      ; X := X * 2 -> POCATEK_DAT := 2 * "velikost fat"
                      00424                                                                 ; ted jeste staci pricist POCATEK_FAT
02BA   0844           00425         movfw POCATEK_FAT1
02BB   0080           00426         movwf INDF
02BC   0A84           00427         incf FSR,F
02BD   0845           00428         movfw POCATEK_FAT2
02BE   0080           00429         movwf INDF
02BF   0A84           00430         incf FSR,F
MPASM 03.90 Released                                  MP3.ASM   10-27-2005  22:54:11         PAGE 27


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

02C0   0846           00431         movfw POCATEK_FAT3
02C1   0080           00432         movwf INDF
02C2   0A84           00433         incf FSR,F
02C3   0847           00434         movfw POCATEK_FAT4
02C4   0080           00435         movwf INDF
02C5   0A84           00436         incf FSR,F
02C6   234F           00437         call SOUCET
                      00438 
                      00439         ;   tady je pro me jedna zcela nepochopitelna vlastnost FATky, a to to, ze prvni dva zaznamy (nu
                            lty a prvni)
                      00440         ;   ve FAT tabulce jsou obsazeny nejakyma srotama (identifikator FATky), coz by nebylo to nejhor
                            si, ale data na disku
                      00441         ;   zacinaji jiz na nultym clusteru. (POCATEK_DAT) Dochazi tedy k tomu, ze nulty cluster na disk
                            u je reprezentovan na druhe
                      00442         ;   pozici ve fatce a to cislem dve!!! Od udaje ve fatce bychom musime tedy vzdy odecist hodnotu
                             2
                      00443         ;   a ziskali bychom skutecnou polohu dat na disku.... (Je to pekne na vyliz!!!!!!!!)
                      00444         ;   Ja to tady resim tak, ze zacatek dat posunu o 2 clustery niz (POCATEK_DAT := POCATEK_DAT - 2
                            *VELIKOST_CLUSTERU),
                      00445         ;   aby udaje souhlasily a my nemuseli nic prepocitavat. 
                      00446         ;   Pak tu nastava jeste jeden problem, ROOT adresar byva adresovan jako by byl na clusteru 0, p
                            roto pokazdy kdyz je 
                      00447         ;   nekde cislo clusteru 0, tak skocime na prvni cluster root adresare. (Vetsinou 2. cluster)
                      00448         ;   O tomto jevu jsem nikde necetl, ale proste to tak je. Z toho vyplyva, ze zadny soubor nemuze
                             byt na slusteru 1...
                      00449         
                      00450         ; Tak ted mame v POCATEK_DAT = POCATEK_FAT + (velikostFat * 2)
                      00451         ; a ted jeste musime odecist 2 * velikost_clusteru
                      00452 
02C7   0D3B           00453         rlf CLUSTER_SIZE,W              ; W := CLUSTER_SIZE * 2
                      00454         BANK_1
02C8   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
02C9   1683               M                 bsf     STATUS,RP0    
02CA   00A4           00455         movwf OPERAND_Y1
02CB   01A5           00456         clrf OPERAND_Y2
02CC   01A6           00457         clrf OPERAND_Y3
02CD   01A7           00458         clrf OPERAND_Y4
02CE   0828           00459         movfw VYSLEDEK1
02CF   00A0           00460         movwf OPERAND_X1
02D0   0829           00461         movfw VYSLEDEK2
02D1   00A1           00462         movwf OPERAND_X2
02D2   082A           00463         movfw VYSLEDEK3
02D3   00A2           00464         movwf OPERAND_X3
02D4   082B           00465         movfw VYSLEDEK4
02D5   00A3           00466         movwf OPERAND_X4
                      00467         BANK_0
02D6   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
02D7   1283               M                 bcf     STATUS,RP0    
02D8   2378           00468         call ROZDIL                             ; VYSLEDEK := POCATEK_FAT + (2 * velikostFat) - (2 * CLU
                            STER_SIZE)
02D9   0800           00469         movfw INDF
02DA   00C0           00470         movwf POCATEK_DAT1
02DB   0A84           00471         incf FSR,F
02DC   0800           00472         movfw INDF
MPASM 03.90 Released                                  MP3.ASM   10-27-2005  22:54:11         PAGE 28


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

02DD   00C1           00473         movwf POCATEK_DAT2
02DE   0A84           00474         incf FSR,F
02DF   0800           00475         movfw INDF
02E0   00C2           00476         movwf POCATEK_DAT3
02E1   0A84           00477         incf FSR,F
02E2   0800           00478         movfw INDF
02E3   00C3           00479         movwf POCATEK_DAT4
02E4   0A84           00480         incf FSR,F
                      00481         
                      00482         ; Tak ted uz to konecne mame, muzeme se pustit do prohlizeni adresaru a souboru...
                      00483 
02E5   162E           00484         bsf ATA_ATTRIBUTES,FAT32_LOAD   
02E6                  00485 NACTI_FAT32__KONEC
02E6   0008           00486         return  
                      00487 ;**************************************************************************
02E7                  00488 CLUSTER_TO_LBA
                      00489         ; vezme hodnoty v CLUSTER 1-4 a POZICE (sektor v clusteru) a do LBA 1-4 vypocita skutecnou pozic
                            i na disku
                      00490         ; pro spravnou funkci musi byt POZICE < CLUSTER_SIZE (POZICE muze byt v rozsahu 0 .. CLUSTER_SIZ
                            E - 1)
                      00491         ; LBA := POCATEK_DAT + (CLUSTER * CLUSTER_SIZE) + POZICE
                      00492         INDF_BANK_1                             ; neprime adresovani do banku1
02E7   1383               M                         bcf STATUS,IRP    
02E8   30A0           00493         movlw 0xA0                                      ; OPERAND_X
02E9   0084           00494         movwf FSR
02EA   083C           00495         movfw CLUSTER1
02EB   0080           00496         movwf INDF
02EC   0A84           00497         incf FSR,F
02ED   083D           00498         movfw CLUSTER2
02EE   0080           00499         movwf INDF
02EF   0A84           00500         incf FSR,F
02F0   083E           00501         movfw CLUSTER3
02F1   0080           00502         movwf INDF
02F2   0A84           00503         incf FSR,F
02F3   083F           00504         movfw CLUSTER4
02F4   0080           00505         movwf INDF
02F5   0A84           00506         incf FSR,F
                      00507 
                      00508         ; CLUSTER_SIZE je vzdy exponentem 2 (1,2,4,8,16,32), proto tento jednoduchy zapis
02F6   18BB           00509         btfsc CLUSTER_SIZE,1            ; 2
02F7   23A7           00510         call POSUNDOLEVA_1                      ; X := X * 2
02F8   193B           00511         btfsc CLUSTER_SIZE,2            ; 4
02F9   23AF           00512         call POSUNDOLEVA_2                      ; X := X * 4
02FA   19BB           00513         btfsc CLUSTER_SIZE,3            ; 8
02FB   23AF           00514         call POSUNDOLEVA_2                      ; X := X * 8
02FC   1A3B           00515         btfsc CLUSTER_SIZE,4            ; 16
02FD   23AF           00516         call POSUNDOLEVA_2                      ; X := X * 4
02FE   1ABB           00517         btfsc CLUSTER_SIZE,5            ; 32
02FF   23AF           00518         call POSUNDOLEVA_2                      ; X := X * 32
                      00519 
0300   0840           00520         movfw POCATEK_DAT1
0301   0080           00521         movwf INDF                                      ; OPERAND_Y
0302   0A84           00522         incf FSR,F
0303   0841           00523         movfw POCATEK_DAT2
MPASM 03.90 Released                                  MP3.ASM   10-27-2005  22:54:11         PAGE 29


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0304   0080           00524         movwf INDF
0305   0A84           00525         incf FSR,F
0306   0842           00526         movfw POCATEK_DAT3
0307   0080           00527         movwf INDF
0308   0A84           00528         incf FSR,F
0309   0843           00529         movfw POCATEK_DAT4
030A   0080           00530         movwf INDF
030B   0A84           00531         incf FSR,F
                      00532 
030C   234F           00533         call SOUCET                                     ; VYSLEDEK := POCATEK_DAT + (CLUSTER * CLUSTER_S
                            IZE)
                      00534 
                      00535         ; zbyva tedy k vysledku pricist POZICE a dat nasledny vysledek do LBA    
030D   083B           00536         movfw POZICE
                      00537         BANK_1
030E   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
030F   1683               M                 bsf     STATUS,RP0    
0310   00A4           00538         movwf OPERAND_Y1
0311   01A5           00539         clrf OPERAND_Y2
0312   01A6           00540         clrf OPERAND_Y3
0313   01A7           00541         clrf OPERAND_Y4
0314   0828           00542         movfw VYSLEDEK1
0315   00A0           00543         movwf OPERAND_X1
0316   0829           00544         movfw VYSLEDEK2
0317   00A1           00545         movwf OPERAND_X2
0318   082A           00546         movfw VYSLEDEK3
0319   00A2           00547         movwf OPERAND_X3
031A   082B           00548         movfw VYSLEDEK4
031B   00A3           00549         movwf OPERAND_X4        
                      00550         BANK_0
031C   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
031D   1283               M                 bcf     STATUS,RP0    
031E   234F           00551         call SOUCET
                      00552 
                      00553         INDF_BANK_1                             ; neprime adresovani do banku1
031F   1383               M                         bcf STATUS,IRP    
0320   30A8           00554         movlw 0xA8                                      ; VYSLEDEK
0321   0084           00555         movwf FSR
0322   0800           00556         movfw INDF
0323   00A7           00557         movwf LBA1
0324   0A84           00558         incf FSR,F
0325   0800           00559         movfw INDF
0326   00A8           00560         movwf LBA2
0327   0A84           00561         incf FSR,F
0328   0800           00562         movfw INDF
0329   00A9           00563         movwf LBA3
032A   0A84           00564         incf FSR,F
032B   0800           00565         movfw INDF
032C   00AA           00566         movwf LBA4
032D   0A84           00567         incf FSR,F
                      00568         
032E   0008           00569         return
                      00570 ;**************************************************************************
                      00037         include "vs1001.asm"    ; podprogramy na ovladani mp3 decoderu
MPASM 03.90 Released                                  MP3.ASM   10-27-2005  22:54:11         PAGE 30


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00001 ;**********************************************************
                      00002 ;**********************************************************
                      00003 ;**********************************************************
                      00004 ; OBSLUZNE PODPROGRAMY PRO MP3 DECODER vs1001g
                      00005 ;**********************************************************
                      00006 ;**********************************************************
                      00007 ;**********************************************************
                      00008 
                      00009 ; MP3_PORT              
                      00010 ; MP3_PORT_TRIS 
                      00011 
                      00012 ; BITY MP3_PORT
                      00013 ; #define MP3_SO                MP3_PORT,0      ; serial output - tady dostavame z dekoderu data
                      00014 ; #define MP3_SI                MP3_PORT,1      ; serial input  - pokud MP3_CS=1, tak posilame mp3 data,
                             pokud =0, tak posilame prikaz
                      00015 ; #define MP3_SCLK              MP3_PORT,2      ; clock - nabezna hrana urcuje platnost dat pri seriovem
                             prenosu
                      00016 ; #define MP3_CS                MP3_PORT,3      ; cable select  - pokud MP3_CS=1, tak po SI posilame mp3
                             data, pokud =0, tak posilame prikaz
                      00017 ; #define MP3_DREQ              MP3_PORT,4      ; data request  - pokud =1, tak dekoder pozaduje dalsi m
                            p3 data (vic jak 32B)
                      00018 ; #define MP3_BSYNC             MP3_PORT,5      ; pro synchronizaci - ma byt nastaven pri prvnim prenase
                            nem bitu kazdeho bytu
                      00019 
                      00020 ;**********************************************************
                      00021 ; do TEMP3 dame adresu registru 
                      00022 ; do TEMP4 dame dolni slabiku zapisovaneho slova
                      00023 ; do TEMP5 dame horni slabiku zapisovaneho slova
                      00024 
032F                  00025 MP3_SOFT_RESET  ; provede softwarovy reset dekoderu (pri zapnuti a pote po zkonceni kazde mp3)
032F   3000           00026         movlw .0        ; adr. reg. MODE
0330   00B8           00027         movwf TEMP3
0331   3004           00028         movlw b'00000100'       ; soft reset=1
0332   00B9           00029         movwf TEMP4
0333   3000           00030         movlw .0
0334   00BA           00031         movwf TEMP5
0335   2337           00032         call MP3_WR_REG
0336   0008           00033         return  
                      00034 ;**********************************************************
0337                  00035 MP3_WR_REG      ; zapise 16bitove slovo (temp4,temp5) do registru mp3 dekoderu
                      00036                         ; 16bit dato se odesila od nejvyssiho bitu (15,14...8,7...1,0)
                      00037                         ; kde TEMP5 = bity 15-8 ; TEMP4 = bity 7-0
                      00038 ; pri praci pouziva TEMP4, TEMP5, TEMPW
0337   1185           00039         bcf MP3_CS                      ; po SI posilame prikaz
0338   3002           00040         movlw b'00000010'       ; write
0339   2341           00041         call MP3_WR_BYTE        
033A   0838           00042         movfw TEMP3                     ; adresa zapisovvaneho registru
033B   2341           00043         call MP3_WR_BYTE
033C   083A           00044         movfw TEMP5             ; horni slabika
033D   2341           00045         call MP3_WR_BYTE
033E   0839           00046         movfw TEMP4             ; dolni slabika
033F   2341           00047         call MP3_WR_BYTE
0340   0008           00048         return
                      00049 ;**********************************************************
MPASM 03.90 Released                                  MP3.ASM   10-27-2005  22:54:11         PAGE 31


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00050 ; vodesle hodnotu ve W smerem k dekoderu
0341                  00051 MP3_WR_BYTE
0341   1685           00052         bsf MP3_BSYNC   ; bude nasledovat prvni bit bytu
0342   00B5           00053         movwf TEMPW
0343   3008           00054         movlw .8                
0344                  00055 MP3_WR_BYTE__1
0344   1105           00056                 bcf     MP3_SCLK
0345   1085           00057                 bcf MP3_SI
0346   0DB5           00058                 rlf TEMPW,f             ; odesilame od nejvyssiho bitu k nejnizsimu
0347   1803           00059                 btfsc STATUS,C  ;
0348   1485           00060                 bsf MP3_SI
0349   1505           00061                 bsf MP3_SCLK
034A   1285           00062                 bcf MP3_BSYNC
034B   0B00           00063                 DECFSZ W,W              
034C   2B44           00064                 goto MP3_WR_BYTE__1             
034D   1105           00065         bcf     MP3_SCLK
034E   0008           00066         return
                      00067 ;**********************************************************
                      00038         include "aritmetic.asm" ; podprogramy vykonavajici zakladni aritmetologicke operace
                      00001 ;**********************************************************
                      00002 ;**********************************************************
                      00003 ;**********************************************************
                      00004 ; Obsahuje podrogramy realizujici zakladni aritmeticke operace
                      00005 ; pouzivane v mp3 preprcavaci. Vsechny operace se provadi 
                      00006 ; s 32bitovymi cisly.
                      00007 ; 
                      00008 ; Pro praci aritmetickych procedur je rezervovana BANKA 1 !!!!!
                      00009 ;**********************************************************
                      00010 ;**********************************************************
                      00011 ;**********************************************************
034F                  00012 SOUCET
                      00013 ; provede soucet hodnoty v registrech OPERAND_X[1..4] 
                      00014 ; s hodnotou v OPERAND_Y[1..4] a umisti do VYSLEDEK[1..4] 
                      00015 ; pokud dojde k preteceni, nastavi se PRETECENI do 1
                      00016 ; (byty s indexem 1 maji nejnizsi vahu)
                      00017         BANK_1
034F   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0350   1683               M                 bsf     STATUS,RP0    
0351   01AC           00018         clrf PRETECENI
                      00019 
0352   0820           00020         movfw OPERAND_X1
0353   0724           00021         addwf OPERAND_Y1,W
0354   00A8           00022         movwf VYSLEDEK1
0355   1803           00023         btfsc STATUS,C
0356   14AC           00024                 bsf PRETECENI,1
                      00025 
0357   0821           00026         movfw OPERAND_X2
0358   0725           00027         addwf OPERAND_Y2,W
0359   00A9           00028         movwf VYSLEDEK2
035A   1803           00029         btfsc STATUS,C
035B   142C           00030                 bsf PRETECENI,0
035C   18AC           00031         btfsc PRETECENI,1
035D   0AA9           00032                 incf VYSLEDEK2,F
035E   1803           00033         btfsc STATUS,C
MPASM 03.90 Released                                  MP3.ASM   10-27-2005  22:54:11         PAGE 32


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

035F   142C           00034                 bsf PRETECENI,0
0360   10AC           00035         bcf PRETECENI,1
                      00036 
0361   0822           00037         movfw OPERAND_X3
0362   0726           00038         addwf OPERAND_Y3,W
0363   00AA           00039         movwf VYSLEDEK3
0364   1803           00040         btfsc STATUS,C
0365   14AC           00041                 bsf PRETECENI,1
0366   182C           00042         btfsc PRETECENI,0
0367   0AAA           00043                 incf VYSLEDEK3,F
0368   1803           00044         btfsc STATUS,C
0369   14AC           00045                 bsf PRETECENI,1
036A   102C           00046         bcf PRETECENI,0
                      00047 
036B   0823           00048         movfw OPERAND_X4
036C   0727           00049         addwf OPERAND_Y4,W
036D   00AB           00050         movwf VYSLEDEK4
036E   1803           00051         btfsc STATUS,C
036F   142C           00052                 bsf PRETECENI,0
0370   18AC           00053         btfsc PRETECENI,1
0371   0AAB           00054                 incf VYSLEDEK4,F
0372   1803           00055         btfsc STATUS,C
0373   142C           00056                 bsf PRETECENI,0
0374   10AC           00057         bcf PRETECENI,1 
                      00058 
                      00059         BANK_0
0375   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0376   1283               M                 bcf     STATUS,RP0    
0377   0008           00060         return
                      00061 ;**********************************************************
                      00062 ;**********************************************************
0378                  00063 ROZDIL  ; VYSLEDEK := X - Y
                      00064                 ; pri podteceni PRETECENI = 1 ( VYSLEDEK < 0 => PRETECENI = 1 )
                      00065         BANK_1
0378   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0379   1683               M                 bsf     STATUS,RP0    
037A   01AC           00066         clrf PRETECENI
                      00067 
037B   0824           00068         movfw OPERAND_Y1
037C   0220           00069         subwf OPERAND_X1,W      ; W = X - Y     
037D   00A8           00070         movwf VYSLEDEK1
037E   1C03           00071         btfss STATUS,C
037F   14AC           00072                 bsf PRETECENI,1
                      00073         
0380   0825           00074         movfw OPERAND_Y2
0381   0221           00075         subwf OPERAND_X2,W      ; W = X - Y     
0382   00A9           00076         movwf VYSLEDEK2
0383   1C03           00077         btfss STATUS,C
0384   142C           00078                 bsf PRETECENI,0
0385   18AC           00079         btfsc PRETECENI,1
0386   03A9           00080                 decf VYSLEDEK2,F
0387   1C03           00081         btfss STATUS,C
0388   142C           00082                 bsf PRETECENI,0
0389   10AC           00083         bcf PRETECENI,1 
MPASM 03.90 Released                                  MP3.ASM   10-27-2005  22:54:11         PAGE 33


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00084         
038A   0826           00085         movfw OPERAND_Y3
038B   0222           00086         subwf OPERAND_X3,W      ; W = X - Y     
038C   00AA           00087         movwf VYSLEDEK3
038D   1C03           00088         btfss STATUS,C
038E   14AC           00089                 bsf PRETECENI,1
038F   182C           00090         btfsc PRETECENI,0
0390   03AA           00091                 decf VYSLEDEK3,F
0391   1C03           00092         btfss STATUS,C
0392   14AC           00093                 bsf PRETECENI,1
0393   102C           00094         bcf PRETECENI,0
                      00095         
0394   0827           00096         movfw OPERAND_Y4
0395   0223           00097         subwf OPERAND_X4,W      ; W = X - Y     
0396   00AB           00098         movwf VYSLEDEK4
0397   1C03           00099         btfss STATUS,C
0398   142C           00100                 bsf PRETECENI,0
0399   18AC           00101         btfsc PRETECENI,1
039A   03AB           00102                 decf VYSLEDEK4,F
039B   1C03           00103         btfss STATUS,C
039C   142C           00104                 bsf PRETECENI,0
039D   10AC           00105         bcf PRETECENI,1 
                      00106         
                      00107         BANK_0
039E   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
039F   1283               M                 bcf     STATUS,RP0    
03A0   0008           00108         return
                      00109 ;**********************************************************
03A1                  00110 POSUNDOLEVA     ; X := (X * 2) mod 0xFFFFFFFF , PRETECENI := (X * 2) div 0xFFFFFFFF
                      00111                         ; tento podprogram nepouzivat, primo v hlavnim programu
                      00112                         ; musi se nastavit BANK_1 a vymazat PRETECENI!!!
                      00113                         ; (je pouze pro pouziti v nasobicich podprogramech)
                      00114                         ; pouzivat jen POSUNDOLEVA_1, 2, 3, 4 
03A1   0DA0           00115         rlf OPERAND_X1,F
03A2   0DA1           00116         rlf OPERAND_X2,F
03A3   0DA2           00117         rlf OPERAND_X3,F
03A4   0DA3           00118         rlf OPERAND_X4,F
03A5   0DAC           00119         rlf PRETECENI,F 
03A6   0008           00120         return
                      00121 ;**********************************************************
03A7                  00122 POSUNDOLEVA_1   ; X := X * 2
                      00123                                 ; X > 0xFFFF FFFF => PRETECENI obsahuje bity navic
                      00124         BANK_1
03A7   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
03A8   1683               M                 bsf     STATUS,RP0    
03A9   01AC           00125         clrf PRETECENI
03AA   1003           00126         bcf STATUS,C
                      00127         
03AB   23A1           00128         call POSUNDOLEVA
                      00129 
                      00130         BANK_0
03AC   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
03AD   1283               M                 bcf     STATUS,RP0    
03AE   0008           00131         return
MPASM 03.90 Released                                  MP3.ASM   10-27-2005  22:54:11         PAGE 34


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00132 ;**********************************************************
03AF                  00133 POSUNDOLEVA_2   ; X := X * 4
                      00134                                 ; X > 0xFFFF FFFF => PRETECENI obsahuje bity navic
                      00135         BANK_1
03AF   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
03B0   1683               M                 bsf     STATUS,RP0    
03B1   01AC           00136         clrf PRETECENI
03B2   1003           00137         bcf STATUS,C
                      00138         
03B3   23A1           00139         call POSUNDOLEVA
03B4   23A1           00140         call POSUNDOLEVA
                      00141 
                      00142         BANK_0
03B5   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
03B6   1283               M                 bcf     STATUS,RP0    
03B7   0008           00143         return
                      00144 ;**********************************************************
03B8                  00145 POSUNDOLEVA_3   ; X := X * 8
                      00146                                 ; X > 0xFFFF FFFF => PRETECENI obsahuje bity navic
                      00147         BANK_1
03B8   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
03B9   1683               M                 bsf     STATUS,RP0    
03BA   01AC           00148         clrf PRETECENI
03BB   1003           00149         bcf STATUS,C
                      00150         
03BC   23A1           00151         call POSUNDOLEVA
03BD   23A1           00152         call POSUNDOLEVA
03BE   23A1           00153         call POSUNDOLEVA
                      00154 
                      00155         BANK_0
03BF   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
03C0   1283               M                 bcf     STATUS,RP0    
03C1   0008           00156         return
                      00157 ;**********************************************************
03C2                  00158 POSUNDOLEVA_4   ; X := X * 16
                      00159                                 ; X > 0xFFFF FFFF => PRETECENI obsahuje bity navic
                      00160         BANK_1
03C2   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
03C3   1683               M                 bsf     STATUS,RP0    
03C4   01AC           00161         clrf PRETECENI
03C5   1003           00162         bcf STATUS,C
                      00163         
03C6   23A1           00164         call POSUNDOLEVA
03C7   23A1           00165         call POSUNDOLEVA
03C8   23A1           00166         call POSUNDOLEVA
03C9   23A1           00167         call POSUNDOLEVA
                      00168 
                      00169         BANK_0
03CA   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
03CB   1283               M                 bcf     STATUS,RP0    
03CC   0008           00170         return
                      00171 ;**********************************************************
03CD                  00172 POSUNDOLEVA_5   ; X := X * 32
                      00173                                 ; X > 0xFFFF FFFF => PRETECENI obsahuje bity navic
MPASM 03.90 Released                                  MP3.ASM   10-27-2005  22:54:11         PAGE 35


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00174         BANK_1
03CD   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
03CE   1683               M                 bsf     STATUS,RP0    
03CF   01AC           00175         clrf PRETECENI
03D0   1003           00176         bcf STATUS,C
                      00177         
03D1   23A1           00178         call POSUNDOLEVA
03D2   23A1           00179         call POSUNDOLEVA
03D3   23A1           00180         call POSUNDOLEVA
03D4   23A1           00181         call POSUNDOLEVA
03D5   23A1           00182         call POSUNDOLEVA
                      00183 
                      00184         BANK_0
03D6   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
03D7   1283               M                 bcf     STATUS,RP0    
03D8   0008           00185         return
                      00186 ;**********************************************************
03D9                  00187 POSUNDOPRAVA    ; X := X div 2 , PRETECENI := X mod 2
                      00188                         ; tento podprogram nepouzivat, primo v hlavnim programu
                      00189                         ; musi se nastavit BANK_1 a vymazat PRETECENI!!!
                      00190                         ; (je pouze pro pouziti v nasobicich podprogramech)
                      00191                         ; pouzivat jen POSUNDOPRAVA_1, 2, 3, 4 
03D9   0CA3           00192         rrf OPERAND_X4,F
03DA   0CA2           00193         rrf OPERAND_X3,F
03DB   0CA1           00194         rrf OPERAND_X2,F
03DC   0CA0           00195         rrf OPERAND_X1,F
03DD   0CAC           00196         rrf PRETECENI,F 
03DE   0008           00197         return
                      00198 ;**********************************************************
03DF                  00199 POSUNDOPRAVA_1  ; X := X div 2
                      00200                                 ; PRETECENI := X mod 2
                      00201         BANK_1
03DF   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
03E0   1683               M                 bsf     STATUS,RP0    
03E1   01AC           00202         clrf PRETECENI
03E2   1003           00203         bcf STATUS,C
                      00204         
03E3   23A1           00205         call POSUNDOLEVA
                      00206 
                      00207         BANK_0
03E4   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
03E5   1283               M                 bcf     STATUS,RP0    
03E6   0008           00208         return
                      00209 ;**********************************************************
03E7                  00210 POSUNDOPRAVA_2  ; X := X div 4
                      00211                                 ; PRETECENI := X mod 4
                      00212         BANK_1
03E7   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
03E8   1683               M                 bsf     STATUS,RP0    
03E9   01AC           00213         clrf PRETECENI
03EA   1003           00214         bcf STATUS,C
                      00215         
03EB   23A1           00216         call POSUNDOLEVA
03EC   23A1           00217         call POSUNDOLEVA
MPASM 03.90 Released                                  MP3.ASM   10-27-2005  22:54:11         PAGE 36


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00218 
                      00219         BANK_0
03ED   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
03EE   1283               M                 bcf     STATUS,RP0    
03EF   0008           00220         return
                      00221 ;**********************************************************
03F0                  00222 POSUNDOPRAVA_3  ; X := X div 8
                      00223                                 ; PRETECENI := X mod 8
                      00224         BANK_1
03F0   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
03F1   1683               M                 bsf     STATUS,RP0    
03F2   01AC           00225         clrf PRETECENI
03F3   1003           00226         bcf STATUS,C
                      00227         
03F4   23A1           00228         call POSUNDOLEVA
03F5   23A1           00229         call POSUNDOLEVA
03F6   23A1           00230         call POSUNDOLEVA
                      00231 
                      00232         BANK_0
03F7   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
03F8   1283               M                 bcf     STATUS,RP0    
03F9   0008           00233         return
                      00234 ;**********************************************************
03FA                  00235 POSUNDOPRAVA_4  ; X := X div 16
                      00236                                 ; PRETECENI := X mod 16
                      00237         BANK_1
03FA   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
03FB   1683               M                 bsf     STATUS,RP0    
03FC   01AC           00238         clrf PRETECENI
03FD   1003           00239         bcf STATUS,C
                      00240         
03FE   23A1           00241         call POSUNDOLEVA
03FF   23A1           00242         call POSUNDOLEVA
0400   23A1           00243         call POSUNDOLEVA
0401   23A1           00244         call POSUNDOLEVA
                      00245 
                      00246         BANK_0
0402   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0403   1283               M                 bcf     STATUS,RP0    
0404   0008           00247         return
                      00248 ;**********************************************************
0405                  00249 POSUNDOPRAVA_5  ; X := X div 32
                      00250                                 ; PRETECENI := X mod 32
                      00251         BANK_1
0405   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0406   1683               M                 bsf     STATUS,RP0    
0407   01AC           00252         clrf PRETECENI
0408   1003           00253         bcf STATUS,C
                      00254         
0409   23A1           00255         call POSUNDOLEVA
040A   23A1           00256         call POSUNDOLEVA
040B   23A1           00257         call POSUNDOLEVA
040C   23A1           00258         call POSUNDOLEVA
040D   23A1           00259         call POSUNDOLEVA
MPASM 03.90 Released                                  MP3.ASM   10-27-2005  22:54:11         PAGE 37


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00260 
                      00261         BANK_0
040E   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
040F   1283               M                 bcf     STATUS,RP0    
0410   0008           00262         return
                      00263 ;**********************************************************
0411                  00264 NULA    ; if (X =  0) then PRETECENI := 0
                      00265                 ; if (X <> 0) then PRETECENI := 1
                      00266                 ; obsah X zustane nezmenen
                      00267         BANK_1
0411   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0412   1683               M                 bsf     STATUS,RP0    
0413   01AC           00268         clrf PRETECENI
0414   30FF           00269         movlw h'FF'     
                      00270 
0415   05A0           00271         andwf OPERAND_X1,F
0416   1D03           00272         btfss STATUS,Z
0417   142C           00273                 bsf PRETECENI,0
0418   05A1           00274         andwf OPERAND_X2,F
0419   1D03           00275         btfss STATUS,Z
041A   142C           00276                 bsf PRETECENI,0
041B   05A2           00277         andwf OPERAND_X3,F
041C   1D03           00278         btfss STATUS,Z
041D   142C           00279                 bsf PRETECENI,0
041E   05A3           00280         andwf OPERAND_X4,F
041F   1D03           00281         btfss STATUS,Z
0420   142C           00282                 bsf PRETECENI,0         
                      00283 
                      00284         BANK_0
0421   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0422   1283               M                 bcf     STATUS,RP0    
0423   0008           00285         return
                      00286 ;**********************************************************
                      00039         ;include "pokusne.asm"
                      00040 
                      00041 ;**********************************************************
0424                  00042 START
0424   2462           00043         call INIT_CONFIG        ; nakonfiguruje preruseni, WDT, USART, pull ups...
0425   244F           00044         call INIT_PORT          ; nastavy trisy, a porty do vychozi polohy
                      00045 
0426   2148           00046         call DELAY_25us         ; chvili pockame, protoze napjeti zdroje co mam doma (stary PC-AT zdroj)
0427   2148           00047         call DELAY_25us         ; zezacatku dost kolisa...
0428   2148           00048         call DELAY_25us
                      00049 
0429   2484           00050         call POZDRAV
                      00051 
                      00052         ;call MP3_SOFT_RESET
042A   20AE           00053         call ATA_RESET                          ; resetujeme disk, koukneme zda tu nejakej mame
042B   1C2E           00054         btfss ATA_ATTRIBUTES,ATA_OK
                      00055         ;goto $-2                                       ;pokud neni pripojen disk, tak se jej pokousime 
                            neustale najit...
042C   0000           00056         nop
042D   24C4           00057         call DELAY_500ms
042E   20F5           00058         call IDENTIFY_DEVICE            ; koukneme co disk umi
MPASM 03.90 Released                                  MP3.ASM   10-27-2005  22:54:11         PAGE 38


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

042F   2497           00059         call ODESLI_MODEL_NUMBER        ; odesleme si jmeno disku 
                      00060 
0430   24C4           00061         call DELAY_500ms
0431   2160           00062         call SCAN_MBR                           ; najdeme oddily s FAT32 a jejich seznam dame do bufferu
                             2
0432   24A8           00063         call ODESLI_BUFFER2                     ; odesleme si seznam oddilu (FAT32) s adresami
                      00064 
0433   01AA           00065         clrf LBA4
0434   01A9           00066         clrf LBA3
0435   01A8           00067         clrf LBA2
0436   303F           00068         movlw .63
0437   00A7           00069         movwf LBA1                                      ; LBA adresa 1. oddilu
                      00070 
0438   24C4           00071         call DELAY_500ms
0439   2223           00072         call NACTI_FAT32                        ; nacte parametry zvoleneho oddilu
043A   01BF           00073         clrf CLUSTER4
043B   01BE           00074         clrf CLUSTER3
043C   01BD           00075         clrf CLUSTER2
043D   3002           00076         movlw .2
043E   00BC           00077         movwf CLUSTER1
043F   22E7           00078         call CLUSTER_TO_LBA                     ; zjistime skutecnou polohu dat na disku
0440   3001           00079         movlw 1
0441   00A6           00080         movwf SECTOR_C
0442   20C9           00081         call READ_SECTOR                        ; dame prikaz je precist
0443   30FF           00082         movlw .255
0444   00B6           00083         movwf TEMP1
0445   248F           00084         call ODESLI_DATA                        ; odesleme USARTem
                      00085 
0446                  00086 BIG_LOOP
0446   1587           00087         bsf ERROR_LED
0447   24C4           00088         call DELAY_500ms
                      00089 
0448   1187           00090         bcf ERROR_LED
0449   24C4           00091         call DELAY_500ms
                      00092         
044A   304F           00093         movlw 'O'
044B   247C           00094         call WR_USART
044C   304B           00095         movlw 'K'
044D   247C           00096         call WR_USART
                      00097 
044E   2C46           00098         goto BIG_LOOP
                      00099 ;**********************************************************
044F                  00100 INIT_PORT
                      00101         BANK_1
044F   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0450   1683               M                 bsf     STATUS,RP0    
                      00102 ;       movlw b'00100001'                       ; bity SO a DREQ jako vstupy z dekoderu
0451   30FF           00103         movlw 0xff
0452   0085           00104         movwf MP3_PORT_TRIS
0453   3000           00105         movlw b'00000000'                       ; adresovani disku jako vystupy, jen vstup pro USART
0454   0087           00106         movwf ATA_ADDRESS_TRIS          
0455   3000           00107         movlw .0
0456   0089           00108         movwf ATA_CONTROL_TRIS          ; ovladani disku jako vystupy
0457   30FF           00109         movlw 0xff
MPASM 03.90 Released                                  MP3.ASM   10-27-2005  22:54:11         PAGE 39


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0458   0086           00110         movwf DATA_PORT_LOW_TRIS        ; datovou sbernici jako vstupy
0459   0088           00111         movwf DATA_PORT_HIGH_TRIS       
                      00112         BANK_0
045A   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
045B   1283               M                 bcf     STATUS,RP0    
                      00113         
045C   3007           00114         movlw b'00000111'       ; signal reset-, diow- a dior- jsou aktivni v log. 0 !!!
045D   0089           00115         movwf ATA_CONTROL
045E   3037           00116         movlw b'00110111'       ; CS1-, CS0- = 1 => datova sbernice disku je odpojena
045F   0087           00117         movwf ATA_ADDRESS
0460   0185           00118         clrf MP3_PORT   
0461   0008           00119         return
                      00120 ;**********************************************************
0462                  00121 INIT_CONFIG     ; nakonfiguruje preruseni, WDT, USART, pull ups....
                      00122         BANK_1
0462   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0463   1683               M                 bsf     STATUS,RP0    
0464   30C7           00123         movlw b'11000111'       ; ...pull up a podobny koniny
                      00124                 ; PORTB Pull-up Enable bit              1 = pull up enabled
                      00125                 ; Interrupt Edge Select bit             1 = interrupt on rising edge of RB0/INT pin
                      00126                 ; TMR0 Clock Source Select bit  0 = Internal instruction cycle clock (CLKO)
                      00127                 ; TMR0 Source Edge Select bit   0 = Increment on low-to-high transition on RA4/T0CKI pin
                      00128                 ; Prescaler Assignment bit              0 = Prescaler is assigned to the Timer0 module
                      00129                 ; PS2:PS0: Prescaler Rate Select bits   111 = TMR0 Rate 1 : 256; WDT Rate 1 : 128
0465   0081           00130         movwf OPTION_REG
                      00131         
0466   3020           00132         movlw b'00100000'       ; povolime preruseni od USARTu (kdyz neco dostanem)
0467   008C           00133         movwf PIE1      
0468   3000           00134         movlw b'00000000'       ; ostatni vnejsi preruseni vymaskujeme
0469   008D           00135         movwf PIE2                      
046A   30C0           00136         movlw b'11000000'       ; povolime preruseni na vnejsi zarizeni (USART)                         
046B   008B           00137         movwf INTCON
                      00138 
046C   3026           00139         movlw b'00100110'       ;konfigurace USARTu (asynchronni, 8bit, bez parity, rychle - (BRGH = 1))
046D   0098           00140         movwf TXSTA
                      00141         BANK_0
046E   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
046F   1283               M                 bcf     STATUS,RP0    
0470   3090           00142         movlw b'10010000'       ;zapnu USART
0471   0098           00143         movwf RCSTA
                      00144         BANK_1
0472   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0473   1683               M                 bsf     STATUS,RP0    
                      00145         ;movlw .129             ; Fosc = 20 MHz, BRGH=1 => rychlost = 9615 bps
0474   3067           00146         movlw .103              ; Fosc = 16 MHz, BRGH=1 => rychlost = 9615 bps
0475   0099           00147         movwf SPBRG     
                      00148 
0476   3007           00149         movlw b'00000111'
0477   009F           00150         movwf ADCON1            ; vsechny vstupy (RA,RE) jako digitalni
                      00151         BANK_0  
0478   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0479   1283               M                 bcf     STATUS,RP0    
047A   019F           00152         clrf ADCON0             ; pro jistotu (vypneme A/D prevodniky)
                      00153 
MPASM 03.90 Released                                  MP3.ASM   10-27-2005  22:54:11         PAGE 40


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

047B   0008           00154         return
                      00155 ;**********************************************************
047C                  00156 WR_USART        ; odesle slovo ve workingu po ICSP
                      00157         BANK_1  
047C   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
047D   1683               M                 bsf     STATUS,RP0    
047E   1C98           00158         btfss TXSTA,1 
047F   2C7C           00159         goto WR_USART   ; cekame do chvile nez bude pripraven transmit buffer 
                      00160 
                      00161         BANK_0  
0480   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0481   1283               M                 bcf     STATUS,RP0    
0482   0099           00162         movwf TXREG
0483   0008           00163         return
                      00164 ;**********************************************************
                      00165 ; tento podprogram bude pro budouci praci zbytecny, je zde jen proto, abych na PC videl ze program byl s
                            pusten...
0484                  00166 POZDRAV  ; odesle po seriove lince pozdrav
0484   3041           00167         movlw 'A'       
0485   247C           00168         call WR_USART
0486   3068           00169         movlw 'h'
0487   247C           00170         call WR_USART
0488   306F           00171         movlw 'o'
0489   247C           00172         call WR_USART
048A   306A           00173         movlw 'j'
048B   247C           00174         call WR_USART
048C   3021           00175         movlw '!'
048D   247C           00176         call WR_USART
048E   0008           00177         return
                      00178 ;**********************************************************
                      00179 ; odesle data, ktera jdou z disku USARTEM. Pocet dat je v reg. TEMP1
048F                  00180 ODESLI_DATA
048F   2079           00181         call READ_DATA  
0490   0820           00182         movfw DATA_L
0491   247C           00183         call WR_USART
0492   0821           00184         movfw DATA_H
0493   247C           00185         call WR_USART   
0494   0BB6           00186         decfsz TEMP1,F
0495   2C8F           00187         goto ODESLI_DATA
0496   0008           00188         return
                      00189 ;**********************************************************
0497                  00190 ODESLI_MODEL_NUMBER     ; Podprogram IDENTIFY_DEVICE nam do bufferu 1 hodil jmeno disku
                      00191                         ; mi jej ted odesleme USARTem, aby mohl byt zobrazen na displeji
                      00192         INDF_BANK_3     ; BUFFER_1 je v bance 3
0497   1783               M                         bsf STATUS,IRP    
0498   3090           00193         movlw 0x90      ; na adrese 90
0499   0084           00194         movwf FSR
049A   3014           00195         movlw .20       ; budeme odesilat 20 slov (40 znaku)
049B   00B6           00196         movwf TEMP1
049C                  00197 ODESLI_MODEL_NUMBER_ODESILANI
049C   0800           00198         movfw INDF
049D   00B7           00199         movwf TEMP2     ; data do bufferu byla vkladana stylem DATA_L, DATA_H, DATA_L, DATA_H...
049E   0A84           00200         incf FSR,F      ; ASCII hodnoty jsou ale razeny stylem DATA_H, DATA_L, DATA_H, DATA_L...
049F   0800           00201         movfw INDF      ; proto to pisu tak slozite...
MPASM 03.90 Released                                  MP3.ASM   10-27-2005  22:54:11         PAGE 41


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

04A0   0A84           00202         incf FSR,F
                      00203         
04A1   247C           00204         call WR_USART
04A2   0837           00205         movfw TEMP2
04A3   247C           00206         call WR_USART   
                      00207 
04A4   0BB6           00208         decfsz TEMP1,F
04A5   2C9C           00209         goto ODESLI_MODEL_NUMBER_ODESILANI
                      00210 
                      00211         INDF_BANK_0     
04A6   1383               M                         bcf STATUS,IRP    
04A7   0008           00212         return
                      00213 ;**********************************************************
04A8                  00214 ODESLI_BUFFER2
                      00215         INDF_BANK_2     ; BUFFER_2 je v bance 2
04A8   1783               M                         bsf STATUS,IRP    
04A9   3010           00216         movlw 0x10      ; na adrese 10
04AA   0084           00217         movwf FSR
04AB   3040           00218         movlw .64       ; budeme odesilat 64 bytu
04AC   00B6           00219         movwf TEMP1
04AD                  00220 ODESLI_BUFFER2_ODESILANI
04AD   0800           00221         movfw INDF
04AE   247C           00222         call WR_USART
04AF   0A84           00223         incf FSR,F      
04B0   0BB6           00224         decfsz TEMP1,F
04B1   2CAD           00225         goto ODESLI_BUFFER2_ODESILANI
                      00226 
                      00227         INDF_BANK_0             
04B2   1383               M                         bcf STATUS,IRP    
04B3   0008           00228         return
                      00229 ;**********************************************************
04B4                  00230 INTERRUPT                                       ; sem se skace po zavolani preruseni...
04B4   00F0           00231         movwf TEMP_WORKING
04B5   0803           00232         movfw STATUS
04B6   00F1           00233         movwf TEMP_STATUS
                      00234         BANK_0
04B7   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
04B8   1283               M                 bcf     STATUS,RP0    
                      00235 
04B9   1E8C           00236         btfss PIR1,5                    ; Meli bychom mit povoleno sice jen jedno preruseni (od USARTU),
                             jeden ale nikdy nevi, proto ten test
04BA   2CC0           00237         goto END_OF_INTERRUPT   ; Pokud nejde o preruseni od USARTU, tak koncime...
04BB   081A           00238         movfw RCREG
04BC   1898           00239         btfsc RCSTA,1
04BD   2CC0           00240         goto END_OF_INTERRUPT
04BE   1918           00241         btfsc RCSTA,2
04BF   2CC0           00242         goto END_OF_INTERRUPT   ; Pokud nastala nejaka chyba pri prijimani data, tak na to s*r*m...
                      00243 
                      00244         ; Sem bychom se podle me meli dostat pri obdrzeni nejakeho slova po USARTU, moc to ale nefunguje
                            ...
                      00245         ; Budu muset zjistit, jestli to je hardwarem, ci softwarem...
                      00246 
04C0                  00247 END_OF_INTERRUPT                        ; sem skocime kdyz mame vsechny veci kolem preruseni vyrizeny
04C0   0871           00248         movfw TEMP_STATUS
MPASM 03.90 Released                                  MP3.ASM   10-27-2005  22:54:11         PAGE 42


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

04C1   0083           00249         movwf STATUS
04C2   0870           00250         movfw TEMP_WORKING
04C3   0009           00251         retfie
                      00252 ;**********************************************************
04C4                  00253 DELAY_500ms
                      00254 ; (Fosc = 16 MHz , instr. cyklus= 0.25 us) 500 000us / 0.25 us = 2 000 000 instrukcnich cyklu
                      00255 ;Variables: TMP2, TMP1, TMP0
                      00256 ;Delay 2000000 cycles
04C4   3047           00257         MOVLW 0x47  ;71 DEC
04C5   00B7           00258         MOVWF TMP2
04C6   302B           00259         MOVLW 0x2B  ;43 DEC
04C7   00B6           00260         MOVWF TMP1
04C8   30D9           00261         MOVLW 0x0D9  ;217 DEC
04C9   00B8           00262         MOVWF TMP0
04CA   0BB8           00263         DECFSZ TMP0,F
04CB   2CCA           00264         GOTO $-1
04CC   0BB6           00265         DECFSZ TMP1,F
04CD   2CC8           00266         GOTO $-5
04CE   0BB7           00267         DECFSZ TMP2,F
04CF   2CC6           00268         GOTO $-9
                      00269 ;End of Delay
04D0   0008           00270         return
                      00271 ;**********************************************************
                      00272         END
MPASM 03.90 Released                                  MP3.ASM   10-27-2005  22:54:11         PAGE 43


SYMBOL TABLE
  LABEL                             VALUE 

ABRT                              00000002
ACKDT                             00000005
ACKEN                             00000004
ACKSTAT                           00000006
ADCON0                            0000001F
ADCON1                            0000009F
ADCS0                             00000006
ADCS1                             00000007
ADDEN                             00000003
ADFM                              00000007
ADIE                              00000006
ADIF                              00000006
ADON                              00000000
ADRESH                            0000001E
ADRESL                            0000009E
APPLICABLE                        00000007
ATA_ADDRESS                       00000007
ATA_ADDRESS_TRIS                  00000087
ATA_ATTRIBUTES                    0000002E
ATA_CONTROL                       00000009
ATA_CONTROL_TRIS                  00000089
ATA_DIOR_N                        ATA_CONTROL,2
ATA_DIOW_N                        ATA_CONTROL,1
ATA_ERROR                         00000025
ATA_OK                            00000000
ATA_RESET                         000000AE
ATA_RESET_N                       ATA_CONTROL,0
ATA_STATUS                        0000002C
ATA_STATUS_A                      00000022
BANK_0                            
BANK_1                            
BANK_2                            
BANK_3                            
BCLIE                             00000003
BCLIF                             00000003
BF                                00000000
BIG_LOOP                          00000446
BIG_SECTOR                        00000003
BRGH                              00000002
BSY                               00000007
C                                 00000000
CCP1CON                           00000017
CCP1IE                            00000002
CCP1IF                            00000002
CCP1M0                            00000000
CCP1M1                            00000001
CCP1M2                            00000002
CCP1M3                            00000003
CCP1X                             00000005
CCP1Y                             00000004
CCP2CON                           0000001D
CCP2IE                            00000000
CCP2IF                            00000000
CCP2M0                            00000000
MPASM 03.90 Released                                  MP3.ASM   10-27-2005  22:54:11         PAGE 44


SYMBOL TABLE
  LABEL                             VALUE 

CCP2M1                            00000001
CCP2M2                            00000002
CCP2M3                            00000003
CCP2X                             00000005
CCP2Y                             00000004
CCPR1H                            00000016
CCPR1L                            00000015
CCPR2H                            0000001C
CCPR2L                            0000001B
CHS0                              00000003
CHS1                              00000004
CHS2                              00000005
CKE                               00000006
CKP                               00000004
CLEAR_BEFFER2__CLEAR              000000A8
CLEAR_BUFFER2                     000000A2
CLUSTER1                          0000003C
CLUSTER2                          0000003D
CLUSTER3                          0000003E
CLUSTER4                          0000003F
CLUSTER_SIZE                      0000003B
CLUSTER_TO_LBA                    000002E7
COMMAND                           0000002D
CREN                              00000004
CSRC                              00000007
D                                 00000005
DATA_ADDRESS                      00000005
DATA_H                            00000021
DATA_L                            00000020
DATA_PORT_HIGH                    00000008
DATA_PORT_HIGH_TRIS               00000088
DATA_PORT_LOW                     00000006
DATA_PORT_LOW_TRIS                00000086
DC                                00000001
DELAY_25us                        00000148
DELAY_500ms                       000004C4
DEVICE                            0000002B
DEVICE_C                          00000023
DRDY                              00000006
DRQ                               00000003
D_A                               00000005
D_COMMAND                         00000027
D_DATA_R                          00000020
D_DEVICE                          00000026
D_DEVICE_C                        00000016
D_ERROR                           00000021
D_FEATURES                        00000021
D_LBA1                            00000023
D_LBA2                            00000024
D_LBA3                            00000025
D_SECTOR_C                        00000022
D_STATUS                          00000027
D_STATUS_A                        00000016
EEADR                             0000010D
MPASM 03.90 Released                                  MP3.ASM   10-27-2005  22:54:11         PAGE 45


SYMBOL TABLE
  LABEL                             VALUE 

EEADRH                            0000010F
EECON1                            0000018C
EECON2                            0000018D
EEDATA                            0000010C
EEDATH                            0000010E
EEIE                              00000004
EEIF                              00000004
EEPGD                             00000007
END_OF_INTERRUPT                  000004C0
ERR                               00000000
ERROR_LED                         ATA_ADDRESS,3
F                                 00000001
FAT32_LOAD                        00000004
FEATURES                          00000024
FERR                              00000002
FSR                               00000004
GCEN                              00000007
GIE                               00000007
GO                                00000002
GO_DONE                           00000002
HOB                               00000007
I2C_DATA                          00000005
I2C_READ                          00000002
I2C_START                         00000003
I2C_STOP                          00000004
IBF                               00000007
IBOV                              00000005
IDENTIFY_DEVICE                   000000F5
INDF                              00000000
INDF_BANK_0                       
INDF_BANK_1                       
INDF_BANK_2                       
INDF_BANK_3                       
INIT_ATA__DALSI                   00000134
INIT_ATA__DALSI2                  0000013E
INIT_ATA__NOT_SUPPORT_LBA48       00000131
INIT_CONFIG                       00000462
INIT_PORT                         0000044F
INTCON                            0000000B
INTE                              00000004
INTEDG                            00000006
INTERRUPT                         000004B4
INTF                              00000001
IRP                               00000007
LBA1                              00000027
LBA2                              00000028
LBA3                              00000029
LBA4                              0000002A
LBA48_SUPPORT                     00000002
LBA_SUPPORT                       00000001
MP3_BSYNC                         MP3_PORT,5
MP3_CS                            MP3_PORT,3
MP3_DREQ                          MP3_PORT,4
MP3_PORT                          00000005
MPASM 03.90 Released                                  MP3.ASM   10-27-2005  22:54:11         PAGE 46


SYMBOL TABLE
  LABEL                             VALUE 

MP3_PORT_TRIS                     00000085
MP3_SCLK                          MP3_PORT,2
MP3_SI                            MP3_PORT,1
MP3_SO                            MP3_PORT,0
MP3_SOFT_RESET                    0000032F
MP3_WR_BYTE                       00000341
MP3_WR_BYTE__1                    00000344
MP3_WR_REG                        00000337
NACTI_FAT32                       00000223
NACTI_FAT32__KONEC                000002E6
NOT_A                             00000005
NOT_ADDRESS                       00000005
NOT_BO                            00000000
NOT_BOR                           00000000
NOT_DONE                          00000002
NOT_PD                            00000003
NOT_POR                           00000001
NOT_RBPU                          00000007
NOT_RC8                           00000006
NOT_T1SYNC                        00000002
NOT_TO                            00000004
NOT_TX8                           00000006
NOT_W                             00000002
NOT_WRITE                         00000002
NULA                              00000411
OBF                               00000006
ODESLI_BUFFER2                    000004A8
ODESLI_BUFFER2_ODESILANI          000004AD
ODESLI_DATA                       0000048F
ODESLI_MODEL_NUMBER               00000497
ODESLI_MODEL_NUMBER_ODESILANI     0000049C
OERR                              00000001
OPERAND_X1                        000000A0
OPERAND_X2                        000000A1
OPERAND_X3                        000000A2
OPERAND_X4                        000000A3
OPERAND_Y1                        000000A4
OPERAND_Y2                        000000A5
OPERAND_Y3                        000000A6
OPERAND_Y4                        000000A7
OPTION_REG                        00000081
P                                 00000004
PARAM_MAX_LBA1                    0000002F
PARAM_MAX_LBA2                    00000030
PARAM_MAX_LBA3                    00000031
PARAM_MAX_LBA4                    00000032
PARAM_SLOV_V_SEKTORU1             00000033
PARAM_SLOV_V_SEKTORU2             00000034
PCFG0                             00000000
PCFG1                             00000001
PCFG2                             00000002
PCFG3                             00000003
PCL                               00000002
PCLATH                            0000000A
MPASM 03.90 Released                                  MP3.ASM   10-27-2005  22:54:11         PAGE 47


SYMBOL TABLE
  LABEL                             VALUE 

PCON                              0000008E
PEIE                              00000006
PEN                               00000002
PIE1                              0000008C
PIE2                              0000008D
PIR1                              0000000C
PIR2                              0000000D
POCATEK_DAT1                      00000040
POCATEK_DAT2                      00000041
POCATEK_DAT3                      00000042
POCATEK_DAT4                      00000043
POCATEK_FAT1                      00000044
POCATEK_FAT2                      00000045
POCATEK_FAT3                      00000046
POCATEK_FAT4                      00000047
PORTA                             00000005
PORTB                             00000006
PORTC                             00000007
PORTD                             00000008
PORTE                             00000009
POSUNDOLEVA                       000003A1
POSUNDOLEVA_1                     000003A7
POSUNDOLEVA_2                     000003AF
POSUNDOLEVA_3                     000003B8
POSUNDOLEVA_4                     000003C2
POSUNDOLEVA_5                     000003CD
POSUNDOPRAVA                      000003D9
POSUNDOPRAVA_1                    000003DF
POSUNDOPRAVA_2                    000003E7
POSUNDOPRAVA_3                    000003F0
POSUNDOPRAVA_4                    000003FA
POSUNDOPRAVA_5                    00000405
POZDRAV                           00000484
POZICE                            0000003B
PR2                               00000092
PRESKOC                           0000008C
PRETECENI                         000000AC
PRIJATE_DATO                      00000071
PS0                               00000000
PS1                               00000001
PS2                               00000002
PSA                               00000003
PSPIE                             00000007
PSPIF                             00000007
PSPMODE                           00000004
R                                 00000002
RBIE                              00000003
RBIF                              00000000
RC8_9                             00000006
RC9                               00000006
RCD8                              00000000
RCEN                              00000003
RCIE                              00000005
RCIF                              00000005
MPASM 03.90 Released                                  MP3.ASM   10-27-2005  22:54:11         PAGE 48


SYMBOL TABLE
  LABEL                             VALUE 

RCREG                             0000001A
RCSTA                             00000018
RD                                00000000
RD_DEVICE                         00000021
RD_ERROR                          00000009
RD_LBA1                           00000015
RD_LBA2                           00000019
RD_LBA3                           0000001D
RD_SC                             00000011
RD_STATUS                         00000005
RD_STATUS_A                       0000000D
READ_DATA                         00000079
READ_SECTOR                       000000C9
READ_SECTOR_LBA27                 000000CE
READ_SECTOR_LBA48                 000000DD
READ_WRITE                        00000002
ROOT_DIR_CL1                      00000048
ROOT_DIR_CL2                      00000049
ROOT_DIR_CL3                      0000004A
ROOT_DIR_CL4                      0000004B
ROZDIL                            00000378
RP0                               00000005
RP1                               00000006
RSEN                              00000001
RUTR                              00000056
RUTW                              00000063
RX9                               00000006
RX9D                              00000000
R_W                               00000002
S                                 00000003
SCAN_BR                           00000166
SCAN_MBR                          00000160
SCAN_MBR__HLEDEJ_ROZSIRENY_ODDIL  000001AF
SCAN_MBR__KONEC                   000001D9
SECTOR_C                          00000026
SELECT_DEVICE                     00000090
SEN                               00000000
SMP                               00000007
SOUCET                            0000034F
SPBRG                             00000099
SPEN                              00000007
SREN                              00000005
SRST                              00000002
SSPADD                            00000093
SSPBUF                            00000013
SSPCON                            00000014
SSPCON2                           00000091
SSPEN                             00000005
SSPIE                             00000003
SSPIF                             00000003
SSPM0                             00000000
SSPM1                             00000001
SSPM2                             00000002
SSPM3                             00000003
MPASM 03.90 Released                                  MP3.ASM   10-27-2005  22:54:11         PAGE 49


SYMBOL TABLE
  LABEL                             VALUE 

SSPOV                             00000006
SSPSTAT                           00000094
START                             00000424
STATUS                            00000003
SYNC                              00000004
T0CS                              00000005
T0IE                              00000005
T0IF                              00000002
T0SE                              00000004
T1CKPS0                           00000004
T1CKPS1                           00000005
T1CON                             00000010
T1INSYNC                          00000002
T1OSCEN                           00000003
T1SYNC                            00000002
T2CKPS0                           00000000
T2CKPS1                           00000001
T2CON                             00000012
TEMP1                             00000036
TEMP2                             00000037
TEMP3                             00000038
TEMP4                             00000039
TEMP5                             0000003A
TEMPW                             00000035
TEMP_STATUS                       00000071
TEMP_WORKING                      00000070
TMP0                              00000038
TMP1                              00000036
TMP2                              00000037
TMR0                              00000001
TMR1CS                            00000001
TMR1H                             0000000F
TMR1IE                            00000000
TMR1IF                            00000000
TMR1L                             0000000E
TMR1ON                            00000000
TMR2                              00000011
TMR2IE                            00000001
TMR2IF                            00000001
TMR2ON                            00000002
TOUTPS0                           00000003
TOUTPS1                           00000004
TOUTPS2                           00000005
TOUTPS3                           00000006
TRISA                             00000085
TRISB                             00000086
TRISC                             00000087
TRISD                             00000088
TRISE                             00000089
TRISE0                            00000000
TRISE1                            00000001
TRISE2                            00000002
TRMT                              00000001
TX8_9                             00000006
MPASM 03.90 Released                                  MP3.ASM   10-27-2005  22:54:11         PAGE 50


SYMBOL TABLE
  LABEL                             VALUE 

TX9                               00000006
TX9D                              00000000
TXD8                              00000000
TXEN                              00000005
TXIE                              00000004
TXIF                              00000004
TXREG                             00000019
TXSTA                             00000098
UA                                00000001
VYSLEDEK1                         000000A8
VYSLEDEK2                         000000A9
VYSLEDEK3                         000000AA
VYSLEDEK4                         000000AB
W                                 00000000
WAIT_FOR_DATA                     0000014D
WAIT_FOR_READY                    00000156
WAIT_FOR_READY_FOR_COMMAND        0000015C
WCOL                              00000007
WR                                00000001
WREN                              00000002
WRERR                             00000003
WR_BLOCK                          0000004D
WR_COMMAND                        0000002A
WR_DC                             00000025
WR_DEVICE                         00000043
WR_FEATURES                       00000048
WR_LBA1                           00000034
WR_LBA2                           00000039
WR_LBA3                           0000003E
WR_SC                             0000002F
WR_USART                          0000047C
Z                                 00000002
ZAPIS_DO_BUFFERU_1                00000094
ZAPIS_DO_BUFFERU_1__ZAPIS         00000097
ZKONTROLUJ_ODDIL_FAT32            000001DA
ZKONTROLUJ_ODDIL_FAT32__JMENOVKA  000001FD
ZKONTROLUJ_ODDIL_FAT32__KONEC     00000222
_BODEN_OFF                        00003FBF
_BODEN_ON                         00003FFF
_CPD_OFF                          00003FFF
_CPD_ON                           00003EFF
_CP_ALL                           00000FCF
_CP_HALF                          00001FDF
_CP_OFF                           00003FFF
_CP_UPPER_256                     00002FEF
_DEBUG_OFF                        00003FFF
_DEBUG_ON                         000037FF
_HS_OSC                           00003FFE
_LP_OSC                           00003FFC
_LVP_OFF                          00003F7F
_LVP_ON                           00003FFF
_PWRTE_OFF                        00003FFF
_PWRTE_ON                         00003FF7
_RC_OSC                           00003FFF
MPASM 03.90 Released                                  MP3.ASM   10-27-2005  22:54:11         PAGE 51


SYMBOL TABLE
  LABEL                             VALUE 

_WDT_OFF                          00003FFB
_WDT_ON                           00003FFF
_WRT_ENABLE_OFF                   00003DFF
_WRT_ENABLE_ON                    00003FFF
_XT_OSC                           00003FFD
__16F877                          00000001
c                                 00000000
nEIN                              00000001


MEMORY USAGE MAP ('X' = Used,  '-' = Unused)

0000 : X---XXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0040 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0080 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
00C0 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0100 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0140 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0180 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
01C0 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0200 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0240 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0280 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
02C0 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0300 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0340 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0380 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
03C0 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0400 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0440 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0480 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
04C0 : XXXXXXXXXXXXXXXX X--------------- ---------------- ----------------
2000 : -------X-------- ---------------- ---------------- ----------------

All other memory blocks unused.

Program Memory Words Used:  1230
Program Memory Words Free:  6962


Errors   :     0
Warnings :     0 reported,     0 suppressed
Messages :     0 reported,   139 suppressed

