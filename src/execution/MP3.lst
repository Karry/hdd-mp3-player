MPASM 03.90 Released                                  MP3.ASM   12-16-2005  14:37:50         PAGE  1


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00001 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00002 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00003 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00004 ;  MP3 PREPRCAVAC
                      00005 ; ================
                      00006 ; 
                      00007 ; Program mp3 prehravace pouzivajici jako zdroj dat ATA disk.
                      00008 ; 
                      00009 ; Umi identifikovat disk, precist libovolny sektor, v MBR  najit oddily se systemem souboru FAT32, 
                      00010 ; nacist spousteci zaznam FAT32, praci s FAT32, prehravani mp3 pres vs1001 a komunikaci s vs1001.
                      00011 ;
                      00012 ;
                      00013 ; dodelat:
                      00014 ;       - po skonceni mp3 nacist dalsi mp3
                      00015 ;       - Nejak udelat aby soubory byly prehravany podle abecedy
                      00016 ;       - pak uz jen vychytavky...      (napr. do vs1001 naprogramovat ekvalizer a nejak ho ovladat...)
                      00017 ;
                      00018 ; srpen 2005 - rijen 2005 Karry - lukas.karas@centrum.cz
                      00019 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00020 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00021 
                      00022 
                      00023 ;**********************************************************
                      00024 ;   HLAVNI SOUBOR 
                      00025 ;**********************************************************
                      00026 ; !!!!!!!! VSECHNY CASOVE SMYCKY JSOU POCITANY NA Fosc=16MHz !!!!!
                      00027 ; !!!!!!!! NASTAVENI USARTu TAKY !!!!!!!
                      00028         LIST            p=PIC16f877,C=132,n=60
2007   3F3A           00029         __CONFIG        _WDT_OFF & _HS_OSC & _PWRTE_OFF & _BODEN_OFF & _LVP_OFF 
                      00030                         ; LVP_OFF = RB3 jako digitalni I/O
                      00031         errorlevel -302         ; vypnuti Message [302]: Register in operand not in bank 0.
                      00032                                                 ; ! zjednoduseni vypisu, ale riziko prehlednuti chyby
                      00033         #DEFINE VS1001 1        ; 1 = vs1001 pripojen, casti kodu pro vs1001 se prekladaji, ...
                      00034                                                 ; ...pokud 0 je pripojen pouze disk, na port se nic nepo
                            sila
                      00035 ;**********************************************************
                      00036 
                      00037         include "P16F877.inc"   ; definice blbosti kolem procesoru
                      00001         LIST
                      00002 ; P16F877.INC  Standard Header File, Version 1.00    Microchip Technology, Inc.
                      00373         LIST
                      00038         include "mp3.inc"               ; definice promennych, konstant a portu
                      00001 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00002 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00003 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00004 ; DEFINICE PORTU
                      00005 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00006 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00007 ;**********************************************************
                      00008 ; ZAPOJENI PORTU:
                      00009 ;       portA - MP3 dekoder vs1001g (alespon doufam ze sezenem tenhle typ, je totiz naprosto spickovej!!
                            !)
                      00010 ;                               5      4     3   2     1         0
                      00011 ;                               BSYNC  DREQ  CS  SCLK  SI/SDATA  SO
MPASM 03.90 Released                                  MP3.ASM   12-16-2005  14:37:50         PAGE  2


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00012 ;               portB - ATA datova sbernice (dolnich 8 bitu)
                      00013 ;               7   .. 0
                      00014 ;               DD7 .. DD0
                      00015 ;               portD - ATA datova sbernice (hornich 8 bitu)
                      00016 ;               15   .. 8
                      00017 ;               DD15 .. DD8 
                      00018 ;               portC - adresove signaly ATA, ERROR_LED, a USART
                      00019 ;                               7          6         5     4     3          2    1    0
                      00020 ;                               USART out  USART in  CS1-  CS0-  ERROR_LED  DA2  DA1  DA0  
                      00021 ;                               (signaly se znaminkem minus jsou aktivni v logicke 0 !!!)
                      00022 ;               portE - ridici signaly ATA
                      00023 ;                               2       1      0
                      00024 ;                               DIOR-   DIOW-  RESET-
                      00025 ;                               (signaly se znaminkem minus jsou aktivni v logicke 0 !!!)
                      00026 ;**********************************************************
  00000005            00027 MP3_PORT                equ PORTA
  00000085            00028 MP3_PORT_TRIS   equ TRISA
                      00029 ; BITY MP3_PORT
                      00030 #define MP3_SO          MP3_PORT,0      ; serial output - tady dostavame z dekoderu data
                      00031 #define MP3_SI          MP3_PORT,1      ; serial input  - pokud MP3_CS=1, tak posilame mp3 data, pokud =
                            0, tak posilame prikaz
                      00032 #define MP3_SCLK        MP3_PORT,2      ; clock - nabezna hrana urcuje platnost dat pri seriovem prenosu
                      00033 #define MP3_CS          MP3_PORT,3      ; cable select  - pokud MP3_CS=1, tak po SI posilame mp3 data, p
                            okud =0, tak posilame prikaz
                      00034 #define MP3_DREQ        MP3_PORT,4      ; data request  - pokud =1, tak dekoder pozaduje dalsi mp3 data
                      00035 #define MP3_BSYNC       MP3_PORT,5      ; pro synchronizaci - ma byt nastaven pri prvnim prenasenem bitu
                             kazdeho bytu
                      00036 ;**********************************************************
                      00037 ; pokud jsem dobre pochopil dataSheat dekoderu vs1001, tak staci do nej jen cpat data, a kdyz skonci mp3
                            , tak odeslat 1024 nulovych bytu,
                      00038 ; softwarove resetovat a posilat dalsi mp3...
                      00039 ;
                      00040 ; popis registru obvodu vs1001 najdete na strane 22 dataSheatu 
                      00041 ; v jeho registrech jsou k dispozici data z hlavicky mp3, zdali mp3 ma spravny format, 
                      00042 ; ovladani hlasitosti a dalsi spousty uzitecnych informaci
                      00043 ;**********************************************************
                      00044 ; PORTY DISKU
  00000007            00045 ATA_ADDRESS             equ PORTC
  00000009            00046 ATA_CONTROL             equ PORTE
  00000006            00047 DATA_PORT_LOW           equ PORTB
  00000008            00048 DATA_PORT_HIGH          equ PORTD
                      00049 
                      00050 
  00000087            00051 ATA_ADDRESS_TRIS        equ TRISC
  00000089            00052 ATA_CONTROL_TRIS        equ TRISE
  00000086            00053 DATA_PORT_LOW_TRIS      equ TRISB
  00000088            00054 DATA_PORT_HIGH_TRIS     equ TRISD
                      00055 
                      00056 ; bity ATA_ADDRESS portu
                      00057 #define ERROR_LED       ATA_ADDRESS,3
                      00058 ; bity ATA_CONTROL portu
                      00059 #define ATA_RESET_N     ATA_CONTROL,0
                      00060 #define ATA_DIOW_N      ATA_CONTROL,1
                      00061 #define ATA_DIOR_N      ATA_CONTROL,2
MPASM 03.90 Released                                  MP3.ASM   12-16-2005  14:37:50         PAGE  3


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00062 
                      00063 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00064 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00065 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00066 ; DEFINICE KONSTANT
                      00067 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00068 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00069 ; ADRESY ATA REGISTRU:
                      00070 ;                                                                       / CHS adressing
                      00071 ;   +-----------+--------------+-------------------+-----------------+
                      00072 ;   | CS0- CS1- |  DA2 DA1 DA0 | READ              | WRITE           |   
                      00073 ;   +-----------+--------------+-------------------+-----------------+
                      00074 ;   | 1    1    |  x   x   x   | data bush h.imped (validace prikazu)|
                      00075 ;   +-----------+--------------+-------------------+-----------------+
                      00076 ;   | 1    0    |  1   1   0   | alternate status  | device control  |
                      00077 ;   +-----------+--------------+-------------------+-----------------+
                      00078 ;   | 0    1    |  0   0   0   | data              | data            |
                      00079 ;   | 0    1    |  0   0   1   | error             | features        |
                      00080 ;   | 0    1    |  0   1   0   |             sector count            |
                      00081 ;   | 0    1    |  0   1   1   |             LBA bits 0-7            |  sector number
                      00082 ;   | 0    1    |  1   0   0   |             LBA bits 8-15           |  cilinder LOW 
                      00083 ;   | 0    1    |  1   0   1   |             LBA bits 16-23          |  cilinder HIGH
                      00084 ;   | 0    1    |  1   1   0   |         device / LBA bits 24-27*    |  device, head
                      00085 ;   | 0    1    |  1   1   1   | status            | command         |
                      00086 ;   +-----------+--------------+-------------------+-----------------+
                      00087 ;   | 0    0    |  0   0   0   | invalid addres    | invalid addres  |
                      00088 ;   +-----------+--------------+-------------------+-----------------+
                      00089 ;
                      00090 ;   * 7 6 5 4   3     2     1     0 
                      00091 ;     1 L 1 DEV LBA27 LBA26 LBA25 LBA24
                      00092 ;  L=1 -> aresa je LBA , L=0 -> adresa je CHS
                      00093 ;  DEV=0 -> master , DEV=1 -> SLAVE
                      00094 ;
                      00095 ;  pokud disk podporuje LBA 48, tak je zadavani adresy trochu odlisne od LBA27
                      00096 ;**********************************************************
                      00097 ; toto jsou definice adres ATA registru. Staci udat jejich adresu na ATA_ADDRESS port a dat prikaz ke ct
                            eni ci zapisu (DIOR- / DIOW-)
  00000016            00098 D_STATUS_A    equ b'00010110'
  00000016            00099 D_DEVICE_C    equ D_STATUS_A
  00000020            00100 D_DATA_R      equ b'00100000'
  00000021            00101 D_FEATURES    equ b'00100001'
  00000021            00102 D_ERROR       equ D_FEATURES
  00000022            00103 D_SECTOR_C    equ b'00100010'
  00000023            00104 D_LBA1        equ b'00100011'   ; LBA low
  00000024            00105 D_LBA2        equ b'00100100'   ; LBA middle
  00000025            00106 D_LBA3        equ b'00100101'   ; LBA high
  00000026            00107 D_DEVICE      equ b'00100110'
  00000027            00108 D_STATUS      equ b'00100111'
  00000027            00109 D_COMMAND     equ D_STATUS
                      00110 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00111 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00112 ; DEFINICE PROMENNYCH
                      00113 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00114 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
MPASM 03.90 Released                                  MP3.ASM   12-16-2005  14:37:50         PAGE  4


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00115 ; MAPA PAMETI: (368 bytu)
                      00116 ;       BANK 0:         0x000 - 0x01F = specialni registry,
                      00117 ;                               0x020 - 0x07F = misto (96bytu) pro nase registry:
                      00118 ;                                       0x020 - 0x034 -> 21bytu pro registry a parametry HDD
                      00119 ;                                       0x035 - 0x03a -> 6bytu pro parametry podprogramu (musime zajisti
                            t, abychom nepouzivali registry, ktere pouzivaji i podprogramy!!!)
                      00120 ;                                       0x03B - 0x04C -> parametry FATky 
                      00121 ;                                       0x04D - 0x050 -> registry pro praci s VS1001
                      00122 ;                                       0x051 - 0x052 -> 
                      00123 ;                                       0x060 - 0x06F -> informace potrebne pro prehravani
                      00124 ;                               0x070 - 0x07F -> registry pro potreby preruseni (dostupne z kterekoliv b
                            anky)
                      00125 ;                                       0x070 - 0x072 -> 3 registry slouzici k zalohovani W, STATUS, FSR
                      00126 ;                                       0x073 - 0x077 -> vlajka prikazu, ....
                      00127 ;                                       0x078 - 0x07F -> 8 bytu zasobniku prikazu (obsahujici data prika
                            zu prisla po USARTU)
                      00128 ;
                      00129 ;       BANK 1:         0x080 - 0x09F = specialni registry,
                      00130 ;                               0x0A0 - 0x0EF = volne misto (80bytu)
                      00131 ;                                       0x0A0 - 0x0AC -> parametry a navratove hodnoty z aritmeto/logick
                            ych podprogramu
                      00132 ;                                       0x0AD - 0x0EF -> 67bytu nepouzito
                      00133 ;
                      00134 ;       BANK 2:         0x100 - 0x10F = specialni registry,
                      00135 ;                               0x110 - 0x16F = misto (96bytu) pro nase registry:
                      00136 ;                                       0x110 - 0x14F -> 64bytu BUFFER_2 pro dlouhe nazvy souboru, tabul
                            ku oddilu, a treba pro cast fatky
                      00137 ;                                       0x150 - 0x16F -> 32bytu nepouzito
                      00138 ;
                      00139 ;       BANK 3:         0x180 - 0x18F = specialni registry,
                      00140 ;                               0x190 - 0x1EF = misto (96bytu) pro nase registry:
                      00141 ;                                       0x190 - 0x1CF -> 64bytu BUFFER_1 pro ruzna data pri cteni...
                      00142 ;                                       0x1D0 - 0x1EF -> 32 bytu nepouzito
                      00143 
                      00144 ; prectena ci zapisovana data
  00000020            00145 DATA_L                  equ 0x020 ; res 1
  00000021            00146 DATA_H                  equ 0x021
                      00147 ; HODNOTY ATA REGISTRU 
  00000022            00148 ATA_STATUS_A    equ 0x022
  00000023            00149 DEVICE_C                equ 0x023
  00000024            00150 FEATURES                equ 0x024
  00000025            00151 ATA_ERROR               equ 0x025
  00000026            00152 SECTOR_C                equ 0x026
  00000027            00153 LBA1                    equ 0x027       ; alias  SECTOR_N
  00000028            00154 LBA2                    equ 0x028       ; alias  CILINDER_L
  00000029            00155 LBA3                    equ 0x029       ; alias  CILINDER_H
  0000002A            00156 LBA4                    equ 0x02a       ; toto neni registr ATA, ale pouze posledni cast aktualni adresy
  0000002B            00157 DEVICE                  equ 0x02b       ; alias  DEVICE_H
  0000002C            00158 ATA_STATUS              equ 0x02c
  0000002D            00159 COMMAND                 equ 0x02d
                      00160 ;**********************************************************
                      00161 ; BITY ATA REGISTRU
                      00162          ; ATA_STATUS register
  00000007            00163 BSY                             equ 7   ; = 1 -> disk je zaneprazdneny, ostatni registry nemusi obsahova
MPASM 03.90 Released                                  MP3.ASM   12-16-2005  14:37:50         PAGE  5


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                            t pravdivou informaci
  00000006            00164 DRDY                    equ 6   ; = 1 -> disk ready (pripraven k praci)
  00000003            00165 DRQ                             equ 3   ; = 1 -> signalizuje, ze jsou pripravena data ke cteni 
  00000000            00166 ERR                             equ 0   ; = 1 -> pri provadeni posledniho prikazu doslo k chybe
                      00167          ; ATA_ERROR register
  00000002            00168 ABRT                    equ 2   ; = 1 -> prikaz aborted (spatny optkode prikazu)
                      00169          ; DEVICE_C (control) register
  00000002            00170 SRST                    equ 2   ; nastavime-li, provedeme soft. reset disku
  00000001            00171 nEIN                    equ 1   ; zakazuje preruseni disku (signal INTRQ)
  00000007            00172 HOB                             equ 7   ; tento bit DEVICE CONTROL se nastavuje pouze pokud disk podporu
                            je LBA 48 a cteme horni cast adresy LBA...
                      00173 ;**********************************************************
  0000002E            00174 ATA_ATTRIBUTES  equ 0x02e       ; Parametry hardisku. 
                      00175 ;Bity maji nasledujici vyznam:
  00000000            00176 ATA_OK                  equ 0   ; 0. bit = 1 -> disk je pritomen, zapnuty a funkcni :-)
  00000001            00177 LBA_SUPPORT             equ 1   ; 1. bit = 1 -> podpora LBA (pokud neni nastaven bit2, tak pouze LBA28 -
                            > disk do 120GB)
  00000002            00178 LBA48_SUPPORT   equ 2   ; 2. bit = 1 -> podpora LBA 48 (disk je zrejme vetsi jak 120GB)
  00000003            00179 BIG_SECTOR              equ 3   ; 3. bit = 1 -> velikost sektoru je vetsi nez 256 !!! (s takovym diskem 
                            zatim tento program neumi)
  00000004            00180 FAT32_LOAD              equ 4   ; 4. bit = 1 -> FATka byla uspesne analyzovana a udaje o ni jsou pravdiv
                            e
                      00181                                                 ; 5. bit  -> nepouzit
                      00182                                                 ; 6. bit  -> nepouzit (tyto tri bity treba pouziju pro v
                            lastnosti FATky)
  00000007            00183 APPLICABLE              equ 7   ; 7. bit = 1 -> disk je pro nas pouzitelny (LBA, sektor o 512B)
                      00184 
                      00185 
  0000002F            00186 PARAM_MAX_LBA1  equ 0x02F               ; [4B] maximalni hodnota LBA (velikost disku)   
  00000030            00187 PARAM_MAX_LBA2  equ 0x030               ; tady pozor, disky mohou byt adresovany az LBA 48, MBR je ale o
                            mezen na LBA 32 (2TB)
  00000031            00188 PARAM_MAX_LBA3  equ 0x031               ; tak by nemelo smysl vsech 48b kdyz by se nevyuzily. (Navic jse
                            m disk vetsi nez 2TB nevidel :)
  00000032            00189 PARAM_MAX_LBA4  equ 0x032               ; (registr s indexem 1 ma nejnizsi vahu)
                      00190 
  00000033            00191 PARAM_SLOV_V_SEKTORU1   equ 0x33 ; [2B] disky mohou mit velikost sektoru vetsi nez 512 (256sl) 
  00000034            00192 PARAM_SLOV_V_SEKTORU2   equ 0x34 
                      00193 ; pokud je to zapsano takto, nejvyznamejsi bity jsou niz v paneti (PARAM_MAX_LBA + X)
                      00194 ; pokud je zapsano jako skupina LBA1, LBA2, LBA3, LBA4, tak nejvyznamejsi bity jsou v LBA4
                      00195 ;**********************************************************
                      00196 ; pomocne registry pouzivane v podprogramech 
                      00197 ; !!! MUSIME ZAJISTIT ABY NEBYLY POUZIVANY VE VNORENYCH PODPROGRAMECH !!!
  00000035            00198 TEMPW                   equ 0x035
  00000036            00199 TEMP1                   equ 0x036
  00000037            00200 TEMP2                   equ 0x037
  00000038            00201 TEMP3                   equ 0x038
  00000039            00202 TEMP4                   equ 0x039
  0000003A            00203 TEMP5                   equ 0x03A
                      00204 
                      00205 ; !!! pomocne promenne pro spozdovaci smycky jsou na stejnych mistech
                      00206 ; pouzito pro synchronizaci s prog. picdelay
  00000036            00207 TMP1                    equ 0x036
  00000037            00208 TMP2                    equ 0x037
  00000038            00209 TMP0                    equ 0x038
MPASM 03.90 Released                                  MP3.ASM   12-16-2005  14:37:50         PAGE  6


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00210 ;**********************************************************
                      00211 ; registry pro praci s FATkou
  0000003B            00212 POZICE                  equ 0x03B               ; na ukladani aktualni pozice v slusteru, pripadne jine 
                            kokotiny
  0000003C            00213 CLUSTER1                equ 0x03C
  0000003D            00214 CLUSTER2                equ 0x03D
  0000003E            00215 CLUSTER3                equ 0x03E
  0000003F            00216 CLUSTER4                equ 0x03F
                      00217 
  00000040            00218 POCATEK_DAT1    equ 0x040
  00000041            00219 POCATEK_DAT2    equ 0x041
  00000042            00220 POCATEK_DAT3    equ 0x042
  00000043            00221 POCATEK_DAT4    equ 0x043
                      00222 
  00000044            00223 POCATEK_FAT1    equ 0x044
  00000045            00224 POCATEK_FAT2    equ 0x045
  00000046            00225 POCATEK_FAT3    equ 0x046
  00000047            00226 POCATEK_FAT4    equ 0x047
                      00227 
  00000048            00228 ROOT_DIR_CL1    equ 0x048
  00000049            00229 ROOT_DIR_CL2    equ 0x049
  0000004A            00230 ROOT_DIR_CL3    equ 0x04A
  0000004B            00231 ROOT_DIR_CL4    equ 0x04B
                      00232 
  0000004C            00233 CLUSTER_SIZE    equ 0x04C               ; velikost clusteru (pocet sektoru na cluster)
                      00234 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00235 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00236 ; DEFINICE PROMENNYCH a KONSTANT PRO PRACI S VS1001
                      00237 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00238 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00239 ; adresy registru VS1001
  00000000            00240 VSADDR_MODE                     equ .0          ; nastaveni VS1001
  00000001            00241 VSADDR_STATUS           equ .1          ; slouzi pouze pro zapnuti / vypnuti analogove casti (MUTE)
  00000003            00242 VSADDR_CLOCKF           equ .3          ; informuje dekoder o jeho krystalu. !! je nutne pro spravne dek
                            odovani !!
  00000004            00243 VSADDR_DECODE_TIME      equ .4          ; obsahuje cas dekodovani aktualni MP3 !! neaktualizuje se pri s
                            kocich (previjeni)
  00000005            00244 VSADDR_AUDATA           equ .5          ; obsahuje informace o datovem toku a vzorkovaci frekvenci MP3
                      00245         ; bit 15 = 1 => STEREO; = 1 => MONO
                      00246         ; bity 12-9 obsahuji vzorkovaci frekvenci v Hz
                      00247         ;       0000 -> neznama vzorkovaci frekvence
                      00248         ;       0001 -> 44 100
                      00249         ;       0010 -> 48 000
                      00250         ;       0011 -> 32 000
                      00251         ;       0100 -> 22 050
                      00252         ;       0101 -> 24 000 
                      00253         ;       0110 -> 16 000
                      00254         ;       0111 -> 11 025
                      00255         ;       1000 -> 12 000
                      00256         ;       1001 ->  8 000
                      00257         ; bity 8-0 obsahuji bitrate v kbps 
  00000006            00258 VSADDR_WRAM             equ .6                  ; Slouzi k zapisovani uzivatelskeho programu, dato se za
                            pise na adresu v WRAMADDR
  00000007            00259 VSADDR_WRAMADDR equ .7                  ; Adresuje uzivatelskou pamet dekoderu
MPASM 03.90 Released                                  MP3.ASM   12-16-2005  14:37:50         PAGE  7


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

  00000008            00260 VSADDR_HDAT0    equ .8                  ; Obsahuje informace ziskane z hlavicky MP3
  00000009            00261 VSADDR_HDAT1    equ .9                  ; Obsahuje informace ziskane z hlavicky MP3
  0000000A            00262 VSADDR_AIADDR   equ .10                 ; Start uzivatelskeho programu (vis. datasheet)
  0000000B            00263 VSADDR_VOL              equ .11                 ; ovladani hlasitosti (pro oba kanaly) Horni byte je lev
                            y kanal, dolni byte je pravy kanal
                      00264                                                                 ; (hodnota 0000h znamena hlasitost na ma
                            x., FF00h hraje pouze pravy kanal, FFFFh je ticho)
  0000000D            00265 VSADDR_AICTRL0  equ .13                 ; Registr pro ovladani uzivatelskeho programu
  0000000E            00266 VSADDR_AICTRL1  equ .14                 ; Registr pro ovladani uzivatelskeho programu
                      00267 ;**********************************************************
                      00268 ; registry pro praci s VS1001   
                      00269 ; dekoder VS1001 ma vsechny registry 16bitove, proto za jmeno pisu _L /_H (u nekterych registru potrebuj
                            i pouze jednu cast)
  0000004D            00270 VSREG_MODE_L    equ 0x04D
  0000004E            00271 VSREG_STATUS_L  equ 0x04E
  0000004F            00272 VSREG_VOL_L             equ 0x04F               ; levy kanal
  00000050            00273 VSREG_VOL_H             equ 0x050               ; pravy kanal
                      00274 ;**********************************************************
                      00275 ; informace potrebne pro prehravani
  00000060            00276 PREH_ADDR_CL1           equ 0x060
  00000061            00277 PREH_ADDR_CL2           equ 0x061
  00000062            00278 PREH_ADDR_CL3           equ 0x062
  00000063            00279 PREH_ADDR_CL4           equ 0x063
  00000064            00280 PREH_ADDR_POZICE        equ 0x064
  00000065            00281 PREH_ADDR_ZAZNAM        equ 0x065
                      00282 
  00000066            00283 PREH_DATA_CL1           equ 0x066
  00000067            00284 PREH_DATA_CL2           equ 0x067
  00000068            00285 PREH_DATA_CL3           equ 0x068
  00000069            00286 PREH_DATA_CL4           equ 0x069
  0000006A            00287 PREH_DATA_POZICE        equ 0x06A
                      00288 
  0000006B            00289 PREH_STAV                       equ 0x06B
                      00290                                 ; registr obsahuje informace o stavu aktualniho prehravani
                      00291                                 ; 0. bit = 1 => prehrava se soubor / 0 => neprehrava se soubor (muze byt
                             ale pouze pauza)
                      00292                                 ; 1. bit = 1 => je soubor pripraven k prehravani (muze byt pauza) / 0=> 
                            neni zadny soubor k prehravani (prikaz play nema zadny ucinek)
                      00293                                 ; 2. bit = 1 => je nastaven, kdyz se automaticky zneni prehravany soubor
                             (predchozi skonci) do doby, nez prijde prikaz na dotaz STAVU...
                      00294 
                      00295 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00296 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00297 ; registry pro potreby preruseni + prace s prikazy (jsou totiz dostupne odkudkoliv)
  00000070            00298 TEMP_WORKING    equ 0x070
  00000071            00299 TEMP_STATUS             equ 0x071
  00000072            00300 TEMP_FSR                equ 0x072
  00000073            00301 PRIJATYCH_DAT   equ 0x073               ; ukazuje kolik je platnych dat v zasobniku prikazu (0 -> zasobn
                            ik je prazdny)
  00000074            00302 PRIJATE_DATO    equ 0x074               ; pomocna promenna v preruseni
  00000075            00303 STAV_PRIKAZU    equ 0x075               ; pomocny registr signalizujici stav prikazu umisteneho v zasobn
                            iku prikazu
                      00304                                                                 ; pokud zadna procedura nenastavi do 1, 
                            je prikaz v tuto chvili neplatny
MPASM 03.90 Released                                  MP3.ASM   12-16-2005  14:37:50         PAGE  8


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00305                                                                 ; pokud prikaz je pro proceduru ale nama
                             zatim dost parametru, muji tento byt nastavit take do 1
                      00306 ; 0x078 - 0x07F         -> zasobnik prikazu (data prisla po USARTU)
                      00307 ;**********************************************************
                      00308 ; BANK_1        s touto bankou pracuji procedury provadejici 32 bitove 
                      00309 ;                       aritmeto/logicke operace
  000000A0            00310 OPERAND_X1              equ 0x0A0
  000000A1            00311 OPERAND_X2              equ 0x0A1
  000000A2            00312 OPERAND_X3              equ 0x0A2
  000000A3            00313 OPERAND_X4              equ 0x0A3
                      00314 
  000000A4            00315 OPERAND_Y1              equ 0x0A4
  000000A5            00316 OPERAND_Y2              equ 0x0A5
  000000A6            00317 OPERAND_Y3              equ 0x0A6
  000000A7            00318 OPERAND_Y4              equ 0x0A7
                      00319 
  000000A8            00320 VYSLEDEK1               equ 0x0A8
  000000A9            00321 VYSLEDEK2               equ 0x0A9
  000000AA            00322 VYSLEDEK3               equ 0x0AA
  000000AB            00323 VYSLEDEK4               equ 0x0AB
                      00324 
  000000AC            00325 PRETECENI               equ 0x0AC
                      00326 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00327 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00328 ; MAKRA
                      00329 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00330 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00331 BANK_0  macro                                   ; prepnuti do banky 0 v pameti dat
                      00332                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
                      00333                 bcf     STATUS,RP0    
                      00334                 endm
                      00335 BANK_1  macro                                   ; prepnuti do banky 1 v pameti dat
                      00336                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
                      00337                 bsf     STATUS,RP0    
                      00338                 endm
                      00339 BANK_2  macro                                   ; prepnuti do banky 2 v pameti dat
                      00340                 bsf     STATUS,RP1              ; BANK2  RP1:RP0 = 10
                      00341                 bcf     STATUS,RP0    
                      00342                 endm
                      00343 BANK_3  macro                                   ; prepnuti do banky 3 v pameti dat
                      00344                 bsf     STATUS,RP1              ; BANK3  RP1:RP0 = 11
                      00345                 bsf     STATUS,RP0    
                      00346                 endm
                      00347 ; INDF_BANK_x slouzi k prepinani bank pro neprime adresovani pomoci INDF a FSR
                      00348 INDF_BANK_0     macro               
                      00349                         bcf STATUS,IRP    
                      00350                         endm
                      00351 INDF_BANK_1     macro               
                      00352                         bcf STATUS,IRP    
                      00353                         endm
                      00354 INDF_BANK_2     macro             
                      00355                         bsf STATUS,IRP    
                      00356                         endm
                      00357 INDF_BANK_3     macro             
MPASM 03.90 Released                                  MP3.ASM   12-16-2005  14:37:50         PAGE  9


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00358                         bsf STATUS,IRP    
                      00359                         endm
                      00360 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00039 
                      00040 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00041 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00042 ; PROGRAM
                      00043 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00044 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00045         org 0
0000   2???           00046         goto START
                      00047         org     4
0004   2???           00048         goto INTERRUPT
                      00049 ;**********************************************************
                      00050 
                      00051         include "ata.asm"               ; podprogramy na ovladani ATA disku
                      00001 ;**********************************************************
                      00002 ;**********************************************************
                      00003 ;**********************************************************
                      00004 ; OBSLUZNE PODPROGRAMY PRO ATA
                      00005 ;**********************************************************
                      00006 ;**********************************************************
                      00007 ;**********************************************************
                      00008 
                      00009 ;**********************************************************
                      00010 ; cteni a zapis ATA registru 
                      00011 ;**********************************************************
0005                  00012 RD_STATUS         
0005   3027           00013         movlw D_STATUS      ; Status 
0006   2???           00014         call RUTR 
0007   00AC           00015         movwf ATA_STATUS
0008   0008           00016         return
                      00017 ;*****************************************
0009                  00018 RD_ERROR
0009   3021           00019         movlw D_ERROR      ; Error
000A   2???           00020         call RUTR
000B   00A5           00021         movwf ATA_ERROR
000C   0008           00022         return
                      00023 ;*****************************************
000D                  00024 RD_STATUS_A     
000D   3016           00025         movlw D_STATUS_A    ; Alternate Status 
000E   2???           00026         call RUTR 
000F   00A2           00027         movwf ATA_STATUS_A
0010   0008           00028         return
                      00029 ;*****************************************
0011                  00030 RD_SC
0011   3022           00031         movlw D_SECTOR_C    ; Sector Count
0012   2???           00032         call RUTR
0013   00A6           00033         movwf SECTOR_C
0014   0008           00034         return
                      00035 ;*****************************************
0015                  00036 RD_LBA1
0015   3023           00037         movlw D_LBA1    ; Sector Number 
0016   2???           00038         call RUTR                
MPASM 03.90 Released                                  MP3.ASM   12-16-2005  14:37:50         PAGE 10


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0017   00A7           00039         movwf LBA1 
0018   0008           00040         return
                      00041 ;*****************************************
0019                  00042 RD_LBA2
0019   3024           00043         movlw D_LBA2  ; Cylinder Low
001A   2???           00044         call RUTR
001B   00A8           00045         movwf LBA2
001C   0008           00046         return
                      00047 ;*****************************************
001D                  00048 RD_LBA3
001D   3025           00049         movlw D_LBA3  ; Cylinder High   
001E   2???           00050         call RUTR
001F   00A9           00051         movwf LBA3
0020   0008           00052         return
                      00053 ;*****************************************
0021                  00054 RD_DEVICE
0021   3026           00055         movlw D_DEVICE  ; Device Head
0022   2???           00056         call RUTR
0023   00AB           00057         movwf DEVICE
0024   0008           00058         return
                      00059 ;*****************************************
                      00060 ;*****************************************
0025                  00061 WR_DC
0025   0823           00062         movf DEVICE_C,w     ; Device Control
0026   00B5           00063         movwf TEMPW
0027   3016           00064         movlw D_DEVICE_C
0028   2???           00065         call RUTW
0029   0008           00066         return
                      00067 ;*****************************************
002A                  00068 WR_COMMAND          
002A   082D           00069         movf COMMAND,w      ; Command       
002B   00B5           00070         movwf TEMPW
002C   3027           00071         movlw D_COMMAND
002D   2???           00072         call RUTW
002E   0008           00073         return
                      00074 ;*****************************************
002F                  00075 WR_SC                    
002F   0826           00076     movf SECTOR_C,w     ; Sector Count
0030   00B5           00077         movwf TEMPW
0031   3022           00078         movlw D_SECTOR_C     
0032   2???           00079         call RUTW
0033   0008           00080         return
                      00081 ;*****************************************
0034                  00082 WR_LBA1
0034   0827           00083         movf LBA1,w     
0035   00B5           00084         movwf TEMPW
0036   3023           00085         movlw D_LBA1    
0037   2???           00086         call RUTW
0038   0008           00087         return
                      00088 ;*****************************************
0039                  00089 WR_LBA2
0039   0828           00090         movf LBA2,w   ; Cylinder Low
003A   00B5           00091         movwf TEMPW
003B   3024           00092         movlw D_LBA2
MPASM 03.90 Released                                  MP3.ASM   12-16-2005  14:37:50         PAGE 11


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

003C   2???           00093         call RUTW
003D   0008           00094         return
                      00095 ;*****************************************
003E                  00096 WR_LBA3
003E   0829           00097         movf LBA3,w   ; Cylinder High
003F   00B5           00098         movwf TEMPW
0040   3025           00099         movlw D_LBA3
0041   2???           00100         call RUTW
0042   0008           00101         return
                      00102 ;*****************************************
0043                  00103 WR_DEVICE
0043   082B           00104         movf DEVICE,w     ; Device Head 
0044   00B5           00105         movwf TEMPW
0045   3026           00106         movlw D_DEVICE
0046   2???           00107         call RUTW
0047   0008           00108         return
                      00109 ;*****************************************
0048                  00110 WR_FEATURES
0048   0824           00111         movf FEATURES,w     ; Features
0049   00B5           00112         movwf TEMPW
004A   3021           00113         movlw D_FEATURES
004B   2???           00114         call RUTW
004C   0008           00115         return
                      00116 ;*****************************************
                      00117 ; zapise vsechny registry potrebne k vykonani prikazu (adresove registry a prikaz)
004D                  00118 WR_BLOCK
004D   2???           00119         call WAIT_FOR_READY_FOR_COMMAND
004E   2???           00120         call WR_FEATURES
004F   2???           00121         call WR_SC
0050   2???           00122         call WR_LBA1
0051   2???           00123         call WR_LBA2
0052   2???           00124         call WR_LBA3
0053   2???           00125         call WR_DEVICE
0054   2???           00126         call WR_COMMAND
0055   0008           00127         return
                      00128 ;*****************************************
                      00129 ; ve workingu mame adresu registru ktery mame precist, 
                      00130 ; pak v nem vracime jeho hodnotu...
0056                  00131 RUTR          
0056   0087           00132         movwf ATA_ADDRESS                  ; adresa pozadovaneho registru
                      00133 
                      00134         BANK_1
0057   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0058   1683               M                 bsf     STATUS,RP0    
0059   30FF           00135     movlw 0xFF
005A   0086           00136     movwf DATA_PORT_LOW_TRIS   ; z datove zbernice cteme
005B   0088           00137     movwf DATA_PORT_HIGH_TRIS
                      00138         BANK_0
005C   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
005D   1283               M                 bcf     STATUS,RP0    
                      00139 
005E   1109           00140         bcf ATA_DIOR_N
005F   0000           00141     nop                                                 ; PIO delay min. 120ns (PIO 4)  
0060   0806           00142     movfw DATA_PORT_LOW                 ; Read DD0..D7 IDE
MPASM 03.90 Released                                  MP3.ASM   12-16-2005  14:37:50         PAGE 12


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0061   1509           00143         bsf ATA_DIOR_N
                      00144 
0062   0008           00145     return
                      00146 ;**********************************************************
                      00147 ; ve workingu mame adresu registru ktery mame zapsat,
                      00148 ; a v reg. TEMPW hodnotu kterou mame do tohoto registru zapsat
0063                  00149 RUTW
0063   0087           00150         movwf ATA_ADDRESS
                      00151 
                      00152         BANK_1
0064   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0065   1683               M                 bsf     STATUS,RP0    
0066   3000           00153     movlw 0x0
0067   0086           00154     movwf DATA_PORT_LOW_TRIS   ; do datove sbernice zapisujeme
0068   0088           00155     movwf DATA_PORT_HIGH_TRIS
                      00156         BANK_0
0069   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
006A   1283               M                 bcf     STATUS,RP0    
                      00157 
006B   0835           00158     movf TEMPW,w        
006C   0086           00159     movwf DATA_PORT_LOW                 ; Write DD0..DD7 IDE 
006D   0188           00160         clrf DATA_PORT_HIGH
                      00161 
006E   1089           00162         bcf ATA_DIOW_N
006F   0000           00163         nop
0070   1489           00164         bsf ATA_DIOW_N
                      00165           
                      00166         BANK_1
0071   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0072   1683               M                 bsf     STATUS,RP0    
0073   30FF           00167     movlw 0xff
0074   0086           00168     movwf DATA_PORT_LOW_TRIS   ; datova sbernice na cteni
0075   0088           00169     movwf DATA_PORT_HIGH_TRIS
                      00170         BANK_0
0076   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0077   1283               M                 bcf     STATUS,RP0    
                      00171 
0078   0008           00172         return
                      00173 ;**********************************************************
0079                  00174 READ_DATA
0079   2???           00175         call WAIT_FOR_DATA
                      00176 
007A   3020           00177     movlw D_DATA_R
007B   0087           00178         movwf ATA_ADDRESS
                      00179 
                      00180         BANK_1
007C   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
007D   1683               M                 bsf     STATUS,RP0    
007E   30FF           00181     movlw 0xFF
007F   0086           00182     movwf DATA_PORT_LOW_TRIS   ; z datove zbernice cteme
0080   0088           00183     movwf DATA_PORT_HIGH_TRIS
                      00184         BANK_0
0081   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0082   1283               M                 bcf     STATUS,RP0    
MPASM 03.90 Released                                  MP3.ASM   12-16-2005  14:37:50         PAGE 13


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00185 
0083   1109           00186         bcf ATA_DIOR_N
0084   0000           00187     nop                                                 ; PIO delay min. 120ns (PIO 4)  
0085   0000           00188         nop
0086   0806           00189     movfw DATA_PORT_LOW                 ; Read DD0..D7 IDE
0087   00A0           00190         movwf DATA_L
0088   0808           00191     movfw DATA_PORT_HIGH                ; Read DD8..D15 IDE
0089   00A1           00192         movwf DATA_H
008A   1509           00193         bsf ATA_DIOR_N
                      00194 
008B   0008           00195     return
                      00196 ;**********************************************************
                      00197 ; stava se, ze obcas nas zajima jen cast vracenych dat, tak ty ktere nas nezajimaji, preskocime
                      00198 ; ocakava parametr v registru TEMP1 (kolik slov ma preskocit)
                      00199 ; pokud TEMP1 = 0 tak preskoci 256 slov
008C                  00200 PRESKOC
008C   2???           00201         call READ_DATA
008D   0BB6           00202         decfsz TEMP1,F
008E   2???           00203         goto PRESKOC
008F   0008           00204         return
                      00205 ;**********************************************************
                      00206 ; rekne disku na ze pristi instrukce, registry, data.... budou pro mastera
0090                  00207 SELECT_DEVICE
0090   30E0           00208         movlw b'11100000'       ; adresy budou v LBA, budeme pracovat s masterem
0091   00AB           00209         movwf DEVICE
0092   2???           00210         call WR_DEVICE
0093   0008           00211         return
                      00212 ;**********************************************************
0094                  00213 ZAPIS_DO_BUFFERU_1      ; buffer1 ma 64B a je v bance 3 na adrese 0x190 - 0x1CF
                      00214                                         ; jako parametr dostanem TEMP1, kde je pocet bytu k zapisu
                      00215                                         ; maximalni hodnota v TEMP1 muze byt 32 (1 slovo = 2 byty)
                      00216         INDF_BANK_3             ; neprime adresovani na banku 3
0094   1783               M                         bsf STATUS,IRP    
0095   3090           00217         movlw 0x90              ; adresa ja 190, devaty byt urcuje banku (0,1 / 2,3) fsr je tedy 90
0096   0084           00218         movwf FSR               
0097                  00219 ZAPIS_DO_BUFFERU_1__ZAPIS
0097   2???           00220         call READ_DATA
                      00221         
0098   0820           00222         movfw DATA_L
0099   0080           00223         movwf INDF
009A   0A84           00224         incf FSR,F
009B   0821           00225         movfw DATA_H
009C   0080           00226         movwf INDF
009D   0A84           00227         incf FSR,F
                      00228 
009E   0BB6           00229         decfsz TEMP1,F
009F   2???           00230         goto ZAPIS_DO_BUFFERU_1__ZAPIS
                      00231 
                      00232         INDF_BANK_0     
00A0   1383               M                         bcf STATUS,IRP    
00A1   0008           00233         return
                      00234 ;**********************************************************
00A2                  00235 CLEAR_BUFFER2           ; BUFFER2 je 64bytu dat v bance 2 na adrese 0x110 - 0x14F
                      00236                                         ; pouziva TEMP1
MPASM 03.90 Released                                  MP3.ASM   12-16-2005  14:37:50         PAGE 14


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

00A2   3040           00237         movlw .64
00A3   00B6           00238         movwf TEMP1
                      00239         INDF_BANK_2             ; neprime adresovani na banku 2
00A4   1783               M                         bsf STATUS,IRP    
00A5   3010           00240         movlw 0x10
00A6   0084           00241         movwf FSR
00A7   3000           00242         movlw .0
                      00243 
00A8                  00244 CLEAR_BEFFER2__CLEAR
00A8   0080           00245         movwf INDF
00A9   0A84           00246         incf FSR,F
00AA   0BB6           00247         decfsz TEMP1,F
00AB   2???           00248         goto CLEAR_BEFFER2__CLEAR
                      00249 
                      00250         INDF_BANK_0             ; neprime adresovani na banku 0
00AC   1383               M                         bcf STATUS,IRP    
00AD   0008           00251         return
                      00252 ;**********************************************************
00AE                  00253 ATA_RESET
                      00254         ; Resetuje disk zjisti, zda vubec nejaky disk je pripojen
00AE   01AE           00255         clrf ATA_ATTRIBUTES     ; registr obsahujici bity rikajici co disk umi
                      00256 
00AF   1009           00257         bcf ATA_RESET_N         ; resetujeme disk
00B0   2???           00258         call DELAY_25us         ; signal reset musi byt min. 25us
00B1   1409           00259         bsf ATA_RESET_N         ; koncime s resetem disku
                      00260 
00B2   2???           00261         call WAIT_FOR_READY     ; vynulujeme device bit v DEVICE registru (disk musi byt master!), ...
00B3   2???           00262         call SELECT_DEVICE      ; ...nastavime bit L - LBA addressing
                      00263 
00B4   2???           00264         call WAIT_FOR_READY
00B5   3002           00265         movlw b'00000010'       ; zakazeme preruseni (ted mam na mysli signal INTRQ z disku)
00B6   00A3           00266         movwf DEVICE_C          ; bit nIEN = 1 -> zakazeme preruseni disku (stejne nemame signal INTRQ p
                            ripojen)
00B7   2???           00267         call WR_DC                      ; zapiseme hodnotu do registru DEVICE CONTROL
                      00268 
00B8   30E0           00269         movlw b'11100000'       ; adresy budou v LBA, budeme pracovat s masterem
00B9   00AB           00270         movwf DEVICE
00BA   01A6           00271         clrf SECTOR_C
00BB   01A7           00272         clrf LBA1       
00BC   01A8           00273         clrf LBA2
00BD   01A9           00274         clrf LBA3
00BE   01A4           00275         clrf FEATURES
00BF   3000           00276         movlw h'00'                     ; code prikazu nop
00C0   00AD           00277         movwf COMMAND
00C1   2???           00278         call WR_BLOCK           ; ted provedeme prvni prikaz (nop) a podivame se co nam disk vrati
                      00279 
00C2   2???           00280         call WAIT_FOR_READY
00C3   2???           00281         call RD_DEVICE          ; Precteme reg. device. Pokud je disk OK, tak by nam mel vratit to, co j
                            sme do nej predtim zapsaly
00C4   082B           00282         movfw DEVICE
00C5   3CE0           00283         sublw b'11100000'
00C6   1903           00284         btfsc STATUS,Z          ; pokud DEVICE <> b'11100000', tak tu bud disk nemame, nebo je nejakej r
                            ozsypanej, nebo je spatne svicivanej (treba SLAVE)
00C7   142E           00285         bsf ATA_ATTRIBUTES,ATA_OK       ; 0. bit = 1 -> disk je pritomen, zapnuty a funkcni...
MPASM 03.90 Released                                  MP3.ASM   12-16-2005  14:37:50         PAGE 15


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00286 
00C8   0008           00287         return          
                      00288 ;**********************************************************
00C9                  00289 READ_SECTOR
                      00290         ; Tento podprogram prevezme parametry SECTOR_C (kolik sec. mame precist)
                      00291         ; a LBA1 - LBA4, kde je ulozena LBA adresa sectoru od ktereho mame cist
                      00292         ; Postara se o spravne zadani adresy do disku (LBA28 / LBA48) a zavolani prikazu ke cteni...
                      00293         ; Samotne cteni se musi obslouzit v jine casti programu (podle toho co cteme...)
00C9   2???           00294         call WAIT_FOR_READY
00CA   2???           00295         call SELECT_DEVICE
00CB   2???           00296         call WAIT_FOR_READY_FOR_COMMAND
00CC   192E           00297         btfsc ATA_ATTRIBUTES,LBA48_SUPPORT
00CD   2???           00298         goto READ_SECTOR_LBA48
                      00299 
00CE                  00300 READ_SECTOR_LBA27               ; zadavani adresy v LBA28 je celkem jednoduche, LBA bity 24-27 jsou obsa
                            zene v dolnich 4 bitech DEVICE reg.
00CE   01A4           00301         clrf FEATURES
00CF   2???           00302         call WR_FEATURES
00D0   2???           00303         call WR_SC
00D1   2???           00304         call WR_LBA1
00D2   2???           00305         call WR_LBA2
00D3   2???           00306         call WR_LBA3
00D4   082A           00307         movfw LBA4                      ; Z nejvyssi casti adresy...
00D5   390F           00308         andlw b'00001111'       ; ...pouzijeme pouze dolni 4bity...
00D6   38E0           00309         iorlw b'11100000'       ; ...horni 3bity nastavime (LBA adresovani, master)...
00D7   00AB           00310         movwf DEVICE            ; ...a zapiseme do DEVICE.
00D8   2???           00311         call WR_DEVICE
00D9   3020           00312         movlw 0x20                      ; Read sector. OPCODE - 20h (with retries) or 21h (without retri
                            es)
00DA   00AD           00313         movwf COMMAND           ; ...podle me to znamena ze prikaz 20h se bude pri neuspechu pokouset zn
                            ova o cteni....
00DB   2???           00314         call WR_COMMAND         ; ...protoze se v novejsich spicifacich jiz prikaz 21h nevyskytuje, pouz
                            ivam ke cteni 20h.
00DC   0008           00315         return
                      00316 
00DD                  00317 READ_SECTOR_LBA48
                      00318         ; !!! Pripominam ze to co zde pisu (o LBA48) vim ze specifikace ATA8, v praxi jsem LBA48 na zadn
                            em disku jeste nezkousel !!!
                      00319         ; Zadavani adresy pri LBA48 se o neco lisi nez LBA28. Do registru LBA 1,2,3 se data zadavaji 2x.
                             
                      00320         ; Prvi zadavani znamena horni cast adresy, druhe zadavani dolni cast adresy.
                      00321         ; Znova sem pisu ze v tomto programu vyuzijeme jen LBA o 32bitech (2TB) a ne celych LBA48
00DD   3000           00322         movlw .0
00DE   00B5           00323         movwf TEMPW
00DF   3022           00324         movlw D_SECTOR_C    ; vyssi cast parametru SECTOR_C = 0
00E0   2???           00325         call RUTW       
00E1   2???           00326         call WR_SC                      ; nizci cast parametru SECTOR_C
                      00327 
00E2   3000           00328         movlw .0
00E3   00B5           00329         movwf TEMPW
00E4   3025           00330         movlw D_LBA3            ; LBA bity 47:40
00E5   2???           00331         call RUTW
00E6   3000           00332         movlw .0
00E7   00B5           00333         movwf TEMPW
MPASM 03.90 Released                                  MP3.ASM   12-16-2005  14:37:50         PAGE 16


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

00E8   3024           00334         movlw D_LBA2            ; LBA bity 39:32
00E9   2???           00335         call RUTW
00EA   082A           00336         movfw LBA4
00EB   00B5           00337         movwf TEMPW
00EC   3023           00338         movlw D_LBA1            ; LBA bity 31:24
00ED   2???           00339         call RUTW
                      00340 
00EE   2???           00341         call WR_LBA3            ; LBA bity 23:16
00EF   2???           00342         call WR_LBA2            ; LBA bity 15:8
00F0   2???           00343         call WR_LBA1            ; LBA bity  7:0
00F1   3024           00344         movlw h'24'                     ; pri LBA48 se musi pouzit tohoto prikazu ke cteni (READ SECTOR(
                            S) EXT - 24h, PIO data-in)
00F2   00AD           00345         movwf COMMAND
00F3   2???           00346         call WR_COMMAND
00F4   0008           00347         return
                      00348 ;**********************************************************
00F5                  00349 IDENTIFY_DEVICE
                      00350         ; ted uz vime, ze mame pripojen nejaky disk, tento podprogram provede prikaz 
                      00351         ; identify device a zjisti co je disk zac. Nektere dulezite informace ulozi 
                      00352         ; (nastavi byty v ATA_ATTRIBUTES) a jmenovku disku hodi do bufferu
                      00353 
                      00354         ; rekneme disku, ze s nim chcem pracovat (s masterem)
00F5   2???           00355         call WAIT_FOR_READY
00F6   2???           00356         call SELECT_DEVICE
                      00357         
                      00358         ; podivame se zda tu vubec disk je a co podporuje (LBA)
00F7   2???           00359         call WAIT_FOR_READY     ; celame nez bude disk opet ready pro dalsi prikazy
                      00360 
00F8   30E0           00361         movlw b'11100000'       ; adresy budou v LBA, budeme pracovat s masterem
00F9   00AB           00362         movwf DEVICE
00FA   01A6           00363         clrf SECTOR_C
00FB   01A7           00364         clrf LBA1       
00FC   01A8           00365         clrf LBA2
00FD   01A9           00366         clrf LBA3
00FE   01A4           00367         clrf FEATURES
00FF   30EC           00368         movlw 0xEC                      ; code prikazu IDENTIFY DEVICE
0100   00AD           00369         movwf COMMAND
0101   2???           00370         call WR_BLOCK
                      00371 
                      00372         ; pokud se neco nepodelalo, dostanem 256 16ti bitovych slov kde je napsano co disk umi a co je t
                            o zac...
                      00373         ; slova cisluji od nuly, (tzn. ze slov je 0-255)
0102   301B           00374         movlw .27               ; prvnich 27 slov je pro nas nepotrebnych
0103   00B6           00375         movwf TEMP1
0104   2???           00376         call PRESKOC
                      00377         
                      00378         ; [27-46] model mumber (ASCI retezec s nazvem disku)
                      00379         ; tady precteme 20 slov a rovnou je odesleme do pric
                      00380                 ; pokud nekde od disku dostavame ASCII retezec jsou data nasledujici: 
                      00381                 ; pr. disk nam posila string Copyright
                      00382                 ;               1. DATA_H = 'C' 
                      00383                 ;               1. DATA_l = 'o'
                      00384                 ;               2. DATA_H = 'P' 
                      00385                 ;               2. DATA_l = 'y'
MPASM 03.90 Released                                  MP3.ASM   12-16-2005  14:37:50         PAGE 17


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0105   3014           00386         movlw .20               ; dalsich 20 slov obsahuje 40 s ASCII znaku s nazvem disku
0106   00B6           00387         movwf TEMP1
0107   2???           00388         call ZAPIS_DO_BUFFERU_1
                      00389                 
                      00390         ; ted jsme uz precetli 47 slov z 256 :-)
0108   3002           00391         movlw .2                ; dalsi 2 slova jsou nam k nicemu
0109   00B6           00392         movwf TEMP1
010A   2???           00393         call PRESKOC
                      00394                 
010B   2???           00395         call READ_DATA  ; slovo 49 - capabilities (schopnosti)
                      00396                         ; 15:14 Reserved for the IDENTIFY PACKET DEVICE command.
                      00397                         ;    13 1 = Standby timer values as specified in this standard are supported
                      00398                         ;       0 = Standby timer values shall be managed by the device
                      00399                         ;    12 Reserved for the IDENTIFY PACKET DEVICE command.
                      00400                         ;    11 1 = IORDY supported
                      00401                         ;       0 = IORDY may be supported
                      00402                         ;    10 1 = IORDY may be disabled
                      00403                         ;     9 1 = LBA supported
                      00404                         ;     8 1 = DMA supported.
                      00405                         ;   7:0 Retired 
010C   18A1           00406         btfsc DATA_H,1  ;bit 9 = 1 -> LBA supported
010D   14AE           00407         bsf ATA_ATTRIBUTES,LBA_SUPPORT
                      00408 
                      00409         ;precetli jsme 50 slov
010E   300A           00410         movlw .10
010F   00B6           00411         movwf TEMP1
0110   2???           00412         call PRESKOC
                      00413         
0111   2???           00414         call READ_DATA  ; 60
0112   0820           00415         movfw DATA_L
0113   00AF           00416         movwf PARAM_MAX_LBA1            ; nejnizsi cast adresy
0114   0821           00417         movfw DATA_H
0115   00B0           00418         movwf PARAM_MAX_LBA2    
                      00419         
0116   2???           00420         call READ_DATA  ; 61
0117   0820           00421         movfw DATA_L
0118   00B1           00422         movwf PARAM_MAX_LBA3
0119   0821           00423         movfw DATA_H
011A   00B2           00424         movwf PARAM_MAX_LBA4            ; nejvyssi cast adresy
                      00425         
                      00426         ;precetli jsme 62 slov, zbyva 194
011B   3015           00427         movlw .21
011C   00B6           00428         movwf TEMP1
011D   2???           00429         call PRESKOC
                      00430 
                      00431         ; 83 slov, na rade je slovo 83 (pripominam ze slova jsou cislovana od nuly)
011E   2???           00432         call READ_DATA  ; 83 - command supported. Tady nas zajima bit 10 - 1 = 48-bit Address feature se
                            t supported
011F   1921           00433         btfsc DATA_H,2  ; pokud disk umi LBA 48 pripiseme tuto skutecnost do ATA_ATTRIBUTES
0120   152E           00434         bsf ATA_ATTRIBUTES,LBA48_SUPPORT
                      00435 
                      00436         ;precetli jsme 84 slov
0121   3010           00437         movlw .16
0122   00B6           00438         movwf TEMP1
MPASM 03.90 Released                                  MP3.ASM   12-16-2005  14:37:50         PAGE 18


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0123   2???           00439         call PRESKOC
                      00440                 
0124   1D2E           00441         btfss ATA_ATTRIBUTES,LBA48_SUPPORT
0125   2???           00442         goto INIT_ATA__NOT_SUPPORT_LBA48
                      00443                         ; pokud je podporovano LBA 48, nachazi se ve slovech [100-103] skutecny pocet se
                            ktoru 
                      00444                         ; do slov 60-61 by se sice vesel pocet sektoru u disku do 2TB, podle standardu s
                            e tam ale zapisuje pouze hodnota max pro LBA 28 (cca 120 GB)
                      00445                         ; mi precteme ale jen nejnizsi 2 slova, predpokladam totiz ze disk neni vetsi ja
                            k 2TB
0126   2???           00446                         call READ_DATA  ; 100
0127   0820           00447                         movfw DATA_L
0128   00AF           00448                         movwf PARAM_MAX_LBA1            ; nejnizsi cast adresy
0129   0821           00449                         movfw DATA_H
012A   00B0           00450                         movwf PARAM_MAX_LBA2    
                      00451 
012B   2???           00452                         call READ_DATA  ; 101
012C   0820           00453                         movfw DATA_L
012D   00B1           00454                         movwf PARAM_MAX_LBA3
012E   0821           00455                         movfw DATA_H
012F   00B2           00456                         movwf PARAM_MAX_LBA4            ; nejvyssi cast adresy                  
0130   2???           00457                 goto INIT_ATA__DALSI
0131                  00458 INIT_ATA__NOT_SUPPORT_LBA48
0131   3002           00459         movlw .2        ; 100, 101
0132   00B6           00460         movwf TEMP1
0133   2???           00461         call PRESKOC    
0134                  00462 INIT_ATA__DALSI
                      00463         ; precetli jsme 102 slov
0134   3004           00464         movlw .4        ; 102, 103, 104, 105
0135   00B6           00465         movwf TEMP1
0136   2???           00466         call PRESKOC
                      00467 
0137   2???           00468         call READ_DATA  ; slovo 106 - pokud bit 15=0 a bit 14=1, tak obsahuje pravdive informace
                      00469                                                 ; pro nas je podstatne, ze pokud je bit 12 = 1, tak sekt
                            or je vetsi nez 256 slov
                      00470                                                 ; pokud je sektor vetsi nez 256 slov, je jeho velikost v
                            e slovech [117-118]
0138   1BA1           00471         btfsc DATA_H,7
0139   2???           00472         goto INIT_ATA__DALSI2
013A   1F21           00473         btfss DATA_H,6
013B   2???           00474         goto INIT_ATA__DALSI2
013C   1A21           00475         btfsc DATA_H,4
013D   15AE           00476         bsf ATA_ATTRIBUTES,BIG_SECTOR
013E                  00477 INIT_ATA__DALSI2
                      00478         ; precteno 107, zbyva 149
013E   3095           00479         movlw .149      ; 107 - 256
013F   00B6           00480         movwf TEMP1
0140   2???           00481         call PRESKOC
                      00482                 
                      00483         ; ted vime co mame za disk, tak se na to jdem podivat...
                      00484         ; pokud disk splnuje vsechny nase pozadavky, tak nastavime 7 bit v ATA_ATTRIBUTES
0141   13AE           00485         bcf ATA_ATTRIBUTES,APPLICABLE   
0142   1CAE           00486         btfss ATA_ATTRIBUTES,LBA_SUPPORT
0143   0008           00487         return
MPASM 03.90 Released                                  MP3.ASM   12-16-2005  14:37:50         PAGE 19


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00488         ; pokud jsme tady, disk podporuje LBA (dneska se jich uz moc nevidi, co by LBA neumeli)
0144   19AE           00489         btfsc ATA_ATTRIBUTES,BIG_SECTOR
0145   0008           00490         return
                      00491         ; mazec, disk ma velikost sektoru 256 slov, vetsi naroky na disk nemam :-)
0146   17AE           00492         bsf ATA_ATTRIBUTES,APPLICABLE ; disk umi to co potrebujeme...   
                      00493 
0147   0008           00494         return
                      00495 ;**************************************************************************
                      00496 ;**********************************************************
                      00497 ; CEKACI PROCEDURY
                      00498 ;**********************************************************
0148                  00499 DELAY_25us
                      00500         ; pouziva TEMP1
                      00501         ; (Fosc = 20 MHz , instr. cyklus= 0.20 us) 25us / 0.20 us = 125 instrukcnich cyklu
                      00502         ; (Fosc = 16 MHz , instr. cyklus= 0.25 us) 25us / 0.25 us = 100 instrukcnich cyklu
                      00503         ; (Fosc = 04 MHz , instr. cyklus= 1.00 us) 25us / 1.00 us =  25 instrukcnich cyklu      
                      00504         ;MOVLW 0x2A  ;42 DEC -> Delay 127 cycles
0148   3021           00505         MOVLW 0x21   ;33 DEC -> Delay 100 cycles
                      00506         ;MOVLW 0x08  ;25 DEC -> Delay  25 cycles
0149   00B6           00507         MOVWF TEMP1
014A   0BB6           00508         DECFSZ TEMP1,F
014B   2???           00509         GOTO $-1
                      00510         ;End of Delay
014C   0008           00511         return
                      00512 ;**************************************************************************
014D                  00513 WAIT_FOR_DATA
                      00514         ; Wait: ( Bsy=0 AND Drq=1 ) OR err=1
                      00515         ; 7   6    5  4   3   2    1   0
                      00516         ; BSY DRDY DF DSC DRQ CORR IDX ERR
                      00517         ; (cekame az disk bude mit pro nas prichystana data)
014D   2???           00518         call WAIT_FOR_READY
014E   082C           00519         movfw ATA_STATUS
014F   3988           00520         andlw b'10001000'
0150   3C08           00521         sublw b'00001000'
0151   1903           00522         btfsc STATUS,Z
0152   0008           00523         return
0153   1C2C           00524         btfss ATA_STATUS,ERR
0154   2???           00525         goto WAIT_FOR_DATA
0155   0008           00526         return
                      00527 ;**************************************************************************
0156                  00528 WAIT_FOR_READY
                      00529         ; Cekame az Bsy bit = 0 
                      00530         ; (cekame az disk nebude zaneprazdnen)
0156   2???           00531         call RD_STATUS
0157   082C           00532         movfw ATA_STATUS
0158   3980           00533         andlw b'10000000'
0159   1903           00534         btfsc STATUS,Z
015A   0008           00535         return
015B   2???           00536         goto WAIT_FOR_READY
                      00537 ;**************************************************************************
015C                  00538 WAIT_FOR_READY_FOR_COMMAND
015C   2???           00539         call WAIT_FOR_READY
015D   1F2C           00540         btfss ATA_STATUS,DRDY
015E   2???           00541         goto WAIT_FOR_READY_FOR_COMMAND
MPASM 03.90 Released                                  MP3.ASM   12-16-2005  14:37:50         PAGE 20


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

015F   0008           00542         return
                      00543 ;**************************************************************************
                      00052         include "fat32.asm"     ; podprogramy na nacteni a praci s FAT32
                      00001 ;**********************************************************
                      00002 ;**********************************************************
                      00003 ;**********************************************************
                      00004 ; OBSLUZNE PODPROGRAMY PRO FAT32, HLEDANI ODDILU
                      00005 ;**********************************************************
                      00006 ;**********************************************************
                      00007 ;**********************************************************
                      00008 
                      00009 ;**************************************************************************
0160                  00010 SCAN_MBR
                      00011         ; Tato procedura ma na prvni pohled jednoduchy ukol, podiva se do MBR a do BUFFERU 2 hodi nasled
                            ujici data:
                      00012         ; 4 x 16 bytovy zaznam, kde kazdy zaznam reprezentuje jeden oddil se systemem FAT32
                      00013         ; struktura zaznamu je nasledujici:             1  byt (pokud = 0 tak v zaznamu neni zaznam o od
                            dilu, pokud = FFh , je zaznam o oddilu)
                      00014         ;                                                                               4  byty = adresa
                             kde se nachazi spousteci zaznam oddilu
                      00015         ;                                                                               11 bytu = jmenov
                            ka oddilu s FAT32 (neni dulezita, jen aby bylo co vypsat na display :-)
0160   2???           00016         call CLEAR_BUFFER2
                      00017 
0161   01A7           00018         clrf LBA1
0162   01A8           00019         clrf LBA2
0163   01A9           00020         clrf LBA3
0164   01AA           00021         clrf LBA4                               ; jako prvni cteme MBR
                      00022 
0165   01BB           00023         clrf POZICE                             ; kolik zaznamu o oddilech uz bylo zapsano do bufferu2
0166                  00024 SCAN_BR                                         
                      00025         ; tady na tom navesti mame zadanou adresu MBR nebo BR nejakeho rozsireneho oddilu
0166   3001           00026         movlw .1
0167   00A6           00027         movwf SECTOR_C
0168   2???           00028         call READ_SECTOR                ; cteme MBR nebo BR rozsireneho oddilu
                      00029 
0169   30DF           00030         movlw .223                              ; 223 slov = 446 bytu
016A   00B6           00031         movwf TEMP1
016B   2???           00032         call PRESKOC                    ; na prvnich 446 bytech MBR je zavadeci program systemu (samozre
                            jme, pokud na disku system je)
016C   3020           00033         movlw .32
016D   00B6           00034         movwf TEMP1
016E   2???           00035         call ZAPIS_DO_BUFFERU_1 ; do bufferu si dame vsechny zaznamy BR (16*4=64bytu / 32slov)
016F   3001           00036         movlw .1
0170   00B6           00037         movwf TEMP1
0171   2???           00038         call PRESKOC
                      00039         ; tak ted jsme precetli cely MBR/BR a zaznamy o jeho oddilech mame v BEFFERU 1, tak se jdem na n
                            e podivat...
                      00040         
                      00041         ; Nejdriv si ale hodime aktualni LBA adresu do operandu Y pro aritmeticke operace
                      00042         INDF_BANK_1                             ; neprime adresovani na banku 1 (aritmeticke operace)
0172   1383               M                         bcf STATUS,IRP    
0173   30A4           00043         movlw 0xA4                              ; FSR na OPERAND_Y
0174   0084           00044         movwf FSR       
MPASM 03.90 Released                                  MP3.ASM   12-16-2005  14:37:50         PAGE 21


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0175   0827           00045         movfw LBA1
0176   0080           00046         movwf INDF
0177   0A84           00047         incf FSR,F
0178   0828           00048         movfw LBA2
0179   0080           00049         movwf INDF
017A   0A84           00050         incf FSR,F
017B   0829           00051         movfw LBA3
017C   0080           00052         movwf INDF
017D   0A84           00053         incf FSR,F
017E   082A           00054         movfw LBA4
017F   0080           00055         movwf INDF
0180   0A84           00056         incf FSR,F
                      00057 
                      00058         INDF_BANK_3                             ; neprime adresovani na banku 3 (buffer 1)      
0181   1783               M                         bsf STATUS,IRP    
0182   3094           00059         movlw 0x94                              ; 90h (buffer1) + 4 (pozice kde je ulozen identifikator 
                            souboroveho systemu prvniho zaznamu BR)
0183   0084           00060         movwf FSR
0184   0800           00061         movfw INDF
0185   3C0C           00062         sublw h'0C'                             ; Pokud se FileSystem <> 0Ch...
0186   1D03           00063         btfss STATUS,Z
0187   3C01           00064         sublw .1                                ; ...ani 0Bh...
0188   1D03           00065         btfss STATUS,Z
0189   2???           00066         goto SCAN_MBR__HLEDEJ_ROZSIRENY_ODDIL   ; ...tak hledej rozsireny oddil.
                      00067 
                      00068         ; pokud jsme v teto casti programu, tak prvni zaznam MBR/BR obsahuje oddil FAT32, s reprezentaci
                             adres stylem LBA
                      00069         ; Tady pozor, v MBR/BR neni zapsana LBA adresa oddilu, ale relativni vzdalenost (offset) od MBR/
                            BR.
                      00070         ; To znamena, ze k adrese v (M)BR musime pricist offset oddilu.
                      00071         BANK_1
018A   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
018B   1683               M                 bsf     STATUS,RP0    
018C   3098           00072         movlw 0x98                              ; offset prvniho zaznamu 
018D   0084           00073         movwf FSR
018E   0800           00074         movfw INDF
018F   00A0           00075         movwf OPERAND_X1
0190   0A84           00076         incf FSR,F
0191   0800           00077         movfw INDF
0192   00A1           00078         movwf OPERAND_X2
0193   0A84           00079         incf FSR,F
0194   0800           00080         movfw INDF
0195   00A2           00081         movwf OPERAND_X3
0196   0A84           00082         incf FSR,F
0197   0800           00083         movfw INDF
0198   00A3           00084         movwf OPERAND_X4
                      00085         BANK_0
0199   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
019A   1283               M                 bcf     STATUS,RP0    
                      00086 
019B   2???           00087         call SOUCET
                      00088 
                      00089         INDF_BANK_1                             ; neprime adresovani na banku 1 (aritmeticke operace)
019C   1383               M                         bcf STATUS,IRP    
MPASM 03.90 Released                                  MP3.ASM   12-16-2005  14:37:50         PAGE 22


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

019D   30A8           00090         movlw 0xA8                              ; FSR na VYSLEDEK
019E   0084           00091         movwf FSR       
019F   0800           00092         movfw INDF
01A0   00A7           00093         movwf LBA1
01A1   0A84           00094         incf FSR,F
01A2   0800           00095         movfw INDF
01A3   00A8           00096         movwf LBA2
01A4   0A84           00097         incf FSR,F
01A5   0800           00098         movfw INDF
01A6   00A9           00099         movwf LBA3
01A7   0A84           00100         incf FSR,F
01A8   0800           00101         movfw INDF
01A9   00AA           00102         movwf LBA4
01AA   0A84           00103         incf FSR,F
                      00104 
01AB   2???           00105         call ZKONTROLUJ_ODDIL_FAT32     ; pokud skutecne adresa v LBA1-4 ukazuje na zacatek oddilu s FAT
                            32, tak da do bufferu2 jmenovku a adresu oddilu
                      00106         INDF_BANK_3
01AC   1783               M                         bsf STATUS,IRP    
01AD   30A4           00107         movlw 0xA4                                      ; 90h (buffer 1) + 16 (velikost 1. zaznamu) + 4 
                            (identifikator souboroveho systemu 2. zaznamu)
01AE   0084           00108         movwf FSR
01AF                  00109 SCAN_MBR__HLEDEJ_ROZSIRENY_ODDIL                ; jdem v zaznamech MBR/BR hledat rozsireny oddil
                      00110         ; pokud byl v prvnim zaznamu oddil typu FAT32, tak nam  tad FSR ukazuje na FileSystem 2. zaznamu
                            ...
                      00111         ; ...pokud 1. zaznam nebyl typu FAT32, tak nam FSR ukazuje na FileSystem 1. zaznamu.
                      00112         ; Kazdopadne se ted podivame na dalsi zaznam a pokud obsahuje rozsireny oddil, skocime na jeho a
                            dresu a dame goto SCAN_BR ...
01AF   0800           00113         movfw INDF
01B0   3C05           00114         sublw h'05'                             ; Pokud se FileSystem <> 05h (rozsireny oddil CHS)...
01B1   1D03           00115         btfss STATUS,Z
01B2   3C0A           00116         sublw h'0A'                             ; ...ani se <> 0Fh (5+A=F) (rozsireny oddil LBA)...
01B3   1D03           00117         btfss STATUS,Z
01B4   2???           00118         goto SCAN_MBR__KONEC    ; ...tak koncime...
                      00119 
01B5   0804           00120         movfw FSR                               ; ...pokud tu ale mame rozsireny oddil,...
01B6   3E04           00121         addlw .4                                ; ...tak se jdem podivat na jeho adresu.
01B7   0084           00122         movwf FSR
                      00123 
                      00124         BANK_1
01B8   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
01B9   1683               M                 bsf     STATUS,RP0    
                      00125         INDF_BANK_3
01BA   1783               M                         bsf STATUS,IRP    
01BB   0800           00126         movfw INDF
01BC   00A0           00127         movwf OPERAND_X1
01BD   0A84           00128         incf FSR,F
01BE   0800           00129         movfw INDF
01BF   00A1           00130         movwf OPERAND_X2
01C0   0A84           00131         incf FSR,F
01C1   0800           00132         movfw INDF
01C2   00A2           00133         movwf OPERAND_X3
01C3   0A84           00134         incf FSR,F
01C4   0800           00135         movfw INDF
MPASM 03.90 Released                                  MP3.ASM   12-16-2005  14:37:50         PAGE 23


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

01C5   00A3           00136         movwf OPERAND_X4
                      00137         BANK_0
01C6   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
01C7   1283               M                 bcf     STATUS,RP0    
                      00138 
01C8   2???           00139         call SOUCET
                      00140 
                      00141         INDF_BANK_1                             ; neprime adresovani na banku 1 (aritmeticke operace)
01C9   1383               M                         bcf STATUS,IRP    
01CA   30A8           00142         movlw 0xA8                              ; FSR na VYSLEDEK
01CB   0084           00143         movwf FSR       
01CC   0800           00144         movfw INDF
01CD   00A7           00145         movwf LBA1
01CE   0A84           00146         incf FSR,F
01CF   0800           00147         movfw INDF
01D0   00A8           00148         movwf LBA2
01D1   0A84           00149         incf FSR,F
01D2   0800           00150         movfw INDF
01D3   00A9           00151         movwf LBA3
01D4   0A84           00152         incf FSR,F
01D5   0800           00153         movfw INDF
01D6   00AA           00154         movwf LBA4
01D7   0A84           00155         incf FSR,F
                      00156         
01D8   2???           00157         goto SCAN_BR                    ; S rozirenym oddilem provedeme totez co s MBR
01D9                  00158 SCAN_MBR__KONEC
01D9   0008           00159         return
                      00160 ;**************************************************************************
01DA                  00161 ZKONTROLUJ_ODDIL_FAT32
                      00162         ; tak ted bychom mely mit v LBA 1-4 adresu spousteciho zaznamu oddilu s FAT32, tak to jdem overi
                            t...
                      00163         ; ...a pokud tam doopravdy spousteci zaznam je, tak dame jmenovku a informace do bufferu 2 na po
                            zici jaka je v rag. POZICE
                      00164         INDF_BANK_2
01DA   1783               M                         bsf STATUS,IRP    
01DB   083B           00165         movfw POZICE
01DC   00B6           00166         movwf TEMP1
01DD   1003           00167         bcf STATUS,C
01DE   0DB6           00168         rlf TEMP1,F
01DF   0DB6           00169         rlf TEMP1,F
01E0   0DB6           00170         rlf TEMP1,F
01E1   0DB6           00171         rlf TEMP1,F                             ; TEMP1 := POZICE *16
01E2   0836           00172         movfw TEMP1
01E3   3E11           00173         addlw 0x11                              ; TEMP1 + pozice bufferu 2 + 1 (pozice kam budeme do buf
                            feru 2 davat adresu oddilu)
01E4   0084           00174         movwf FSR
                      00175 
01E5   0827           00176         movfw LBA1
01E6   0080           00177         movwf INDF
01E7   0A84           00178         incf FSR,F
01E8   0828           00179         movfw LBA2
01E9   0080           00180         movwf INDF
01EA   0A84           00181         incf FSR,F
01EB   0829           00182         movfw LBA3
MPASM 03.90 Released                                  MP3.ASM   12-16-2005  14:37:50         PAGE 24


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

01EC   0080           00183         movwf INDF
01ED   0A84           00184         incf FSR,F
01EE   082A           00185         movfw LBA4
01EF   0080           00186         movwf INDF
01F0   0A84           00187         incf FSR,F                              ; adresa oddilu je ulozena do bufferu 2, ted tam jdem da
                            vat jmenovku oddilu
                      00188 
01F1   3001           00189         movlw .1
01F2   00A6           00190         movwf SECTOR_C
01F3   2???           00191         call READ_SECTOR
01F4   3023           00192         movlw h'23'
01F5   00B6           00193         movwf TEMP1
01F6   2???           00194         call PRESKOC                    ; informace o FATce co nas ted zrovna moc nezejimaji
                      00195         ; na offsetu 47 je ulozena jmenovka oddilu (11znaku), ted jsme na offsetu 46
                      00196 
01F7   2???           00197         call READ_DATA
01F8   0821           00198         movfw DATA_H
01F9   0080           00199         movwf INDF                              ; 1. znak ze jmenovky svazku
01FA   0A84           00200         incf FSR,F
                      00201 
01FB   3005           00202         movlw .5                                ; dalsich 10 bytu je zbytek jmenovky
01FC   00B6           00203         movwf TEMP1
01FD                  00204 ZKONTROLUJ_ODDIL_FAT32__JMENOVKA
01FD   2???           00205         call READ_DATA
01FE   0820           00206         movfw DATA_L
01FF   0080           00207         movwf INDF
0200   0A84           00208         incf FSR,F
0201   0821           00209         movfw DATA_H
0202   0080           00210         movwf INDF
0203   0A84           00211         incf FSR,F
0204   0BB6           00212         decfsz TEMP1,F
0205   2???           00213         goto ZKONTROLUJ_ODDIL_FAT32__JMENOVKA
0206   3010           00214         movlw .16
0207   0284           00215         subwf FSR,F                                     ; aby fsr ukazoval na priznak o pravdivosti (FSR
                             := FSR - 16)
                      00216 
0208   2???           00217         call READ_DATA
0209   0820           00218         movfw DATA_L
020A   3C46           00219         sublw 'F'               
020B   1D03           00220         btfss STATUS,Z
020C   2???           00221         goto ZKONTROLUJ_ODDIL_FAT32__KONEC
020D   0821           00222         movfw DATA_H
020E   3C41           00223         sublw 'A'               
020F   1D03           00224         btfss STATUS,Z
0210   2???           00225         goto ZKONTROLUJ_ODDIL_FAT32__KONEC
                      00226 
0211   2???           00227         call READ_DATA
0212   0820           00228         movfw DATA_L
0213   3C54           00229         sublw 'T'               
0214   1D03           00230         btfss STATUS,Z
0215   2???           00231         goto ZKONTROLUJ_ODDIL_FAT32__KONEC
0216   0821           00232         movfw DATA_H
0217   3C33           00233         sublw '3'               
0218   1D03           00234         btfss STATUS,Z
MPASM 03.90 Released                                  MP3.ASM   12-16-2005  14:37:50         PAGE 25


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0219   2???           00235         goto ZKONTROLUJ_ODDIL_FAT32__KONEC
                      00236 
021A   2???           00237         call READ_DATA
021B   0820           00238         movfw DATA_L
021C   3C32           00239         sublw '2'
021D   1D03           00240         btfss STATUS,Z
021E   2???           00241         goto ZKONTROLUJ_ODDIL_FAT32__KONEC
                      00242         ; tak, ted uz opravdu vime, ze na tomto sektoru se nachazi spousteci zaznam svazku se souborovym
                             systemem FAT32
                      00243 
021F   30FF           00244         movlw h'FF'
0220   0080           00245         movwf INDF
0221   0ABB           00246         incf POZICE,F                           ; sektor skutecne obsahoval spousteci zaznam svazku...
0222                  00247 ZKONTROLUJ_ODDIL_FAT32__KONEC
0222   0008           00248         return
                      00249 ;**************************************************************************
0223                  00250 NACTI_FAT32
                      00251         ; V LBA1-4 bychom meli dostat adresu prvniho sektoru FAT32 oddilu, kde by se mely nalezat inform
                            ace o fatce
                      00252         ; pokud je FATka pro nas pouzitelna (Clustery nejsou moc velke, sektor = 512B ...) nastavime bit
                             FAT32_LOAD v ATA_ATTRIBUTES
0223   122E           00253         bcf ATA_ATTRIBUTES,FAT32_LOAD
0224   01C0           00254         clrf POCATEK_DAT1
0225   01C1           00255         clrf POCATEK_DAT2
0226   01C2           00256         clrf POCATEK_DAT3
0227   01C3           00257         clrf POCATEK_DAT4
0228   01C4           00258         clrf POCATEK_FAT1
0229   01C5           00259         clrf POCATEK_FAT2
022A   01C6           00260         clrf POCATEK_FAT3
022B   01C7           00261         clrf POCATEK_FAT4
022C   01C8           00262         clrf ROOT_DIR_CL1
022D   01C9           00263         clrf ROOT_DIR_CL2
022E   01CA           00264         clrf ROOT_DIR_CL3
022F   01CB           00265         clrf ROOT_DIR_CL4
                      00266 
                      00267 
0230   01A4           00268         clrf FEATURES
0231   3001           00269         movlw .1
0232   00A6           00270         movwf SECTOR_C
0233   2???           00271         call READ_SECTOR
                      00272 
0234   3005           00273         movlw .5
0235   00B6           00274         movwf TEMP1
0236   2???           00275         call PRESKOC
                      00276 
0237   2???           00277         call READ_DATA                          ; 10 bytu precteno
0238   0821           00278         movfw DATA_H                            ; 11,12 byte - velikost sektoru (tady by melo byt 512, a
                            le co kdyby ne...)
0239   39FF           00279         andlw h'FF'
023A   1D03           00280         btfss STATUS,Z
023B   2???           00281         goto NACTI_FAT32__KONEC         ; pokud 11 byte neni nula, koncime (velikost sektoru se nerovna 
                            512)
                      00282 
023C   2???           00283         call READ_DATA                          ; ctu 12. a 13. byte
MPASM 03.90 Released                                  MP3.ASM   12-16-2005  14:37:50         PAGE 26


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

023D   0820           00284         movfw DATA_L
023E   3C02           00285         sublw h'02'
023F   1D03           00286         btfss STATUS,Z
0240   2???           00287         goto NACTI_FAT32__KONEC         ; pokud 12 byte neni 2, koncime (velikost sektoru se nerovna 512
                            )
                      00288 
0241   0821           00289         movfw DATA_H                            ; byte 13. SectorsPerCluster
0242   00CC           00290         movwf CLUSTER_SIZE
0243   3C20           00291         sublw .32                                       ; nas program neumi vic jak 32 (Velikost cluster
                            u = 16KB)
0244   1C03           00292         btfss STATUS,C
0245   2???           00293         goto NACTI_FAT32__KONEC         ; pokud mame clustery vetsi jak 16KB, tak koncime
                      00294 
0246   2???           00295         call READ_DATA                          ; ctu 14. a 15. byte
0247   0820           00296         movfw DATA_L
0248   00C4           00297         movwf POCATEK_FAT1                      ; tady se nachazi pocet rezervovanych sektoru, pak k ZAC
                            ATEK_FAT pricteme adresu zacatku sektoru a mame zacatek fat...
0249   0821           00298         movfw DATA_H
024A   00C5           00299         movwf POCATEK_FAT2
                      00300         
024B   2???           00301         call READ_DATA                          ; ctu 16. a 17. byte
024C   0820           00302         movfw DATA_L                            ; Pocet FAT. byva temer vzdy 2, kdyby ale ne, tak by nam
                             to delalo docela bordel...
024D   3C02           00303         sublw .2
024E   1D03           00304         btfss STATUS,Z
024F   2???           00305         goto NACTI_FAT32__KONEC
                      00306 
0250   3009           00307         movlw .9
0251   00B6           00308         movwf TEMP1
0252   2???           00309         call PRESKOC                            ; 18 - 35
                      00310 
0253   2???           00311         call READ_DATA                          ; 36,37 -> velikost FAT (pocet sektoru)
0254   0820           00312         movfw DATA_L
0255   00C0           00313         movwf POCATEK_DAT1
0256   0821           00314         movfw DATA_H
0257   00C1           00315         movwf POCATEK_DAT2      
0258   2???           00316         call READ_DATA                          ; 38,39 -> velikost FAT (pocet sektoru)
0259   0820           00317         movfw DATA_L
025A   00C2           00318         movwf POCATEK_DAT3
025B   0821           00319         movfw DATA_H
025C   00C3           00320         movwf POCATEK_DAT4
                      00321 
025D   2???           00322         call READ_DATA                          ; 40,41
025E   2???           00323         call READ_DATA                          ; 42,43
                      00324 
025F   2???           00325         call READ_DATA                          ; 44,45
0260   0820           00326         movfw DATA_L
0261   00C8           00327         movwf ROOT_DIR_CL1
0262   0821           00328         movfw DATA_H
0263   00C9           00329         movwf ROOT_DIR_CL2
0264   2???           00330         call READ_DATA                          ; 46,47
0265   0820           00331         movfw DATA_L
0266   00CA           00332         movwf ROOT_DIR_CL3
0267   0821           00333         movfw DATA_H
MPASM 03.90 Released                                  MP3.ASM   12-16-2005  14:37:50         PAGE 27


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0268   00CB           00334         movwf ROOT_DIR_CL4
                      00335 
0269   3011           00336         movlw .17
026A   00B6           00337         movwf TEMP1
026B   2???           00338         call PRESKOC                            ; 48 - 81
                      00339 
                      00340         ; ted jeste takova mala kontrola...
026C   2???           00341         call READ_DATA
026D   0820           00342         movfw DATA_L
026E   3C46           00343         sublw 'F'               
026F   1D03           00344         btfss STATUS,Z
0270   2???           00345         goto NACTI_FAT32__KONEC
0271   0821           00346         movfw DATA_H
0272   3C41           00347         sublw 'A'               
0273   1D03           00348         btfss STATUS,Z
0274   2???           00349         goto NACTI_FAT32__KONEC
0275   2???           00350         call READ_DATA
0276   0820           00351         movfw DATA_L
0277   3C54           00352         sublw 'T'               
0278   1D03           00353         btfss STATUS,Z
0279   2???           00354         goto NACTI_FAT32__KONEC
027A   0821           00355         movfw DATA_H
027B   3C33           00356         sublw '3'               
027C   1D03           00357         btfss STATUS,Z
027D   2???           00358         goto NACTI_FAT32__KONEC
027E   2???           00359         call READ_DATA
027F   0820           00360         movfw DATA_L
0280   3C32           00361         sublw '2'
0281   1D03           00362         btfss STATUS,Z
0282   2???           00363         goto NACTI_FAT32__KONEC
                      00364         ; tak, ted uz opravdu vime, ze na tomto sektoru se nachazi spousteci zaznam svazku se souborovym
                             systemem FAT32...
                      00365         ; tak ted jdem vypocitat ty nejdulezitejsi cisla pro praci s FATkou...
                      00366 
                      00367         INDF_BANK_1                                     ; aritmeto/logicke operace
0283   1383               M                         bcf STATUS,IRP    
0284   30A0           00368         movlw 0xA0                                      ; OPERAND_X
0285   0084           00369         movwf FSR
0286   0844           00370         movfw POCATEK_FAT1
0287   0080           00371         movwf INDF
0288   0A84           00372         incf FSR,F
0289   0845           00373         movfw POCATEK_FAT2
028A   0080           00374         movwf INDF
028B   0A84           00375         incf FSR,F
028C   0846           00376         movfw POCATEK_FAT3
028D   0080           00377         movwf INDF
028E   0A84           00378         incf FSR,F
028F   0847           00379         movfw POCATEK_FAT4
0290   0080           00380         movwf INDF
0291   0A84           00381         incf FSR,F
0292   0827           00382         movfw LBA1                                      ; OPERAND_Y
0293   0080           00383         movwf INDF
0294   0A84           00384         incf FSR,F
0295   0828           00385         movfw LBA2
MPASM 03.90 Released                                  MP3.ASM   12-16-2005  14:37:50         PAGE 28


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0296   0080           00386         movwf INDF
0297   0A84           00387         incf FSR,F
0298   0829           00388         movfw LBA3
0299   0080           00389         movwf INDF
029A   0A84           00390         incf FSR,F
029B   082A           00391         movfw LBA4
029C   0080           00392         movwf INDF
029D   0A84           00393         incf FSR,F
029E   2???           00394         call SOUCET                                     ; pricteme k zacatku oddilu pocet rezervovanych 
                            sektoru (obvykle 32) a mame z toho POCATEK_FAT
029F   0800           00395         movfw INDF
02A0   00C4           00396         movwf POCATEK_FAT1
02A1   0A84           00397         incf FSR,F
02A2   0800           00398         movfw INDF
02A3   00C5           00399         movwf POCATEK_FAT2
02A4   0A84           00400         incf FSR,F
02A5   0800           00401         movfw INDF
02A6   00C6           00402         movwf POCATEK_FAT3
02A7   0A84           00403         incf FSR,F
02A8   0800           00404         movfw INDF
02A9   00C7           00405         movwf POCATEK_FAT4
02AA   0A84           00406         incf FSR,F
                      00407 
                      00408         ; v POCATEK_DAT ted mame hodnotu "velikost fat", tu vynasobime 2 a pricteme POCATEK_FAT. Tak zis
                            kame POCATEK_DAT
02AB   30A0           00409         movlw 0xA0                                      ; OPERAND_X
02AC   0084           00410         movwf FSR
02AD   0840           00411         movfw POCATEK_DAT1
02AE   0080           00412         movwf INDF
02AF   0A84           00413         incf FSR,F
02B0   0841           00414         movfw POCATEK_DAT2
02B1   0080           00415         movwf INDF
02B2   0A84           00416         incf FSR,F
02B3   0842           00417         movfw POCATEK_DAT3
02B4   0080           00418         movwf INDF
02B5   0A84           00419         incf FSR,F
02B6   0843           00420         movfw POCATEK_DAT4
02B7   0080           00421         movwf INDF
02B8   0A84           00422         incf FSR,F
02B9   2???           00423         call POSUNDOLEVA_1                      ; X := X * 2 -> POCATEK_DAT := 2 * "velikost fat"
                      00424                                                                 ; ted jeste staci pricist POCATEK_FAT
02BA   0844           00425         movfw POCATEK_FAT1
02BB   0080           00426         movwf INDF
02BC   0A84           00427         incf FSR,F
02BD   0845           00428         movfw POCATEK_FAT2
02BE   0080           00429         movwf INDF
02BF   0A84           00430         incf FSR,F
02C0   0846           00431         movfw POCATEK_FAT3
02C1   0080           00432         movwf INDF
02C2   0A84           00433         incf FSR,F
02C3   0847           00434         movfw POCATEK_FAT4
02C4   0080           00435         movwf INDF
02C5   0A84           00436         incf FSR,F
02C6   2???           00437         call SOUCET
MPASM 03.90 Released                                  MP3.ASM   12-16-2005  14:37:50         PAGE 29


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00438 
                      00439         ;   tady je pro me jedna zcela nepochopitelna vlastnost FATky, a to to, ze prvni dva zaznamy (nu
                            lty a prvni)
                      00440         ;   ve FAT tabulce jsou obsazeny nejakyma srotama (identifikator FATky), coz by nebylo to nejhor
                            si, ale data na disku
                      00441         ;   zacinaji jiz na nultym clusteru. (POCATEK_DAT) Dochazi tedy k tomu, ze nulty cluster na disk
                            u je reprezentovan na druhe
                      00442         ;   pozici ve fatce a to cislem dve!!! Od udaje ve fatce bychom musime tedy vzdy odecist hodnotu
                             2
                      00443         ;   a ziskali bychom skutecnou polohu dat na disku.... (Je to pekne na vyliz!!!!!!!!)
                      00444         ;   Ja to tady resim tak, ze zacatek dat posunu o 2 clustery niz (POCATEK_DAT := POCATEK_DAT - 2
                            *VELIKOST_CLUSTERU),
                      00445         ;   aby udaje souhlasily a my nemuseli nic prepocitavat. 
                      00446         ;   Pak tu nastava jeste jeden problem, ROOT adresar byva adresovan jako by byl na clusteru 0, p
                            roto pokazdy kdyz je 
                      00447         ;   nekde cislo clusteru 0, tak skocime na prvni cluster root adresare. (Vetsinou 2. cluster)
                      00448         ;   O tomto jevu jsem nikde necetl, ale proste to tak je. Z toho vyplyva, ze zadny soubor nemuze
                             byt na slusteru 1...
                      00449         
                      00450         ; Tak ted mame v POCATEK_DAT = POCATEK_FAT + (velikostFat * 2)
                      00451         ; a ted jeste musime odecist 2 * velikost_clusteru
                      00452 
02C7   0D4C           00453         rlf CLUSTER_SIZE,W              ; W := CLUSTER_SIZE * 2
                      00454         BANK_1
02C8   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
02C9   1683               M                 bsf     STATUS,RP0    
02CA   00A4           00455         movwf OPERAND_Y1
02CB   01A5           00456         clrf OPERAND_Y2
02CC   01A6           00457         clrf OPERAND_Y3
02CD   01A7           00458         clrf OPERAND_Y4
02CE   0828           00459         movfw VYSLEDEK1
02CF   00A0           00460         movwf OPERAND_X1
02D0   0829           00461         movfw VYSLEDEK2
02D1   00A1           00462         movwf OPERAND_X2
02D2   082A           00463         movfw VYSLEDEK3
02D3   00A2           00464         movwf OPERAND_X3
02D4   082B           00465         movfw VYSLEDEK4
02D5   00A3           00466         movwf OPERAND_X4
                      00467         BANK_0
02D6   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
02D7   1283               M                 bcf     STATUS,RP0    
02D8   2???           00468         call ROZDIL                             ; VYSLEDEK := POCATEK_FAT + (2 * velikostFat) - (2 * CLU
                            STER_SIZE)
02D9   0800           00469         movfw INDF
02DA   00C0           00470         movwf POCATEK_DAT1
02DB   0A84           00471         incf FSR,F
02DC   0800           00472         movfw INDF
02DD   00C1           00473         movwf POCATEK_DAT2
02DE   0A84           00474         incf FSR,F
02DF   0800           00475         movfw INDF
02E0   00C2           00476         movwf POCATEK_DAT3
02E1   0A84           00477         incf FSR,F
02E2   0800           00478         movfw INDF
02E3   00C3           00479         movwf POCATEK_DAT4
MPASM 03.90 Released                                  MP3.ASM   12-16-2005  14:37:50         PAGE 30


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

02E4   0A84           00480         incf FSR,F
                      00481         
                      00482         ; Tak ted uz to konecne mame, muzeme se pustit do prohlizeni adresaru a souboru...
                      00483 
02E5   162E           00484         bsf ATA_ATTRIBUTES,FAT32_LOAD   
02E6                  00485 NACTI_FAT32__KONEC
02E6   0008           00486         return  
                      00487 ;**************************************************************************
02E7                  00488 CLUSTER_TO_LBA
                      00489         ; vezme hodnoty v CLUSTER 1-4 a POZICE (sektor v clusteru) a do LBA 1-4 vypocita skutecnou pozic
                            i na disku
                      00490         ; pro spravnou funkci musi byt POZICE < CLUSTER_SIZE (POZICE muze byt v rozsahu 0 .. CLUSTER_SIZ
                            E - 1)
                      00491         ; LBA := POCATEK_DAT + (CLUSTER * CLUSTER_SIZE) + POZICE
                      00492         INDF_BANK_1                             ; neprime adresovani do banku1
02E7   1383               M                         bcf STATUS,IRP    
02E8   30A0           00493         movlw 0xA0                                      ; OPERAND_X
02E9   0084           00494         movwf FSR
02EA   083C           00495         movfw CLUSTER1
02EB   0080           00496         movwf INDF
02EC   0A84           00497         incf FSR,F
02ED   083D           00498         movfw CLUSTER2
02EE   0080           00499         movwf INDF
02EF   0A84           00500         incf FSR,F
02F0   083E           00501         movfw CLUSTER3
02F1   0080           00502         movwf INDF
02F2   0A84           00503         incf FSR,F
02F3   083F           00504         movfw CLUSTER4
02F4   0080           00505         movwf INDF
02F5   0A84           00506         incf FSR,F
                      00507 
                      00508         ; Nejdriv se koukneme zda-li CLUSTER se nerovna 0, to bychom pak vratily 
                      00509         ; pozici na prvnim clusteru root adresare...
02F6   2???           00510         call NULA                                               ; if (X =  0) then PRETECENI := 0 else P
                            RETECENI := 1
                      00511         BANK_1
02F7   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
02F8   1683               M                 bsf     STATUS,RP0    
02F9   182C           00512         btfsc PRETECENI,0
02FA   2???           00513         goto CLUSTER_TO_LBA_NO_ROOT
                      00514         BANK_0
02FB   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
02FC   1283               M                 bcf     STATUS,RP0    
02FD   30A0           00515         movlw 0xA0                                      ; OPERAND_X
02FE   0084           00516         movwf FSR
02FF   0848           00517         movfw ROOT_DIR_CL1
0300   0080           00518         movwf INDF
0301   0A84           00519         incf FSR,F
0302   0849           00520         movfw ROOT_DIR_CL2
0303   0080           00521         movwf INDF
0304   0A84           00522         incf FSR,F
0305   084A           00523         movfw ROOT_DIR_CL3
0306   0080           00524         movwf INDF
0307   0A84           00525         incf FSR,F
MPASM 03.90 Released                                  MP3.ASM   12-16-2005  14:37:50         PAGE 31


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0308   084B           00526         movfw ROOT_DIR_CL4
0309   0080           00527         movwf INDF
030A   0A84           00528         incf FSR,F
                      00529                 
030B                  00530 CLUSTER_TO_LBA_NO_ROOT
                      00531         BANK_0
030B   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
030C   1283               M                 bcf     STATUS,RP0    
                      00532         ; CLUSTER_SIZE je vzdy exponentem 2 (1,2,4,8,16,32), proto tento jednoduchy zapis
030D   18CC           00533         btfsc CLUSTER_SIZE,1            ; 2
030E   2???           00534         call POSUNDOLEVA_1                      ; X := X * 2
030F   194C           00535         btfsc CLUSTER_SIZE,2            ; 4
0310   2???           00536         call POSUNDOLEVA_2                      ; X := X * 4
0311   19CC           00537         btfsc CLUSTER_SIZE,3            ; 8
0312   2???           00538         call POSUNDOLEVA_3                      ; X := X * 8
0313   1A4C           00539         btfsc CLUSTER_SIZE,4            ; 16
0314   2???           00540         call POSUNDOLEVA_4                      ; X := X * 4
0315   1ACC           00541         btfsc CLUSTER_SIZE,5            ; 32
0316   2???           00542         call POSUNDOLEVA_5                      ; X := X * 32
                      00543         
0317   0840           00544         movfw POCATEK_DAT1
0318   0080           00545         movwf INDF                                      ; OPERAND_Y
0319   0A84           00546         incf FSR,F
031A   0841           00547         movfw POCATEK_DAT2
031B   0080           00548         movwf INDF
031C   0A84           00549         incf FSR,F
031D   0842           00550         movfw POCATEK_DAT3
031E   0080           00551         movwf INDF
031F   0A84           00552         incf FSR,F
0320   0843           00553         movfw POCATEK_DAT4
0321   0080           00554         movwf INDF
0322   0A84           00555         incf FSR,F
                      00556 
0323   2???           00557         call SOUCET                                     ; VYSLEDEK := POCATEK_DAT + (CLUSTER * CLUSTER_S
                            IZE)
                      00558 
                      00559         ; zbyva tedy k vysledku pricist POZICE a dat nasledny vysledek do LBA    
0324   083B           00560         movfw POZICE
                      00561         BANK_1
0325   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0326   1683               M                 bsf     STATUS,RP0    
0327   00A4           00562         movwf OPERAND_Y1
0328   01A5           00563         clrf OPERAND_Y2
0329   01A6           00564         clrf OPERAND_Y3
032A   01A7           00565         clrf OPERAND_Y4
032B   0828           00566         movfw VYSLEDEK1
032C   00A0           00567         movwf OPERAND_X1
032D   0829           00568         movfw VYSLEDEK2
032E   00A1           00569         movwf OPERAND_X2
032F   082A           00570         movfw VYSLEDEK3
0330   00A2           00571         movwf OPERAND_X3
0331   082B           00572         movfw VYSLEDEK4
0332   00A3           00573         movwf OPERAND_X4        
                      00574         BANK_0
MPASM 03.90 Released                                  MP3.ASM   12-16-2005  14:37:50         PAGE 32


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0333   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0334   1283               M                 bcf     STATUS,RP0    
0335   2???           00575         call SOUCET
                      00576 
                      00577         INDF_BANK_1                             ; neprime adresovani do banku1
0336   1383               M                         bcf STATUS,IRP    
0337   30A8           00578         movlw 0xA8                                      ; VYSLEDEK
0338   0084           00579         movwf FSR
0339   0800           00580         movfw INDF
033A   00A7           00581         movwf LBA1
033B   0A84           00582         incf FSR,F
033C   0800           00583         movfw INDF
033D   00A8           00584         movwf LBA2
033E   0A84           00585         incf FSR,F
033F   0800           00586         movfw INDF
0340   00A9           00587         movwf LBA3
0341   0A84           00588         incf FSR,F
0342   0800           00589         movfw INDF
0343   00AA           00590         movwf LBA4
0344   0A84           00591         incf FSR,F
                      00592         
0345   0008           00593         return
                      00594 ;**************************************************************************
0346                  00595 NEXT_CLUSTER
                      00596         ; V CLUSTER prijme cislo clusteru, podiva se do FATky na disku a v CLUSTER vrati 
                      00597         ; hodnotu clustru, ktery nasleduje v retezu clusteru.
                      00598         ; Pokud pozadovany cluster byl posledni v retezu vrati v reg. POZICE konstantu FFh
                      00599         ; Pokud soucasny cluster je prazdny (coz by se stat nemelo) vrati taky v POZICE FFh
                      00600         ; Jinak, pokud s vse povede, dame do POZICE 0
                      00601 
                      00602         ; ! PODPROGRAM NETESTUJE ZDA NEBYLO ZADANO VETSI CISLO NEZ JE POCET CLUSTERU !!!
                      00603         
0346   01BB           00604         clrf POZICE
                      00605         ; LBA := [(CLUSTER * 4) / 512 ] + POCATEK_FAT
                      00606         ; LBA := ( CLUSTER / 128 ) + POCATEK_FAT
                      00607         ; offset := CLUSTER mod 128 
                      00608         INDF_BANK_1                             ; neprime adresovani do banku1
0347   1383               M                         bcf STATUS,IRP    
0348   30A0           00609         movlw 0xA0                                      ; OPERAND_X
0349   0084           00610         movwf FSR
034A   083C           00611         movfw CLUSTER1
034B   0080           00612         movwf INDF
034C   0A84           00613         incf FSR,F
034D   083D           00614         movfw CLUSTER2
034E   0080           00615         movwf INDF
034F   0A84           00616         incf FSR,F
0350   083E           00617         movfw CLUSTER3
0351   0080           00618         movwf INDF
0352   0A84           00619         incf FSR,F
0353   083F           00620         movfw CLUSTER4
0354   0080           00621         movwf INDF
                      00622 
                      00623         ; Nejdriv se koukneme zda-li CLUSTER se nerovna 0, to pak musime jako cluster brat prvni cluster
                             ROOT adr.
MPASM 03.90 Released                                  MP3.ASM   12-16-2005  14:37:50         PAGE 33


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0355   2???           00624         call NULA                                               ; if (X =  0) then PRETECENI := 0 else P
                            RETECENI := 1
                      00625         BANK_1
0356   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0357   1683               M                 bsf     STATUS,RP0    
0358   182C           00626         btfsc PRETECENI,0
0359   2???           00627         goto NEXT_CLUSTER_NO_ROOT
                      00628         BANK_0
035A   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
035B   1283               M                 bcf     STATUS,RP0    
035C   30A0           00629         movlw 0xA0                                      ; OPERAND_X
035D   0084           00630         movwf FSR
035E   0848           00631         movfw ROOT_DIR_CL1
035F   0080           00632         movwf INDF
0360   0A84           00633         incf FSR,F
0361   0849           00634         movfw ROOT_DIR_CL2
0362   0080           00635         movwf INDF
0363   0A84           00636         incf FSR,F
0364   084A           00637         movfw ROOT_DIR_CL3
0365   0080           00638         movwf INDF
0366   0A84           00639         incf FSR,F
0367   084B           00640         movfw ROOT_DIR_CL4
0368   0080           00641         movwf INDF
0369   0A84           00642         incf FSR,F
                      00643                 
036A                  00644 NEXT_CLUSTER_NO_ROOT
                      00645         BANK_0
036A   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
036B   1283               M                 bcf     STATUS,RP0    
                      00646         
036C   2???           00647         call POSUNDOPRAVA_7     ; X := X div 128  ; PRETECENI := X mod 128
036D   30AC           00648         movlw 0xAC                                      ; PRETECENI
036E   0084           00649         movwf FSR
036F   0800           00650         movfw INDF
0370   00B6           00651         movwf TEMP1
                      00652 
0371   30A4           00653         movlw 0xA4                                      ; OPERAND_Y
0372   0084           00654         movwf FSR
0373   0844           00655         movfw POCATEK_FAT1
0374   0080           00656         movwf INDF
0375   0A84           00657         incf FSR,F
0376   0845           00658         movfw POCATEK_FAT2
0377   0080           00659         movwf INDF
0378   0A84           00660         incf FSR,F
0379   0846           00661         movfw POCATEK_FAT3
037A   0080           00662         movwf INDF
037B   0A84           00663         incf FSR,F
037C   0847           00664         movfw POCATEK_FAT4
037D   0080           00665         movwf INDF
037E   0A84           00666         incf FSR,F
                      00667 
037F   2???           00668         call SOUCET
                      00669         
0380   0800           00670         movfw INDF                                      ; FSR ukazuje na VYSLEDEK
MPASM 03.90 Released                                  MP3.ASM   12-16-2005  14:37:50         PAGE 34


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0381   00A7           00671         movwf LBA1
0382   0A84           00672         incf FSR,F
0383   0800           00673         movfw INDF
0384   00A8           00674         movwf LBA2
0385   0A84           00675         incf FSR,F
0386   0800           00676         movfw INDF
0387   00A9           00677         movwf LBA3
0388   0A84           00678         incf FSR,F
0389   0800           00679         movfw INDF
038A   00AA           00680         movwf LBA4
038B   0A84           00681         incf FSR,F
                      00682         
038C   01A4           00683         clrf FEATURES
038D   3001           00684         movlw .1
038E   00A6           00685         movwf SECTOR_C
038F   2???           00686         call READ_SECTOR
                      00687 
0390   1003           00688         bcf STATUS,C                            ; TEMP1 := CLUSTER mod 128 (TEMP1 je v intervalu 0..127)
0391   0D36           00689         rlf TEMP1,W                                     ; W := TEMP1 * 2
0392   00B6           00690         movwf TEMP1
0393   39FF           00691         andlw h'FF'
0394   1D03           00692         btfss STATUS,Z
0395   2???           00693         call PRESKOC                            ; pokud je zaznam o clusteru na nulte pozici v sektoru, 
                            nic preskakovat nebudem...
                      00694 
                      00695 
0396   30A0           00696         movlw 0xA0                                      ; OPERAND_X
0397   0084           00697         movwf FSR               
0398   2???           00698         call READ_DATA  
0399   0820           00699         movfw DATA_L
039A   0080           00700         movwf INDF
039B   00BC           00701         movwf CLUSTER1
039C   0A84           00702         incf FSR,F
039D   0821           00703         movfw DATA_H
039E   0080           00704         movwf INDF
039F   00BD           00705         movwf CLUSTER2
03A0   0A84           00706         incf FSR,F      
03A1   2???           00707         call READ_DATA  
03A2   0820           00708         movfw DATA_L
03A3   0080           00709         movwf INDF
03A4   00BE           00710         movwf CLUSTER3
03A5   0A84           00711         incf FSR,F
03A6   0821           00712         movfw DATA_H
03A7   0080           00713         movwf INDF
03A8   00BF           00714         movwf CLUSTER4
03A9   0A84           00715         incf FSR,F
                      00716 
                      00717         ; ted mame hodnotu clusteru ktery nam byl na pocatku predan v reg. CLUSTER, podivame se zda neby
                            l nasledkem 
                      00718         ; nejake chyby prazdny, nebo zda neni posledni v alokacnim retezu
03AA   2???           00719         call NULA                                               ; if (OPERAND_X =  0) then PRETECENI := 
                            0 else PRETECENI := 1
                      00720         BANK_1
03AB   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
MPASM 03.90 Released                                  MP3.ASM   12-16-2005  14:37:50         PAGE 35


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

03AC   1683               M                 bsf     STATUS,RP0    
03AD   182C           00721         btfsc PRETECENI,0
03AE   2???           00722         goto NEXT_CLUSTER_NEPRAZDNY
                      00723         BANK_0
03AF   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
03B0   1283               M                 bcf     STATUS,RP0    
03B1   30FF           00724         movlw h'FF'
03B2   00BB           00725         movwf POZICE
03B3   2???           00726         goto NEXT_CLUSTER_KONEC                 ; Nevim sice jak by se toto mohlo stat, ale cluster byl 
                            prazdny, proto neni jiz co resit..
03B4                  00727 NEXT_CLUSTER_NEPRAZDNY
                      00728         BANK_0
03B4   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
03B5   1283               M                 bcf     STATUS,RP0    
                      00729         ; Ted se podivame zda cluster nebyl posledni v alokacnim retezu -> cluster >= 0x0FFFFFF7
03B6   30F7           00730         movlw 0xF7
03B7   0080           00731         movwf INDF
03B8   0A84           00732         incf FSR,F
03B9   30FF           00733         movlw 0xFF
03BA   0080           00734         movwf INDF
03BB   0A84           00735         incf FSR,F
03BC   30FF           00736         movlw 0xFF
03BD   0080           00737         movwf INDF
03BE   0A84           00738         incf FSR,F
03BF   300F           00739         movlw 0x0F
03C0   0080           00740         movwf INDF
03C1   0A84           00741         incf FSR,F
                      00742         
03C2   2???           00743         call ROZDIL                                             ; VYSLEDEK := X - Y 
                      00744                                                                         ; pri podteceni PRETECENI = 1 ( 
                            VYSLEDEK < 0 => PRETECENI = 1 )
                      00745         BANK_1
03C3   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
03C4   1683               M                 bsf     STATUS,RP0    
03C5   182C           00746         btfsc PRETECENI,0
03C6   2???           00747         goto NEXT_CLUSTER_KONEC
                      00748         BANK_0
03C7   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
03C8   1283               M                 bcf     STATUS,RP0    
03C9   30FF           00749         movlw h'FF'
03CA   00BB           00750         movwf POZICE
03CB                  00751 NEXT_CLUSTER_KONEC
                      00752         BANK_0
03CB   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
03CC   1283               M                 bcf     STATUS,RP0    
03CD   0008           00753         return
                      00754 ;**************************************************************************
03CE                  00755 FILE_INFO
                      00756         ; z disku nam ted ma prijit 32bytu dat, ktere reprezentuji jeden zaznam ve slozce
                      00757         ; tato procedura zaznam precte, analyzuje, a do bufferu 2 da nasledujici informace:
                      00758         ;               1.     byte -> = 00h -> zaznam je prazdny; = 01h -> zaznam je adresar; 02h -> za
                            znam je soubor; 06h -> zaznam je soubor s priponou MP3
                      00759         ;               2..9   byte -> 8 znaku dlouhe jmeno ("DOSovsky" tvar - napr. slouzka "dokumenty"
                             = "DOKUME~1" )
MPASM 03.90 Released                                  MP3.ASM   12-16-2005  14:37:50         PAGE 36


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00760         ;               10..12 byte -> u souboru tri znaky pripony (u adresaru vetsinou mezery - 20h 20h
                             20h)
                      00761         ;               13..16 byte -> 1. cluster souboru
                      00762         ; Pokud se jedna o adresar, a zaznam o pripone se nerovna 0x202020 (tri mezery), tak skutecne jm
                            eno adresare je : ADRESAR.PRI
                      00763         INDF_BANK_2
03CE   1783               M                         bsf STATUS,IRP    
03CF   3010           00764         movlw 0x10                                      ; 1. byte bufferu 2
03D0   0084           00765         movwf FSR
03D1   3000           00766         movlw .0                                        ; zatim nevime co zaznam obsahuje, tak ho oznaci
                            me jako prazdny
03D2   0080           00767         movwf INDF
03D3   0A84           00768         incf FSR,F      
                      00769 
03D4   3005           00770         movlw .5                                        ; 5 slov = 10 bytu -> 8 znaku jmena souboru/sloz
                            ky + 2 znaky pripony
03D5   00B6           00771         movwf TEMP1
03D6                  00772 FILE_INFO__READ_NAME
03D6   2???           00773         call READ_DATA                          ; 2 znaky jmena souboru/slozky, nebo pripony souboru
03D7   0820           00774         movfw DATA_L
03D8   0080           00775         movwf INDF
03D9   0A84           00776         incf FSR,F
03DA   0821           00777         movfw DATA_H
03DB   0080           00778         movwf INDF
03DC   0A84           00779         incf FSR,F
03DD   03B6           00780         decf TEMP1,F
03DE   1D03           00781         btfss STATUS,Z
03DF   2???           00782         goto FILE_INFO__READ_NAME       
                      00783 
03E0   2???           00784         call READ_DATA                          ; posledni znak pripony a byt s atributy souboru
03E1   0820           00785         movfw DATA_L
03E2   0080           00786         movwf INDF
                      00787 
03E3   3011           00788         movlw 0x11                                      ; 2. byte bufferu 2 -> 1. znak jmena souboru
03E4   0084           00789         movwf FSR
03E5   0800           00790         movfw INDF                                      ; ted ve W mame 1. znak jmena souboru/slozky
03E6   39FF           00791         andlw h'FF'
03E7   1903           00792         btfsc STATUS,Z
03E8   2???           00793         goto FILE_INFO__KONEC           ; pokud 1. znak jmena souboru = 00h, je zaznam prazdny
03E9   3CE5           00794         sublw h'E5'
03EA   1903           00795         btfsc STATUS,Z
03EB   2???           00796         goto FILE_INFO__KONEC           ; pokud 1. znak jmena souboru = E5h, je zaznam prazdny
                      00797         
                      00798         ; pokud jsme tady, tak zaznam obsahuje soubor, adresar, dlouhe jmeno souboru, nebo jmenovku disk
                            u 
                      00799         ; (jsou dva zpusoby jak zapsat jmenovku svazku, bud do spousteciho zaznamu, nebo jako polozku RO
                            OT adresare)
03EC   0821           00800         movfw DATA_H                            ; byt s atributy souboru
03ED   390F           00801         andlw h'0F'
03EE   3C0F           00802         sublw h'0F'                                     ; if (atributy and 0Fh) = 0Fh -> zaznam s dlouhy
                            m nazvem souboru
03EF   1903           00803         btfsc STATUS,Z
03F0   2???           00804         goto FILE_INFO__KONEC           ; pokud zaznam je dlouhy nazav souboru, koncime
03F1   19A1           00805         btfsc DATA_H,3
MPASM 03.90 Released                                  MP3.ASM   12-16-2005  14:37:50         PAGE 37


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

03F2   2???           00806         goto FILE_INFO__KONEC           ; if (atributy and 08h) = 08h -> jmenovka disku
03F3   1A21           00807         btfsc DATA_H,4                          ; if (atributy and 16h) = 16h -> adresar
03F4   2???           00808         goto FILE_INFO__DIR
                      00809 
03F5   3002           00810         movlw h'02'                                     ; zaznam je soubor
03F6   00B6           00811         movwf TEMP1
                      00812         ; tady vime, ze zaznam je soubor, tak se podivame, zda to neni mp3
03F7   3019           00813         movlw 0x19                                      ; 10. byt bufferu 2 -> 1. znak pripony souboru
03F8   0084           00814         movwf FSR
                      00815 
03F9   0800           00816         movfw INDF
03FA   3C4D           00817         sublw 'M'                                       ; (jmena souboru v "DOSovskem" tvaru maji vzdy v
                            elka pismena)
03FB   1D03           00818         btfss STATUS,Z
03FC   2???           00819         goto FILE_INFO__FILE
03FD   0A84           00820         incf FSR,F
03FE   0800           00821         movfw INDF
03FF   3C50           00822         sublw 'P'
0400   1D03           00823         btfss STATUS,Z
0401   2???           00824         goto FILE_INFO__FILE
0402   0A84           00825         incf FSR,F
0403   0800           00826         movfw INDF
0404   3C33           00827         sublw '3'
0405   1D03           00828         btfss STATUS,Z
0406   2???           00829         goto FILE_INFO__FILE
                      00830 
0407   3006           00831         movlw h'06'                                     ; ted je jasne, ze soubor je mp3
0408   00B6           00832         movwf TEMP1
0409   2???           00833         goto FILE_INFO__FILE
                      00834 
040A                  00835 FILE_INFO__DIR
040A   3001           00836         movlw h'01'                                     ; zaznam je adresar
040B   00B6           00837         movwf TEMP1
                      00838 
040C                  00839 FILE_INFO__FILE
                      00840         ; tady mame v TEMP 1 jednu z nasledujicich hodnot:
                      00841         ; 01h -> zaznam je adresar; 02h -> zaznam je soubor; 06h -> zaznam je soubor s priponou MP3
040C   3010           00842         movlw 0x10                                      ; 1. byt bufferu 2 -> identifikace zaznamu
040D   0084           00843         movwf FSR
040E   0836           00844         movfw TEMP1
040F   0080           00845         movwf INDF
                      00846 
0410   3004           00847         movlw .4
0411   00B6           00848         movwf TEMP1
0412   2???           00849         call PRESKOC                            ; nasledujicich 8 bytu ze zaznamu je pro nas k nicemu (o
                            bsahuji cas posledni upravy, otevreni a buh vi co jeste...)
                      00850 
0413   301E           00851         movlw 0x1E                                      ; 15. byt bufferu 2 -> 2. byt prvniho clusteru
0414   0084           00852         movwf FSR
0415   2???           00853         call READ_DATA                          ; jedno slovo -> horni cast cisla prvniho clusteru
0416   0820           00854         movfw DATA_L
0417   0080           00855         movwf INDF
0418   0A84           00856         incf FSR,F
0419   0821           00857         movfw DATA_H
MPASM 03.90 Released                                  MP3.ASM   12-16-2005  14:37:50         PAGE 38


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

041A   0080           00858         movwf INDF
                      00859 
041B   2???           00860         call READ_DATA                          ; cas vytvoreni   (1 word)
041C   2???           00861         call READ_DATA                          ; datum vytvoreni (1 word)
                      00862 
041D   301C           00863         movlw 0x1C                                      ; 13. byt bufferu 2 -> 0. byt prvniho clusteru
041E   0084           00864         movwf FSR
041F   2???           00865         call READ_DATA                          ; jedno slovo -> dolni cast cisla prvniho clusteru
0420   0820           00866         movfw DATA_L
0421   0080           00867         movwf INDF
0422   0A84           00868         incf FSR,F
0423   0821           00869         movfw DATA_H
0424   0080           00870         movwf INDF
                      00871         
                      00872         ; Pak jsou v zaznamu jeste 4 byty, ktere obsahuji velikost souboru. Ty mi ale nepotrebujeme...  
0425                  00873 FILE_INFO__KONEC
0425   0008           00874         return
                      00875 ;**************************************************************************
0426                  00876 FILE_SIZE
                      00877         ; z disku nam ted ma prijit 32bytu dat, ktere reprezentuji jeden zaznam ve slozce
                      00878         ; Zaznam by mel byt soubor, podprogram toto nekontroluje (zda zaznam neni adresar)
                      00879         ; Na zacatek bufferu 1 da 4 byty obsahujici velikost zaznamu
0426   300E           00880         movlw .14                                       ; my ted potrebujeme jen posledni 4 byty ze zazn
                            amu, tam se nachazi velikost souboru
0427   00B6           00881         movwf TEMP1
0428   2???           00882         call PRESKOC
                      00883 
                      00884         INDF_BANK_2
0429   1783               M                         bsf STATUS,IRP    
042A   3010           00885         movlw 0x10                                      ; 1. byte bufferu 1
042B   0084           00886         movwf FSR
                      00887 
042C   2???           00888         call READ_DATA
042D   0820           00889         movfw DATA_L
042E   0080           00890         movwf INDF
042F   0A84           00891         incf FSR,F
0430   0821           00892         movfw DATA_H
0431   0080           00893         movwf INDF
0432   0A84           00894         incf FSR,F
                      00895 
0433   2???           00896         call READ_DATA
0434   0820           00897         movfw DATA_L
0435   0080           00898         movwf INDF
0436   0A84           00899         incf FSR,F
0437   0821           00900         movfw DATA_H
0438   0080           00901         movwf INDF
0439   0A84           00902         incf FSR,F
                      00903 
043A   0008           00904         return
                      00905 ;**************************************************************************
                      00053         include "vs1001.asm"    ; podprogramy na ovladani mp3 decoderu
                      00001 ;**********************************************************
                      00002 ;**********************************************************
                      00003 ;**********************************************************
MPASM 03.90 Released                                  MP3.ASM   12-16-2005  14:37:50         PAGE 39


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00004 ; OBSLUZNE PODPROGRAMY PRO MP3 DECODER vs1001g
                      00005 ;**********************************************************
                      00006 ;**********************************************************
                      00007 ;**********************************************************
                      00008 
                      00009 ; MP3_PORT              
                      00010 ; MP3_PORT_TRIS 
                      00011 
                      00012 ; BITY MP3_PORT
                      00013 ; #define MP3_SO                MP3_PORT,0      ; serial output - tady dostavame z dekoderu data
                      00014 ; #define MP3_SI                MP3_PORT,1      ; serial input  - pokud MP3_CS=1, tak posilame mp3 data,
                             pokud =0, tak posilame prikaz
                      00015 ; #define MP3_SCLK              MP3_PORT,2      ; clock - nabezna hrana urcuje platnost dat pri seriovem
                             prenosu
                      00016 ; #define MP3_CS                MP3_PORT,3      ; cable select  - pokud MP3_CS=1, tak po SI posilame mp3
                             data, pokud =0, tak posilame prikaz
                      00017 ; #define MP3_DREQ              MP3_PORT,4      ; data request  - pokud =1, tak dekoder pozaduje dalsi m
                            p3 data (vic jak 32B)
                      00018 ; #define MP3_BSYNC             MP3_PORT,5      ; pro synchronizaci - ma byt nastaven pri prvnim prenase
                            nem bitu kazdeho bytu
                      00019 
                      00020 ;**********************************************************
                      00021 ; co nejrychleji vodesle hodnotu ve W smerem k dekoderu (obsluhuje signaly DSYNC, SI, SCLK)
043B                  00022 VS_WR_BYTE
                      00023         ; k praci pouziva TEMPW
043B   00B5           00024         movwf TEMPW             ; dato co mame odeslat si hodime do tempu...
                      00025 
043C   1685           00026         bsf MP3_BSYNC   ; bude nasledovat prvni bit bytu, proto nastavime BSYNC
                      00027 
                      00028         ; 7. bit bytu
043D   1105           00029         bcf MP3_SCLK    ; shodime SCLK
043E   1085           00030         bcf MP3_SI              ; nevime zda bit bude 0 nebo 1, SI nulujeme
043F   0DB5           00031         rlf TEMPW,f             ; odesilame od nejvyssiho bitu k nejnizsimu
0440   1803           00032         btfsc STATUS,C
0441   1485           00033         bsf MP3_SI
0442   1505           00034         bsf MP3_SCLK
0443   1285           00035         bcf MP3_BSYNC
                      00036         
                      00037         ; 6. bit bytu
0444   1105           00038         bcf MP3_SCLK    ; shodime SCLK
0445   1085           00039         bcf MP3_SI              ; nevime zda bit bude 0 nebo 1, SI nulujeme
0446   0DB5           00040         rlf TEMPW,f             ; odesilame od nejvyssiho bitu k nejnizsimu
0447   1803           00041         btfsc STATUS,C
0448   1485           00042         bsf MP3_SI
0449   1505           00043         bsf MP3_SCLK
                      00044 
                      00045         ; 5. bit bytu
044A   1105           00046         bcf MP3_SCLK    ; shodime SCLK
044B   1085           00047         bcf MP3_SI              ; nevime zda bit bude 0 nebo 1, SI nulujeme
044C   0DB5           00048         rlf TEMPW,f             ; odesilame od nejvyssiho bitu k nejnizsimu
044D   1803           00049         btfsc STATUS,C
044E   1485           00050         bsf MP3_SI
044F   1505           00051         bsf MP3_SCLK
                      00052 
MPASM 03.90 Released                                  MP3.ASM   12-16-2005  14:37:50         PAGE 40


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00053         ; 4. bit bytu
0450   1105           00054         bcf MP3_SCLK    ; shodime SCLK
0451   1085           00055         bcf MP3_SI              ; nevime zda bit bude 0 nebo 1, SI nulujeme
0452   0DB5           00056         rlf TEMPW,f             ; odesilame od nejvyssiho bitu k nejnizsimu
0453   1803           00057         btfsc STATUS,C
0454   1485           00058         bsf MP3_SI
0455   1505           00059         bsf MP3_SCLK
                      00060 
                      00061         ; 3. bit bytu
0456   1105           00062         bcf MP3_SCLK    ; shodime SCLK
0457   1085           00063         bcf MP3_SI              ; nevime zda bit bude 0 nebo 1, SI nulujeme
0458   0DB5           00064         rlf TEMPW,f             ; odesilame od nejvyssiho bitu k nejnizsimu
0459   1803           00065         btfsc STATUS,C
045A   1485           00066         bsf MP3_SI
045B   1505           00067         bsf MP3_SCLK
                      00068 
                      00069         ; 2. bit bytu
045C   1105           00070         bcf MP3_SCLK    ; shodime SCLK
045D   1085           00071         bcf MP3_SI              ; nevime zda bit bude 0 nebo 1, SI nulujeme
045E   0DB5           00072         rlf TEMPW,f             ; odesilame od nejvyssiho bitu k nejnizsimu
045F   1803           00073         btfsc STATUS,C
0460   1485           00074         bsf MP3_SI
0461   1505           00075         bsf MP3_SCLK
                      00076 
                      00077         ; 1. bit bytu
0462   1105           00078         bcf MP3_SCLK    ; shodime SCLK
0463   1085           00079         bcf MP3_SI              ; nevime zda bit bude 0 nebo 1, SI nulujeme
0464   0DB5           00080         rlf TEMPW,f             ; odesilame od nejvyssiho bitu k nejnizsimu
0465   1803           00081         btfsc STATUS,C
0466   1485           00082         bsf MP3_SI
0467   1505           00083         bsf MP3_SCLK
                      00084 
                      00085         ; 0. bit bytu
0468   1105           00086         bcf MP3_SCLK    ; shodime SCLK
0469   1085           00087         bcf MP3_SI              ; nevime zda bit bude 0 nebo 1, SI nulujeme
046A   0DB5           00088         rlf TEMPW,f             ; odesilame od nejvyssiho bitu k nejnizsimu
046B   1803           00089         btfsc STATUS,C
046C   1485           00090         bsf MP3_SI
046D   1505           00091         bsf MP3_SCLK
                      00092 
046E   1105           00093         bcf MP3_SCLK
046F   0008           00094         return
                      00095 ;**********************************************************
                      00096 ; do TEMP1 dame adresu registru 
                      00097 ; do TEMP2 dame dolni slabiku zapisovaneho slova
                      00098 ; do TEMP3 dame horni slabiku zapisovaneho slova
0470                  00099 VS_WR_REG       ; zapise 16bitove slovo (TEMP2,TEMP3) do registru mp3 dekoderu (TEMP1)
                      00100                         ; 16bit dato se odesila od nejvyssiho bitu (15,14...8,7...1,0)
                      00101                         ; kde TEMP5 = bity 15-8 ; TEMP4 = bity 7-0
                      00102 ; pri praci pouziva TEMP1, TEMP2, TEMP3, TEMPW
0470   1185           00103         bcf MP3_CS                      ; po SI posilame prikaz
0471   3002           00104         movlw b'00000010'       ; write
0472   2???           00105         call VS_WR_BYTE 
0473   0836           00106         movfw TEMP1                     ; adresa zapisovaneho registru
MPASM 03.90 Released                                  MP3.ASM   12-16-2005  14:37:50         PAGE 41


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0474   2???           00107         call VS_WR_BYTE
0475   0838           00108         movfw TEMP3             ; horni slabika
0476   2???           00109         call VS_WR_BYTE
0477   0837           00110         movfw TEMP2             ; dolni slabika
0478   2???           00111         call VS_WR_BYTE
0479   1585           00112         bsf MP3_CS
047A   0008           00113         return
                      00114 ;**********************************************************
047B                  00115 VS_SOFT_RESET   ; provede softwarovy reset dekoderu (pri zapnuti a pote po skonceni kazde mp3)
047B   2???           00116         call DELAY_200ms
                      00117 
047C   3000           00118         movlw VSADDR_MODE
047D   00B6           00119         movwf TEMP1
047E   154D           00120         bsf VSREG_MODE_L,2      ; soft reset=1
047F   084D           00121         movfw VSREG_MODE_L
0480   00B7           00122         movwf TEMP2
0481   3000           00123         movlw .0                        ; MODE_H
0482   00B8           00124         movwf TEMP3
0483   2???           00125         call VS_WR_REG
                      00126 
0484   2???           00127         call DELAY_2ms
0485   2???           00128         call VS_SEND_1024_NULL  
                      00129 
0486   0008           00130         return  
                      00131 ;**********************************************************
0487                  00132 VS_SEND_32_NULL
0487   2???           00133         call WAIT_FOR_VSDREQ
0488   3020           00134         movlw .32
0489   00B7           00135         movwf TEMP2
                      00136         
048A   3000           00137         movlw .0
048B   2???           00138         call VS_WR_BYTE
048C   0BB7           00139         decfsz TEMP2,F
048D   2???           00140         goto $-3
048E   0008           00141         return
                      00142 ;**********************************************************
048F                  00143 VS_SEND_1024_NULL
048F   1585           00144         bsf MP3_CS                      ; po SI posilam data
0490   3020           00145         movlw .32
0491   00B6           00146         movwf TEMP1
                      00147 
0492   2???           00148         call VS_SEND_32_NULL
0493   0BB6           00149         decfsz TEMP1,F
0494   2???           00150         goto $-2
                      00151          
0495   0008           00152         return
                      00153 ;**********************************************************
0496                  00154 VS_SET_VOLUME
0496   300B           00155         movlw VSADDR_VOL
0497   00B6           00156         movwf TEMP1
                      00157 
0498   084F           00158         movfw VSREG_VOL_L
0499   00B7           00159         movwf TEMP2
049A   0850           00160         movfw VSREG_VOL_H
MPASM 03.90 Released                                  MP3.ASM   12-16-2005  14:37:50         PAGE 42


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

049B   00B8           00161         movwf TEMP3
049C   2???           00162         call VS_WR_REG
049D   0008           00163         return          
                      00164 ;**********************************************************
049E                  00165 WAIT_FOR_VSDREQ
049E   1E05           00166         btfss MP3_DREQ
049F   2???           00167         goto WAIT_FOR_VSDREQ
04A0   0008           00168         return
                      00169 ;**********************************************************
04A1                  00170 VS_BEEP
04A1   2???           00171         call WAIT_FOR_VSDREQ
                      00172 
04A2   1585           00173         bsf MP3_CS                      ; po SI posilam data
04A3   3053           00174         movlw h'53'
04A4   2???           00175         call VS_WR_BYTE
04A5   30EF           00176         movlw h'EF'
04A6   2???           00177         call VS_WR_BYTE
04A7   306E           00178         movlw h'6E'
04A8   2???           00179         call VS_WR_BYTE
04A9   303E           00180         movlw .62                       ; ctyr bytova testovaci sekvence. Tento posledni byte znamena, 
04AA   2???           00181         call VS_WR_BYTE         ; ze s pouzitim vzorkovaci frekvence 16kHz bude generovan ton 1kHz
04AB   3000           00182         movlw .0
04AC   2???           00183         call VS_WR_BYTE
04AD   3000           00184         movlw .0
04AE   2???           00185         call VS_WR_BYTE
04AF   3000           00186         movlw .0
04B0   2???           00187         call VS_WR_BYTE
04B1   3000           00188         movlw .0                        ; testovaci kod musi byt nasledovan 4 nulamy
04B2   2???           00189         call VS_WR_BYTE
                      00190 
04B3   2???           00191         call DELAY_200ms        ; nimusovku nechame zapnutou 200ms
                      00192 
04B4   2???           00193         call WAIT_FOR_VSDREQ
                      00194 
04B5   3045           00195         movlw h'45'
04B6   2???           00196         call VS_WR_BYTE
04B7   3078           00197         movlw h'78'
04B8   2???           00198         call VS_WR_BYTE
04B9   3069           00199         movlw h'69'
04BA   2???           00200         call VS_WR_BYTE
04BB   3074           00201         movlw h'74'                     ; odeslanim tohoto kodu sinusovku ukoncime...
04BC   2???           00202         call VS_WR_BYTE
04BD   3000           00203         movlw .0
04BE   2???           00204         call VS_WR_BYTE
04BF   3000           00205         movlw .0
04C0   2???           00206         call VS_WR_BYTE
04C1   3000           00207         movlw .0
04C2   2???           00208         call VS_WR_BYTE
04C3   3000           00209         movlw .0
04C4   2???           00210         call VS_WR_BYTE
                      00211 
04C5   2???           00212         call VS_SOFT_RESET
04C6   0008           00213         return
                      00214 ;**********************************************************
MPASM 03.90 Released                                  MP3.ASM   12-16-2005  14:37:50         PAGE 43


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

04C7                  00215 VS_INIT
04C7   01CD           00216         clrf VSREG_MODE_L
04C8   01CE           00217         clrf VSREG_STATUS_L
04C9   01CF           00218         clrf VSREG_VOL_L                ; VOL=0 => maximalni hlasitost
04CA   01D0           00219         clrf VSREG_VOL_H
                      00220 
04CB   2???           00221         call VS_SOFT_RESET              ; resetujeme
04CC   2???           00222         call VS_SET_VOLUME              ; nastavime hlasitost
                      00223 
04CD   2???           00224         call VS_BEEP                    ; dvakrat za sebou pipneme
04CE   2???           00225         call DELAY_200ms
04CF   2???           00226         call VS_BEEP
                      00227         
04D0   0008           00228         return
                      00229 ;**********************************************************
                      00054         include "aritmetic.asm" ; podprogramy vykonavajici zakladni aritmetologicke operace
                      00001 ;**********************************************************
                      00002 ;**********************************************************
                      00003 ;**********************************************************
                      00004 ; Obsahuje podrogramy realizujici zakladni aritmeticke operace
                      00005 ; pouzivane v mp3 preprcavaci. Vsechny operace se provadi 
                      00006 ; s 32bitovymi cisly.
                      00007 ; 
                      00008 ; Pro praci aritmetickych procedur je rezervovana BANKA 1 !!!!!
                      00009 ;**********************************************************
                      00010 ;**********************************************************
                      00011 ;**********************************************************
04D1                  00012 SOUCET
                      00013 ; provede soucet hodnoty v registrech OPERAND_X[1..4] 
                      00014 ; s hodnotou v OPERAND_Y[1..4] a umisti do VYSLEDEK[1..4] 
                      00015 ; pokud dojde k preteceni, nastavi se PRETECENI do 1
                      00016 ; (byty s indexem 1 maji nejnizsi vahu)
                      00017         BANK_1
04D1   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
04D2   1683               M                 bsf     STATUS,RP0    
04D3   01AC           00018         clrf PRETECENI
                      00019 
04D4   0820           00020         movfw OPERAND_X1
04D5   0724           00021         addwf OPERAND_Y1,W
04D6   00A8           00022         movwf VYSLEDEK1
04D7   1803           00023         btfsc STATUS,C
04D8   14AC           00024                 bsf PRETECENI,1
                      00025 
04D9   0821           00026         movfw OPERAND_X2
04DA   0725           00027         addwf OPERAND_Y2,W
04DB   00A9           00028         movwf VYSLEDEK2
04DC   1803           00029         btfsc STATUS,C
04DD   142C           00030                 bsf PRETECENI,0
04DE   18AC           00031         btfsc PRETECENI,1
04DF   0AA9           00032                 incf VYSLEDEK2,F
04E0   1803           00033         btfsc STATUS,C
04E1   142C           00034                 bsf PRETECENI,0
04E2   10AC           00035         bcf PRETECENI,1
                      00036 
MPASM 03.90 Released                                  MP3.ASM   12-16-2005  14:37:50         PAGE 44


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

04E3   0822           00037         movfw OPERAND_X3
04E4   0726           00038         addwf OPERAND_Y3,W
04E5   00AA           00039         movwf VYSLEDEK3
04E6   1803           00040         btfsc STATUS,C
04E7   14AC           00041                 bsf PRETECENI,1
04E8   182C           00042         btfsc PRETECENI,0
04E9   0AAA           00043                 incf VYSLEDEK3,F
04EA   1803           00044         btfsc STATUS,C
04EB   14AC           00045                 bsf PRETECENI,1
04EC   102C           00046         bcf PRETECENI,0
                      00047 
04ED   0823           00048         movfw OPERAND_X4
04EE   0727           00049         addwf OPERAND_Y4,W
04EF   00AB           00050         movwf VYSLEDEK4
04F0   1803           00051         btfsc STATUS,C
04F1   142C           00052                 bsf PRETECENI,0
04F2   18AC           00053         btfsc PRETECENI,1
04F3   0AAB           00054                 incf VYSLEDEK4,F
04F4   1803           00055         btfsc STATUS,C
04F5   142C           00056                 bsf PRETECENI,0
04F6   10AC           00057         bcf PRETECENI,1 
                      00058 
                      00059         BANK_0
04F7   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
04F8   1283               M                 bcf     STATUS,RP0    
04F9   0008           00060         return
                      00061 ;**********************************************************
                      00062 ;**********************************************************
04FA                  00063 ROZDIL  ; VYSLEDEK := X - Y
                      00064                 ; pri podteceni PRETECENI = 1 ( VYSLEDEK < 0 => PRETECENI = 1 )
                      00065         BANK_1
04FA   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
04FB   1683               M                 bsf     STATUS,RP0    
04FC   01AC           00066         clrf PRETECENI
                      00067 
04FD   0824           00068         movfw OPERAND_Y1
04FE   0220           00069         subwf OPERAND_X1,W      ; W = X - Y     
04FF   00A8           00070         movwf VYSLEDEK1
0500   1C03           00071         btfss STATUS,C
0501   14AC           00072                 bsf PRETECENI,1
                      00073         
0502   0825           00074         movfw OPERAND_Y2
0503   0221           00075         subwf OPERAND_X2,W      ; W = X - Y     
0504   00A9           00076         movwf VYSLEDEK2
0505   1C03           00077         btfss STATUS,C
0506   142C           00078                 bsf PRETECENI,0
0507   18AC           00079         btfsc PRETECENI,1
0508   03A9           00080                 decf VYSLEDEK2,F
0509   1C03           00081         btfss STATUS,C
050A   142C           00082                 bsf PRETECENI,0
050B   10AC           00083         bcf PRETECENI,1 
                      00084         
050C   0826           00085         movfw OPERAND_Y3
050D   0222           00086         subwf OPERAND_X3,W      ; W = X - Y     
MPASM 03.90 Released                                  MP3.ASM   12-16-2005  14:37:50         PAGE 45


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

050E   00AA           00087         movwf VYSLEDEK3
050F   1C03           00088         btfss STATUS,C
0510   14AC           00089                 bsf PRETECENI,1
0511   182C           00090         btfsc PRETECENI,0
0512   03AA           00091                 decf VYSLEDEK3,F
0513   1C03           00092         btfss STATUS,C
0514   14AC           00093                 bsf PRETECENI,1
0515   102C           00094         bcf PRETECENI,0
                      00095         
0516   0827           00096         movfw OPERAND_Y4
0517   0223           00097         subwf OPERAND_X4,W      ; W = X - Y     
0518   00AB           00098         movwf VYSLEDEK4
0519   1C03           00099         btfss STATUS,C
051A   142C           00100                 bsf PRETECENI,0
051B   18AC           00101         btfsc PRETECENI,1
051C   03AB           00102                 decf VYSLEDEK4,F
051D   1C03           00103         btfss STATUS,C
051E   142C           00104                 bsf PRETECENI,0
051F   10AC           00105         bcf PRETECENI,1 
                      00106         
                      00107         BANK_0
0520   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0521   1283               M                 bcf     STATUS,RP0    
0522   0008           00108         return
                      00109 ;**********************************************************
0523                  00110 POSUNDOLEVA     ; X := (X * 2) mod 0xFFFFFFFF , PRETECENI := (X * 2) div 0xFFFFFFFF
                      00111                         ; tento podprogram nepouzivat, primo v hlavnim programu
                      00112                         ; musi se nastavit BANK_1 a vymazat PRETECENI!!!
                      00113                         ; (je pouze pro pouziti v nasobicich podprogramech)
                      00114                         ; pouzivat jen POSUNDOLEVA_1, 2, 3, 4 
0523   0DA0           00115         rlf OPERAND_X1,F
0524   0DA1           00116         rlf OPERAND_X2,F
0525   0DA2           00117         rlf OPERAND_X3,F
0526   0DA3           00118         rlf OPERAND_X4,F
0527   0DAC           00119         rlf PRETECENI,F 
0528   0008           00120         return
                      00121 ;**********************************************************
0529                  00122 POSUNDOLEVA_1   ; X := X * 2
                      00123                                 ; X > 0xFFFF FFFF => PRETECENI obsahuje bity navic
                      00124         BANK_1
0529   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
052A   1683               M                 bsf     STATUS,RP0    
052B   01AC           00125         clrf PRETECENI
052C   1003           00126         bcf STATUS,C
                      00127         
052D   2???           00128         call POSUNDOLEVA
                      00129 
                      00130         BANK_0
052E   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
052F   1283               M                 bcf     STATUS,RP0    
0530   0008           00131         return
                      00132 ;**********************************************************
0531                  00133 POSUNDOLEVA_2   ; X := X * 4
                      00134                                 ; X > 0xFFFF FFFF => PRETECENI obsahuje bity navic
MPASM 03.90 Released                                  MP3.ASM   12-16-2005  14:37:50         PAGE 46


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00135         BANK_1
0531   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0532   1683               M                 bsf     STATUS,RP0    
0533   01AC           00136         clrf PRETECENI
0534   1003           00137         bcf STATUS,C
                      00138         
0535   2???           00139         call POSUNDOLEVA
0536   2???           00140         call POSUNDOLEVA
                      00141 
                      00142         BANK_0
0537   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0538   1283               M                 bcf     STATUS,RP0    
0539   0008           00143         return
                      00144 ;**********************************************************
053A                  00145 POSUNDOLEVA_3   ; X := X * 8
                      00146                                 ; X > 0xFFFF FFFF => PRETECENI obsahuje bity navic
                      00147         BANK_1
053A   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
053B   1683               M                 bsf     STATUS,RP0    
053C   01AC           00148         clrf PRETECENI
053D   1003           00149         bcf STATUS,C
                      00150         
053E   2???           00151         call POSUNDOLEVA
053F   2???           00152         call POSUNDOLEVA
0540   2???           00153         call POSUNDOLEVA
                      00154 
                      00155         BANK_0
0541   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0542   1283               M                 bcf     STATUS,RP0    
0543   0008           00156         return
                      00157 ;**********************************************************
0544                  00158 POSUNDOLEVA_4   ; X := X * 16
                      00159                                 ; X > 0xFFFF FFFF => PRETECENI obsahuje bity navic
                      00160         BANK_1
0544   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0545   1683               M                 bsf     STATUS,RP0    
0546   01AC           00161         clrf PRETECENI
0547   1003           00162         bcf STATUS,C
                      00163         
0548   2???           00164         call POSUNDOLEVA
0549   2???           00165         call POSUNDOLEVA
054A   2???           00166         call POSUNDOLEVA
054B   2???           00167         call POSUNDOLEVA
                      00168 
                      00169         BANK_0
054C   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
054D   1283               M                 bcf     STATUS,RP0    
054E   0008           00170         return
                      00171 ;**********************************************************
054F                  00172 POSUNDOLEVA_5   ; X := X * 32
                      00173                                 ; X > 0xFFFF FFFF => PRETECENI obsahuje bity navic
                      00174         BANK_1
054F   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0550   1683               M                 bsf     STATUS,RP0    
MPASM 03.90 Released                                  MP3.ASM   12-16-2005  14:37:50         PAGE 47


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0551   01AC           00175         clrf PRETECENI
0552   1003           00176         bcf STATUS,C
                      00177         
0553   2???           00178         call POSUNDOLEVA
0554   2???           00179         call POSUNDOLEVA
0555   2???           00180         call POSUNDOLEVA
0556   2???           00181         call POSUNDOLEVA
0557   2???           00182         call POSUNDOLEVA
                      00183 
                      00184         BANK_0
0558   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0559   1283               M                 bcf     STATUS,RP0    
055A   0008           00185         return
                      00186 ;**********************************************************
055B                  00187 POSUNDOPRAVA    ; X := X div 2 , PRETECENI := X mod 2
                      00188                         ; tento podprogram nepouzivat, primo v hlavnim programu
                      00189                         ; musi se nastavit BANK_1 a vymazat PRETECENI!!!
                      00190                         ; (je pouze pro pouziti v nasobicich podprogramech)
                      00191                         ; pouzivat jen POSUNDOPRAVA_1, 2, 3, 4 
055B   1003           00192         bcf STATUS,C
055C   0CA3           00193         rrf OPERAND_X4,F
055D   0CA2           00194         rrf OPERAND_X3,F
055E   0CA1           00195         rrf OPERAND_X2,F
055F   0CA0           00196         rrf OPERAND_X1,F
0560   0008           00197         return
                      00198 ;**********************************************************
0561                  00199 POSUNDOPRAVA_1  ; X := X div 2
                      00200                                 ; PRETECENI := X mod 2
                      00201         BANK_1
0561   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0562   1683               M                 bsf     STATUS,RP0    
0563   0820           00202         movfw OPERAND_X1
0564   3901           00203         andlw b'00000001'
0565   00AC           00204         movwf PRETECENI         ; PRETECENI := X mod 2
                      00205         
0566   2???           00206         call POSUNDOPRAVA
                      00207 
                      00208         BANK_0
0567   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0568   1283               M                 bcf     STATUS,RP0    
0569   0008           00209         return
                      00210 ;**********************************************************
056A                  00211 POSUNDOPRAVA_2  ; X := X div 4
                      00212                                 ; PRETECENI := X mod 4
                      00213         BANK_1
056A   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
056B   1683               M                 bsf     STATUS,RP0    
056C   0820           00214         movfw OPERAND_X1
056D   3903           00215         andlw b'00000011'
056E   00AC           00216         movwf PRETECENI         ; PRETECENI := X mod 4
                      00217         
056F   2???           00218         call POSUNDOPRAVA
0570   2???           00219         call POSUNDOPRAVA
                      00220 
MPASM 03.90 Released                                  MP3.ASM   12-16-2005  14:37:50         PAGE 48


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00221         BANK_0
0571   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0572   1283               M                 bcf     STATUS,RP0    
0573   0008           00222         return
                      00223 ;**********************************************************
0574                  00224 POSUNDOPRAVA_3  ; X := X div 8
                      00225                                 ; PRETECENI := X mod 8
                      00226         BANK_1
0574   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0575   1683               M                 bsf     STATUS,RP0    
0576   0820           00227         movfw OPERAND_X1
0577   3907           00228         andlw b'00000111'
0578   00AC           00229         movwf PRETECENI         ; PRETECENI := X mod 8
                      00230         
0579   2???           00231         call POSUNDOPRAVA
057A   2???           00232         call POSUNDOPRAVA
057B   2???           00233         call POSUNDOPRAVA
                      00234 
                      00235         BANK_0
057C   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
057D   1283               M                 bcf     STATUS,RP0    
057E   0008           00236         return
                      00237 ;**********************************************************
057F                  00238 POSUNDOPRAVA_4  ; X := X div 16
                      00239                                 ; PRETECENI := X mod 16
                      00240         BANK_1
057F   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0580   1683               M                 bsf     STATUS,RP0    
0581   0820           00241         movfw OPERAND_X1
0582   390F           00242         andlw b'00001111'
0583   00AC           00243         movwf PRETECENI         ; PRETECENI := X mod 16
                      00244         
0584   2???           00245         call POSUNDOPRAVA
0585   2???           00246         call POSUNDOPRAVA
0586   2???           00247         call POSUNDOPRAVA
0587   2???           00248         call POSUNDOPRAVA
                      00249 
                      00250         BANK_0
0588   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0589   1283               M                 bcf     STATUS,RP0    
058A   0008           00251         return
                      00252 ;**********************************************************
058B                  00253 POSUNDOPRAVA_5  ; X := X div 32
                      00254                                 ; PRETECENI := X mod 32
                      00255         BANK_1
058B   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
058C   1683               M                 bsf     STATUS,RP0    
058D   0820           00256         movfw OPERAND_X1
058E   391F           00257         andlw b'00011111'
058F   00AC           00258         movwf PRETECENI         ; PRETECENI := X mod 32
                      00259         
0590   2???           00260         call POSUNDOPRAVA
0591   2???           00261         call POSUNDOPRAVA
0592   2???           00262         call POSUNDOPRAVA
MPASM 03.90 Released                                  MP3.ASM   12-16-2005  14:37:50         PAGE 49


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0593   2???           00263         call POSUNDOPRAVA
0594   2???           00264         call POSUNDOPRAVA
                      00265 
                      00266         BANK_0
0595   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0596   1283               M                 bcf     STATUS,RP0    
0597   0008           00267         return
                      00268 ;**********************************************************
0598                  00269 POSUNDOPRAVA_7  ; X := X div 128
                      00270                                 ; PRETECENI := X mod 128
                      00271         BANK_1
0598   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0599   1683               M                 bsf     STATUS,RP0    
059A   0820           00272         movfw OPERAND_X1
059B   397F           00273         andlw b'01111111'
059C   00AC           00274         movwf PRETECENI         ; PRETECENI := X mod 128
                      00275         
059D   2???           00276         call POSUNDOPRAVA
059E   2???           00277         call POSUNDOPRAVA
059F   2???           00278         call POSUNDOPRAVA
05A0   2???           00279         call POSUNDOPRAVA
05A1   2???           00280         call POSUNDOPRAVA
05A2   2???           00281         call POSUNDOPRAVA
05A3   2???           00282         call POSUNDOPRAVA
                      00283 
                      00284         BANK_0
05A4   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
05A5   1283               M                 bcf     STATUS,RP0    
05A6   0008           00285         return
                      00286 ;**********************************************************
05A7                  00287 NULA    ; if (X =  0) then PRETECENI := 0
                      00288                 ; if (X <> 0) then PRETECENI := 1
                      00289                 ; obsah X zustane nezmenen
                      00290         BANK_1
05A7   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
05A8   1683               M                 bsf     STATUS,RP0    
05A9   01AC           00291         clrf PRETECENI
05AA   30FF           00292         movlw h'FF'     
                      00293 
05AB   05A0           00294         andwf OPERAND_X1,F
05AC   1D03           00295         btfss STATUS,Z
05AD   142C           00296                 bsf PRETECENI,0
05AE   05A1           00297         andwf OPERAND_X2,F
05AF   1D03           00298         btfss STATUS,Z
05B0   142C           00299                 bsf PRETECENI,0
05B1   05A2           00300         andwf OPERAND_X3,F
05B2   1D03           00301         btfss STATUS,Z
05B3   142C           00302                 bsf PRETECENI,0
05B4   05A3           00303         andwf OPERAND_X4,F
05B5   1D03           00304         btfss STATUS,Z
05B6   142C           00305                 bsf PRETECENI,0         
                      00306 
                      00307         BANK_0
05B7   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
MPASM 03.90 Released                                  MP3.ASM   12-16-2005  14:37:50         PAGE 50


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

05B8   1283               M                 bcf     STATUS,RP0    
05B9   0008           00308         return
                      00309 ;**********************************************************
                      00055 
                      00056 ;**********************************************************
05BA                  00057 START
05BA   2???           00058         call INIT_CONFIG        ; nakonfiguruje preruseni, WDT, USART, pull ups...
05BB   2???           00059         call INIT_PORT          ; nastavy trisy, a porty do vychozi polohy
                      00060 
05BC   2???           00061         call DELAY_25us         ; chvili pockame, protoze napjeti zdroje co mam doma (stary PC-AT zdroj)
05BD   2???           00062         call DELAY_25us         ; zezacatku dost kolisa...
05BE   2???           00063         call DELAY_25us
                      00064 
05BF   2???           00065         call POZDRAV                            ; abych se u kompu nenudil
                      00066 
                      00067 #IF VS1001==1
05C0   2???           00068         call VS_INIT
                      00069 #ENDIF
                      00070 
05C1   2???           00071         call ATA_RESET                          ; resetujeme disk, koukneme zda tu nejakej mame
05C2   1C2E           00072         btfss ATA_ATTRIBUTES,ATA_OK
05C3   2???           00073         goto $-2                                        ; pokud neni pripojen disk, tak se jej pokousime
                             neustale najit...
05C4   0000           00074         nop                                                     ; ...pokud tam zadny disk neni, tak bych
                            om se stejne ani sem nemeli dostat, protoze budem porad cekat na WAIT_FOR_READY
                      00075 
05C5   2???           00076         call IDENTIFY_DEVICE            ; koukneme co disk umi
05C6                  00077 CEK_PRIKAZ_01h
05C6   2???           00078         call CEKEJ_PRIKAZ
05C7   0878           00079         movfw 0x078                                     ; prvni byte prikazoveho zasobniku
05C8   01F3           00080         clrf PRIJATYCH_DAT                      ; prikaz byl vybran -> prazdny zasobnik
05C9   3C01           00081         sublw h'01'                                     ; ...pokud to byl prikaz 01h...
05CA   1D03           00082         btfss STATUS,Z
05CB   2???           00083         goto CEK_PRIKAZ_01h
05CC   082E           00084         movfw ATA_ATTRIBUTES            ; ...vodesleme zpet vlastnosti disku a jeho jmenovku (vis. popis
                             protokolu)
05CD   2???           00085         call WR_USART
05CE   2???           00086         call ODESLI_MODEL_NUMBER        ; odesleme jmeno disku 
                      00087 
05CF   2???           00088         call SCAN_MBR                           ; najdeme oddily s FAT32 a jejich seznam dame do bufferu
                             2
05D0                  00089 CEK_PRIKAZ_02h_03h
05D0   2???           00090         call CEKEJ_PRIKAZ                       ; pockame si na prikaz
05D1   01F5           00091         clrf STAV_PRIKAZU                       ; smazeme registr signalizujici platnost prikazu
05D2   2???           00092         call PRIKAZ_02h                         ; testujeme zda prisel prikaz 02h, pokud ano tak jej pro
                            vedeme a nastavime platnost prikazu
05D3   2???           00093         call PRIKAZ_03h                         ; ---//---
05D4   1C75           00094         btfss STAV_PRIKAZU,0            ; Pokud si zadna z procedur prikaz neprevzala, ...
05D5   01F3           00095         clrf PRIJATYCH_DAT                      ; ...vymazeme zasobnik prikazu. (prikaz neni pro tuto ch
                            vili platny)
05D6   1E2E           00096         btfss ATA_ATTRIBUTES,FAT32_LOAD ; cekame dokud nedojde k nasteni nejakeho oddilu
05D7   2???           00097         goto CEK_PRIKAZ_02h_03h         ; pokud byl oddil vporadku nacten, pokracujeme...
                      00098 
05D8   01EB           00099         clrf PREH_STAV
MPASM 03.90 Released                                  MP3.ASM   12-16-2005  14:37:50         PAGE 51


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00100 ;*******************************************************************************************************
                            *************
                      00101 ;*******************************************************************************************************
                            *************
                      00102 ;*******************************************************************************************************
                            *************
                      00103 ;*******************************************************************************************************
                            *************
05D9                  00104 BIG_LOOP
                      00105         ; Tady ta smycka beha po nacteni disku a nejake FATky porad dokola.
                      00106         ; Pri kazdem prubehu smyckou vyresime prikazy, ktere prisly, a pokud prehravame 
                      00107         ; nejakou mp3 a dekoder chce po nas data, tak ho nakrmime alespon jednim sektorem...
                      00108         ; Mimo to musime v teto smycce osefovat, ze kdyz skonci mp3, nacteme dalsi...
05D9   0873           00109         movfw PRIJATYCH_DAT
05DA   39FF           00110         andlw h'FF'
05DB   1903           00111         btfsc STATUS,Z
05DC   2???           00112         goto BIG_LOOP__NENI_PRIKAZ
                      00113         
05DD   01F5           00114         clrf STAV_PRIKAZU                       ; smazeme registr signalizujici platnost prikazu
                      00115         ; Pokud jsme tady, tak prisel nejaky prikaz, jdem predat prikaz jednotlivym proceduram
05DE   2???           00116         call PRIKAZ_04h                         ; testujeme zda prisel prikaz 04h, pokud ano tak jej pro
                            vedeme a nastavime platnost prikazu
05DF   2???           00117         call PRIKAZ_05h                         ; --- // ---
05E0   2???           00118         call PRIKAZ_06h                         ; --- // ---
05E1   2???           00119         call PRIKAZ_07h                         ; --- // ---
05E2   2???           00120         call PRIKAZ_08h                         ; --- // ---
                      00121 
05E3   2???           00122         call PRIKAZ_80h                         ; --- // ---
05E4   2???           00123         call PRIKAZ_81h                         ; --- // ---
05E5   2???           00124         call PRIKAZ_82h                         ; --- // ---
                      00125         
05E6   1C75           00126         btfss STAV_PRIKAZU,0            ; Pokud si zadna z procedur prikaz neprevzala, ...
05E7   01F3           00127         clrf PRIJATYCH_DAT                      ; ...vymazeme zasobnik prikazu. (prikaz neni pro tuto ch
                            vili platny)
                      00128 
05E8                  00129 BIG_LOOP__NENI_PRIKAZ
                      00130 
                      00131 #IF VS1001==1                                   ; pokud mame pripojen dekoder...
05E8   1C6B           00132         btfss PREH_STAV,0                       ; ...a pokud se prehrava mp3...
05E9   2???           00133         goto MP3_NOT_PLAY
                      00134         
05EA   086A           00135         movfw PREH_DATA_POZICE
05EB   024C           00136         subwf CLUSTER_SIZE,W
05EC   1D03           00137         btfss STATUS,Z                          ; ...podivame se zda jiz nejsme na konci clusteru...
05ED   2???           00138         goto SEND_MP3_DATA
                      00139 
05EE   0866           00140         movfw PREH_DATA_CL1                     ; ...pokud jo, tak si najdeme dalsi cluster v retezci.
05EF   00BC           00141         movwf CLUSTER1
05F0   0867           00142         movfw PREH_DATA_CL2
05F1   00BD           00143         movwf CLUSTER2
05F2   0868           00144         movfw PREH_DATA_CL3
05F3   00BE           00145         movwf CLUSTER3
05F4   0869           00146         movfw PREH_DATA_CL4
05F5   00BF           00147         movwf CLUSTER4
MPASM 03.90 Released                                  MP3.ASM   12-16-2005  14:37:50         PAGE 52


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00148 
05F6   01EA           00149         clrf PREH_DATA_POZICE
05F7   2???           00150         call NEXT_CLUSTER
05F8   083C           00151         movfw CLUSTER1
05F9   00E6           00152         movwf PREH_DATA_CL1
05FA   083D           00153         movfw CLUSTER2
05FB   00E7           00154         movwf PREH_DATA_CL2
05FC   083E           00155         movfw CLUSTER3
05FD   00E8           00156         movwf PREH_DATA_CL3
05FE   083F           00157         movfw CLUSTER4
05FF   00E9           00158         movwf PREH_DATA_CL4
                      00159         
0600   1C3B           00160         btfss POZICE,0                          ; Pokud byl cluster posledni v retezci, skoncime s prehr
                            avanim...
0601   2???           00161         goto SEND_MP3_DATA
                      00162         
0602   106B           00163         bcf PREH_STAV,0
0603   10EB           00164         bcf PREH_STAV,1
0604   116B           00165         bcf PREH_STAV,2
0605   2???           00166         goto MP3_NOT_PLAY
                      00167 
0606                  00168 SEND_MP3_DATA
0606   0866           00169         movfw PREH_DATA_CL1                     ; Mame zjisteny cluster a jeho cast, kterou mame prehrav
                            at...
0607   00BC           00170         movwf CLUSTER1
0608   0867           00171         movfw PREH_DATA_CL2
0609   00BD           00172         movwf CLUSTER2
060A   0868           00173         movfw PREH_DATA_CL3
060B   00BE           00174         movwf CLUSTER3
060C   0869           00175         movfw PREH_DATA_CL4
060D   00BF           00176         movwf CLUSTER4
060E   086A           00177         movfw PREH_DATA_POZICE
060F   00BB           00178         movwf POZICE
                      00179 
0610   2???           00180         call CLUSTER_TO_LBA                     ; zjistime si skutecnou polohu dat na disku...
0611   3001           00181         movlw .1
0612   00A6           00182         movwf SECTOR_C
0613   2???           00183         call READ_SECTOR                        ; dame prikaz precist data...
                      00184 
0614   1585           00185         bsf MP3_CS                                      ; po SI posilam data
0615   3000           00186         movlw .0                                        ; posilame celkem 256 slov
0616   00B6           00187         movwf TEMP1             
0617                  00188 SEND_MP3_WORD
0617   2???           00189         call WAIT_FOR_VSDREQ
0618   2???           00190         call READ_DATA
0619   0820           00191         movfw DATA_L
061A   2???           00192         call VS_WR_BYTE
061B   0821           00193         movfw DATA_H
061C   2???           00194         call VS_WR_BYTE
061D   0BB6           00195         decfsz TEMP1,f  
061E   2???           00196         goto SEND_MP3_WORD
                      00197 
061F   0AEA           00198         incf PREH_DATA_POZICE,f
0620                  00199 MP3_NOT_PLAY
MPASM 03.90 Released                                  MP3.ASM   12-16-2005  14:37:50         PAGE 53


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00200 #ENDIF
                      00201 
0620   2???           00202         goto BIG_LOOP
                      00203 ;*******************************************************************************************************
                            *************
                      00204 ;*******************************************************************************************************
                            *************
                      00205 ;*******************************************************************************************************
                            *************
                      00206 ;*******************************************************************************************************
                            *************
0621                  00207 INIT_PORT
                      00208         BANK_1
0621   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0622   1683               M                 bsf     STATUS,RP0    
                      00209 
                      00210 #IF VS1001==1
0623   3011           00211         movlw b'00010001'                       ; bity SO a DREQ jako vstupy (signaly z dekoderu)
                      00212 #ELSE
                      00213         movlw 0xff
                      00214 #ENDIF
                      00215 
0624   0085           00216         movwf MP3_PORT_TRIS
0625   3080           00217         movlw b'10000000'                       ; adresovani disku jako vystupy
0626   0087           00218         movwf ATA_ADDRESS_TRIS          
0627   3000           00219         movlw .0
0628   0089           00220         movwf ATA_CONTROL_TRIS          ; ovladani disku jako vystupy
0629   30FF           00221         movlw 0xff
062A   0086           00222         movwf DATA_PORT_LOW_TRIS        ; datovou sbernici jako vstupy
062B   0088           00223         movwf DATA_PORT_HIGH_TRIS       
                      00224         BANK_0
062C   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
062D   1283               M                 bcf     STATUS,RP0    
                      00225         
062E   3007           00226         movlw b'00000111'       ; signal reset-, diow- a dior- jsou aktivni v log. 0 !!!
062F   0089           00227         movwf ATA_CONTROL
0630   3037           00228         movlw b'00110111'       ; CS1-, CS0- = 1 => datova sbernice disku je odpojena
0631   0087           00229         movwf ATA_ADDRESS
0632   0185           00230         clrf MP3_PORT   
0633   0008           00231         return
                      00232 ;**********************************************************
0634                  00233 INIT_CONFIG     ; nakonfiguruje preruseni, WDT, USART, pull ups....
                      00234         BANK_1
0634   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0635   1683               M                 bsf     STATUS,RP0    
0636   30C7           00235         movlw b'11000111'       ; ...pull up a podobny koniny
                      00236                 ; PORTB Pull-up Enable bit              1 = pull up enabled
                      00237                 ; Interrupt Edge Select bit             1 = interrupt on rising edge of RB0/INT pin
                      00238                 ; TMR0 Clock Source Select bit  0 = Internal instruction cycle clock (CLKO)
                      00239                 ; TMR0 Source Edge Select bit   0 = Increment on low-to-high transition on RA4/T0CKI pin
                      00240                 ; Prescaler Assignment bit              0 = Prescaler is assigned to the Timer0 module
                      00241                 ; PS2:PS0: Prescaler Rate Select bits   111 = TMR0 Rate 1 : 256; WDT Rate 1 : 128
0637   0081           00242         movwf OPTION_REG
                      00243         
MPASM 03.90 Released                                  MP3.ASM   12-16-2005  14:37:50         PAGE 54


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0638   3020           00244         movlw b'00100000'       ; povolime preruseni od USARTu (kdyz neco dostanem)
0639   008C           00245         movwf PIE1      
063A   3000           00246         movlw b'00000000'       ; ostatni vnejsi preruseni vymaskujeme
063B   008D           00247         movwf PIE2                      
                      00248 
063C   30C0           00249         movlw b'11000000'       ; povolime preruseni na vnejsi zarizeni (USART)                         
063D   008B           00250         movwf INTCON
                      00251 
063E   3026           00252         movlw b'00100110'       ;konfigurace USARTu (asynchronni, 8bit, bez parity, rychle - (BRGH = 1))
063F   0098           00253         movwf TXSTA
                      00254         BANK_0
0640   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0641   1283               M                 bcf     STATUS,RP0    
0642   3090           00255         movlw b'10010000'       ;zapnu USART
0643   0098           00256         movwf RCSTA
                      00257         BANK_1
0644   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0645   1683               M                 bsf     STATUS,RP0    
                      00258         ;movlw .129             ; Fosc = 20 MHz, BRGH=1 => rychlost = 9615 bps
0646   3067           00259         movlw .103                      ; Fosc = 16 MHz, BRGH=1 => rychlost = 9615 bps
0647   0099           00260         movwf SPBRG     
                      00261 
0648   3007           00262         movlw b'00000111'
0649   009F           00263         movwf ADCON1            ; vsechny vstupy (RA,RE) jako digitalni
                      00264         BANK_0  
064A   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
064B   1283               M                 bcf     STATUS,RP0    
064C   019F           00265         clrf ADCON0                     ; pro jistotu (vypneme A/D prevodniky)
                      00266 
064D   01F3           00267         clrf PRIJATYCH_DAT      ; zasobnik prikazu prazdny...
064E   0008           00268         return
                      00269 ;**********************************************************
064F                  00270 WR_USART        ; odesle slovo ve workingu po USARTu
                      00271                         ; prijimani dat je reseno prez preruseni...
                      00272         BANK_1  
064F   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0650   1683               M                 bsf     STATUS,RP0    
0651   1C98           00273         btfss TXSTA,1 
0652   2???           00274         goto WR_USART   ; cekame do chvile nez bude pripraven transmit buffer 
                      00275 
                      00276         BANK_0  
0653   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0654   1283               M                 bcf     STATUS,RP0    
0655   0099           00277         movwf TXREG
0656   0008           00278         return
                      00279 ;**********************************************************
                      00280 ; tento podprogram bude pro budouci praci zbytecny, je zde jen proto, abych na PC videl ze program byl s
                            pusten...
0657                  00281 POZDRAV  ; odesle po seriove lince pozdrav
0657   3041           00282         movlw 'A'       
0658   2???           00283         call WR_USART
0659   3068           00284         movlw 'h'
065A   2???           00285         call WR_USART
065B   306F           00286         movlw 'o'
MPASM 03.90 Released                                  MP3.ASM   12-16-2005  14:37:50         PAGE 55


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

065C   2???           00287         call WR_USART
065D   306A           00288         movlw 'j'
065E   2???           00289         call WR_USART
065F   3021           00290         movlw '!'
0660   2???           00291         call WR_USART
0661   0008           00292         return
                      00293 ;**********************************************************
                      00294 ; odesle data, ktera jdou z disku USARTEM. Pocet dat je v reg. TEMP1
0662                  00295 ODESLI_DATA
0662   2???           00296         call READ_DATA  
0663   0820           00297         movfw DATA_L
0664   2???           00298         call WR_USART
0665   0821           00299         movfw DATA_H
0666   2???           00300         call WR_USART   
0667   0BB6           00301         decfsz TEMP1,F
0668   2???           00302         goto ODESLI_DATA
0669   0008           00303         return
                      00304 ;**********************************************************
066A                  00305 ODESLI_MODEL_NUMBER     ; Podprogram IDENTIFY_DEVICE nam do bufferu 1 hodil jmeno disku
                      00306                         ; mi jej ted odesleme USARTem, aby mohl byt zobrazen na displeji
                      00307         INDF_BANK_3     ; BUFFER_1 je v bance 3
066A   1783               M                         bsf STATUS,IRP    
066B   3090           00308         movlw 0x90      ; na adrese 90
066C   0084           00309         movwf FSR
066D   3014           00310         movlw .20       ; budeme odesilat 20 slov (40 znaku)
066E   00B6           00311         movwf TEMP1
066F                  00312 ODESLI_MODEL_NUMBER_ODESILANI
066F   0800           00313         movfw INDF
0670   00B7           00314         movwf TEMP2     ; data do bufferu byla vkladana stylem DATA_L, DATA_H, DATA_L, DATA_H...
0671   0A84           00315         incf FSR,F      ; ASCII hodnoty jsou ale razeny stylem DATA_H, DATA_L, DATA_H, DATA_L...
0672   0800           00316         movfw INDF      ; proto to pisu tak slozite...
0673   0A84           00317         incf FSR,F
                      00318         
0674   2???           00319         call WR_USART
0675   0837           00320         movfw TEMP2
0676   2???           00321         call WR_USART   
                      00322 
0677   0BB6           00323         decfsz TEMP1,F
0678   2???           00324         goto ODESLI_MODEL_NUMBER_ODESILANI
                      00325 
                      00326         INDF_BANK_0     
0679   1383               M                         bcf STATUS,IRP    
067A   0008           00327         return
                      00328 ;**********************************************************
067B                  00329 ODESLI_BUFFER2
                      00330         ; v TEMP1 ocakava hodnotu kolik bytu ma odeslat
                      00331         INDF_BANK_2     ; BUFFER_2 je v bance 2
067B   1783               M                         bsf STATUS,IRP    
067C   3010           00332         movlw 0x10      ; na adrese 10
067D   0084           00333         movwf FSR
067E                  00334 ODESLI_BUFFER2_ODESILANI
067E   0800           00335         movfw INDF
067F   2???           00336         call WR_USART
0680   0A84           00337         incf FSR,F      
MPASM 03.90 Released                                  MP3.ASM   12-16-2005  14:37:50         PAGE 56


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0681   0BB6           00338         decfsz TEMP1,F
0682   2???           00339         goto ODESLI_BUFFER2_ODESILANI
                      00340 
                      00341         INDF_BANK_0             
0683   1383               M                         bcf STATUS,IRP    
0684   0008           00342         return
                      00343 ;**********************************************************
0685                  00344 INTERRUPT                                       ; sem se skace po zavolani preruseni...
0685   00F0           00345         movwf TEMP_WORKING
0686   0803           00346         movfw STATUS
0687   00F1           00347         movwf TEMP_STATUS
0688   0804           00348         movfw FSR
0689   00F2           00349         movwf TEMP_FSR
                      00350         BANK_0
068A   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
068B   1283               M                 bcf     STATUS,RP0    
                      00351         INDF_BANK_0
068C   1383               M                         bcf STATUS,IRP    
                      00352 
068D   1E8C           00353         btfss PIR1,RCIF                 ; Meli bychom mit povoleno sice jen jedno preruseni (od USARTU),
                             jeden ale nikdy nevi, proto ten test
068E   2???           00354         goto END_OF_INTERRUPT   ; Pokud nejde o preruseni od USARTU, tak koncime...
068F   081A           00355         movfw RCREG                             ; !!! vynulovat pznak !!!     
0690   00F4           00356         movwf PRIJATE_DATO
                      00357 
0691   0873           00358         movfw PRIJATYCH_DAT
0692   3C07           00359         sublw .7                                ; pokud je v zasobniku uz plno (PRIJATYCH_DAT=8), tak ko
                            ncime
0693   1C03           00360         btfss STATUS,C
0694   2???           00361         goto END_OF_INTERRUPT   ; Zasobnik je plny, nic prijimat nebudeme
                      00362 
0695   0873           00363         movfw PRIJATYCH_DAT
0696   3E78           00364         addlw 0x78                              ; zacatek zasobniku prikazu
0697   0084           00365         movwf FSR
0698   0874           00366         movfw PRIJATE_DATO              ; prijmuta data -> do W
0699   0080           00367         movwf INDF                              ; prijate dato na prvni volne misto v zasobniku
                      00368         
069A   0AF3           00369         incf  PRIJATYCH_DAT,F   ; pricteme k indikaci zasobniku
                      00370 ;       movlw '['
                      00371 ;       call WR_USART
                      00372 ;       movfw PRIJATYCH_DAT
                      00373 ;       addlw .48
                      00374 ;       call WR_USART
                      00375 ;       movlw ']'
                      00376 ;       call WR_USART   
069B                  00377 END_OF_INTERRUPT                        ; sem skocime kdyz mame vsechny veci kolem preruseni vyrizeny
069B   0872           00378         movfw TEMP_FSR
069C   0084           00379         movwf FSR
069D   0871           00380         movfw TEMP_STATUS
069E   0083           00381         movwf STATUS
069F   0870           00382         movfw TEMP_WORKING
06A0   0009           00383         retfie
                      00384 ;**********************************************************
06A1                  00385 DELAY_2ms
MPASM 03.90 Released                                  MP3.ASM   12-16-2005  14:37:50         PAGE 57


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00386 ;Delay 8000 cycles
06A1   3013           00387         MOVLW 0x13  ;19 DEC
06A2   00B6           00388         MOVWF TMP1
06A3   308B           00389         MOVLW 0x8B  ;139 DEC
06A4   00B8           00390         MOVWF TMP0
06A5   0BB8           00391         DECFSZ TMP0,F
06A6   2???           00392         GOTO $-1
06A7   0BB6           00393         DECFSZ TMP1,F
06A8   2???           00394         GOTO $-5
                      00395 ;End of Delay   
06A9   0008           00396         return
                      00397 ;**********************************************************
06AA                  00398 DELAY_200ms
                      00399 ;Delay 197123 cycles
06AA   3000           00400         MOVLW 0x00  ;0 DEC
06AB   00B6           00401         MOVWF TMP1
06AC   3000           00402         MOVLW 0x00  ;0 DEC
06AD   00B8           00403         MOVWF TMP0
06AE   0BB8           00404         DECFSZ TMP0,F
06AF   2???           00405         GOTO $-1
06B0   0BB6           00406         DECFSZ TMP1,F
06B1   2???           00407         GOTO $-3
                      00408 ;End of Delay
06B2   0008           00409         return
                      00410 ;**********************************************************
06B3                  00411 DELAY_500ms
                      00412 ; (Fosc = 16 MHz , instr. cyklus= 0.25 us) 500 000us / 0.25 us = 2 000 000 instrukcnich cyklu
                      00413 ;Variables: TMP2, TMP1, TMP0
                      00414 ;Delay 2000000 cycles
06B3   3047           00415         MOVLW 0x47  ;71 DEC
06B4   00B7           00416         MOVWF TMP2
06B5   302B           00417         MOVLW 0x2B  ;43 DEC
06B6   00B6           00418         MOVWF TMP1
06B7   30D9           00419         MOVLW 0x0D9  ;217 DEC
06B8   00B8           00420         MOVWF TMP0
06B9   0BB8           00421         DECFSZ TMP0,F
06BA   2???           00422         GOTO $-1
06BB   0BB6           00423         DECFSZ TMP1,F
06BC   2???           00424         GOTO $-5
06BD   0BB7           00425         DECFSZ TMP2,F
06BE   2???           00426         GOTO $-9
                      00427 ;End of Delay
06BF   0008           00428         return
                      00429 ;**********************************************************
                      00430 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
                      00431 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
                      00432 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
                      00433 ; tady jsou procedury resici jednotlive prikazy
                      00434 ; Pokud je v zasobniku prikaz pro nejakou proceduru, musi tato procedura nastavit byt STAV_PRIKAZU do 1 
                            (i kdyz treba nema vsechny parametry)
                      00435 ; Pokud procedura najde svuj prikaz a jsou prijate vsechny parametry, musi odeslat nejakou odpoved po US
MPASM 03.90 Released                                  MP3.ASM   12-16-2005  14:37:50         PAGE 58


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                            ARTu a smazat reg. PRIJATYCH_DAT!!!
                      00436 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
06C0                  00437 CEKEJ_PRIKAZ                                    ; ceka dokud nedostaneme nejaky prikaz
06C0   0873           00438         movfw PRIJATYCH_DAT
06C1   39FF           00439         andlw h'FF'
06C2   1903           00440         btfsc STATUS,Z                          ; koukneme se zda prisel nejaky prikaz...
06C3   2???           00441         goto CEKEJ_PRIKAZ
06C4   0008           00442         return
                      00443 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
06C5                  00444 PRIKAZ_02h                                              ; 02h - vrat oddily se systemem FAT32
06C5   0878           00445         movfw 0x078                                     ; prvni byte zasobniku prikazu
06C6   3C02           00446         sublw h'02'                                     
06C7   1D03           00447         btfss STATUS,Z
06C8   0008           00448         return                                          ; nebyl prijat prikaz 02h
06C9   1475           00449         bsf STAV_PRIKAZU,0                      ; mame tu prikaz 02h, nastavime byt STAV_REGISTRU
06CA   0873           00450         movfw PRIJATYCH_DAT
06CB   3C01           00451         sublw .1                                        ; pro prikaz 02h museji prijit 2 byty (prikaz + 
                            1 parametr)
06CC   1803           00452         btfsc STATUS,C
06CD   0008           00453         return                                          ; jeste nemame vsechny parametry
                      00454         ; Prisel prikaz 02h s jednim parametrem (vrat oddily se systemem FAT32)
                      00455 
06CE   0879           00456         movfw 0x079                                     ; parametr prikazu 02h (cislo svazku, jehoz para
                            metry chceme vratit)
06CF   3903           00457         andlw b'00000011'                       ; parametr musi byt v rozsahu 0-3
06D0   00B6           00458         movwf TEMP1
06D1   1003           00459         bcf STATUS,C
06D2   0DB6           00460         rlf TEMP1,F
06D3   0DB6           00461         rlf TEMP1,F
06D4   0DB6           00462         rlf TEMP1,F
06D5   0D36           00463         rlf TEMP1,W                                     ; parametr vynasobime 16
06D6   3E10           00464         addlw 0x10                                      ; buffer 2 je v bance 2 na adrese 0x10
06D7   0084           00465         movwf FSR
                      00466         INDF_BANK_2
06D8   1783               M                         bsf STATUS,IRP    
06D9   3010           00467         movlw .16                                       ; budeme odesilat 16 bytu
06DA   00B6           00468         movwf TEMP1
06DB                  00469 PRIKAZ_02h__ODESILANI_ODDILU
06DB   0800           00470         movfw INDF
06DC   2???           00471         call WR_USART
06DD   0A84           00472         incf FSR,F
06DE   0BB6           00473         decfsz TEMP1,F
06DF   2???           00474         goto PRIKAZ_02h__ODESILANI_ODDILU
06E0   01F3           00475         clrf PRIJATYCH_DAT
06E1   0008           00476         return
                      00477 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
06E2                  00478 PRIKAZ_03h                                              ; 03h  nastav oddil
06E2   0878           00479         movfw 0x078                                     ; prvni byte zasobniku prikazu
06E3   3C03           00480         sublw h'03'                                     
06E4   1D03           00481         btfss STATUS,Z
06E5   0008           00482         return                                          ; nebyl prijat prikaz 03h
MPASM 03.90 Released                                  MP3.ASM   12-16-2005  14:37:50         PAGE 59


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

06E6   1475           00483         bsf STAV_PRIKAZU,0                      ; mame tu prikaz 03h, nastavime byt STAV_REGISTRU
06E7   0873           00484         movfw PRIJATYCH_DAT
06E8   3C04           00485         sublw .4                                        ; pro prikaz 03h museji prijit 5 byty (prikaz + 
                            4byty parametr)
06E9   1803           00486         btfsc STATUS,C
06EA   0008           00487         return                                          ; jeste nemame vsechny parametry
                      00488         ; Prisel prikaz 03h s 4bytovym parametrem (nacti oddily se systemem FAT32)
                      00489 
06EB   0879           00490         movfw 0x079                                     ; parametrem prikazu 03h ma byt 4bytova adresa z
                            acatku svazku, ktery se ma nacist
06EC   00A7           00491         movwf LBA1
06ED   087A           00492         movfw 0x07A
06EE   00A8           00493         movwf LBA2
06EF   087B           00494         movfw 0x07B
06F0   00A9           00495         movwf LBA3
06F1   087C           00496         movfw 0x07C
06F2   00AA           00497         movwf LBA4
06F3   2???           00498         call NACTI_FAT32                        ; nacte parametry zvoleneho oddilu
                      00499 
06F4   082E           00500         movfw ATA_ATTRIBUTES
06F5   2???           00501         call WR_USART
06F6   01F3           00502         clrf PRIJATYCH_DAT                      ; vyprazdnime zasobnik
06F7   0008           00503         return
                      00504 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
06F8                  00505 PRIKAZ_04h                                              ; 04h  vrat velikost clusteru
06F8   0878           00506         movfw 0x078                                     ; prvni byte zasobniku prikazu
06F9   3C04           00507         sublw h'04'                                     
06FA   1D03           00508         btfss STATUS,Z
06FB   0008           00509         return                                          ; nebyl prijat prikaz 04h
06FC   1475           00510         bsf STAV_PRIKAZU,0                      ; mame tu prikaz 04h, nastavime byt STAV_REGISTRU
                      00511         ; pro prikaz 04h nejsou definovany zadne parametry, proto jiz nic jineho netestujeme
                      00512 
06FD   084C           00513         movfw CLUSTER_SIZE
06FE   2???           00514         call WR_USART
06FF   01F3           00515         clrf PRIJATYCH_DAT                      ; vyprazdnime zasobnik
0700   0008           00516         return
                      00517 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
0701                  00518 PRIKAZ_05h                                              ; 05h  vrat jmeno a adresu souboru
0701   0878           00519         movfw 0x078                                     ; prvni byte zasobniku prikazu
0702   3C05           00520         sublw h'05'                                     
0703   1D03           00521         btfss STATUS,Z
0704   0008           00522         return                                          ; nebyl prijat prikaz 05h
0705   1475           00523         bsf STAV_PRIKAZU,0                      ; mame tu prikaz 05h, nastavime byt STAV_REGISTRU
0706   0873           00524         movfw PRIJATYCH_DAT
0707   3C06           00525         sublw .6                                        ; pro prikaz 05h museji prijit 7 bytu (prikaz + 
                            6byty parametr)
0708   1803           00526         btfsc STATUS,C
0709   0008           00527         return                                          ; jeste nemame vsechny parametry
                      00528         ; Prisel prikaz 05h s 6bytovym parametrem 
                      00529 
070A   087D           00530         movfw 0x07D                                     ; 5. parametr prikazu (cast adresare) Muze byt v
                             rozsahu 0..[CLUSTER_SIZE -1]
MPASM 03.90 Released                                  MP3.ASM   12-16-2005  14:37:50         PAGE 60


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

070B   00BB           00531         movwf POZICE
070C   024C           00532         subwf CLUSTER_SIZE,W            ; W := CLUSTER_SIZE - [sektor v clusteru]
                      00533                                                                 ; pokud W <= 0 tak je 5. parametr mimo r
                            ozsah. Prvni byte odpovedi bude 80h
070D   1903           00534         btfsc STATUS,Z                          ; pokud neni vysledek nula...
070E   2???           00535         goto PRIKAZ_05h__PAR_OK         ; ...je parametr OK
070F   1803           00536         btfsc STATUS,C                          ; Pokud neni vysledek zaporny...
0710   2???           00537         goto PRIKAZ_05h__PAR_OK         ; ...je parametr OK
                      00538 
                      00539         ;Parametr byl zadan prilis velky (v jednom clusteru je CLUSTER_SIZE * 16 zaznamu)
0711                  00540 PRIKAZ_05h__PAR_NOT_OK
                      00541         INDF_BANK_2
0711   1783               M                         bsf STATUS,IRP    
0712   3010           00542         movlw 0x10                                      ; 1. byte bufferu 2
0713   0084           00543         movwf FSR
0714   3080           00544         movlw h'80'                                     ; jako prvni byte odpovedi dame 80h (parametr by
                            l prilis velky)
0715   0080           00545         movwf INDF
0716   2???           00546         goto PRIKAZ_05h__KONEC
0717                  00547 PRIKAZ_05h__PAR_OK      
                      00548         ; Parametr "castClusteru" byl zadan spravne, jdem se podivat zda parametr "CisloZaznamu" je v ro
                            zsahu 0..15
0717   087E           00549         movfw 0x07E                                     ; kolikaty zaznam v casti adersare (sektoru) mam
                            e precist
0718   39F0           00550         andlw b'11110000'
0719   1D03           00551         btfss STATUS,Z                          ; pokud je parametr vetsi jak 15...
071A   2???           00552         goto PRIKAZ_05h__PAR_NOT_OK     ; ...tak odesleme jako prvni byte odpovedi 80h
                      00553 
                      00554         ; Jdem precist sektor clusteru, v kterem se nachazi pozadovany zaznam. Cislo tohoto sektoru (off
                            set v clusteru) mame v POZICE.
071B   0879           00555         movfw 0x079                                     ; nejnizsi cast clusteru adresare
071C   00BC           00556         movwf CLUSTER1
071D   087A           00557         movfw 0x07A
071E   00BD           00558         movwf CLUSTER2
071F   087B           00559         movfw 0x07B
0720   00BE           00560         movwf CLUSTER3
0721   087C           00561         movfw 0x07C
0722   00BF           00562         movwf CLUSTER4
0723   2???           00563         call CLUSTER_TO_LBA                     ; zjistime si skutecnou polohu zaznamu na disku
0724   3001           00564         movlw .1
0725   00A6           00565         movwf SECTOR_C
0726   2???           00566         call READ_SECTOR                        ; dame prikaz jej precist
                      00567 
0727   087E           00568         movfw 0x07E                                     ; kolikaty zaznam v casti adersare (sektoru) mam
                            e precist
0728   390F           00569         andlw b'00001111'
0729   00B6           00570         movwf TEMP1                                     ; rozsah by mel byt spravne, pro jistotu jej ale
                             orizneme [0..15]
072A   39FF           00571         andlw h'FF'
072B   1903           00572         btfsc STATUS,Z                          ; pokud chceme prvni soubor ze sektoru...
072C   2???           00573         goto PRIKAZ_05h__MAME_SOUBOR    ; ...skocime rovnou na jeho cteni.
                      00574 
072D   0EB6           00575         swapf TEMP1,F                           ; protoze kazdy zaznam o souboru ma 32B=16slov, tak musi
                            me TEMP1 vynasobit 16...
MPASM 03.90 Released                                  MP3.ASM   12-16-2005  14:37:50         PAGE 61


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

072E   2???           00576         call PRESKOC                            ; a tolik slov preskocit (tolik slov je pro nas nepotreb
                            nych)
072F                  00577 PRIKAZ_05h__MAME_SOUBOR
072F   2???           00578         call FILE_INFO
0730                  00579 PRIKAZ_05h__KONEC
                      00580         ; At uz bylo v zaznamu cokoli, odesleme 16 bytu z BUFFERU 2
0730   3010           00581         movlw .16
0731   00B6           00582         movwf TEMP1
0732   2???           00583         call ODESLI_BUFFER2                     ; odesleme si zaznam o souboru  
                      00584 
0733   01F3           00585         clrf PRIJATYCH_DAT                      ; vyprazdnime zasobnik prikazu
0734   0008           00586         return
                      00587 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
0735                  00588 PRIKAZ_06h                                              ; 06h  vrat cislo dalsiho clusteru v alokacnim 
                            retezu
0735   0878           00589         movfw 0x078                                     ; prvni byte zasobniku prikazu
0736   3C06           00590         sublw h'06'                                     
0737   1D03           00591         btfss STATUS,Z
0738   0008           00592         return                                          ; nebyl prijat prikaz 06h
0739   1475           00593         bsf STAV_PRIKAZU,0                      ; mame tu prikaz 06h, nastavime byt STAV_REGISTRU
073A   0873           00594         movfw PRIJATYCH_DAT
073B   3C04           00595         sublw .4                                        ; pro prikaz 06h museji prijit 5 bytu (prikaz + 
                            4byty parametr)
073C   1803           00596         btfsc STATUS,C
073D   0008           00597         return                                          ; jeste nemame vsechny parametry
                      00598         ; Prisel prikaz 06h s 4bytovym parametrem 
                      00599 
073E   0879           00600         movfw 0x079                                     ; nejnizsi cast clusteru
073F   00BC           00601         movwf CLUSTER1
0740   087A           00602         movfw 0x07A
0741   00BD           00603         movwf CLUSTER2
0742   087B           00604         movfw 0x07B
0743   00BE           00605         movwf CLUSTER3
0744   087C           00606         movfw 0x07C
0745   00BF           00607         movwf CLUSTER4
0746   2???           00608         call NEXT_CLUSTER
0747   083B           00609         movfw POZICE                            ; pokud POZICE = 00h, je vse v poradku (vratime c. dalsi
                            ho clusteru v retezci). 
                      00610                                                                 ; Pokud POZICE = FFh byl predany cluster
                             posledni v retezu, nebo byl prazdny...
0748   2???           00611         call WR_USART
0749   083C           00612         movfw CLUSTER1
074A   2???           00613         call WR_USART
074B   083D           00614         movfw CLUSTER2
074C   2???           00615         call WR_USART
074D   083E           00616         movfw CLUSTER3
074E   2???           00617         call WR_USART
074F   083F           00618         movfw CLUSTER4
0750   2???           00619         call WR_USART
                      00620         
0751   01F3           00621         clrf PRIJATYCH_DAT                      ; vyprazdnime zasobnik prikazu
0752   0008           00622         return
                      00623 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
MPASM 03.90 Released                                  MP3.ASM   12-16-2005  14:37:50         PAGE 62


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                            XXXXXXXXXXXXXXXXXXXXX
0753                  00624 PRIKAZ_07h                                              ; 07h  cti cluster
0753   0878           00625         movfw 0x078                                     ; prvni byte zasobniku prikazu
0754   3C07           00626         sublw h'07'                                     
0755   1D03           00627         btfss STATUS,Z
0756   0008           00628         return                                          ; nebyl prijat prikaz 07h
0757   1475           00629         bsf STAV_PRIKAZU,0                      ; mame tu prikaz 07h, nastavime byt STAV_REGISTRU
0758   0873           00630         movfw PRIJATYCH_DAT
0759   3C04           00631         sublw .4                                        ; pro prikaz 07h museji prijit 5 bytu (prikaz + 
                            4byty parametr)
075A   1803           00632         btfsc STATUS,C
075B   0008           00633         return                                          ; jeste nemame vsechny parametry
                      00634         ; Prisel prikaz 06h s 4bytovym parametrem 
                      00635 
075C   0879           00636         movfw 0x079                                     ; nejnizsi cast clusteru
075D   00BC           00637         movwf CLUSTER1
075E   087A           00638         movfw 0x07A
075F   00BD           00639         movwf CLUSTER2
0760   087B           00640         movfw 0x07B
0761   00BE           00641         movwf CLUSTER3
0762   087C           00642         movfw 0x07C
0763   00BF           00643         movwf CLUSTER4
0764   01BB           00644         clrf POZICE
0765   2???           00645         call CLUSTER_TO_LBA                     ; zjistime si skutecnou polohu pozadovaneho clusteru na 
                            disku...
0766   084C           00646         movfw CLUSTER_SIZE
0767   00A6           00647         movwf SECTOR_C                          ; tentokrat cteme cely cluster a ne sector
0768   2???           00648         call READ_SECTOR;S
                      00649 
0769   084C           00650         movfw CLUSTER_SIZE
076A   00B7           00651         movwf TEMP2                                     ; kolik sektoru budeme odesilat
                      00652 
076B                  00653 PRIKAZ_07h__ODESLI_SECTOR
076B   3000           00654         movlw .0                                        ; budeme odesilat cely sector (256slov = 512bytu
                            )
076C   00B6           00655         movwf TEMP1
076D   2???           00656         call ODESLI_DATA
076E   0BB7           00657         decfsz TEMP2,F                          ; a to tolikrat, kolik ma cluster sektroru
076F   2???           00658         goto PRIKAZ_07h__ODESLI_SECTOR
                      00659         
0770   01F3           00660         clrf PRIJATYCH_DAT                      ; vyprazdnime zasobnik prikazu
0771   0008           00661         return
                      00662 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
0772                  00663 PRIKAZ_08h                                              ; 08h  vrat velikost souboru
0772   0878           00664         movfw 0x078                                     ; prvni byte zasobniku prikazu
0773   3C08           00665         sublw h'08'                                     
0774   1D03           00666         btfss STATUS,Z
0775   0008           00667         return                                          ; nebyl prijat prikaz 08h
0776   1475           00668         bsf STAV_PRIKAZU,0                      ; mame tu prikaz 08h, nastavime byt STAV_REGISTRU
0777   0873           00669         movfw PRIJATYCH_DAT
0778   3C06           00670         sublw .6                                        ; pro prikaz 08h museji prijit 7 bytu (prikaz + 
                            6byty parametr)
0779   1803           00671         btfsc STATUS,C
MPASM 03.90 Released                                  MP3.ASM   12-16-2005  14:37:50         PAGE 63


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

077A   0008           00672         return                                          ; jeste nemame vsechny parametry
                      00673         ; Prisel prikaz 08h s 6bytovym parametrem 
                      00674 
077B   087D           00675         movfw 0x07D                                     ; 5. parametr prikazu (cast adresare) Muze byt v
                             rozsahu 0..[CLUSTER_SIZE -1]
077C   00BB           00676         movwf POZICE
077D   024C           00677         subwf CLUSTER_SIZE,W            ; W := CLUSTER_SIZE - [sektor v clusteru]
                      00678                                                                 ; pokud W <= 0 tak je 5. parametr mimo r
                            ozsah. Prvni byte odpovedi bude 80h
077E   1903           00679         btfsc STATUS,Z                          ; pokud neni vysledek nula...
077F   2???           00680         goto PRIKAZ_08h__PAR_OK         ; ...je parametr OK
0780   1803           00681         btfsc STATUS,C                          ; Pokud neni vysledek zaporny...
0781   2???           00682         goto PRIKAZ_08h__PAR_OK         ; ...je parametr OK
                      00683 
                      00684         ;Parametr byl zadan prilis velky (v jednom clusteru je CLUSTER_SIZE * 16 zaznamu)
0782                  00685 PRIKAZ_08h__PAR_NOT_OK
0782   3080           00686         movlw h'80'                                     ; jako prvni byte odpovedi dame 80h (parametr by
                            l prilis velky)
0783   00B7           00687         movwf TEMP2
0784   2???           00688         goto PRIKAZ_08h__KONEC
0785                  00689 PRIKAZ_08h__PAR_OK      
                      00690         ; Parametr "castClusteru" byl zadan spravne, jdem se podivat zda parametr "CisloZaznamu" je v ro
                            zsahu 0..15
0785   087E           00691         movfw 0x07E                                     ; kolikaty zaznam v casti adersare (sektoru) mam
                            e precist
0786   39F0           00692         andlw b'11110000'
0787   1D03           00693         btfss STATUS,Z                          ; pokud je parametr vetsi jak 15...
0788   2???           00694         goto PRIKAZ_08h__PAR_NOT_OK     ; ...tak odesleme jako prvni byte odpovedi 80h
                      00695 
                      00696         ; Jdem precist sektor clusteru, v kterem se nachazi pozadovany zaznam. Cislo tohoto sektoru (off
                            set v clusteru) mame v POZICE.
0789   0879           00697         movfw 0x079                                     ; nejnizsi cast clusteru adresare
078A   00BC           00698         movwf CLUSTER1
078B   087A           00699         movfw 0x07A
078C   00BD           00700         movwf CLUSTER2
078D   087B           00701         movfw 0x07B
078E   00BE           00702         movwf CLUSTER3
078F   087C           00703         movfw 0x07C
0790   00BF           00704         movwf CLUSTER4
0791   2???           00705         call CLUSTER_TO_LBA                     ; zjistime si skutecnou polohu zaznamu na disku
0792   3001           00706         movlw .1
0793   00A6           00707         movwf SECTOR_C
0794   2???           00708         call READ_SECTOR                        ; dame prikaz jej precist
                      00709 
0795   087E           00710         movfw 0x07E                                     ; kolikaty zaznam v casti adersare (sektoru) mam
                            e precist
0796   390F           00711         andlw b'00001111'
0797   00B6           00712         movwf TEMP1                                     ; rozsah by mel byt spravne, pro jistotu jej ale
                             orizneme [0..15]
0798   39FF           00713         andlw h'FF'
0799   1903           00714         btfsc STATUS,Z                          ; pokud chceme prvni soubor ze sektoru...
079A   2???           00715         goto PRIKAZ_08h__MAME_SOUBOR    ; ...skocime rovnou na jeho cteni.
                      00716 
079B   0EB6           00717         swapf TEMP1,F                           ; protoze kazdy zaznam o souboru ma 32B=16slov, tak musi
MPASM 03.90 Released                                  MP3.ASM   12-16-2005  14:37:50         PAGE 64


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                            me TEMP1 vynasobit 16...
079C   2???           00718         call PRESKOC                            ; a tolik slov preskocit (tolik slov je pro nas nepotreb
                            nych)
079D                  00719 PRIKAZ_08h__MAME_SOUBOR
079D   3000           00720         movlw h'00'                                     ; jako prvni byte odpovedi dame 00h -> spravne p
                            arametry
079E   00B7           00721         movwf TEMP2
079F   2???           00722         call FILE_SIZE
07A0                  00723 PRIKAZ_08h__KONEC
07A0   0837           00724         movfw TEMP2
07A1   2???           00725         call WR_USART                           ; signalizace stavu odpovedi
                      00726 
07A2   3004           00727         movlw .4
07A3   00B6           00728         movwf TEMP1
07A4   2???           00729         call ODESLI_BUFFER2                     ; odesleme si velikost souboru
                      00730 
07A5   01F3           00731         clrf PRIJATYCH_DAT                      ; vyprazdnime zasobnik prikazu
07A6   0008           00732         return
                      00733 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
07A7                  00734 PRIKAZ_80h                                              ; 80h  hraj mp3 soubor
07A7   0878           00735         movfw 0x078                                     ; prvni byte zasobniku prikazu
07A8   3C80           00736         sublw h'80'
07A9   1D03           00737         btfss STATUS,Z
07AA   0008           00738         return                                          ; nebyl prijat prikaz 80h
07AB   1475           00739         bsf STAV_PRIKAZU,0                      ; mame tu prikaz 80h, nastavime byt STAV_REGISTRU
07AC   0873           00740         movfw PRIJATYCH_DAT
07AD   3C06           00741         sublw .6                                        ; pro prikaz 80h museji prijit 7 bytu (prikaz + 
                            6byty parametr)
07AE   1803           00742         btfsc STATUS,C
07AF   0008           00743         return                                          ; jeste nemame vsechny parametry
                      00744         ; Prisel prikaz 08h s 6bytovym parametrem 
                      00745 
07B0   087D           00746         movfw 0x07D                                     ; 5. parametr prikazu (cast adresare) Muze byt v
                             rozsahu 0..[CLUSTER_SIZE -1]
07B1   00BB           00747         movwf POZICE
07B2   024C           00748         subwf CLUSTER_SIZE,W            ; W := CLUSTER_SIZE - [sektor v clusteru]
                      00749                                                                 ; pokud W <= 0 tak je 5. parametr mimo r
                            ozsah. Prvni byte odpovedi bude 80h
07B3   1903           00750         btfsc STATUS,Z                          ; pokud neni vysledek nula...
07B4   2???           00751         goto PRIKAZ_80h__PAR_OK         ; ...je parametr OK
07B5   1803           00752         btfsc STATUS,C                          ; Pokud neni vysledek zaporny...
07B6   2???           00753         goto PRIKAZ_80h__PAR_OK         ; ...je parametr OK
                      00754 
                      00755         ;Parametr byl zadan prilis velky (v jednom clusteru je CLUSTER_SIZE * 16 zaznamu)
07B7                  00756 PRIKAZ_80h__PAR_NOT_OK
                      00757         INDF_BANK_2
07B7   1783               M                         bsf STATUS,IRP    
07B8   3010           00758         movlw 0x10                                      ; 1. byte bufferu 2
07B9   0084           00759         movwf FSR
07BA   3080           00760         movlw h'80'                                     ; jako prvni byte odpovedi dame 80h (parametr by
                            l prilis velky)
07BB   0080           00761         movwf INDF
07BC   2???           00762         goto PRIKAZ_80h__KONEC
MPASM 03.90 Released                                  MP3.ASM   12-16-2005  14:37:50         PAGE 65


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

07BD                  00763 PRIKAZ_80h__PAR_OK      
                      00764         ; Parametr "castClusteru" byl zadan spravne, jdem se podivat zda parametr "CisloZaznamu" je v ro
                            zsahu 0..15
07BD   087E           00765         movfw 0x07E                                     ; kolikaty zaznam v casti adersare (sektoru) mam
                            e precist
07BE   39F0           00766         andlw b'11110000'
07BF   1D03           00767         btfss STATUS,Z                          ; pokud je parametr vetsi jak 15...
07C0   2???           00768         goto PRIKAZ_80h__PAR_NOT_OK     ; ...tak odesleme jako prvni byte odpovedi 80h
                      00769 
                      00770         ; Jdem precist sektor clusteru, v kterem se nachazi pozadovany zaznam. Cislo tohoto sektoru (off
                            set v clusteru) mame v POZICE.
07C1   0879           00771         movfw 0x079                                     ; nejnizsi cast clusteru adresare
07C2   00BC           00772         movwf CLUSTER1
07C3   087A           00773         movfw 0x07A
07C4   00BD           00774         movwf CLUSTER2
07C5   087B           00775         movfw 0x07B
07C6   00BE           00776         movwf CLUSTER3
07C7   087C           00777         movfw 0x07C
07C8   00BF           00778         movwf CLUSTER4
07C9   2???           00779         call CLUSTER_TO_LBA                     ; zjistime si skutecnou polohu zaznamu na disku
07CA   3001           00780         movlw .1
07CB   00A6           00781         movwf SECTOR_C
07CC   2???           00782         call READ_SECTOR                        ; dame prikaz jej precist
                      00783 
07CD   087E           00784         movfw 0x07E                                     ; kolikaty zaznam v casti adersare (sektoru) mam
                            e precist
07CE   390F           00785         andlw b'00001111'
07CF   00B6           00786         movwf TEMP1                                     ; rozsah by mel byt spravne, pro jistotu jej ale
                             orizneme [0..15]
07D0   39FF           00787         andlw h'FF'
07D1   1903           00788         btfsc STATUS,Z                          ; pokud chceme prvni soubor ze sektoru...
07D2   2???           00789         goto PRIKAZ_80h__MAME_SOUBOR    ; ...skocime rovnou na jeho cteni.
                      00790 
07D3   0EB6           00791         swapf TEMP1,F                           ; protoze kazdy zaznam o souboru ma 32B=16slov, tak musi
                            me TEMP1 vynasobit 16...
07D4   2???           00792         call PRESKOC                            ; a tolik slov preskocit (tolik slov je pro nas nepotreb
                            nych)
07D5                  00793 PRIKAZ_80h__MAME_SOUBOR
07D5   2???           00794         call FILE_INFO
                      00795 
                      00796         INDF_BANK_2
07D6   1783               M                         bsf STATUS,IRP    
07D7   3010           00797         movlw 0x10                                      ; 1. byte bufferu 2
07D8   0084           00798         movwf FSR
07D9   0800           00799         movfw INDF
07DA   3C06           00800         sublw h'06'                                     ; pokud na zadanem miste se nachazi soubor s pri
                            ponou mp3...
07DB   1D03           00801         btfss STATUS,Z
07DC   2???           00802         goto PRIKAZ_80h__KONEC
                      00803                         
                      00804         ; ...nastavime jej jako prehravany soubor.
07DD   301C           00805         movlw 0x1C                                      ; 13. byte bufferu 2
07DE   0084           00806         movwf FSR
07DF   0800           00807         movfw INDF
MPASM 03.90 Released                                  MP3.ASM   12-16-2005  14:37:50         PAGE 66


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

07E0   00E6           00808         movwf PREH_DATA_CL1
07E1   0A84           00809         incf FSR,f
07E2   0800           00810         movfw INDF
07E3   00E7           00811         movwf PREH_DATA_CL2
07E4   0A84           00812         incf FSR,f
07E5   0800           00813         movfw INDF
07E6   00E8           00814         movwf PREH_DATA_CL3
07E7   0A84           00815         incf FSR,f
07E8   0800           00816         movfw INDF
07E9   00E9           00817         movwf PREH_DATA_CL4
                      00818         
07EA   01EA           00819         clrf PREH_DATA_POZICE
07EB   3003           00820         movlw b'00000011'
07EC   00EB           00821         movwf PREH_STAV
                      00822 
07ED                  00823 PRIKAZ_80h__KONEC
                      00824         INDF_BANK_2
07ED   1783               M                         bsf STATUS,IRP    
07EE   3010           00825         movlw 0x10                                      ; 1. byte bufferu 2
07EF   0084           00826         movwf FSR
07F0   0800           00827         movfw INDF
07F1   2???           00828         call WR_USART   
                      00829         
07F2   01F3           00830         clrf PRIJATYCH_DAT                      ; vyprazdnime zasobnik prikazu
07F3   0008           00831         return
                      00832 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
07F4                  00833 PRIKAZ_81h                                              ; 81h  vrat stav prehravaneho souboru
07F4   0878           00834         movfw 0x078                                     ; prvni byte zasobniku prikazu
07F5   3C81           00835         sublw h'81'
07F6   1D03           00836         btfss STATUS,Z
07F7   0008           00837         return                                          ; nebyl prijat prikaz 04h
07F8   1475           00838         bsf STAV_PRIKAZU,0                      ; mame tu prikaz 04h, nastavime byt STAV_REGISTRU
                      00839         ; pro prikaz 04h nejsou definovany zadne parametry, proto jiz nic jineho netestujeme
                      00840 
07F9   086B           00841         movfw PREH_STAV
07FA   2???           00842         call WR_USART
07FB   01F3           00843         clrf PRIJATYCH_DAT                      ; vyprazdnime zasobnik
07FC   0008           00844         return
                      00845 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
07FD                  00846 PRIKAZ_82h                                              ; 82h  nastav hlasitost
07FD   0878           00847         movfw 0x078                                     ; prvni byte zasobniku prikazu
07FE   3C82           00848         sublw h'82'
07FF   1D03           00849         btfss STATUS,Z
0800   0008           00850         return                                          ; nebyl prijat prikaz 82h
0801   1475           00851         bsf STAV_PRIKAZU,0                      ; mame tu prikaz 82h, nastavime byt STAV_REGISTRU
0802   0873           00852         movfw PRIJATYCH_DAT
0803   3C02           00853         sublw .2                                        ; pro prikaz 82h museji prijit 3 byty (prikaz + 
                            2byty parametr)
0804   1803           00854         btfsc STATUS,C
0805   0008           00855         return                                          ; jeste nemame vsechny parametry
                      00856         ; Prisel prikaz 82h s 2bytovym parametrem 
                      00857 
MPASM 03.90 Released                                  MP3.ASM   12-16-2005  14:37:50         PAGE 67


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0806   0879           00858         movfw 0x079                                     ; hlasitost pro levy kanal
0807   00CF           00859         movwf VSREG_VOL_L       
0808   087A           00860         movfw 0x07A                                     ; hlasitost pro pravy kanal
0809   00D0           00861         movwf VSREG_VOL_H
080A   2???           00862         call VS_SET_VOLUME                      ; nastavime hlasitost   
                      00863 
080B   30FF           00864         movlw h'FF'
080C   2???           00865         call WR_USART
080D   01F3           00866         clrf PRIJATYCH_DAT                      ; vyprazdnime zasobnik
080E   0008           00867         return
                      00868 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
                      00869         END
MPASM 03.90 Released                                  MP3.ASM   12-16-2005  14:37:50         PAGE 68


SYMBOL TABLE
  LABEL                             VALUE 

ABRT                              00000002
ACKDT                             00000005
ACKEN                             00000004
ACKSTAT                           00000006
ADCON0                            0000001F
ADCON1                            0000009F
ADCS0                             00000006
ADCS1                             00000007
ADDEN                             00000003
ADFM                              00000007
ADIE                              00000006
ADIF                              00000006
ADON                              00000000
ADRESH                            0000001E
ADRESL                            0000009E
APPLICABLE                        00000007
ATA_ADDRESS                       00000007
ATA_ADDRESS_TRIS                  00000087
ATA_ATTRIBUTES                    0000002E
ATA_CONTROL                       00000009
ATA_CONTROL_TRIS                  00000089
ATA_DIOR_N                        ATA_CONTROL,2
ATA_DIOW_N                        ATA_CONTROL,1
ATA_ERROR                         00000025
ATA_OK                            00000000
ATA_RESET                         000000AE
ATA_RESET_N                       ATA_CONTROL,0
ATA_STATUS                        0000002C
ATA_STATUS_A                      00000022
BANK_0                            
BANK_1                            
BANK_2                            
BANK_3                            
BCLIE                             00000003
BCLIF                             00000003
BF                                00000000
BIG_LOOP                          000005D9
BIG_LOOP__NENI_PRIKAZ             000005E8
BIG_SECTOR                        00000003
BRGH                              00000002
BSY                               00000007
C                                 00000000
CCP1CON                           00000017
CCP1IE                            00000002
CCP1IF                            00000002
CCP1M0                            00000000
CCP1M1                            00000001
CCP1M2                            00000002
CCP1M3                            00000003
CCP1X                             00000005
CCP1Y                             00000004
CCP2CON                           0000001D
CCP2IE                            00000000
CCP2IF                            00000000
MPASM 03.90 Released                                  MP3.ASM   12-16-2005  14:37:50         PAGE 69


SYMBOL TABLE
  LABEL                             VALUE 

CCP2M0                            00000000
CCP2M1                            00000001
CCP2M2                            00000002
CCP2M3                            00000003
CCP2X                             00000005
CCP2Y                             00000004
CCPR1H                            00000016
CCPR1L                            00000015
CCPR2H                            0000001C
CCPR2L                            0000001B
CEKEJ_PRIKAZ                      000006C0
CEK_PRIKAZ_01h                    000005C6
CEK_PRIKAZ_02h_03h                000005D0
CHS0                              00000003
CHS1                              00000004
CHS2                              00000005
CKE                               00000006
CKP                               00000004
CLEAR_BEFFER2__CLEAR              000000A8
CLEAR_BUFFER2                     000000A2
CLUSTER1                          0000003C
CLUSTER2                          0000003D
CLUSTER3                          0000003E
CLUSTER4                          0000003F
CLUSTER_SIZE                      0000004C
CLUSTER_TO_LBA                    000002E7
CLUSTER_TO_LBA_NO_ROOT            0000030B
COMMAND                           0000002D
CREN                              00000004
CSRC                              00000007
D                                 00000005
DATA_ADDRESS                      00000005
DATA_H                            00000021
DATA_L                            00000020
DATA_PORT_HIGH                    00000008
DATA_PORT_HIGH_TRIS               00000088
DATA_PORT_LOW                     00000006
DATA_PORT_LOW_TRIS                00000086
DC                                00000001
DELAY_200ms                       000006AA
DELAY_25us                        00000148
DELAY_2ms                         000006A1
DELAY_500ms                       000006B3
DEVICE                            0000002B
DEVICE_C                          00000023
DRDY                              00000006
DRQ                               00000003
D_A                               00000005
D_COMMAND                         00000027
D_DATA_R                          00000020
D_DEVICE                          00000026
D_DEVICE_C                        00000016
D_ERROR                           00000021
D_FEATURES                        00000021
MPASM 03.90 Released                                  MP3.ASM   12-16-2005  14:37:50         PAGE 70


SYMBOL TABLE
  LABEL                             VALUE 

D_LBA1                            00000023
D_LBA2                            00000024
D_LBA3                            00000025
D_SECTOR_C                        00000022
D_STATUS                          00000027
D_STATUS_A                        00000016
EEADR                             0000010D
EEADRH                            0000010F
EECON1                            0000018C
EECON2                            0000018D
EEDATA                            0000010C
EEDATH                            0000010E
EEIE                              00000004
EEIF                              00000004
EEPGD                             00000007
END_OF_INTERRUPT                  0000069B
ERR                               00000000
ERROR_LED                         ATA_ADDRESS,3
F                                 00000001
FAT32_LOAD                        00000004
FEATURES                          00000024
FERR                              00000002
FILE_INFO                         000003CE
FILE_INFO__DIR                    0000040A
FILE_INFO__FILE                   0000040C
FILE_INFO__KONEC                  00000425
FILE_INFO__READ_NAME              000003D6
FILE_SIZE                         00000426
FSR                               00000004
GCEN                              00000007
GIE                               00000007
GO                                00000002
GO_DONE                           00000002
HOB                               00000007
I2C_DATA                          00000005
I2C_READ                          00000002
I2C_START                         00000003
I2C_STOP                          00000004
IBF                               00000007
IBOV                              00000005
IDENTIFY_DEVICE                   000000F5
INDF                              00000000
INDF_BANK_0                       
INDF_BANK_1                       
INDF_BANK_2                       
INDF_BANK_3                       
INIT_ATA__DALSI                   00000134
INIT_ATA__DALSI2                  0000013E
INIT_ATA__NOT_SUPPORT_LBA48       00000131
INIT_CONFIG                       00000634
INIT_PORT                         00000621
INTCON                            0000000B
INTE                              00000004
INTEDG                            00000006
MPASM 03.90 Released                                  MP3.ASM   12-16-2005  14:37:50         PAGE 71


SYMBOL TABLE
  LABEL                             VALUE 

INTERRUPT                         00000685
INTF                              00000001
IRP                               00000007
LBA1                              00000027
LBA2                              00000028
LBA3                              00000029
LBA4                              0000002A
LBA48_SUPPORT                     00000002
LBA_SUPPORT                       00000001
MP3_BSYNC                         MP3_PORT,5
MP3_CS                            MP3_PORT,3
MP3_DREQ                          MP3_PORT,4
MP3_NOT_PLAY                      00000620
MP3_PORT                          00000005
MP3_PORT_TRIS                     00000085
MP3_SCLK                          MP3_PORT,2
MP3_SI                            MP3_PORT,1
MP3_SO                            MP3_PORT,0
NACTI_FAT32                       00000223
NACTI_FAT32__KONEC                000002E6
NEXT_CLUSTER                      00000346
NEXT_CLUSTER_KONEC                000003CB
NEXT_CLUSTER_NEPRAZDNY            000003B4
NEXT_CLUSTER_NO_ROOT              0000036A
NOT_A                             00000005
NOT_ADDRESS                       00000005
NOT_BO                            00000000
NOT_BOR                           00000000
NOT_DONE                          00000002
NOT_PD                            00000003
NOT_POR                           00000001
NOT_RBPU                          00000007
NOT_RC8                           00000006
NOT_T1SYNC                        00000002
NOT_TO                            00000004
NOT_TX8                           00000006
NOT_W                             00000002
NOT_WRITE                         00000002
NULA                              000005A7
OBF                               00000006
ODESLI_BUFFER2                    0000067B
ODESLI_BUFFER2_ODESILANI          0000067E
ODESLI_DATA                       00000662
ODESLI_MODEL_NUMBER               0000066A
ODESLI_MODEL_NUMBER_ODESILANI     0000066F
OERR                              00000001
OPERAND_X1                        000000A0
OPERAND_X2                        000000A1
OPERAND_X3                        000000A2
OPERAND_X4                        000000A3
OPERAND_Y1                        000000A4
OPERAND_Y2                        000000A5
OPERAND_Y3                        000000A6
OPERAND_Y4                        000000A7
MPASM 03.90 Released                                  MP3.ASM   12-16-2005  14:37:50         PAGE 72


SYMBOL TABLE
  LABEL                             VALUE 

OPTION_REG                        00000081
P                                 00000004
PARAM_MAX_LBA1                    0000002F
PARAM_MAX_LBA2                    00000030
PARAM_MAX_LBA3                    00000031
PARAM_MAX_LBA4                    00000032
PARAM_SLOV_V_SEKTORU1             00000033
PARAM_SLOV_V_SEKTORU2             00000034
PCFG0                             00000000
PCFG1                             00000001
PCFG2                             00000002
PCFG3                             00000003
PCL                               00000002
PCLATH                            0000000A
PCON                              0000008E
PEIE                              00000006
PEN                               00000002
PIE1                              0000008C
PIE2                              0000008D
PIR1                              0000000C
PIR2                              0000000D
POCATEK_DAT1                      00000040
POCATEK_DAT2                      00000041
POCATEK_DAT3                      00000042
POCATEK_DAT4                      00000043
POCATEK_FAT1                      00000044
POCATEK_FAT2                      00000045
POCATEK_FAT3                      00000046
POCATEK_FAT4                      00000047
PORTA                             00000005
PORTB                             00000006
PORTC                             00000007
PORTD                             00000008
PORTE                             00000009
POSUNDOLEVA                       00000523
POSUNDOLEVA_1                     00000529
POSUNDOLEVA_2                     00000531
POSUNDOLEVA_3                     0000053A
POSUNDOLEVA_4                     00000544
POSUNDOLEVA_5                     0000054F
POSUNDOPRAVA                      0000055B
POSUNDOPRAVA_1                    00000561
POSUNDOPRAVA_2                    0000056A
POSUNDOPRAVA_3                    00000574
POSUNDOPRAVA_4                    0000057F
POSUNDOPRAVA_5                    0000058B
POSUNDOPRAVA_7                    00000598
POZDRAV                           00000657
POZICE                            0000003B
PR2                               00000092
PREH_ADDR_CL1                     00000060
PREH_ADDR_CL2                     00000061
PREH_ADDR_CL3                     00000062
PREH_ADDR_CL4                     00000063
MPASM 03.90 Released                                  MP3.ASM   12-16-2005  14:37:50         PAGE 73


SYMBOL TABLE
  LABEL                             VALUE 

PREH_ADDR_POZICE                  00000064
PREH_ADDR_ZAZNAM                  00000065
PREH_DATA_CL1                     00000066
PREH_DATA_CL2                     00000067
PREH_DATA_CL3                     00000068
PREH_DATA_CL4                     00000069
PREH_DATA_POZICE                  0000006A
PREH_STAV                         0000006B
PRESKOC                           0000008C
PRETECENI                         000000AC
PRIJATE_DATO                      00000074
PRIJATYCH_DAT                     00000073
PRIKAZ_02h                        000006C5
PRIKAZ_02h__ODESILANI_ODDILU      000006DB
PRIKAZ_03h                        000006E2
PRIKAZ_04h                        000006F8
PRIKAZ_05h                        00000701
PRIKAZ_05h__KONEC                 00000730
PRIKAZ_05h__MAME_SOUBOR           0000072F
PRIKAZ_05h__PAR_NOT_OK            00000711
PRIKAZ_05h__PAR_OK                00000717
PRIKAZ_06h                        00000735
PRIKAZ_07h                        00000753
PRIKAZ_07h__ODESLI_SECTOR         0000076B
PRIKAZ_08h                        00000772
PRIKAZ_08h__KONEC                 000007A0
PRIKAZ_08h__MAME_SOUBOR           0000079D
PRIKAZ_08h__PAR_NOT_OK            00000782
PRIKAZ_08h__PAR_OK                00000785
PRIKAZ_80h                        000007A7
PRIKAZ_80h__KONEC                 000007ED
PRIKAZ_80h__MAME_SOUBOR           000007D5
PRIKAZ_80h__PAR_NOT_OK            000007B7
PRIKAZ_80h__PAR_OK                000007BD
PRIKAZ_81h                        000007F4
PRIKAZ_82h                        000007FD
PS0                               00000000
PS1                               00000001
PS2                               00000002
PSA                               00000003
PSPIE                             00000007
PSPIF                             00000007
PSPMODE                           00000004
R                                 00000002
RBIE                              00000003
RBIF                              00000000
RC8_9                             00000006
RC9                               00000006
RCD8                              00000000
RCEN                              00000003
RCIE                              00000005
RCIF                              00000005
RCREG                             0000001A
RCSTA                             00000018
MPASM 03.90 Released                                  MP3.ASM   12-16-2005  14:37:50         PAGE 74


SYMBOL TABLE
  LABEL                             VALUE 

RD                                00000000
RD_DEVICE                         00000021
RD_ERROR                          00000009
RD_LBA1                           00000015
RD_LBA2                           00000019
RD_LBA3                           0000001D
RD_SC                             00000011
RD_STATUS                         00000005
RD_STATUS_A                       0000000D
READ_DATA                         00000079
READ_SECTOR                       000000C9
READ_SECTOR_LBA27                 000000CE
READ_SECTOR_LBA48                 000000DD
READ_WRITE                        00000002
ROOT_DIR_CL1                      00000048
ROOT_DIR_CL2                      00000049
ROOT_DIR_CL3                      0000004A
ROOT_DIR_CL4                      0000004B
ROZDIL                            000004FA
RP0                               00000005
RP1                               00000006
RSEN                              00000001
RUTR                              00000056
RUTW                              00000063
RX9                               00000006
RX9D                              00000000
R_W                               00000002
S                                 00000003
SCAN_BR                           00000166
SCAN_MBR                          00000160
SCAN_MBR__HLEDEJ_ROZSIRENY_ODDIL  000001AF
SCAN_MBR__KONEC                   000001D9
SECTOR_C                          00000026
SELECT_DEVICE                     00000090
SEN                               00000000
SEND_MP3_DATA                     00000606
SEND_MP3_WORD                     00000617
SMP                               00000007
SOUCET                            000004D1
SPBRG                             00000099
SPEN                              00000007
SREN                              00000005
SRST                              00000002
SSPADD                            00000093
SSPBUF                            00000013
SSPCON                            00000014
SSPCON2                           00000091
SSPEN                             00000005
SSPIE                             00000003
SSPIF                             00000003
SSPM0                             00000000
SSPM1                             00000001
SSPM2                             00000002
SSPM3                             00000003
MPASM 03.90 Released                                  MP3.ASM   12-16-2005  14:37:50         PAGE 75


SYMBOL TABLE
  LABEL                             VALUE 

SSPOV                             00000006
SSPSTAT                           00000094
START                             000005BA
STATUS                            00000003
STAV_PRIKAZU                      00000075
SYNC                              00000004
T0CS                              00000005
T0IE                              00000005
T0IF                              00000002
T0SE                              00000004
T1CKPS0                           00000004
T1CKPS1                           00000005
T1CON                             00000010
T1INSYNC                          00000002
T1OSCEN                           00000003
T1SYNC                            00000002
T2CKPS0                           00000000
T2CKPS1                           00000001
T2CON                             00000012
TEMP1                             00000036
TEMP2                             00000037
TEMP3                             00000038
TEMP4                             00000039
TEMP5                             0000003A
TEMPW                             00000035
TEMP_FSR                          00000072
TEMP_STATUS                       00000071
TEMP_WORKING                      00000070
TMP0                              00000038
TMP1                              00000036
TMP2                              00000037
TMR0                              00000001
TMR1CS                            00000001
TMR1H                             0000000F
TMR1IE                            00000000
TMR1IF                            00000000
TMR1L                             0000000E
TMR1ON                            00000000
TMR2                              00000011
TMR2IE                            00000001
TMR2IF                            00000001
TMR2ON                            00000002
TOUTPS0                           00000003
TOUTPS1                           00000004
TOUTPS2                           00000005
TOUTPS3                           00000006
TRISA                             00000085
TRISB                             00000086
TRISC                             00000087
TRISD                             00000088
TRISE                             00000089
TRISE0                            00000000
TRISE1                            00000001
TRISE2                            00000002
MPASM 03.90 Released                                  MP3.ASM   12-16-2005  14:37:50         PAGE 76


SYMBOL TABLE
  LABEL                             VALUE 

TRMT                              00000001
TX8_9                             00000006
TX9                               00000006
TX9D                              00000000
TXD8                              00000000
TXEN                              00000005
TXIE                              00000004
TXIF                              00000004
TXREG                             00000019
TXSTA                             00000098
UA                                00000001
VS1001                            1
VSADDR_AIADDR                     0000000A
VSADDR_AICTRL0                    0000000D
VSADDR_AICTRL1                    0000000E
VSADDR_AUDATA                     00000005
VSADDR_CLOCKF                     00000003
VSADDR_DECODE_TIME                00000004
VSADDR_HDAT0                      00000008
VSADDR_HDAT1                      00000009
VSADDR_MODE                       00000000
VSADDR_STATUS                     00000001
VSADDR_VOL                        0000000B
VSADDR_WRAM                       00000006
VSADDR_WRAMADDR                   00000007
VSREG_MODE_L                      0000004D
VSREG_STATUS_L                    0000004E
VSREG_VOL_H                       00000050
VSREG_VOL_L                       0000004F
VS_BEEP                           000004A1
VS_INIT                           000004C7
VS_SEND_1024_NULL                 0000048F
VS_SEND_32_NULL                   00000487
VS_SET_VOLUME                     00000496
VS_SOFT_RESET                     0000047B
VS_WR_BYTE                        0000043B
VS_WR_REG                         00000470
VYSLEDEK1                         000000A8
VYSLEDEK2                         000000A9
VYSLEDEK3                         000000AA
VYSLEDEK4                         000000AB
W                                 00000000
WAIT_FOR_DATA                     0000014D
WAIT_FOR_READY                    00000156
WAIT_FOR_READY_FOR_COMMAND        0000015C
WAIT_FOR_VSDREQ                   0000049E
WCOL                              00000007
WR                                00000001
WREN                              00000002
WRERR                             00000003
WR_BLOCK                          0000004D
WR_COMMAND                        0000002A
WR_DC                             00000025
WR_DEVICE                         00000043
MPASM 03.90 Released                                  MP3.ASM   12-16-2005  14:37:50         PAGE 77


SYMBOL TABLE
  LABEL                             VALUE 

WR_FEATURES                       00000048
WR_LBA1                           00000034
WR_LBA2                           00000039
WR_LBA3                           0000003E
WR_SC                             0000002F
WR_USART                          0000064F
Z                                 00000002
ZAPIS_DO_BUFFERU_1                00000094
ZAPIS_DO_BUFFERU_1__ZAPIS         00000097
ZKONTROLUJ_ODDIL_FAT32            000001DA
ZKONTROLUJ_ODDIL_FAT32__JMENOVKA  000001FD
ZKONTROLUJ_ODDIL_FAT32__KONEC     00000222
_.org_1_014B                      0000014B
_.org_1_048D                      0000048D
_.org_1_0494                      00000494
_.org_1_05C3                      000005C3
_.org_1_06A6                      000006A6
_.org_1_06A8                      000006A8
_.org_1_06AF                      000006AF
_.org_1_06B1                      000006B1
_.org_1_06BA                      000006BA
_.org_1_06BC                      000006BC
_.org_1_06BE                      000006BE
_BODEN_OFF                        00003FBF
_BODEN_ON                         00003FFF
_CPD_OFF                          00003FFF
_CPD_ON                           00003EFF
_CP_ALL                           00000FCF
_CP_HALF                          00001FDF
_CP_OFF                           00003FFF
_CP_UPPER_256                     00002FEF
_DEBUG_OFF                        00003FFF
_DEBUG_ON                         000037FF
_HS_OSC                           00003FFE
_LP_OSC                           00003FFC
_LVP_OFF                          00003F7F
_LVP_ON                           00003FFF
_PWRTE_OFF                        00003FFF
_PWRTE_ON                         00003FF7
_RC_OSC                           00003FFF
_WDT_OFF                          00003FFB
_WDT_ON                           00003FFF
_WRT_ENABLE_OFF                   00003DFF
_WRT_ENABLE_ON                    00003FFF
_XT_OSC                           00003FFD
__16F877                          00000001
nEIN                              00000001

Errors   :     0
Warnings :     0 reported,     0 suppressed
Messages :     0 reported,   149 suppressed

