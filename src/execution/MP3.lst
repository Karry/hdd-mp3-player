MPASM 03.90 Released                                  MP3.ASM   10-25-2005  21:19:59         PAGE  1


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0000                  00001 c;********************************************************************
                      00002 ; Zkusebni program na cteni dat z ATA disku.                      
                      00003 ; Casem mozna bude prekousavat FAT32 a prehravat z disku MP3.
                      00004 ; To je zatim jen ale sen
                      00005 ;                                                                
                      00006 ; srpen 2005 - zari 2005 Karry - lukas.karas@centrum.cz
                      00007 ;********************************************************************
                      00008 
                      00009 ;**********************************************************
                      00010 ;   HLAVNI SOUBOR 
                      00011 ;**********************************************************
                      00012 ; !!!!!!!! VSECHNY CASOVE SMYCKY JSOU POCITANY NA Fosc=16MHz !!!!!
                      00013 ; !!!!!!!! NASTAVENI USARTu TAKY !!!!!!!
                      00014         LIST            p=PIC16f877,C=132,n=60
2007   3F3A           00015         __CONFIG        _WDT_OFF & _HS_OSC & _PWRTE_OFF & _BODEN_OFF & _LVP_OFF 
                      00016                         ; LVP_OFF = RB3 jako digitalni I/O
                      00017         errorlevel -302      ; vypnuti Message [302]: Register in operand not in
                      00018                       ; bank 0.
                      00019                       ; ! zjednoduseni vypisu, ale riziko prehlednuti chyby
                      00020 
                      00021         include "P16F877.inc"   ; definice blbosti kolem procesoru
                      00001         LIST
                      00002 ; P16F877.INC  Standard Header File, Version 1.00    Microchip Technology, Inc.
                      00373         LIST
                      00022         include "mp3.inc"               ; definice promennych a portu
                      00001 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00002 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00003 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00004 ; DEFINICE PORTU
                      00005 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00006 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00007 ;**********************************************************
                      00008 ; ZAPOJENI PORTU:
                      00009 ;       portA - MP3 dekoder vs1001g (alespon doufam ze sezenem tenhle typ, je totiz naprosto spickovej!!
                            !)
                      00010 ;                               5      4     3   2     1         0
                      00011 ;                               BSYNC  DREQ  CS  SCLK  SI/SDATA  SO
                      00012 ;               portB - ATA datova sbernice (dolnich 8 bitu)
                      00013 ;               7   .. 0
                      00014 ;               DD7 .. DD0
                      00015 ;               portD - ATA datova sbernice (hornich 8 bitu)
                      00016 ;               15   .. 8
                      00017 ;               DD15 .. DD8 
                      00018 ;               portC - adresove signaly ATA, ERROR_LED, a USART
                      00019 ;                               7          6         5     4     3          2    1    0
                      00020 ;                               USART out  USART in  CS1-  CS0-  ERROR_LED  DA2  DA1  DA0  
                      00021 ;                               (signaly se znaminkem minus jsou aktivni v logicke 0 !!!)
                      00022 ;               portE - ridici signaly ATA
                      00023 ;                               2       1      0
                      00024 ;                               DIOR-   DIOW-  RESET-
                      00025 ;                               (signaly se znaminkem minus jsou aktivni v logicke 0 !!!)
                      00026 ;**********************************************************
  00000005            00027 MP3_PORT                equ PORTA
  00000085            00028 MP3_PORT_TRIS   equ TRISA
MPASM 03.90 Released                                  MP3.ASM   10-25-2005  21:19:59         PAGE  2


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00029 ; BITY MP3_PORT
                      00030 #define MP3_SO          MP3_PORT,0      ; serial output - tady dostavame z dekoderu data
                      00031 #define MP3_SI          MP3_PORT,1      ; serial input  - pokud MP3_CS=1, tak posilame mp3 data, pokud =
                            0, tak posilame prikaz
                      00032 #define MP3_SCLK        MP3_PORT,2      ; clock - nabezna hrana urcuje platnost dat pri seriovem prenosu
                      00033 #define MP3_CS          MP3_PORT,3      ; cable select  - pokud MP3_CS=1, tak po SI posilame mp3 data, p
                            okud =0, tak posilame prikaz
                      00034 #define MP3_DREQ        MP3_PORT,4      ; data request  - pokud =1, tak dekoder pozaduje dalsi mp3 data
                      00035 #define MP3_BSYNC       MP3_PORT,5      ; pro synchronizaci - ma byt nastaven pri prvnim prenasenem bitu
                             kazdeho bytu
                      00036 ;**********************************************************
                      00037 ; pokud jsem dobre pochopil dataSheat dekoderu vs1001, tak staci do nej jen cpat data, a kdyz skonci mp3
                            , tak odeslat 1024 nulovych bytu,
                      00038 ; softwarove resetovat a posilat dalsi mp3...
                      00039 ;
                      00040 ; popis registru obvodu vs1001 najdete na strane 22 dataSheatu 
                      00041 ; v jeho registrech jsou k dispozici data z hlavicky mp3, zdali mp3 ma spravny format, 
                      00042 ; ovladani hlasitosti a dalsi spousty uzitecnych informaci
                      00043 ;**********************************************************
                      00044 ; PORTY DISKU
  00000007            00045 ATA_ADDRESS             equ PORTC
  00000009            00046 ATA_CONTROL             equ PORTE
  00000006            00047 DATA_PORT_LOW           equ PORTB
  00000008            00048 DATA_PORT_HIGH          equ PORTD
                      00049 
                      00050 
  00000087            00051 ATA_ADDRESS_TRIS        equ TRISC
  00000089            00052 ATA_CONTROL_TRIS        equ TRISE
  00000086            00053 DATA_PORT_LOW_TRIS      equ TRISB
  00000088            00054 DATA_PORT_HIGH_TRIS     equ TRISD
                      00055 
                      00056 ; bity ATA_ADDRESS portu
                      00057 #define ERROR_LED       ATA_ADDRESS,3
                      00058 ; bity ATA_CONTROL portu
                      00059 #define ATA_RESET_N     ATA_CONTROL,0
                      00060 #define ATA_DIOW_N      ATA_CONTROL,1
                      00061 #define ATA_DIOR_N      ATA_CONTROL,2
                      00062 
                      00063 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00064 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00065 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00066 ; DEFINICE KONSTANT
                      00067 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00068 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00069 ; ADRESY ATA REGISTRU:
                      00070 ;                                                                       / CHS adressing
                      00071 ;   +-----------+--------------+-------------------+-----------------+
                      00072 ;   | CS0- CS1- |  DA2 DA1 DA0 | READ              | WRITE           |   
                      00073 ;   +-----------+--------------+-------------------+-----------------+
                      00074 ;   | 1    1    |  x   x   x   | data bush h.imped (validace prikazu)|
                      00075 ;   +-----------+--------------+-------------------+-----------------+
                      00076 ;   | 1    0    |  1   1   0   | alternate status  | device control  |
                      00077 ;   +-----------+--------------+-------------------+-----------------+
                      00078 ;   | 0    1    |  0   0   0   | data              | data            |
MPASM 03.90 Released                                  MP3.ASM   10-25-2005  21:19:59         PAGE  3


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00079 ;   | 0    1    |  0   0   1   | error             | features        |
                      00080 ;   | 0    1    |  0   1   0   |             sector count            |
                      00081 ;   | 0    1    |  0   1   1   |             LBA bits 0-7            |  sector number
                      00082 ;   | 0    1    |  1   0   0   |             LBA bits 8-15           |  cilinder LOW 
                      00083 ;   | 0    1    |  1   0   1   |             LBA bits 16-23          |  cilinder HIGH
                      00084 ;   | 0    1    |  1   1   0   |         device / LBA bits 24-27*    |  device, head
                      00085 ;   | 0    1    |  1   1   1   | status            | command         |
                      00086 ;   +-----------+--------------+-------------------+-----------------+
                      00087 ;   | 0    0    |  0   0   0   | invalid addres    | invalid addres  |
                      00088 ;   +-----------+--------------+-------------------+-----------------+
                      00089 ;
                      00090 ;   * 7 6 5 4   3     2     1     0 
                      00091 ;     1 L 1 DEV LBA27 LBA26 LBA25 LBA24
                      00092 ;  L=1 -> aresa je LBA , L=0 -> adresa je CHS
                      00093 ;  DEV=0 -> master , DEV=1 -> SLAVE
                      00094 ;
                      00095 ;  pokud disk podporuje LBA 48, tak je zadavani adresy trochu odlisne od LBA27
                      00096 ;**********************************************************
                      00097 ; toto jsou definice adres ATA registru. Staci udat jejich adresu na ATA_ADDRESS port a dat prikaz ke ct
                            eni ci zapisu (DIOR- / DIOW-)
  00000016            00098 D_STATUS_A    equ b'00010110'
  00000016            00099 D_DEVICE_C    equ D_STATUS_A
  00000020            00100 D_DATA_R      equ b'00100000'
  00000021            00101 D_FEATURES    equ b'00100001'
  00000021            00102 D_ERROR       equ D_FEATURES
  00000022            00103 D_SECTOR_C    equ b'00100010'
  00000023            00104 D_LBA1        equ b'00100011'   ; LBA low
  00000024            00105 D_LBA2        equ b'00100100'   ; LBA middle
  00000025            00106 D_LBA3        equ b'00100101'   ; LBA high
  00000026            00107 D_DEVICE      equ b'00100110'
  00000027            00108 D_STATUS      equ b'00100111'
  00000027            00109 D_COMMAND     equ D_STATUS
                      00110 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00111 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00112 ; DEFINICE PROMENNYCH
                      00113 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00114 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00115 ; MAPA PAMETI: (368 bytu)
                      00116 ;       BANK 0:         0x000 - 0x01F = specialni registry,
                      00117 ;                               0x020 - 0x07F = misto (96bytu) pro nase registry:
                      00118 ;                               0x020 - 0x034 -> 21bytu pro registry a parametry HDD
                      00119 ;                               0x035 - 0x03a -> 6bytu pro parametry podprogramu (musime zajistit, abych
                            om nepouzivali registry, ktere pouzivaji i podprogramy!!!)
                      00120 ;                               0x03B - 0x07F -> 69bytu rezervovano pro parametry oddilu, pozici v mp3 a
                             dalsi blbosti
                      00121 ;
                      00122 ;       BANK 1:         0x080 - 0x09F = specialni registry,
                      00123 ;                               0x0A0 - 0x0EF = volne misto (80bytu)
                      00124 ;                               0x0A0 - 0x0AC -> parametry a navratove hodnoty z aritmeto/logickych podp
                            rogramu
                      00125 ;                               0x0AD - 0x0EF -> 67bytu nepouzito
                      00126 ;
                      00127 ;       BANK 2:         0x100 - 0x10F = specialni registry,
                      00128 ;                               0x110 - 0x16F = misto (96bytu) pro nase registry:
MPASM 03.90 Released                                  MP3.ASM   10-25-2005  21:19:59         PAGE  4


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00129 ;                               0x110 - 0x14F -> 64bytu BUFFER_2 pro dlouhe nazvy souboru, tabulku oddil
                            u, a treba pro cast fatky
                      00130 ;                               0x150 - 0x16F -> 32bytu nepouzito
                      00131 ;
                      00132 ;       BANK 3:         0x180 - 0x18F = specialni registry,
                      00133 ;                               0x190 - 0x1EF = misto (96bytu) pro nase registry:
                      00134 ;                               0x190 - 0x1CF -> 64bytu BUFFER_1 pro ruzna data pri cteni...
                      00135 ;                               0x1D0 - 0x1DF -> 16bytu bufferu pro data prikazu (smi zapisovat z prerus
                            eni)
                      00136 ;                               0x1E0             -> vlajka prikazu if (vlajka > 0): buffer obsahuje pri
                            kaz dlouhy "vlajka" bytu
                      00137 ;                               0x1E1 - 0x1EF -> 15bytu nepouzito
                      00138 
                      00139 ; prectena ci zapisovana data
  00000020            00140 DATA_L                  equ 0x020 ; res 1
  00000021            00141 DATA_H                  equ 0x021
                      00142 ; HODNOTY ATA REGISTRU 
  00000022            00143 ATA_STATUS_A    equ 0x022
  00000023            00144 DEVICE_C                equ 0x023
  00000024            00145 FEATURES                equ 0x024
  00000025            00146 ATA_ERROR               equ 0x025
  00000026            00147 SECTOR_C                equ 0x026
  00000027            00148 LBA1                    equ 0x027       ; alias  SECTOR_N
  00000028            00149 LBA2                    equ 0x028       ; alias  CILINDER_L
  00000029            00150 LBA3                    equ 0x029       ; alias  CILINDER_H
  0000002A            00151 LBA4                    equ 0x02a       ; toto neni registr ATA, ale pouze posledni cast aktualni adresy
  0000002B            00152 DEVICE                  equ 0x02b       ; alias  DEVICE_H
  0000002C            00153 ATA_STATUS              equ 0x02c
  0000002D            00154 COMMAND                 equ 0x02d
                      00155 ;**********************************************************
                      00156 ; BITY ATA REGISTRU
                      00157          ; ATA_STATUS register
  00000007            00158 BSY                             equ 7   ; = 1 -> disk je zaneprazdneny, ostatni registry nemusi obsahova
                            t pravdivou informaci
  00000006            00159 DRDY                    equ 6   ; = 1 -> disk ready (pripraven k praci)
  00000003            00160 DRQ                             equ 3   ; = 1 -> signalizuje, ze jsou pripravena data ke cteni 
  00000000            00161 ERR                             equ 0   ; = 1 -> pri provadeni posledniho prikazu doslo k chybe
                      00162          ; ATA_ERROR register
  00000002            00163 ABRT                    equ 2   ; = 1 -> prikaz aborted (spatny optkode prikazu)
                      00164          ; DEVICE_C (control) register
  00000002            00165 SRST                    equ 2   ; nastavime-li, provedeme soft. reset disku
  00000001            00166 nEIN                    equ 1   ; zakazuje preruseni disku (signal INTRQ)
  00000007            00167 HOB                             equ 7   ; tento bit DEVICE CONTROL se nastavuje pouze pokud disk podporu
                            je LBA 48 a cteme horni cast adresy LBA...
                      00168 ;**********************************************************
  0000002E            00169 ATA_ATTRIBUTES  equ 0x02e       ; Parametry hardisku. 
                      00170 ;Bity maji nasledujici vyznam:
  00000000            00171 ATA_OK                  equ 0   ; 0. bit = 1 -> disk je pritomen, zapnuty a funkcni :-)
  00000001            00172 LBA_SUPPORT             equ 1   ; 1. bit = 1 -> podpora LBA (pokud neni nastaven bit2, tak pouze LBA27 -
                            > disk do 120GB)
  00000002            00173 LBA48_SUPPORT   equ 2   ; 2. bit = 1 -> podpora LBA 48 (disk je zrejme vetsi jak 120GB)
  00000003            00174 BIG_SECTOR              equ 3   ; 3. bit = 1 -> velikost sektoru je vetsi nez 256 !!! (s takovym diskem 
                            zatim tento program neumi)
                      00175                                                 ; 4. bit  -> nepouzit
MPASM 03.90 Released                                  MP3.ASM   10-25-2005  21:19:59         PAGE  5


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00176                                                 ; 5. bit  -> nepouzit
                      00177                                                 ; 6. bit  -> nepouzit (tyto tri bity treba pouziju pro v
                            lastnosti FATky)
  00000007            00178 APPLICABLE              equ 7   ; 7. bit = 1 -> disk je pro nas pouzitelny (LBA, sektor o 512B)
                      00179 
                      00180 
  0000002F            00181 PARAM_MAX_LBA1  equ 0x02f               ; [4B] maximalni hodnota LBA (velikost disku)   
  00000030            00182 PARAM_MAX_LBA2  equ 0x030               ; tady pozor, disky mohou byt adresovany az LBA 48, MBR je ale o
                            mezen na LBA 32 (2TB)
  00000031            00183 PARAM_MAX_LBA3  equ 0x031               ; tak by nemelo smysl vsech 48b kdyz by se nevyuzily. (Navic jse
                            m disk vetsi nez 2TB nevidel :)
  00000032            00184 PARAM_MAX_LBA4  equ 0x032               ; (registr s indexem 1 ma nejnizsi vahu)
                      00185 
  00000033            00186 PARAM_SLOV_V_SEKTORU1   equ 0x33 ; [2B] disky mohou mit velikost sektoru vetsi nez 512 (256sl) 
  00000034            00187 PARAM_SLOV_V_SEKTORU2   equ 0x34 
                      00188 ; pokud je to zapsano takto, nejvyznamejsi bity jsou niz v paneti (PARAM_MAX_LBA + X)
                      00189 ; pokud je zapsano jako skupina LBA1, LBA2, LBA3, LBA4, tak nejvyznamejsi bity jsou v LBA4
                      00190 ;**********************************************************
                      00191 ; pomocne registry pouzivane v podprogramech 
                      00192 ; !!! MUSIME ZAJISTIT ABY NEBYLY POUZIVANY VE VNORENYCH PODPROGRAMECH !!!
  00000035            00193 TEMPW                   equ 0x035
  00000036            00194 TEMP1                   equ 0x036
  00000037            00195 TEMP2                   equ 0x037
  00000038            00196 TEMP3                   equ 0x038
  00000039            00197 TEMP4                   equ 0x039
  0000003A            00198 TEMP5                   equ 0x03a
                      00199 
                      00200 ; !!! pomocne promenne pro spozdovaci smycky jsou na stejnych mistech
                      00201 ; pouzito pro synchronizaci s prog. picdelay
  00000036            00202 TMP1                    equ 0x036
  00000037            00203 TMP2                    equ 0x037
  00000038            00204 TMP0                    equ 0x038
                      00205 ;**********************************************************
                      00206 ; BANK_1        s touto bankou pracuji procedury provadejici 32 bitove 
                      00207 ;                       aritmeto/logicke operace
  000000A0            00208 OPERAND_X1              equ 0x0A0
  000000A1            00209 OPERAND_X2              equ 0x0A1
  000000A2            00210 OPERAND_X3              equ 0x0A2
  000000A3            00211 OPERAND_X4              equ 0x0A3
                      00212 
  000000A4            00213 OPERAND_Y1              equ 0x0A4
  000000A5            00214 OPERAND_Y2              equ 0x0A5
  000000A6            00215 OPERAND_Y3              equ 0x0A6
  000000A7            00216 OPERAND_Y4              equ 0x0A7
                      00217 
  000000A8            00218 VYSLEDEK1               equ 0x0A8
  000000A9            00219 VYSLEDEK2               equ 0x0A9
  000000AA            00220 VYSLEDEK3               equ 0x0AA
  000000AB            00221 VYSLEDEK4               equ 0x0AB
                      00222 
  000000AC            00223 PRETECENI               equ 0x0AC
                      00224 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00225 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00226 ; MAKRA
MPASM 03.90 Released                                  MP3.ASM   10-25-2005  21:19:59         PAGE  6


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00227 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00228 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00229 BANK_0  macro                                   ; prepnuti do banky 0 v pameti dat
                      00230                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
                      00231                 bcf     STATUS,RP0    
                      00232                 endm
                      00233 BANK_1  macro                                   ; prepnuti do banky 1 v pameti dat
                      00234                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
                      00235                 bsf     STATUS,RP0    
                      00236                 endm
                      00237 BANK_2  macro                                   ; prepnuti do banky 2 v pameti dat
                      00238                 bsf     STATUS,RP1              ; BANK2  RP1:RP0 = 10
                      00239                 bcf     STATUS,RP0    
                      00240                 endm
                      00241 BANK_3  macro                                   ; prepnuti do banky 3 v pameti dat
                      00242                 bsf     STATUS,RP1              ; BANK3  RP1:RP0 = 11
                      00243                 bsf     STATUS,RP0    
                      00244                 endm
                      00245 ; INDF_BANK_x slouzi k prepinani bank pro neprime adresovani pomoci INDF a FSR
                      00246 INDF_BANK_0     macro               
                      00247                         bcf STATUS,IRP    
                      00248                         endm
                      00249 INDF_BANK_1     macro               
                      00250                         bcf STATUS,IRP    
                      00251                         endm
                      00252 INDF_BANK_2     macro             
                      00253                         bsf STATUS,IRP    
                      00254                         endm
                      00255 INDF_BANK_3     macro             
                      00256                         bsf STATUS,IRP    
                      00257                         endm
                      00258 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00023 
                      00024 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00025 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00026 ; PROGRAM
                      00027 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00028 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
0000                  00029         org 0
0000   2A5E           00030         goto START
0004                  00031         org 4
0004   2AA8           00032         goto INTERRUPT
                      00033 ;**********************************************************
                      00034 
                      00035         include "ata.asm"               ; podprogramy na ovladani ATA disku
                      00001 ;**********************************************************
                      00002 ;**********************************************************
                      00003 ;**********************************************************
                      00004 ; OBSLUZNE PODPROGRAMY PRO ATA
                      00005 ;**********************************************************
                      00006 ;**********************************************************
                      00007 ;**********************************************************
                      00008 
                      00009 ;**********************************************************
MPASM 03.90 Released                                  MP3.ASM   10-25-2005  21:19:59         PAGE  7


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00010 ; cteni a zapis ATA registru 
                      00011 ;**********************************************************
0005                  00012 RD_STATUS         
0005   3027           00013         movlw D_STATUS      ; Status 
0006   2056           00014         call RUTR 
0007   00AC           00015         movwf ATA_STATUS
0008   0008           00016         return
                      00017 ;*****************************************
0009                  00018 RD_ERROR
0009   3021           00019         movlw D_ERROR      ; Error
000A   2056           00020         call RUTR
000B   00A5           00021         movwf ATA_ERROR
000C   0008           00022         return
                      00023 ;*****************************************
000D                  00024 RD_STATUS_A     
000D   3016           00025         movlw D_STATUS_A    ; Alternate Status 
000E   2056           00026         call RUTR 
000F   00A2           00027         movwf ATA_STATUS_A
0010   0008           00028         return
                      00029 ;*****************************************
0011                  00030 RD_SC
0011   3022           00031         movlw D_SECTOR_C    ; Sector Count
0012   2056           00032         call RUTR
0013   00A6           00033         movwf SECTOR_C
0014   0008           00034         return
                      00035 ;*****************************************
0015                  00036 RD_LBA1
0015   3023           00037         movlw D_LBA1    ; Sector Number 
0016   2056           00038         call RUTR                
0017   00A7           00039         movwf LBA1 
0018   0008           00040         return
                      00041 ;*****************************************
0019                  00042 RD_LBA2
0019   3024           00043         movlw D_LBA2  ; Cylinder Low
001A   2056           00044         call RUTR
001B   00A8           00045         movwf LBA2
001C   0008           00046         return
                      00047 ;*****************************************
001D                  00048 RD_LBA3
001D   3025           00049         movlw D_LBA3  ; Cylinder High   
001E   2056           00050         call RUTR
001F   00A9           00051         movwf LBA3
0020   0008           00052         return
                      00053 ;*****************************************
0021                  00054 RD_DEVICE
0021   3026           00055         movlw D_DEVICE  ; Device Head
0022   2056           00056         call RUTR
0023   00AB           00057         movwf DEVICE
0024   0008           00058         return
                      00059 ;*****************************************
                      00060 ;*****************************************
0025                  00061 WR_DC
0025   0823           00062         movf DEVICE_C,w     ; Device Control
0026   00B5           00063         movwf TEMPW
MPASM 03.90 Released                                  MP3.ASM   10-25-2005  21:19:59         PAGE  8


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0027   3016           00064         movlw D_DEVICE_C
0028   2063           00065         call RUTW
0029   0008           00066         return
                      00067 ;*****************************************
002A                  00068 WR_COMMAND          
002A   082D           00069         movf COMMAND,w      ; Command       
002B   00B5           00070         movwf TEMPW
002C   3027           00071         movlw D_COMMAND
002D   2063           00072         call RUTW
002E   0008           00073         return
                      00074 ;*****************************************
002F                  00075 WR_SC                    
002F   0826           00076     movf SECTOR_C,w     ; Sector Count
0030   00B5           00077         movwf TEMPW
0031   3022           00078         movlw D_SECTOR_C     
0032   2063           00079         call RUTW
0033   0008           00080         return
                      00081 ;*****************************************
0034                  00082 WR_LBA1
0034   0827           00083         movf LBA1,w     
0035   00B5           00084         movwf TEMPW
0036   3023           00085         movlw D_LBA1    
0037   2063           00086         call RUTW
0038   0008           00087         return
                      00088 ;*****************************************
0039                  00089 WR_LBA2
0039   0828           00090         movf LBA2,w   ; Cylinder Low
003A   00B5           00091         movwf TEMPW
003B   3024           00092         movlw D_LBA2
003C   2063           00093         call RUTW
003D   0008           00094         return
                      00095 ;*****************************************
003E                  00096 WR_LBA3
003E   0829           00097         movf LBA3,w   ; Cylinder High
003F   00B5           00098         movwf TEMPW
0040   3025           00099         movlw D_LBA3
0041   2063           00100         call RUTW
0042   0008           00101         return
                      00102 ;*****************************************
0043                  00103 WR_DEVICE
0043   082B           00104         movf DEVICE,w     ; Device Head 
0044   00B5           00105         movwf TEMPW
0045   3026           00106         movlw D_DEVICE
0046   2063           00107         call RUTW
0047   0008           00108         return
                      00109 ;*****************************************
0048                  00110 WR_FEATURES
0048   0824           00111         movf FEATURES,w     ; Features
0049   00B5           00112         movwf TEMPW
004A   3021           00113         movlw D_FEATURES
004B   2063           00114         call RUTW
004C   0008           00115         return
                      00116 ;*****************************************
                      00117 ; zapise vsechny registry potrebne k vykonani prikazu (adresove registry a prikaz)
MPASM 03.90 Released                                  MP3.ASM   10-25-2005  21:19:59         PAGE  9


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

004D                  00118 WR_BLOCK
004D   212E           00119         call WAIT_FOR_READY
004E   2048           00120         call WR_FEATURES
004F   202F           00121         call WR_SC
0050   2034           00122         call WR_LBA1
0051   2039           00123         call WR_LBA2
0052   203E           00124         call WR_LBA3
0053   2043           00125         call WR_DEVICE
0054   202A           00126         call WR_COMMAND
0055   0008           00127         return
                      00128 ;*****************************************
                      00129 ; ve workingu mame adresu registru ktery mame precist, 
                      00130 ; pak v nem vracime jeho hodnotu...
0056                  00131 RUTR          
0056   0087           00132         movwf ATA_ADDRESS                  ; adresa pozadovaneho registru
                      00133 
                      00134         BANK_1
0057   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0058   1683               M                 bsf     STATUS,RP0    
0059   30FF           00135     movlw 0xFF
005A   0086           00136     movwf DATA_PORT_LOW_TRIS   ; z datove zbernice cteme
005B   0088           00137     movwf DATA_PORT_HIGH_TRIS
                      00138         BANK_0
005C   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
005D   1283               M                 bcf     STATUS,RP0    
                      00139 
005E   1109           00140         bcf ATA_DIOR_N
005F   0000           00141     nop                                                 ; PIO delay min. 120ns (PIO 4)  
0060   0806           00142     movfw DATA_PORT_LOW                 ; Read DD0..D7 IDE
0061   1509           00143         bsf ATA_DIOR_N
                      00144 
0062   0008           00145     return
                      00146 ;**********************************************************
                      00147 ; ve workingu mame adresu registru ktery mame zapsat,
                      00148 ; a v reg. TEMPW hodnotu kterou mame do tohoto registru zapsat
0063                  00149 RUTW
0063   0087           00150         movwf ATA_ADDRESS
                      00151 
                      00152         BANK_1
0064   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0065   1683               M                 bsf     STATUS,RP0    
0066   3000           00153     movlw 0x0
0067   0086           00154     movwf DATA_PORT_LOW_TRIS   ; do datove sbernice zapisujeme
0068   0088           00155     movwf DATA_PORT_HIGH_TRIS
                      00156         BANK_0
0069   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
006A   1283               M                 bcf     STATUS,RP0    
                      00157 
006B   0835           00158     movf TEMPW,w        
006C   0086           00159     movwf DATA_PORT_LOW                 ; Write DD0..DD7 IDE 
006D   0188           00160         clrf DATA_PORT_HIGH
                      00161 
006E   1089           00162         bcf ATA_DIOW_N
006F   0000           00163         nop
MPASM 03.90 Released                                  MP3.ASM   10-25-2005  21:19:59         PAGE 10


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0070   1489           00164         bsf ATA_DIOW_N
                      00165           
                      00166         BANK_1
0071   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0072   1683               M                 bsf     STATUS,RP0    
0073   30FF           00167     movlw 0xff
0074   0086           00168     movwf DATA_PORT_LOW_TRIS   ; datova sbernice na cteni
0075   0088           00169     movwf DATA_PORT_HIGH_TRIS
                      00170         BANK_0
0076   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0077   1283               M                 bcf     STATUS,RP0    
                      00171 
0078   0008           00172         return
                      00173 ;**********************************************************
0079                  00174 READ_DATA
0079   3020           00175     movlw D_DATA_R
007A   0087           00176         movwf ATA_ADDRESS
                      00177 
                      00178         BANK_1
007B   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
007C   1683               M                 bsf     STATUS,RP0    
007D   30FF           00179     movlw 0xFF
007E   0086           00180     movwf DATA_PORT_LOW_TRIS   ; z datove zbernice cteme
007F   0088           00181     movwf DATA_PORT_HIGH_TRIS
                      00182         BANK_0
0080   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0081   1283               M                 bcf     STATUS,RP0    
                      00183 
0082   1109           00184         bcf ATA_DIOR_N
0083   0000           00185     nop                                                 ; PIO delay min. 120ns (PIO 4)  
0084   0000           00186         nop
0085   0806           00187     movfw DATA_PORT_LOW                 ; Read DD0..D7 IDE
0086   00A0           00188         movwf DATA_L
0087   0808           00189     movfw DATA_PORT_HIGH                ; Read DD8..D15 IDE
0088   00A1           00190         movwf DATA_H
0089   1509           00191         bsf ATA_DIOR_N
                      00192 
008A   0008           00193     return
                      00194 ;**********************************************************
                      00195 ; stava se, ze obcas nas zajima jen cast vracenych dat, tak ty ktere nas nezajimaji, preskocime
                      00196 ; ocakava parametr v registru TEMP1 (kolik slov ma preskocit)
008B                  00197 PRESKOC
008B   2125           00198         call WAIT_FOR_DATA      ; cekame na data
008C   2079           00199         call READ_DATA
008D   0BB6           00200         decfsz TEMP1,F
008E   288B           00201         goto PRESKOC
008F   0008           00202         return
                      00203 ;**********************************************************
                      00204 ; rekne disku na ze pristi instrukce, registry, data.... budou pro mastera
0090                  00205 SELECT_DEVICE
0090   30E0           00206         movlw b'11100000'       ; adresy budou v LBA, budeme pracovat s masterem
0091   00AB           00207         movwf DEVICE
0092   2043           00208         call WR_DEVICE
0093   0008           00209         return
MPASM 03.90 Released                                  MP3.ASM   10-25-2005  21:19:59         PAGE 11


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00210 ;**********************************************************
0094                  00211 ZAPIS_DO_BUFFERU_1      ; buffer1 ma 64B a je v bance 3 na adrese 0x190 - 0x1CF
                      00212                                         ; jako parametr dostanem TEMP1, kde je pocet bytu k zapisu
                      00213                                         ; maximalni hodnota v TEMP1 muze byt 32 (1 slovo = 2 byty)
                      00214         INDF_BANK_3             ; neprime adresovani na banku 3
0094   1783               M                         bsf STATUS,IRP    
0095   3090           00215         movlw 0x90              ; adresa ja 190, devaty byt urcuje banku (0,1 / 2,3) fsr je tedy 90
0096   0084           00216         movwf FSR               
0097                  00217 ZAPIS_DO_BUFFERU_1__ZAPIS
0097   2125           00218         call WAIT_FOR_DATA              ; cekame na data
0098   2079           00219         call READ_DATA
                      00220         
0099   0820           00221         movfw DATA_L
009A   0080           00222         movwf INDF
009B   0A84           00223         incf FSR,F
009C   0821           00224         movfw DATA_H
009D   0080           00225         movwf INDF
009E   0A84           00226         incf FSR,F
                      00227 
009F   0BB6           00228         decfsz TEMP1,F
00A0   2897           00229         goto ZAPIS_DO_BUFFERU_1__ZAPIS
                      00230 
                      00231         INDF_BANK_0     
00A1   1383               M                         bcf STATUS,IRP    
00A2   0008           00232         return
                      00233 ;**********************************************************
00A3                  00234 ATA_RESET
                      00235         ; Resetuje disk zjisti, zda vubec nejaky disk je pripojen
00A3   01AE           00236         clrf ATA_ATTRIBUTES     ; registr obsahujici bity rikajici co disk umi
                      00237 
00A4   1009           00238         bcf ATA_RESET_N         ; resetujeme disk
00A5   2120           00239         call DELAY_25us         ; signal reset musi byt min. 25us
00A6   1409           00240         bsf ATA_RESET_N         ; koncime s resetem disku
                      00241 
00A7   212E           00242         call WAIT_FOR_READY     ; vynulujeme device bit v DEVICE registru (disk musi byt master!), ...
00A8   2090           00243         call SELECT_DEVICE      ; ...nastavime bit L - LBA addressing
                      00244 
00A9   212E           00245         call WAIT_FOR_READY
00AA   3002           00246         movlw b'00000010'       ; zakazeme preruseni (ted mam na mysli signal INTRQ z disku)
00AB   00A3           00247         movwf DEVICE_C          ; bit nIEN = 1 -> zakazeme preruseni disku (stejne nemame signal INTRQ p
                            ripojen)
00AC   2025           00248         call WR_DC                      ; zapiseme hodnotu do registru DEVICE CONTROL
                      00249 
00AD   30E0           00250         movlw b'11100000'       ; adresy budou v LBA, budeme pracovat s masterem
00AE   00AB           00251         movwf DEVICE
00AF   01A6           00252         clrf SECTOR_C
00B0   01A7           00253         clrf LBA1       
00B1   01A8           00254         clrf LBA2
00B2   01A9           00255         clrf LBA3
00B3   01A4           00256         clrf FEATURES
00B4   3000           00257         movlw h'00'                     ; code prikazu  nop
00B5   00AD           00258         movwf COMMAND
00B6   204D           00259         call WR_BLOCK           ; ted provedeme prvni prikaz (nop) a podivame se co nam disk vrati
                      00260 
MPASM 03.90 Released                                  MP3.ASM   10-25-2005  21:19:59         PAGE 12


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

00B7   212E           00261         call WAIT_FOR_READY
00B8   2021           00262         call RD_DEVICE          ; Precteme reg. device. Pokud je disk OK, tak by nam mel vratit to, co j
                            sme do nej predtim zapsaly
00B9   082B           00263         movfw DEVICE
00BA   3CE0           00264         sublw b'11100000'
00BB   1903           00265         btfsc STATUS,Z          ; pokud DEVICE <> b'11100000', tak tu bud disk nemame, nebo je nejakej r
                            ozsypanej, nebo je spatne svicivanej (treba SLAVE)
00BC   142E           00266         bsf ATA_ATTRIBUTES,ATA_OK       ; 0. bit = 1 -> disk je pritomen, zapnuty a funkcni...
                      00267 
00BD   0008           00268         return          
                      00269 ;**********************************************************
00BE                  00270 IDENTIFY_DEVICE
                      00271         ; ted uz vime, ze mame pripojen nejaky disk, tento podprogram provede prikaz 
                      00272         ; identify device a zjisti co je disk zac. Nektere dulezite informace ulozi 
                      00273         ; (nastavi byty v ATA_ATTRIBUTES) a jmenovku disku hodi do bufferu
                      00274 
                      00275         ; !!!! tato procedura neni hotova a odzkousena
                      00276 
                      00277         ; rekneme disku, ze s nim chcem pracovat (s masterem)
00BE   212E           00278         call WAIT_FOR_READY
00BF   2090           00279         call SELECT_DEVICE
                      00280         
                      00281         ; podivame se zda tu vubec disk je a co podporuje (LBA)
00C0   212E           00282         call WAIT_FOR_READY     ; celame nez bude disk opet ready pro dalsi prikazy
                      00283 
00C1   30E0           00284         movlw b'11100000'       ; adresy budou v LBA, budeme pracovat s masterem
00C2   00AB           00285         movwf DEVICE
00C3   01A6           00286         clrf SECTOR_C
00C4   01A7           00287         clrf LBA1       
00C5   01A8           00288         clrf LBA2
00C6   01A9           00289         clrf LBA3
00C7   01A4           00290         clrf FEATURES
00C8   30EC           00291         movlw 0xEC                      ; code prikazu IDENTIFY DEVICE
00C9   00AD           00292         movwf COMMAND
00CA   204D           00293         call WR_BLOCK
                      00294 
                      00295         ; pokud se neco nepodelalo, dostanem 256 16ti bitovych slov kde je napsano co disk umi a co je t
                            o zac...
                      00296         ; slova cisluji od nuly, (tzn. ze slov je 0-255)
00CB   301B           00297         movlw .27               ; prvnich 27 slov je pro nas nepotrebnych
00CC   00B6           00298         movwf TEMP1
00CD   208B           00299         call PRESKOC
                      00300         
                      00301         ;////////////////////////////////////////////////////////////////////////////////
                      00302         ; [27-46] model mumber (ASCI retezec s nazvem disku)
                      00303         ; tady precteme 20 slov a rovnou je odesleme do pric
                      00304                 ; pokud nekde od disku dostavame ASCII retezec jsou data nasledujici: 
                      00305                 ; pr. disk nam posila string “Copyright”
                      00306                 ;               1. DATA_H = 'C' 
                      00307                 ;               1. DATA_l = 'o'
                      00308                 ;               2. DATA_H = 'P' 
                      00309                 ;               2. DATA_l = 'y'
00CE   3014           00310         movlw .20               ; dalsich 20 slov obsahuje 40 s ASCII znaku s nazvem disku
00CF   00B6           00311         movwf TEMP1
MPASM 03.90 Released                                  MP3.ASM   10-25-2005  21:19:59         PAGE 13


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

00D0                  00312 INIT_ATA__ODESLI_ZNAK
00D0   2125           00313                 call WAIT_FOR_DATA      ; cekame na data
00D1   2079           00314                 call READ_DATA
00D2   0821           00315                 movfw DATA_H
00D3   22A0           00316                 call WR_USART
00D4   0820           00317                 movfw DATA_L
00D5   22A0           00318                 call WR_USART
00D6   0BB6           00319                 decfsz TEMP1,F
00D7   28D0           00320                 goto INIT_ATA__ODESLI_ZNAK
                      00321 
                      00322         ; movlw .20             ; dalsich 20 slov obsahuje 40 s ASCII znaku s nazvem disku
                      00323         ; movwf TEMP1
                      00324         ; call ZAPIS_DO_BUFFERU_1
                      00325         ;////////////////////////////////////////////////////////////////////////////////
                      00326 
                      00327                 
                      00328         ; ted jsme uz precetli 31 slov z 256 :-)
00D8   3002           00329         movlw .2                ; dalsi 2 slova jsou nam k nicemu
00D9   00B6           00330         movwf TEMP1
00DA   208B           00331         call PRESKOC
                      00332                 
00DB   2125           00333         call WAIT_FOR_DATA
00DC   2079           00334         call READ_DATA  ; slovo 49 - capabilities (schopnosti)
                      00335                         ; 15:14 Reserved for the IDENTIFY PACKET DEVICE command.
                      00336                         ;    13 1 = Standby timer values as specified in this standard are supported
                      00337                         ;       0 = Standby timer values shall be managed by the device
                      00338                         ;    12 Reserved for the IDENTIFY PACKET DEVICE command.
                      00339                         ;    11 1 = IORDY supported
                      00340                         ;       0 = IORDY may be supported
                      00341                         ;    10 1 = IORDY may be disabled
                      00342                         ;     9 1 = LBA supported
                      00343                         ;     8 1 = DMA supported.
                      00344                         ;   7:0 Retired
00DD   0821           00345         movfw DATA_H
00DE   3902           00346         andlw b'00000010'       ; z toho nas zajima pouze bit 9
00DF   00AE           00347         movwf ATA_ATTRIBUTES
                      00348 
                      00349         ;precetli jsme 50 slov
00E0   300A           00350         movlw .10
00E1   00B6           00351         movwf TEMP1
00E2   208B           00352         call PRESKOC
                      00353         
00E3   2125           00354         call WAIT_FOR_DATA
00E4   2079           00355         call READ_DATA  ; 60
00E5   0820           00356         movfw DATA_L
00E6   00AF           00357         movwf PARAM_MAX_LBA1            ; nejnizsi cast adresy
00E7   0821           00358         movfw DATA_H
00E8   00B0           00359         movwf PARAM_MAX_LBA2    
                      00360         
00E9   2125           00361         call WAIT_FOR_DATA
00EA   2079           00362         call READ_DATA  ; 61
00EB   0820           00363         movfw DATA_L
00EC   00B1           00364         movwf PARAM_MAX_LBA3
00ED   0821           00365         movfw DATA_H
MPASM 03.90 Released                                  MP3.ASM   10-25-2005  21:19:59         PAGE 14


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

00EE   00B2           00366         movwf PARAM_MAX_LBA4            ; nejvyssi cast adresy
                      00367         
                      00368         ;precetli jsme 62 slov, zbyva 194
00EF   3015           00369         movlw .21
00F0   00B6           00370         movwf TEMP1
00F1   208B           00371         call PRESKOC
                      00372 
                      00373         ; 83 slov, na rade je slovo 83 (pripominam ze slova jsou cislovana od nuly)
00F2   2125           00374         call WAIT_FOR_DATA
00F3   2079           00375         call READ_DATA  ; 83 - command supported. Tady nas zajima bit 10 - 1 = 48-bit Address feature se
                            t supported
00F4   1921           00376         btfsc DATA_H,2  ; pokud disk umi LBA 48 pripiseme tuto skutecnost do ATA_ATTRIBUTES
00F5   142E           00377                 bsf ATA_ATTRIBUTES,0
                      00378 
                      00379         ;precetli jsme 84 slov
00F6   3010           00380         movlw .16
00F7   00B6           00381         movwf TEMP1
00F8   208B           00382         call PRESKOC
                      00383                 
00F9   1C2E           00384         btfss ATA_ATTRIBUTES,0
00FA   2908           00385         goto INIT_ATA__NOT_SUPPORT_LBA48
                      00386                         ; pokud je podporovano LBA 48, nachazi se ve slovech [100-103] skutecny pocet se
                            ktoru 
                      00387                         ; do slov 60-61 by se sice vesel pocet sektoru u disku do 2TB, podle standardu s
                            e tam ale zapisuje pouze hodnota max pro LBA 28 (cca 120 GB)
                      00388                         ; mi precteme ale jen nejnizsi 2 slova, predpokladam totiz ze disk neni vetsi ja
                            k 2TB
00FB   2125           00389                         call WAIT_FOR_DATA
00FC   2079           00390                         call READ_DATA  ; 100
00FD   0820           00391                         movfw DATA_L
00FE   00AF           00392                         movwf PARAM_MAX_LBA1            ; nejnizsi cast adresy
00FF   0821           00393                         movfw DATA_H
0100   00B0           00394                         movwf PARAM_MAX_LBA2    
                      00395 
0101   2125           00396                         call WAIT_FOR_DATA
0102   2079           00397                         call READ_DATA  ; 101
0103   0820           00398                         movfw DATA_L
0104   00B1           00399                         movwf PARAM_MAX_LBA3
0105   0821           00400                         movfw DATA_H
0106   00B2           00401                         movwf PARAM_MAX_LBA4            ; nejvyssi cast adresy                  
0107   290B           00402                 goto INIT_ATA__DALSI
0108                  00403 INIT_ATA__NOT_SUPPORT_LBA48
0108   3002           00404         movlw .2        ; 100, 101
0109   00B6           00405         movwf TEMP1
010A   208B           00406         call PRESKOC    
010B                  00407 INIT_ATA__DALSI
                      00408         ; precetli jsme 102 slov
010B   3004           00409         movlw .4        ; 102, 103, 104, 105
010C   00B6           00410         movwf TEMP1
010D   208B           00411         call PRESKOC
                      00412 
010E   2125           00413         call WAIT_FOR_DATA
010F   2079           00414         call READ_DATA  ; slovo 106 - pokud bit 15=0 a bit 14=1, tak obsahuje pravdive informace
                      00415                                                 ; pro nas je podstatne, ze pokud je bit 12 = 1, tak sekt
MPASM 03.90 Released                                  MP3.ASM   10-25-2005  21:19:59         PAGE 15


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                            or je vetsi nez 256 slov
                      00416                                                 ; pokud je sektor vetsi nez 256 slov, je jeho velikost v
                            e slovech [117-118]
0110   1BA1           00417         btfsc DATA_H,7
0111   2916           00418         goto INIT_ATA__DALSI2
0112   1F21           00419         btfss DATA_H,6
0113   2916           00420         goto INIT_ATA__DALSI2
0114   1A21           00421         btfsc DATA_H,4
0115   152E           00422         bsf ATA_ATTRIBUTES,2
0116                  00423 INIT_ATA__DALSI2
                      00424         ; precteno 107, zbyva 149
0116   3095           00425         movlw .149      ; 107 - 256
0117   00B6           00426         movwf TEMP1
0118   208B           00427         call PRESKOC
                      00428                 
                      00429         ; ted vime co mame za disk, tak se na to jdem podivat...
                      00430         ; pokud disk splnuje vsechny nase pozadavky, tak nastavime 7 bit v ATA_ATTRIBUTES
0119   13AE           00431         bcf ATA_ATTRIBUTES,7    
011A   1CAE           00432         btfss ATA_ATTRIBUTES,1
011B   0008           00433         return
                      00434         ; pokud jsme tady, disk podporuje LBA (dneska se jich uz moc nevidi, co by LBA neumeli)
011C   192E           00435         btfsc ATA_ATTRIBUTES,2
011D   0008           00436         return
                      00437         ; mazec, disk ma velikost sektoru 256 slov, vetsi naroky na disk nemam :-)
011E   17AE           00438         bsf ATA_ATTRIBUTES,7 ; disk umi to co potrebujeme...    
                      00439 
011F   0008           00440         return
                      00441 ;**********************************************************
                      00442 ; CEKACI PROCEDURY
                      00443 ;**********************************************************
0120                  00444 DELAY_25us
                      00445         ; pouziva TEMP1
                      00446         ; (Fosc = 20 MHz , instr. cyklus= 0.20 us) 25us / 0.20 us = 125 instrukcnich cyklu
                      00447         ; (Fosc = 16 MHz , instr. cyklus= 0.25 us) 25us / 0.25 us = 100 instrukcnich cyklu
                      00448         ; (Fosc = 04 MHz , instr. cyklus= 1.00 us) 25us / 1.00 us =  25 instrukcnich cyklu      
                      00449         ;MOVLW 0x2A  ;42 DEC -> Delay 127 cycles
0120   3021           00450         MOVLW 0x21   ;33 DEC -> Delay 100 cycles
                      00451         ;MOVLW 0x08  ;25 DEC -> Delay  25 cycles
0121   00B6           00452         MOVWF TEMP1
0122   0BB6           00453         DECFSZ TEMP1,F
0123   2922           00454         GOTO $-1
                      00455         ;End of Delay
0124   0008           00456         return
                      00457 ;**************************************************************************
0125                  00458 WAIT_FOR_DATA
                      00459         ; Wait: ( Bsy=0 AND Drq=1 ) OR err=1
                      00460         ; 7   6    5  4   3   2    1   0
                      00461         ; BSY DRDY DF DSC DRQ CORR IDX ERR
                      00462         ; (cekame az disk bude mit pro nas prichystana data)
0125   212E           00463         call WAIT_FOR_READY
0126   082C           00464         movfw ATA_STATUS
0127   3988           00465         andlw b'10001000'
0128   3C08           00466         sublw b'00001000'
0129   1903           00467         btfsc STATUS,Z
MPASM 03.90 Released                                  MP3.ASM   10-25-2005  21:19:59         PAGE 16


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

012A   0008           00468         return
012B   1C2C           00469         btfss ATA_STATUS,ERR
012C   2925           00470         goto WAIT_FOR_DATA
012D   0008           00471         return
                      00472 ;**************************************************************************
012E                  00473 WAIT_FOR_READY
                      00474         ; Cekame az Bsy bit = 0 
                      00475         ; (cekame az disk nebude zaneprazdnen)
012E   2005           00476         call RD_STATUS
012F   082C           00477         movfw ATA_STATUS
0130   3980           00478         andlw b'10000000'
0131   1903           00479         btfsc STATUS,Z
0132   0008           00480         return
0133   292E           00481         goto WAIT_FOR_READY
                      00482 ;**************************************************************************
                      00036         include "vs1001.asm"    ; podprogramy na ovladani mp3 decoderu
                      00001 ;**********************************************************
                      00002 ;**********************************************************
                      00003 ;**********************************************************
                      00004 ; OBSLUZNE PODPROGRAMY PRO MP3 DECODER vs1001g
                      00005 ;**********************************************************
                      00006 ;**********************************************************
                      00007 ;**********************************************************
                      00008 
                      00009 ; MP3_PORT              
                      00010 ; MP3_PORT_TRIS 
                      00011 
                      00012 ; BITY MP3_PORT
                      00013 ; #define MP3_SO                MP3_PORT,0      ; serial output - tady dostavame z dekoderu data
                      00014 ; #define MP3_SI                MP3_PORT,1      ; serial input  - pokud MP3_CS=1, tak posilame mp3 data,
                             pokud =0, tak posilame prikaz
                      00015 ; #define MP3_SCLK              MP3_PORT,2      ; clock - nabezna hrana urcuje platnost dat pri seriovem
                             prenosu
                      00016 ; #define MP3_CS                MP3_PORT,3      ; cable select  - pokud MP3_CS=1, tak po SI posilame mp3
                             data, pokud =0, tak posilame prikaz
                      00017 ; #define MP3_DREQ              MP3_PORT,4      ; data request  - pokud =1, tak dekoder pozaduje dalsi m
                            p3 data (vic jak 32B)
                      00018 ; #define MP3_BSYNC             MP3_PORT,5      ; pro synchronizaci - ma byt nastaven pri prvnim prenase
                            nem bitu kazdeho bytu
                      00019 
                      00020 ;**********************************************************
                      00021 ; do TEMP3 dame adresu registru 
                      00022 ; do TEMP4 dame dolni slabiku zapisovaneho slova
                      00023 ; do TEMP5 dame horni slabiku zapisovaneho slova
                      00024 
0134                  00025 MP3_SOFT_RESET  ; provede softwarovy reset dekoderu (pri zapnuti a pote po zkonceni kazde mp3)
0134   3000           00026         movlw .0        ; adr. reg. MODE
0135   00B8           00027         movwf TEMP3
0136   3004           00028         movlw b'00000100'       ; soft reset=1
0137   00B9           00029         movwf TEMP4
0138   3000           00030         movlw .0
0139   00BA           00031         movwf TEMP5
013A   213C           00032         call MP3_WR_REG
013B   0008           00033         return  
MPASM 03.90 Released                                  MP3.ASM   10-25-2005  21:19:59         PAGE 17


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00034 ;**********************************************************
013C                  00035 MP3_WR_REG      ; zapise 16bitove slovo (temp4,temp5) do registru mp3 dekoderu
                      00036                         ; 16bit dato se odesila od nejvyssiho bitu (15,14...8,7...1,0)
                      00037                         ; kde TEMP5 = bity 15-8 ; TEMP4 = bity 7-0
                      00038 ; pri praci pouziva TEMP4, TEMP5, TEMPW
013C   1185           00039         bcf MP3_CS                      ; po SI posilame prikaz
013D   3002           00040         movlw b'00000010'       ; write
013E   2146           00041         call MP3_WR_BYTE        
013F   0838           00042         movfw TEMP3                     ; adresa zapisovvaneho registru
0140   2146           00043         call MP3_WR_BYTE
0141   083A           00044         movfw TEMP5             ; horni slabika
0142   2146           00045         call MP3_WR_BYTE
0143   0839           00046         movfw TEMP4             ; dolni slabika
0144   2146           00047         call MP3_WR_BYTE
0145   0008           00048         return
                      00049 ;**********************************************************
                      00050 ; vodesle hodnotu ve W smerem k dekoderu
0146                  00051 MP3_WR_BYTE
0146   1685           00052         bsf MP3_BSYNC   ; bude nasledovat prvni bit bytu
0147   00B5           00053         movwf TEMPW
0148   3008           00054         movlw .8                
0149                  00055 MP3_WR_BYTE__1
0149   1105           00056                 bcf     MP3_SCLK
014A   1085           00057                 bcf MP3_SI
014B   0DB5           00058                 rlf TEMPW,f             ; odesilame od nejvyssiho bitu k nejnizsimu
014C   1803           00059                 btfsc STATUS,C  ;
014D   1485           00060                 bsf MP3_SI
014E   1505           00061                 bsf MP3_SCLK
014F   1285           00062                 bcf MP3_BSYNC
0150   0B00           00063                 DECFSZ W,W              
0151   2949           00064                 goto MP3_WR_BYTE__1             
0152   1105           00065         bcf     MP3_SCLK
0153   0008           00066         return
                      00067 ;**********************************************************
                      00037         include "aritmetic.asm" ; podprogramy na ovladani mp3 decoderu
                      00001 ;**********************************************************
                      00002 ;**********************************************************
                      00003 ;**********************************************************
                      00004 ; Obsahuje podrogramy realizujici zakladni aritmeticke operace
                      00005 ; pouzivane v mp3 preprcavaci. Vsechny operace se provadi 
                      00006 ; s 32bitovymi cisly.
                      00007 ; 
                      00008 ; Pro praci aritmetickych procedur je rezervovana BANKA 1 !!!!!
                      00009 ;**********************************************************
                      00010 ;**********************************************************
                      00011 ;**********************************************************
0154                  00012 SOUCET
                      00013 ; provede soucet hodnoty v registrech OPERAND_X[1..4] 
                      00014 ; s hodnotou v OPERAND_Y[1..4] a umisti do VYSLEDEK[1..4] 
                      00015 ; pokud dojde k preteceni, nastavi se PRETECENI do 1
                      00016 ; (byty s indexem 1 maji nejnizsi vahu)
                      00017         BANK_1
0154   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0155   1683               M                 bsf     STATUS,RP0    
MPASM 03.90 Released                                  MP3.ASM   10-25-2005  21:19:59         PAGE 18


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0156   01AC           00018         clrf PRETECENI
                      00019 
0157   0820           00020         movfw OPERAND_X1
0158   0724           00021         addwf OPERAND_Y1,W
0159   00A8           00022         movwf VYSLEDEK1
015A   1803           00023         btfsc STATUS,C
015B   14AC           00024                 bsf PRETECENI,1
                      00025 
015C   0821           00026         movfw OPERAND_X2
015D   0725           00027         addwf OPERAND_Y2,W
015E   00A9           00028         movwf VYSLEDEK2
015F   1803           00029         btfsc STATUS,C
0160   142C           00030                 bsf PRETECENI,0
0161   18AC           00031         btfsc PRETECENI,1
0162   0AA9           00032                 incf VYSLEDEK2,F
0163   1803           00033         btfsc STATUS,C
0164   142C           00034                 bsf PRETECENI,0
0165   10AC           00035         bcf PRETECENI,1
                      00036 
0166   0822           00037         movfw OPERAND_X3
0167   0726           00038         addwf OPERAND_Y3,W
0168   00AA           00039         movwf VYSLEDEK3
0169   1803           00040         btfsc STATUS,C
016A   14AC           00041                 bsf PRETECENI,1
016B   182C           00042         btfsc PRETECENI,0
016C   0AAA           00043                 incf VYSLEDEK3,F
016D   1803           00044         btfsc STATUS,C
016E   14AC           00045                 bsf PRETECENI,1
016F   102C           00046         bcf PRETECENI,0
                      00047 
0170   0823           00048         movfw OPERAND_X4
0171   0727           00049         addwf OPERAND_Y4,W
0172   00AB           00050         movwf VYSLEDEK4
0173   1803           00051         btfsc STATUS,C
0174   142C           00052                 bsf PRETECENI,0
0175   18AC           00053         btfsc PRETECENI,1
0176   0AAB           00054                 incf VYSLEDEK4,F
0177   1803           00055         btfsc STATUS,C
0178   142C           00056                 bsf PRETECENI,0
0179   10AC           00057         bcf PRETECENI,1 
                      00058 
                      00059         BANK_0
017A   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
017B   1283               M                 bcf     STATUS,RP0    
017C   0008           00060         return
                      00061 ;**********************************************************
                      00062 ;**********************************************************
017D                  00063 ROZDIL  ; VYSLEDEK := X - Y
                      00064                 ; pri podteceni PRETECENI = 1 ( VYSLEDEK < 0 => PRETECENI = 1 )
                      00065         BANK_1
017D   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
017E   1683               M                 bsf     STATUS,RP0    
017F   01AC           00066         clrf PRETECENI
                      00067 
MPASM 03.90 Released                                  MP3.ASM   10-25-2005  21:19:59         PAGE 19


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0180   0824           00068         movfw OPERAND_Y1
0181   0220           00069         subwf OPERAND_X1,W      ; W = X - Y     
0182   00A8           00070         movwf VYSLEDEK1
0183   1C03           00071         btfss STATUS,C
0184   14AC           00072                 bsf PRETECENI,1
                      00073         
0185   0825           00074         movfw OPERAND_Y2
0186   0221           00075         subwf OPERAND_X2,W      ; W = X - Y     
0187   00A9           00076         movwf VYSLEDEK2
0188   1C03           00077         btfss STATUS,C
0189   142C           00078                 bsf PRETECENI,0
018A   18AC           00079         btfsc PRETECENI,1
018B   03A9           00080                 decf VYSLEDEK2,F
018C   1C03           00081         btfss STATUS,C
018D   142C           00082                 bsf PRETECENI,0
018E   10AC           00083         bcf PRETECENI,1 
                      00084         
018F   0826           00085         movfw OPERAND_Y3
0190   0222           00086         subwf OPERAND_X3,W      ; W = X - Y     
0191   00AA           00087         movwf VYSLEDEK3
0192   1C03           00088         btfss STATUS,C
0193   14AC           00089                 bsf PRETECENI,1
0194   182C           00090         btfsc PRETECENI,0
0195   03AA           00091                 decf VYSLEDEK3,F
0196   1C03           00092         btfss STATUS,C
0197   14AC           00093                 bsf PRETECENI,1
0198   102C           00094         bcf PRETECENI,0
                      00095         
0199   0827           00096         movfw OPERAND_Y4
019A   0223           00097         subwf OPERAND_X4,W      ; W = X - Y     
019B   00AB           00098         movwf VYSLEDEK4
019C   1C03           00099         btfss STATUS,C
019D   142C           00100                 bsf PRETECENI,0
019E   18AC           00101         btfsc PRETECENI,1
019F   03AB           00102                 decf VYSLEDEK4,F
01A0   1C03           00103         btfss STATUS,C
01A1   142C           00104                 bsf PRETECENI,0
01A2   10AC           00105         bcf PRETECENI,1 
                      00106         
                      00107         BANK_0
01A3   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
01A4   1283               M                 bcf     STATUS,RP0    
01A5   0008           00108         return
                      00109 ;**********************************************************
01A6                  00110 POSUNDOLEVA     ; X := (X * 2) mod 0xFFFFFFFF , PRETECENI := (X * 2) div 0xFFFFFFFF
                      00111                         ; tento podprogram nepouzivat, primo v hlavnim programu
                      00112                         ; musi se nastavit BANK_1 a vymazat PRETECENI!!!
                      00113                         ; (je pouze pro pouziti v nasobicich podprogramech)
                      00114                         ; pouzivat jen POSUNDOLEVA_1, 2, 3, 4 
01A6   0DA0           00115         rlf OPERAND_X1,F
01A7   0DA1           00116         rlf OPERAND_X2,F
01A8   0DA2           00117         rlf OPERAND_X3,F
01A9   0DA3           00118         rlf OPERAND_X4,F
01AA   0DAC           00119         rlf PRETECENI,F 
MPASM 03.90 Released                                  MP3.ASM   10-25-2005  21:19:59         PAGE 20


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

01AB   0008           00120         return
                      00121 ;**********************************************************
01AC                  00122 POSUNDOLEVA_1   ; X := X * 2
                      00123                                 ; X > 0xFFFF FFFF => PRETECENI obsahuje bity navic
                      00124         BANK_1
01AC   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
01AD   1683               M                 bsf     STATUS,RP0    
01AE   01AC           00125         clrf PRETECENI
01AF   1003           00126         bcf STATUS,C
                      00127         
01B0   21A6           00128         call POSUNDOLEVA
                      00129 
                      00130         BANK_0
01B1   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
01B2   1283               M                 bcf     STATUS,RP0    
01B3   0008           00131         return
                      00132 ;**********************************************************
01B4                  00133 POSUNDOLEVA_2   ; X := X * 4
                      00134                                 ; X > 0xFFFF FFFF => PRETECENI obsahuje bity navic
                      00135         BANK_1
01B4   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
01B5   1683               M                 bsf     STATUS,RP0    
01B6   01AC           00136         clrf PRETECENI
01B7   1003           00137         bcf STATUS,C
                      00138         
01B8   21A6           00139         call POSUNDOLEVA
01B9   21A6           00140         call POSUNDOLEVA
                      00141 
                      00142         BANK_0
01BA   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
01BB   1283               M                 bcf     STATUS,RP0    
01BC   0008           00143         return
                      00144 ;**********************************************************
01BD                  00145 POSUNDOLEVA_3   ; X := X * 8
                      00146                                 ; X > 0xFFFF FFFF => PRETECENI obsahuje bity navic
                      00147         BANK_1
01BD   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
01BE   1683               M                 bsf     STATUS,RP0    
01BF   01AC           00148         clrf PRETECENI
01C0   1003           00149         bcf STATUS,C
                      00150         
01C1   21A6           00151         call POSUNDOLEVA
01C2   21A6           00152         call POSUNDOLEVA
01C3   21A6           00153         call POSUNDOLEVA
                      00154 
                      00155         BANK_0
01C4   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
01C5   1283               M                 bcf     STATUS,RP0    
01C6   0008           00156         return
                      00157 ;**********************************************************
01C7                  00158 POSUNDOLEVA_4   ; X := X * 16
                      00159                                 ; X > 0xFFFF FFFF => PRETECENI obsahuje bity navic
                      00160         BANK_1
01C7   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
MPASM 03.90 Released                                  MP3.ASM   10-25-2005  21:19:59         PAGE 21


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

01C8   1683               M                 bsf     STATUS,RP0    
01C9   01AC           00161         clrf PRETECENI
01CA   1003           00162         bcf STATUS,C
                      00163         
01CB   21A6           00164         call POSUNDOLEVA
01CC   21A6           00165         call POSUNDOLEVA
01CD   21A6           00166         call POSUNDOLEVA
01CE   21A6           00167         call POSUNDOLEVA
                      00168 
                      00169         BANK_0
01CF   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
01D0   1283               M                 bcf     STATUS,RP0    
01D1   0008           00170         return
                      00171 ;**********************************************************
01D2                  00172 POSUNDOPRAVA    ; X := X div 2 , PRETECENI := X mod 2
                      00173                         ; tento podprogram nepouzivat, primo v hlavnim programu
                      00174                         ; musi se nastavit BANK_1 a vymazat PRETECENI!!!
                      00175                         ; (je pouze pro pouziti v nasobicich podprogramech)
                      00176                         ; pouzivat jen POSUNDOPRAVA_1, 2, 3, 4 
01D2   0CA3           00177         rrf OPERAND_X4,F
01D3   0CA2           00178         rrf OPERAND_X3,F
01D4   0CA1           00179         rrf OPERAND_X2,F
01D5   0CA0           00180         rrf OPERAND_X1,F
01D6   0CAC           00181         rrf PRETECENI,F 
01D7   0008           00182         return
                      00183 ;**********************************************************
01D8                  00184 POSUNDOPRAVA_1  ; X := X div 2
                      00185                                 ; X > 0xFFFF FFFF => PRETECENI obsahuje bity navic
                      00186         BANK_1
01D8   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
01D9   1683               M                 bsf     STATUS,RP0    
01DA   01AC           00187         clrf PRETECENI
01DB   1003           00188         bcf STATUS,C
                      00189         
01DC   21A6           00190         call POSUNDOLEVA
                      00191 
                      00192         BANK_0
01DD   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
01DE   1283               M                 bcf     STATUS,RP0    
01DF   0008           00193         return
                      00194 ;**********************************************************
01E0                  00195 POSUNDOPRAVA_2  ; X := X div 4
                      00196                                 ; X > 0xFFFF FFFF => PRETECENI obsahuje bity navic
                      00197         BANK_1
01E0   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
01E1   1683               M                 bsf     STATUS,RP0    
01E2   01AC           00198         clrf PRETECENI
01E3   1003           00199         bcf STATUS,C
                      00200         
01E4   21A6           00201         call POSUNDOLEVA
01E5   21A6           00202         call POSUNDOLEVA
                      00203 
                      00204         BANK_0
01E6   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
MPASM 03.90 Released                                  MP3.ASM   10-25-2005  21:19:59         PAGE 22


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

01E7   1283               M                 bcf     STATUS,RP0    
01E8   0008           00205         return
                      00206 ;**********************************************************
01E9                  00207 POSUNDOPRAVA_3  ; X := X div 8
                      00208                                 ; X > 0xFFFF FFFF => PRETECENI obsahuje bity navic
                      00209         BANK_1
01E9   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
01EA   1683               M                 bsf     STATUS,RP0    
01EB   01AC           00210         clrf PRETECENI
01EC   1003           00211         bcf STATUS,C
                      00212         
01ED   21A6           00213         call POSUNDOLEVA
01EE   21A6           00214         call POSUNDOLEVA
01EF   21A6           00215         call POSUNDOLEVA
                      00216 
                      00217         BANK_0
01F0   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
01F1   1283               M                 bcf     STATUS,RP0    
01F2   0008           00218         return
                      00219 ;**********************************************************
01F3                  00220 POSUNDOPRAVA_4  ; X := X div 16
                      00221                                 ; X > 0xFFFF FFFF => PRETECENI obsahuje bity navic
                      00222         BANK_1
01F3   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
01F4   1683               M                 bsf     STATUS,RP0    
01F5   01AC           00223         clrf PRETECENI
01F6   1003           00224         bcf STATUS,C
                      00225         
01F7   21A6           00226         call POSUNDOLEVA
01F8   21A6           00227         call POSUNDOLEVA
01F9   21A6           00228         call POSUNDOLEVA
01FA   21A6           00229         call POSUNDOLEVA
                      00230 
                      00231         BANK_0
01FB   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
01FC   1283               M                 bcf     STATUS,RP0    
01FD   0008           00232         return
                      00233 ;**********************************************************
01FE                  00234 NULA    ; if (X =  0) then PRETECENI := 0
                      00235                 ; if (X <> 0) then PRETECENI := 1
                      00236                 ; obsah X zustane nezmenen
                      00237         BANK_1
01FE   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
01FF   1683               M                 bsf     STATUS,RP0    
0200   01AC           00238         clrf PRETECENI
0201   30FF           00239         movlw h'FF'     
                      00240 
0202   05A0           00241         andwf OPERAND_X1,F
0203   1D03           00242         btfss STATUS,Z
0204   142C           00243                 bsf PRETECENI,0
0205   05A1           00244         andwf OPERAND_X2,F
0206   1D03           00245         btfss STATUS,Z
0207   142C           00246                 bsf PRETECENI,0
0208   05A2           00247         andwf OPERAND_X3,F
MPASM 03.90 Released                                  MP3.ASM   10-25-2005  21:19:59         PAGE 23


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0209   1D03           00248         btfss STATUS,Z
020A   142C           00249                 bsf PRETECENI,0
020B   05A3           00250         andwf OPERAND_X4,F
020C   1D03           00251         btfss STATUS,Z
020D   142C           00252                 bsf PRETECENI,0         
                      00253 
                      00254         BANK_0
020E   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
020F   1283               M                 bcf     STATUS,RP0    
0210   0008           00255         return
                      00256 ;**********************************************************
                      00038         include "pokusne.asm"
                      00001 ;**********************************************************
                      00002 ; POKUSNE PODPROGRAMY. TADY BUDU POSTUPNE TESTOVAT FUNKCNOST PODPROGRAMU...
0211                  00003 POZDRAV  ; odesle po seriove lince pozdrav
0211   3041           00004         movlw 'A'       
0212   22A0           00005         call WR_USART
0213   3068           00006         movlw 'h'
0214   22A0           00007         call WR_USART
0215   306F           00008         movlw 'o'
0216   22A0           00009         call WR_USART
0217   306A           00010         movlw 'j'
0218   22A0           00011         call WR_USART
0219   3021           00012         movlw '!'
021A   22A0           00013         call WR_USART
021B   0008           00014         return
                      00015 ;**********************************************************
021C                  00016 POKUSNY_KOD     
021C   30E0           00017         movlw b'11100000'       ; adresy budou v LBA, budeme pracovat s masterem
021D   00AB           00018         movwf DEVICE
021E   3000           00019         movlw .0
021F   00A6           00020         movwf SECTOR_C
0220   00A7           00021         movwf LBA1      
0221   01A8           00022         clrf LBA2
0222   01A9           00023         clrf LBA3
0223   01A4           00024         clrf FEATURES
0224   3021           00025         movlw 0x21              ; read sector
0225   30EC           00026         movlw 0xEC              ; identify device
0226   00AD           00027         movwf COMMAND
0227   204D           00028         call WR_BLOCK
                      00029 
0228   212E           00030         call WAIT_FOR_READY                     ; cekame az disk nebude zaneprazdnen
0229   082C           00031         movfw ATA_STATUS
022A   22A0           00032         call WR_USART
022B   30FF           00033         movlw h'ff'
022C   22A0           00034         call WR_USART
                      00035 
                      00036         ;call KONTROLA
                      00037         ;movlw h'88'
                      00038         ;call WR_USART
                      00039         
022D   30FF           00040         movlw h'ff'                     ; dalsich XX slov odesleme na USART...
022E   00BA           00041         movwf TEMP5
022F                  00042 POK5_ODESLI
MPASM 03.90 Released                                  MP3.ASM   10-25-2005  21:19:59         PAGE 24


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

022F   2125           00043         call WAIT_FOR_DATA              ; cekame na data
0230   2079           00044         call READ_DATA
0231   0821           00045         movfw DATA_H
0232   22A0           00046         call WR_USART
0233   0820           00047         movfw DATA_L
0234   22A0           00048         call WR_USART
0235   0BBA           00049         decfsz TEMP5,F
0236   2A2F           00050         goto POK5_ODESLI
                      00051 
0237   0008           00052         return
                      00053 ;**********************************************************
0238                  00054 KONTROLA
                      00055         ; jen tak pro kontrolu nam do PC posle hodnoty vsech ATA registru 
                      00056         ; (abych mel prehled)
0238   200D           00057         call RD_STATUS_A
0239   0822           00058         movfw ATA_STATUS_A 
023A   22A0           00059         call WR_USART   
                      00060         
023B   2009           00061         call RD_ERROR
023C   0825           00062         movfw ATA_ERROR 
023D   22A0           00063         call WR_USART   
                      00064         
023E   2011           00065         call RD_SC
023F   0826           00066         movfw SECTOR_C
0240   22A0           00067         call WR_USART   
                      00068         
0241   2015           00069         call RD_LBA1
0242   0827           00070         movfw LBA1
0243   22A0           00071         call WR_USART   
                      00072         
0244   2019           00073         call RD_LBA2
0245   0828           00074         movfw LBA2
0246   22A0           00075         call WR_USART   
                      00076         
0247   201D           00077         call RD_LBA3
0248   0829           00078         movfw LBA3
0249   22A0           00079         call WR_USART   
                      00080         
024A   2021           00081         call RD_DEVICE
024B   082B           00082         movfw DEVICE
024C   22A0           00083         call WR_USART   
                      00084         
024D   2005           00085         call RD_STATUS
024E   082C           00086         movfw ATA_STATUS 
024F   22A0           00087         call WR_USART   
                      00088         
0250   0008           00089         return  
                      00090 ;**********************************************************
0251                  00091 POKUSNY_KOD4  ; pocka nez prijde nejake dato 
0251   3080           00092         movlw b'10000000'       ;zapnu USART, povolim continuous receive
0252   0098           00093         movwf RCSTA
0253   3090           00094         movlw b'10010000'       ;zapnu USART, povolim continuous receive
0254   0098           00095         movwf RCSTA
                      00096 
MPASM 03.90 Released                                  MP3.ASM   10-25-2005  21:19:59         PAGE 25


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0255   1E8C           00097         btfss PIR1,5    ; vlajka preruseni 1 = The USART receive buffer is full
0256   2A51           00098         goto POKUSNY_KOD4
                      00099 
0257   128C           00100         bcf PIR1,5
                      00101 
                      00102         ;movfw RCREG
                      00103         ;sublw h'8a'
                      00104         ;btfss STATUS,Z
                      00105         ;goto POKUSNY_KOD4
                      00106 
0258   3080           00107         movlw b'10000000'       ;zapnu USART, povolim continuous receive
0259   0098           00108         movwf RCSTA
025A   3090           00109         movlw b'10010000'       ;zapnu USART, povolim continuous receive
025B   0098           00110         movwf RCSTA
                      00111 
025C   1587           00112         bsf ERROR_LED
025D   0008           00113         return
                      00114 ;**********************************************************
                      00039 
                      00040 ;**********************************************************
025E                  00041 START
025E   2286           00042         call INIT_CONFIG        ; nakonfiguruje preruseni, WDT, USART, pull ups...
025F   2273           00043         call INIT_PORT          ; nastavy trisy, a porty do vychozi polohy
                      00044 
0260   2120           00045         call DELAY_25us         ; chvili pockame, protoze napjeti zdroje co mam doma (stary PC-AT zdroj)
0261   2120           00046         call DELAY_25us         ; zezacatku dost kolisa...
0262   2120           00047         call DELAY_25us
                      00048 
0263   2211           00049         call POZDRAV
                      00050 
                      00051         ;call MP3_SOFT_RESET
0264   20A3           00052         call ATA_RESET
0265   1C2E           00053         btfss ATA_ATTRIBUTES,ATA_OK
                      00054         ;goto $-2                       ;pokud neni pripojen disk, tak se jej pokousime neustale najit..
                            .
0266   0000           00055         nop
                      00056 
0267   082E           00057         movfw ATA_ATTRIBUTES
0268   22A0           00058         call WR_USART   
                      00059         
0269   221C           00060         call POKUSNY_KOD
                      00061 
026A                  00062 BIG_LOOP
026A   1587           00063         bsf ERROR_LED
026B   22A9           00064         call DELAY_500ms
                      00065 
026C   1187           00066         bcf ERROR_LED
026D   22A9           00067         call DELAY_500ms
                      00068         
026E   304F           00069         movlw 'O'
026F   22A0           00070         call WR_USART
0270   304B           00071         movlw 'K'
0271   22A0           00072         call WR_USART
                      00073         
MPASM 03.90 Released                                  MP3.ASM   10-25-2005  21:19:59         PAGE 26


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0272   2A6A           00074         goto BIG_LOOP
                      00075 ;**********************************************************
0273                  00076 INIT_PORT
                      00077         BANK_1
0273   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0274   1683               M                 bsf     STATUS,RP0    
                      00078 ;       movlw b'00100001'                       ; bity SO a DREQ jako vstupy z dekoderu
0275   30FF           00079         movlw 0xff
0276   0085           00080         movwf MP3_PORT_TRIS
0277   3000           00081         movlw b'00000000'                       ; adresovani disku jako vystupy, jen vstup pro USART
0278   0087           00082         movwf ATA_ADDRESS_TRIS          
0279   3000           00083         movlw .0
027A   0089           00084         movwf ATA_CONTROL_TRIS          ; ovladani disku jako vystupy
027B   30FF           00085         movlw 0xff
027C   0086           00086         movwf DATA_PORT_LOW_TRIS        ; datovou sbernici jako vstupy
027D   0088           00087         movwf DATA_PORT_HIGH_TRIS       
                      00088         BANK_0
027E   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
027F   1283               M                 bcf     STATUS,RP0    
                      00089         
0280   3007           00090         movlw b'00000111'       ; signal reset-, diow- a dior- jsou aktivni v log. 0 !!!
0281   0089           00091         movwf ATA_CONTROL
0282   303F           00092         movlw b'00111111'       ; CS1-, CS0- = 1 => datova sbernice disku je odpojena
0283   0087           00093         movwf ATA_ADDRESS
0284   0185           00094         clrf MP3_PORT   
0285   0008           00095         return
                      00096 ;**********************************************************
0286                  00097 INIT_CONFIG     ; nakonfiguruje preruseni, WDT, USART, pull ups....
                      00098         BANK_1
0286   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0287   1683               M                 bsf     STATUS,RP0    
0288   30C7           00099         movlw b'11000111'       ; ...pull up a podobny koniny
                      00100                 ; PORTB Pull-up Enable bit              1 = pull up enabled
                      00101                 ; Interrupt Edge Select bit             1 = interrupt on rising edge of RB0/INT pin
                      00102                 ; TMR0 Clock Source Select bit  0 = Internal instruction cycle clock (CLKO)
                      00103                 ; TMR0 Source Edge Select bit   0 = Increment on low-to-high transition on RA4/T0CKI pin
                      00104                 ; Prescaler Assignment bit              0 = Prescaler is assigned to the Timer0 module
                      00105                 ; PS2:PS0: Prescaler Rate Select bits   111 = TMR0 Rate 1 : 256; WDT Rate 1 : 128
0289   0081           00106         movwf OPTION_REG
                      00107         
028A   3020           00108         movlw b'00100000'       ; povolime preruseni od USARTu (kdyz neco dostanem)
028B   008C           00109         movwf PIE1      
028C   3000           00110         movlw b'00000000'       ; ostatni vnejsi preruseni vymaskujeme
028D   008D           00111         movwf PIE2                      
028E   30C0           00112         movlw b'11000000'       ; povolime preruseni, na vnejsi zarizeni (USART)
028F   008B           00113         movwf INTCON                            
                      00114 
0290   3026           00115         movlw b'00100110'       ;konfigurace USARTu (asynchronni, 8bit, bez parity, rychle - (BRGH = 1))
0291   0098           00116         movwf TXSTA
                      00117         BANK_0
0292   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0293   1283               M                 bcf     STATUS,RP0    
0294   3080           00118         movlw b'10000000'       ;zapnu USART
0295   0098           00119         movwf RCSTA
MPASM 03.90 Released                                  MP3.ASM   10-25-2005  21:19:59         PAGE 27


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00120         BANK_1
0296   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0297   1683               M                 bsf     STATUS,RP0    
                      00121         ;movlw .129             ; Fosc = 20 MHz, BRGH=1 => rychlost = 9615 bps
0298   3067           00122         movlw .103              ; Fosc = 16 MHz, BRGH=1 => rychlost = 9615 bps
0299   0099           00123         movwf SPBRG     
                      00124 
029A   3007           00125         movlw b'00000111'
029B   009F           00126         movwf ADCON1            ; vsechny vstupy (RA,RE) jako digitalni
                      00127         BANK_0  
029C   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
029D   1283               M                 bcf     STATUS,RP0    
029E   019F           00128         clrf ADCON0             ; pro jistotu (vypneme A/D prevodniky)
                      00129 
029F   0008           00130         return
                      00131 ;**********************************************************
02A0                  00132 WR_USART        ; odesle slovo ve workingu po ICSP
                      00133         BANK_1  
02A0   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
02A1   1683               M                 bsf     STATUS,RP0    
02A2   1C98           00134         btfss TXSTA,1 
02A3   2AA0           00135         goto WR_USART   ; cekame do chvile nez bude pripraven transmit buffer 
                      00136 
                      00137         BANK_0  
02A4   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
02A5   1283               M                 bcf     STATUS,RP0    
02A6   0099           00138         movwf TXREG
02A7   0008           00139         return
                      00140 ;**********************************************************
02A8                  00141 INTERRUPT               ; sem se skace po zavolani preruseni...
02A8   0009           00142         retfie
                      00143 ;**********************************************************
02A9                  00144 DELAY_500ms
                      00145 ; (Fosc = 16 MHz , instr. cyklus= 0.25 us) 500 000us / 0.25 us = 2 000 000 instrukcnich cyklu
                      00146 ;Variables: TMP2, TMP1, TMP0
                      00147 ;Delay 2000000 cycles
02A9   3047           00148         MOVLW 0x47  ;71 DEC
02AA   00B7           00149         MOVWF TMP2
02AB   302B           00150         MOVLW 0x2B  ;43 DEC
02AC   00B6           00151         MOVWF TMP1
02AD   30D9           00152         MOVLW 0x0D9  ;217 DEC
02AE   00B8           00153         MOVWF TMP0
02AF   0BB8           00154         DECFSZ TMP0,F
02B0   2AAF           00155         GOTO $-1
02B1   0BB6           00156         DECFSZ TMP1,F
02B2   2AAD           00157         GOTO $-5
02B3   0BB7           00158         DECFSZ TMP2,F
02B4   2AAB           00159         GOTO $-9
                      00160 ;End of Delay
02B5   0008           00161         return
                      00162 ;**********************************************************
                      00163         END
MPASM 03.90 Released                                  MP3.ASM   10-25-2005  21:19:59         PAGE 28


SYMBOL TABLE
  LABEL                             VALUE 

ABRT                              00000002
ACKDT                             00000005
ACKEN                             00000004
ACKSTAT                           00000006
ADCON0                            0000001F
ADCON1                            0000009F
ADCS0                             00000006
ADCS1                             00000007
ADDEN                             00000003
ADFM                              00000007
ADIE                              00000006
ADIF                              00000006
ADON                              00000000
ADRESH                            0000001E
ADRESL                            0000009E
APPLICABLE                        00000007
ATA_ADDRESS                       00000007
ATA_ADDRESS_TRIS                  00000087
ATA_ATTRIBUTES                    0000002E
ATA_CONTROL                       00000009
ATA_CONTROL_TRIS                  00000089
ATA_DIOR_N                        ATA_CONTROL,2
ATA_DIOW_N                        ATA_CONTROL,1
ATA_ERROR                         00000025
ATA_OK                            00000000
ATA_RESET                         000000A3
ATA_RESET_N                       ATA_CONTROL,0
ATA_STATUS                        0000002C
ATA_STATUS_A                      00000022
BANK_0                            
BANK_1                            
BANK_2                            
BANK_3                            
BCLIE                             00000003
BCLIF                             00000003
BF                                00000000
BIG_LOOP                          0000026A
BIG_SECTOR                        00000003
BRGH                              00000002
BSY                               00000007
C                                 00000000
CCP1CON                           00000017
CCP1IE                            00000002
CCP1IF                            00000002
CCP1M0                            00000000
CCP1M1                            00000001
CCP1M2                            00000002
CCP1M3                            00000003
CCP1X                             00000005
CCP1Y                             00000004
CCP2CON                           0000001D
CCP2IE                            00000000
CCP2IF                            00000000
CCP2M0                            00000000
MPASM 03.90 Released                                  MP3.ASM   10-25-2005  21:19:59         PAGE 29


SYMBOL TABLE
  LABEL                             VALUE 

CCP2M1                            00000001
CCP2M2                            00000002
CCP2M3                            00000003
CCP2X                             00000005
CCP2Y                             00000004
CCPR1H                            00000016
CCPR1L                            00000015
CCPR2H                            0000001C
CCPR2L                            0000001B
CHS0                              00000003
CHS1                              00000004
CHS2                              00000005
CKE                               00000006
CKP                               00000004
COMMAND                           0000002D
CREN                              00000004
CSRC                              00000007
D                                 00000005
DATA_ADDRESS                      00000005
DATA_H                            00000021
DATA_L                            00000020
DATA_PORT_HIGH                    00000008
DATA_PORT_HIGH_TRIS               00000088
DATA_PORT_LOW                     00000006
DATA_PORT_LOW_TRIS                00000086
DC                                00000001
DELAY_25us                        00000120
DELAY_500ms                       000002A9
DEVICE                            0000002B
DEVICE_C                          00000023
DRDY                              00000006
DRQ                               00000003
D_A                               00000005
D_COMMAND                         00000027
D_DATA_R                          00000020
D_DEVICE                          00000026
D_DEVICE_C                        00000016
D_ERROR                           00000021
D_FEATURES                        00000021
D_LBA1                            00000023
D_LBA2                            00000024
D_LBA3                            00000025
D_SECTOR_C                        00000022
D_STATUS                          00000027
D_STATUS_A                        00000016
EEADR                             0000010D
EEADRH                            0000010F
EECON1                            0000018C
EECON2                            0000018D
EEDATA                            0000010C
EEDATH                            0000010E
EEIE                              00000004
EEIF                              00000004
EEPGD                             00000007
MPASM 03.90 Released                                  MP3.ASM   10-25-2005  21:19:59         PAGE 30


SYMBOL TABLE
  LABEL                             VALUE 

ERR                               00000000
ERROR_LED                         ATA_ADDRESS,3
F                                 00000001
FEATURES                          00000024
FERR                              00000002
FSR                               00000004
GCEN                              00000007
GIE                               00000007
GO                                00000002
GO_DONE                           00000002
HOB                               00000007
I2C_DATA                          00000005
I2C_READ                          00000002
I2C_START                         00000003
I2C_STOP                          00000004
IBF                               00000007
IBOV                              00000005
IDENTIFY_DEVICE                   000000BE
INDF                              00000000
INDF_BANK_0                       
INDF_BANK_1                       
INDF_BANK_2                       
INDF_BANK_3                       
INIT_ATA__DALSI                   0000010B
INIT_ATA__DALSI2                  00000116
INIT_ATA__NOT_SUPPORT_LBA48       00000108
INIT_ATA__ODESLI_ZNAK             000000D0
INIT_CONFIG                       00000286
INIT_PORT                         00000273
INTCON                            0000000B
INTE                              00000004
INTEDG                            00000006
INTERRUPT                         000002A8
INTF                              00000001
IRP                               00000007
KONTROLA                          00000238
LBA1                              00000027
LBA2                              00000028
LBA3                              00000029
LBA4                              0000002A
LBA48_SUPPORT                     00000002
LBA_SUPPORT                       00000001
MP3_BSYNC                         MP3_PORT,5
MP3_CS                            MP3_PORT,3
MP3_DREQ                          MP3_PORT,4
MP3_PORT                          00000005
MP3_PORT_TRIS                     00000085
MP3_SCLK                          MP3_PORT,2
MP3_SI                            MP3_PORT,1
MP3_SO                            MP3_PORT,0
MP3_SOFT_RESET                    00000134
MP3_WR_BYTE                       00000146
MP3_WR_BYTE__1                    00000149
MP3_WR_REG                        0000013C
MPASM 03.90 Released                                  MP3.ASM   10-25-2005  21:19:59         PAGE 31


SYMBOL TABLE
  LABEL                             VALUE 

NOT_A                             00000005
NOT_ADDRESS                       00000005
NOT_BO                            00000000
NOT_BOR                           00000000
NOT_DONE                          00000002
NOT_PD                            00000003
NOT_POR                           00000001
NOT_RBPU                          00000007
NOT_RC8                           00000006
NOT_T1SYNC                        00000002
NOT_TO                            00000004
NOT_TX8                           00000006
NOT_W                             00000002
NOT_WRITE                         00000002
NULA                              000001FE
OBF                               00000006
OERR                              00000001
OPERAND_X1                        000000A0
OPERAND_X2                        000000A1
OPERAND_X3                        000000A2
OPERAND_X4                        000000A3
OPERAND_Y1                        000000A4
OPERAND_Y2                        000000A5
OPERAND_Y3                        000000A6
OPERAND_Y4                        000000A7
OPTION_REG                        00000081
P                                 00000004
PARAM_MAX_LBA1                    0000002F
PARAM_MAX_LBA2                    00000030
PARAM_MAX_LBA3                    00000031
PARAM_MAX_LBA4                    00000032
PARAM_SLOV_V_SEKTORU1             00000033
PARAM_SLOV_V_SEKTORU2             00000034
PCFG0                             00000000
PCFG1                             00000001
PCFG2                             00000002
PCFG3                             00000003
PCL                               00000002
PCLATH                            0000000A
PCON                              0000008E
PEIE                              00000006
PEN                               00000002
PIE1                              0000008C
PIE2                              0000008D
PIR1                              0000000C
PIR2                              0000000D
POK5_ODESLI                       0000022F
POKUSNY_KOD                       0000021C
POKUSNY_KOD4                      00000251
PORTA                             00000005
PORTB                             00000006
PORTC                             00000007
PORTD                             00000008
PORTE                             00000009
MPASM 03.90 Released                                  MP3.ASM   10-25-2005  21:19:59         PAGE 32


SYMBOL TABLE
  LABEL                             VALUE 

POSUNDOLEVA                       000001A6
POSUNDOLEVA_1                     000001AC
POSUNDOLEVA_2                     000001B4
POSUNDOLEVA_3                     000001BD
POSUNDOLEVA_4                     000001C7
POSUNDOPRAVA                      000001D2
POSUNDOPRAVA_1                    000001D8
POSUNDOPRAVA_2                    000001E0
POSUNDOPRAVA_3                    000001E9
POSUNDOPRAVA_4                    000001F3
POZDRAV                           00000211
PR2                               00000092
PRESKOC                           0000008B
PRETECENI                         000000AC
PS0                               00000000
PS1                               00000001
PS2                               00000002
PSA                               00000003
PSPIE                             00000007
PSPIF                             00000007
PSPMODE                           00000004
R                                 00000002
RBIE                              00000003
RBIF                              00000000
RC8_9                             00000006
RC9                               00000006
RCD8                              00000000
RCEN                              00000003
RCIE                              00000005
RCIF                              00000005
RCREG                             0000001A
RCSTA                             00000018
RD                                00000000
RD_DEVICE                         00000021
RD_ERROR                          00000009
RD_LBA1                           00000015
RD_LBA2                           00000019
RD_LBA3                           0000001D
RD_SC                             00000011
RD_STATUS                         00000005
RD_STATUS_A                       0000000D
READ_DATA                         00000079
READ_WRITE                        00000002
ROZDIL                            0000017D
RP0                               00000005
RP1                               00000006
RSEN                              00000001
RUTR                              00000056
RUTW                              00000063
RX9                               00000006
RX9D                              00000000
R_W                               00000002
S                                 00000003
SECTOR_C                          00000026
MPASM 03.90 Released                                  MP3.ASM   10-25-2005  21:19:59         PAGE 33


SYMBOL TABLE
  LABEL                             VALUE 

SELECT_DEVICE                     00000090
SEN                               00000000
SMP                               00000007
SOUCET                            00000154
SPBRG                             00000099
SPEN                              00000007
SREN                              00000005
SRST                              00000002
SSPADD                            00000093
SSPBUF                            00000013
SSPCON                            00000014
SSPCON2                           00000091
SSPEN                             00000005
SSPIE                             00000003
SSPIF                             00000003
SSPM0                             00000000
SSPM1                             00000001
SSPM2                             00000002
SSPM3                             00000003
SSPOV                             00000006
SSPSTAT                           00000094
START                             0000025E
STATUS                            00000003
SYNC                              00000004
T0CS                              00000005
T0IE                              00000005
T0IF                              00000002
T0SE                              00000004
T1CKPS0                           00000004
T1CKPS1                           00000005
T1CON                             00000010
T1INSYNC                          00000002
T1OSCEN                           00000003
T1SYNC                            00000002
T2CKPS0                           00000000
T2CKPS1                           00000001
T2CON                             00000012
TEMP1                             00000036
TEMP2                             00000037
TEMP3                             00000038
TEMP4                             00000039
TEMP5                             0000003A
TEMPW                             00000035
TMP0                              00000038
TMP1                              00000036
TMP2                              00000037
TMR0                              00000001
TMR1CS                            00000001
TMR1H                             0000000F
TMR1IE                            00000000
TMR1IF                            00000000
TMR1L                             0000000E
TMR1ON                            00000000
TMR2                              00000011
MPASM 03.90 Released                                  MP3.ASM   10-25-2005  21:19:59         PAGE 34


SYMBOL TABLE
  LABEL                             VALUE 

TMR2IE                            00000001
TMR2IF                            00000001
TMR2ON                            00000002
TOUTPS0                           00000003
TOUTPS1                           00000004
TOUTPS2                           00000005
TOUTPS3                           00000006
TRISA                             00000085
TRISB                             00000086
TRISC                             00000087
TRISD                             00000088
TRISE                             00000089
TRISE0                            00000000
TRISE1                            00000001
TRISE2                            00000002
TRMT                              00000001
TX8_9                             00000006
TX9                               00000006
TX9D                              00000000
TXD8                              00000000
TXEN                              00000005
TXIE                              00000004
TXIF                              00000004
TXREG                             00000019
TXSTA                             00000098
UA                                00000001
VYSLEDEK1                         000000A8
VYSLEDEK2                         000000A9
VYSLEDEK3                         000000AA
VYSLEDEK4                         000000AB
W                                 00000000
WAIT_FOR_DATA                     00000125
WAIT_FOR_READY                    0000012E
WCOL                              00000007
WR                                00000001
WREN                              00000002
WRERR                             00000003
WR_BLOCK                          0000004D
WR_COMMAND                        0000002A
WR_DC                             00000025
WR_DEVICE                         00000043
WR_FEATURES                       00000048
WR_LBA1                           00000034
WR_LBA2                           00000039
WR_LBA3                           0000003E
WR_SC                             0000002F
WR_USART                          000002A0
Z                                 00000002
ZAPIS_DO_BUFFERU_1                00000094
ZAPIS_DO_BUFFERU_1__ZAPIS         00000097
_BODEN_OFF                        00003FBF
_BODEN_ON                         00003FFF
_CPD_OFF                          00003FFF
_CPD_ON                           00003EFF
MPASM 03.90 Released                                  MP3.ASM   10-25-2005  21:19:59         PAGE 35


SYMBOL TABLE
  LABEL                             VALUE 

_CP_ALL                           00000FCF
_CP_HALF                          00001FDF
_CP_OFF                           00003FFF
_CP_UPPER_256                     00002FEF
_DEBUG_OFF                        00003FFF
_DEBUG_ON                         000037FF
_HS_OSC                           00003FFE
_LP_OSC                           00003FFC
_LVP_OFF                          00003F7F
_LVP_ON                           00003FFF
_PWRTE_OFF                        00003FFF
_PWRTE_ON                         00003FF7
_RC_OSC                           00003FFF
_WDT_OFF                          00003FFB
_WDT_ON                           00003FFF
_WRT_ENABLE_OFF                   00003DFF
_WRT_ENABLE_ON                    00003FFF
_XT_OSC                           00003FFD
__16F877                          00000001
c                                 00000000
nEIN                              00000001


MEMORY USAGE MAP ('X' = Used,  '-' = Unused)

0000 : X---XXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0040 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0080 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
00C0 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0100 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0140 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0180 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
01C0 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0200 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0240 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0280 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXX----------
2000 : -------X-------- ---------------- ---------------- ----------------

All other memory blocks unused.

Program Memory Words Used:   691
Program Memory Words Free:  7501


Errors   :     0
Warnings :     0 reported,     0 suppressed
Messages :     0 reported,   105 suppressed

