MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE  1


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00001 ;   HLAVNI SOUBOR 
                      00002 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00003 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00004 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00005 ;  MP3 PREPRCAVAC
                      00006 ; ================
                      00007 ; 
                      00008 ; Program mp3 prehravace pouzivajici jako zdroj dat ATA disk.
                      00009 ; 
                      00010 ; Umi identifikovat disk, precist libovolny sektor, v MBR  najit oddily se systemem souboru FAT32, 
                      00011 ; nacist spousteci zaznam FAT32, praci s FAT32, komunikaci s vs1001 a prehravani mp3 pres vs1001.
                      00012 ;
                      00013 ;
                      00014 ; dodelat:
                      00015 ;       - po skonceni mp3 nacist dalsi mp3
                      00016 ;       - Nejak udelat aby soubory byly prehravany podle abecedy
                      00017 ;       - Podporu dlouhych nazvu souboru
                      00018 ;       - podporu ID3v1
                      00019 ;       - pak uz jen vychytavky...      (napr. do vs1001 naprogramovat ekvalizer a nejak ho ovladat...)
                      00020 ;
                      00021 ; srpen 2005 - rijen 2005 Karry - lukas.karas@centrum.cz
                      00022 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00023 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00024 
                      00025 
                      00026 ;**********************************************************
                      00027 ;   VERZE 0.8b
                      00028 ;**********************************************************
                      00029 ; !!!!!!!! VSECHNY CASOVE SMYCKY JSOU POCITANY NA Fosc=16MHz !!!!!
                      00030 ; !!!!!!!! NASTAVENI USARTu TAKY !!!!!!!
                      00031         LIST            p=PIC16f877,C=132,n=60
2007   3F3A           00032         __CONFIG        _WDT_OFF & _HS_OSC & _PWRTE_OFF & _BODEN_OFF & _LVP_OFF 
                      00033                         ; LVP_OFF = RB3 jako digitalni I/O
                      00034         errorlevel -302         ; vypnuti Message [302]: Register in operand not in bank 0.
                      00035         errorlevel -306         ; vypnuti Message[306] : Crossing page boundary -- ensure page bits are 
                            set.
                      00036                                                 ; ! zjednoduseni vypisu, ale riziko prehlednuti chyby
                      00037 
                      00038         #DEFINE VS1001 1        ; 1 = vs1001 pripojen, casti kodu pro vs1001 se prekladaji, ...
                      00039                                                 ; ...pokud 0 je pripojen pouze disk, na portA se nic nep
                            osila
                      00040 ;**********************************************************
                      00041 
                      00042         include "P16F877.inc"   ; definice blbosti kolem procesoru
                      00001         LIST
                      00002 ; P16F877.INC  Standard Header File, Version 1.00    Microchip Technology, Inc.
                      00373         LIST
                      00043         include "mp3.inc"               ; definice promennych, konstant a portu
                      00001 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00002 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00003 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00004 ; DEFINICE PORTU
                      00005 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00006 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE  2


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00007 ;**********************************************************
                      00008 ; ZAPOJENI PORTU:
                      00009 ;       portA - MP3 dekoder vs1001g
                      00010 ;                               5      4     3   2     1         0
                      00011 ;                               BSYNC  DREQ  CS  SCLK  SI/SDATA  SO
                      00012 ;               portB - ATA datova sbernice (dolnich 8 bitu)
                      00013 ;               7   .. 0
                      00014 ;               DD7 .. DD0
                      00015 ;               portD - ATA datova sbernice (hornich 8 bitu)
                      00016 ;               15   .. 8
                      00017 ;               DD15 .. DD8 
                      00018 ;               portC - adresove signaly ATA, ERROR_LED, a USART
                      00019 ;                               7          6         5     4     3          2    1    0
                      00020 ;                               USART out  USART in  CS1-  CS0-  ERROR_LED  DA2  DA1  DA0  
                      00021 ;                               (signaly se znaminkem minus jsou aktivni v logicke 0 !!!)
                      00022 ;               portE - ridici signaly ATA
                      00023 ;                               2       1      0
                      00024 ;                               DIOR-   DIOW-  RESET-
                      00025 ;                               (signaly se znaminkem minus jsou aktivni v logicke 0 !!!)
                      00026 ;**********************************************************
  00000005            00027 MP3_PORT                equ PORTA
  00000085            00028 MP3_PORT_TRIS   equ TRISA
                      00029 ; BITY MP3_PORT
                      00030 #define MP3_SO          MP3_PORT,0      ; serial output - tady dostavame z dekoderu data
                      00031 #define MP3_SI          MP3_PORT,1      ; serial input  - pokud MP3_CS=1, tak posilame mp3 data, pokud =
                            0, tak posilame prikaz
                      00032 #define MP3_SCLK        MP3_PORT,2      ; clock - nabezna hrana urcuje platnost dat pri seriovem prenosu
                      00033 #define MP3_CS          MP3_PORT,3      ; cable select  - pokud MP3_CS=1, tak po SI posilame mp3 data, p
                            okud =0, tak posilame prikaz
                      00034 #define MP3_DREQ        MP3_PORT,4      ; data request  - pokud =1, tak dekoder pozaduje dalsi mp3 data
                      00035 #define MP3_BSYNC       MP3_PORT,5      ; pro synchronizaci - ma byt nastaven pri prvnim prenasenem bitu
                             kazdeho bytu
                      00036 ;**********************************************************
                      00037 ; pokud jsem dobre pochopil dataSheat dekoderu vs1001, tak staci do nej jen cpat data, a kdyz skonci mp3
                            , tak odeslat 1024 nulovych bytu,
                      00038 ; softwarove resetovat a posilat dalsi mp3...
                      00039 ;
                      00040 ; popis registru obvodu vs1001 najdete na strane 22 dataSheatu 
                      00041 ; v jeho registrech jsou k dispozici data z hlavicky mp3, zdali mp3 ma spravny format, 
                      00042 ; ovladani hlasitosti a dalsi spousty uzitecnych informaci
                      00043 ;**********************************************************
                      00044 ; PORTY DISKU
  00000007            00045 ATA_ADDRESS             equ PORTC
  00000009            00046 ATA_CONTROL             equ PORTE
  00000006            00047 DATA_PORT_LOW           equ PORTB
  00000008            00048 DATA_PORT_HIGH          equ PORTD
                      00049 
                      00050 
  00000087            00051 ATA_ADDRESS_TRIS        equ TRISC
  00000089            00052 ATA_CONTROL_TRIS        equ TRISE
  00000086            00053 DATA_PORT_LOW_TRIS      equ TRISB
  00000088            00054 DATA_PORT_HIGH_TRIS     equ TRISD
                      00055 
                      00056 ; bity ATA_ADDRESS portu
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE  3


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00057 #define ERROR_LED       ATA_ADDRESS,3
                      00058 ; bity ATA_CONTROL portu
                      00059 #define ATA_RESET_N     ATA_CONTROL,0
                      00060 #define ATA_DIOW_N      ATA_CONTROL,1
                      00061 #define ATA_DIOR_N      ATA_CONTROL,2
                      00062 
                      00063 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00064 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00065 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00066 ; DEFINICE KONSTANT
                      00067 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00068 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00069 ; ADRESY ATA REGISTRU:
                      00070 ;                                                                       / CHS adressing
                      00071 ;   +-----------+--------------+-------------------+-----------------+
                      00072 ;   | CS0- CS1- |  DA2 DA1 DA0 | READ              | WRITE           |   
                      00073 ;   +-----------+--------------+-------------------+-----------------+
                      00074 ;   | 1    1    |  x   x   x   | data bush h.imped (validace prikazu)|
                      00075 ;   +-----------+--------------+-------------------+-----------------+
                      00076 ;   | 1    0    |  1   1   0   | alternate status  | device control  |
                      00077 ;   +-----------+--------------+-------------------+-----------------+
                      00078 ;   | 0    1    |  0   0   0   | data              | data            |
                      00079 ;   | 0    1    |  0   0   1   | error             | features        |
                      00080 ;   | 0    1    |  0   1   0   |             sector count            |
                      00081 ;   | 0    1    |  0   1   1   |             LBA bits 0-7            |  sector number
                      00082 ;   | 0    1    |  1   0   0   |             LBA bits 8-15           |  cilinder LOW 
                      00083 ;   | 0    1    |  1   0   1   |             LBA bits 16-23          |  cilinder HIGH
                      00084 ;   | 0    1    |  1   1   0   |         device / LBA bits 24-27*    |  device, head
                      00085 ;   | 0    1    |  1   1   1   | status            | command         |
                      00086 ;   +-----------+--------------+-------------------+-----------------+
                      00087 ;   | 0    0    |  0   0   0   | invalid addres    | invalid addres  |
                      00088 ;   +-----------+--------------+-------------------+-----------------+
                      00089 ;
                      00090 ;   * 7 6 5 4   3     2     1     0 
                      00091 ;     1 L 1 DEV LBA27 LBA26 LBA25 LBA24
                      00092 ;  L=1 -> aresa je LBA , L=0 -> adresa je CHS
                      00093 ;  DEV=0 -> master , DEV=1 -> SLAVE
                      00094 ;
                      00095 ;  pokud disk podporuje LBA 48, tak je zadavani adresy trochu odlisne od LBA27
                      00096 ;**********************************************************
                      00097 ; toto jsou definice adres ATA registru. Staci udat jejich adresu na ATA_ADDRESS port a dat prikaz ke ct
                            eni ci zapisu (DIOR- / DIOW-)
  00000016            00098 D_STATUS_A    equ b'00010110'
  00000016            00099 D_DEVICE_C    equ D_STATUS_A
  00000020            00100 D_DATA_R      equ b'00100000'
  00000021            00101 D_FEATURES    equ b'00100001'
  00000021            00102 D_ERROR       equ D_FEATURES
  00000022            00103 D_SECTOR_C    equ b'00100010'
  00000023            00104 D_LBA1        equ b'00100011'   ; LBA low
  00000024            00105 D_LBA2        equ b'00100100'   ; LBA middle
  00000025            00106 D_LBA3        equ b'00100101'   ; LBA high
  00000026            00107 D_DEVICE      equ b'00100110'
  00000027            00108 D_STATUS      equ b'00100111'
  00000027            00109 D_COMMAND     equ D_STATUS
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE  4


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00110 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00111 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00112 ; ROZLOZENI PAMETI PROGRAMU
                      00113 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00114 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00115 ;       page 0  0x0000 - 0x07FF
                      00116 ;                               - mp3.asm (hlavni smycka)
                      00117 ;                               - ata.asm
                      00118 ;                               - fat32.asm
                      00119 ;                               - aritmetic.asm
                      00120 ;       page 1  0x0800 - 0x0FFF
                      00121 ;                               - vs1001.asm
                      00122 ;                               - commands.asm
                      00123 ;       page 2  0x1000 - 0x17FF
                      00124 ;       page 3  0x1800 - 0x1FFF
                      00125 ;
                      00126 ; Vsechny podprogramy by mely nechat nastaven PCLATH na hodnotu jak se do nich vstoupilo...
                      00127 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00128 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00129 ; DEFINICE PROMENNYCH
                      00130 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00131 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00132 ; MAPA PAMETI: (368 bytu)
                      00133 ;       BANK 0:         0x000 - 0x01F = specialni registry,
                      00134 ;                               0x020 - 0x07F = misto (96bytu) pro nase registry:
                      00135 ;                                       0x020 - 0x034 -> 21bytu pro registry a parametry HDD
                      00136 ;                                       0x035 - 0x03a -> 6bytu pro parametry podprogramu (musime zajisti
                            t, abychom nepouzivali registry, ktere pouzivaji i podprogramy!!!)
                      00137 ;                                       0x03B - 0x04C -> parametry FATky
                      00138 ;                                       0x04D - 0x050 -> registry pro praci s VS1001
                      00139 ;                                       0x051 - 0xXXX -> ---------------------------
                      00140 ;                                       0x05F - 0x06F -> informace potrebne pro prehravani
                      00141 ;                               0x070 - 0x07F -> registry pro potreby preruseni (dostupne z kterekoliv b
                            anky)
                      00142 ;                                       0x070 - 0x072 -> 3 registry slouzici k zalohovani W, STATUS, FSR
                      00143 ;                                       0x073 - 0x076 -> registry pro prikazy a preruseni + zaloha pro P
                            CLATH
                      00144 ;                                       0x077         -> ---------------------------
                      00145 ;                                       0x078 - 0x07F -> 8 bytu zasobniku prikazu (obsahujici data prika
                            zu prisla po USARTU)
                      00146 ;
                      00147 ;       BANK 1:         0x080 - 0x09F = specialni registry,
                      00148 ;                               0x0A0 - 0x0EF = volne misto (80bytu)
                      00149 ;                                       0x0A0 - 0x0AC -> parametry a navratove hodnoty z aritmeto/logick
                            ych podprogramu
                      00150 ;                                       0x0AD - 0x0EF -> --------------------------- (67bytu)
                      00151 ;
                      00152 ;       BANK 2:         0x100 - 0x10F = specialni registry,
                      00153 ;                               0x110 - 0x16F = misto (96bytu) pro nase registry:
                      00154 ;                                       0x110 - 0x14F -> 64bytu BUFFER_2 (pro dlouhe nazvy souboru, tabu
                            lku oddilu, a treba pro cast fatky)
                      00155 ;                                       0x150 - 0x16F -> --------------------------- (32bytu)
                      00156 ;
                      00157 ;       BANK 3:         0x180 - 0x18F = specialni registry,
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE  5


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00158 ;                               0x190 - 0x1EF = misto (96bytu) pro nase registry:
                      00159 ;                                       0x190 - 0x1CF -> 64bytu BUFFER_1 (pro ruzna data pri cteni...)
                      00160 ;                                       0x1D0 - 0x1EF -> --------------------------- (32 bytu)
                      00161 
                      00162 ; prectena ci zapisovana data
  00000020            00163 DATA_L                  equ 0x020 ; res 1
  00000021            00164 DATA_H                  equ 0x021
                      00165 ; HODNOTY ATA REGISTRU 
  00000022            00166 ATA_STATUS_A    equ 0x022
  00000023            00167 DEVICE_C                equ 0x023
  00000024            00168 FEATURES                equ 0x024
  00000025            00169 ATA_ERROR               equ 0x025
  00000026            00170 SECTOR_C                equ 0x026
  00000027            00171 LBA1                    equ 0x027       ; alias  SECTOR_N
  00000028            00172 LBA2                    equ 0x028       ; alias  CILINDER_L
  00000029            00173 LBA3                    equ 0x029       ; alias  CILINDER_H
  0000002A            00174 LBA4                    equ 0x02a       ; toto neni registr ATA, ale pouze posledni cast aktualni adresy
  0000002B            00175 DEVICE                  equ 0x02b       ; alias  DEVICE_H
  0000002C            00176 ATA_STATUS              equ 0x02c
  0000002D            00177 COMMAND                 equ 0x02d
                      00178 ;**********************************************************
                      00179 ; BITY ATA REGISTRU
                      00180          ; ATA_STATUS register
  00000007            00181 BSY                             equ 7   ; = 1 -> disk je zaneprazdneny, ostatni registry nemusi obsahova
                            t pravdivou informaci
  00000006            00182 DRDY                    equ 6   ; = 1 -> disk ready (pripraven k praci)
  00000003            00183 DRQ                             equ 3   ; = 1 -> signalizuje, ze jsou pripravena data ke cteni 
  00000000            00184 ERR                             equ 0   ; = 1 -> pri provadeni posledniho prikazu doslo k chybe
                      00185          ; ATA_ERROR register
  00000002            00186 ABRT                    equ 2   ; = 1 -> prikaz aborted (spatny optkode prikazu)
                      00187          ; DEVICE_C (control) register
  00000002            00188 SRST                    equ 2   ; nastavime-li, provedeme soft. reset disku
  00000001            00189 nEIN                    equ 1   ; zakazuje preruseni disku (signal INTRQ)
  00000007            00190 HOB                             equ 7   ; tento bit DEVICE CONTROL se nastavuje pouze pokud disk podporu
                            je LBA 48 a cteme horni cast adresy LBA...
                      00191 ;**********************************************************
  0000002E            00192 ATA_ATTRIBUTES  equ 0x02e       ; Parametry hardisku. 
                      00193 ;Bity maji nasledujici vyznam:
  00000000            00194 ATA_OK                  equ 0   ; 0. bit = 1 -> disk je pritomen, zapnuty a funkcni :-)
  00000001            00195 LBA_SUPPORT             equ 1   ; 1. bit = 1 -> podpora LBA (pokud neni nastaven bit2, tak pouze LBA28 -
                            > disk do 120GB)
  00000002            00196 LBA48_SUPPORT   equ 2   ; 2. bit = 1 -> podpora LBA 48 (disk je zrejme vetsi jak 120GB)
  00000003            00197 BIG_SECTOR              equ 3   ; 3. bit = 1 -> velikost sektoru je vetsi nez 256 !!! (s takovym diskem 
                            zatim tento program neumi)
  00000004            00198 FAT32_LOAD              equ 4   ; 4. bit = 1 -> FATka byla uspesne analyzovana a udaje o ni jsou pravdiv
                            e
                      00199                                                 ; 5. bit  -> nepouzit
                      00200                                                 ; 6. bit  -> nepouzit (tyto tri bity treba pouziju pro v
                            lastnosti FATky)
  00000007            00201 APPLICABLE              equ 7   ; 7. bit = 1 -> disk je pro nas pouzitelny (LBA, sektor o 512B)
                      00202 
                      00203 
  0000002F            00204 PARAM_MAX_LBA1  equ 0x02F               ; [4B] maximalni hodnota LBA (velikost disku)   
  00000030            00205 PARAM_MAX_LBA2  equ 0x030               ; tady pozor, disky mohou byt adresovany az LBA 48, MBR je ale o
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE  6


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                            mezen na LBA 32 (2TB)
  00000031            00206 PARAM_MAX_LBA3  equ 0x031               ; tak by nemelo smysl vsech 48b kdyz by se nevyuzily. (Navic jse
                            m disk vetsi nez 2TB nevidel :)
  00000032            00207 PARAM_MAX_LBA4  equ 0x032               ; (registr s indexem 1 ma nejnizsi vahu)
                      00208 
  00000033            00209 PARAM_SLOV_V_SEKTORU1   equ 0x33 ; [2B] disky mohou mit velikost sektoru vetsi nez 512 (256sl) 
  00000034            00210 PARAM_SLOV_V_SEKTORU2   equ 0x34 
                      00211 ; pokud je to zapsano takto, nejvyznamejsi bity jsou niz v paneti (PARAM_MAX_LBA + X)
                      00212 ; pokud je zapsano jako skupina LBA1, LBA2, LBA3, LBA4, tak nejvyznamejsi bity jsou v LBA4
                      00213 ;**********************************************************
                      00214 ; pomocne registry pouzivane v podprogramech 
                      00215 ; !!! MUSIME ZAJISTIT ABY NEBYLY POUZIVANY VE VNORENYCH PODPROGRAMECH !!!
  00000035            00216 TEMPW                   equ 0x035
  00000036            00217 TEMP1                   equ 0x036
  00000037            00218 TEMP2                   equ 0x037
  00000038            00219 TEMP3                   equ 0x038
  00000039            00220 TEMP4                   equ 0x039
  0000003A            00221 TEMP5                   equ 0x03A
                      00222 
                      00223 ; !!! pomocne promenne pro spozdovaci smycky jsou na stejnych mistech
                      00224 ; pouzito pro synchronizaci s prog. picdelay
  00000036            00225 TMP1                    equ 0x036
  00000037            00226 TMP2                    equ 0x037
  00000038            00227 TMP0                    equ 0x038
                      00228 ;**********************************************************
                      00229 ; registry pro praci s FATkou
  0000003B            00230 POZICE                  equ 0x03B               ; na ukladani aktualni pozice v slusteru, pripadne jine 
                            kokotiny
  0000003C            00231 CLUSTER1                equ 0x03C
  0000003D            00232 CLUSTER2                equ 0x03D
  0000003E            00233 CLUSTER3                equ 0x03E
  0000003F            00234 CLUSTER4                equ 0x03F
                      00235 
  00000040            00236 POCATEK_DAT1    equ 0x040
  00000041            00237 POCATEK_DAT2    equ 0x041
  00000042            00238 POCATEK_DAT3    equ 0x042
  00000043            00239 POCATEK_DAT4    equ 0x043
                      00240 
  00000044            00241 POCATEK_FAT1    equ 0x044
  00000045            00242 POCATEK_FAT2    equ 0x045
  00000046            00243 POCATEK_FAT3    equ 0x046
  00000047            00244 POCATEK_FAT4    equ 0x047
                      00245 
  00000048            00246 ROOT_DIR_CL1    equ 0x048
  00000049            00247 ROOT_DIR_CL2    equ 0x049
  0000004A            00248 ROOT_DIR_CL3    equ 0x04A
  0000004B            00249 ROOT_DIR_CL4    equ 0x04B
                      00250 
  0000004C            00251 CLUSTER_SIZE    equ 0x04C               ; velikost clusteru (pocet sektoru na cluster)
                      00252 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00253 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00254 ; DEFINICE PROMENNYCH a KONSTANT PRO PRACI S VS1001
                      00255 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00256 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE  7


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00257 ; adresy registru VS1001
  00000000            00258 VSADDR_MODE                     equ .0          ; nastaveni VS1001
  00000001            00259 VSADDR_STATUS           equ .1          ; slouzi pouze pro zapnuti / vypnuti analogove casti (MUTE)
  00000003            00260 VSADDR_CLOCKF           equ .3          ; informuje dekoder o jeho krystalu. !! je nutne pro spravne dek
                            odovani !!
  00000004            00261 VSADDR_DECODE_TIME      equ .4          ; obsahuje cas dekodovani aktualni MP3 !! neaktualizuje se pri s
                            kocich (previjeni)
  00000005            00262 VSADDR_AUDATA           equ .5          ; obsahuje informace o datovem toku a vzorkovaci frekvenci MP3
                      00263         ; bit 15 = 1 => STEREO; = 0 => MONO
                      00264         ; bity 12-9 obsahuji vzorkovaci frekvenci v Hz
                      00265         ;       0000 -> neznama vzorkovaci frekvence
                      00266         ;       0001 -> 44 100
                      00267         ;       0010 -> 48 000
                      00268         ;       0011 -> 32 000
                      00269         ;       0100 -> 22 050
                      00270         ;       0101 -> 24 000 
                      00271         ;       0110 -> 16 000
                      00272         ;       0111 -> 11 025
                      00273         ;       1000 -> 12 000
                      00274         ;       1001 ->  8 000
                      00275         ; bity 8-0 obsahuji bitrate v kbps 
                      00276 
  00000006            00277 VSADDR_WRAM             equ .6                  ; Slouzi k zapisovani uzivatelskeho programu, dato se za
                            pise na adresu v WRAMADDR
  00000007            00278 VSADDR_WRAMADDR equ .7                  ; Adresuje uzivatelskou pamet dekoderu
  00000008            00279 VSADDR_HDAT0    equ .8                  ; Obsahuje informace ziskane z hlavicky MP3
  00000009            00280 VSADDR_HDAT1    equ .9                  ; Obsahuje informace ziskane z hlavicky MP3
  0000000A            00281 VSADDR_AIADDR   equ .10                 ; Start uzivatelskeho programu (vis. datasheet)
  0000000B            00282 VSADDR_VOL              equ .11                 ; ovladani hlasitosti (pro oba kanaly) Horni byte je lev
                            y kanal, dolni byte je pravy kanal
                      00283                                                                 ; (hodnota 0000h znamena hlasitost na ma
                            x., FF00h hraje pouze pravy kanal, FFFFh je ticho)
  0000000D            00284 VSADDR_AICTRL0  equ .13                 ; Registr pro ovladani uzivatelskeho programu
  0000000E            00285 VSADDR_AICTRL1  equ .14                 ; Registr pro ovladani uzivatelskeho programu
                      00286 ;**********************************************************
                      00287 ; registry pro praci s VS1001   
                      00288 ; dekoder VS1001 ma vsechny registry 16bitove, proto za jmeno pisu _L /_H (u nekterych registru potrebuj
                            i pouze jednu cast)
  0000004D            00289 VSREG_MODE_L    equ 0x04D
  0000004E            00290 VSREG_STATUS_L  equ 0x04E
  0000004F            00291 VSREG_VOL_L             equ 0x04F               ; pravy kanal
  00000050            00292 VSREG_VOL_H             equ 0x050               ; levy kanal
                      00293 ;                               equ 0x051
                      00294 ;                               equ 0x052
                      00295 ;                               equ 0x053
                      00296 ;                               equ 0x054
                      00297 ;                               equ 0x055
                      00298 ;                               equ 0x056
                      00299 ;                               equ 0x057
                      00300 ;                               equ 0x058
                      00301 ;**********************************************************
                      00302 ; registry pro ukladani nastaveni hledani
  00000059            00303 HL_PARAMETRY    equ 0x059
                      00304 ;               0. bit = 0 > pokud hledáme soubory, tak pouze MP3
;                              1 > pok
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE  8


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                            ud hledáme soubory, vrací všechny soubory
;             1. bit = 0 > hledáme klasicky (nejdøíve 
                      00305 ;               3. bit = 0 > hledáme podle èísla záznamu buï následující èi pøedchozí záznam
;          
                                             1 > hledáme první záznam v adresáøi
                      00306 ;               4. bit = 0 > hledáme NÁSLEDUJÍCÍ záznam
;                                1 > hledáme PØE
                            DCHOZÍ záznam
                      00307 ;               7. bit - tento bit nelze nastavit uzivatelem
                      00308 ;                               = 0 > adresar je ROOT
                      00309 ;                               = 1 > adresar neni ROOT
                      00310 
  0000005A            00311 HL_ADR_CL1              equ 0x05A
  0000005B            00312 HL_ADR_CL2              equ 0x05B
  0000005C            00313 HL_ADR_CL3              equ 0x05C
  0000005D            00314 HL_ADR_CL4              equ 0x05D       ; v jakem adresari momentalne vyhledavame
                      00315 
                      00316 ;HL_ZAZNAM1             equ 0x05E
                      00317 ;HL_ZAZNAM2             equ 0x05F       ; zaznamu v adresari podle nehoz hledame
                      00318 ;**********************************************************
                      00319 ; registry pro praci procedur v filesystem (dalsi registry pozivane proceduramy v filesystem jsou CLUSTE
                            R a POZICE)
  00000060            00320 ZAZNAM1                 equ 0x060
  00000061            00321 ZAZNAM2                 equ 0x061       ; poradi zaznamu v adresari
                      00322 ;**********************************************************
                      00323 ; informace potrebne pro prehravani
  00000062            00324 PREH_ADR_CL1            equ 0x062
  00000063            00325 PREH_ADR_CL2            equ 0x063
  00000064            00326 PREH_ADR_CL3            equ 0x064
  00000065            00327 PREH_ADR_CL4            equ 0x065       ; prni cluster adresare, ktery se prave prehrava...
                      00328 
  00000066            00329 PREH_ZAZNAM1            equ 0x066
  00000067            00330 PREH_ZAZNAM2            equ 0x067       ; poradi zaznamu v adresari ktery se zrovna prehrava (soubor mp3
                            )
                      00331 
  00000068            00332 PREH_CITAC_PREV         equ 0x068       ; pokud je mp3 previjena pomalu, sem se zapisuje kolik sektoru s
                            e jiz previnulo. 
                      00333                                                                 ; (Pøi pomalém pøevíjení je pomìr pøehra
                            ných sektorù ku pøeskoèeným 5:20.)
                      00334 
  00000069            00335 PREH_DATA_CL1           equ 0x069
  0000006A            00336 PREH_DATA_CL2           equ 0x06A
  0000006B            00337 PREH_DATA_CL3           equ 0x06B
  0000006C            00338 PREH_DATA_CL4           equ 0x06C       ; aktualni cluster, ktery se prehrava
  0000006D            00339 PREH_DATA_POZICE        equ 0x06D       ; sektor v clusteru, ktery se prehrava
                      00340 
  0000006E            00341 PREH_STAV0                      equ 0x06E       ; registr obsahuje informace o stavu aktualniho prehrava
                            ni
                      00342                                 ; 0. bit =      0 => stop nebo pausa (nic nehraje)
                      00343                                 ;                       1 => play            (nejaky soubor je prehravan
                            )
                      00344                                 ; 1. bit =      0 => neni zadny soubor k prehravani (nastaveni bitu play
                             nema zadny ucinek)
                      00345                                 ;                       1 => je soubor pripraven k prehravani (muze byt 
                            ale pauza - nic nehraje)
                      00346                                 ; 2. bit =      1 => je nastaven, kdyz se zmeni prehravany soubor (bez v
                            olani prikazu) do doby, nez prijde prikaz na dotaz STAVU... (81h)
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE  9


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00347                                 ; 3. bit =      0 => po skonceni souboru se pokracuje v prehravani (zavi
                            si na nastaveni repeatu)
                      00348                                 ;                       1 => po skonceni prehravani souboru se nic nepre
                            hrava (ceka se na prijeti prikazu k prehravani)
                      00349                                 ; 4. bit =      0 => repeat off
                      00350                                 ;                       1 => repeat on
                      00351                                 ; 5. bit =      0 => repeat adresare (prvni cluster adresare musi byt na
                            staven v PREH_ADDR_ZACATEK_CL[1-4] )
                      00352                                 ;                       1 => repeat souboru (po skonceni prehravani soub
                            oru se ten samy soubor zacne prehravat znova)
                      00353                                 ; 6. bit =      0 => 
                      00354                                 ;                       1 => rezervovano (pro nahodny vyber, nebo jiny r
                            ezim prehravani...)
                      00355                                 ; 7. bit =  0 => 
                      00356                                 ;                       1 => rezervovano
  0000006F            00357 PREH_STAV1                      equ 0x06F
                      00358                                 ; 0. bit =  0 => normalni prehravani
                      00359                                 ;                       1 => previjeni mp3 dopredu
                      00360                                 ; 1. bit =  0 => 
                      00361                                 ;                       1 => rezervovano (pro previjeni dozadu)
                      00362                                 ; 2. bit =      zpusob previjeni,       0 => previji se rychle, potichu
                      00363                                 ;                                                               1 => pre
                            viji se pomalu, vzdy se po nejake dobe kratky usek souboru prehraje
                      00364                                 ; 3. bit =      0 => normalni nastaveni zvuku
                      00365                                 ;                       1 => zvyrazneni basu a vysek (moznost dekoderu v
                            s1001 "bass/treble enhancer")
                      00366                                 ; 4. bit =      0 => NO MUTE
                      00367                                 ;                       1 => MUTE
                      00368                                 ; 5., 6., 7. bit 
                      00369                                 ;                       => rezervovano
                      00370 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00371 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00372 ; registry pro potreby preruseni + prace s prikazy (jsou totiz dostupne odkudkoliv)
  00000070            00373 TEMP_WORKING    equ 0x070
  00000071            00374 TEMP_STATUS             equ 0x071
  00000072            00375 TEMP_FSR                equ 0x072
  00000073            00376 PRIJATYCH_DAT   equ 0x073               ; ukazuje kolik je platnych dat v zasobniku prikazu (0 -> zasobn
                            ik je prazdny)
  00000074            00377 PRIJATE_DATO    equ 0x074               ; pomocna promenna v preruseni
  00000075            00378 STAV_PRIKAZU    equ 0x075               ; pomocny registr signalizujici stav prikazu umisteneho v zasobn
                            iku prikazu
                      00379                                                                 ; pokud zadna procedura nenastavi do 1, 
                            je prikaz v tuto chvili neplatny
                      00380                                                                 ; pokud prikaz je pro proceduru ale nama
                             zatim dost parametru, muji tento byt nastavit take do 1
  00000076            00381 TEMP_PCLATH             equ 0x076
                      00382 ; 0x078 - 0x07F         -> zasobnik prikazu (data prisla po USARTU)
                      00383 ;**********************************************************
                      00384 ; BANK_1        s touto bankou pracuji procedury provadejici 32 bitove 
                      00385 ;                       aritmeto/logicke operace
  000000A0            00386 OPERAND_X1              equ 0x0A0
  000000A1            00387 OPERAND_X2              equ 0x0A1
  000000A2            00388 OPERAND_X3              equ 0x0A2
  000000A3            00389 OPERAND_X4              equ 0x0A3
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 10


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00390 
  000000A4            00391 OPERAND_Y1              equ 0x0A4
  000000A5            00392 OPERAND_Y2              equ 0x0A5
  000000A6            00393 OPERAND_Y3              equ 0x0A6
  000000A7            00394 OPERAND_Y4              equ 0x0A7
                      00395 
  000000A8            00396 VYSLEDEK1               equ 0x0A8
  000000A9            00397 VYSLEDEK2               equ 0x0A9
  000000AA            00398 VYSLEDEK3               equ 0x0AA
  000000AB            00399 VYSLEDEK4               equ 0x0AB
                      00400 
  000000AC            00401 PRETECENI               equ 0x0AC
                      00402 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00403 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00404 ; MAKRA
                      00405 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00406 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00407 BANK_0  macro                                   ; prepnuti do banky 0 v pameti dat
                      00408                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
                      00409                 bcf     STATUS,RP0    
                      00410                 endm
                      00411 BANK_1  macro                                   ; prepnuti do banky 1 v pameti dat
                      00412                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
                      00413                 bsf     STATUS,RP0    
                      00414                 endm
                      00415 BANK_2  macro                                   ; prepnuti do banky 2 v pameti dat
                      00416                 bsf     STATUS,RP1              ; BANK2  RP1:RP0 = 10
                      00417                 bcf     STATUS,RP0    
                      00418                 endm
                      00419 BANK_3  macro                                   ; prepnuti do banky 3 v pameti dat
                      00420                 bsf     STATUS,RP1              ; BANK3  RP1:RP0 = 11
                      00421                 bsf     STATUS,RP0    
                      00422                 endm
                      00423 ; INDF_BANK_x slouzi k prepinani bank pro neprime adresovani pomoci INDF a FSR
                      00424 INDF_BANK_0     macro               
                      00425                         bcf STATUS,IRP    
                      00426                         endm
                      00427 INDF_BANK_1     macro               
                      00428                         bcf STATUS,IRP    
                      00429                         endm
                      00430 INDF_BANK_2     macro             
                      00431                         bsf STATUS,IRP    
                      00432                         endm
                      00433 INDF_BANK_3     macro             
                      00434                         bsf STATUS,IRP    
                      00435                         endm
                      00436 ;**********************************************************
                      00437 PROG_PAGE_0     macro             
                      00438                         bcf PCLATH,3
                      00439                         bcf PCLATH,4
                      00440                         endm
                      00441 PROG_PAGE_1     macro             
                      00442                         bsf PCLATH,3
                      00443                         bcf PCLATH,4
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 11


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00444                         endm
                      00445 PROG_PAGE_2     macro             
                      00446                         bcf PCLATH,3
                      00447                         bsf PCLATH,4
                      00448                         endm
                      00449 PROG_PAGE_3     macro             
                      00450                         bsf PCLATH,3
                      00451                         bsf PCLATH,4
                      00452                         endm
                      00453 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00044 
                      00045 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00046 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00047 ; PROGRAM
                      00048 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00049 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00050 ;**********************************************************
0000                  00051  org 0x0000                                     ; PAGE 0
0000   2810           00052         goto START
0004                  00053  org 0x0004                                     ; PAGE 0
0004   00F0           00054         movwf TEMP_WORKING
0005   0803           00055         movfw STATUS
0006   00F1           00056         movwf TEMP_STATUS
0007   0804           00057         movfw FSR
0008   00F2           00058         movwf TEMP_FSR
0009   080A           00059         movfw PCLATH
000A   00F6           00060         movwf TEMP_PCLATH
000B   018A           00061         clrf PCLATH
                      00062         BANK_0
000C   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
000D   1283               M                 bcf     STATUS,RP0    
                      00063         INDF_BANK_0
000E   1383               M                         bcf STATUS,IRP    
000F   2992           00064         goto INTERRUPT
                      00065 ;**********************************************************
0010                  00066  org 0x0010                                     ; PAGE 0
                      00067         include "mp3.asm"               ; hlavni programova smycka
0010                  00001 START
0010   2137           00002         call INIT_CONFIG        ; nakonfiguruje preruseni, WDT, USART, pull ups...
0011   2124           00003         call INIT_PORT          ; nastavy trisy, a porty do vychozi polohy
                      00004 
0012   2324           00005         call DELAY_25us         ; chvili pockame, protoze napjeti zdroje co mam doma (stary PC-AT zdroj)
0013   2324           00006         call DELAY_25us         ; zezacatku dost kolisa...
0014   2324           00007         call DELAY_25us
                      00008 
0015   215A           00009         call POZDRAV                            ; abych se u kompu nenudil
                      00010 
                      00011 #IF VS1001==1
                      00012         PROG_PAGE_1
0016   158A               M                         bsf PCLATH,3
0017   120A               M                         bcf PCLATH,4
0018   20CE           00013         call VS_INIT
                      00014         PROG_PAGE_0
0019   118A               M                         bcf PCLATH,3
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 12


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

001A   120A               M                         bcf PCLATH,4
                      00015 #ENDIF
                      00016 
001B   227E           00017         call ATA_RESET                          ; resetujeme disk, koukneme zda tu nejakej mame
001C   1C2E           00018         btfss ATA_ATTRIBUTES,ATA_OK
001D   281B           00019         goto $-2                                        ; pokud neni pripojen disk, tak se jej pokousime
                             neustale najit...
001E   0000           00020         nop                                                     ; ...pokud tam zadny disk neni, tak bych
                            om se stejne ani sem nemeli dostat, protoze budem porad cekat na WAIT_FOR_READY
                      00021 
001F   22D1           00022         call IDENTIFY_DEVICE            ; koukneme co disk umi
                      00023 
0020                  00024 CEK_PRIKAZ_01h
                      00025         PROG_PAGE_1
0020   158A               M                         bsf PCLATH,3
0021   120A               M                         bcf PCLATH,4
0022   20DD           00026         call CEKEJ_PRIKAZ
                      00027         PROG_PAGE_0
0023   118A               M                         bcf PCLATH,3
0024   120A               M                         bcf PCLATH,4
                      00028 
                      00029 
0025   0878           00030         movfw 0x078                                     ; prvni byte prikazoveho zasobniku
0026   01F3           00031         clrf PRIJATYCH_DAT                      ; prikaz byl vybran -> prazdny zasobnik
0027   3C01           00032         sublw h'01'                                     ; ...pokud to byl prikaz 01h...
0028   1D03           00033         btfss STATUS,Z
0029   2820           00034         goto CEK_PRIKAZ_01h
                      00035 
002A   082E           00036         movfw ATA_ATTRIBUTES            ; ...vodesleme zpet vlastnosti disku a jeho jmenovku (vis. popis
                             protokolu)
002B   2152           00037         call WR_USART
002C   216D           00038         call ODESLI_MODEL_NUMBER        ; odesleme jmeno disku 
                      00039 
002D   232F           00040         call SCAN_MBR                           ; najdeme oddily s FAT32 a jejich seznam dame do bufferu
                             2
002E                  00041 CEK_PRIKAZ_02h_03h
                      00042         PROG_PAGE_1
002E   158A               M                         bsf PCLATH,3
002F   120A               M                         bcf PCLATH,4
0030   20DD           00043         call CEKEJ_PRIKAZ                       ; pockame si na prikaz
0031   01F5           00044         clrf STAV_PRIKAZU                       ; smazeme registr signalizujici platnost prikazu
0032   20E2           00045         call PRIKAZ_02h                         ; testujeme zda prisel prikaz 02h, pokud ano tak jej pro
                            vedeme a nastavime platnost prikazu
0033   2103           00046         call PRIKAZ_03h                         ; ---//---
                      00047         PROG_PAGE_0
0034   118A               M                         bcf PCLATH,3
0035   120A               M                         bcf PCLATH,4
0036   1C75           00048         btfss STAV_PRIKAZU,0            ; Pokud si zadna z procedur prikaz neprevzala, ...
0037   01F3           00049         clrf PRIJATYCH_DAT                      ; ...vymazeme zasobnik prikazu. (prikaz neni pro tuto ch
                            vili platny)
0038   1E2E           00050         btfss ATA_ATTRIBUTES,FAT32_LOAD ; cekame dokud nedojde k nasteni nejakeho oddilu
0039   282E           00051         goto CEK_PRIKAZ_02h_03h         ; pokud byl oddil vporadku nacten, pokracujeme...
                      00052 
003A   01EE           00053         clrf PREH_STAV0
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 13


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00054 ;*******************************************************************************************************
                            *************
                      00055 ;*******************************************************************************************************
                            *************
                      00056 ;*******************************************************************************************************
                            *************
                      00057 ;*******************************************************************************************************
                            *************
003B                  00058 BIG_LOOP
                      00059         ; Tady ta smycka beha po nacteni disku a nejake FATky porad dokola.
                      00060         ; Pri kazdem prubehu smyckou vyresime prikazy, ktere prisly, a pokud prehravame 
                      00061         ; nejakou mp3 tak dekoder nakrmime jednim sektorem...
                      00062         ; Mimo to musime v teto smycce osefovat, ze kdyz skonci mp3, nacteme dalsi...
003B   0873           00063         movfw PRIJATYCH_DAT
003C   39FF           00064         andlw h'FF'
003D   1903           00065         btfsc STATUS,Z
003E   2851           00066         goto BIG_LOOP__NENI_PRIKAZ
                      00067         
003F   01F5           00068         clrf STAV_PRIKAZU                       ; smazeme registr signalizujici platnost prikazu
                      00069         ; Pokud jsme tady, tak prisel nejaky prikaz, jdem predat prikaz jednotlivym proceduram
                      00070         PROG_PAGE_1
0040   158A               M                         bsf PCLATH,3
0041   120A               M                         bcf PCLATH,4
0042   2121           00071         call PRIKAZ_04h                         ; testujeme zda prisel prikaz 04h, pokud ano tak jej pro
                            vedeme a nastavime platnost prikazu
0043   212E           00072         call PRIKAZ_05h                         ; --- // ---
0044   215F           00073         call PRIKAZ_06h                         ; --- // ---
0045   2181           00074         call PRIKAZ_07h                         ; --- // ---
0046   21A8           00075         call PRIKAZ_08h                         ; --- // ---
0047   21D6           00076         call PRIKAZ_09h                         ; --- // ---
                      00077 
0048   2209           00078         call PRIKAZ_80h                         ; --- // ---
0049   2268           00079         call PRIKAZ_81h                         ; --- // ---
004A   2287           00080         call PRIKAZ_82h                         ; --- // ---
004B   229D           00081         call PRIKAZ_83h                         ; --- // ---
004C   22D1           00082         call PRIKAZ_84h                         ; --- // ---
                      00083         PROG_PAGE_0
004D   118A               M                         bcf PCLATH,3
004E   120A               M                         bcf PCLATH,4
                      00084         
004F   1C75           00085         btfss STAV_PRIKAZU,0            ; Pokud si zadna z procedur prikaz neprevzala, ...
0050   01F3           00086         clrf PRIJATYCH_DAT                      ; ...vymazeme zasobnik prikazu. (prikaz neni pro tuto ch
                            vili platny)
                      00087 
0051                  00088 BIG_LOOP__NENI_PRIKAZ
                      00089 
                      00090 #IF VS1001==1                                   ; pokud mame pripojen dekoder,...
0051   1C6E           00091         btfss PREH_STAV0,0                      ; ...je zvoleno play,...
0052   28AF           00092         goto MP3_NOT_PLAY
                      00093 
0053   1CEE           00094         btfss PREH_STAV0,1                      ; ...a je co prehravat...
0054   28AF           00095         goto MP3_NOT_PLAY
                      00096         
0055   086D           00097         movfw PREH_DATA_POZICE
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 14


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0056   024C           00098         subwf CLUSTER_SIZE,W
0057   1D03           00099         btfss STATUS,Z                          ; ...podivame se zda jiz nejsme na konci clusteru...
0058   2872           00100         goto SEND_MP3_DATA
                      00101 
0059   0869           00102         movfw PREH_DATA_CL1                     ; ...pokud jo, tak si najdeme dalsi cluster v retezci.
005A   00BC           00103         movwf CLUSTER1
005B   086A           00104         movfw PREH_DATA_CL2
005C   00BD           00105         movwf CLUSTER2
005D   086B           00106         movfw PREH_DATA_CL3
005E   00BE           00107         movwf CLUSTER3
005F   086C           00108         movfw PREH_DATA_CL4
0060   00BF           00109         movwf CLUSTER4
                      00110 
0061   01ED           00111         clrf PREH_DATA_POZICE
0062   2519           00112         call NEXT_CLUSTER
0063   083C           00113         movfw CLUSTER1
0064   00E9           00114         movwf PREH_DATA_CL1
0065   083D           00115         movfw CLUSTER2
0066   00EA           00116         movwf PREH_DATA_CL2
0067   083E           00117         movfw CLUSTER3
0068   00EB           00118         movwf PREH_DATA_CL3
0069   083F           00119         movfw CLUSTER4
006A   00EC           00120         movwf PREH_DATA_CL4
                      00121         
006B   1C3B           00122         btfss POZICE,0                          ; Pokud byl cluster posledni v retezci...
006C   2872           00123         goto SEND_MP3_DATA
                      00124 
006D   20B0           00125         call DALSI_SKLADBA                      ; ...tak najdeme dalsi soubor co se ma prehrat (pokud je
                             nastaven repeat a dalsi kraviny)
                      00126         ; otestujeme zda se ma nejaka dalsi mp3 prehravat
006E   1C6E           00127         btfss PREH_STAV0,0                      ; Je zvoleno play?
006F   28AF           00128         goto MP3_NOT_PLAY
0070   1CEE           00129         btfss PREH_STAV0,1                      ; Je co prehravat?
0071   28AF           00130         goto MP3_NOT_PLAY
                      00131 
0072                  00132 SEND_MP3_DATA
0072   1C6F           00133         btfss PREH_STAV1,0                      ; 0. bit = 1 => previjeni mp3 dopredu
0073   288D           00134         goto NOT_MP3_REWIND_FORWARD
0074   14CD           00135         bsf VSREG_MODE_L,1                      ; fast forward on
                      00136 
0075   1D6F           00137         btfss PREH_STAV1,2                      ; 2. bit = 1 => previji se pomalu, vzdy se po nejake dob
                            e kratky usek souboru prehraje  
0076   2881           00138         goto MP3_REWIND_FORWARD
                      00139 
0077   0868           00140         movfw PREH_CITAC_PREV           ; MP3 previjime pomalu...
0078   3C14           00141         sublw .20                                       ; ...podivame se kolik sektoru jsme previnuly...
0079   1803           00142         btfsc STATUS,C                          ; ...pokud jich je vic jak 20...
007A   2881           00143         goto MP3_REWIND_FORWARD         ; 
                      00144         
007B   10CD           00145         bcf VSREG_MODE_L,1                      ; ...tak dalsi pustime normalne. (fast forward off)
                      00146 
007C   0868           00147         movfw PREH_CITAC_PREV
007D   3C19           00148         sublw .25
007E   1D03           00149         btfss STATUS,Z                          ; pokud jsme jich uz normalne pustily 5, ... (25-20)
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 15


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

007F   2881           00150         goto MP3_REWIND_FORWARD
                      00151 
0080   01E8           00152         clrf PREH_CITAC_PREV            ; ...vymazeme citac previjeni (zas nejaky sektory pustime rychle
                            )
0081                  00153 MP3_REWIND_FORWARD
0081   3000           00154         movlw VSADDR_MODE
0082   00B6           00155         movwf TEMP1
0083   084D           00156         movfw VSREG_MODE_L
0084   00B7           00157         movwf TEMP2
0085   01B8           00158         clrf TEMP3
                      00159         PROG_PAGE_1     
0086   158A               M                         bsf PCLATH,3
0087   120A               M                         bcf PCLATH,4
0088   2063           00160         call VS_WR_REG
                      00161         PROG_PAGE_0
0089   118A               M                         bcf PCLATH,3
008A   120A               M                         bcf PCLATH,4
                      00162         
008B   196F           00163         btfsc PREH_STAV1,2                      ; 2. bit = 1 => previji se pomalu, vzdy se po nejake dob
                            e kratky usek souboru prehraje  
008C   0AE8           00164         incf PREH_CITAC_PREV,f
008D                  00165 NOT_MP3_REWIND_FORWARD
                      00166 
008D   0869           00167         movfw PREH_DATA_CL1                     ; Mame zjisteny cluster a jeho cast, kterou mame prehrav
                            at...
008E   00BC           00168         movwf CLUSTER1
008F   086A           00169         movfw PREH_DATA_CL2
0090   00BD           00170         movwf CLUSTER2
0091   086B           00171         movfw PREH_DATA_CL3
0092   00BE           00172         movwf CLUSTER3
0093   086C           00173         movfw PREH_DATA_CL4
0094   00BF           00174         movwf CLUSTER4
0095   086D           00175         movfw PREH_DATA_POZICE
0096   00BB           00176         movwf POZICE
                      00177 
0097   24B6           00178         call CLUSTER_TO_LBA                     ; zjistime si skutecnou polohu dat na disku...
0098   3001           00179         movlw .1
0099   00A6           00180         movwf SECTOR_C
009A   2299           00181         call READ_SECTOR                        ; dame prikaz precist data...
                      00182 
009B   1585           00183         bsf MP3_CS                                      ; po SI posilam data
009C   3000           00184         movlw .0                                        ; posilame celkem 256 slov
009D   00B6           00185         movwf TEMP1             
009E                  00186 SEND_MP3_WORD
                      00187         PROG_PAGE_1
009E   158A               M                         bsf PCLATH,3
009F   120A               M                         bcf PCLATH,4
00A0   20A5           00188         call WAIT_FOR_VSDREQ
                      00189         PROG_PAGE_0
00A1   118A               M                         bcf PCLATH,3
00A2   120A               M                         bcf PCLATH,4
00A3   2241           00190         call READ_DATA
00A4   0820           00191         movfw DATA_L
                      00192         PROG_PAGE_1
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 16


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

00A5   158A               M                         bsf PCLATH,3
00A6   120A               M                         bcf PCLATH,4
00A7   2000           00193         call VS_WR_BYTE
00A8   0821           00194         movfw DATA_H
00A9   2000           00195         call VS_WR_BYTE
                      00196         PROG_PAGE_0
00AA   118A               M                         bcf PCLATH,3
00AB   120A               M                         bcf PCLATH,4
00AC   0BB6           00197         decfsz TEMP1,f  
00AD   289E           00198         goto SEND_MP3_WORD
                      00199 
00AE   0AED           00200         incf PREH_DATA_POZICE,f
00AF                  00201 MP3_NOT_PLAY
                      00202 #ENDIF
                      00203 
00AF   283B           00204         goto BIG_LOOP
                      00205 ;*******************************************************************************************************
                            *************
                      00206 ;*******************************************************************************************************
                            *************
                      00207 ;*******************************************************************************************************
                            *************
                      00208 ;*******************************************************************************************************
                            *************
00B0                  00209 DALSI_SKLADBA
                      00210         ; tato procedura je volana, kdyz skonci mp3, aby nasla v adresari dalsi mp3 ktera se ma prehrava
                            t...
00B0   106E           00211         bcf PREH_STAV0,0                ; 0. bit =      0 => stop nebo pausa (nic nehraje)
00B1   10EE           00212         bcf PREH_STAV0,1                ; 1. bit =      0 => neni zadny soubor k prehravani (nastaveni b
                            itu play nema zadny ucinek)
00B2   116E           00213         bcf PREH_STAV0,2                ; 2. bit =      1 => je nastaven, kdyz se zmeni prehravany soubo
                            r (bez volani prikazu) do doby, nez prijde prikaz na dotaz STAVU... (81h)
00B3   106F           00214         bcf PREH_STAV1,0                ; 0. bit =  0 => normalni prehravani (mp3 se nepreviji)
00B4   19EE           00215         btfsc PREH_STAV0,3              ; 3. bit =      0 => po skonceni souboru se pokracuje v prehrava
                            ni (zavisi na nastaveni repeatu)
00B5   0008           00216         return
                      00217 
                      00218 ; PREH_STAV0
                      00219 ;       4. bit =        0 => repeat off
                      00220 ;                               1 => repeat on
                      00221 ;       5. bit =        0 => repeat adresare (prvni cluster adresare musi byt nastaven v PREH_ADDR_ZACAT
                            EK_CL[1-4] )
                      00222 ;                               1 => repeat souboru (po skonceni prehravani souboru se ten samy soubor z
                            acne prehravat znova)
00B6   1E6E           00223         btfss PREH_STAV0,4
00B7   28E1           00224         goto DALSI_SKLADBA_NO_R_S
00B8   1EEE           00225         btfss PREH_STAV0,5
00B9   28E1           00226         goto DALSI_SKLADBA_NO_R_S       
00BA                  00227 DALSI_SKLADBA_REPAT_SOUBORU
00BA   0862           00228         movfw PREH_ADR_CL1
00BB   00BC           00229         movwf CLUSTER1
00BC   0863           00230         movfw PREH_ADR_CL2
00BD   00BD           00231         movwf CLUSTER2
00BE   0864           00232         movfw PREH_ADR_CL3
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 17


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

00BF   00BE           00233         movwf CLUSTER3
00C0   0865           00234         movfw PREH_ADR_CL4
00C1   00BF           00235         movwf CLUSTER4
00C2   0866           00236         movfw PREH_ZAZNAM1
00C3   00E0           00237         movwf ZAZNAM1
00C4   0867           00238         movfw PREH_ZAZNAM2
00C5   00E1           00239         movwf ZAZNAM2
                      00240 
                      00241         PROG_PAGE_1
00C6   158A               M                         bsf PCLATH,3
00C7   120A               M                         bcf PCLATH,4
00C8   233D           00242         call SKOC_NA_ZAZNAM
                      00243         PROG_PAGE_0
00C9   118A               M                         bcf PCLATH,3
00CA   120A               M                         bcf PCLATH,4
00CB   183B           00244         btfsc POZICE,0                          ; tento test by tu byt nemusel, protoze jsme jiz tento s
                            oubor hrali, jeden ale nikdy nevi...
00CC   0008           00245         return
                      00246         PROG_PAGE_1
00CD   158A               M                         bsf PCLATH,3
00CE   120A               M                         bcf PCLATH,4
00CF   23B4           00247         call FILE_INFO
                      00248         PROG_PAGE_0
00D0   118A               M                         bcf PCLATH,3
00D1   120A               M                         bcf PCLATH,4
                      00249 
                      00250         INDF_BANK_2
00D2   1783               M                         bsf STATUS,IRP    
                      00251         ; ...nastavime jej jako prehravany soubor.
00D3   301C           00252         movlw 0x1C                                      ; 13. byte bufferu 2
00D4   0084           00253         movwf FSR
00D5   0800           00254         movfw INDF
00D6   00E9           00255         movwf PREH_DATA_CL1
00D7   0A84           00256         incf FSR,f
00D8   0800           00257         movfw INDF
00D9   00EA           00258         movwf PREH_DATA_CL2
00DA   0A84           00259         incf FSR,f
00DB   0800           00260         movfw INDF
00DC   00EB           00261         movwf PREH_DATA_CL3
00DD   0A84           00262         incf FSR,f
00DE   0800           00263         movfw INDF
00DF   00EC           00264         movwf PREH_DATA_CL4
00E0   2912           00265         goto DALSI_SKLADBA_PLAY         ; nic jineho nemusime nastavovat, protoze hrajeme ten samy soubo
                            r co predtim
00E1                  00266 DALSI_SKLADBA_NO_R_S
                      00267 ; PREH_STAV0
                      00268 ;       4. bit =        0 => repeat off
                      00269 ;                               1 => repeat on
                      00270 ;       5. bit =        0 => repeat adresare (prvni cluster adresare musi byt nastaven v PREH_ADDR_ZACAT
                            EK_CL[1-4] )
                      00271 ;                               1 => repeat souboru (po skonceni prehravani souboru se ten samy soubor z
                            acne prehravat znova)
                      00272         ; tak ted jdem hledat dalsi soubor v adresari...
                      00273         
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 18


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00274 ;       HL_PARAMETRY    -- parametry hledani
                      00275 ;       HL_ADR_CL[1-4]  -- prnvi cluster prohledavaneho adresare
                      00276 ;       ZAZNAM[1-2]             -- zaznam od ktereho hledame
00E1   3006           00277         movlw b'00000110'
00E2   00D9           00278         movwf HL_PARAMETRY
00E3   0862           00279         movfw PREH_ADR_CL1
00E4   00DA           00280         movwf HL_ADR_CL1
00E5   0863           00281         movfw PREH_ADR_CL2
00E6   00DB           00282         movwf HL_ADR_CL2
00E7   0864           00283         movfw PREH_ADR_CL3
00E8   00DC           00284         movwf HL_ADR_CL3
00E9   0865           00285         movfw PREH_ADR_CL4
00EA   00DD           00286         movwf HL_ADR_CL4
00EB   0866           00287         movfw PREH_ZAZNAM1
00EC   00E0           00288         movwf ZAZNAM1
00ED   0867           00289         movfw PREH_ZAZNAM2
00EE   00E1           00290         movwf ZAZNAM2
                      00291         
                      00292         PROG_PAGE_1
00EF   158A               M                         bsf PCLATH,3
00F0   120A               M                         bcf PCLATH,4
00F1   243D           00293         call HLEDEJ
                      00294         PROG_PAGE_0     
00F2   118A               M                         bcf PCLATH,3
00F3   120A               M                         bcf PCLATH,4
                      00295 
                      00296         INDF_BANK_2
00F4   1783               M                         bsf STATUS,IRP    
00F5   3030           00297         movlw 0x30
00F6   0084           00298         movwf FSR
00F7   0800           00299         movfw INDF
00F8   3C06           00300         sublw h'06'
00F9   1903           00301         btfsc STATUS,Z
00FA   28FE           00302         goto DALSI_SKLADBA_MAME_SOUBOR
                      00303 
                      00304         ; zadny dalsi mp3 soubor v adresari neni...
00FB   1E6E           00305         btfss PREH_STAV0,4                              ; ..podivame se, zda neni nastaven repeat slozky
00FC   0008           00306         return
                      00307 
                      00308         ; je nastaven repeat slozky a uz neni co prehravat. Jdem hledat prvni mp3 ve slozce...
00FD   0008           00309         return
                      00310 
00FE                  00311 DALSI_SKLADBA_MAME_SOUBOR
                      00312         INDF_BANK_2
00FE   1783               M                         bsf STATUS,IRP    
00FF   303C           00313         movlw 0x3C
0100   0084           00314         movwf FSR
0101   0800           00315         movfw INDF
0102   00E9           00316         movwf PREH_DATA_CL1
0103   0A84           00317         incf FSR,f
0104   0800           00318         movfw INDF
0105   00EA           00319         movwf PREH_DATA_CL2
0106   0A84           00320         incf FSR,f
0107   0800           00321         movfw INDF
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 19


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0108   00EB           00322         movwf PREH_DATA_CL3
0109   0A84           00323         incf FSR,f
010A   0800           00324         movfw INDF
010B   00EC           00325         movwf PREH_DATA_CL4
010C   0A84           00326         incf FSR,f
010D   0800           00327         movfw INDF
010E   00E6           00328         movwf PREH_ZAZNAM1
010F   0A84           00329         incf FSR,f
0110   0800           00330         movfw INDF
0111   00E7           00331         movwf PREH_ZAZNAM2
                      00332 
0112                  00333 DALSI_SKLADBA_PLAY
0112   01ED           00334         clrf PREH_DATA_POZICE
0113   146E           00335         bsf PREH_STAV0,0
0114   14EE           00336         bsf PREH_STAV0,1                        ; nastavime si vlastosti prehravani: (PREH_STAV[0-1])
0115   156E           00337         bsf PREH_STAV0,2
                      00338 
                      00339         PROG_PAGE_1
0116   158A               M                         bsf PCLATH,3
0117   120A               M                         bcf PCLATH,4
0118   2079           00340         call VS_SOFT_RESET
                      00341 
0119   10CD           00342         bcf VSREG_MODE_L,1                      ; prehravame normalni rychlosti 
011A   106F           00343         bcf PREH_STAV1,0                        ; prehravame normalni rychlosti 
                      00344         
011B   3000           00345         movlw VSADDR_MODE
011C   00B6           00346         movwf TEMP1
011D   084D           00347         movfw VSREG_MODE_L
011E   00B7           00348         movwf TEMP2
011F   01B8           00349         clrf TEMP3
0120   2063           00350         call VS_WR_REG
                      00351         PROG_PAGE_0
0121   118A               M                         bcf PCLATH,3
0122   120A               M                         bcf PCLATH,4
                      00352         
0123   0008           00353         return
                      00354 ;*******************************************************************************************************
                            *************
0124                  00355 INIT_PORT
                      00356         BANK_1
0124   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0125   1683               M                 bsf     STATUS,RP0    
                      00357 
                      00358 #IF VS1001==1
0126   3011           00359         movlw b'00010001'                       ; bity SO a DREQ jako vstupy (signaly z dekoderu)
                      00360 #ELSE
                      00361         movlw 0xff
                      00362 #ENDIF
                      00363 
0127   0085           00364         movwf MP3_PORT_TRIS
0128   3080           00365         movlw b'10000000'                       ; adresovani disku jako vystupy
0129   0087           00366         movwf ATA_ADDRESS_TRIS          
012A   3000           00367         movlw .0
012B   0089           00368         movwf ATA_CONTROL_TRIS          ; ovladani disku jako vystupy
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 20


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

012C   30FF           00369         movlw 0xff
012D   0086           00370         movwf DATA_PORT_LOW_TRIS        ; datovou sbernici jako vstupy
012E   0088           00371         movwf DATA_PORT_HIGH_TRIS       
                      00372         BANK_0
012F   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0130   1283               M                 bcf     STATUS,RP0    
                      00373         
0131   3007           00374         movlw b'00000111'       ; signal reset-, diow- a dior- jsou aktivni v log. 0 !!!
0132   0089           00375         movwf ATA_CONTROL
0133   3037           00376         movlw b'00110111'       ; CS1-, CS0- = 1 => datova sbernice disku je odpojena
0134   0087           00377         movwf ATA_ADDRESS
0135   0185           00378         clrf MP3_PORT   
0136   0008           00379         return
                      00380 ;**********************************************************
0137                  00381 INIT_CONFIG     ; nakonfiguruje preruseni, WDT, USART, pull ups....
                      00382         BANK_1
0137   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0138   1683               M                 bsf     STATUS,RP0    
0139   30C7           00383         movlw b'11000111'       ; ...pull up a podobny koniny
                      00384                 ; PORTB Pull-up Enable bit              1 = pull up enabled
                      00385                 ; Interrupt Edge Select bit             1 = interrupt on rising edge of RB0/INT pin
                      00386                 ; TMR0 Clock Source Select bit  0 = Internal instruction cycle clock (CLKO)
                      00387                 ; TMR0 Source Edge Select bit   0 = Increment on low-to-high transition on RA4/T0CKI pin
                      00388                 ; Prescaler Assignment bit              0 = Prescaler is assigned to the Timer0 module
                      00389                 ; PS2:PS0: Prescaler Rate Select bits   111 = TMR0 Rate 1 : 256; WDT Rate 1 : 128
013A   0081           00390         movwf OPTION_REG
                      00391         
013B   3020           00392         movlw b'00100000'       ; povolime preruseni od USARTu (kdyz neco dostanem)
013C   008C           00393         movwf PIE1      
013D   3000           00394         movlw b'00000000'       ; ostatni vnejsi preruseni vymaskujeme
013E   008D           00395         movwf PIE2                      
                      00396 
013F   30C0           00397         movlw b'11000000'       ; povolime preruseni na vnejsi zarizeni (USART)                         
0140   008B           00398         movwf INTCON
                      00399 
0141   3026           00400         movlw b'00100110'       ;konfigurace USARTu (asynchronni, 8bit, bez parity, rychle - (BRGH = 1))
0142   0098           00401         movwf TXSTA
                      00402         BANK_0
0143   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0144   1283               M                 bcf     STATUS,RP0    
0145   3090           00403         movlw b'10010000'       ;zapnu USART
0146   0098           00404         movwf RCSTA
                      00405         BANK_1
0147   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0148   1683               M                 bsf     STATUS,RP0    
                      00406         ;movlw .129             ; Fosc = 20 MHz, BRGH=1 => rychlost = 9615 bps
0149   3067           00407         movlw .103                      ; Fosc = 16 MHz, BRGH=1 => rychlost = 9615 bps
014A   0099           00408         movwf SPBRG     
                      00409 
014B   3007           00410         movlw b'00000111'
014C   009F           00411         movwf ADCON1            ; vsechny vstupy (RA,RE) jako digitalni
                      00412         BANK_0  
014D   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
014E   1283               M                 bcf     STATUS,RP0    
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 21


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

014F   019F           00413         clrf ADCON0                     ; pro jistotu (vypneme A/D prevodniky)
                      00414 
0150   01F3           00415         clrf PRIJATYCH_DAT      ; zasobnik prikazu prazdny...
0151   0008           00416         return
                      00417 ;**********************************************************
0152                  00418 WR_USART        ; odesle slovo ve workingu po USARTu
                      00419                         ; prijimani dat je reseno prez preruseni...
                      00420         BANK_1  
0152   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0153   1683               M                 bsf     STATUS,RP0    
0154   1C98           00421         btfss TXSTA,1 
0155   2952           00422         goto WR_USART   ; cekame do chvile nez bude pripraven transmit buffer 
                      00423 
                      00424         BANK_0  
0156   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0157   1283               M                 bcf     STATUS,RP0    
0158   0099           00425         movwf TXREG
0159   0008           00426         return
                      00427 ;**********************************************************
                      00428 ; tento podprogram bude pro budouci praci zbytecny, je zde jen proto, abych na PC videl ze program byl s
                            pusten...
015A                  00429 POZDRAV  ; odesle po seriove lince pozdrav
015A   3041           00430         movlw 'A'       
015B   2152           00431         call WR_USART
015C   3068           00432         movlw 'h'
015D   2152           00433         call WR_USART
015E   306F           00434         movlw 'o'
015F   2152           00435         call WR_USART
0160   306A           00436         movlw 'j'
0161   2152           00437         call WR_USART
0162   3021           00438         movlw '!'
0163   2152           00439         call WR_USART
0164   0008           00440         return
                      00441 ;**********************************************************
                      00442 ; odesle data, ktera jdou z disku USARTEM. Pocet dat je v reg. TEMP1
0165                  00443 ODESLI_DATA
0165   2241           00444         call READ_DATA  
0166   0820           00445         movfw DATA_L
0167   2152           00446         call WR_USART
0168   0821           00447         movfw DATA_H
0169   2152           00448         call WR_USART   
016A   0BB6           00449         decfsz TEMP1,F
016B   2965           00450         goto ODESLI_DATA
016C   0008           00451         return
                      00452 ;**********************************************************
016D                  00453 ODESLI_MODEL_NUMBER     ; Podprogram IDENTIFY_DEVICE nam do bufferu 1 hodil jmeno disku
                      00454                         ; mi jej ted odesleme USARTem, aby mohl byt zobrazen na displeji
                      00455         INDF_BANK_3     ; BUFFER_1 je v bance 3
016D   1783               M                         bsf STATUS,IRP    
016E   3090           00456         movlw 0x90      ; na adrese 90
016F   0084           00457         movwf FSR
0170   3014           00458         movlw .20       ; budeme odesilat 20 slov (40 znaku)
0171   00B6           00459         movwf TEMP1
0172                  00460 ODESLI_MODEL_NUMBER_ODESILANI
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 22


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0172   0800           00461         movfw INDF
0173   00B7           00462         movwf TEMP2     ; data do bufferu byla vkladana stylem DATA_L, DATA_H, DATA_L, DATA_H...
0174   0A84           00463         incf FSR,F      ; ASCII hodnoty jsou ale razeny stylem DATA_H, DATA_L, DATA_H, DATA_L...
0175   0800           00464         movfw INDF      ; proto to pisu tak slozite...
0176   0A84           00465         incf FSR,F
                      00466         
0177   2152           00467         call WR_USART
0178   0837           00468         movfw TEMP2
0179   2152           00469         call WR_USART   
                      00470 
017A   0BB6           00471         decfsz TEMP1,F
017B   2972           00472         goto ODESLI_MODEL_NUMBER_ODESILANI
                      00473 
                      00474         INDF_BANK_0     
017C   1383               M                         bcf STATUS,IRP    
017D   0008           00475         return
                      00476 ;**********************************************************
017E                  00477 ODESLI_BUFF2_HIGH
                      00478         ; odesle z horni poloviny bufferu2 tolik bytu, kolik je v TEMP1
                      00479         INDF_BANK_2     ; BUFFER_2 je v bance 2
017E   1783               M                         bsf STATUS,IRP    
017F   3030           00480         movlw 0x30      ; horni pulka od adresy 30h
0180   0084           00481         movwf FSR
0181                  00482 ODESLI_BUFF2_HIGH_ODESILANI
0181   0800           00483         movfw INDF
0182   2152           00484         call WR_USART
0183   0A84           00485         incf FSR,F      
0184   0BB6           00486         decfsz TEMP1,F
0185   2981           00487         goto ODESLI_BUFF2_HIGH_ODESILANI
                      00488 
                      00489         INDF_BANK_0             
0186   1383               M                         bcf STATUS,IRP    
0187   0008           00490         return
                      00491 ;**************************************************************************
0188                  00492 ODESLI_BUFFER2
                      00493         ; v TEMP1 ocakava hodnotu kolik bytu ma odeslat
                      00494         INDF_BANK_2     ; BUFFER_2 je v bance 2
0188   1783               M                         bsf STATUS,IRP    
0189   3010           00495         movlw 0x10      ; na adrese 10
018A   0084           00496         movwf FSR
018B                  00497 ODESLI_BUFFER2_ODESILANI
018B   0800           00498         movfw INDF
018C   2152           00499         call WR_USART
018D   0A84           00500         incf FSR,F      
018E   0BB6           00501         decfsz TEMP1,F
018F   298B           00502         goto ODESLI_BUFFER2_ODESILANI
                      00503 
                      00504         INDF_BANK_0             
0190   1383               M                         bcf STATUS,IRP    
0191   0008           00505         return
                      00506 ;**********************************************************
0192                  00507 INTERRUPT                                       ; sem se skace po zavolani preruseni (uz jsou vyreseny u
                            lohy dulezitych registru)
0192   1E8C           00508         btfss PIR1,RCIF                 ; Meli bychom mit povoleno sice jen jedno preruseni (od USARTU),
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 23


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                             jeden ale nikdy nevi, proto ten test
0193   29A0           00509         goto END_OF_INTERRUPT   ; Pokud nejde o preruseni od USARTU, tak koncime...
0194   081A           00510         movfw RCREG                             ; !!! vynulovat pøíznak !!!     
0195   00F4           00511         movwf PRIJATE_DATO
                      00512 
0196   0873           00513         movfw PRIJATYCH_DAT
0197   3C07           00514         sublw .7                                ; pokud je v zasobniku uz plno (PRIJATYCH_DAT=8), tak ko
                            ncime
0198   1C03           00515         btfss STATUS,C
0199   29A0           00516         goto END_OF_INTERRUPT   ; Zasobnik je plny, nic prijimat nebudeme
                      00517 
019A   0873           00518         movfw PRIJATYCH_DAT
019B   3E78           00519         addlw 0x78                              ; zacatek zasobniku prikazu
019C   0084           00520         movwf FSR
019D   0874           00521         movfw PRIJATE_DATO              ; prijmuta data -> do W
019E   0080           00522         movwf INDF                              ; prijate dato na prvni volne misto v zasobniku
                      00523         
019F   0AF3           00524         incf  PRIJATYCH_DAT,F   ; pricteme k indikaci zasobniku
                      00525 ;       movlw '['
                      00526 ;       call WR_USART
                      00527 ;       movfw PRIJATYCH_DAT
                      00528 ;       addlw .48
                      00529 ;       call WR_USART
                      00530 ;       movlw ']'
                      00531 ;       call WR_USART   
01A0                  00532 END_OF_INTERRUPT                        ; sem skocime kdyz mame vsechny veci kolem preruseni vyrizeny
01A0   0876           00533         movfw TEMP_PCLATH
01A1   008A           00534         movwf PCLATH
01A2   0872           00535         movfw TEMP_FSR
01A3   0084           00536         movwf FSR
01A4   0871           00537         movfw TEMP_STATUS
01A5   0083           00538         movwf STATUS
01A6   0870           00539         movfw TEMP_WORKING
01A7   0009           00540         retfie
                      00541 ;**********************************************************
01A8                  00542 DELAY_2ms
                      00543 ;Delay 8000 cycles
01A8   3013           00544         MOVLW 0x13  ;19 DEC
01A9   00B6           00545         MOVWF TMP1
01AA   308B           00546         MOVLW 0x8B  ;139 DEC
01AB   00B8           00547         MOVWF TMP0
01AC   0BB8           00548         DECFSZ TMP0,F
01AD   29AC           00549         GOTO $-1
01AE   0BB6           00550         DECFSZ TMP1,F
01AF   29AA           00551         GOTO $-5
                      00552 ;End of Delay   
01B0   0008           00553         return
                      00554 ;**********************************************************
01B1                  00555 DELAY_200ms
                      00556 ;Delay 197123 cycles
01B1   3000           00557         MOVLW 0x00  ;0 DEC
01B2   00B6           00558         MOVWF TMP1
01B3   3000           00559         MOVLW 0x00  ;0 DEC
01B4   00B8           00560         MOVWF TMP0
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 24


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

01B5   0BB8           00561         DECFSZ TMP0,F
01B6   29B5           00562         GOTO $-1
01B7   0BB6           00563         DECFSZ TMP1,F
01B8   29B5           00564         GOTO $-3
                      00565 ;End of Delay
01B9   0008           00566         return
                      00567 ;**********************************************************
01BA                  00568 DELAY_500ms
                      00569 ; (Fosc = 16 MHz , instr. cyklus= 0.25 us) 500 000us / 0.25 us = 2 000 000 instrukcnich cyklu
                      00570 ;Variables: TMP2, TMP1, TMP0
                      00571 ;Delay 2000000 cycles
01BA   3047           00572         MOVLW 0x47  ;71 DEC
01BB   00B7           00573         MOVWF TMP2
01BC   302B           00574         MOVLW 0x2B  ;43 DEC
01BD   00B6           00575         MOVWF TMP1
01BE   30D9           00576         MOVLW 0x0D9  ;217 DEC
01BF   00B8           00577         MOVWF TMP0
01C0   0BB8           00578         DECFSZ TMP0,F
01C1   29C0           00579         GOTO $-1
01C2   0BB6           00580         DECFSZ TMP1,F
01C3   29BE           00581         GOTO $-5
01C4   0BB7           00582         DECFSZ TMP2,F
01C5   29BC           00583         GOTO $-9
                      00584 ;End of Delay
01C6   0008           00585         return
                      00586 ;**********************************************************
                      00068         include "ata.asm"               ; podprogramy na ovladani ATA disku
                      00001 ;**********************************************************
                      00002 ;**********************************************************
                      00003 ;**********************************************************
                      00004 ; OBSLUZNE PODPROGRAMY PRO ATA
                      00005 ;**********************************************************
                      00006 ;**********************************************************
                      00007 ;**********************************************************
                      00008 
                      00009 ;**********************************************************
                      00010 ; cteni a zapis ATA registru 
                      00011 ;**********************************************************
01C7                  00012 RD_STATUS         
01C7   3027           00013         movlw D_STATUS      ; Status 
01C8   221E           00014         call RUTR 
01C9   00AC           00015         movwf ATA_STATUS
01CA   0008           00016         return
                      00017 ;*****************************************
01CB                  00018 RD_ERROR
01CB   3021           00019         movlw D_ERROR      ; Error
01CC   221E           00020         call RUTR
01CD   00A5           00021         movwf ATA_ERROR
01CE   0008           00022         return
                      00023 ;*****************************************
01CF                  00024 RD_STATUS_A     
01CF   3016           00025         movlw D_STATUS_A    ; Alternate Status 
01D0   221E           00026         call RUTR 
01D1   00A2           00027         movwf ATA_STATUS_A
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 25


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

01D2   0008           00028         return
                      00029 ;*****************************************
01D3                  00030 RD_SC
01D3   3022           00031         movlw D_SECTOR_C    ; Sector Count
01D4   221E           00032         call RUTR
01D5   00A6           00033         movwf SECTOR_C
01D6   0008           00034         return
                      00035 ;*****************************************
01D7                  00036 RD_LBA1
01D7   3023           00037         movlw D_LBA1    ; Sector Number 
01D8   221E           00038         call RUTR                
01D9   00A7           00039         movwf LBA1 
01DA   0008           00040         return
                      00041 ;*****************************************
01DB                  00042 RD_LBA2
01DB   3024           00043         movlw D_LBA2  ; Cylinder Low
01DC   221E           00044         call RUTR
01DD   00A8           00045         movwf LBA2
01DE   0008           00046         return
                      00047 ;*****************************************
01DF                  00048 RD_LBA3
01DF   3025           00049         movlw D_LBA3  ; Cylinder High   
01E0   221E           00050         call RUTR
01E1   00A9           00051         movwf LBA3
01E2   0008           00052         return
                      00053 ;*****************************************
01E3                  00054 RD_DEVICE
01E3   3026           00055         movlw D_DEVICE  ; Device Head
01E4   221E           00056         call RUTR
01E5   00AB           00057         movwf DEVICE
01E6   0008           00058         return
                      00059 ;*****************************************
                      00060 ;*****************************************
01E7                  00061 WR_DC
01E7   0823           00062         movf DEVICE_C,w     ; Device Control
01E8   00B5           00063         movwf TEMPW
01E9   3016           00064         movlw D_DEVICE_C
01EA   222B           00065         call RUTW
01EB   0008           00066         return
                      00067 ;*****************************************
01EC                  00068 WR_COMMAND          
01EC   082D           00069         movf COMMAND,w      ; Command       
01ED   00B5           00070         movwf TEMPW
01EE   3027           00071         movlw D_COMMAND
01EF   222B           00072         call RUTW
01F0   0008           00073         return
                      00074 ;*****************************************
01F1                  00075 WR_SC                    
01F1   0826           00076     movf SECTOR_C,w     ; Sector Count
01F2   00B5           00077         movwf TEMPW
01F3   3022           00078         movlw D_SECTOR_C     
01F4   222B           00079         call RUTW
01F5   0008           00080         return
                      00081 ;*****************************************
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 26


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

01F6                  00082 WR_LBA1
01F6   0827           00083         movf LBA1,w     
01F7   00B5           00084         movwf TEMPW
01F8   3023           00085         movlw D_LBA1    
01F9   222B           00086         call RUTW
01FA   0008           00087         return
                      00088 ;*****************************************
01FB                  00089 WR_LBA2
01FB   0828           00090         movf LBA2,w   ; Cylinder Low
01FC   00B5           00091         movwf TEMPW
01FD   3024           00092         movlw D_LBA2
01FE   222B           00093         call RUTW
01FF   0008           00094         return
                      00095 ;*****************************************
0200                  00096 WR_LBA3
0200   0829           00097         movf LBA3,w   ; Cylinder High
0201   00B5           00098         movwf TEMPW
0202   3025           00099         movlw D_LBA3
0203   222B           00100         call RUTW
0204   0008           00101         return
                      00102 ;*****************************************
0205                  00103 WR_DEVICE
0205   082B           00104         movf DEVICE,w     ; Device Head 
0206   00B5           00105         movwf TEMPW
0207   3026           00106         movlw D_DEVICE
0208   222B           00107         call RUTW
0209   0008           00108         return
                      00109 ;*****************************************
020A                  00110 WR_FEATURES
020A   0824           00111         movf FEATURES,w     ; Features
020B   00B5           00112         movwf TEMPW
020C   3021           00113         movlw D_FEATURES
020D   222B           00114         call RUTW
020E   0008           00115         return
                      00116 ;*****************************************
                      00117 ; zapise vsechny registry potrebne k vykonani prikazu (adresove registry a prikaz)
020F                  00118 WR_BLOCK
                      00119 ;       call WAIT_FOR_READY_FOR_COMMAND
020F   21C7           00120         call RD_STATUS
0210   182C           00121         btfsc ATA_STATUS,ERR
0211   2A16           00122         goto $+5                                        ; Nastal error disku. Co budeme delat? S*r*m* na
                             to a jdeme dal
0212   1BAC           00123         btfsc ATA_STATUS,BSY
0213   2A0F           00124         goto $-4                                        ; Bsy <> 0, cekame dal 
0214   1F2C           00125         btfss ATA_STATUS,DRDY
0215   2A0F           00126         goto $-6
                      00127 
0216   220A           00128         call WR_FEATURES
0217   21F1           00129         call WR_SC
0218   21F6           00130         call WR_LBA1
0219   21FB           00131         call WR_LBA2
021A   2200           00132         call WR_LBA3
021B   2205           00133         call WR_DEVICE
021C   21EC           00134         call WR_COMMAND
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 27


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

021D   0008           00135         return
                      00136 ;*****************************************
                      00137 ; ve workingu mame adresu registru ktery mame precist, 
                      00138 ; pak v nem vracime jeho hodnotu...
021E                  00139 RUTR          
021E   0087           00140         movwf ATA_ADDRESS                  ; adresa pozadovaneho registru
                      00141 
                      00142         BANK_1
021F   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0220   1683               M                 bsf     STATUS,RP0    
0221   30FF           00143     movlw 0xFF
0222   0086           00144     movwf DATA_PORT_LOW_TRIS   ; z datove zbernice cteme
0223   0088           00145     movwf DATA_PORT_HIGH_TRIS
                      00146         BANK_0
0224   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0225   1283               M                 bcf     STATUS,RP0    
                      00147 
0226   1109           00148         bcf ATA_DIOR_N
0227   0000           00149     nop                                                 ; PIO delay min. 120ns (PIO 4)  
0228   0806           00150     movfw DATA_PORT_LOW                 ; Read DD0..D7 IDE
0229   1509           00151         bsf ATA_DIOR_N
                      00152 
022A   0008           00153     return
                      00154 ;**********************************************************
                      00155 ; ve workingu mame adresu registru ktery mame zapsat,
                      00156 ; a v reg. TEMPW hodnotu kterou mame do tohoto registru zapsat
022B                  00157 RUTW
022B   0087           00158         movwf ATA_ADDRESS
                      00159 
                      00160         BANK_1
022C   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
022D   1683               M                 bsf     STATUS,RP0    
022E   3000           00161     movlw 0x0
022F   0086           00162     movwf DATA_PORT_LOW_TRIS   ; do datove sbernice zapisujeme
0230   0088           00163     movwf DATA_PORT_HIGH_TRIS
                      00164         BANK_0
0231   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0232   1283               M                 bcf     STATUS,RP0    
                      00165 
0233   0835           00166     movf TEMPW,w        
0234   0086           00167     movwf DATA_PORT_LOW                 ; Write DD0..DD7 IDE 
0235   0188           00168         clrf DATA_PORT_HIGH
                      00169 
0236   1089           00170         bcf ATA_DIOW_N
0237   0000           00171         nop
0238   1489           00172         bsf ATA_DIOW_N
                      00173           
                      00174         BANK_1
0239   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
023A   1683               M                 bsf     STATUS,RP0    
023B   30FF           00175     movlw 0xff
023C   0086           00176     movwf DATA_PORT_LOW_TRIS   ; datova sbernice na cteni
023D   0088           00177     movwf DATA_PORT_HIGH_TRIS
                      00178         BANK_0
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 28


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

023E   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
023F   1283               M                 bcf     STATUS,RP0    
                      00179 
0240   0008           00180         return
                      00181 ;**********************************************************
0241                  00182 READ_DATA
                      00183 ;       call WAIT_FOR_DATA      ; tento odskok do dalsich podprogramu si nemohu, dovolit, protoze mam je
                            n 8bit STACK
                      00184         ; Wait: ( Bsy=0 AND Drq=1 ) OR err=1
                      00185         ; 7   6    5  4   3   2    1   0
                      00186         ; BSY DRDY DF DSC DRQ CORR IDX ERR
                      00187         ; (cekame az disk bude mit pro nas prichystana data)
0241   3027           00188         movlw D_STATUS      ; Status 
0242   221E           00189         call RUTR 
0243   00AC           00190         movwf ATA_STATUS
0244   182C           00191         btfsc ATA_STATUS,ERR
0245   2A4A           00192         goto READ_DATA_CTEME            ; Nastal error disku. Co budeme delat? S*r*m* na to a data prect
                            eme...
                      00193 
0246   1BAC           00194         btfsc ATA_STATUS,BSY
0247   2A41           00195         goto READ_DATA                          ; Bsy <> 0, cekame dal 
                      00196         
0248   1DAC           00197         btfss ATA_STATUS,DRQ
0249   2A41           00198         goto READ_DATA                          ; Drq <> 1, cekame dal 
                      00199         
024A                  00200 READ_DATA_CTEME
                      00201 
024A   3020           00202     movlw D_DATA_R
024B   0087           00203         movwf ATA_ADDRESS
                      00204 
                      00205         BANK_1
024C   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
024D   1683               M                 bsf     STATUS,RP0    
024E   30FF           00206     movlw 0xFF
024F   0086           00207     movwf DATA_PORT_LOW_TRIS   ; z datove zbernice cteme
0250   0088           00208     movwf DATA_PORT_HIGH_TRIS
                      00209         BANK_0
0251   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0252   1283               M                 bcf     STATUS,RP0    
                      00210 
0253   1109           00211         bcf ATA_DIOR_N
0254   0000           00212     nop                                                 ; PIO delay min. 120ns (PIO 4)  
0255   0000           00213         nop
0256   0806           00214     movfw DATA_PORT_LOW                 ; Read DD0..D7 IDE
0257   00A0           00215         movwf DATA_L
0258   0808           00216     movfw DATA_PORT_HIGH                ; Read DD8..D15 IDE
0259   00A1           00217         movwf DATA_H
025A   1509           00218         bsf ATA_DIOR_N
                      00219 
025B   0008           00220     return
                      00221 ;**********************************************************
                      00222 ; stava se, ze obcas nas zajima jen cast vracenych dat, tak ty ktere nas nezajimaji, preskocime
                      00223 ; ocakava parametr v registru TEMP1 (kolik slov ma preskocit)
                      00224 ; pokud TEMP1 = 0 tak preskoci 256 slov
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 29


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

025C                  00225 PRESKOC
025C   2241           00226         call READ_DATA
025D   0BB6           00227         decfsz TEMP1,F
025E   2A5C           00228         goto PRESKOC
025F   0008           00229         return
                      00230 ;**********************************************************
                      00231 ; rekne disku na ze pristi instrukce, registry, data.... budou pro mastera
0260                  00232 SELECT_DEVICE
0260   30E0           00233         movlw b'11100000'       ; adresy budou v LBA, budeme pracovat s masterem
0261   00AB           00234         movwf DEVICE
0262   2205           00235         call WR_DEVICE
0263   0008           00236         return
                      00237 ;**********************************************************
0264                  00238 ZAPIS_DO_BUFFERU_1      ; buffer1 ma 64B a je v bance 3 na adrese 0x190 - 0x1CF
                      00239                                         ; jako parametr dostanem TEMP1, kde je pocet bytu k zapisu
                      00240                                         ; maximalni hodnota v TEMP1 muze byt 32 (1 slovo = 2 byty)
                      00241         INDF_BANK_3             ; neprime adresovani na banku 3
0264   1783               M                         bsf STATUS,IRP    
0265   3090           00242         movlw 0x90              ; adresa ja 190, devaty byt urcuje banku (0,1 / 2,3) fsr je tedy 90
0266   0084           00243         movwf FSR               
0267                  00244 ZAPIS_DO_BUFFERU_1__ZAPIS
0267   2241           00245         call READ_DATA
                      00246         
0268   0820           00247         movfw DATA_L
0269   0080           00248         movwf INDF
026A   0A84           00249         incf FSR,F
026B   0821           00250         movfw DATA_H
026C   0080           00251         movwf INDF
026D   0A84           00252         incf FSR,F
                      00253 
026E   0BB6           00254         decfsz TEMP1,F
026F   2A67           00255         goto ZAPIS_DO_BUFFERU_1__ZAPIS
                      00256 
                      00257         INDF_BANK_0     
0270   1383               M                         bcf STATUS,IRP    
0271   0008           00258         return
                      00259 ;**********************************************************
0272                  00260 CLEAR_BUFFER2           ; BUFFER2 je 64bytu dat v bance 2 na adrese 0x110 - 0x14F
                      00261                                         ; pouziva TEMP1
0272   3040           00262         movlw .64
0273   00B6           00263         movwf TEMP1
                      00264         INDF_BANK_2             ; neprime adresovani na banku 2
0274   1783               M                         bsf STATUS,IRP    
0275   3010           00265         movlw 0x10
0276   0084           00266         movwf FSR
0277   3000           00267         movlw .0
                      00268 
0278                  00269 CLEAR_BEFFER2__CLEAR
0278   0080           00270         movwf INDF
0279   0A84           00271         incf FSR,F
027A   0BB6           00272         decfsz TEMP1,F
027B   2A78           00273         goto CLEAR_BEFFER2__CLEAR
                      00274 
                      00275         INDF_BANK_0             ; neprime adresovani na banku 0
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 30


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

027C   1383               M                         bcf STATUS,IRP    
027D   0008           00276         return
                      00277 ;**********************************************************
027E                  00278 ATA_RESET
                      00279         ; Resetuje disk zjisti, zda vubec nejaky disk je pripojen
027E   01AE           00280         clrf ATA_ATTRIBUTES     ; registr obsahujici bity rikajici co disk umi
                      00281 
027F   1009           00282         bcf ATA_RESET_N         ; resetujeme disk
0280   2324           00283         call DELAY_25us         ; signal reset musi byt min. 25us
0281   1409           00284         bsf ATA_RESET_N         ; koncime s resetem disku
                      00285 
0282   2329           00286         call WAIT_FOR_READY     ; vynulujeme device bit v DEVICE registru (disk musi byt master!), ...
0283   2260           00287         call SELECT_DEVICE      ; ...nastavime bit L - LBA addressing
                      00288 
0284   2329           00289         call WAIT_FOR_READY
0285   3002           00290         movlw b'00000010'       ; zakazeme preruseni (ted mam na mysli signal INTRQ z disku)
0286   00A3           00291         movwf DEVICE_C          ; bit nIEN = 1 -> zakazeme preruseni disku (stejne nemame signal INTRQ p
                            ripojen)
0287   21E7           00292         call WR_DC                      ; zapiseme hodnotu do registru DEVICE CONTROL
                      00293 
0288   30E0           00294         movlw b'11100000'       ; adresy budou v LBA, budeme pracovat s masterem
0289   00AB           00295         movwf DEVICE
028A   01A6           00296         clrf SECTOR_C
028B   01A7           00297         clrf LBA1       
028C   01A8           00298         clrf LBA2
028D   01A9           00299         clrf LBA3
028E   01A4           00300         clrf FEATURES
028F   3000           00301         movlw h'00'                     ; code prikazu nop
0290   00AD           00302         movwf COMMAND
0291   220F           00303         call WR_BLOCK           ; ted provedeme prvni prikaz (nop) a podivame se co nam disk vrati
                      00304 
0292   2329           00305         call WAIT_FOR_READY
0293   21E3           00306         call RD_DEVICE          ; Precteme reg. device. Pokud je disk OK, tak by nam mel vratit to, co j
                            sme do nej predtim zapsaly
0294   082B           00307         movfw DEVICE
0295   3CE0           00308         sublw b'11100000'
0296   1903           00309         btfsc STATUS,Z          ; pokud DEVICE <> b'11100000', tak tu bud disk nemame, nebo je nejakej r
                            ozsypanej, nebo je spatne svicivanej (treba SLAVE)
0297   142E           00310         bsf ATA_ATTRIBUTES,ATA_OK       ; 0. bit = 1 -> disk je pritomen, zapnuty a funkcni...
                      00311 
0298   0008           00312         return          
                      00313 ;**********************************************************
0299                  00314 READ_SECTOR
                      00315         ; Tento podprogram prevezme parametry SECTOR_C (kolik sec. mame precist)
                      00316         ; a LBA1 - LBA4, kde je ulozena LBA adresa sectoru od ktereho mame cist
                      00317         ; Postara se o spravne zadani adresy do disku (LBA28 / LBA48) a zavolani prikazu ke cteni...
                      00318         ; Samotne cteni se musi obslouzit v jine casti programu (podle toho co cteme...)
                      00319 
                      00320 ;       call WAIT_FOR_READY
                      00321         ; Cekame az Bsy bit = 0 
0299   21C7           00322         call RD_STATUS
029A   182C           00323         btfsc ATA_STATUS,ERR
029B   2A9E           00324         goto $+3                                        ; Nastal error disku. Co budeme delat? S*r*m* na
                             to a jdeme dal
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 31


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

029C   1BAC           00325         btfsc ATA_STATUS,BSY
029D   2A99           00326         goto $-4                                        ; Bsy <> 0, cekame dal 
                      00327 
                      00328 
                      00329 ;       call SELECT_DEVICE
029E   30E0           00330         movlw b'11100000'       ; adresy budou v LBA, budeme pracovat s masterem
029F   00AB           00331         movwf DEVICE
02A0   2205           00332         call WR_DEVICE
                      00333 
                      00334 ;       call WAIT_FOR_READY_FOR_COMMAND
02A1   21C7           00335         call RD_STATUS
02A2   182C           00336         btfsc ATA_STATUS,ERR
02A3   2AA8           00337         goto $+5                                        ; Nastal error disku. Co budeme delat? S*r*m* na
                             to a jdeme dal
02A4   1BAC           00338         btfsc ATA_STATUS,BSY
02A5   2AA1           00339         goto $-4                                        ; Bsy <> 0, cekame dal 
02A6   1F2C           00340         btfss ATA_STATUS,DRDY
02A7   2AA1           00341         goto $-6
                      00342 
02A8   192E           00343         btfsc ATA_ATTRIBUTES,LBA48_SUPPORT
02A9   2AB9           00344         goto READ_SECTOR_LBA48
                      00345 
02AA                  00346 READ_SECTOR_LBA27               ; zadavani adresy v LBA28 je celkem jednoduche, LBA bity 24-27 jsou obsa
                            zene v dolnich 4 bitech DEVICE reg.
02AA   01A4           00347         clrf FEATURES
02AB   220A           00348         call WR_FEATURES
02AC   21F1           00349         call WR_SC
02AD   21F6           00350         call WR_LBA1
02AE   21FB           00351         call WR_LBA2
02AF   2200           00352         call WR_LBA3
02B0   082A           00353         movfw LBA4                      ; Z nejvyssi casti adresy...
02B1   390F           00354         andlw b'00001111'       ; ...pouzijeme pouze dolni 4bity...
02B2   38E0           00355         iorlw b'11100000'       ; ...horni 3bity nastavime (LBA adresovani, master)...
02B3   00AB           00356         movwf DEVICE            ; ...a zapiseme do DEVICE.
02B4   2205           00357         call WR_DEVICE
02B5   3020           00358         movlw 0x20                      ; Read sector. OPCODE - 20h (with retries) or 21h (without retri
                            es)
02B6   00AD           00359         movwf COMMAND           ; ...podle me to znamena ze prikaz 20h se bude pri neuspechu pokouset zn
                            ova o cteni....
02B7   21EC           00360         call WR_COMMAND         ; ...protoze se v novejsich spicifacich jiz prikaz 21h nevyskytuje, pouz
                            ivam ke cteni 20h.
02B8   0008           00361         return
                      00362 
02B9                  00363 READ_SECTOR_LBA48
                      00364         ; !!! Pripominam ze to co zde pisu (o LBA48) vim ze specifikace ATA8, v praxi jsem LBA48 na zadn
                            em disku jeste nezkousel !!!
                      00365         ; Zadavani adresy pri LBA48 se o neco lisi nez LBA28. Do registru LBA 1,2,3 se data zadavaji 2x.
                             
                      00366         ; Prvi zadavani znamena horni cast adresy, druhe zadavani dolni cast adresy.
                      00367         ; Znova sem pisu ze v tomto programu vyuzijeme jen LBA o 32bitech (2TB) a ne celych LBA48
02B9   3000           00368         movlw .0
02BA   00B5           00369         movwf TEMPW
02BB   3022           00370         movlw D_SECTOR_C    ; vyssi cast parametru SECTOR_C = 0
02BC   222B           00371         call RUTW       
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 32


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

02BD   21F1           00372         call WR_SC                      ; nizci cast parametru SECTOR_C
                      00373 
02BE   3000           00374         movlw .0
02BF   00B5           00375         movwf TEMPW
02C0   3025           00376         movlw D_LBA3            ; LBA bity 47:40
02C1   222B           00377         call RUTW
02C2   3000           00378         movlw .0
02C3   00B5           00379         movwf TEMPW
02C4   3024           00380         movlw D_LBA2            ; LBA bity 39:32
02C5   222B           00381         call RUTW
02C6   082A           00382         movfw LBA4
02C7   00B5           00383         movwf TEMPW
02C8   3023           00384         movlw D_LBA1            ; LBA bity 31:24
02C9   222B           00385         call RUTW
                      00386 
02CA   2200           00387         call WR_LBA3            ; LBA bity 23:16
02CB   21FB           00388         call WR_LBA2            ; LBA bity 15:8
02CC   21F6           00389         call WR_LBA1            ; LBA bity  7:0
02CD   3024           00390         movlw h'24'                     ; pri LBA48 se musi pouzit tohoto prikazu ke cteni (READ SECTOR(
                            S) EXT - 24h, PIO data-in)
02CE   00AD           00391         movwf COMMAND
02CF   21EC           00392         call WR_COMMAND
02D0   0008           00393         return
                      00394 ;**********************************************************
02D1                  00395 IDENTIFY_DEVICE
                      00396         ; ted uz vime, ze mame pripojen nejaky disk, tento podprogram provede prikaz 
                      00397         ; identify device a zjisti co je disk zac. Nektere dulezite informace ulozi 
                      00398         ; (nastavi byty v ATA_ATTRIBUTES) a jmenovku disku hodi do bufferu
                      00399 
                      00400         ; rekneme disku, ze s nim chcem pracovat (s masterem)
02D1   2329           00401         call WAIT_FOR_READY
02D2   2260           00402         call SELECT_DEVICE
                      00403         
                      00404         ; podivame se zda tu vubec disk je a co podporuje (LBA)
02D3   2329           00405         call WAIT_FOR_READY     ; celame nez bude disk opet ready pro dalsi prikazy
                      00406 
02D4   30E0           00407         movlw b'11100000'       ; adresy budou v LBA, budeme pracovat s masterem
02D5   00AB           00408         movwf DEVICE
02D6   01A6           00409         clrf SECTOR_C
02D7   01A7           00410         clrf LBA1       
02D8   01A8           00411         clrf LBA2
02D9   01A9           00412         clrf LBA3
02DA   01A4           00413         clrf FEATURES
02DB   30EC           00414         movlw 0xEC                      ; code prikazu IDENTIFY DEVICE
02DC   00AD           00415         movwf COMMAND
02DD   220F           00416         call WR_BLOCK
                      00417 
                      00418         ; pokud se neco nepodelalo, dostanem 256 16ti bitovych slov kde je napsano co disk umi a co je t
                            o zac...
                      00419         ; slova cisluji od nuly, (tzn. ze slov je 0-255)
02DE   301B           00420         movlw .27               ; prvnich 27 slov je pro nas nepotrebnych
02DF   00B6           00421         movwf TEMP1
02E0   225C           00422         call PRESKOC
                      00423         
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 33


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00424         ; [27-46] model mumber (ASCI retezec s nazvem disku)
                      00425         ; tady precteme 20 slov a rovnou je odesleme do pric
                      00426                 ; pokud nekde od disku dostavame ASCII retezec jsou data nasledujici: 
                      00427                 ; pr. disk nam posila string “Copyright”
                      00428                 ;               1. DATA_H = 'C' 
                      00429                 ;               1. DATA_l = 'o'
                      00430                 ;               2. DATA_H = 'P' 
                      00431                 ;               2. DATA_l = 'y'
02E1   3014           00432         movlw .20               ; dalsich 20 slov obsahuje 40 s ASCII znaku s nazvem disku
02E2   00B6           00433         movwf TEMP1
02E3   2264           00434         call ZAPIS_DO_BUFFERU_1
                      00435                 
                      00436         ; ted jsme uz precetli 47 slov z 256 :-)
02E4   3002           00437         movlw .2                ; dalsi 2 slova jsou nam k nicemu
02E5   00B6           00438         movwf TEMP1
02E6   225C           00439         call PRESKOC
                      00440                 
02E7   2241           00441         call READ_DATA  ; slovo 49 - capabilities (schopnosti)
                      00442                         ; 15:14 Reserved for the IDENTIFY PACKET DEVICE command.
                      00443                         ;    13 1 = Standby timer values as specified in this standard are supported
                      00444                         ;       0 = Standby timer values shall be managed by the device
                      00445                         ;    12 Reserved for the IDENTIFY PACKET DEVICE command.
                      00446                         ;    11 1 = IORDY supported
                      00447                         ;       0 = IORDY may be supported
                      00448                         ;    10 1 = IORDY may be disabled
                      00449                         ;     9 1 = LBA supported
                      00450                         ;     8 1 = DMA supported.
                      00451                         ;   7:0 Retired 
02E8   18A1           00452         btfsc DATA_H,1  ;bit 9 = 1 -> LBA supported
02E9   14AE           00453         bsf ATA_ATTRIBUTES,LBA_SUPPORT
                      00454 
                      00455         ;precetli jsme 50 slov
02EA   300A           00456         movlw .10
02EB   00B6           00457         movwf TEMP1
02EC   225C           00458         call PRESKOC
                      00459         
02ED   2241           00460         call READ_DATA  ; 60
02EE   0820           00461         movfw DATA_L
02EF   00AF           00462         movwf PARAM_MAX_LBA1            ; nejnizsi cast adresy
02F0   0821           00463         movfw DATA_H
02F1   00B0           00464         movwf PARAM_MAX_LBA2    
                      00465         
02F2   2241           00466         call READ_DATA  ; 61
02F3   0820           00467         movfw DATA_L
02F4   00B1           00468         movwf PARAM_MAX_LBA3
02F5   0821           00469         movfw DATA_H
02F6   00B2           00470         movwf PARAM_MAX_LBA4            ; nejvyssi cast adresy
                      00471         
                      00472         ;precetli jsme 62 slov, zbyva 194
02F7   3015           00473         movlw .21
02F8   00B6           00474         movwf TEMP1
02F9   225C           00475         call PRESKOC
                      00476 
                      00477         ; 83 slov, na rade je slovo 83 (pripominam ze slova jsou cislovana od nuly)
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 34


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

02FA   2241           00478         call READ_DATA  ; 83 - command supported. Tady nas zajima bit 10 - 1 = 48-bit Address feature se
                            t supported
02FB   1921           00479         btfsc DATA_H,2  ; pokud disk umi LBA 48 pripiseme tuto skutecnost do ATA_ATTRIBUTES
02FC   152E           00480         bsf ATA_ATTRIBUTES,LBA48_SUPPORT
                      00481 
                      00482         ;precetli jsme 84 slov
02FD   3010           00483         movlw .16
02FE   00B6           00484         movwf TEMP1
02FF   225C           00485         call PRESKOC
                      00486                 
0300   1D2E           00487         btfss ATA_ATTRIBUTES,LBA48_SUPPORT
0301   2B0D           00488         goto INIT_ATA__NOT_SUPPORT_LBA48
                      00489                         ; pokud je podporovano LBA 48, nachazi se ve slovech [100-103] skutecny pocet se
                            ktoru 
                      00490                         ; do slov 60-61 by se sice vesel pocet sektoru u disku do 2TB, podle standardu s
                            e tam ale zapisuje pouze hodnota max pro LBA 28 (cca 120 GB)
                      00491                         ; mi precteme ale jen nejnizsi 2 slova, predpokladam totiz ze disk neni vetsi ja
                            k 2TB
0302   2241           00492                         call READ_DATA  ; 100
0303   0820           00493                         movfw DATA_L
0304   00AF           00494                         movwf PARAM_MAX_LBA1            ; nejnizsi cast adresy
0305   0821           00495                         movfw DATA_H
0306   00B0           00496                         movwf PARAM_MAX_LBA2    
                      00497 
0307   2241           00498                         call READ_DATA  ; 101
0308   0820           00499                         movfw DATA_L
0309   00B1           00500                         movwf PARAM_MAX_LBA3
030A   0821           00501                         movfw DATA_H
030B   00B2           00502                         movwf PARAM_MAX_LBA4            ; nejvyssi cast adresy                  
030C   2B10           00503                 goto INIT_ATA__DALSI
030D                  00504 INIT_ATA__NOT_SUPPORT_LBA48
030D   3002           00505         movlw .2        ; 100, 101
030E   00B6           00506         movwf TEMP1
030F   225C           00507         call PRESKOC    
0310                  00508 INIT_ATA__DALSI
                      00509         ; precetli jsme 102 slov
0310   3004           00510         movlw .4        ; 102, 103, 104, 105
0311   00B6           00511         movwf TEMP1
0312   225C           00512         call PRESKOC
                      00513 
0313   2241           00514         call READ_DATA  ; slovo 106 - pokud bit 15=0 a bit 14=1, tak obsahuje pravdive informace
                      00515                                                 ; pro nas je podstatne, ze pokud je bit 12 = 1, tak sekt
                            or je vetsi nez 256 slov
                      00516                                                 ; pokud je sektor vetsi nez 256 slov, je jeho velikost v
                            e slovech [117-118]
0314   1BA1           00517         btfsc DATA_H,7
0315   2B1A           00518         goto INIT_ATA__DALSI2
0316   1F21           00519         btfss DATA_H,6
0317   2B1A           00520         goto INIT_ATA__DALSI2
0318   1A21           00521         btfsc DATA_H,4
0319   15AE           00522         bsf ATA_ATTRIBUTES,BIG_SECTOR
031A                  00523 INIT_ATA__DALSI2
                      00524         ; precteno 107, zbyva 149
031A   3095           00525         movlw .149      ; 107 - 256
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 35


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

031B   00B6           00526         movwf TEMP1
031C   225C           00527         call PRESKOC
                      00528                 
                      00529         ; ted vime co mame za disk, tak se na to jdem podivat...
                      00530         ; pokud disk splnuje vsechny nase pozadavky, tak nastavime 7 bit v ATA_ATTRIBUTES
031D   13AE           00531         bcf ATA_ATTRIBUTES,APPLICABLE   
031E   1CAE           00532         btfss ATA_ATTRIBUTES,LBA_SUPPORT
031F   0008           00533         return
                      00534         ; pokud jsme tady, disk podporuje LBA (dneska se jich uz moc nevidi, co by LBA neumeli)
0320   19AE           00535         btfsc ATA_ATTRIBUTES,BIG_SECTOR
0321   0008           00536         return
                      00537         ; mazec, disk ma velikost sektoru 256 slov, vetsi naroky na disk nemam :-)
0322   17AE           00538         bsf ATA_ATTRIBUTES,APPLICABLE ; disk umi to co potrebujeme...   
                      00539 
0323   0008           00540         return
                      00541 ;**************************************************************************
                      00542 ;**********************************************************
                      00543 ; CEKACI PROCEDURY
                      00544 ;**********************************************************
0324                  00545 DELAY_25us
                      00546         ; pouziva TEMP1
                      00547         ; (Fosc = 20 MHz , instr. cyklus= 0.20 us) 25us / 0.20 us = 125 instrukcnich cyklu
                      00548         ; (Fosc = 16 MHz , instr. cyklus= 0.25 us) 25us / 0.25 us = 100 instrukcnich cyklu
                      00549         ; (Fosc = 04 MHz , instr. cyklus= 1.00 us) 25us / 1.00 us =  25 instrukcnich cyklu      
                      00550         ;MOVLW 0x2A  ;42 DEC -> Delay 127 cycles
0324   3021           00551         MOVLW 0x21   ;33 DEC -> Delay 100 cycles
                      00552         ;MOVLW 0x08  ;25 DEC -> Delay  25 cycles
0325   00B6           00553         MOVWF TEMP1
0326   0BB6           00554         DECFSZ TEMP1,F
0327   2B26           00555         GOTO $-1
                      00556         ;End of Delay
0328   0008           00557         return
                      00558 ;**************************************************************************
0329                  00559 WAIT_FOR_READY
                      00560         ; Cekame az Bsy bit = 0 
                      00561         ; (cekame az disk nebude zaneprazdnen)
0329   21C7           00562         call RD_STATUS
032A   082C           00563         movfw ATA_STATUS
032B   3980           00564         andlw b'10000000'
032C   1903           00565         btfsc STATUS,Z
032D   0008           00566         return
032E   2B29           00567         goto WAIT_FOR_READY
                      00568 ;**************************************************************************
                      00569 ;WAIT_FOR_READY_FOR_COMMAND
                      00570 ;       call WAIT_FOR_READY
                      00571 ;       btfss ATA_STATUS,DRDY
                      00572 ;       goto WAIT_FOR_READY_FOR_COMMAND
                      00573 ;       return
                      00574 ;**************************************************************************
                      00069         include "fat32.asm"     ; podprogramy na nacteni a praci s FAT32
                      00001 ;**********************************************************
                      00002 ;**********************************************************
                      00003 ;**********************************************************
                      00004 ; OBSLUZNE PODPROGRAMY PRO FAT32, HLEDANI ODDILU
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 36


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00005 ;**********************************************************
                      00006 ;**********************************************************
                      00007 ;**********************************************************
                      00008 
                      00009 ;**************************************************************************
032F                  00010 SCAN_MBR
                      00011         ; Tato procedura ma na prvni pohled jednoduchy ukol, podiva se do MBR a do BUFFERU 2 hodi nasled
                            ujici data:
                      00012         ; 4 x 16 bytovy zaznam, kde kazdy zaznam reprezentuje jeden oddil se systemem FAT32
                      00013         ; struktura zaznamu je nasledujici:             1  byt (pokud = 0 tak v zaznamu neni zaznam o od
                            dilu, pokud = FFh , je zaznam o oddilu)
                      00014         ;                                                                               4  byty = adresa
                             kde se nachazi spousteci zaznam oddilu
                      00015         ;                                                                               11 bytu = jmenov
                            ka oddilu s FAT32 (neni dulezita, jen aby bylo co vypsat na display :-)
032F   2272           00016         call CLEAR_BUFFER2
                      00017 
0330   01A7           00018         clrf LBA1
0331   01A8           00019         clrf LBA2
0332   01A9           00020         clrf LBA3
0333   01AA           00021         clrf LBA4                               ; jako prvni cteme MBR
                      00022 
0334   01BB           00023         clrf POZICE                             ; kolik zaznamu o oddilech uz bylo zapsano do bufferu2
0335                  00024 SCAN_BR                                         
                      00025         ; tady na tom navesti mame zadanou adresu MBR nebo BR nejakeho rozsireneho oddilu
0335   3001           00026         movlw .1
0336   00A6           00027         movwf SECTOR_C
0337   2299           00028         call READ_SECTOR                ; cteme MBR nebo BR rozsireneho oddilu
                      00029 
0338   30DF           00030         movlw .223                              ; 223 slov = 446 bytu
0339   00B6           00031         movwf TEMP1
033A   225C           00032         call PRESKOC                    ; na prvnich 446 bytech MBR je zavadeci program systemu (samozre
                            jme, pokud na disku system je)
033B   3020           00033         movlw .32
033C   00B6           00034         movwf TEMP1
033D   2264           00035         call ZAPIS_DO_BUFFERU_1 ; do bufferu si dame vsechny zaznamy BR (16*4=64bytu / 32slov)
033E   3001           00036         movlw .1
033F   00B6           00037         movwf TEMP1
0340   225C           00038         call PRESKOC
                      00039         ; tak ted jsme precetli cely MBR/BR a zaznamy o jeho oddilech mame v BEFFERU 1, tak se jdem na n
                            e podivat...
                      00040         
                      00041         ; Nejdriv si ale hodime aktualni LBA adresu do operandu Y pro aritmeticke operace
                      00042         INDF_BANK_1                             ; neprime adresovani na banku 1 (aritmeticke operace)
0341   1383               M                         bcf STATUS,IRP    
0342   30A4           00043         movlw 0xA4                              ; FSR na OPERAND_Y
0343   0084           00044         movwf FSR       
0344   0827           00045         movfw LBA1
0345   0080           00046         movwf INDF
0346   0A84           00047         incf FSR,F
0347   0828           00048         movfw LBA2
0348   0080           00049         movwf INDF
0349   0A84           00050         incf FSR,F
034A   0829           00051         movfw LBA3
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 37


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

034B   0080           00052         movwf INDF
034C   0A84           00053         incf FSR,F
034D   082A           00054         movfw LBA4
034E   0080           00055         movwf INDF
034F   0A84           00056         incf FSR,F
                      00057 
                      00058         INDF_BANK_3                             ; neprime adresovani na banku 3 (buffer 1)      
0350   1783               M                         bsf STATUS,IRP    
0351   3094           00059         movlw 0x94                              ; 90h (buffer1) + 4 (pozice kde je ulozen identifikator 
                            souboroveho systemu prvniho zaznamu BR)
0352   0084           00060         movwf FSR
0353   0800           00061         movfw INDF
0354   3C0C           00062         sublw h'0C'                             ; Pokud se FileSystem <> 0Ch...
0355   1D03           00063         btfss STATUS,Z
0356   3C01           00064         sublw .1                                ; ...ani 0Bh...
0357   1D03           00065         btfss STATUS,Z
0358   2B7E           00066         goto SCAN_MBR__HLEDEJ_ROZSIRENY_ODDIL   ; ...tak hledej rozsireny oddil.
                      00067 
                      00068         ; pokud jsme v teto casti programu, tak prvni zaznam MBR/BR obsahuje oddil FAT32, s reprezentaci
                             adres stylem LBA
                      00069         ; Tady pozor, v MBR/BR neni zapsana LBA adresa oddilu, ale relativni vzdalenost (offset) od MBR/
                            BR.
                      00070         ; To znamena, ze k adrese v (M)BR musime pricist offset oddilu.
                      00071         BANK_1
0359   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
035A   1683               M                 bsf     STATUS,RP0    
035B   3098           00072         movlw 0x98                              ; offset prvniho zaznamu 
035C   0084           00073         movwf FSR
035D   0800           00074         movfw INDF
035E   00A0           00075         movwf OPERAND_X1
035F   0A84           00076         incf FSR,F
0360   0800           00077         movfw INDF
0361   00A1           00078         movwf OPERAND_X2
0362   0A84           00079         incf FSR,F
0363   0800           00080         movfw INDF
0364   00A2           00081         movwf OPERAND_X3
0365   0A84           00082         incf FSR,F
0366   0800           00083         movfw INDF
0367   00A3           00084         movwf OPERAND_X4
                      00085         BANK_0
0368   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0369   1283               M                 bcf     STATUS,RP0    
                      00086 
036A   25A1           00087         call SOUCET
                      00088 
                      00089         INDF_BANK_1                             ; neprime adresovani na banku 1 (aritmeticke operace)
036B   1383               M                         bcf STATUS,IRP    
036C   30A8           00090         movlw 0xA8                              ; FSR na VYSLEDEK
036D   0084           00091         movwf FSR       
036E   0800           00092         movfw INDF
036F   00A7           00093         movwf LBA1
0370   0A84           00094         incf FSR,F
0371   0800           00095         movfw INDF
0372   00A8           00096         movwf LBA2
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 38


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0373   0A84           00097         incf FSR,F
0374   0800           00098         movfw INDF
0375   00A9           00099         movwf LBA3
0376   0A84           00100         incf FSR,F
0377   0800           00101         movfw INDF
0378   00AA           00102         movwf LBA4
0379   0A84           00103         incf FSR,F
                      00104 
037A   23A9           00105         call ZKONTROLUJ_ODDIL_FAT32     ; pokud skutecne adresa v LBA1-4 ukazuje na zacatek oddilu s FAT
                            32, tak da do bufferu2 jmenovku a adresu oddilu
                      00106         INDF_BANK_3
037B   1783               M                         bsf STATUS,IRP    
037C   30A4           00107         movlw 0xA4                                      ; 90h (buffer 1) + 16 (velikost 1. zaznamu) + 4 
                            (identifikator souboroveho systemu 2. zaznamu)
037D   0084           00108         movwf FSR
037E                  00109 SCAN_MBR__HLEDEJ_ROZSIRENY_ODDIL                ; jdem v zaznamech MBR/BR hledat rozsireny oddil
                      00110         ; pokud byl v prvnim zaznamu oddil typu FAT32, tak nam  tad FSR ukazuje na FileSystem 2. zaznamu
                            ...
                      00111         ; ...pokud 1. zaznam nebyl typu FAT32, tak nam FSR ukazuje na FileSystem 1. zaznamu.
                      00112         ; Kazdopadne se ted podivame na dalsi zaznam a pokud obsahuje rozsireny oddil, skocime na jeho a
                            dresu a dame goto SCAN_BR ...
037E   0800           00113         movfw INDF
037F   3C05           00114         sublw h'05'                             ; Pokud se FileSystem <> 05h (rozsireny oddil CHS)...
0380   1D03           00115         btfss STATUS,Z
0381   3C0A           00116         sublw h'0A'                             ; ...ani se <> 0Fh (5+A=F) (rozsireny oddil LBA)...
0382   1D03           00117         btfss STATUS,Z
0383   2BA8           00118         goto SCAN_MBR__KONEC    ; ...tak koncime...
                      00119 
0384   0804           00120         movfw FSR                               ; ...pokud tu ale mame rozsireny oddil,...
0385   3E04           00121         addlw .4                                ; ...tak se jdem podivat na jeho adresu.
0386   0084           00122         movwf FSR
                      00123 
                      00124         BANK_1
0387   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0388   1683               M                 bsf     STATUS,RP0    
                      00125         INDF_BANK_3
0389   1783               M                         bsf STATUS,IRP    
038A   0800           00126         movfw INDF
038B   00A0           00127         movwf OPERAND_X1
038C   0A84           00128         incf FSR,F
038D   0800           00129         movfw INDF
038E   00A1           00130         movwf OPERAND_X2
038F   0A84           00131         incf FSR,F
0390   0800           00132         movfw INDF
0391   00A2           00133         movwf OPERAND_X3
0392   0A84           00134         incf FSR,F
0393   0800           00135         movfw INDF
0394   00A3           00136         movwf OPERAND_X4
                      00137         BANK_0
0395   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0396   1283               M                 bcf     STATUS,RP0    
                      00138 
0397   25A1           00139         call SOUCET
                      00140 
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 39


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00141         INDF_BANK_1                             ; neprime adresovani na banku 1 (aritmeticke operace)
0398   1383               M                         bcf STATUS,IRP    
0399   30A8           00142         movlw 0xA8                              ; FSR na VYSLEDEK
039A   0084           00143         movwf FSR       
039B   0800           00144         movfw INDF
039C   00A7           00145         movwf LBA1
039D   0A84           00146         incf FSR,F
039E   0800           00147         movfw INDF
039F   00A8           00148         movwf LBA2
03A0   0A84           00149         incf FSR,F
03A1   0800           00150         movfw INDF
03A2   00A9           00151         movwf LBA3
03A3   0A84           00152         incf FSR,F
03A4   0800           00153         movfw INDF
03A5   00AA           00154         movwf LBA4
03A6   0A84           00155         incf FSR,F
                      00156         
03A7   2B35           00157         goto SCAN_BR                    ; S rozirenym oddilem provedeme totez co s MBR
03A8                  00158 SCAN_MBR__KONEC
03A8   0008           00159         return
                      00160 ;**************************************************************************
03A9                  00161 ZKONTROLUJ_ODDIL_FAT32
                      00162         ; tak ted bychom mely mit v LBA 1-4 adresu spousteciho zaznamu oddilu s FAT32, tak to jdem overi
                            t...
                      00163         ; ...a pokud tam doopravdy spousteci zaznam je, tak dame jmenovku a informace do bufferu 2 na po
                            zici jaka je v rag. POZICE
                      00164         INDF_BANK_2
03A9   1783               M                         bsf STATUS,IRP    
03AA   083B           00165         movfw POZICE
03AB   00B6           00166         movwf TEMP1
03AC   1003           00167         bcf STATUS,C
03AD   0DB6           00168         rlf TEMP1,F
03AE   0DB6           00169         rlf TEMP1,F
03AF   0DB6           00170         rlf TEMP1,F
03B0   0DB6           00171         rlf TEMP1,F                             ; TEMP1 := POZICE *16
03B1   0836           00172         movfw TEMP1
03B2   3E11           00173         addlw 0x11                              ; TEMP1 + pozice bufferu 2 + 1 (pozice kam budeme do buf
                            feru 2 davat adresu oddilu)
03B3   0084           00174         movwf FSR
                      00175 
03B4   0827           00176         movfw LBA1
03B5   0080           00177         movwf INDF
03B6   0A84           00178         incf FSR,F
03B7   0828           00179         movfw LBA2
03B8   0080           00180         movwf INDF
03B9   0A84           00181         incf FSR,F
03BA   0829           00182         movfw LBA3
03BB   0080           00183         movwf INDF
03BC   0A84           00184         incf FSR,F
03BD   082A           00185         movfw LBA4
03BE   0080           00186         movwf INDF
03BF   0A84           00187         incf FSR,F                              ; adresa oddilu je ulozena do bufferu 2, ted tam jdem da
                            vat jmenovku oddilu
                      00188 
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 40


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

03C0   3001           00189         movlw .1
03C1   00A6           00190         movwf SECTOR_C
03C2   2299           00191         call READ_SECTOR
03C3   3023           00192         movlw h'23'
03C4   00B6           00193         movwf TEMP1
03C5   225C           00194         call PRESKOC                    ; informace o FATce co nas ted zrovna moc nezejimaji
                      00195         ; na offsetu 47 je ulozena jmenovka oddilu (11znaku), ted jsme na offsetu 46
                      00196 
03C6   2241           00197         call READ_DATA
03C7   0821           00198         movfw DATA_H
03C8   0080           00199         movwf INDF                              ; 1. znak ze jmenovky svazku
03C9   0A84           00200         incf FSR,F
                      00201 
03CA   3005           00202         movlw .5                                ; dalsich 10 bytu je zbytek jmenovky
03CB   00B6           00203         movwf TEMP1
03CC                  00204 ZKONTROLUJ_ODDIL_FAT32__JMENOVKA
03CC   2241           00205         call READ_DATA
03CD   0820           00206         movfw DATA_L
03CE   0080           00207         movwf INDF
03CF   0A84           00208         incf FSR,F
03D0   0821           00209         movfw DATA_H
03D1   0080           00210         movwf INDF
03D2   0A84           00211         incf FSR,F
03D3   0BB6           00212         decfsz TEMP1,F
03D4   2BCC           00213         goto ZKONTROLUJ_ODDIL_FAT32__JMENOVKA
03D5   3010           00214         movlw .16
03D6   0284           00215         subwf FSR,F                                     ; aby fsr ukazoval na priznak o pravdivosti (FSR
                             := FSR - 16)
                      00216 
03D7   2241           00217         call READ_DATA
03D8   0820           00218         movfw DATA_L
03D9   3C46           00219         sublw 'F'               
03DA   1D03           00220         btfss STATUS,Z
03DB   2BF1           00221         goto ZKONTROLUJ_ODDIL_FAT32__KONEC
03DC   0821           00222         movfw DATA_H
03DD   3C41           00223         sublw 'A'               
03DE   1D03           00224         btfss STATUS,Z
03DF   2BF1           00225         goto ZKONTROLUJ_ODDIL_FAT32__KONEC
                      00226 
03E0   2241           00227         call READ_DATA
03E1   0820           00228         movfw DATA_L
03E2   3C54           00229         sublw 'T'               
03E3   1D03           00230         btfss STATUS,Z
03E4   2BF1           00231         goto ZKONTROLUJ_ODDIL_FAT32__KONEC
03E5   0821           00232         movfw DATA_H
03E6   3C33           00233         sublw '3'               
03E7   1D03           00234         btfss STATUS,Z
03E8   2BF1           00235         goto ZKONTROLUJ_ODDIL_FAT32__KONEC
                      00236 
03E9   2241           00237         call READ_DATA
03EA   0820           00238         movfw DATA_L
03EB   3C32           00239         sublw '2'
03EC   1D03           00240         btfss STATUS,Z
03ED   2BF1           00241         goto ZKONTROLUJ_ODDIL_FAT32__KONEC
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 41


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00242         ; tak, ted uz opravdu vime, ze na tomto sektoru se nachazi spousteci zaznam svazku se souborovym
                             systemem FAT32
                      00243 
03EE   30FF           00244         movlw h'FF'
03EF   0080           00245         movwf INDF
03F0   0ABB           00246         incf POZICE,F                           ; sektor skutecne obsahoval spousteci zaznam svazku...
03F1                  00247 ZKONTROLUJ_ODDIL_FAT32__KONEC
03F1   0008           00248         return
                      00249 ;**************************************************************************
03F2                  00250 NACTI_FAT32
                      00251         ; V LBA1-4 bychom meli dostat adresu prvniho sektoru FAT32 oddilu, kde by se mely nalezat inform
                            ace o fatce
                      00252         ; pokud je FATka pro nas pouzitelna (Clustery nejsou moc velke, sektor = 512B ...) nastavime bit
                             FAT32_LOAD v ATA_ATTRIBUTES
03F2   122E           00253         bcf ATA_ATTRIBUTES,FAT32_LOAD
03F3   01C0           00254         clrf POCATEK_DAT1
03F4   01C1           00255         clrf POCATEK_DAT2
03F5   01C2           00256         clrf POCATEK_DAT3
03F6   01C3           00257         clrf POCATEK_DAT4
03F7   01C4           00258         clrf POCATEK_FAT1
03F8   01C5           00259         clrf POCATEK_FAT2
03F9   01C6           00260         clrf POCATEK_FAT3
03FA   01C7           00261         clrf POCATEK_FAT4
03FB   01C8           00262         clrf ROOT_DIR_CL1
03FC   01C9           00263         clrf ROOT_DIR_CL2
03FD   01CA           00264         clrf ROOT_DIR_CL3
03FE   01CB           00265         clrf ROOT_DIR_CL4
                      00266 
                      00267 
03FF   01A4           00268         clrf FEATURES
0400   3001           00269         movlw .1
0401   00A6           00270         movwf SECTOR_C
0402   2299           00271         call READ_SECTOR
                      00272 
0403   3005           00273         movlw .5
0404   00B6           00274         movwf TEMP1
0405   225C           00275         call PRESKOC
                      00276 
0406   2241           00277         call READ_DATA                          ; 10 bytu precteno
0407   0821           00278         movfw DATA_H                            ; 11,12 byte - velikost sektoru (tady by melo byt 512, a
                            le co kdyby ne...)
0408   39FF           00279         andlw h'FF'
0409   1D03           00280         btfss STATUS,Z
040A   2CB5           00281         goto NACTI_FAT32__KONEC         ; pokud 11 byte neni nula, koncime (velikost sektoru se nerovna 
                            512)
                      00282 
040B   2241           00283         call READ_DATA                          ; ctu 12. a 13. byte
040C   0820           00284         movfw DATA_L
040D   3C02           00285         sublw h'02'
040E   1D03           00286         btfss STATUS,Z
040F   2CB5           00287         goto NACTI_FAT32__KONEC         ; pokud 12 byte neni 2, koncime (velikost sektoru se nerovna 512
                            )
                      00288 
0410   0821           00289         movfw DATA_H                            ; byte 13. SectorsPerCluster
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 42


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0411   00CC           00290         movwf CLUSTER_SIZE
0412   3C20           00291         sublw .32                                       ; nas program neumi vic jak 32 (Velikost cluster
                            u = 16KB)
0413   1C03           00292         btfss STATUS,C
0414   2CB5           00293         goto NACTI_FAT32__KONEC         ; pokud mame clustery vetsi jak 16KB, tak koncime
                      00294 
0415   2241           00295         call READ_DATA                          ; ctu 14. a 15. byte
0416   0820           00296         movfw DATA_L
0417   00C4           00297         movwf POCATEK_FAT1                      ; tady se nachazi pocet rezervovanych sektoru, pak k ZAC
                            ATEK_FAT pricteme adresu zacatku sektoru a mame zacatek fat...
0418   0821           00298         movfw DATA_H
0419   00C5           00299         movwf POCATEK_FAT2
                      00300         
041A   2241           00301         call READ_DATA                          ; ctu 16. a 17. byte
041B   0820           00302         movfw DATA_L                            ; Pocet FAT. byva temer vzdy 2, kdyby ale ne, tak by nam
                             to delalo docela bordel...
041C   3C02           00303         sublw .2
041D   1D03           00304         btfss STATUS,Z
041E   2CB5           00305         goto NACTI_FAT32__KONEC
                      00306 
041F   3009           00307         movlw .9
0420   00B6           00308         movwf TEMP1
0421   225C           00309         call PRESKOC                            ; 18 - 35
                      00310 
0422   2241           00311         call READ_DATA                          ; 36,37 -> velikost FAT (pocet sektoru)
0423   0820           00312         movfw DATA_L
0424   00C0           00313         movwf POCATEK_DAT1
0425   0821           00314         movfw DATA_H
0426   00C1           00315         movwf POCATEK_DAT2      
0427   2241           00316         call READ_DATA                          ; 38,39 -> velikost FAT (pocet sektoru)
0428   0820           00317         movfw DATA_L
0429   00C2           00318         movwf POCATEK_DAT3
042A   0821           00319         movfw DATA_H
042B   00C3           00320         movwf POCATEK_DAT4
                      00321 
042C   2241           00322         call READ_DATA                          ; 40,41
042D   2241           00323         call READ_DATA                          ; 42,43
                      00324 
042E   2241           00325         call READ_DATA                          ; 44,45
042F   0820           00326         movfw DATA_L
0430   00C8           00327         movwf ROOT_DIR_CL1
0431   0821           00328         movfw DATA_H
0432   00C9           00329         movwf ROOT_DIR_CL2
0433   2241           00330         call READ_DATA                          ; 46,47
0434   0820           00331         movfw DATA_L
0435   00CA           00332         movwf ROOT_DIR_CL3
0436   0821           00333         movfw DATA_H
0437   00CB           00334         movwf ROOT_DIR_CL4
                      00335 
0438   3011           00336         movlw .17
0439   00B6           00337         movwf TEMP1
043A   225C           00338         call PRESKOC                            ; 48 - 81
                      00339 
                      00340         ; ted jeste takova mala kontrola...
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 43


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

043B   2241           00341         call READ_DATA
043C   0820           00342         movfw DATA_L
043D   3C46           00343         sublw 'F'               
043E   1D03           00344         btfss STATUS,Z
043F   2CB5           00345         goto NACTI_FAT32__KONEC
0440   0821           00346         movfw DATA_H
0441   3C41           00347         sublw 'A'               
0442   1D03           00348         btfss STATUS,Z
0443   2CB5           00349         goto NACTI_FAT32__KONEC
0444   2241           00350         call READ_DATA
0445   0820           00351         movfw DATA_L
0446   3C54           00352         sublw 'T'               
0447   1D03           00353         btfss STATUS,Z
0448   2CB5           00354         goto NACTI_FAT32__KONEC
0449   0821           00355         movfw DATA_H
044A   3C33           00356         sublw '3'               
044B   1D03           00357         btfss STATUS,Z
044C   2CB5           00358         goto NACTI_FAT32__KONEC
044D   2241           00359         call READ_DATA
044E   0820           00360         movfw DATA_L
044F   3C32           00361         sublw '2'
0450   1D03           00362         btfss STATUS,Z
0451   2CB5           00363         goto NACTI_FAT32__KONEC
                      00364         ; tak, ted uz opravdu vime, ze na tomto sektoru se nachazi spousteci zaznam svazku se souborovym
                             systemem FAT32...
                      00365         ; tak ted jdem vypocitat ty nejdulezitejsi cisla pro praci s FATkou...
                      00366 
                      00367         INDF_BANK_1                                     ; aritmeto/logicke operace
0452   1383               M                         bcf STATUS,IRP    
0453   30A0           00368         movlw 0xA0                                      ; OPERAND_X
0454   0084           00369         movwf FSR
0455   0844           00370         movfw POCATEK_FAT1
0456   0080           00371         movwf INDF
0457   0A84           00372         incf FSR,F
0458   0845           00373         movfw POCATEK_FAT2
0459   0080           00374         movwf INDF
045A   0A84           00375         incf FSR,F
045B   0846           00376         movfw POCATEK_FAT3
045C   0080           00377         movwf INDF
045D   0A84           00378         incf FSR,F
045E   0847           00379         movfw POCATEK_FAT4
045F   0080           00380         movwf INDF
0460   0A84           00381         incf FSR,F
0461   0827           00382         movfw LBA1                                      ; OPERAND_Y
0462   0080           00383         movwf INDF
0463   0A84           00384         incf FSR,F
0464   0828           00385         movfw LBA2
0465   0080           00386         movwf INDF
0466   0A84           00387         incf FSR,F
0467   0829           00388         movfw LBA3
0468   0080           00389         movwf INDF
0469   0A84           00390         incf FSR,F
046A   082A           00391         movfw LBA4
046B   0080           00392         movwf INDF
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 44


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

046C   0A84           00393         incf FSR,F
046D   25A1           00394         call SOUCET                                     ; pricteme k zacatku oddilu pocet rezervovanych 
                            sektoru (obvykle 32) a mame z toho POCATEK_FAT
046E   0800           00395         movfw INDF
046F   00C4           00396         movwf POCATEK_FAT1
0470   0A84           00397         incf FSR,F
0471   0800           00398         movfw INDF
0472   00C5           00399         movwf POCATEK_FAT2
0473   0A84           00400         incf FSR,F
0474   0800           00401         movfw INDF
0475   00C6           00402         movwf POCATEK_FAT3
0476   0A84           00403         incf FSR,F
0477   0800           00404         movfw INDF
0478   00C7           00405         movwf POCATEK_FAT4
0479   0A84           00406         incf FSR,F
                      00407 
                      00408         ; v POCATEK_DAT ted mame hodnotu "velikost fat", tu vynasobime 2 a pricteme POCATEK_FAT. Tak zis
                            kame POCATEK_DAT
047A   30A0           00409         movlw 0xA0                                      ; OPERAND_X
047B   0084           00410         movwf FSR
047C   0840           00411         movfw POCATEK_DAT1
047D   0080           00412         movwf INDF
047E   0A84           00413         incf FSR,F
047F   0841           00414         movfw POCATEK_DAT2
0480   0080           00415         movwf INDF
0481   0A84           00416         incf FSR,F
0482   0842           00417         movfw POCATEK_DAT3
0483   0080           00418         movwf INDF
0484   0A84           00419         incf FSR,F
0485   0843           00420         movfw POCATEK_DAT4
0486   0080           00421         movwf INDF
0487   0A84           00422         incf FSR,F
0488   2609           00423         call POSUNDOLEVA_1                      ; X := X * 2 -> POCATEK_DAT := 2 * "velikost fat"
                      00424                                                                 ; ted jeste staci pricist POCATEK_FAT
0489   0844           00425         movfw POCATEK_FAT1
048A   0080           00426         movwf INDF
048B   0A84           00427         incf FSR,F
048C   0845           00428         movfw POCATEK_FAT2
048D   0080           00429         movwf INDF
048E   0A84           00430         incf FSR,F
048F   0846           00431         movfw POCATEK_FAT3
0490   0080           00432         movwf INDF
0491   0A84           00433         incf FSR,F
0492   0847           00434         movfw POCATEK_FAT4
0493   0080           00435         movwf INDF
0494   0A84           00436         incf FSR,F
0495   25A1           00437         call SOUCET
                      00438 
                      00439         ;   tady je pro me jedna zcela nepochopitelna vlastnost FATky, a to to, ze prvni dva zaznamy (nu
                            lty a prvni)
                      00440         ;   ve FAT tabulce jsou obsazeny nejakyma srotama (identifikator FATky), coz by nebylo to nejhor
                            si, ale data na disku
                      00441         ;   zacinaji jiz na nultym clusteru. (POCATEK_DAT) Dochazi tedy k tomu, ze nulty cluster na disk
                            u je reprezentovan na druhe
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 45


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00442         ;   pozici ve fatce a to cislem dve!!! Od udaje ve fatce bychom musime tedy vzdy odecist hodnotu
                             2
                      00443         ;   a ziskali bychom skutecnou polohu dat na disku.... (Je to pekne na vyliz!!!!!!!!)
                      00444         ;   Ja to tady resim tak, ze zacatek dat posunu o 2 clustery niz (POCATEK_DAT := POCATEK_DAT - 2
                            *VELIKOST_CLUSTERU),
                      00445         ;   aby udaje souhlasily a my nemuseli nic prepocitavat. 
                      00446         ;   Pak tu nastava jeste jeden problem, ROOT adresar byva adresovan jako by byl na clusteru 0, p
                            roto pokazdy kdyz je 
                      00447         ;   nekde cislo clusteru 0, tak skocime na prvni cluster root adresare. (Vetsinou 2. cluster)
                      00448         ;   O tomto jevu jsem nikde necetl, ale proste to tak je. Z toho vyplyva, ze zadny soubor nemuze
                             byt na slusteru 1...
                      00449         
                      00450         ; Tak ted mame v POCATEK_DAT = POCATEK_FAT + (velikostFat * 2)
                      00451         ; a ted jeste musime odecist 2 * velikost_clusteru
                      00452 
0496   0D4C           00453         rlf CLUSTER_SIZE,W              ; W := CLUSTER_SIZE * 2
                      00454         BANK_1
0497   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0498   1683               M                 bsf     STATUS,RP0    
0499   00A4           00455         movwf OPERAND_Y1
049A   01A5           00456         clrf OPERAND_Y2
049B   01A6           00457         clrf OPERAND_Y3
049C   01A7           00458         clrf OPERAND_Y4
049D   0828           00459         movfw VYSLEDEK1
049E   00A0           00460         movwf OPERAND_X1
049F   0829           00461         movfw VYSLEDEK2
04A0   00A1           00462         movwf OPERAND_X2
04A1   082A           00463         movfw VYSLEDEK3
04A2   00A2           00464         movwf OPERAND_X3
04A3   082B           00465         movfw VYSLEDEK4
04A4   00A3           00466         movwf OPERAND_X4
                      00467         BANK_0
04A5   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
04A6   1283               M                 bcf     STATUS,RP0    
04A7   25CA           00468         call ROZDIL                             ; VYSLEDEK := POCATEK_FAT + (2 * velikostFat) - (2 * CLU
                            STER_SIZE)
04A8   0800           00469         movfw INDF
04A9   00C0           00470         movwf POCATEK_DAT1
04AA   0A84           00471         incf FSR,F
04AB   0800           00472         movfw INDF
04AC   00C1           00473         movwf POCATEK_DAT2
04AD   0A84           00474         incf FSR,F
04AE   0800           00475         movfw INDF
04AF   00C2           00476         movwf POCATEK_DAT3
04B0   0A84           00477         incf FSR,F
04B1   0800           00478         movfw INDF
04B2   00C3           00479         movwf POCATEK_DAT4
04B3   0A84           00480         incf FSR,F
                      00481         
                      00482         ; Tak ted uz to konecne mame, muzeme se pustit do prohlizeni adresaru a souboru...
                      00483 
04B4   162E           00484         bsf ATA_ATTRIBUTES,FAT32_LOAD   
04B5                  00485 NACTI_FAT32__KONEC
04B5   0008           00486         return  
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 46


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00487 ;**************************************************************************
04B6                  00488 CLUSTER_TO_LBA
                      00489         ; vezme hodnoty v CLUSTER[1-4] a POZICE (sektor v clusteru) a do LBA 1-4 vypocita skutecnou pozi
                            ci na disku
                      00490         ; pro spravnou funkci musi byt POZICE < CLUSTER_SIZE (POZICE muze byt v rozsahu 0 .. CLUSTER_SIZ
                            E - 1)
                      00491         ; LBA := POCATEK_DAT + (CLUSTER * CLUSTER_SIZE) + POZICE
                      00492         INDF_BANK_1                             ; neprime adresovani do banku1
04B6   1383               M                         bcf STATUS,IRP    
04B7   30A0           00493         movlw 0xA0                                      ; OPERAND_X
04B8   0084           00494         movwf FSR
04B9   083C           00495         movfw CLUSTER1
04BA   0080           00496         movwf INDF
04BB   0A84           00497         incf FSR,F
04BC   083D           00498         movfw CLUSTER2
04BD   0080           00499         movwf INDF
04BE   0A84           00500         incf FSR,F
04BF   083E           00501         movfw CLUSTER3
04C0   0080           00502         movwf INDF
04C1   0A84           00503         incf FSR,F
04C2   083F           00504         movfw CLUSTER4
04C3   0080           00505         movwf INDF
04C4   0A84           00506         incf FSR,F
                      00507 
                      00508         ; Nejdriv se koukneme zda-li CLUSTER se nerovna 0, to bychom pak vratily 
                      00509         ; pozici na prvnim clusteru root adresare...
04C5   26B0           00510         call NULA                                               ; if (X =  0) then PRETECENI := 0 else P
                            RETECENI := 1
                      00511         BANK_1
04C6   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
04C7   1683               M                 bsf     STATUS,RP0    
04C8   182C           00512         btfsc PRETECENI,0
04C9   2CDA           00513         goto CLUSTER_TO_LBA_NO_ROOT
                      00514         BANK_0
04CA   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
04CB   1283               M                 bcf     STATUS,RP0    
04CC   30A0           00515         movlw 0xA0                                      ; OPERAND_X
04CD   0084           00516         movwf FSR
04CE   0848           00517         movfw ROOT_DIR_CL1
04CF   0080           00518         movwf INDF
04D0   0A84           00519         incf FSR,F
04D1   0849           00520         movfw ROOT_DIR_CL2
04D2   0080           00521         movwf INDF
04D3   0A84           00522         incf FSR,F
04D4   084A           00523         movfw ROOT_DIR_CL3
04D5   0080           00524         movwf INDF
04D6   0A84           00525         incf FSR,F
04D7   084B           00526         movfw ROOT_DIR_CL4
04D8   0080           00527         movwf INDF
04D9   0A84           00528         incf FSR,F
                      00529                 
04DA                  00530 CLUSTER_TO_LBA_NO_ROOT
                      00531         BANK_0
04DA   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 47


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

04DB   1283               M                 bcf     STATUS,RP0    
                      00532         ; CLUSTER_SIZE je vzdy exponentem 2 (1,2,4,8,16,32,64,128), proto tento jednoduchy zapis
04DC   18CC           00533         btfsc CLUSTER_SIZE,1            ; 2
04DD   2609           00534         call POSUNDOLEVA_1                      ; X := X * 2
04DE   194C           00535         btfsc CLUSTER_SIZE,2            ; 4
04DF   2611           00536         call POSUNDOLEVA_2                      ; X := X * 4
04E0   19CC           00537         btfsc CLUSTER_SIZE,3            ; 8
04E1   261A           00538         call POSUNDOLEVA_3                      ; X := X * 8
04E2   1A4C           00539         btfsc CLUSTER_SIZE,4            ; 16
04E3   2624           00540         call POSUNDOLEVA_4                      ; X := X * 4
04E4   1ACC           00541         btfsc CLUSTER_SIZE,5            ; 32
04E5   262F           00542         call POSUNDOLEVA_5                      ; X := X * 32
04E6   1B4C           00543         btfsc CLUSTER_SIZE,6            ; 64
04E7   263B           00544         call POSUNDOLEVA_6                      ; X := X * 64
04E8   1BCC           00545         btfsc CLUSTER_SIZE,7            ; 128
04E9   2648           00546         call POSUNDOLEVA_7                      ; X := X * 128
                      00547         
04EA   0840           00548         movfw POCATEK_DAT1
04EB   0080           00549         movwf INDF                                      ; OPERAND_Y
04EC   0A84           00550         incf FSR,F
04ED   0841           00551         movfw POCATEK_DAT2
04EE   0080           00552         movwf INDF
04EF   0A84           00553         incf FSR,F
04F0   0842           00554         movfw POCATEK_DAT3
04F1   0080           00555         movwf INDF
04F2   0A84           00556         incf FSR,F
04F3   0843           00557         movfw POCATEK_DAT4
04F4   0080           00558         movwf INDF
04F5   0A84           00559         incf FSR,F
                      00560 
04F6   25A1           00561         call SOUCET                                     ; VYSLEDEK := POCATEK_DAT + (CLUSTER * CLUSTER_S
                            IZE)
                      00562 
                      00563         ; zbyva tedy k vysledku pricist POZICE a dat nasledny vysledek do LBA    
04F7   083B           00564         movfw POZICE
                      00565         BANK_1
04F8   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
04F9   1683               M                 bsf     STATUS,RP0    
04FA   00A4           00566         movwf OPERAND_Y1
04FB   01A5           00567         clrf OPERAND_Y2
04FC   01A6           00568         clrf OPERAND_Y3
04FD   01A7           00569         clrf OPERAND_Y4
04FE   0828           00570         movfw VYSLEDEK1
04FF   00A0           00571         movwf OPERAND_X1
0500   0829           00572         movfw VYSLEDEK2
0501   00A1           00573         movwf OPERAND_X2
0502   082A           00574         movfw VYSLEDEK3
0503   00A2           00575         movwf OPERAND_X3
0504   082B           00576         movfw VYSLEDEK4
0505   00A3           00577         movwf OPERAND_X4        
                      00578         BANK_0
0506   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0507   1283               M                 bcf     STATUS,RP0    
0508   25A1           00579         call SOUCET
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 48


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00580 
                      00581         INDF_BANK_1                             ; neprime adresovani do banku1
0509   1383               M                         bcf STATUS,IRP    
050A   30A8           00582         movlw 0xA8                                      ; VYSLEDEK
050B   0084           00583         movwf FSR
050C   0800           00584         movfw INDF
050D   00A7           00585         movwf LBA1
050E   0A84           00586         incf FSR,F
050F   0800           00587         movfw INDF
0510   00A8           00588         movwf LBA2
0511   0A84           00589         incf FSR,F
0512   0800           00590         movfw INDF
0513   00A9           00591         movwf LBA3
0514   0A84           00592         incf FSR,F
0515   0800           00593         movfw INDF
0516   00AA           00594         movwf LBA4
0517   0A84           00595         incf FSR,F
                      00596         
0518   0008           00597         return
                      00598 ;**************************************************************************
0519                  00599 NEXT_CLUSTER
                      00600         ; V CLUSTER prijme cislo clusteru, podiva se do FATky na disku a v CLUSTER vrati 
                      00601         ; hodnotu clustru, ktery nasleduje v retezu clusteru.
                      00602         ; Pokud pozadovany cluster byl posledni v retezu vrati v reg. POZICE konstantu FFh
                      00603         ; Pokud soucasny cluster je prazdny (coz by se stat nemelo) vrati taky v POZICE FFh
                      00604         ; Jinak, pokud s vse povede, dame do POZICE 0
                      00605 
                      00606         ; ! PODPROGRAM NETESTUJE ZDA NEBYLO ZADANO VETSI CISLO NEZ JE POCET CLUSTERU !!!
                      00607         
0519   01BB           00608         clrf POZICE
                      00609         ; LBA := [(CLUSTER * 4) / 512 ] + POCATEK_FAT
                      00610         ; LBA := ( CLUSTER / 128 ) + POCATEK_FAT
                      00611         ; offset := CLUSTER mod 128 
                      00612         INDF_BANK_1                             ; neprime adresovani do banku1
051A   1383               M                         bcf STATUS,IRP    
051B   30A0           00613         movlw 0xA0                                      ; OPERAND_X
051C   0084           00614         movwf FSR
051D   083C           00615         movfw CLUSTER1
051E   0080           00616         movwf INDF
051F   0A84           00617         incf FSR,F
0520   083D           00618         movfw CLUSTER2
0521   0080           00619         movwf INDF
0522   0A84           00620         incf FSR,F
0523   083E           00621         movfw CLUSTER3
0524   0080           00622         movwf INDF
0525   0A84           00623         incf FSR,F
0526   083F           00624         movfw CLUSTER4
0527   0080           00625         movwf INDF
                      00626 
                      00627         ; Nejdriv se koukneme zda-li CLUSTER se nerovna 0, to pak musime jako cluster brat prvni cluster
                             ROOT adr.
0528   26B0           00628         call NULA                                               ; if (X =  0) then PRETECENI := 0 else P
                            RETECENI := 1
                      00629         BANK_1
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 49


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0529   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
052A   1683               M                 bsf     STATUS,RP0    
052B   182C           00630         btfsc PRETECENI,0
052C   2D3D           00631         goto NEXT_CLUSTER_NO_ROOT
                      00632         BANK_0
052D   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
052E   1283               M                 bcf     STATUS,RP0    
052F   30A0           00633         movlw 0xA0                                      ; OPERAND_X
0530   0084           00634         movwf FSR
0531   0848           00635         movfw ROOT_DIR_CL1
0532   0080           00636         movwf INDF
0533   0A84           00637         incf FSR,F
0534   0849           00638         movfw ROOT_DIR_CL2
0535   0080           00639         movwf INDF
0536   0A84           00640         incf FSR,F
0537   084A           00641         movfw ROOT_DIR_CL3
0538   0080           00642         movwf INDF
0539   0A84           00643         incf FSR,F
053A   084B           00644         movfw ROOT_DIR_CL4
053B   0080           00645         movwf INDF
053C   0A84           00646         incf FSR,F
                      00647                 
053D                  00648 NEXT_CLUSTER_NO_ROOT
                      00649         BANK_0
053D   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
053E   1283               M                 bcf     STATUS,RP0    
                      00650         
053F   26A1           00651         call POSUNDOPRAVA_7     ; X := X div 128  ; PRETECENI := X mod 128
0540   30AC           00652         movlw 0xAC                                      ; PRETECENI
0541   0084           00653         movwf FSR
0542   0800           00654         movfw INDF
0543   00B6           00655         movwf TEMP1
                      00656 
0544   30A4           00657         movlw 0xA4                                      ; OPERAND_Y
0545   0084           00658         movwf FSR
0546   0844           00659         movfw POCATEK_FAT1
0547   0080           00660         movwf INDF
0548   0A84           00661         incf FSR,F
0549   0845           00662         movfw POCATEK_FAT2
054A   0080           00663         movwf INDF
054B   0A84           00664         incf FSR,F
054C   0846           00665         movfw POCATEK_FAT3
054D   0080           00666         movwf INDF
054E   0A84           00667         incf FSR,F
054F   0847           00668         movfw POCATEK_FAT4
0550   0080           00669         movwf INDF
0551   0A84           00670         incf FSR,F
                      00671 
0552   25A1           00672         call SOUCET
                      00673         
0553   0800           00674         movfw INDF                                      ; FSR ukazuje na VYSLEDEK
0554   00A7           00675         movwf LBA1
0555   0A84           00676         incf FSR,F
0556   0800           00677         movfw INDF
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 50


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0557   00A8           00678         movwf LBA2
0558   0A84           00679         incf FSR,F
0559   0800           00680         movfw INDF
055A   00A9           00681         movwf LBA3
055B   0A84           00682         incf FSR,F
055C   0800           00683         movfw INDF
055D   00AA           00684         movwf LBA4
055E   0A84           00685         incf FSR,F
                      00686         
055F   01A4           00687         clrf FEATURES
0560   3001           00688         movlw .1
0561   00A6           00689         movwf SECTOR_C
0562   2299           00690         call READ_SECTOR
                      00691 
0563   1003           00692         bcf STATUS,C                            ; TEMP1 := CLUSTER mod 128 (TEMP1 je v intervalu 0..127)
0564   0D36           00693         rlf TEMP1,W                                     ; W := TEMP1 * 2
0565   00B6           00694         movwf TEMP1
0566   39FF           00695         andlw h'FF'
0567   1D03           00696         btfss STATUS,Z
0568   225C           00697         call PRESKOC                            ; pokud je zaznam o clusteru na nulte pozici v sektoru, 
                            nic preskakovat nebudem...
                      00698 
                      00699 
0569   30A0           00700         movlw 0xA0                                      ; OPERAND_X
056A   0084           00701         movwf FSR               
056B   2241           00702         call READ_DATA  
056C   0820           00703         movfw DATA_L
056D   0080           00704         movwf INDF
056E   00BC           00705         movwf CLUSTER1
056F   0A84           00706         incf FSR,F
0570   0821           00707         movfw DATA_H
0571   0080           00708         movwf INDF
0572   00BD           00709         movwf CLUSTER2
0573   0A84           00710         incf FSR,F      
0574   2241           00711         call READ_DATA  
0575   0820           00712         movfw DATA_L
0576   0080           00713         movwf INDF
0577   00BE           00714         movwf CLUSTER3
0578   0A84           00715         incf FSR,F
0579   0821           00716         movfw DATA_H
057A   0080           00717         movwf INDF
057B   00BF           00718         movwf CLUSTER4
057C   0A84           00719         incf FSR,F
                      00720 
                      00721         ; ted mame hodnotu clusteru ktery nam byl na pocatku predan v reg. CLUSTER, podivame se zda neby
                            l nasledkem 
                      00722         ; nejake chyby prazdny, nebo zda neni posledni v alokacnim retezu
057D   26B0           00723         call NULA                                               ; if (OPERAND_X =  0) then PRETECENI := 
                            0 else PRETECENI := 1
                      00724         BANK_1
057E   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
057F   1683               M                 bsf     STATUS,RP0    
0580   182C           00725         btfsc PRETECENI,0
0581   2D87           00726         goto NEXT_CLUSTER_NEPRAZDNY
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 51


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00727         BANK_0
0582   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0583   1283               M                 bcf     STATUS,RP0    
0584   30FF           00728         movlw h'FF'
0585   00BB           00729         movwf POZICE
0586   2D9E           00730         goto NEXT_CLUSTER_KONEC                 ; Nevim sice jak by se toto mohlo stat, ale cluster byl 
                            prazdny, proto neni jiz co resit..
0587                  00731 NEXT_CLUSTER_NEPRAZDNY
                      00732         BANK_0
0587   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0588   1283               M                 bcf     STATUS,RP0    
                      00733         ; Ted se podivame zda cluster nebyl posledni v alokacnim retezu -> cluster >= 0x0FFFFFF7
0589   30F7           00734         movlw 0xF7
058A   0080           00735         movwf INDF
058B   0A84           00736         incf FSR,F
058C   30FF           00737         movlw 0xFF
058D   0080           00738         movwf INDF
058E   0A84           00739         incf FSR,F
058F   30FF           00740         movlw 0xFF
0590   0080           00741         movwf INDF
0591   0A84           00742         incf FSR,F
0592   300F           00743         movlw 0x0F
0593   0080           00744         movwf INDF
0594   0A84           00745         incf FSR,F
                      00746         
0595   25CA           00747         call ROZDIL                                             ; VYSLEDEK := X - Y 
                      00748                                                                         ; pri podteceni PRETECENI = 1 ( 
                            VYSLEDEK < 0 => PRETECENI = 1 )
                      00749         BANK_1
0596   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0597   1683               M                 bsf     STATUS,RP0    
0598   182C           00750         btfsc PRETECENI,0
0599   2D9E           00751         goto NEXT_CLUSTER_KONEC
                      00752         BANK_0
059A   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
059B   1283               M                 bcf     STATUS,RP0    
059C   30FF           00753         movlw h'FF'
059D   00BB           00754         movwf POZICE
059E                  00755 NEXT_CLUSTER_KONEC
                      00756         BANK_0
059E   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
059F   1283               M                 bcf     STATUS,RP0    
05A0   0008           00757         return
                      00758 ;**************************************************************************
                      00070         include "aritmetic.asm" ; podprogramy vykonavajici zakladni aritmetologicke operace
                      00001 ;**********************************************************
                      00002 ;**********************************************************
                      00003 ;**********************************************************
                      00004 ; Obsahuje podrogramy realizujici zakladni aritmeticke operace
                      00005 ; pouzivane v mp3 preprcavaci. Vsechny operace se provadi 
                      00006 ; s 32bitovymi cisly.
                      00007 ; 
                      00008 ; Pro praci aritmetickych procedur je rezervovana BANKA 1 !!!!!
                      00009 ;**********************************************************
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 52


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00010 ;**********************************************************
                      00011 ;**********************************************************
05A1                  00012 SOUCET
                      00013 ; provede soucet hodnoty v registrech OPERAND_X[1..4] 
                      00014 ; s hodnotou v OPERAND_Y[1..4] a umisti do VYSLEDEK[1..4] 
                      00015 ; pokud dojde k preteceni, nastavi se PRETECENI do 1
                      00016 ; (byty s indexem 1 maji nejnizsi vahu)
                      00017         BANK_1
05A1   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
05A2   1683               M                 bsf     STATUS,RP0    
05A3   01AC           00018         clrf PRETECENI
                      00019 
05A4   0820           00020         movfw OPERAND_X1
05A5   0724           00021         addwf OPERAND_Y1,W
05A6   00A8           00022         movwf VYSLEDEK1
05A7   1803           00023         btfsc STATUS,C
05A8   14AC           00024                 bsf PRETECENI,1
                      00025 
05A9   0821           00026         movfw OPERAND_X2
05AA   0725           00027         addwf OPERAND_Y2,W
05AB   00A9           00028         movwf VYSLEDEK2
05AC   1803           00029         btfsc STATUS,C
05AD   142C           00030                 bsf PRETECENI,0
05AE   18AC           00031         btfsc PRETECENI,1
05AF   0AA9           00032                 incf VYSLEDEK2,F
05B0   1803           00033         btfsc STATUS,C
05B1   142C           00034                 bsf PRETECENI,0
05B2   10AC           00035         bcf PRETECENI,1
                      00036 
05B3   0822           00037         movfw OPERAND_X3
05B4   0726           00038         addwf OPERAND_Y3,W
05B5   00AA           00039         movwf VYSLEDEK3
05B6   1803           00040         btfsc STATUS,C
05B7   14AC           00041                 bsf PRETECENI,1
05B8   182C           00042         btfsc PRETECENI,0
05B9   0AAA           00043                 incf VYSLEDEK3,F
05BA   1803           00044         btfsc STATUS,C
05BB   14AC           00045                 bsf PRETECENI,1
05BC   102C           00046         bcf PRETECENI,0
                      00047 
05BD   0823           00048         movfw OPERAND_X4
05BE   0727           00049         addwf OPERAND_Y4,W
05BF   00AB           00050         movwf VYSLEDEK4
05C0   1803           00051         btfsc STATUS,C
05C1   142C           00052                 bsf PRETECENI,0
05C2   18AC           00053         btfsc PRETECENI,1
05C3   0AAB           00054                 incf VYSLEDEK4,F
05C4   1803           00055         btfsc STATUS,C
05C5   142C           00056                 bsf PRETECENI,0
05C6   10AC           00057         bcf PRETECENI,1 
                      00058 
                      00059         BANK_0
05C7   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
05C8   1283               M                 bcf     STATUS,RP0    
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 53


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

05C9   0008           00060         return
                      00061 ;**********************************************************
                      00062 ;**********************************************************
05CA                  00063 ROZDIL  ; VYSLEDEK := X - Y
                      00064                 ; pri podteceni PRETECENI = 1 ( VYSLEDEK < 0 => PRETECENI = 1 )
                      00065         BANK_1
05CA   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
05CB   1683               M                 bsf     STATUS,RP0    
05CC   01AC           00066         clrf PRETECENI
                      00067 
05CD   0824           00068         movfw OPERAND_Y1
05CE   0220           00069         subwf OPERAND_X1,W      ; W = X - Y     
05CF   00A8           00070         movwf VYSLEDEK1
05D0   1C03           00071         btfss STATUS,C
05D1   14AC           00072                 bsf PRETECENI,1
                      00073         
05D2   0825           00074         movfw OPERAND_Y2
05D3   0221           00075         subwf OPERAND_X2,W      ; W = X - Y     
05D4   00A9           00076         movwf VYSLEDEK2
05D5   1C03           00077         btfss STATUS,C
05D6   142C           00078                 bsf PRETECENI,0
05D7   18AC           00079         btfsc PRETECENI,1
05D8   03A9           00080                 decf VYSLEDEK2,F
05D9   1C03           00081         btfss STATUS,C
05DA   142C           00082                 bsf PRETECENI,0
05DB   10AC           00083         bcf PRETECENI,1 
                      00084         
05DC   0826           00085         movfw OPERAND_Y3
05DD   0222           00086         subwf OPERAND_X3,W      ; W = X - Y     
05DE   00AA           00087         movwf VYSLEDEK3
05DF   1C03           00088         btfss STATUS,C
05E0   14AC           00089                 bsf PRETECENI,1
05E1   182C           00090         btfsc PRETECENI,0
05E2   03AA           00091                 decf VYSLEDEK3,F
05E3   1C03           00092         btfss STATUS,C
05E4   14AC           00093                 bsf PRETECENI,1
05E5   102C           00094         bcf PRETECENI,0
                      00095         
05E6   0827           00096         movfw OPERAND_Y4
05E7   0223           00097         subwf OPERAND_X4,W      ; W = X - Y     
05E8   00AB           00098         movwf VYSLEDEK4
05E9   1C03           00099         btfss STATUS,C
05EA   142C           00100                 bsf PRETECENI,0
05EB   18AC           00101         btfsc PRETECENI,1
05EC   03AB           00102                 decf VYSLEDEK4,F
05ED   1C03           00103         btfss STATUS,C
05EE   142C           00104                 bsf PRETECENI,0
05EF   10AC           00105         bcf PRETECENI,1 
                      00106         
                      00107         BANK_0
05F0   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
05F1   1283               M                 bcf     STATUS,RP0    
05F2   0008           00108         return
                      00109 ;**********************************************************
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 54


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

05F3                  00110 DEKREMENTUJ     ; X := X - 1
                      00111         BANK_1
05F3   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
05F4   1683               M                 bsf     STATUS,RP0    
05F5   3001           00112         movlw .1
                      00113 
05F6   02A0           00114         subwf OPERAND_X1,f
05F7   1803           00115         btfsc STATUS,C
05F8   2E00           00116         goto DEKREMENTUJ_KONEC
                      00117         
05F9   02A1           00118         subwf OPERAND_X2,f
05FA   1803           00119         btfsc STATUS,C
05FB   2E00           00120         goto DEKREMENTUJ_KONEC
                      00121 
05FC   02A2           00122         subwf OPERAND_X3,f
05FD   1803           00123         btfsc STATUS,C
05FE   2E00           00124         goto DEKREMENTUJ_KONEC
                      00125 
05FF   02A3           00126         subwf OPERAND_X4,f
0600                  00127 DEKREMENTUJ_KONEC
                      00128         BANK_0
0600   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0601   1283               M                 bcf     STATUS,RP0    
0602   0008           00129         return
                      00130 ;**********************************************************
0603                  00131 POSUNDOLEVA     ; X := (X * 2) mod 0xFFFFFFFF , PRETECENI := (X * 2) div 0xFFFFFFFF
                      00132                         ; tento podprogram nepouzivat, primo v hlavnim programu
                      00133                         ; musi se nastavit BANK_1 a vymazat PRETECENI!!!
                      00134                         ; (je pouze pro pouziti v nasobicich podprogramech)
                      00135                         ; pouzivat jen POSUNDOLEVA_1, 2, 3, 4 
0603   0DA0           00136         rlf OPERAND_X1,F
0604   0DA1           00137         rlf OPERAND_X2,F
0605   0DA2           00138         rlf OPERAND_X3,F
0606   0DA3           00139         rlf OPERAND_X4,F
0607   0DAC           00140         rlf PRETECENI,F 
0608   0008           00141         return
                      00142 ;**********************************************************
0609                  00143 POSUNDOLEVA_1   ; X := X * 2
                      00144                                 ; X > 0xFFFF FFFF => PRETECENI obsahuje bity navic
                      00145         BANK_1
0609   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
060A   1683               M                 bsf     STATUS,RP0    
060B   01AC           00146         clrf PRETECENI
060C   1003           00147         bcf STATUS,C
                      00148         
060D   2603           00149         call POSUNDOLEVA
                      00150 
                      00151         BANK_0
060E   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
060F   1283               M                 bcf     STATUS,RP0    
0610   0008           00152         return
                      00153 ;**********************************************************
0611                  00154 POSUNDOLEVA_2   ; X := X * 4
                      00155                                 ; X > 0xFFFF FFFF => PRETECENI obsahuje bity navic
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 55


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00156         BANK_1
0611   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0612   1683               M                 bsf     STATUS,RP0    
0613   01AC           00157         clrf PRETECENI
0614   1003           00158         bcf STATUS,C
                      00159         
0615   2603           00160         call POSUNDOLEVA
0616   2603           00161         call POSUNDOLEVA
                      00162 
                      00163         BANK_0
0617   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0618   1283               M                 bcf     STATUS,RP0    
0619   0008           00164         return
                      00165 ;**********************************************************
061A                  00166 POSUNDOLEVA_3   ; X := X * 8
                      00167                                 ; X > 0xFFFF FFFF => PRETECENI obsahuje bity navic
                      00168         BANK_1
061A   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
061B   1683               M                 bsf     STATUS,RP0    
061C   01AC           00169         clrf PRETECENI
061D   1003           00170         bcf STATUS,C
                      00171         
061E   2603           00172         call POSUNDOLEVA
061F   2603           00173         call POSUNDOLEVA
0620   2603           00174         call POSUNDOLEVA
                      00175 
                      00176         BANK_0
0621   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0622   1283               M                 bcf     STATUS,RP0    
0623   0008           00177         return
                      00178 ;**********************************************************
0624                  00179 POSUNDOLEVA_4   ; X := X * 16
                      00180                                 ; X > 0xFFFF FFFF => PRETECENI obsahuje bity navic
                      00181         BANK_1
0624   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0625   1683               M                 bsf     STATUS,RP0    
0626   01AC           00182         clrf PRETECENI
0627   1003           00183         bcf STATUS,C
                      00184         
0628   2603           00185         call POSUNDOLEVA
0629   2603           00186         call POSUNDOLEVA
062A   2603           00187         call POSUNDOLEVA
062B   2603           00188         call POSUNDOLEVA
                      00189 
                      00190         BANK_0
062C   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
062D   1283               M                 bcf     STATUS,RP0    
062E   0008           00191         return
                      00192 ;**********************************************************
062F                  00193 POSUNDOLEVA_5   ; X := X * 32
                      00194                                 ; X > 0xFFFF FFFF => PRETECENI obsahuje bity navic
                      00195         BANK_1
062F   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0630   1683               M                 bsf     STATUS,RP0    
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 56


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0631   01AC           00196         clrf PRETECENI
0632   1003           00197         bcf STATUS,C
                      00198         
0633   2603           00199         call POSUNDOLEVA
0634   2603           00200         call POSUNDOLEVA
0635   2603           00201         call POSUNDOLEVA
0636   2603           00202         call POSUNDOLEVA
0637   2603           00203         call POSUNDOLEVA
                      00204 
                      00205         BANK_0
0638   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0639   1283               M                 bcf     STATUS,RP0    
063A   0008           00206         return
                      00207 ;**********************************************************
063B                  00208 POSUNDOLEVA_6   ; X := X * 64
                      00209                                 ; X > 0xFFFF FFFF => PRETECENI obsahuje bity navic
                      00210         BANK_1
063B   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
063C   1683               M                 bsf     STATUS,RP0    
063D   01AC           00211         clrf PRETECENI
063E   1003           00212         bcf STATUS,C
                      00213         
063F   2603           00214         call POSUNDOLEVA
0640   2603           00215         call POSUNDOLEVA
0641   2603           00216         call POSUNDOLEVA
0642   2603           00217         call POSUNDOLEVA
0643   2603           00218         call POSUNDOLEVA
0644   2603           00219         call POSUNDOLEVA
                      00220 
                      00221         BANK_0
0645   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0646   1283               M                 bcf     STATUS,RP0    
0647   0008           00222         return
                      00223 ;**********************************************************
0648                  00224 POSUNDOLEVA_7   ; X := X * 128
                      00225                                 ; X > 0xFFFF FFFF => PRETECENI obsahuje bity navic
                      00226         BANK_1
0648   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0649   1683               M                 bsf     STATUS,RP0    
064A   01AC           00227         clrf PRETECENI
064B   1003           00228         bcf STATUS,C
                      00229         
064C   2603           00230         call POSUNDOLEVA
064D   2603           00231         call POSUNDOLEVA
064E   2603           00232         call POSUNDOLEVA
064F   2603           00233         call POSUNDOLEVA
0650   2603           00234         call POSUNDOLEVA
0651   2603           00235         call POSUNDOLEVA
0652   2603           00236         call POSUNDOLEVA
                      00237 
                      00238         BANK_0
0653   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0654   1283               M                 bcf     STATUS,RP0    
0655   0008           00239         return
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 57


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00240 ;**********************************************************
0656                  00241 POSUNDOPRAVA    ; X := X div 2 , PRETECENI := X mod 2
                      00242                         ; tento podprogram nepouzivat, primo v hlavnim programu
                      00243                         ; musi se nastavit BANK_1 a vymazat PRETECENI!!!
                      00244                         ; (je pouze pro pouziti v nasobicich podprogramech)
                      00245                         ; pouzivat jen POSUNDOPRAVA_1, 2, 3, 4 
0656   1003           00246         bcf STATUS,C
0657   0CA3           00247         rrf OPERAND_X4,F
0658   0CA2           00248         rrf OPERAND_X3,F
0659   0CA1           00249         rrf OPERAND_X2,F
065A   0CA0           00250         rrf OPERAND_X1,F
065B   0008           00251         return
                      00252 ;**********************************************************
065C                  00253 POSUNDOPRAVA_1  ; X := X div 2
                      00254                                 ; PRETECENI := X mod 2
                      00255         BANK_1
065C   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
065D   1683               M                 bsf     STATUS,RP0    
065E   0820           00256         movfw OPERAND_X1
065F   3901           00257         andlw b'00000001'
0660   00AC           00258         movwf PRETECENI         ; PRETECENI := X mod 2
                      00259         
0661   2656           00260         call POSUNDOPRAVA
                      00261 
                      00262         BANK_0
0662   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0663   1283               M                 bcf     STATUS,RP0    
0664   0008           00263         return
                      00264 ;**********************************************************
0665                  00265 POSUNDOPRAVA_2  ; X := X div 4
                      00266                                 ; PRETECENI := X mod 4
                      00267         BANK_1
0665   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0666   1683               M                 bsf     STATUS,RP0    
0667   0820           00268         movfw OPERAND_X1
0668   3903           00269         andlw b'00000011'
0669   00AC           00270         movwf PRETECENI         ; PRETECENI := X mod 4
                      00271         
066A   2656           00272         call POSUNDOPRAVA
066B   2656           00273         call POSUNDOPRAVA
                      00274 
                      00275         BANK_0
066C   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
066D   1283               M                 bcf     STATUS,RP0    
066E   0008           00276         return
                      00277 ;**********************************************************
066F                  00278 POSUNDOPRAVA_3  ; X := X div 8
                      00279                                 ; PRETECENI := X mod 8
                      00280         BANK_1
066F   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0670   1683               M                 bsf     STATUS,RP0    
0671   0820           00281         movfw OPERAND_X1
0672   3907           00282         andlw b'00000111'
0673   00AC           00283         movwf PRETECENI         ; PRETECENI := X mod 8
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 58


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00284         
0674   2656           00285         call POSUNDOPRAVA
0675   2656           00286         call POSUNDOPRAVA
0676   2656           00287         call POSUNDOPRAVA
                      00288 
                      00289         BANK_0
0677   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0678   1283               M                 bcf     STATUS,RP0    
0679   0008           00290         return
                      00291 ;**********************************************************
067A                  00292 POSUNDOPRAVA_4  ; X := X div 16
                      00293                                 ; PRETECENI := X mod 16
                      00294         BANK_1
067A   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
067B   1683               M                 bsf     STATUS,RP0    
067C   0820           00295         movfw OPERAND_X1
067D   390F           00296         andlw b'00001111'
067E   00AC           00297         movwf PRETECENI         ; PRETECENI := X mod 16
                      00298         
067F   2656           00299         call POSUNDOPRAVA
0680   2656           00300         call POSUNDOPRAVA
0681   2656           00301         call POSUNDOPRAVA
0682   2656           00302         call POSUNDOPRAVA
                      00303 
                      00304         BANK_0
0683   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0684   1283               M                 bcf     STATUS,RP0    
0685   0008           00305         return
                      00306 ;**********************************************************
0686                  00307 POSUNDOPRAVA_5  ; X := X div 32
                      00308                                 ; PRETECENI := X mod 32
                      00309         BANK_1
0686   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0687   1683               M                 bsf     STATUS,RP0    
0688   0820           00310         movfw OPERAND_X1
0689   391F           00311         andlw b'00011111'
068A   00AC           00312         movwf PRETECENI         ; PRETECENI := X mod 32
                      00313         
068B   2656           00314         call POSUNDOPRAVA
068C   2656           00315         call POSUNDOPRAVA
068D   2656           00316         call POSUNDOPRAVA
068E   2656           00317         call POSUNDOPRAVA
068F   2656           00318         call POSUNDOPRAVA
                      00319 
                      00320         BANK_0
0690   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0691   1283               M                 bcf     STATUS,RP0    
0692   0008           00321         return
                      00322 ;**********************************************************
0693                  00323 POSUNDOPRAVA_6  ; X := X div 64
                      00324                                 ; PRETECENI := X mod 64
                      00325         BANK_1
0693   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0694   1683               M                 bsf     STATUS,RP0    
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 59


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0695   0820           00326         movfw OPERAND_X1
0696   393F           00327         andlw b'00111111'
0697   00AC           00328         movwf PRETECENI         ; PRETECENI := X mod 64
                      00329         
0698   2656           00330         call POSUNDOPRAVA
0699   2656           00331         call POSUNDOPRAVA
069A   2656           00332         call POSUNDOPRAVA
069B   2656           00333         call POSUNDOPRAVA
069C   2656           00334         call POSUNDOPRAVA
069D   2656           00335         call POSUNDOPRAVA
                      00336 
                      00337         BANK_0
069E   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
069F   1283               M                 bcf     STATUS,RP0    
06A0   0008           00338         return
                      00339 ;**********************************************************
06A1                  00340 POSUNDOPRAVA_7  ; X := X div 128
                      00341                                 ; PRETECENI := X mod 128
                      00342         BANK_1
06A1   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
06A2   1683               M                 bsf     STATUS,RP0    
06A3   0820           00343         movfw OPERAND_X1
06A4   397F           00344         andlw b'01111111'
06A5   00AC           00345         movwf PRETECENI         ; PRETECENI := X mod 128
                      00346         
06A6   2656           00347         call POSUNDOPRAVA
06A7   2656           00348         call POSUNDOPRAVA
06A8   2656           00349         call POSUNDOPRAVA
06A9   2656           00350         call POSUNDOPRAVA
06AA   2656           00351         call POSUNDOPRAVA
06AB   2656           00352         call POSUNDOPRAVA
06AC   2656           00353         call POSUNDOPRAVA
                      00354 
                      00355         BANK_0
06AD   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
06AE   1283               M                 bcf     STATUS,RP0    
06AF   0008           00356         return
                      00357 ;**********************************************************
06B0                  00358 NULA    ; if (X =  0) then PRETECENI := 0
                      00359                 ; if (X <> 0) then PRETECENI := 1
                      00360                 ; obsah X zustane nezmenen
                      00361         BANK_1
06B0   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
06B1   1683               M                 bsf     STATUS,RP0    
06B2   01AC           00362         clrf PRETECENI
06B3   30FF           00363         movlw h'FF'     
                      00364 
06B4   05A0           00365         andwf OPERAND_X1,F
06B5   1D03           00366         btfss STATUS,Z
06B6   142C           00367                 bsf PRETECENI,0
06B7   05A1           00368         andwf OPERAND_X2,F
06B8   1D03           00369         btfss STATUS,Z
06B9   142C           00370                 bsf PRETECENI,0
06BA   05A2           00371         andwf OPERAND_X3,F
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 60


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

06BB   1D03           00372         btfss STATUS,Z
06BC   142C           00373                 bsf PRETECENI,0
06BD   05A3           00374         andwf OPERAND_X4,F
06BE   1D03           00375         btfss STATUS,Z
06BF   142C           00376                 bsf PRETECENI,0         
                      00377 
                      00378         BANK_0
06C0   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
06C1   1283               M                 bcf     STATUS,RP0    
06C2   0008           00379         return
                      00380 ;**********************************************************
                      00071  
0800                  00072  org 0x0800                                     ; PAGE 1
                      00073 ;#IF VS1001==1
                      00074         include "vs1001.asm"    ; podprogramy na ovladani mp3 decoderu
                      00001 ;**********************************************************
                      00002 ;**********************************************************
                      00003 ;**********************************************************
                      00004 ; OBSLUZNE PODPROGRAMY PRO MP3 DECODER vs1001g
                      00005 ;**********************************************************
                      00006 ;**********************************************************
                      00007 ;**********************************************************
                      00008 
                      00009 ; MP3_PORT              
                      00010 ; MP3_PORT_TRIS 
                      00011 
                      00012 ; BITY MP3_PORT
                      00013 ; #define MP3_SO                MP3_PORT,0      ; serial output - tady dostavame z dekoderu data
                      00014 ; #define MP3_SI                MP3_PORT,1      ; serial input  - pokud MP3_CS=1, tak posilame mp3 data,
                             pokud =0, tak posilame prikaz
                      00015 ; #define MP3_SCLK              MP3_PORT,2      ; clock - nabezna hrana urcuje platnost dat pri seriovem
                             prenosu
                      00016 ; #define MP3_CS                MP3_PORT,3      ; cable select  - pokud MP3_CS=1, tak po SI posilame mp3
                             data, pokud =0, tak posilame prikaz
                      00017 ; #define MP3_DREQ              MP3_PORT,4      ; data request  - pokud =1, tak dekoder pozaduje dalsi m
                            p3 data (vic jak 32B)
                      00018 ; #define MP3_BSYNC             MP3_PORT,5      ; pro synchronizaci - ma byt nastaven pri prvnim prenase
                            nem bitu kazdeho bytu
                      00019 
                      00020 ;**********************************************************
                      00021 ; co nejrychleji vodesle hodnotu ve W smerem k dekoderu (obsluhuje signaly DSYNC, SI, SCLK)
0800                  00022 VS_WR_BYTE
                      00023         ; k praci pouziva TEMPW
0800   00B5           00024         movwf TEMPW             ; dato co mame odeslat si hodime do tempu...
                      00025 
0801   1685           00026         bsf MP3_BSYNC   ; bude nasledovat prvni bit bytu, proto nastavime BSYNC
                      00027 
                      00028         ; 7. bit bytu
0802   1105           00029         bcf MP3_SCLK    ; shodime SCLK
0803   1085           00030         bcf MP3_SI              ; nevime zda bit bude 0 nebo 1, SI nulujeme
0804   0DB5           00031         rlf TEMPW,f             ; odesilame od nejvyssiho bitu k nejnizsimu
0805   1803           00032         btfsc STATUS,C
0806   1485           00033         bsf MP3_SI
0807   1505           00034         bsf MP3_SCLK
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 61


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0808   1285           00035         bcf MP3_BSYNC
                      00036         
                      00037         ; 6. bit bytu
0809   1105           00038         bcf MP3_SCLK    ; shodime SCLK
080A   1085           00039         bcf MP3_SI              ; nevime zda bit bude 0 nebo 1, SI nulujeme
080B   0DB5           00040         rlf TEMPW,f             ; odesilame od nejvyssiho bitu k nejnizsimu
080C   1803           00041         btfsc STATUS,C
080D   1485           00042         bsf MP3_SI
080E   1505           00043         bsf MP3_SCLK
                      00044 
                      00045         ; 5. bit bytu
080F   1105           00046         bcf MP3_SCLK    ; shodime SCLK
0810   1085           00047         bcf MP3_SI              ; nevime zda bit bude 0 nebo 1, SI nulujeme
0811   0DB5           00048         rlf TEMPW,f             ; odesilame od nejvyssiho bitu k nejnizsimu
0812   1803           00049         btfsc STATUS,C
0813   1485           00050         bsf MP3_SI
0814   1505           00051         bsf MP3_SCLK
                      00052 
                      00053         ; 4. bit bytu
0815   1105           00054         bcf MP3_SCLK    ; shodime SCLK
0816   1085           00055         bcf MP3_SI              ; nevime zda bit bude 0 nebo 1, SI nulujeme
0817   0DB5           00056         rlf TEMPW,f             ; odesilame od nejvyssiho bitu k nejnizsimu
0818   1803           00057         btfsc STATUS,C
0819   1485           00058         bsf MP3_SI
081A   1505           00059         bsf MP3_SCLK
                      00060 
                      00061         ; 3. bit bytu
081B   1105           00062         bcf MP3_SCLK    ; shodime SCLK
081C   1085           00063         bcf MP3_SI              ; nevime zda bit bude 0 nebo 1, SI nulujeme
081D   0DB5           00064         rlf TEMPW,f             ; odesilame od nejvyssiho bitu k nejnizsimu
081E   1803           00065         btfsc STATUS,C
081F   1485           00066         bsf MP3_SI
0820   1505           00067         bsf MP3_SCLK
                      00068 
                      00069         ; 2. bit bytu
0821   1105           00070         bcf MP3_SCLK    ; shodime SCLK
0822   1085           00071         bcf MP3_SI              ; nevime zda bit bude 0 nebo 1, SI nulujeme
0823   0DB5           00072         rlf TEMPW,f             ; odesilame od nejvyssiho bitu k nejnizsimu
0824   1803           00073         btfsc STATUS,C
0825   1485           00074         bsf MP3_SI
0826   1505           00075         bsf MP3_SCLK
                      00076 
                      00077         ; 1. bit bytu
0827   1105           00078         bcf MP3_SCLK    ; shodime SCLK
0828   1085           00079         bcf MP3_SI              ; nevime zda bit bude 0 nebo 1, SI nulujeme
0829   0DB5           00080         rlf TEMPW,f             ; odesilame od nejvyssiho bitu k nejnizsimu
082A   1803           00081         btfsc STATUS,C
082B   1485           00082         bsf MP3_SI
082C   1505           00083         bsf MP3_SCLK
                      00084 
                      00085         ; 0. bit bytu
082D   1105           00086         bcf MP3_SCLK    ; shodime SCLK
082E   1085           00087         bcf MP3_SI              ; nevime zda bit bude 0 nebo 1, SI nulujeme
082F   0DB5           00088         rlf TEMPW,f             ; odesilame od nejvyssiho bitu k nejnizsimu
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 62


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0830   1803           00089         btfsc STATUS,C
0831   1485           00090         bsf MP3_SI
0832   1505           00091         bsf MP3_SCLK
                      00092 
0833   1105           00093         bcf MP3_SCLK
0834   0008           00094         return
                      00095 ;**********************************************************
                      00096 ; co nejrychleji prijme dato z vs1001 a umisti jej do W
0835                  00097 VS_RD_BYTE
                      00098         ; k praci pouziva TEMPW
                      00099 
0835   01B5           00100         clrf TEMPW              ; vymazeme, sem budeme strkat dato co nam prijde...
0836   1105           00101         bcf MP3_SCLK    ; shodime SCLK
0837   1685           00102         bsf MP3_BSYNC   ; bude nasledovat prvni bit bytu, proto nastavime BSYNC
0838   1003           00103         bcf STATUS,C    ; nulujeme priznak CARRY, staci to delat jen na zacatku, protoze TEMW mame prazd
                            ny...
                      00104 
                      00105         ; 7. bit bytu
0839   1505           00106         bsf MP3_SCLK    ; nabezna hrana SCLK
083A   1805           00107         btfsc MP3_SO
083B   1403           00108         bsf STATUS,C    ; pokud je SO v jednice nastavime C...
083C   0DB5           00109         rlf TEMPW,f
083D   1105           00110         bcf MP3_SCLK    ; shodime SCLK
                      00111 
083E   1285           00112         bcf MP3_BSYNC
                      00113 
                      00114         ; 6. bit bytu
083F   1505           00115         bsf MP3_SCLK    ; nabezna hrana SCLK
0840   1805           00116         btfsc MP3_SO
0841   1403           00117         bsf STATUS,C    ; pokud je SO v jednice nastavime C...
0842   0DB5           00118         rlf TEMPW,f
0843   1105           00119         bcf MP3_SCLK    ; shodime SCLK  
                      00120 
                      00121         ; 5. bit bytu
0844   1505           00122         bsf MP3_SCLK    ; nabezna hrana SCLK
0845   1805           00123         btfsc MP3_SO
0846   1403           00124         bsf STATUS,C    ; pokud je SO v jednice nastavime C...
0847   0DB5           00125         rlf TEMPW,f
0848   1105           00126         bcf MP3_SCLK    ; shodime SCLK  
                      00127 
                      00128         ; 4. bit bytu
0849   1505           00129         bsf MP3_SCLK    ; nabezna hrana SCLK
084A   1805           00130         btfsc MP3_SO
084B   1403           00131         bsf STATUS,C    ; pokud je SO v jednice nastavime C...
084C   0DB5           00132         rlf TEMPW,f
084D   1105           00133         bcf MP3_SCLK    ; shodime SCLK  
                      00134 
                      00135         ; 3. bit bytu
084E   1505           00136         bsf MP3_SCLK    ; nabezna hrana SCLK
084F   1805           00137         btfsc MP3_SO
0850   1403           00138         bsf STATUS,C    ; pokud je SO v jednice nastavime C...
0851   0DB5           00139         rlf TEMPW,f
0852   1105           00140         bcf MP3_SCLK    ; shodime SCLK  
                      00141 
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 63


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00142         ; 2. bit bytu
0853   1505           00143         bsf MP3_SCLK    ; nabezna hrana SCLK
0854   1805           00144         btfsc MP3_SO
0855   1403           00145         bsf STATUS,C    ; pokud je SO v jednice nastavime C...
0856   0DB5           00146         rlf TEMPW,f
0857   1105           00147         bcf MP3_SCLK    ; shodime SCLK  
                      00148 
                      00149         ; 1. bit bytu
0858   1505           00150         bsf MP3_SCLK    ; nabezna hrana SCLK
0859   1805           00151         btfsc MP3_SO
085A   1403           00152         bsf STATUS,C    ; pokud je SO v jednice nastavime C...
085B   0DB5           00153         rlf TEMPW,f
085C   1105           00154         bcf MP3_SCLK    ; shodime SCLK  
                      00155 
                      00156         ; 0. bit bytu
085D   1505           00157         bsf MP3_SCLK    ; nabezna hrana SCLK
085E   1805           00158         btfsc MP3_SO
085F   1403           00159         bsf STATUS,C    ; pokud je SO v jednice nastavime C...
0860   0D35           00160         rlf TEMPW,W
0861   1105           00161         bcf MP3_SCLK    ; shodime SCLK  
                      00162 
                      00163         ; movfw TEMPW ; tuto operaci jiz nemusime provadet, protoze jsme posledni rotaci hodily do W (rl
                            f TEMPW,W)
0862   0008           00164         return
                      00165 ;**********************************************************
                      00166 ; do TEMP1 dame adresu registru 
                      00167 ; do TEMP2 dame dolni slabiku zapisovaneho slova
                      00168 ; do TEMP3 dame horni slabiku zapisovaneho slova
0863                  00169 VS_WR_REG       ; zapise 16bitove slovo (TEMP2,TEMP3) do registru mp3 dekoderu (TEMP1)
                      00170                         ; 16bit dato se odesila od nejvyssiho bitu (15,14...8,7...1,0)
                      00171                         ; kde TEMP3 = bity 15-8 ; TEMP2 = bity 7-0
                      00172 ; pri praci pouziva TEMP1, TEMP2, TEMP3, TEMPW
0863   1185           00173         bcf MP3_CS                      ; po SI posilame prikaz
0864   3002           00174         movlw b'00000010'       ; write
0865   2000           00175         call VS_WR_BYTE 
0866   0836           00176         movfw TEMP1                     ; adresa zapisovaneho registru
0867   2000           00177         call VS_WR_BYTE
0868   0838           00178         movfw TEMP3             ; horni slabika
0869   2000           00179         call VS_WR_BYTE
086A   0837           00180         movfw TEMP2             ; dolni slabika
086B   2000           00181         call VS_WR_BYTE
086C   1585           00182         bsf MP3_CS
086D   0008           00183         return
                      00184 ;**********************************************************
                      00185 ; do TEMP1 dame adresu registru 
                      00186 ; v TEMP2 nam vrati dolni slabiku precteneho slova
                      00187 ; v TEMP3 nam vrati horni slabiku precteneho slova
086E                  00188 VS_RD_REG       ; precte 16bitove slovo (TEMP3,TEMP2) z registru mp3 dekoderu (TEMP1)
                      00189                         ; kde TEMP3 = bity 15-8 ; TEMP2 = bity 7-0
                      00190 ; pri praci pouziva TEMP1, TEMP2, TEMP3, TEMPW
086E   1185           00191         bcf MP3_CS                      ; po SI posilame prikaz
086F   3003           00192         movlw b'00000011'       ; read
0870   2000           00193         call VS_WR_BYTE 
0871   0836           00194         movfw TEMP1                     ; adresa cteneho registru
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 64


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0872   2000           00195         call VS_WR_BYTE
0873   2035           00196         call VS_RD_BYTE
0874   00B8           00197         movwf TEMP3             ; horni slabika
0875   2035           00198         call VS_RD_BYTE
0876   00B7           00199         movwf TEMP2             ; dolni slabika
0877   1585           00200         bsf MP3_CS
0878   0008           00201         return
                      00202 ;**********************************************************
0879                  00203 VS_SOFT_RESET   ; provede softwarovy reset dekoderu (pri zapnuti a pote po skonceni kazde mp3)
                      00204         PROG_PAGE_0
0879   118A               M                         bcf PCLATH,3
087A   120A               M                         bcf PCLATH,4
087B   21B1           00205         call DELAY_200ms
                      00206         PROG_PAGE_1
087C   158A               M                         bsf PCLATH,3
087D   120A               M                         bcf PCLATH,4
                      00207 
087E   3000           00208         movlw VSADDR_MODE
087F   00B6           00209         movwf TEMP1
0880   154D           00210         bsf VSREG_MODE_L,2      ; soft reset=1
0881   084D           00211         movfw VSREG_MODE_L
0882   00B7           00212         movwf TEMP2
0883   3000           00213         movlw .0                        ; MODE_H
0884   00B8           00214         movwf TEMP3
0885   2063           00215         call VS_WR_REG
                      00216 
                      00217         PROG_PAGE_0
0886   118A               M                         bcf PCLATH,3
0887   120A               M                         bcf PCLATH,4
0888   21A8           00218         call DELAY_2ms
                      00219         PROG_PAGE_1
0889   158A               M                         bsf PCLATH,3
088A   120A               M                         bcf PCLATH,4
088B   2096           00220         call VS_SEND_1024_NULL  
                      00221 
088C   114D           00222         bcf VSREG_MODE_L,2      ; soft reset=0
088D   0008           00223         return
                      00224 ;**********************************************************
088E                  00225 VS_SEND_32_NULL
088E   20A5           00226         call WAIT_FOR_VSDREQ
088F   3020           00227         movlw .32
0890   00B7           00228         movwf TEMP2
                      00229         
0891   3000           00230         movlw .0
0892   2000           00231         call VS_WR_BYTE
0893   0BB7           00232         decfsz TEMP2,F
0894   2891           00233         goto $-3
0895   0008           00234         return
                      00235 ;**********************************************************
0896                  00236 VS_SEND_1024_NULL
0896   1585           00237         bsf MP3_CS                      ; po SI posilam data
0897   3020           00238         movlw .32
0898   00B6           00239         movwf TEMP1
                      00240 
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 65


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0899   208E           00241         call VS_SEND_32_NULL
089A   0BB6           00242         decfsz TEMP1,F
089B   2899           00243         goto $-2
                      00244          
089C   0008           00245         return
                      00246 ;**********************************************************
089D                  00247 VS_SET_VOLUME
089D   300B           00248         movlw VSADDR_VOL
089E   00B6           00249         movwf TEMP1
                      00250 
089F   084F           00251         movfw VSREG_VOL_L
08A0   00B7           00252         movwf TEMP2
08A1   0850           00253         movfw VSREG_VOL_H
08A2   00B8           00254         movwf TEMP3
08A3   2063           00255         call VS_WR_REG
08A4   0008           00256         return          
                      00257 ;**********************************************************
08A5                  00258 WAIT_FOR_VSDREQ
08A5   1E05           00259         btfss MP3_DREQ
08A6   28A5           00260         goto WAIT_FOR_VSDREQ
08A7   0008           00261         return
                      00262 ;**********************************************************
08A8                  00263 VS_END_BEEP
08A8   20A5           00264         call WAIT_FOR_VSDREQ
                      00265 
08A9   3045           00266         movlw h'45'
08AA   2000           00267         call VS_WR_BYTE
08AB   3078           00268         movlw h'78'
08AC   2000           00269         call VS_WR_BYTE
08AD   3069           00270         movlw h'69'
08AE   2000           00271         call VS_WR_BYTE
08AF   3074           00272         movlw h'74'                     ; odeslanim tohoto kodu sinusovku ukoncime...
08B0   2000           00273         call VS_WR_BYTE
08B1   3000           00274         movlw .0
08B2   2000           00275         call VS_WR_BYTE
08B3   3000           00276         movlw .0
08B4   2000           00277         call VS_WR_BYTE
08B5   3000           00278         movlw .0
08B6   2000           00279         call VS_WR_BYTE
08B7   3000           00280         movlw .0
08B8   2000           00281         call VS_WR_BYTE
                      00282 
08B9   0008           00283         return
                      00284 ;**********************************************************
08BA                  00285 VS_BEEP
08BA   2079           00286         call VS_SOFT_RESET
08BB   20A5           00287         call WAIT_FOR_VSDREQ
                      00288 
08BC   1585           00289         bsf MP3_CS                      ; po SI posilam data
08BD   3053           00290         movlw h'53'
08BE   2000           00291         call VS_WR_BYTE
08BF   30EF           00292         movlw h'EF'
08C0   2000           00293         call VS_WR_BYTE
08C1   306E           00294         movlw h'6E'
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 66


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

08C2   2000           00295         call VS_WR_BYTE
08C3   303E           00296         movlw .62                       ; ctyr bytova testovaci sekvence. Tento posledni byte znamena, 
08C4   2000           00297         call VS_WR_BYTE         ; ze s pouzitim vzorkovaci frekvence 16kHz bude generovan ton 1kHz
08C5   3000           00298         movlw .0
08C6   2000           00299         call VS_WR_BYTE
08C7   3000           00300         movlw .0
08C8   2000           00301         call VS_WR_BYTE
08C9   3000           00302         movlw .0
08CA   2000           00303         call VS_WR_BYTE
08CB   3000           00304         movlw .0                        ; testovaci kod musi byt nasledovan 4 nulamy
08CC   2000           00305         call VS_WR_BYTE
                      00306 
08CD   0008           00307         return
                      00308 ;**********************************************************
08CE                  00309 VS_INIT
08CE   01CD           00310         clrf VSREG_MODE_L
08CF   01CE           00311         clrf VSREG_STATUS_L
08D0   3040           00312         movlw h'40'
08D1   00CF           00313         movwf VSREG_VOL_L               ; VOL=0x40 => nenastavuji maximalni hlasitost, protoze kdyz jsou
                             pripojena sluchatka, tak by z toho jeden ohluchl...
08D2   00D0           00314         movwf VSREG_VOL_H
                      00315 
08D3   2079           00316         call VS_SOFT_RESET              ; resetujeme
                      00317         
08D4   3003           00318         movlw .3
08D5   00BA           00319         movwf TEMP5
08D6   209D           00320         call VS_SET_VOLUME              ; nastavime hlasitost
08D7   20BA           00321         call VS_BEEP
08D8   0BBA           00322         decfsz TEMP5,f
08D9   28D6           00323         goto $-3
                      00324         ; asi proto, ze nemam osetreny hardwarovy reset dekoderu, se mu obcas nechce nastartovat....
                      00325         ; proto jej 5x za sebou resetuji a zapinam pokusnou sinusovku...
                      00326         
08DA   20A8           00327         call VS_END_BEEP
08DB   2079           00328         call VS_SOFT_RESET              ; resetujeme
                      00329 
08DC   0008           00330         return
                      00331 ;**********************************************************
                      00075 ;#ENDIF
                      00076         include "commands.asm"  ; podprogramy na obsluhu prikazu (od ridiciho procesoru)
                      00001 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
                      00002 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
                      00003 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
                      00004 ; tady jsou procedury resici jednotlive prikazy
                      00005 ; Pokud je v zasobniku prikaz pro nejakou proceduru, musi tato procedura nastavit byt STAV_PRIKAZU do 1 
                            (i kdyz treba nema vsechny parametry)
                      00006 ; Pokud procedura najde svuj prikaz a jsou prijate vsechny parametry, musi odeslat nejakou odpoved po US
                            ARTu a smazat reg. PRIJATYCH_DAT!!!
                      00007 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
08DD                  00008 CEKEJ_PRIKAZ                                    ; ceka dokud nedostaneme nejaky prikaz
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 67


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

08DD   0873           00009         movfw PRIJATYCH_DAT
08DE   39FF           00010         andlw h'FF'
08DF   1903           00011         btfsc STATUS,Z                          ; koukneme se zda prisel nejaky prikaz...
08E0   28DD           00012         goto CEKEJ_PRIKAZ
08E1   0008           00013         return
                      00014 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
08E2                  00015 PRIKAZ_02h                                              ; 02h - vrat oddily se systemem FAT32
08E2   0878           00016         movfw 0x078                                     ; prvni byte zasobniku prikazu
08E3   3C02           00017         sublw h'02'                                     
08E4   1D03           00018         btfss STATUS,Z
08E5   0008           00019         return                                          ; nebyl prijat prikaz 02h
08E6   1475           00020         bsf STAV_PRIKAZU,0                      ; mame tu prikaz 02h, nastavime byt STAV_REGISTRU
08E7   0873           00021         movfw PRIJATYCH_DAT
08E8   3C01           00022         sublw .1                                        ; pro prikaz 02h museji prijit 2 byty (prikaz + 
                            1 parametr)
08E9   1803           00023         btfsc STATUS,C
08EA   0008           00024         return                                          ; jeste nemame vsechny parametry
                      00025         ; Prisel prikaz 02h s jednim parametrem (vrat oddily se systemem FAT32)
                      00026 
08EB   0879           00027         movfw 0x079                                     ; parametr prikazu 02h (cislo svazku, jehoz para
                            metry chceme vratit)
08EC   3903           00028         andlw b'00000011'                       ; parametr musi byt v rozsahu 0-3
08ED   00B6           00029         movwf TEMP1
08EE   1003           00030         bcf STATUS,C
08EF   0DB6           00031         rlf TEMP1,F
08F0   0DB6           00032         rlf TEMP1,F
08F1   0DB6           00033         rlf TEMP1,F
08F2   0D36           00034         rlf TEMP1,W                                     ; parametr vynasobime 16
08F3   3E10           00035         addlw 0x10                                      ; buffer 2 je v bance 2 na adrese 0x10
08F4   0084           00036         movwf FSR
                      00037         INDF_BANK_2
08F5   1783               M                         bsf STATUS,IRP    
08F6   3010           00038         movlw .16                                       ; budeme odesilat 16 bytu
08F7   00B6           00039         movwf TEMP1
08F8                  00040 PRIKAZ_02h__ODESILANI_ODDILU
08F8   0800           00041         movfw INDF
                      00042         PROG_PAGE_0
08F9   118A               M                         bcf PCLATH,3
08FA   120A               M                         bcf PCLATH,4
08FB   2152           00043         call WR_USART
                      00044         PROG_PAGE_1
08FC   158A               M                         bsf PCLATH,3
08FD   120A               M                         bcf PCLATH,4
08FE   0A84           00045         incf FSR,F
08FF   0BB6           00046         decfsz TEMP1,F
0900   28F8           00047         goto PRIKAZ_02h__ODESILANI_ODDILU
0901   01F3           00048         clrf PRIJATYCH_DAT
0902   0008           00049         return
                      00050 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
0903                  00051 PRIKAZ_03h                                              ; 03h – nastav oddil
0903   0878           00052         movfw 0x078                                     ; prvni byte zasobniku prikazu
0904   3C03           00053         sublw h'03'                                     
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 68


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0905   1D03           00054         btfss STATUS,Z
0906   0008           00055         return                                          ; nebyl prijat prikaz 03h
0907   1475           00056         bsf STAV_PRIKAZU,0                      ; mame tu prikaz 03h, nastavime byt STAV_REGISTRU
0908   0873           00057         movfw PRIJATYCH_DAT
0909   3C04           00058         sublw .4                                        ; pro prikaz 03h museji prijit 5 byty (prikaz + 
                            4byty parametr)
090A   1803           00059         btfsc STATUS,C
090B   0008           00060         return                                          ; jeste nemame vsechny parametry
                      00061         ; Prisel prikaz 03h s 4bytovym parametrem (nacti oddily se systemem FAT32)
                      00062 
090C   0879           00063         movfw 0x079                                     ; parametrem prikazu 03h ma byt 4bytova adresa z
                            acatku svazku, ktery se ma nacist
090D   00A7           00064         movwf LBA1
090E   087A           00065         movfw 0x07A
090F   00A8           00066         movwf LBA2
0910   087B           00067         movfw 0x07B
0911   00A9           00068         movwf LBA3
0912   087C           00069         movfw 0x07C
0913   00AA           00070         movwf LBA4
                      00071         PROG_PAGE_0
0914   118A               M                         bcf PCLATH,3
0915   120A               M                         bcf PCLATH,4
0916   23F2           00072         call NACTI_FAT32                        ; nacte parametry zvoleneho oddilu
                      00073         PROG_PAGE_1
0917   158A               M                         bsf PCLATH,3
0918   120A               M                         bcf PCLATH,4
                      00074 
0919   082E           00075         movfw ATA_ATTRIBUTES
                      00076         PROG_PAGE_0
091A   118A               M                         bcf PCLATH,3
091B   120A               M                         bcf PCLATH,4
091C   2152           00077         call WR_USART
                      00078         PROG_PAGE_1
091D   158A               M                         bsf PCLATH,3
091E   120A               M                         bcf PCLATH,4
091F   01F3           00079         clrf PRIJATYCH_DAT                      ; vyprazdnime zasobnik
0920   0008           00080         return
                      00081 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
0921                  00082 PRIKAZ_04h                                              ; 04h – vrat velikost clusteru
0921   0878           00083         movfw 0x078                                     ; prvni byte zasobniku prikazu
0922   3C04           00084         sublw h'04'                                     
0923   1D03           00085         btfss STATUS,Z
0924   0008           00086         return                                          ; nebyl prijat prikaz 04h
0925   1475           00087         bsf STAV_PRIKAZU,0                      ; mame tu prikaz 04h, nastavime byt STAV_REGISTRU
                      00088         ; pro prikaz 04h nejsou definovany zadne parametry, proto jiz nic jineho netestujeme
                      00089 
0926   084C           00090         movfw CLUSTER_SIZE
                      00091         PROG_PAGE_0
0927   118A               M                         bcf PCLATH,3
0928   120A               M                         bcf PCLATH,4
0929   2152           00092         call WR_USART
                      00093         PROG_PAGE_1
092A   158A               M                         bsf PCLATH,3
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 69


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

092B   120A               M                         bcf PCLATH,4
092C   01F3           00094         clrf PRIJATYCH_DAT                      ; vyprazdnime zasobnik
092D   0008           00095         return
                      00096 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
092E                  00097 PRIKAZ_05h                                              ; 05h – zjisti, zda je cluster prvni v adresari
092E   0878           00098         movfw 0x078                                     ; prvni byte zasobniku prikazu
092F   3C05           00099         sublw h'05'
0930   1D03           00100         btfss STATUS,Z
0931   0008           00101         return                                          ; nebyl prijat prikaz 05h
0932   1475           00102         bsf STAV_PRIKAZU,0                      ; mame tu prikaz 05h, nastavime byt STAV_REGISTRU
0933   0873           00103         movfw PRIJATYCH_DAT
0934   3C06           00104         sublw .6                                        ; pro prikaz 05h musi prijit 7 bytu (prikaz + 6b
                            ytu parametr)
0935   1803           00105         btfsc STATUS,C
0936   0008           00106         return                                          ; jeste nemame vsechny parametry
                      00107         ; Prisel prikaz 05h s 6bytovym parametrem 
                      00108 
0937   0879           00109         movfw 0x079                                     ; nejnizsi cast clusteru adresare
0938   00BC           00110         movwf CLUSTER1
0939   087A           00111         movfw 0x07A
093A   00BD           00112         movwf CLUSTER2
093B   087B           00113         movfw 0x07B
093C   00BE           00114         movwf CLUSTER3
093D   087C           00115         movfw 0x07C
093E   00BF           00116         movwf CLUSTER4
093F   2303           00117         call PRVNI_CL_ADRESARE
                      00118 
0940   1C3B           00119         btfss POZICE,0
0941   2948           00120         goto PRIKAZ_05h_PAR1_OK
                      00121 
0942                  00122 PRIKAZ_05h_PAR1_NOT_OK
                      00123         INDF_BANK_2
0942   1783               M                         bsf STATUS,IRP    
0943   3010           00124         movlw 0x10                                      ; 1. byte bufferu 2
0944   0084           00125         movwf FSR
0945   3081           00126         movlw h'81'                                     ; jako prvni byte odpovedi dame 81h (Zadany clus
                            ter neobsahuje adresar)
0946   0080           00127         movwf INDF
0947   2956           00128         goto PRIKAZ_05h_KONEC
0948                  00129 PRIKAZ_05h_PAR1_OK
                      00130 
0948   087D           00131         movfw 0x07D
0949   00E0           00132         movwf ZAZNAM1
094A   087E           00133         movfw 0x07E
094B   00E1           00134         movwf ZAZNAM2
                      00135 
094C   233D           00136         call SKOC_NA_ZAZNAM
094D   1C3B           00137         btfss POZICE,0
094E   2955           00138         goto PRIKAZ_05h_PAR2_OK
                      00139 
094F                  00140 PRIKAZ_05h_PAR2_NOT_OK
                      00141         INDF_BANK_2
094F   1783               M                         bsf STATUS,IRP    
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 70


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0950   3010           00142         movlw 0x10                                      ; 1. byte bufferu 2
0951   0084           00143         movwf FSR
0952   3080           00144         movlw h'80'                                     ; jako prvni byte odpovedi dame 80h (Zadany zazn
                            am mimo rozsah)
0953   0080           00145         movwf INDF
0954   2956           00146         goto PRIKAZ_05h_KONEC
0955                  00147 PRIKAZ_05h_PAR2_OK
                      00148 
0955   23B4           00149         call FILE_INFO
                      00150 
0956                  00151 PRIKAZ_05h_KONEC
                      00152         ; At uz bylo v zaznamu cokoli, odesleme 16 bytu z BUFFERU 2
0956   3010           00153         movlw .16
0957   00B6           00154         movwf TEMP1
                      00155         PROG_PAGE_0
0958   118A               M                         bcf PCLATH,3
0959   120A               M                         bcf PCLATH,4
095A   2188           00156         call ODESLI_BUFFER2                     ; odesleme si zaznam o souboru  
                      00157         PROG_PAGE_1
095B   158A               M                         bsf PCLATH,3
095C   120A               M                         bcf PCLATH,4
                      00158 
095D   01F3           00159         clrf PRIJATYCH_DAT                      ; vyprazdnime zasobnik prikazu
095E   0008           00160         return
                      00161 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
095F                  00162 PRIKAZ_06h                                              ; 06h – vrat cislo dalsiho clusteru v alokacnim 
                            retezu
095F   0878           00163         movfw 0x078                                     ; prvni byte zasobniku prikazu
0960   3C06           00164         sublw h'06'                                     
0961   1D03           00165         btfss STATUS,Z
0962   0008           00166         return                                          ; nebyl prijat prikaz 06h
0963   1475           00167         bsf STAV_PRIKAZU,0                      ; mame tu prikaz 06h, nastavime byt STAV_REGISTRU
0964   0873           00168         movfw PRIJATYCH_DAT
0965   3C04           00169         sublw .4                                        ; pro prikaz 06h museji prijit 5 bytu (prikaz + 
                            4byty parametr)
0966   1803           00170         btfsc STATUS,C
0967   0008           00171         return                                          ; jeste nemame vsechny parametry
                      00172         ; Prisel prikaz 06h s 4bytovym parametrem 
                      00173 
0968   0879           00174         movfw 0x079                                     ; nejnizsi cast clusteru
0969   00BC           00175         movwf CLUSTER1
096A   087A           00176         movfw 0x07A
096B   00BD           00177         movwf CLUSTER2
096C   087B           00178         movfw 0x07B
096D   00BE           00179         movwf CLUSTER3
096E   087C           00180         movfw 0x07C
096F   00BF           00181         movwf CLUSTER4
                      00182         PROG_PAGE_0
0970   118A               M                         bcf PCLATH,3
0971   120A               M                         bcf PCLATH,4
0972   2519           00183         call NEXT_CLUSTER
0973   083B           00184         movfw POZICE                            ; pokud POZICE = 00h, je vse v poradku (vratime c. dalsi
                            ho clusteru v retezci). 
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 71


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00185                                                                 ; Pokud POZICE = FFh byl predany cluster
                             posledni v retezu, nebo byl prazdny...
0974   2152           00186         call WR_USART
0975   083C           00187         movfw CLUSTER1
0976   2152           00188         call WR_USART
0977   083D           00189         movfw CLUSTER2
0978   2152           00190         call WR_USART
0979   083E           00191         movfw CLUSTER3
097A   2152           00192         call WR_USART
097B   083F           00193         movfw CLUSTER4
097C   2152           00194         call WR_USART
                      00195         PROG_PAGE_1
097D   158A               M                         bsf PCLATH,3
097E   120A               M                         bcf PCLATH,4
                      00196         
097F   01F3           00197         clrf PRIJATYCH_DAT                      ; vyprazdnime zasobnik prikazu
0980   0008           00198         return
                      00199 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
0981                  00200 PRIKAZ_07h                                              ; 07h – cti cluster
0981   0878           00201         movfw 0x078                                     ; prvni byte zasobniku prikazu
0982   3C07           00202         sublw h'07'                                     
0983   1D03           00203         btfss STATUS,Z
0984   0008           00204         return                                          ; nebyl prijat prikaz 07h
0985   1475           00205         bsf STAV_PRIKAZU,0                      ; mame tu prikaz 07h, nastavime byt STAV_REGISTRU
0986   0873           00206         movfw PRIJATYCH_DAT
0987   3C04           00207         sublw .4                                        ; pro prikaz 07h museji prijit 5 bytu (prikaz + 
                            4byty parametr)
0988   1803           00208         btfsc STATUS,C
0989   0008           00209         return                                          ; jeste nemame vsechny parametry
                      00210         ; Prisel prikaz 06h s 4bytovym parametrem 
                      00211 
098A   0879           00212         movfw 0x079                                     ; nejnizsi cast clusteru
098B   00BC           00213         movwf CLUSTER1
098C   087A           00214         movfw 0x07A
098D   00BD           00215         movwf CLUSTER2
098E   087B           00216         movfw 0x07B
098F   00BE           00217         movwf CLUSTER3
0990   087C           00218         movfw 0x07C
0991   00BF           00219         movwf CLUSTER4
0992   01BB           00220         clrf POZICE
                      00221         PROG_PAGE_0
0993   118A               M                         bcf PCLATH,3
0994   120A               M                         bcf PCLATH,4
0995   24B6           00222         call CLUSTER_TO_LBA                     ; zjistime si skutecnou polohu pozadovaneho clusteru na 
                            disku...
0996   084C           00223         movfw CLUSTER_SIZE
0997   00A6           00224         movwf SECTOR_C                          ; tentokrat cteme cely cluster a ne sector
0998   2299           00225         call READ_SECTOR;S
                      00226         PROG_PAGE_1
0999   158A               M                         bsf PCLATH,3
099A   120A               M                         bcf PCLATH,4
                      00227 
099B   084C           00228         movfw CLUSTER_SIZE
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 72


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

099C   00B7           00229         movwf TEMP2                                     ; kolik sektoru budeme odesilat
                      00230 
099D                  00231 PRIKAZ_07h__ODESLI_SECTOR
099D   3000           00232         movlw .0                                        ; budeme odesilat cely sector (256slov = 512bytu
                            )
099E   00B6           00233         movwf TEMP1
                      00234         PROG_PAGE_0
099F   118A               M                         bcf PCLATH,3
09A0   120A               M                         bcf PCLATH,4
09A1   2165           00235         call ODESLI_DATA
                      00236         PROG_PAGE_1
09A2   158A               M                         bsf PCLATH,3
09A3   120A               M                         bcf PCLATH,4
09A4   0BB7           00237         decfsz TEMP2,F                          ; a to tolikrat, kolik ma cluster sektroru
09A5   299D           00238         goto PRIKAZ_07h__ODESLI_SECTOR
                      00239         
09A6   01F3           00240         clrf PRIJATYCH_DAT                      ; vyprazdnime zasobnik prikazu
09A7   0008           00241         return
                      00242 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
09A8                  00243 PRIKAZ_08h                                              ; 08h – zjisti velikost souboru
09A8   0878           00244         movfw 0x078                                     ; prvni byte zasobniku prikazu
09A9   3C08           00245         sublw h'08'
09AA   1D03           00246         btfss STATUS,Z
09AB   0008           00247         return                                          ; nebyl prijat prikaz 08h
09AC   1475           00248         bsf STAV_PRIKAZU,0                      ; mame tu prikaz 08h, nastavime byt STAV_REGISTRU
09AD   0873           00249         movfw PRIJATYCH_DAT
09AE   3C06           00250         sublw .6                                        ; pro prikaz 08h musi prijit 7 bytu (prikaz + 6b
                            ytu parametr)
09AF   1803           00251         btfsc STATUS,C
09B0   0008           00252         return                                          ; jeste nemame vsechny parametry
                      00253         ; Prisel prikaz 08h s 6bytovym parametrem 
                      00254 
09B1   0879           00255         movfw 0x079                                     ; nejnizsi cast clusteru adresare
09B2   00BC           00256         movwf CLUSTER1
09B3   087A           00257         movfw 0x07A
09B4   00BD           00258         movwf CLUSTER2
09B5   087B           00259         movfw 0x07B
09B6   00BE           00260         movwf CLUSTER3
09B7   087C           00261         movfw 0x07C
09B8   00BF           00262         movwf CLUSTER4
09B9   2303           00263         call PRVNI_CL_ADRESARE
                      00264 
09BA   1C3B           00265         btfss POZICE,0
09BB   29BF           00266         goto PRIKAZ_08h_PAR1_OK
                      00267 
09BC                  00268 PRIKAZ_08h_PAR1_NOT_OK
09BC   3081           00269         movlw h'81'                                     ; jako prvni byte odpovedi dame 81h (Zadany clus
                            ter neobsahuje adresar)
09BD   00B6           00270         movwf TEMP1
09BE   29CB           00271         goto PRIKAZ_08h_KONEC
09BF                  00272 PRIKAZ_08h_PAR1_OK
                      00273 
09BF   087D           00274         movfw 0x07D
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 73


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

09C0   00E0           00275         movwf ZAZNAM1
09C1   087E           00276         movfw 0x07E
09C2   00E1           00277         movwf ZAZNAM2
                      00278 
09C3   233D           00279         call SKOC_NA_ZAZNAM
09C4   1C3B           00280         btfss POZICE,0
09C5   29C9           00281         goto PRIKAZ_08h_PAR2_OK
                      00282 
09C6                  00283 PRIKAZ_08h_PAR2_NOT_OK
09C6   3080           00284         movlw h'80'                                     ; jako prvni byte odpovedi dame 80h (Zadany zazn
                            am mimo rozsah)
09C7   00B6           00285         movwf TEMP1
09C8   29CB           00286         goto PRIKAZ_08h_KONEC
09C9                  00287 PRIKAZ_08h_PAR2_OK
                      00288 
09C9   2420           00289         call FILE_SIZE
09CA   01B6           00290         clrf TEMP1
                      00291 
09CB                  00292 PRIKAZ_08h_KONEC
                      00293         ; At uz bylo v zaznamu cokoli, odesleme 4 byty z BUFFERU 2
09CB   0836           00294         movfw TEMP1
                      00295         PROG_PAGE_0
09CC   118A               M                         bcf PCLATH,3
09CD   120A               M                         bcf PCLATH,4
09CE   2152           00296         call WR_USART
09CF   3004           00297         movlw .4
09D0   00B6           00298         movwf TEMP1
09D1   2188           00299         call ODESLI_BUFFER2                     ; odesleme si zaznam o souboru  
                      00300         PROG_PAGE_1
09D2   158A               M                         bsf PCLATH,3
09D3   120A               M                         bcf PCLATH,4
                      00301 
09D4   01F3           00302         clrf PRIJATYCH_DAT                      ; vyprazdnime zasobnik prikazu
09D5   0008           00303         return
                      00304 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
09D6                  00305 PRIKAZ_09h                                              ; 09h – nastav hledání
09D6   0878           00306         movfw 0x078                                     ; prvni byte zasobniku prikazu
09D7   3C09           00307         sublw h'09'
09D8   1D03           00308         btfss STATUS,Z
09D9   0008           00309         return                                          ; nebyl prijat prikaz 09h
09DA   1475           00310         bsf STAV_PRIKAZU,0                      ; mame tu prikaz 09h, nastavime byt STAV_REGISTRU
09DB   0873           00311         movfw PRIJATYCH_DAT
09DC   3C07           00312         sublw .7                                        ; pro prikaz 09h musi prijit 8 bytu (prikaz + 7b
                            ytu parametr)
09DD   1803           00313         btfsc STATUS,C
09DE   0008           00314         return                                          ; jeste nemame vsechny parametry
                      00315         ; Prisel prikaz 09h s 5bytovym parametrem 
                      00316 
09DF   0879           00317         movfw 0x079                                     ; nejnizsi cast clusteru adresare
09E0   00BC           00318         movwf CLUSTER1
09E1   087A           00319         movfw 0x07A
09E2   00BD           00320         movwf CLUSTER2
09E3   087B           00321         movfw 0x07B
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 74


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

09E4   00BE           00322         movwf CLUSTER3
09E5   087C           00323         movfw 0x07C
09E6   00BF           00324         movwf CLUSTER4
09E7   2303           00325         call PRVNI_CL_ADRESARE
                      00326 
09E8   183B           00327         btfsc POZICE,0
09E9   29FA           00328         goto PRIKAZ_09h_SPATNY_PAR
                      00329 
09EA   0879           00330         movfw 0x079                                     ; nejnizsi cast clusteru adresare
09EB   00DA           00331         movwf HL_ADR_CL1
09EC   087A           00332         movfw 0x07A
09ED   00DB           00333         movwf HL_ADR_CL2
09EE   087B           00334         movfw 0x07B
09EF   00DC           00335         movwf HL_ADR_CL3
09F0   087C           00336         movfw 0x07C
09F1   00DD           00337         movwf HL_ADR_CL4
                      00338 
09F2   087D           00339         movfw 0x07D
09F3   00E0           00340         movwf ZAZNAM1
09F4   087E           00341         movfw 0x07E
09F5   00E1           00342         movwf ZAZNAM2
                      00343 
09F6   087F           00344         movfw 0x07F
09F7   00D9           00345         movwf HL_PARAMETRY
                      00346 
09F8   243D           00347         call HLEDEJ             ; mocna procedura, ktera man podle zadanych parametru vyhleda pozadovany
                             zaznam 
                      00348                                         ; a umisti jej do bufferu2 na offset 32 (od zacatku bufferu)
09F9   2A00           00349         goto PRIKAZ_09h_KONEC
09FA                  00350 PRIKAZ_09h_SPATNY_PAR
                      00351         BANK_2
09FA   1703               M                 bsf     STATUS,RP1              ; BANK2  RP1:RP0 = 10
09FB   1283               M                 bcf     STATUS,RP0    
09FC   3081           00352         movlw h'81'
09FD   00B0           00353         movwf 0x130
                      00354         BANK_0
09FE   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
09FF   1283               M                 bcf     STATUS,RP0    
0A00                  00355 PRIKAZ_09h_KONEC
0A00   3012           00356         movlw .18
0A01   00B6           00357         movwf TEMP1     
                      00358 
                      00359         PROG_PAGE_0
0A02   118A               M                         bcf PCLATH,3
0A03   120A               M                         bcf PCLATH,4
0A04   217E           00360         call ODESLI_BUFF2_HIGH
                      00361         PROG_PAGE_1
0A05   158A               M                         bsf PCLATH,3
0A06   120A               M                         bcf PCLATH,4
                      00362 
0A07   01F3           00363         clrf PRIJATYCH_DAT                      ; vyprazdnime zasobnik prikazu
0A08   0008           00364         return
                      00365 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 75


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0A09                  00366 PRIKAZ_80h                                              ; 80h – hraj mp3 soubor
0A09   0878           00367         movfw 0x078                                     ; prvni byte zasobniku prikazu
0A0A   3C80           00368         sublw h'80'
0A0B   1D03           00369         btfss STATUS,Z
0A0C   0008           00370         return                                          ; nebyl prijat prikaz 80h
0A0D   1475           00371         bsf STAV_PRIKAZU,0                      ; mame tu prikaz 80h, nastavime byt STAV_REGISTRU
0A0E   0873           00372         movfw PRIJATYCH_DAT
0A0F   3C06           00373         sublw .6                                        ; pro prikaz 80h musi prijit 7 bytu (prikaz + 6b
                            ytu parametr)
0A10   1803           00374         btfsc STATUS,C
0A11   0008           00375         return                                          ; jeste nemame vsechny parametry
                      00376         ; Prisel prikaz 80h s 6bytovym parametrem 
                      00377 
0A12   0879           00378         movfw 0x079                                     ; nejnizsi cast clusteru adresare
0A13   00BC           00379         movwf CLUSTER1
0A14   087A           00380         movfw 0x07A
0A15   00BD           00381         movwf CLUSTER2
0A16   087B           00382         movfw 0x07B
0A17   00BE           00383         movwf CLUSTER3
0A18   087C           00384         movfw 0x07C
0A19   00BF           00385         movwf CLUSTER4
0A1A   2303           00386         call PRVNI_CL_ADRESARE
                      00387 
0A1B   1C3B           00388         btfss POZICE,0
0A1C   2A23           00389         goto PRIKAZ_80h_PAR1_OK
                      00390 
0A1D                  00391 PRIKAZ_80h_PAR1_NOT_OK
                      00392         INDF_BANK_2
0A1D   1783               M                         bsf STATUS,IRP    
0A1E   3010           00393         movlw 0x10                                      ; 1. byte bufferu 2
0A1F   0084           00394         movwf FSR
0A20   3081           00395         movlw h'81'                                     ; jako prvni byte odpovedi dame 81h (Zadany clus
                            ter neobsahuje adresar)
0A21   0080           00396         movwf INDF
0A22   2A5D           00397         goto PRIKAZ_80h_KONEC
0A23                  00398 PRIKAZ_80h_PAR1_OK
                      00399 
0A23   087D           00400         movfw 0x07D
0A24   00E0           00401         movwf ZAZNAM1
0A25   087E           00402         movfw 0x07E
0A26   00E1           00403         movwf ZAZNAM2
                      00404 
0A27   233D           00405         call SKOC_NA_ZAZNAM
0A28   1C3B           00406         btfss POZICE,0
0A29   2A30           00407         goto PRIKAZ_80h_PAR2_OK
                      00408 
0A2A                  00409 PRIKAZ_80h_PAR2_NOT_OK
                      00410         INDF_BANK_2
0A2A   1783               M                         bsf STATUS,IRP    
0A2B   3010           00411         movlw 0x10                                      ; 1. byte bufferu 2
0A2C   0084           00412         movwf FSR
0A2D   3080           00413         movlw h'80'                                     ; jako prvni byte odpovedi dame 80h (Zadany zazn
                            am mimo rozsah)
0A2E   0080           00414         movwf INDF
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 76


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0A2F   2A5D           00415         goto PRIKAZ_80h_KONEC
0A30                  00416 PRIKAZ_80h_PAR2_OK
                      00417 
0A30   23B4           00418         call FILE_INFO
                      00419 
                      00420         INDF_BANK_2
0A31   1783               M                         bsf STATUS,IRP    
0A32   3010           00421         movlw 0x10                                      ; 1. byte bufferu 2
0A33   0084           00422         movwf FSR
0A34   0800           00423         movfw INDF
0A35   3C06           00424         sublw h'06'                                     ; pokud na zadanem miste se nachazi soubor s pri
                            ponou mp3...
0A36   1D03           00425         btfss STATUS,Z
0A37   2A5D           00426         goto PRIKAZ_80h_KONEC
                      00427                         
                      00428         ; ...nastavime jej jako prehravany soubor.
0A38   301C           00429         movlw 0x1C                                      ; 13. byte bufferu 2
0A39   0084           00430         movwf FSR
0A3A   0800           00431         movfw INDF
0A3B   00E9           00432         movwf PREH_DATA_CL1
0A3C   0A84           00433         incf FSR,f
0A3D   0800           00434         movfw INDF
0A3E   00EA           00435         movwf PREH_DATA_CL2
0A3F   0A84           00436         incf FSR,f
0A40   0800           00437         movfw INDF
0A41   00EB           00438         movwf PREH_DATA_CL3
0A42   0A84           00439         incf FSR,f
0A43   0800           00440         movfw INDF
0A44   00EC           00441         movwf PREH_DATA_CL4
                      00442         
0A45   087D           00443         movfw 0x07D
0A46   00E6           00444         movwf PREH_ZAZNAM1
0A47   087E           00445         movfw 0x07E
0A48   00E7           00446         movwf PREH_ZAZNAM2
                      00447 
0A49   0879           00448         movfw 0x079                                     ; nejnizsi cast clusteru adresare
0A4A   00E2           00449         movwf PREH_ADR_CL1
0A4B   087A           00450         movfw 0x07A
0A4C   00E3           00451         movwf PREH_ADR_CL2
0A4D   087B           00452         movfw 0x07B
0A4E   00E4           00453         movwf PREH_ADR_CL3
0A4F   087C           00454         movfw 0x07C
0A50   00E5           00455         movwf PREH_ADR_CL4
                      00456         ; aktualni prehravany soubor i prehravana slozka byly nastaveny...
                      00457 
0A51   01ED           00458         clrf PREH_DATA_POZICE
0A52   146E           00459         bsf PREH_STAV0,0
0A53   14EE           00460         bsf PREH_STAV0,1                        ; nastavime si vlastosti prehravani: (PREH_STAV[0-1])
                      00461 
0A54   10CD           00462         bcf VSREG_MODE_L,1                      ; prehravame normalni rychlosti 
0A55   106F           00463         bcf PREH_STAV1,0                        ; prehravame normalni rychlosti 
                      00464         
0A56   2079           00465         call VS_SOFT_RESET
                      00466 
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 77


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0A57   3000           00467         movlw VSADDR_MODE
0A58   00B6           00468         movwf TEMP1
0A59   084D           00469         movfw VSREG_MODE_L
0A5A   00B7           00470         movwf TEMP2
0A5B   01B8           00471         clrf TEMP3
0A5C   2063           00472         call VS_WR_REG
                      00473 
0A5D                  00474 PRIKAZ_80h_KONEC
                      00475         ; At uz bylo v zaznamu cokoli, odesleme 1 byt z BUFFERU 2
                      00476         INDF_BANK_2
0A5D   1783               M                         bsf STATUS,IRP    
0A5E   3010           00477         movlw 0x10                                      ; 1. byte bufferu 2
0A5F   0084           00478         movwf FSR
0A60   0800           00479         movfw INDF
                      00480         PROG_PAGE_0
0A61   118A               M                         bcf PCLATH,3
0A62   120A               M                         bcf PCLATH,4
0A63   2152           00481         call WR_USART   
                      00482         PROG_PAGE_1
0A64   158A               M                         bsf PCLATH,3
0A65   120A               M                         bcf PCLATH,4
                      00483         
0A66   01F3           00484         clrf PRIJATYCH_DAT                      ; vyprazdnime zasobnik prikazu
0A67   0008           00485         return
                      00486 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
0A68                  00487 PRIKAZ_81h                                              ; 81h – vrat stav prehravaneho souboru
0A68   0878           00488         movfw 0x078                                     ; prvni byte zasobniku prikazu
0A69   3C81           00489         sublw h'81'
0A6A   1D03           00490         btfss STATUS,Z
0A6B   0008           00491         return                                          ; nebyl prijat prikaz 81h
0A6C   1475           00492         bsf STAV_PRIKAZU,0                      ; mame tu prikaz 81h, nastavime byt STAV_REGISTRU
                      00493         ; pro prikaz 81h nejsou definovany zadne parametry, proto jiz nic jineho netestujeme
                      00494 
0A6D   086E           00495         movfw PREH_STAV0
                      00496         PROG_PAGE_0
0A6E   118A               M                         bcf PCLATH,3
0A6F   120A               M                         bcf PCLATH,4
0A70   2152           00497         call WR_USART
                      00498         PROG_PAGE_1
0A71   158A               M                         bsf PCLATH,3
0A72   120A               M                         bcf PCLATH,4
                      00499 
0A73   086F           00500         movfw PREH_STAV1
                      00501         PROG_PAGE_0
0A74   118A               M                         bcf PCLATH,3
0A75   120A               M                         bcf PCLATH,4
0A76   2152           00502         call WR_USART
                      00503         PROG_PAGE_1
0A77   158A               M                         bsf PCLATH,3
0A78   120A               M                         bcf PCLATH,4
                      00504 
0A79   116E           00505         bcf PREH_STAV0,2                        ; 2. bit je nastaven, kdyz se zmeni prehravany soubor (b
                            ez volani prikazu) do doby, nez prijde prikaz na dotaz STAVU... (81h)
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 78


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00506 
0A7A   3004           00507         movlw VSADDR_DECODE_TIME
0A7B   00B6           00508         movwf TEMP1
0A7C   206E           00509         call VS_RD_REG                          ; zjistime si aktualni pozici v souboru v sekundach
0A7D   0837           00510         movfw TEMP2
                      00511         PROG_PAGE_0
0A7E   118A               M                         bcf PCLATH,3
0A7F   120A               M                         bcf PCLATH,4
0A80   2152           00512         call WR_USART
0A81   0838           00513         movfw TEMP3
0A82   2152           00514         call WR_USART   
                      00515         PROG_PAGE_1
0A83   158A               M                         bsf PCLATH,3
0A84   120A               M                         bcf PCLATH,4
                      00516 
                      00517 ;       movlw VSADDR_STATUS
                      00518 ;       movwf TEMP1
                      00519 ;       call VS_RD_REG
                      00520 ;       movfw TEMP2
                      00521 ;       PROG_PAGE_0
                      00522 ;       call WR_USART
                      00523 ;       PROG_PAGE_1
                      00524 
0A85   01F3           00525         clrf PRIJATYCH_DAT                      ; vyprazdnime zasobnik
0A86   0008           00526         return
                      00527 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
0A87                  00528 PRIKAZ_82h                                              ; 82h – nastav hlasitost
0A87   0878           00529         movfw 0x078                                     ; prvni byte zasobniku prikazu
0A88   3C82           00530         sublw h'82'
0A89   1D03           00531         btfss STATUS,Z
0A8A   0008           00532         return                                          ; nebyl prijat prikaz 82h
0A8B   1475           00533         bsf STAV_PRIKAZU,0                      ; mame tu prikaz 82h, nastavime byt STAV_REGISTRU
0A8C   0873           00534         movfw PRIJATYCH_DAT
0A8D   3C02           00535         sublw .2                                        ; pro prikaz 82h museji prijit 3 byty (prikaz + 
                            2byty parametr)
0A8E   1803           00536         btfsc STATUS,C
0A8F   0008           00537         return                                          ; jeste nemame vsechny parametry
                      00538         ; Prisel prikaz 82h s 2bytovym parametrem 
                      00539 
0A90   0879           00540         movfw 0x079                                     ; hlasitost pro levy kanal
0A91   00D0           00541         movwf VSREG_VOL_H
0A92   087A           00542         movfw 0x07A                                     ; hlasitost pro pravy kanal
0A93   00CF           00543         movwf VSREG_VOL_L
0A94   209D           00544         call VS_SET_VOLUME                      ; nastavime hlasitost   
                      00545 
0A95   30FF           00546         movlw h'FF'
                      00547         PROG_PAGE_0
0A96   118A               M                         bcf PCLATH,3
0A97   120A               M                         bcf PCLATH,4
0A98   2152           00548         call WR_USART
                      00549         PROG_PAGE_1
0A99   158A               M                         bsf PCLATH,3
0A9A   120A               M                         bcf PCLATH,4
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 79


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0A9B   01F3           00550         clrf PRIJATYCH_DAT                      ; vyprazdnime zasobnik
0A9C   0008           00551         return
                      00552 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
0A9D                  00553 PRIKAZ_83h                                              ; 83h – vrat informace o prehravanem souboru
0A9D   0878           00554         movfw 0x078                                     ; prvni byte zasobniku prikazu
0A9E   3C83           00555         sublw h'83'
0A9F   1D03           00556         btfss STATUS,Z
0AA0   0008           00557         return                                          ; nebyl prijat prikaz 83h
0AA1   1475           00558         bsf STAV_PRIKAZU,0                      ; mame tu prikaz 83h, nastavime byt STAV_REGISTRU
                      00559         ; pro prikaz 83h nejsou definovane zadne parametry, proto jiz nic jineho netestujeme
                      00560 
0AA2   3005           00561         movlw VSADDR_AUDATA
0AA3   00B6           00562         movwf TEMP1
0AA4   206E           00563         call VS_RD_REG
0AA5   0837           00564         movfw TEMP2
                      00565         PROG_PAGE_0
0AA6   118A               M                         bcf PCLATH,3
0AA7   120A               M                         bcf PCLATH,4
0AA8   2152           00566         call WR_USART
0AA9   0838           00567         movfw TEMP3
0AAA   2152           00568         call WR_USART   
                      00569         PROG_PAGE_1
0AAB   158A               M                         bsf PCLATH,3
0AAC   120A               M                         bcf PCLATH,4
                      00570         ; odeslali jsme AUDATA
                      00571 
0AAD   3008           00572         movlw VSADDR_HDAT0
0AAE   00B6           00573         movwf TEMP1
0AAF   206E           00574         call VS_RD_REG
0AB0   0837           00575         movfw TEMP2
                      00576         PROG_PAGE_0
0AB1   118A               M                         bcf PCLATH,3
0AB2   120A               M                         bcf PCLATH,4
0AB3   2152           00577         call WR_USART
0AB4   0838           00578         movfw TEMP3
0AB5   2152           00579         call WR_USART   
                      00580         PROG_PAGE_1
0AB6   158A               M                         bsf PCLATH,3
0AB7   120A               M                         bcf PCLATH,4
                      00581         ; odeslali jsme HDAT0
                      00582 
0AB8   3009           00583         movlw VSADDR_HDAT1
0AB9   00B6           00584         movwf TEMP1
0ABA   206E           00585         call VS_RD_REG
0ABB   0837           00586         movfw TEMP2
                      00587         PROG_PAGE_0
0ABC   118A               M                         bcf PCLATH,3
0ABD   120A               M                         bcf PCLATH,4
0ABE   2152           00588         call WR_USART
0ABF   0838           00589         movfw TEMP3
0AC0   2152           00590         call WR_USART   
                      00591         ; odeslali jsme HDAT1
                      00592 
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 80


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0AC1   0862           00593         movfw PREH_ADR_CL1
0AC2   2152           00594         call WR_USART
0AC3   0863           00595         movfw PREH_ADR_CL2
0AC4   2152           00596         call WR_USART
0AC5   0864           00597         movfw PREH_ADR_CL3
0AC6   2152           00598         call WR_USART
0AC7   0865           00599         movfw PREH_ADR_CL4
0AC8   2152           00600         call WR_USART
                      00601 
0AC9   0866           00602         movfw PREH_ZAZNAM1
0ACA   2152           00603         call WR_USART
0ACB   0867           00604         movfw PREH_ZAZNAM2
0ACC   2152           00605         call WR_USART
                      00606         PROG_PAGE_1
0ACD   158A               M                         bsf PCLATH,3
0ACE   120A               M                         bcf PCLATH,4
                      00607 
0ACF   01F3           00608         clrf PRIJATYCH_DAT                      ; vyprazdnime zasobnik
0AD0   0008           00609         return
                      00610 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
0AD1                  00611 PRIKAZ_84h                                              ; 84h – nastav stav prehravani
0AD1   0878           00612         movfw 0x078                                     ; prvni byte zasobniku prikazu
0AD2   3C84           00613         sublw h'84'
0AD3   1D03           00614         btfss STATUS,Z
0AD4   0008           00615         return                                          ; nebyl prijat prikaz 84h
0AD5   1475           00616         bsf STAV_PRIKAZU,0                      ; mame tu prikaz 84h, nastavime byt STAV_REGISTRU
0AD6   0873           00617         movfw PRIJATYCH_DAT
0AD7   3C02           00618         sublw .2                                        ; pro prikaz 8h museji prijit 3 byty (prikaz + 2
                            byty parametr)
0AD8   1803           00619         btfsc STATUS,C
0AD9   0008           00620         return                                          ; jeste nemame vsechny parametry
                      00621         ; Prisel prikaz 84h s 2bytovym parametrem 
                      00622 
0ADA   086E           00623         movfw PREH_STAV0
0ADB   3906           00624         andlw b'00000110'
0ADC   00EE           00625         movwf PREH_STAV0
0ADD   0879           00626         movfw 0x079                                     ; parametr 1
0ADE   39F9           00627         andlw b'11111001'                       ; nektere bity vymaskujeme (vsechny nelze ovladat prikaz
                            em)
0ADF   046E           00628         iorwf PREH_STAV0,w      
0AE0   00EE           00629         movwf PREH_STAV0
                      00630 
0AE1   087A           00631         movfw 0x07A                                     ; parametr 2
0AE2   00EF           00632         movwf PREH_STAV1
                      00633 
0AE3   10CD           00634         bcf VSREG_MODE_L,1                      ; prehravame normalni rychlosti (zda se mp3 prevyji je r
                            eseno v hlavni smycce podle stavu registru PREH_STAV1)
0AE4   13CD           00635         bcf VSREG_MODE_L,7                      ;bass/treble enhancer
0AE5   19EF           00636         btfsc PREH_STAV1,3                      ; 3. bit =      1 => zvyrazneni basu a vysek (moznost de
                            koderu vs1001 "bass/treble enhancer")
0AE6   17CD           00637         bsf VSREG_MODE_L,7                      ;bass/treble enhancer
                      00638         
0AE7   3000           00639         movlw VSADDR_MODE
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 81


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0AE8   00B6           00640         movwf TEMP1
0AE9   084D           00641         movfw VSREG_MODE_L
0AEA   00B7           00642         movwf TEMP2
0AEB   01B8           00643         clrf TEMP3
0AEC   2063           00644         call VS_WR_REG
                      00645         
0AED   3001           00646         movlw VSADDR_STATUS
0AEE   206E           00647         call VS_RD_REG
0AEF   0837           00648         movfw TEMP2
0AF0   00CE           00649         movwf VSREG_STATUS_L
                      00650 
0AF1   114E           00651         bcf VSREG_STATUS_L,2            ; Bit 2 is analog powerdown bit.
0AF2   1A6F           00652         btfsc PREH_STAV1,4                      ; 4. bit = 1 => MUTE
0AF3   154E           00653         bsf VSREG_STATUS_L,2            ; Bit 2 is analog powerdown bit.
                      00654         
0AF4   3001           00655         movlw VSADDR_STATUS
0AF5   00B6           00656         movwf TEMP1
0AF6   084E           00657         movfw VSREG_STATUS_L
0AF7   00B7           00658         movwf TEMP2
0AF8   01B8           00659         clrf TEMP3
0AF9   2063           00660         call VS_WR_REG
                      00661 
                      00662         PROG_PAGE_0
0AFA   118A               M                         bcf PCLATH,3
0AFB   120A               M                         bcf PCLATH,4
0AFC   30FF           00663         movlw h'FF'
0AFD   2152           00664         call WR_USART
                      00665         PROG_PAGE_1
0AFE   158A               M                         bsf PCLATH,3
0AFF   120A               M                         bcf PCLATH,4
0B00   01E8           00666         clrf PREH_CITAC_PREV
0B01   01F3           00667         clrf PRIJATYCH_DAT                      ; vyprazdnime zasobnik
0B02   0008           00668         return
                      00669 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
                      00077         include "filesystem.asm"; podprogramy pro praci s adresari a setrideni obsahu adresaru
                      00001 ;**********************************************************
                      00002 ;**********************************************************
                      00003 ;**********************************************************
                      00004 ; podprogramy pro praci s adresari a setrideni obsahu adresaru
                      00005 ;**********************************************************
                      00006 ;**********************************************************
                      00007 ;**********************************************************
                      00008 
                      00009 ;**************************************************************************
0B03                  00010 PRVNI_CL_ADRESARE
                      00011         ; V CLUSTER[1-4] prijme cislo clusteru, zkontroluje, zda zadany sluster obsahuje 
                      00012         ; zacatek adresare
                      00013         ; V POZICE vrati 00h, pokud cluster je prvni cluster nejakeho adresare, FFh, pokud neobsahuje ad
                            resar
0B03   01BB           00014         clrf POZICE
                      00015 
0B04   083C           00016         movfw CLUSTER1
0B05   043D           00017         iorwf CLUSTER2,W
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 82


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0B06   043E           00018         iorwf CLUSTER3,W
0B07   043F           00019         iorwf CLUSTER4,W
0B08   1903           00020         btfsc STATUS,Z
0B09   0008           00021         return                          ; pokud CLUSTER[1-4]=0, tak se jedna o 1. cluster ROOT adr., pro
                            to nemusime dale resit co tam je...
                      00022         
                      00023         PROG_PAGE_0
0B0A   118A               M                         bcf PCLATH,3
0B0B   120A               M                         bcf PCLATH,4
0B0C   24B6           00024         call CLUSTER_TO_LBA
0B0D   3001           00025         movlw .1
0B0E   00A6           00026         movwf SECTOR_C
0B0F   2299           00027         call READ_SECTOR        ; precteme udajny prvni sektor z prvniho clusteru adresare      
                      00028         PROG_PAGE_1
0B10   158A               M                         bsf PCLATH,3
0B11   120A               M                         bcf PCLATH,4
                      00029 
                      00030         ; Tady vychazime z toho, ze kazdy adresar krome ROOTu ma jako prvni zaznam ukazatel na sebe (jak
                            o jmeno je jedna tecka)
                      00031         ; Mohlo by se sice stat, ze bychom narazili na soubor, ktery zacina retezcem ".          " to by
                            ch ale neresil...
0B12   30FF           00032         movlw h'FF'
0B13   00BB           00033         movwf POZICE
                      00034 
                      00035         PROG_PAGE_0
0B14   118A               M                         bcf PCLATH,3
0B15   120A               M                         bcf PCLATH,4
0B16   2241           00036         call READ_DATA
                      00037         PROG_PAGE_1
0B17   158A               M                         bsf PCLATH,3
0B18   120A               M                         bcf PCLATH,4
0B19   0820           00038         movfw DATA_L
0B1A   3C2E           00039         sublw '.'               ; 1. znak
0B1B   1D03           00040         btfss STATUS,Z
0B1C   2B3C           00041         goto PRVNI_CL_ADRESARE_KONEC
0B1D   0821           00042         movfw DATA_H
0B1E   3C20           00043         sublw h'20'             ; 2. znak
0B1F   1D03           00044         btfss STATUS,Z
0B20   2B3C           00045         goto PRVNI_CL_ADRESARE_KONEC
                      00046 
0B21   3004           00047         movlw .4                ; dalsich 8 znaku maji byt mezery
0B22   00B6           00048         movwf TEMP1
                      00049         
0B23                  00050 PRVNI_CL_ADRESARE_MEZERY
                      00051         PROG_PAGE_0
0B23   118A               M                         bcf PCLATH,3
0B24   120A               M                         bcf PCLATH,4
0B25   2241           00052         call READ_DATA
                      00053         PROG_PAGE_1
0B26   158A               M                         bsf PCLATH,3
0B27   120A               M                         bcf PCLATH,4
0B28   0820           00054         movfw DATA_L
0B29   3C20           00055         sublw h'20'
0B2A   1D03           00056         btfss STATUS,Z
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 83


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0B2B   2B3C           00057         goto PRVNI_CL_ADRESARE_KONEC
0B2C   0821           00058         movfw DATA_H
0B2D   3C20           00059         sublw h'20'
0B2E   1D03           00060         btfss STATUS,Z
0B2F   2B3C           00061         goto PRVNI_CL_ADRESARE_KONEC
0B30   0BB6           00062         decfsz TEMP1,f
0B31   2B23           00063         goto PRVNI_CL_ADRESARE_MEZERY
                      00064 
                      00065         PROG_PAGE_0
0B32   118A               M                         bcf PCLATH,3
0B33   120A               M                         bcf PCLATH,4
0B34   2241           00066         call READ_DATA
                      00067         PROG_PAGE_1
0B35   158A               M                         bsf PCLATH,3
0B36   120A               M                         bcf PCLATH,4
0B37   0820           00068         movfw DATA_L
0B38   3C20           00069         sublw h'20'
0B39   1D03           00070         btfss STATUS,Z
0B3A   2B3C           00071         goto PRVNI_CL_ADRESARE_KONEC
                      00072 
0B3B   01BB           00073         clrf POZICE     
0B3C                  00074 PRVNI_CL_ADRESARE_KONEC
0B3C   0008           00075         return
                      00076 ;**************************************************************************
0B3D                  00077 SKOC_NA_ZAZNAM
                      00078         ; !!!! pozor, tato procedura potrebuje min. 5 mist ve STACKu (vcetne sama sebe)
                      00079 
                      00080         ; V CLUSTER[1-4] prijme cislo clusteru na kterem se nachazi zacatek adresare
                      00081         ; V ZAZNAM[1-2] prijme cislo zaznamu 
                      00082         ; - pokud ZAZNAM[1-2] ukazuji mimo adresar, vrati v POZICE FFh (jinak 00h)
                      00083         ; - pokud byl zaznam nalezen,
                      00084         ;       da disku prikaz k jeho precteni a skoci az k zaznamu...
                      00085         ;       ...v bufferu disku budeme mit teda 32bytu dat ktere prezentuji jeden zaznam ve slozce
0B3D   0860           00086         movfw ZAZNAM1
                      00087         BANK_1
0B3E   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0B3F   1683               M                 bsf     STATUS,RP0    
0B40   00A0           00088         movwf OPERAND_X1
                      00089         BANK_0
0B41   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0B42   1283               M                 bcf     STATUS,RP0    
0B43   0861           00090         movfw ZAZNAM2
                      00091         BANK_1
0B44   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0B45   1683               M                 bsf     STATUS,RP0    
0B46   00A1           00092         movwf OPERAND_X2
0B47   01A2           00093         clrf OPERAND_X3
0B48   01A3           00094         clrf OPERAND_X4
                      00095         BANK_0                                  ; OPERAND_X := ZAZNAM
0B49   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0B4A   1283               M                 bcf     STATUS,RP0    
                      00096         
                      00097         PROG_PAGE_0
0B4B   118A               M                         bcf PCLATH,3
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 84


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0B4C   120A               M                         bcf PCLATH,4
0B4D   267A           00098         call POSUNDOPRAVA_4             ; OPERAND_X := OPERAND_X div 16
                      00099         ; tady mame v PRETECENI kolikaty zaznam v sektoru chceme
                      00100         BANK_1
0B4E   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0B4F   1683               M                 bsf     STATUS,RP0    
0B50   082C           00101         movfw PRETECENI
                      00102         BANK_0
0B51   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0B52   1283               M                 bcf     STATUS,RP0    
0B53   00BA           00103         movwf TEMP5
                      00104 
0B54   18CC           00105         btfsc CLUSTER_SIZE,1            ; 2
0B55   265C           00106         call POSUNDOPRAVA_1                     ; X := X div 2
0B56   194C           00107         btfsc CLUSTER_SIZE,2            ; 4
0B57   2665           00108         call POSUNDOPRAVA_2                     ; X := X div 4
0B58   19CC           00109         btfsc CLUSTER_SIZE,3            ; 8
0B59   266F           00110         call POSUNDOPRAVA_3                     ; X := X div 8
0B5A   1A4C           00111         btfsc CLUSTER_SIZE,4            ; 16
0B5B   267A           00112         call POSUNDOPRAVA_4                     ; X := X div 4
0B5C   1ACC           00113         btfsc CLUSTER_SIZE,5            ; 32
0B5D   2686           00114         call POSUNDOPRAVA_5                     ; X := X div 32
0B5E   1B4C           00115         btfsc CLUSTER_SIZE,6            ; 64
0B5F   2693           00116         call POSUNDOPRAVA_6                     ; X := X div 64
0B60   1BCC           00117         btfsc CLUSTER_SIZE,7            ; 128
0B61   26A1           00118         call POSUNDOPRAVA_7                     ; X := X div 128
                      00119         ; tady mame v PRETECENI na kolikatem sektoru v clusteru je hledany zaznam
                      00120         BANK_1
0B62   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0B63   1683               M                 bsf     STATUS,RP0    
0B64   082C           00121         movfw PRETECENI
                      00122         BANK_0
0B65   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0B66   1283               M                 bcf     STATUS,RP0    
0B67   00B9           00123         movwf TEMP4
                      00124 
                      00125         ; OPERAND_X := (ZAZNAM div 16) div CLUSTER_SIZE
                      00126         ; ted v OPERAND_X mame hodnotu kolik clusteru mame od zacatku adresare preskocit...
0B68                  00127 SKOC_NA_ZAZNAM_PRESKOC_CL
                      00128         PROG_PAGE_0
0B68   118A               M                         bcf PCLATH,3
0B69   120A               M                         bcf PCLATH,4
0B6A   26B0           00129         call NULA
                      00130         PROG_PAGE_1
0B6B   158A               M                         bsf PCLATH,3
0B6C   120A               M                         bcf PCLATH,4
                      00131         BANK_1
0B6D   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0B6E   1683               M                 bsf     STATUS,RP0    
0B6F   1C2C           00132         btfss PRETECENI,0
0B70   2B96           00133         goto SKOC_NA_ZAZNAM_MAME_CL     
                      00134         BANK_0
0B71   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0B72   1283               M                 bcf     STATUS,RP0    
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 85


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00135 
                      00136         INDF_BANK_1
0B73   1383               M                         bcf STATUS,IRP    
0B74   30A0           00137         movlw 0xA0
0B75   0084           00138         movwf FSR
0B76   0800           00139         movfw INDF
0B77   00B7           00140         movwf TEMP2
0B78   0A84           00141         incf FSR,F
0B79   0800           00142         movfw INDF
0B7A   00B8           00143         movwf TEMP3
                      00144 
                      00145         PROG_PAGE_0
0B7B   118A               M                         bcf PCLATH,3
0B7C   120A               M                         bcf PCLATH,4
0B7D   2519           00146         call NEXT_CLUSTER
                      00147         PROG_PAGE_1
0B7E   158A               M                         bsf PCLATH,3
0B7F   120A               M                         bcf PCLATH,4
0B80   183B           00148         btfsc POZICE,0          ; pokud s vse povedlo, mame v POZICE 0
0B81   2BB1           00149         goto SKOC_NA_ZAZNAM_MIMO_ROZSAH
                      00150 
                      00151         INDF_BANK_1
0B82   1383               M                         bcf STATUS,IRP    
0B83   30A0           00152         movlw 0xA0
0B84   0084           00153         movwf FSR
0B85   0837           00154         movfw TEMP2
0B86   0080           00155         movwf INDF
0B87   0A84           00156         incf FSR,F
0B88   0838           00157         movfw TEMP3
0B89   0080           00158         movwf INDF
                      00159         BANK_1
0B8A   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0B8B   1683               M                 bsf     STATUS,RP0    
0B8C   01A2           00160         clrf OPERAND_X3
0B8D   01A3           00161         clrf OPERAND_X4
                      00162         BANK_0  
0B8E   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0B8F   1283               M                 bcf     STATUS,RP0    
                      00163 
                      00164         PROG_PAGE_0
0B90   118A               M                         bcf PCLATH,3
0B91   120A               M                         bcf PCLATH,4
0B92   25F3           00165         call DEKREMENTUJ
                      00166         PROG_PAGE_1
0B93   158A               M                         bsf PCLATH,3
0B94   120A               M                         bcf PCLATH,4
                      00167 
0B95   2B68           00168         goto SKOC_NA_ZAZNAM_PRESKOC_CL
                      00169 
0B96                  00170 SKOC_NA_ZAZNAM_MAME_CL
                      00171         BANK_0
0B96   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0B97   1283               M                 bcf     STATUS,RP0    
                      00172 
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 86


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0B98   0839           00173         movfw TEMP4                                     ; v kolikatem sektoru v clusteru je hledany zazn
                            am
0B99   00BB           00174         movwf POZICE 
                      00175         PROG_PAGE_0
0B9A   118A               M                         bcf PCLATH,3
0B9B   120A               M                         bcf PCLATH,4
0B9C   24B6           00176         call CLUSTER_TO_LBA                     ; zjistime si skutecnou polohu zaznamu na disku
0B9D   3001           00177         movlw .1
0B9E   00A6           00178         movwf SECTOR_C
0B9F   2299           00179         call READ_SECTOR                        ; dame prikaz precist sektor
                      00180         PROG_PAGE_1
0BA0   158A               M                         bsf PCLATH,3
0BA1   120A               M                         bcf PCLATH,4
                      00181 
0BA2   083A           00182         movfw TEMP5                                     ; kolikaty zaznam v casti adersare (sektoru) mam
                            e precist
0BA3   390F           00183         andlw b'00001111'
0BA4   00B6           00184         movwf TEMP1                                     ; rozsah by mel byt spravne, pro jistotu jej ale
                             orizneme [0..15]
0BA5   39FF           00185         andlw h'FF'
0BA6   1903           00186         btfsc STATUS,Z                          ; pokud chceme prvni zaznam ze sektoru...
0BA7   2BAE           00187         goto SKOC_NA_ZAZNAM_MAME_ZAZNAM         ; ...koncime
                      00188 
0BA8   0EB6           00189         swapf TEMP1,F                           ; protoze kazdy zaznam o souboru ma 32B=16slov, tak musi
                            me TEMP1 vynasobit 16...
                      00190         PROG_PAGE_0
0BA9   118A               M                         bcf PCLATH,3
0BAA   120A               M                         bcf PCLATH,4
0BAB   225C           00191         call PRESKOC                            ; a tolik slov preskocit (tolik slov je pro nas nepotreb
                            nych)
                      00192         PROG_PAGE_1
0BAC   158A               M                         bsf PCLATH,3
0BAD   120A               M                         bcf PCLATH,4
                      00193 
0BAE                  00194 SKOC_NA_ZAZNAM_MAME_ZAZNAM
0BAE   3000           00195         movlw h'00'
0BAF   00BB           00196         movwf POZICE 
0BB0   2BB3           00197         goto SKOC_NA_ZAZNAM_KONEC
0BB1                  00198 SKOC_NA_ZAZNAM_MIMO_ROZSAH
0BB1   30FF           00199         movlw h'FF'
0BB2   00BB           00200         movwf POZICE 
0BB3                  00201 SKOC_NA_ZAZNAM_KONEC
0BB3   0008           00202         return
                      00203 ;**************************************************************************
0BB4                  00204 FILE_INFO
                      00205         ; z disku nam ted ma prijit 32bytu dat, ktere reprezentuji jeden zaznam ve slozce
                      00206         ; tato procedura zaznam precte, analyzuje, a do bufferu 2 da nasledujici informace:
                      00207         ;               1.     byte ->  = 00h -> zaznam je prazdny; 
                      00208         ;                                               = 01h -> zaznam je adresar; 
                      00209         ;                                               = 02h -> zaznam je soubor; 
                      00210         ;                                               = 06h -> zaznam je soubor s priponou MP3
                      00211         ;               2..9   byte -> 8 znaku dlouhe jmeno ("DOSovsky" tvar - napr. slouzka "dokumenty"
                             = "DOKUME~1" )
                      00212         ;               10..12 byte -> u souboru tri znaky pripony (u adresaru vetsinou mezery - 20h 20h
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 87


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                             20h)
                      00213         ;               13..16 byte -> 1. cluster souboru
                      00214         ; Pokud se jedna o adresar, a zaznam o pripone se nerovna 0x202020 (tri mezery), tak skutecne jm
                            eno adresare je : ADRESAR.PRI
                      00215         INDF_BANK_2
0BB4   1783               M                         bsf STATUS,IRP    
0BB5   3010           00216         movlw 0x10                                      ; 1. byte bufferu 2
0BB6   0084           00217         movwf FSR
0BB7   3000           00218         movlw .0                                        ; zatim nevime co zaznam obsahuje, tak ho oznaci
                            me jako prazdny
0BB8   0080           00219         movwf INDF
0BB9   0A84           00220         incf FSR,F      
                      00221 
0BBA   3005           00222         movlw .5                                        ; 5 slov = 10 bytu -> 8 znaku jmena souboru/sloz
                            ky + 2 znaky pripony
0BBB   00B6           00223         movwf TEMP1
0BBC                  00224 FILE_INFO__READ_NAME
                      00225         PROG_PAGE_0
0BBC   118A               M                         bcf PCLATH,3
0BBD   120A               M                         bcf PCLATH,4
0BBE   2241           00226         call READ_DATA                          ; 2 znaky jmena souboru/slozky, nebo pripony souboru
                      00227         PROG_PAGE_1
0BBF   158A               M                         bsf PCLATH,3
0BC0   120A               M                         bcf PCLATH,4
0BC1   0820           00228         movfw DATA_L
0BC2   0080           00229         movwf INDF
0BC3   0A84           00230         incf FSR,F
0BC4   0821           00231         movfw DATA_H
0BC5   0080           00232         movwf INDF
0BC6   0A84           00233         incf FSR,F
0BC7   03B6           00234         decf TEMP1,F
0BC8   1D03           00235         btfss STATUS,Z
0BC9   2BBC           00236         goto FILE_INFO__READ_NAME       
                      00237 
                      00238         PROG_PAGE_0
0BCA   118A               M                         bcf PCLATH,3
0BCB   120A               M                         bcf PCLATH,4
0BCC   2241           00239         call READ_DATA                          ; posledni znak pripony a byt s atributy souboru
                      00240         PROG_PAGE_1
0BCD   158A               M                         bsf PCLATH,3
0BCE   120A               M                         bcf PCLATH,4
0BCF   0820           00241         movfw DATA_L
0BD0   0080           00242         movwf INDF
                      00243 
0BD1   3011           00244         movlw 0x11                                      ; 2. byte bufferu 2 -> 1. znak jmena souboru
0BD2   0084           00245         movwf FSR
0BD3   0800           00246         movfw INDF                                      ; ted ve W mame 1. znak jmena souboru/slozky
0BD4   39FF           00247         andlw h'FF'
0BD5   1903           00248         btfsc STATUS,Z
0BD6   2C1F           00249         goto FILE_INFO__KONEC           ; pokud 1. znak jmena souboru = 00h, je zaznam prazdny
0BD7   3CE5           00250         sublw h'E5'
0BD8   1903           00251         btfsc STATUS,Z
0BD9   2C1F           00252         goto FILE_INFO__KONEC           ; pokud 1. znak jmena souboru = E5h, je zaznam prazdny
                      00253         
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 88


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00254         ; pokud jsme tady, tak zaznam obsahuje soubor, adresar, dlouhe jmeno souboru, nebo jmenovku disk
                            u 
                      00255         ; (jsou dva zpusoby jak zapsat jmenovku svazku, bud do spousteciho zaznamu, nebo jako polozku RO
                            OT adresare)
0BDA   0821           00256         movfw DATA_H                            ; byt s atributy souboru
0BDB   390F           00257         andlw h'0F'
0BDC   3C0F           00258         sublw h'0F'                                     ; if (atributy and 0Fh) = 0Fh -> zaznam s dlouhy
                            m nazvem souboru
0BDD   1903           00259         btfsc STATUS,Z
0BDE   2C1F           00260         goto FILE_INFO__KONEC           ; pokud zaznam je dlouhy nazav souboru, koncime
0BDF   19A1           00261         btfsc DATA_H,3
0BE0   2C1F           00262         goto FILE_INFO__KONEC           ; if (atributy and 08h) = 08h -> jmenovka disku
0BE1   1A21           00263         btfsc DATA_H,4                          ; if (atributy and 16h) = 16h -> adresar
0BE2   2BF8           00264         goto FILE_INFO__DIR
                      00265 
0BE3   3002           00266         movlw h'02'                                     ; zaznam je soubor
0BE4   00B6           00267         movwf TEMP1
                      00268         ; tady vime, ze zaznam je soubor, tak se podivame, zda to neni mp3
0BE5   3019           00269         movlw 0x19                                      ; 10. byt bufferu 2 -> 1. znak pripony souboru
0BE6   0084           00270         movwf FSR
                      00271 
0BE7   0800           00272         movfw INDF
0BE8   3C4D           00273         sublw 'M'                                       ; (jmena souboru v "DOSovskem" tvaru maji vzdy v
                            elka pismena)
0BE9   1D03           00274         btfss STATUS,Z
0BEA   2BFA           00275         goto FILE_INFO__FILE
0BEB   0A84           00276         incf FSR,F
0BEC   0800           00277         movfw INDF
0BED   3C50           00278         sublw 'P'
0BEE   1D03           00279         btfss STATUS,Z
0BEF   2BFA           00280         goto FILE_INFO__FILE
0BF0   0A84           00281         incf FSR,F
0BF1   0800           00282         movfw INDF
0BF2   3C33           00283         sublw '3'
0BF3   1D03           00284         btfss STATUS,Z
0BF4   2BFA           00285         goto FILE_INFO__FILE
                      00286 
0BF5   3006           00287         movlw h'06'                                     ; ted je jasne, ze soubor je mp3
0BF6   00B6           00288         movwf TEMP1
0BF7   2BFA           00289         goto FILE_INFO__FILE
                      00290 
0BF8                  00291 FILE_INFO__DIR
0BF8   3001           00292         movlw h'01'                                     ; zaznam je adresar
0BF9   00B6           00293         movwf TEMP1
                      00294 
0BFA                  00295 FILE_INFO__FILE
                      00296         ; tady mame v TEMP 1 jednu z nasledujicich hodnot:
                      00297         ; 01h -> zaznam je adresar; 02h -> zaznam je soubor; 06h -> zaznam je soubor s priponou MP3
0BFA   3010           00298         movlw 0x10                                      ; 1. byt bufferu 2 -> identifikace zaznamu
0BFB   0084           00299         movwf FSR
0BFC   0836           00300         movfw TEMP1
0BFD   0080           00301         movwf INDF
                      00302 
0BFE   3004           00303         movlw .4
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 89


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0BFF   00B6           00304         movwf TEMP1
                      00305         PROG_PAGE_0
0C00   118A               M                         bcf PCLATH,3
0C01   120A               M                         bcf PCLATH,4
0C02   225C           00306         call PRESKOC                            ; nasledujicich 8 bytu ze zaznamu je pro nas k nicemu (o
                            bsahuji cas posledni upravy, otevreni a buh vi co jeste...)
                      00307         PROG_PAGE_1
0C03   158A               M                         bsf PCLATH,3
0C04   120A               M                         bcf PCLATH,4
                      00308 
0C05   301E           00309         movlw 0x1E                                      ; 15. byt bufferu 2 -> 2. byt prvniho clusteru
0C06   0084           00310         movwf FSR
                      00311         PROG_PAGE_0
0C07   118A               M                         bcf PCLATH,3
0C08   120A               M                         bcf PCLATH,4
0C09   2241           00312         call READ_DATA                          ; jedno slovo -> horni cast cisla prvniho clusteru
                      00313         PROG_PAGE_1
0C0A   158A               M                         bsf PCLATH,3
0C0B   120A               M                         bcf PCLATH,4
0C0C   0820           00314         movfw DATA_L
0C0D   0080           00315         movwf INDF
0C0E   0A84           00316         incf FSR,F
0C0F   0821           00317         movfw DATA_H
0C10   0080           00318         movwf INDF
                      00319 
                      00320         PROG_PAGE_0
0C11   118A               M                         bcf PCLATH,3
0C12   120A               M                         bcf PCLATH,4
0C13   2241           00321         call READ_DATA                          ; cas vytvoreni   (1 word)
0C14   2241           00322         call READ_DATA                          ; datum vytvoreni (1 word)
                      00323 
0C15   301C           00324         movlw 0x1C                                      ; 13. byt bufferu 2 -> 0. byt prvniho clusteru
0C16   0084           00325         movwf FSR
0C17   2241           00326         call READ_DATA                          ; jedno slovo -> dolni cast cisla prvniho clusteru
                      00327         PROG_PAGE_1
0C18   158A               M                         bsf PCLATH,3
0C19   120A               M                         bcf PCLATH,4
0C1A   0820           00328         movfw DATA_L
0C1B   0080           00329         movwf INDF
0C1C   0A84           00330         incf FSR,F
0C1D   0821           00331         movfw DATA_H
0C1E   0080           00332         movwf INDF
                      00333         
                      00334         ; Pak jsou v zaznamu jeste 4 byty, ktere obsahuji velikost souboru. Ty mi ale nepotrebujeme...  
0C1F                  00335 FILE_INFO__KONEC
0C1F   0008           00336         return
                      00337 ;**************************************************************************
0C20                  00338 FILE_SIZE
                      00339         ; z disku nam ted ma prijit 32bytu dat, ktere reprezentuji jeden zaznam ve slozce
                      00340         ; Zaznam by mel byt soubor, podprogram toto nekontroluje (zda zaznam neni adresar)
                      00341         ; Na zacatek bufferu 1 da 4 byty obsahujici velikost zaznamu
0C20   300E           00342         movlw .14                                       ; my ted potrebujeme jen posledni 4 byty ze zazn
                            amu, tam se nachazi velikost souboru
0C21   00B6           00343         movwf TEMP1
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 90


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00344         PROG_PAGE_0
0C22   118A               M                         bcf PCLATH,3
0C23   120A               M                         bcf PCLATH,4
0C24   225C           00345         call PRESKOC
                      00346         PROG_PAGE_1
0C25   158A               M                         bsf PCLATH,3
0C26   120A               M                         bcf PCLATH,4
                      00347 
                      00348         INDF_BANK_2
0C27   1783               M                         bsf STATUS,IRP    
0C28   3010           00349         movlw 0x10                                      ; 1. byte bufferu 1
0C29   0084           00350         movwf FSR
                      00351 
                      00352         PROG_PAGE_0
0C2A   118A               M                         bcf PCLATH,3
0C2B   120A               M                         bcf PCLATH,4
0C2C   2241           00353         call READ_DATA
0C2D   0820           00354         movfw DATA_L
0C2E   0080           00355         movwf INDF
0C2F   0A84           00356         incf FSR,F
0C30   0821           00357         movfw DATA_H
0C31   0080           00358         movwf INDF
0C32   0A84           00359         incf FSR,F
                      00360 
0C33   2241           00361         call READ_DATA
                      00362         PROG_PAGE_1
0C34   158A               M                         bsf PCLATH,3
0C35   120A               M                         bcf PCLATH,4
0C36   0820           00363         movfw DATA_L
0C37   0080           00364         movwf INDF
0C38   0A84           00365         incf FSR,F
0C39   0821           00366         movfw DATA_H
0C3A   0080           00367         movwf INDF
0C3B   0A84           00368         incf FSR,F
                      00369 
0C3C   0008           00370         return
                      00371 ;**************************************************************************
0C3D                  00372 HLEDEJ
                      00373 ; !!!! pozor, tato procedura potrebuje min. 6 mist ve STACKu (vcetne sama sebe)
                      00374 
                      00375 ; mocna procedura, ktera nam podle zadanych parametru vyhleda pozadovany zaznam 
                      00376 ; a umisti jej do bufferu2 na offset 32 (do horni poloviny bufferu)
                      00377 
                      00378 ; ZAZNAM V DRUHE POLOVINE BUFFERU2 MA NASLEDUJICI STRUKTURU:
                      00379 ;       1. byte:        = 00h -> zadny vyhovujici zaznam nebyl nalezen
                      00380 ;                               = 01h -> zaznam je adresar
                      00381 ;                               = 02h -> zaznam je soubor; 
                      00382 ;                               = 06h -> zaznam je soubor s priponou MP3
                      00383 ;       2..9   byte -> 8 znaku dlouhe jmeno ("DOSovsky" tvar - napr. slouzka "dokumenty" = "DOKUME~1" )
                      00384 ;       10..12 byte -> u souboru tri znaky pripony (u adresaru vetsinou mezery - 20h 20h 20h)
                      00385 ;       13..16 byte -> 1. cluster souboru
                      00386 ;       17..18 byte -> cislo zaznamu v adresari
                      00387 
                      00388 ;       HL_PARAMETRY    -- parametry hledani
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 91


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00389 ;       HL_ADR_CL[1-4]  -- prnvi cluster prohledavaneho adresare
                      00390 ;       ZAZNAM[1-2]             -- zaznam od ktereho hledame
                      00391 
                      00392 ; Filozofie je takova, ze v bufferu 1 mame ulozen zaznam vuci kteremu vyhledavame (ZAZ_REF),
                      00393 ; v dolni polovine bufferu 2 mame ulozen zaznam, ktery jsme prave precetli (ZAZ_A)
                      00394 ; a v hodni polovine bufferu 2 zaznam, ktery zatim byl nejblize k pozadovanemu zaznamu (ZAZ_N).
                      00395 
                      00396 ; Hruby vyvojak by pak mohl vypadat takto:
                      00397 ;******************************************************************************************************
                      00398 ; if ((HL_PARAMETRY = [prvni]):
                      00399 ;       if (CLUSTER = ROOT):
                      00400 ;               HL_PARAMETRY := [dalsi]
                      00401 ;               ZAZ_REF := 0x0000000.....
                      00402 ;               goto hledej_hledani
                      00403 ;       else:
                      00404 ;               ZAZ_N naplnit daty ze zaznamu 1 // prvni polozkou vsech adresaru krome ROOTu jsou ".."
                      00405 ;               goto hledej_konec
                      00406 ;       endif;
                      00407 ; endif;
                      00408 
                      00409 ; if ((CLUSTER != ROOT) and (ZAZNAM<2)):
                      00410 ;               if (HL_PARAMETRY = [dalsi]):
                      00411 ;                       ZAZ_REF := 0x0000000.....
                      00412 ;                       goto hledej_hledani
                      00413 ;               else:
                      00414 ;                       goto hledej_konec
                      00415 ;               endif;
                      00416 ; endif;
                      00417 ;
                      00418 ; ZAZ_REF naplnit daty ze zaznamu ZAZNAM
                      00419 ; ZAZNAM := 0
                      00420 ; if (CLUSTER != ROOT):
                      00421 ;               ZAZNAM :=2
                      00422 ; end;
                      00423 ;
                      00424 ; repeat
                      00425 ;       nacti_zaznam
                      00426 ;       IF     (hledame dalsi zaznam)     AND (ZAZ_A > ZAZ_REF) AND ((ZAZ_A < ZAZ_N) OR (ZAZ_N is empty)
                            ):
                      00427 ;                       ZAZ_N := ZAZ_A
                      00428 ;       ELSEIF (hledame predchozi zaznam) AND (ZAZ_A < ZAZ_REF) AND (ZAZ_A > ZAZ_N):
                      00429 ;                       ZAZ_N := ZAZ_A
                      00430 ;       ENDIF
                      00431 ;       zaznam++
                      00432 ; until (byl zaznam posledni)
                      00433 ;
                      00434 ; if (HL_PARAMETRY = [predchozi]) and (ZAZ_N = 00000) and (!ROOT):
                      00435 ;       ZAZ_N naplnit daty ze zaznamu 1
                      00436 ; endif;
                      00437 ; KONEC
                      00438 ;******************************************************************************************************
                      00439         PROG_PAGE_0
0C3D   118A               M                         bcf PCLATH,3
0C3E   120A               M                         bcf PCLATH,4
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 92


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0C3F   2272           00440         call CLEAR_BUFFER2              ; vymazeme si buffer2, abychom tam nemeli bordel
                      00441         PROG_PAGE_1
0C40   158A               M                         bsf PCLATH,3
0C41   120A               M                         bcf PCLATH,4
0C42   259B           00442         call CLEAR_BUFFER1              ; vymazeme si buffer1, abychom tam nemeli bordel
                      00443 
0C43   085A           00444         movfw HL_ADR_CL1
0C44   00BC           00445         movwf CLUSTER1
0C45   085B           00446         movfw HL_ADR_CL2
0C46   00BD           00447         movwf CLUSTER2
0C47   085C           00448         movfw HL_ADR_CL3
0C48   00BE           00449         movwf CLUSTER3
0C49   085D           00450         movfw HL_ADR_CL4
0C4A   00BF           00451         movwf CLUSTER4
                      00452 
                      00453         ; protoze to budeme v nasledujicim kodu potrebova, nastavime si 7. bit HL_PARAMETRY podle toho, 
                      00454         ; zda predany adresar je ROOT ci nikoliv
0C4B   13D9           00455         bcf HL_PARAMETRY,7
0C4C   30FF           00456         movlw h'FF'     
0C4D   05BC           00457         andwf CLUSTER1,F
0C4E   1D03           00458         btfss STATUS,Z
0C4F   17D9           00459                 bsf HL_PARAMETRY,7
0C50   05BD           00460         andwf CLUSTER2,F
0C51   1D03           00461         btfss STATUS,Z
0C52   17D9           00462                 bsf HL_PARAMETRY,7
0C53   05BE           00463         andwf CLUSTER3,F
0C54   1D03           00464         btfss STATUS,Z
0C55   17D9           00465                 bsf HL_PARAMETRY,7
0C56   05BF           00466         andwf CLUSTER4,F
0C57   1D03           00467         btfss STATUS,Z
0C58   17D9           00468                 bsf HL_PARAMETRY,7
                      00469 
                      00470 
0C59   1DD9           00471         btfss HL_PARAMETRY,3                    ; if ((HL_PARAMETRY = [prvni]):
0C5A   2C67           00472         goto HLEDEJ_NEHLEDAME_PRVNI
0C5B   1BD9           00473         btfsc HL_PARAMETRY,7                    ;               IF (CLUSTER = ROOT):
0C5C   2C5F           00474         goto HLEDEJ_ELSE1
0C5D   1259           00475         bcf HL_PARAMETRY,4
0C5E   2C7D           00476         goto HLEDEJ_HLEDANI
0C5F                  00477 HLEDEJ_ELSE1                                            ;               ELSE:
0C5F   3001           00478         movlw .1
0C60   00E0           00479         movwf ZAZNAM1
0C61   01E1           00480         clrf ZAZNAM2
0C62   233D           00481         call SKOC_NA_ZAZNAM     
0C63   23B4           00482         call FILE_INFO
0C64   24C9           00483         call ZAPIS_C_ZAZNAMU
0C65   25E5           00484         call BUF2_LOW_TO_HIGH
0C66   2CC8           00485         goto HLEDEJ_KONEC                               ;               ENDIF;
0C67                  00486 HLEDEJ_NEHLEDAME_PRVNI                          ; ENDIF 
                      00487 
0C67   1FD9           00488         btfss HL_PARAMETRY,7
0C68   2C77           00489         goto HLEDEJ_IF2_ENDIF
0C69   0861           00490         movfw ZAZNAM2 
0C6A   39FF           00491         andlw h'FF'
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 93


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0C6B   1D03           00492         btfss STATUS,Z
0C6C   2C77           00493         goto HLEDEJ_IF2_ENDIF
0C6D   0860           00494         movfw ZAZNAM1
0C6E   39FF           00495         andlw h'FF'
0C6F   1903           00496         btfsc STATUS,Z
0C70   2C74           00497         goto IF2
0C71   3C01           00498         sublw .1
0C72   1D03           00499         btfss STATUS,Z
0C73   2C77           00500         goto HLEDEJ_IF2_ENDIF                   ; if ((CLUSTER != ROOT) and (ZAZNAM < 2)):
0C74                  00501 IF2
0C74   1A59           00502         btfsc HL_PARAMETRY,4                    ;               if (HL_PARAMETRY = [predchozi]):
0C75   2CC8           00503         goto HLEDEJ_KONEC                               ;               ... else:
0C76   2C7D           00504         goto HLEDEJ_HLEDANI                             ;               ... endif;
0C77                  00505 HLEDEJ_IF2_ENDIF                                        ; endif
                      00506 
0C77   233D           00507         call SKOC_NA_ZAZNAM             ; - pokud ZAZNAM[1-2] ukazuji mimo adresar, vrati v POZICE FFh (
                            jinak 00h)
0C78   183B           00508         btfsc POZICE,0
0C79   2CC8           00509         goto HLEDEJ_KONEC       
0C7A   23B4           00510         call FILE_INFO
0C7B   24C9           00511         call ZAPIS_C_ZAZNAMU    
0C7C   25A7           00512         call BUF2_TO_BUF1
                      00513 
0C7D                  00514 HLEDEJ_HLEDANI  
0C7D   01E0           00515         clrf ZAZNAM1
0C7E   01E1           00516         clrf ZAZNAM2
0C7F   1BD9           00517         btfsc HL_PARAMETRY,7
0C80   14E0           00518         bsf ZAZNAM1,1                   ; if (!ROOT): ZAZNAM = 2; endif;
                      00519 
0C81                  00520 HLEDEJ_REPEAT
0C81   085A           00521         movfw HL_ADR_CL1
0C82   00BC           00522         movwf CLUSTER1
0C83   085B           00523         movfw HL_ADR_CL2
0C84   00BD           00524         movwf CLUSTER2
0C85   085C           00525         movfw HL_ADR_CL3
0C86   00BE           00526         movwf CLUSTER3
0C87   085D           00527         movfw HL_ADR_CL4
0C88   00BF           00528         movwf CLUSTER4
                      00529 
0C89   233D           00530         call SKOC_NA_ZAZNAM             ; - pokud ZAZNAM[1-2] ukazuji mimo adresar, vrati v POZICE FFh (
                            jinak 00h)
0C8A   183B           00531         btfsc POZICE,0
0C8B   2CAD           00532         goto HLEDEJ_END_REPEAT
0C8C   23B4           00533         call FILE_INFO
0C8D   24C9           00534         call ZAPIS_C_ZAZNAMU
                      00535 
0C8E   0AE0           00536         incf ZAZNAM1,f
0C8F   1903           00537         btfsc STATUS,Z
0C90   0AE1           00538         incf ZAZNAM2,f
                      00539 
0C91   24D6           00540         call VYHOVUJE_ZAZNAM
0C92   1C36           00541         btfss TEMP1,0
0C93   2C81           00542         goto HLEDEJ_REPEAT
                      00543         
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 94


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00544 ;       movlw .16
                      00545 ;       movwf TEMP1
                      00546 ;       PROG_PAGE_0
                      00547 ;       call ODESLI_BUFFER2                     ; odesleme si zaznam o souboru  
                      00548 ;       call DELAY_500ms    
                      00549 ;       PROG_PAGE_1
                      00550 
                      00551 ;       IF     (hledame dalsi zaznam)
                      00552 ;               IF (ZAZ_A > ZAZ_REF) AND ((ZAZ_A < ZAZ_N) OR (ZAZ_N is empty)):
                      00553 ;                       ZAZ_N := ZAZ_A
                      00554 ;               ENDIF
                      00555 ;       ELSEIF (hledame predchozi zaznam)
                      00556 ;               IF (ZAZ_A < ZAZ_REF) AND (ZAZ_A > ZAZ_N):
                      00557 ;                       ZAZ_N := ZAZ_A
                      00558 ;               ENDIF
                      00559 ;       ENDIF
0C94   250B           00560         call COMPARE_BUFF1_BUFF2
                      00561         ; porovna nazvy souboru na zacatku bufferu1 s bufferem2
                      00562         ; pokud v abecede je driv nazev v bufferu1 da to TEMP1 0x01
                      00563         ; pokud v abecede je driv nazev v bufferu2 da to TEMP1 0x02
                      00564         ; pokud se nazvy shoduji da do TEMP1 0x00
0C95   1A59           00565         btfsc HL_PARAMETRY,4            ;       IF     (hledame dalsi zaznam)
0C96   2CA6           00566         goto HLEDEJ_ELSE3
0C97   1C36           00567         btfss TEMP1,0                           ;               IF (ZAZ_A > ZAZ_REF)
0C98   2CAC           00568         goto HLEDEJ_ENDIF3
                      00569 
                      00570         BANK_2
0C99   1703               M                 bsf     STATUS,RP1              ; BANK2  RP1:RP0 = 10
0C9A   1283               M                 bcf     STATUS,RP0    
0C9B   0830           00571         movfw 0x30
                      00572         BANK_0
0C9C   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0C9D   1283               M                 bcf     STATUS,RP0    
0C9E   39FF           00573         andlw h'FF'
0C9F   1903           00574         btfsc STATUS,Z
0CA0   2CA4           00575         goto HLEDEJ_IF4
                      00576 
0CA1   24F8           00577         call COMPARE_BUFF2_L_H
                      00578         ; porovna nazvy souboru na zacatku bufferu2 a na konci bufferu2
                      00579         ; pokud v abecede je driv nazev v horni polovine buff2 da to TEMP1 0x01
                      00580         ; pokud v abecede je driv nazev v dolni polovine buff2 da to TEMP1 0x02
                      00581         ; pokud se nazvy shoduji da do TEMP1 0x00
0CA2   1CB6           00582         btfss TEMP1,1
0CA3   2CAC           00583         goto HLEDEJ_ENDIF3
0CA4                  00584 HLEDEJ_IF4                                              ;               AND ((ZAZ_A < ZAZ_N) OR (ZAZ_N i
                            s empty)):
0CA4   25E5           00585         call BUF2_LOW_TO_HIGH           ;                               ZAZ_N := ZAZ_A
0CA5   2CAC           00586         goto HLEDEJ_ENDIF3                      ;               ENDIF
0CA6                  00587 HLEDEJ_ELSE3                                    ;       ELSEIF (hledame predchozi zaznam)
0CA6   1CB6           00588         btfss TEMP1,1                           ;               IF (ZAZ_A < ZAZ_REF)
0CA7   2CAC           00589         goto HLEDEJ_ENDIF3
0CA8   24F8           00590         call COMPARE_BUFF2_L_H
0CA9   1C36           00591         btfss TEMP1,0                           ;               AND (ZAZ_A > ZAZ_N):
0CAA   2CAC           00592         goto HLEDEJ_ENDIF3
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 95


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0CAB   25E5           00593         call BUF2_LOW_TO_HIGH           ;                               ZAZ_N := ZAZ_A
0CAC                  00594 HLEDEJ_ENDIF3                                   ;       ENDIF
                      00595         
0CAC   2C81           00596         goto HLEDEJ_REPEAT
0CAD                  00597 HLEDEJ_END_REPEAT
                      00598 
                      00599 ; if (HL_PARAMETRY = [predchozi]) and (ZAZ_N = 00000) and (!ROOT):
                      00600 ;       ZAZ_N naplnit daty ze zaznamu 1
                      00601 ; endif;
0CAD   1E59           00602         btfss HL_PARAMETRY,4            ; if (HL_PARAMETRY = [predchozi])
0CAE   2CC8           00603         goto HLEDEJ_KONEC
0CAF   1FD9           00604         btfss HL_PARAMETRY,7            ;       and (!ROOT)
0CB0   2CC8           00605         goto HLEDEJ_KONEC
                      00606         BANK_2
0CB1   1703               M                 bsf     STATUS,RP1              ; BANK2  RP1:RP0 = 10
0CB2   1283               M                 bcf     STATUS,RP0    
0CB3   0830           00607         movfw 0x30
                      00608         BANK_0
0CB4   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0CB5   1283               M                 bcf     STATUS,RP0    
0CB6   39FF           00609         andlw h'FF'
0CB7   1D03           00610         btfss STATUS,Z                          ;       and (ZAZ_N is empty):
0CB8   2CC8           00611         goto HLEDEJ_KONEC
                      00612 
0CB9   085A           00613         movfw HL_ADR_CL1
0CBA   00BC           00614         movwf CLUSTER1
0CBB   085B           00615         movfw HL_ADR_CL2
0CBC   00BD           00616         movwf CLUSTER2
0CBD   085C           00617         movfw HL_ADR_CL3
0CBE   00BE           00618         movwf CLUSTER3
0CBF   085D           00619         movfw HL_ADR_CL4
0CC0   00BF           00620         movwf CLUSTER4
0CC1   3001           00621         movlw .1
0CC2   00E0           00622         movwf ZAZNAM1
0CC3   01E1           00623         clrf ZAZNAM2
0CC4   233D           00624         call SKOC_NA_ZAZNAM     
0CC5   23B4           00625         call FILE_INFO
0CC6   24C9           00626         call ZAPIS_C_ZAZNAMU
0CC7   25E5           00627         call BUF2_LOW_TO_HIGH
                      00628 
0CC8                  00629 HLEDEJ_KONEC                                    ; endif;
0CC8   0008           00630         return
                      00631 ;**************************************************************************
0CC9                  00632 ZAPIS_C_ZAZNAMU
                      00633         ; podprogram FILE_INFO nam dava vsechny mozny informace o souboru, krome cisla zaznamu, 
                      00634         ; proto si toto cislo musime zapsat sami do bufferu2
0CC9   0860           00635         movfw ZAZNAM1
                      00636         BANK_2
0CCA   1703               M                 bsf     STATUS,RP1              ; BANK2  RP1:RP0 = 10
0CCB   1283               M                 bcf     STATUS,RP0    
0CCC   00A0           00637         movwf 0x120
                      00638         BANK_0
0CCD   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0CCE   1283               M                 bcf     STATUS,RP0    
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 96


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0CCF   0861           00639         movfw ZAZNAM2
                      00640         BANK_2
0CD0   1703               M                 bsf     STATUS,RP1              ; BANK2  RP1:RP0 = 10
0CD1   1283               M                 bcf     STATUS,RP0    
0CD2   00A1           00641         movwf 0x121
                      00642         BANK_0
0CD3   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0CD4   1283               M                 bcf     STATUS,RP0    
0CD5   0008           00643         return
                      00644 ;**************************************************************************
0CD6                  00645 VYHOVUJE_ZAZNAM
                      00646         ; pokud zaznam ZAZ_A v bufferu2 vyhovuje hledani, nastavi bit TEMP1,0
0CD6   01B6           00647         clrf TEMP1
                      00648         BANK_2
0CD7   1703               M                 bsf     STATUS,RP1              ; BANK2  RP1:RP0 = 10
0CD8   1283               M                 bcf     STATUS,RP0    
0CD9   0810           00649         movfw 0x110
                      00650         BANK_0
0CDA   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0CDB   1283               M                 bcf     STATUS,RP0    
                      00651         ;               1.     byte ->  = 00h -> zaznam je prazdny; 
                      00652         ;                                               = 01h -> zaznam je adresar; 
                      00653         ;                                               = 02h -> zaznam je soubor; 
                      00654         ;                                               = 06h -> zaznam je soubor s priponou MP3
0CDC   00B7           00655         movwf TEMP2
0CDD   39FF           00656         andlw h'FF'
0CDE   1903           00657         btfsc STATUS,Z
0CDF   0008           00658         return                          ; pokud je zaznam prazdny, tak jej proste neberem
                      00659 ;HL_PARAMETRY   equ 0x059
                      00660 ;               0. bit = 0 > pokud hledáme soubory, tak pouze MP3
;                              1 > pok
                            ud hledáme soubory, vrací všechny soubory
;             1. bit = 0 > hledáme klasicky (nejdøíve 
0CE0   1CD9           00661         btfss HL_PARAMETRY,1
0CE1   2CEF           00662         goto VYHOV_ZAZ_SOUBiADR
0CE2   1D59           00663         btfss HL_PARAMETRY,2
0CE3   2CEC           00664         goto VYHOV_ZAZ_ONLY_ADR
0CE4   1C59           00665         btfss HL_PARAMETRY,0
0CE5   2CE9           00666         goto VYHOV_ZAZ_ONLY_MP3
0CE6                  00667 VYHOV_ZAZ_ALL_FILES
0CE6   1C37           00668         btfss TEMP2,0
0CE7   1436           00669         bsf TEMP1,0
0CE8   0008           00670         return          
0CE9                  00671 VYHOV_ZAZ_ONLY_MP3
0CE9   1937           00672         btfsc TEMP2,2
0CEA   1436           00673         bsf TEMP1,0
0CEB   0008           00674         return
0CEC                  00675 VYHOV_ZAZ_ONLY_ADR
0CEC   1837           00676         btfsc TEMP2,0
0CED   1436           00677         bsf TEMP1,0
0CEE   0008           00678         return
0CEF                  00679 VYHOV_ZAZ_SOUBiADR
0CEF   1C59           00680         btfss HL_PARAMETRY,0
0CF0   2CF3           00681         goto VYHOV_ZAZ_SOUBiADR_MP3
0CF1   1436           00682         bsf TEMP1,0
0CF2   0008           00683         return
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 97


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0CF3                  00684 VYHOV_ZAZ_SOUBiADR_MP3
0CF3   1837           00685         btfsc TEMP2,0
0CF4   1436           00686         bsf TEMP1,0
0CF5   1937           00687         btfsc TEMP2,2
0CF6   1436           00688         bsf TEMP1,0
0CF7   0008           00689         return
                      00690 ;**************************************************************************
0CF8                  00691 COMPARE_BUFF2_L_H
                      00692 ; porovna nazvy souboru na zacatku bufferu2 a na konci bufferu2
                      00693 ; pokud v abecede je driv nazev v horni polovine buff2 da to TEMP1 0x01
                      00694 ; pokud v abecede je driv nazev v dolni polovine buff2 da to TEMP1 0x02
                      00695 ; pokud se nazvy shoduji da do TEMP1 0x00
0CF8   01B6           00696         clrf TEMP1
                      00697         INDF_BANK_2                     ; stejne jako INDF_BANK_2
0CF9   1783               M                         bsf STATUS,IRP    
                      00698         BANK_0
0CFA   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0CFB   1283               M                 bcf     STATUS,RP0    
0CFC   3010           00699         movlw 0x10
0CFD   0084           00700         movwf FSR
0CFE   0800           00701         movfw INDF
0CFF   3903           00702         andlw h'03'                     ; ted nerozlisuji mezi souborem mp3 a ostatnimi soubory
0D00   00B7           00703         movwf TEMP2
                      00704 
0D01   3030           00705         movlw 0x30
0D02   0084           00706         movwf FSR
0D03   0800           00707         movfw INDF
0D04   3903           00708         andlw h'03'                     ; ted nerozlisuji mezi souborem mp3 a ostatnimi soubory 
0D05   0237           00709         subwf TEMP2,W           ; prni byte z bufferu 2 - prvni byte z bufferu 1
                      00710 
0D06   1903           00711         btfsc STATUS,Z
0D07   2D1E           00712         goto COMPARE_B1_B2_BYT2         ; prvni byt signalizujici typ byl shodny, pokracujeme bytem druh
                            ym (prvni byt nazvu)
0D08   1C03           00713         btfss STATUS,C
0D09   2D96           00714         goto COMPARE_B1_B2_BUFF2        ; hodnota v bufferu 1 byla vetsi, proto je v abecede dal...
0D0A   2D91           00715         goto COMPARE_B1_B2_BUFF1
                      00716 ; tato procedura je temer shodna s tou nasledujici, proto jen zadame jinou hodnotu do FSR
                      00717 ; (misto pro buffer1 na horni pulku bufferu2) a nechame probehnout stejny kus kodu...
                      00718 ;**************************************************************************
0D0B                  00719 COMPARE_BUFF1_BUFF2
                      00720 ; porovna nazvy souboru na zacatku bufferu1 s bufferem2
                      00721 ; pokud v abecede je driv nazev v bufferu1 da to TEMP1 0x01
                      00722 ; pokud v abecede je driv nazev v bufferu2 da to TEMP1 0x02
                      00723 ; pokud se nazvy shoduji da do TEMP1 0x00
                      00724 
                      00725 ; zaznamy v obou bufferech vypadaji nasledovne:
                      00726 ;               1.     byte ->  = 00h -> zaznam je prazdny; 
                      00727 ;                                               = 01h -> zaznam je adresar; 
                      00728 ;                                               = 02h -> zaznam je soubor; 
                      00729 ;                                               = 06h -> zaznam je soubor s priponou MP3
                      00730 ;               2..9   byte -> 8 znaku dlouhe jmeno ("DOSovsky" tvar - napr. slouzka "dokumenty" = "DOKU
                            ME~1" )
                      00731 ;               10..12 byte -> u souboru tri znaky pripony (u adresaru vetsinou mezery - 20h 20h 20h)
                      00732 ;               13..16 byte -> 1. cluster souboru
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 98


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0D0B   01B6           00733         clrf TEMP1
                      00734         INDF_BANK_3                     ; stejne jako INDF_BANK_2
0D0C   1783               M                         bsf STATUS,IRP    
                      00735         BANK_0
0D0D   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0D0E   1283               M                 bcf     STATUS,RP0    
0D0F   3010           00736         movlw 0x10
0D10   0084           00737         movwf FSR
0D11   0800           00738         movfw INDF
0D12   3903           00739         andlw h'03'                     ; ted nerozlisuji mezi souborem mp3 a ostatnimi soubory
0D13   00B7           00740         movwf TEMP2
                      00741 
0D14   3090           00742         movlw 0x90
0D15   0084           00743         movwf FSR
0D16   0800           00744         movfw INDF
0D17   3903           00745         andlw h'03'                     ; ted nerozlisuji mezi souborem mp3 a ostatnimi soubory 
0D18   0237           00746         subwf TEMP2,W           ; prni byte z bufferu 2 - prvni byte z bufferu 1
                      00747 
0D19   1903           00748         btfsc STATUS,Z
0D1A   2D1E           00749         goto COMPARE_B1_B2_BYT2 ; prvni byt signalizujici typ byl shodny, pokracujeme bytem druhym (prvn
                            i byt nazvu)
0D1B   1C03           00750         btfss STATUS,C
0D1C   2D96           00751         goto COMPARE_B1_B2_BUFF2        ; hodnota v bufferu 1 byla vetsi, proto je v abecede dal...
0D1D   2D91           00752         goto COMPARE_B1_B2_BUFF1
                      00753 
0D1E                  00754 COMPARE_B1_B2_BYT2
                      00755         BANK_2
0D1E   1703               M                 bsf     STATUS,RP1              ; BANK2  RP1:RP0 = 10
0D1F   1283               M                 bcf     STATUS,RP0    
0D20   0A84           00756         incf FSR,F
0D21   0800           00757         movfw INDF
0D22   0211           00758         subwf 0x111,W                           ; 2. byte z bufferu 2 - 2. byte z bufferu 1
0D23   1903           00759         btfsc STATUS,Z
0D24   2D28           00760         goto COMPARE_B1_B2_BYT3
0D25   1C03           00761         btfss STATUS,C
0D26   2D96           00762         goto COMPARE_B1_B2_BUFF2        ; hodnota v bufferu 1 byla vetsi, proto je v abecede dal...
0D27   2D91           00763         goto COMPARE_B1_B2_BUFF1
                      00764 
0D28                  00765 COMPARE_B1_B2_BYT3
                      00766         BANK_2
0D28   1703               M                 bsf     STATUS,RP1              ; BANK2  RP1:RP0 = 10
0D29   1283               M                 bcf     STATUS,RP0    
0D2A   0A84           00767         incf FSR,F
0D2B   0800           00768         movfw INDF
0D2C   0212           00769         subwf 0x112,W                           ; 3. byte z bufferu 2 - 3. byte z bufferu 1
0D2D   1903           00770         btfsc STATUS,Z
0D2E   2D32           00771         goto COMPARE_B1_B2_BYT4
0D2F   1C03           00772         btfss STATUS,C
0D30   2D96           00773         goto COMPARE_B1_B2_BUFF2        ; hodnota v bufferu 1 byla vetsi, proto je v abecede dal...
0D31   2D91           00774         goto COMPARE_B1_B2_BUFF1
                      00775 
0D32                  00776 COMPARE_B1_B2_BYT4
                      00777         BANK_2
0D32   1703               M                 bsf     STATUS,RP1              ; BANK2  RP1:RP0 = 10
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 99


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0D33   1283               M                 bcf     STATUS,RP0    
0D34   0A84           00778         incf FSR,F
0D35   0800           00779         movfw INDF
0D36   0213           00780         subwf 0x113,W                           ; 4. byte z bufferu 2 - 4. byte z bufferu 1
0D37   1903           00781         btfsc STATUS,Z
0D38   2D3C           00782         goto COMPARE_B1_B2_BYT5
0D39   1C03           00783         btfss STATUS,C
0D3A   2D96           00784         goto COMPARE_B1_B2_BUFF2        ; hodnota v bufferu 1 byla vetsi, proto je v abecede dal...
0D3B   2D91           00785         goto COMPARE_B1_B2_BUFF1
                      00786 
0D3C                  00787 COMPARE_B1_B2_BYT5
                      00788         BANK_2
0D3C   1703               M                 bsf     STATUS,RP1              ; BANK2  RP1:RP0 = 10
0D3D   1283               M                 bcf     STATUS,RP0    
0D3E   0A84           00789         incf FSR,F
0D3F   0800           00790         movfw INDF
0D40   0214           00791         subwf 0x114,W                           ; 5. byte z bufferu 2 - 5. byte z bufferu 1
0D41   1903           00792         btfsc STATUS,Z
0D42   2D46           00793         goto COMPARE_B1_B2_BYT6
0D43   1C03           00794         btfss STATUS,C
0D44   2D96           00795         goto COMPARE_B1_B2_BUFF2        ; hodnota v bufferu 1 byla vetsi, proto je v abecede dal...
0D45   2D91           00796         goto COMPARE_B1_B2_BUFF1
                      00797 
0D46                  00798 COMPARE_B1_B2_BYT6
                      00799         BANK_2
0D46   1703               M                 bsf     STATUS,RP1              ; BANK2  RP1:RP0 = 10
0D47   1283               M                 bcf     STATUS,RP0    
0D48   0A84           00800         incf FSR,F
0D49   0800           00801         movfw INDF
0D4A   0215           00802         subwf 0x115,W                           ; 6. byte z bufferu 2 - 6. byte z bufferu 1
0D4B   1903           00803         btfsc STATUS,Z
0D4C   2D50           00804         goto COMPARE_B1_B2_BYT7
0D4D   1C03           00805         btfss STATUS,C
0D4E   2D96           00806         goto COMPARE_B1_B2_BUFF2        ; hodnota v bufferu 1 byla vetsi, proto je v abecede dal...
0D4F   2D91           00807         goto COMPARE_B1_B2_BUFF1
                      00808 
0D50                  00809 COMPARE_B1_B2_BYT7
                      00810         BANK_2
0D50   1703               M                 bsf     STATUS,RP1              ; BANK2  RP1:RP0 = 10
0D51   1283               M                 bcf     STATUS,RP0    
0D52   0A84           00811         incf FSR,F
0D53   0800           00812         movfw INDF
0D54   0216           00813         subwf 0x116,W                           ; 7. byte z bufferu 2 - 7. byte z bufferu 1
0D55   1903           00814         btfsc STATUS,Z
0D56   2D5A           00815         goto COMPARE_B1_B2_BYT8
0D57   1C03           00816         btfss STATUS,C
0D58   2D96           00817         goto COMPARE_B1_B2_BUFF2        ; hodnota v bufferu 1 byla vetsi, proto je v abecede dal...
0D59   2D91           00818         goto COMPARE_B1_B2_BUFF1
                      00819 
0D5A                  00820 COMPARE_B1_B2_BYT8
                      00821         BANK_2
0D5A   1703               M                 bsf     STATUS,RP1              ; BANK2  RP1:RP0 = 10
0D5B   1283               M                 bcf     STATUS,RP0    
0D5C   0A84           00822         incf FSR,F
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 100


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0D5D   0800           00823         movfw INDF
0D5E   0217           00824         subwf 0x117,W                           ; 8. byte z bufferu 2 - 8. byte z bufferu 1
0D5F   1903           00825         btfsc STATUS,Z
0D60   2D64           00826         goto COMPARE_B1_B2_BYT9
0D61   1C03           00827         btfss STATUS,C
0D62   2D96           00828         goto COMPARE_B1_B2_BUFF2        ; hodnota v bufferu 1 byla vetsi, proto je v abecede dal...
0D63   2D91           00829         goto COMPARE_B1_B2_BUFF1
                      00830 
0D64                  00831 COMPARE_B1_B2_BYT9
                      00832         BANK_2
0D64   1703               M                 bsf     STATUS,RP1              ; BANK2  RP1:RP0 = 10
0D65   1283               M                 bcf     STATUS,RP0    
0D66   0A84           00833         incf FSR,F
0D67   0800           00834         movfw INDF
0D68   0218           00835         subwf 0x118,W                           ; 9. byte z bufferu 2 - 9. byte z bufferu 1
0D69   1903           00836         btfsc STATUS,Z
0D6A   2D6E           00837         goto COMPARE_B1_B2_BYT10
0D6B   1C03           00838         btfss STATUS,C
0D6C   2D96           00839         goto COMPARE_B1_B2_BUFF2        ; hodnota v bufferu 1 byla vetsi, proto je v abecede dal...
0D6D   2D91           00840         goto COMPARE_B1_B2_BUFF1
                      00841 
0D6E                  00842 COMPARE_B1_B2_BYT10
                      00843         BANK_2
0D6E   1703               M                 bsf     STATUS,RP1              ; BANK2  RP1:RP0 = 10
0D6F   1283               M                 bcf     STATUS,RP0    
0D70   0A84           00844         incf FSR,F
0D71   0800           00845         movfw INDF
0D72   0219           00846         subwf 0x119,W                           ; 10. byte z bufferu 2 - 10. byte z bufferu 1
0D73   1903           00847         btfsc STATUS,Z
0D74   2D78           00848         goto COMPARE_B1_B2_BYT11
0D75   1C03           00849         btfss STATUS,C
0D76   2D96           00850         goto COMPARE_B1_B2_BUFF2        ; hodnota v bufferu 1 byla vetsi, proto je v abecede dal...
0D77   2D91           00851         goto COMPARE_B1_B2_BUFF1
                      00852 
0D78                  00853 COMPARE_B1_B2_BYT11
                      00854         BANK_2
0D78   1703               M                 bsf     STATUS,RP1              ; BANK2  RP1:RP0 = 10
0D79   1283               M                 bcf     STATUS,RP0    
0D7A   0A84           00855         incf FSR,F
0D7B   0800           00856         movfw INDF
0D7C   021A           00857         subwf 0x11A,W                           ; 11. byte z bufferu 2 - 11. byte z bufferu 1
0D7D   1903           00858         btfsc STATUS,Z
0D7E   2D82           00859         goto COMPARE_B1_B2_BYT12
0D7F   1C03           00860         btfss STATUS,C
0D80   2D96           00861         goto COMPARE_B1_B2_BUFF2        ; hodnota v bufferu 1 byla vetsi, proto je v abecede dal...
0D81   2D91           00862         goto COMPARE_B1_B2_BUFF1
                      00863 
0D82                  00864 COMPARE_B1_B2_BYT12
                      00865         BANK_2
0D82   1703               M                 bsf     STATUS,RP1              ; BANK2  RP1:RP0 = 10
0D83   1283               M                 bcf     STATUS,RP0    
0D84   0A84           00866         incf FSR,F
0D85   0800           00867         movfw INDF
0D86   021B           00868         subwf 0x11B,W                           ; 12. byte z bufferu 2 - 12. byte z bufferu 1
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 101


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0D87   1903           00869         btfsc STATUS,Z
0D88   2D8C           00870         goto COMPARE_B1_B2_SHODNE
0D89   1C03           00871         btfss STATUS,C
0D8A   2D96           00872         goto COMPARE_B1_B2_BUFF2        ; hodnota v bufferu 1 byla vetsi, proto je v abecede dal...
0D8B   2D91           00873         goto COMPARE_B1_B2_BUFF1
                      00874 
0D8C                  00875 COMPARE_B1_B2_SHODNE
                      00876         BANK_0
0D8C   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0D8D   1283               M                 bcf     STATUS,RP0    
0D8E   3000           00877         movlw h'00'
0D8F   00B6           00878         movwf TEMP1     
0D90   0008           00879         return
0D91                  00880 COMPARE_B1_B2_BUFF1
                      00881         BANK_0
0D91   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0D92   1283               M                 bcf     STATUS,RP0    
0D93   3001           00882         movlw h'01'
0D94   00B6           00883         movwf TEMP1     
0D95   0008           00884         return
0D96                  00885 COMPARE_B1_B2_BUFF2
                      00886         BANK_0
0D96   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0D97   1283               M                 bcf     STATUS,RP0    
0D98   3002           00887         movlw h'02'
0D99   00B6           00888         movwf TEMP1
0D9A   0008           00889         return
                      00890 ;**************************************************************************
0D9B                  00891 CLEAR_BUFFER1           ; BUFFER1 je 64bytu dat v bance 3 na adrese 0x190 - 0x1CF
                      00892                                         ; pouziva TEMP1
0D9B   3040           00893         movlw .64
0D9C   00B6           00894         movwf TEMP1
                      00895         INDF_BANK_3             ; neprime adresovani na banku 3
0D9D   1783               M                         bsf STATUS,IRP    
0D9E   3090           00896         movlw 0x90
0D9F   0084           00897         movwf FSR
0DA0   3000           00898         movlw .0
                      00899 
0DA1                  00900 CLEAR_BEFFER1__CLEAR
0DA1   0080           00901         movwf INDF
0DA2   0A84           00902         incf FSR,F
0DA3   0BB6           00903         decfsz TEMP1,F
0DA4   2DA1           00904         goto CLEAR_BEFFER1__CLEAR
                      00905 
                      00906         INDF_BANK_0             ; neprime adresovani na banku 0
0DA5   1383               M                         bcf STATUS,IRP    
0DA6   0008           00907         return
                      00908 ;**************************************************************************
0DA7                  00909 BUF2_TO_BUF1
                      00910         ; hodi 18 dat z dolni pulky bufferu 2 do dolni pulky bufferu 1
                      00911         ; 0x110 -> 0x190
                      00912         INDF_BANK_3
0DA7   1783               M                         bsf STATUS,IRP    
                      00913         BANK_2
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 102


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0DA8   1703               M                 bsf     STATUS,RP1              ; BANK2  RP1:RP0 = 10
0DA9   1283               M                 bcf     STATUS,RP0    
0DAA   3090           00914         movlw 0x90
0DAB   0084           00915         movwf FSR
                      00916 
0DAC   0810           00917         movfw 0x110
0DAD   0080           00918         movwf INDF
0DAE   0A84           00919         incf FSR,F
0DAF   0811           00920         movfw 0x111
0DB0   0080           00921         movwf INDF
0DB1   0A84           00922         incf FSR,F
0DB2   0812           00923         movfw 0x112
0DB3   0080           00924         movwf INDF
0DB4   0A84           00925         incf FSR,F
0DB5   0813           00926         movfw 0x113
0DB6   0080           00927         movwf INDF
0DB7   0A84           00928         incf FSR,F
0DB8   0814           00929         movfw 0x114
0DB9   0080           00930         movwf INDF
0DBA   0A84           00931         incf FSR,F
0DBB   0815           00932         movfw 0x115
0DBC   0080           00933         movwf INDF
0DBD   0A84           00934         incf FSR,F
0DBE   0816           00935         movfw 0x116
0DBF   0080           00936         movwf INDF
0DC0   0A84           00937         incf FSR,F
0DC1   0817           00938         movfw 0x117
0DC2   0080           00939         movwf INDF
0DC3   0A84           00940         incf FSR,F
0DC4   0818           00941         movfw 0x118
0DC5   0080           00942         movwf INDF
0DC6   0A84           00943         incf FSR,F
0DC7   0819           00944         movfw 0x119
0DC8   0080           00945         movwf INDF
0DC9   0A84           00946         incf FSR,F
0DCA   081A           00947         movfw 0x11A
0DCB   0080           00948         movwf INDF
0DCC   0A84           00949         incf FSR,F
0DCD   081B           00950         movfw 0x11B
0DCE   0080           00951         movwf INDF
0DCF   0A84           00952         incf FSR,F
0DD0   081C           00953         movfw 0x11C
0DD1   0080           00954         movwf INDF
0DD2   0A84           00955         incf FSR,F
0DD3   081D           00956         movfw 0x11D
0DD4   0080           00957         movwf INDF
0DD5   0A84           00958         incf FSR,F
0DD6   081E           00959         movfw 0x11E
0DD7   0080           00960         movwf INDF
0DD8   0A84           00961         incf FSR,F
0DD9   081F           00962         movfw 0x11F
0DDA   0080           00963         movwf INDF
0DDB   0A84           00964         incf FSR,F
                      00965 
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 103


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0DDC   0820           00966         movfw 0x120
0DDD   0080           00967         movwf INDF
0DDE   0A84           00968         incf FSR,F
0DDF   0821           00969         movfw 0x121
0DE0   0080           00970         movwf INDF
0DE1   0A84           00971         incf FSR,F
                      00972         BANK_0
0DE2   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0DE3   1283               M                 bcf     STATUS,RP0    
0DE4   0008           00973         return
                      00974 ;**************************************************************************
0DE5                  00975 BUF2_LOW_TO_HIGH
                      00976         ; hodi 18 dat z dolni pulky bufferu 2 do horni pulky bufferu 2
                      00977         ; 0x110 - 0x121 -> 0x130 - 0x141
                      00978         BANK_2
0DE5   1703               M                 bsf     STATUS,RP1              ; BANK2  RP1:RP0 = 10
0DE6   1283               M                 bcf     STATUS,RP0    
0DE7   0810           00979         movfw 0x110
0DE8   00B0           00980         movwf 0x130
0DE9   0811           00981         movfw 0x111
0DEA   00B1           00982         movwf 0x131
0DEB   0812           00983         movfw 0x112
0DEC   00B2           00984         movwf 0x132
0DED   0813           00985         movfw 0x113
0DEE   00B3           00986         movwf 0x133
0DEF   0814           00987         movfw 0x114
0DF0   00B4           00988         movwf 0x134
0DF1   0815           00989         movfw 0x115
0DF2   00B5           00990         movwf 0x135
0DF3   0816           00991         movfw 0x116
0DF4   00B6           00992         movwf 0x136
0DF5   0817           00993         movfw 0x117
0DF6   00B7           00994         movwf 0x137
0DF7   0818           00995         movfw 0x118
0DF8   00B8           00996         movwf 0x138
0DF9   0819           00997         movfw 0x119
0DFA   00B9           00998         movwf 0x139
0DFB   081A           00999         movfw 0x11A
0DFC   00BA           01000         movwf 0x13A
0DFD   081B           01001         movfw 0x11B
0DFE   00BB           01002         movwf 0x13B
0DFF   081C           01003         movfw 0x11C
0E00   00BC           01004         movwf 0x13C
0E01   081D           01005         movfw 0x11D
0E02   00BD           01006         movwf 0x13D
0E03   081E           01007         movfw 0x11E
0E04   00BE           01008         movwf 0x13E
0E05   081F           01009         movfw 0x11F
0E06   00BF           01010         movwf 0x13F
                      01011 
0E07   0820           01012         movfw 0x120
0E08   00C0           01013         movwf 0x140
0E09   0821           01014         movfw 0x121
0E0A   00C1           01015         movwf 0x141
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 104


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      01016         BANK_0
0E0B   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0E0C   1283               M                 bcf     STATUS,RP0    
0E0D   0008           01017         return
                      01018 ;**************************************************************************
1000                  00078  org 0x1000                                     ; PAGE 2
1800                  00079  org 0x1800                                     ; PAGE 3
                      00080 ;**********************************************************
                      00081         END
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 105


SYMBOL TABLE
  LABEL                             VALUE 

ABRT                              00000002
ACKDT                             00000005
ACKEN                             00000004
ACKSTAT                           00000006
ADCON0                            0000001F
ADCON1                            0000009F
ADCS0                             00000006
ADCS1                             00000007
ADDEN                             00000003
ADFM                              00000007
ADIE                              00000006
ADIF                              00000006
ADON                              00000000
ADRESH                            0000001E
ADRESL                            0000009E
APPLICABLE                        00000007
ATA_ADDRESS                       00000007
ATA_ADDRESS_TRIS                  00000087
ATA_ATTRIBUTES                    0000002E
ATA_CONTROL                       00000009
ATA_CONTROL_TRIS                  00000089
ATA_DIOR_N                        ATA_CONTROL,2
ATA_DIOW_N                        ATA_CONTROL,1
ATA_ERROR                         00000025
ATA_OK                            00000000
ATA_RESET                         0000027E
ATA_RESET_N                       ATA_CONTROL,0
ATA_STATUS                        0000002C
ATA_STATUS_A                      00000022
BANK_0                            
BANK_1                            
BANK_2                            
BANK_3                            
BCLIE                             00000003
BCLIF                             00000003
BF                                00000000
BIG_LOOP                          0000003B
BIG_LOOP__NENI_PRIKAZ             00000051
BIG_SECTOR                        00000003
BRGH                              00000002
BSY                               00000007
BUF2_LOW_TO_HIGH                  00000DE5
BUF2_TO_BUF1                      00000DA7
C                                 00000000
CCP1CON                           00000017
CCP1IE                            00000002
CCP1IF                            00000002
CCP1M0                            00000000
CCP1M1                            00000001
CCP1M2                            00000002
CCP1M3                            00000003
CCP1X                             00000005
CCP1Y                             00000004
CCP2CON                           0000001D
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 106


SYMBOL TABLE
  LABEL                             VALUE 

CCP2IE                            00000000
CCP2IF                            00000000
CCP2M0                            00000000
CCP2M1                            00000001
CCP2M2                            00000002
CCP2M3                            00000003
CCP2X                             00000005
CCP2Y                             00000004
CCPR1H                            00000016
CCPR1L                            00000015
CCPR2H                            0000001C
CCPR2L                            0000001B
CEKEJ_PRIKAZ                      000008DD
CEK_PRIKAZ_01h                    00000020
CEK_PRIKAZ_02h_03h                0000002E
CHS0                              00000003
CHS1                              00000004
CHS2                              00000005
CKE                               00000006
CKP                               00000004
CLEAR_BEFFER1__CLEAR              00000DA1
CLEAR_BEFFER2__CLEAR              00000278
CLEAR_BUFFER1                     00000D9B
CLEAR_BUFFER2                     00000272
CLUSTER1                          0000003C
CLUSTER2                          0000003D
CLUSTER3                          0000003E
CLUSTER4                          0000003F
CLUSTER_SIZE                      0000004C
CLUSTER_TO_LBA                    000004B6
CLUSTER_TO_LBA_NO_ROOT            000004DA
COMMAND                           0000002D
COMPARE_B1_B2_BUFF1               00000D91
COMPARE_B1_B2_BUFF2               00000D96
COMPARE_B1_B2_BYT10               00000D6E
COMPARE_B1_B2_BYT11               00000D78
COMPARE_B1_B2_BYT12               00000D82
COMPARE_B1_B2_BYT2                00000D1E
COMPARE_B1_B2_BYT3                00000D28
COMPARE_B1_B2_BYT4                00000D32
COMPARE_B1_B2_BYT5                00000D3C
COMPARE_B1_B2_BYT6                00000D46
COMPARE_B1_B2_BYT7                00000D50
COMPARE_B1_B2_BYT8                00000D5A
COMPARE_B1_B2_BYT9                00000D64
COMPARE_B1_B2_SHODNE              00000D8C
COMPARE_BUFF1_BUFF2               00000D0B
COMPARE_BUFF2_L_H                 00000CF8
CREN                              00000004
CSRC                              00000007
D                                 00000005
DALSI_SKLADBA                     000000B0
DALSI_SKLADBA_MAME_SOUBOR         000000FE
DALSI_SKLADBA_NO_R_S              000000E1
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 107


SYMBOL TABLE
  LABEL                             VALUE 

DALSI_SKLADBA_PLAY                00000112
DALSI_SKLADBA_REPAT_SOUBORU       000000BA
DATA_ADDRESS                      00000005
DATA_H                            00000021
DATA_L                            00000020
DATA_PORT_HIGH                    00000008
DATA_PORT_HIGH_TRIS               00000088
DATA_PORT_LOW                     00000006
DATA_PORT_LOW_TRIS                00000086
DC                                00000001
DEKREMENTUJ                       000005F3
DEKREMENTUJ_KONEC                 00000600
DELAY_200ms                       000001B1
DELAY_25us                        00000324
DELAY_2ms                         000001A8
DELAY_500ms                       000001BA
DEVICE                            0000002B
DEVICE_C                          00000023
DRDY                              00000006
DRQ                               00000003
D_A                               00000005
D_COMMAND                         00000027
D_DATA_R                          00000020
D_DEVICE                          00000026
D_DEVICE_C                        00000016
D_ERROR                           00000021
D_FEATURES                        00000021
D_LBA1                            00000023
D_LBA2                            00000024
D_LBA3                            00000025
D_SECTOR_C                        00000022
D_STATUS                          00000027
D_STATUS_A                        00000016
EEADR                             0000010D
EEADRH                            0000010F
EECON1                            0000018C
EECON2                            0000018D
EEDATA                            0000010C
EEDATH                            0000010E
EEIE                              00000004
EEIF                              00000004
EEPGD                             00000007
END_OF_INTERRUPT                  000001A0
ERR                               00000000
ERROR_LED                         ATA_ADDRESS,3
F                                 00000001
FAT32_LOAD                        00000004
FEATURES                          00000024
FERR                              00000002
FILE_INFO                         00000BB4
FILE_INFO__DIR                    00000BF8
FILE_INFO__FILE                   00000BFA
FILE_INFO__KONEC                  00000C1F
FILE_INFO__READ_NAME              00000BBC
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 108


SYMBOL TABLE
  LABEL                             VALUE 

FILE_SIZE                         00000C20
FSR                               00000004
GCEN                              00000007
GIE                               00000007
GO                                00000002
GO_DONE                           00000002
HLEDEJ                            00000C3D
HLEDEJ_ELSE1                      00000C5F
HLEDEJ_ELSE3                      00000CA6
HLEDEJ_ENDIF3                     00000CAC
HLEDEJ_END_REPEAT                 00000CAD
HLEDEJ_HLEDANI                    00000C7D
HLEDEJ_IF2_ENDIF                  00000C77
HLEDEJ_IF4                        00000CA4
HLEDEJ_KONEC                      00000CC8
HLEDEJ_NEHLEDAME_PRVNI            00000C67
HLEDEJ_REPEAT                     00000C81
HL_ADR_CL1                        0000005A
HL_ADR_CL2                        0000005B
HL_ADR_CL3                        0000005C
HL_ADR_CL4                        0000005D
HL_PARAMETRY                      00000059
HOB                               00000007
I2C_DATA                          00000005
I2C_READ                          00000002
I2C_START                         00000003
I2C_STOP                          00000004
IBF                               00000007
IBOV                              00000005
IDENTIFY_DEVICE                   000002D1
IF2                               00000C74
INDF                              00000000
INDF_BANK_0                       
INDF_BANK_1                       
INDF_BANK_2                       
INDF_BANK_3                       
INIT_ATA__DALSI                   00000310
INIT_ATA__DALSI2                  0000031A
INIT_ATA__NOT_SUPPORT_LBA48       0000030D
INIT_CONFIG                       00000137
INIT_PORT                         00000124
INTCON                            0000000B
INTE                              00000004
INTEDG                            00000006
INTERRUPT                         00000192
INTF                              00000001
IRP                               00000007
LBA1                              00000027
LBA2                              00000028
LBA3                              00000029
LBA4                              0000002A
LBA48_SUPPORT                     00000002
LBA_SUPPORT                       00000001
MP3_BSYNC                         MP3_PORT,5
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 109


SYMBOL TABLE
  LABEL                             VALUE 

MP3_CS                            MP3_PORT,3
MP3_DREQ                          MP3_PORT,4
MP3_NOT_PLAY                      000000AF
MP3_PORT                          00000005
MP3_PORT_TRIS                     00000085
MP3_REWIND_FORWARD                00000081
MP3_SCLK                          MP3_PORT,2
MP3_SI                            MP3_PORT,1
MP3_SO                            MP3_PORT,0
NACTI_FAT32                       000003F2
NACTI_FAT32__KONEC                000004B5
NEXT_CLUSTER                      00000519
NEXT_CLUSTER_KONEC                0000059E
NEXT_CLUSTER_NEPRAZDNY            00000587
NEXT_CLUSTER_NO_ROOT              0000053D
NOT_A                             00000005
NOT_ADDRESS                       00000005
NOT_BO                            00000000
NOT_BOR                           00000000
NOT_DONE                          00000002
NOT_MP3_REWIND_FORWARD            0000008D
NOT_PD                            00000003
NOT_POR                           00000001
NOT_RBPU                          00000007
NOT_RC8                           00000006
NOT_T1SYNC                        00000002
NOT_TO                            00000004
NOT_TX8                           00000006
NOT_W                             00000002
NOT_WRITE                         00000002
NULA                              000006B0
OBF                               00000006
ODESLI_BUFF2_HIGH                 0000017E
ODESLI_BUFF2_HIGH_ODESILANI       00000181
ODESLI_BUFFER2                    00000188
ODESLI_BUFFER2_ODESILANI          0000018B
ODESLI_DATA                       00000165
ODESLI_MODEL_NUMBER               0000016D
ODESLI_MODEL_NUMBER_ODESILANI     00000172
OERR                              00000001
OPERAND_X1                        000000A0
OPERAND_X2                        000000A1
OPERAND_X3                        000000A2
OPERAND_X4                        000000A3
OPERAND_Y1                        000000A4
OPERAND_Y2                        000000A5
OPERAND_Y3                        000000A6
OPERAND_Y4                        000000A7
OPTION_REG                        00000081
P                                 00000004
PARAM_MAX_LBA1                    0000002F
PARAM_MAX_LBA2                    00000030
PARAM_MAX_LBA3                    00000031
PARAM_MAX_LBA4                    00000032
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 110


SYMBOL TABLE
  LABEL                             VALUE 

PARAM_SLOV_V_SEKTORU1             00000033
PARAM_SLOV_V_SEKTORU2             00000034
PCFG0                             00000000
PCFG1                             00000001
PCFG2                             00000002
PCFG3                             00000003
PCL                               00000002
PCLATH                            0000000A
PCON                              0000008E
PEIE                              00000006
PEN                               00000002
PIE1                              0000008C
PIE2                              0000008D
PIR1                              0000000C
PIR2                              0000000D
POCATEK_DAT1                      00000040
POCATEK_DAT2                      00000041
POCATEK_DAT3                      00000042
POCATEK_DAT4                      00000043
POCATEK_FAT1                      00000044
POCATEK_FAT2                      00000045
POCATEK_FAT3                      00000046
POCATEK_FAT4                      00000047
PORTA                             00000005
PORTB                             00000006
PORTC                             00000007
PORTD                             00000008
PORTE                             00000009
POSUNDOLEVA                       00000603
POSUNDOLEVA_1                     00000609
POSUNDOLEVA_2                     00000611
POSUNDOLEVA_3                     0000061A
POSUNDOLEVA_4                     00000624
POSUNDOLEVA_5                     0000062F
POSUNDOLEVA_6                     0000063B
POSUNDOLEVA_7                     00000648
POSUNDOPRAVA                      00000656
POSUNDOPRAVA_1                    0000065C
POSUNDOPRAVA_2                    00000665
POSUNDOPRAVA_3                    0000066F
POSUNDOPRAVA_4                    0000067A
POSUNDOPRAVA_5                    00000686
POSUNDOPRAVA_6                    00000693
POSUNDOPRAVA_7                    000006A1
POZDRAV                           0000015A
POZICE                            0000003B
PR2                               00000092
PREH_ADR_CL1                      00000062
PREH_ADR_CL2                      00000063
PREH_ADR_CL3                      00000064
PREH_ADR_CL4                      00000065
PREH_CITAC_PREV                   00000068
PREH_DATA_CL1                     00000069
PREH_DATA_CL2                     0000006A
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 111


SYMBOL TABLE
  LABEL                             VALUE 

PREH_DATA_CL3                     0000006B
PREH_DATA_CL4                     0000006C
PREH_DATA_POZICE                  0000006D
PREH_STAV0                        0000006E
PREH_STAV1                        0000006F
PREH_ZAZNAM1                      00000066
PREH_ZAZNAM2                      00000067
PRESKOC                           0000025C
PRETECENI                         000000AC
PRIJATE_DATO                      00000074
PRIJATYCH_DAT                     00000073
PRIKAZ_02h                        000008E2
PRIKAZ_02h__ODESILANI_ODDILU      000008F8
PRIKAZ_03h                        00000903
PRIKAZ_04h                        00000921
PRIKAZ_05h                        0000092E
PRIKAZ_05h_KONEC                  00000956
PRIKAZ_05h_PAR1_NOT_OK            00000942
PRIKAZ_05h_PAR1_OK                00000948
PRIKAZ_05h_PAR2_NOT_OK            0000094F
PRIKAZ_05h_PAR2_OK                00000955
PRIKAZ_06h                        0000095F
PRIKAZ_07h                        00000981
PRIKAZ_07h__ODESLI_SECTOR         0000099D
PRIKAZ_08h                        000009A8
PRIKAZ_08h_KONEC                  000009CB
PRIKAZ_08h_PAR1_NOT_OK            000009BC
PRIKAZ_08h_PAR1_OK                000009BF
PRIKAZ_08h_PAR2_NOT_OK            000009C6
PRIKAZ_08h_PAR2_OK                000009C9
PRIKAZ_09h                        000009D6
PRIKAZ_09h_KONEC                  00000A00
PRIKAZ_09h_SPATNY_PAR             000009FA
PRIKAZ_80h                        00000A09
PRIKAZ_80h_KONEC                  00000A5D
PRIKAZ_80h_PAR1_NOT_OK            00000A1D
PRIKAZ_80h_PAR1_OK                00000A23
PRIKAZ_80h_PAR2_NOT_OK            00000A2A
PRIKAZ_80h_PAR2_OK                00000A30
PRIKAZ_81h                        00000A68
PRIKAZ_82h                        00000A87
PRIKAZ_83h                        00000A9D
PRIKAZ_84h                        00000AD1
PROG_PAGE_0                       
PROG_PAGE_1                       
PROG_PAGE_2                       
PROG_PAGE_3                       
PRVNI_CL_ADRESARE                 00000B03
PRVNI_CL_ADRESARE_KONEC           00000B3C
PRVNI_CL_ADRESARE_MEZERY          00000B23
PS0                               00000000
PS1                               00000001
PS2                               00000002
PSA                               00000003
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 112


SYMBOL TABLE
  LABEL                             VALUE 

PSPIE                             00000007
PSPIF                             00000007
PSPMODE                           00000004
R                                 00000002
RBIE                              00000003
RBIF                              00000000
RC8_9                             00000006
RC9                               00000006
RCD8                              00000000
RCEN                              00000003
RCIE                              00000005
RCIF                              00000005
RCREG                             0000001A
RCSTA                             00000018
RD                                00000000
RD_DEVICE                         000001E3
RD_ERROR                          000001CB
RD_LBA1                           000001D7
RD_LBA2                           000001DB
RD_LBA3                           000001DF
RD_SC                             000001D3
RD_STATUS                         000001C7
RD_STATUS_A                       000001CF
READ_DATA                         00000241
READ_DATA_CTEME                   0000024A
READ_SECTOR                       00000299
READ_SECTOR_LBA27                 000002AA
READ_SECTOR_LBA48                 000002B9
READ_WRITE                        00000002
ROOT_DIR_CL1                      00000048
ROOT_DIR_CL2                      00000049
ROOT_DIR_CL3                      0000004A
ROOT_DIR_CL4                      0000004B
ROZDIL                            000005CA
RP0                               00000005
RP1                               00000006
RSEN                              00000001
RUTR                              0000021E
RUTW                              0000022B
RX9                               00000006
RX9D                              00000000
R_W                               00000002
S                                 00000003
SCAN_BR                           00000335
SCAN_MBR                          0000032F
SCAN_MBR__HLEDEJ_ROZSIRENY_ODDIL  0000037E
SCAN_MBR__KONEC                   000003A8
SECTOR_C                          00000026
SELECT_DEVICE                     00000260
SEN                               00000000
SEND_MP3_DATA                     00000072
SEND_MP3_WORD                     0000009E
SKOC_NA_ZAZNAM                    00000B3D
SKOC_NA_ZAZNAM_KONEC              00000BB3
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 113


SYMBOL TABLE
  LABEL                             VALUE 

SKOC_NA_ZAZNAM_MAME_CL            00000B96
SKOC_NA_ZAZNAM_MAME_ZAZNAM        00000BAE
SKOC_NA_ZAZNAM_MIMO_ROZSAH        00000BB1
SKOC_NA_ZAZNAM_PRESKOC_CL         00000B68
SMP                               00000007
SOUCET                            000005A1
SPBRG                             00000099
SPEN                              00000007
SREN                              00000005
SRST                              00000002
SSPADD                            00000093
SSPBUF                            00000013
SSPCON                            00000014
SSPCON2                           00000091
SSPEN                             00000005
SSPIE                             00000003
SSPIF                             00000003
SSPM0                             00000000
SSPM1                             00000001
SSPM2                             00000002
SSPM3                             00000003
SSPOV                             00000006
SSPSTAT                           00000094
START                             00000010
STATUS                            00000003
STAV_PRIKAZU                      00000075
SYNC                              00000004
T0CS                              00000005
T0IE                              00000005
T0IF                              00000002
T0SE                              00000004
T1CKPS0                           00000004
T1CKPS1                           00000005
T1CON                             00000010
T1INSYNC                          00000002
T1OSCEN                           00000003
T1SYNC                            00000002
T2CKPS0                           00000000
T2CKPS1                           00000001
T2CON                             00000012
TEMP1                             00000036
TEMP2                             00000037
TEMP3                             00000038
TEMP4                             00000039
TEMP5                             0000003A
TEMPW                             00000035
TEMP_FSR                          00000072
TEMP_PCLATH                       00000076
TEMP_STATUS                       00000071
TEMP_WORKING                      00000070
TMP0                              00000038
TMP1                              00000036
TMP2                              00000037
TMR0                              00000001
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 114


SYMBOL TABLE
  LABEL                             VALUE 

TMR1CS                            00000001
TMR1H                             0000000F
TMR1IE                            00000000
TMR1IF                            00000000
TMR1L                             0000000E
TMR1ON                            00000000
TMR2                              00000011
TMR2IE                            00000001
TMR2IF                            00000001
TMR2ON                            00000002
TOUTPS0                           00000003
TOUTPS1                           00000004
TOUTPS2                           00000005
TOUTPS3                           00000006
TRISA                             00000085
TRISB                             00000086
TRISC                             00000087
TRISD                             00000088
TRISE                             00000089
TRISE0                            00000000
TRISE1                            00000001
TRISE2                            00000002
TRMT                              00000001
TX8_9                             00000006
TX9                               00000006
TX9D                              00000000
TXD8                              00000000
TXEN                              00000005
TXIE                              00000004
TXIF                              00000004
TXREG                             00000019
TXSTA                             00000098
UA                                00000001
VS1001                            1
VSADDR_AIADDR                     0000000A
VSADDR_AICTRL0                    0000000D
VSADDR_AICTRL1                    0000000E
VSADDR_AUDATA                     00000005
VSADDR_CLOCKF                     00000003
VSADDR_DECODE_TIME                00000004
VSADDR_HDAT0                      00000008
VSADDR_HDAT1                      00000009
VSADDR_MODE                       00000000
VSADDR_STATUS                     00000001
VSADDR_VOL                        0000000B
VSADDR_WRAM                       00000006
VSADDR_WRAMADDR                   00000007
VSREG_MODE_L                      0000004D
VSREG_STATUS_L                    0000004E
VSREG_VOL_H                       00000050
VSREG_VOL_L                       0000004F
VS_BEEP                           000008BA
VS_END_BEEP                       000008A8
VS_INIT                           000008CE
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 115


SYMBOL TABLE
  LABEL                             VALUE 

VS_RD_BYTE                        00000835
VS_RD_REG                         0000086E
VS_SEND_1024_NULL                 00000896
VS_SEND_32_NULL                   0000088E
VS_SET_VOLUME                     0000089D
VS_SOFT_RESET                     00000879
VS_WR_BYTE                        00000800
VS_WR_REG                         00000863
VYHOVUJE_ZAZNAM                   00000CD6
VYHOV_ZAZ_ALL_FILES               00000CE6
VYHOV_ZAZ_ONLY_ADR                00000CEC
VYHOV_ZAZ_ONLY_MP3                00000CE9
VYHOV_ZAZ_SOUBiADR                00000CEF
VYHOV_ZAZ_SOUBiADR_MP3            00000CF3
VYSLEDEK1                         000000A8
VYSLEDEK2                         000000A9
VYSLEDEK3                         000000AA
VYSLEDEK4                         000000AB
W                                 00000000
WAIT_FOR_READY                    00000329
WAIT_FOR_VSDREQ                   000008A5
WCOL                              00000007
WR                                00000001
WREN                              00000002
WRERR                             00000003
WR_BLOCK                          0000020F
WR_COMMAND                        000001EC
WR_DC                             000001E7
WR_DEVICE                         00000205
WR_FEATURES                       0000020A
WR_LBA1                           000001F6
WR_LBA2                           000001FB
WR_LBA3                           00000200
WR_SC                             000001F1
WR_USART                          00000152
Z                                 00000002
ZAPIS_C_ZAZNAMU                   00000CC9
ZAPIS_DO_BUFFERU_1                00000264
ZAPIS_DO_BUFFERU_1__ZAPIS         00000267
ZAZNAM1                           00000060
ZAZNAM2                           00000061
ZKONTROLUJ_ODDIL_FAT32            000003A9
ZKONTROLUJ_ODDIL_FAT32__JMENOVKA  000003CC
ZKONTROLUJ_ODDIL_FAT32__KONEC     000003F1
_BODEN_OFF                        00003FBF
_BODEN_ON                         00003FFF
_CPD_OFF                          00003FFF
_CPD_ON                           00003EFF
_CP_ALL                           00000FCF
_CP_HALF                          00001FDF
_CP_OFF                           00003FFF
_CP_UPPER_256                     00002FEF
_DEBUG_OFF                        00003FFF
_DEBUG_ON                         000037FF
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 116


SYMBOL TABLE
  LABEL                             VALUE 

_HS_OSC                           00003FFE
_LP_OSC                           00003FFC
_LVP_OFF                          00003F7F
_LVP_ON                           00003FFF
_PWRTE_OFF                        00003FFF
_PWRTE_ON                         00003FF7
_RC_OSC                           00003FFF
_WDT_OFF                          00003FFB
_WDT_ON                           00003FFF
_WRT_ENABLE_OFF                   00003DFF
_WRT_ENABLE_ON                    00003FFF
_XT_OSC                           00003FFD
__16F877                          00000001
nEIN                              00000001


MEMORY USAGE MAP ('X' = Used,  '-' = Unused)

0000 : X---XXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0040 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0080 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
00C0 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0100 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0140 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0180 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
01C0 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0200 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0240 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0280 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
02C0 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0300 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0340 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0380 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
03C0 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0400 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0440 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0480 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
04C0 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0500 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0540 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0580 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
05C0 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0600 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0640 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0680 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
06C0 : XXX------------- ---------------- ---------------- ----------------
0800 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
MPASM 03.90 Released                               HLAVNI.ASM   12-29-2005  20:42:39         PAGE 117


MEMORY USAGE MAP ('X' = Used,  '-' = Unused)


0840 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0880 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
08C0 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0900 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0940 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0980 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
09C0 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0A00 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0A40 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0A80 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0AC0 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0B00 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0B40 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0B80 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0BC0 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0C00 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0C40 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0C80 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0CC0 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0D00 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0D40 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0D80 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0DC0 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0E00 : XXXXXXXXXXXXXX-- ---------------- ---------------- ----------------
2000 : -------X-------- ---------------- ---------------- ----------------

All other memory blocks unused.

Program Memory Words Used:  3278
Program Memory Words Free:  4914


Errors   :     0
Warnings :     0 reported,     0 suppressed
Messages :     0 reported,   328 suppressed

