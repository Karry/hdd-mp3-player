MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE  1


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00001 ;   HLAVNI SOUBOR 
                      00002 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00003 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00004 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00005 ;  MP3 PREPRCAVAC
                      00006 ; ================
                      00007 ; 
                      00008 ; Program mp3 prehravace pouzivajici jako zdroj dat ATA disk.
                      00009 ; 
                      00010 ; Umi identifikovat disk, precist libovolny sektor, v MBR  najit oddily se systemem souboru FAT32, 
                      00011 ; nacist spousteci zaznam FAT32, praci s FAT32, komunikaci s vs1001 a prehravani mp3 pres vs1001.
                      00012 ;
                      00013 ;
                      00014 ; dodelat:
                      00015 ;       - Podporu dlouhych nazvu souboru
                      00016 ;       - podporu ID3v1
                      00017 ;       - pak uz jen vychytavky...      (napr. do vs1001 naprogramovat ekvalizer a nejak ho ovladat...)
                      00018 ;       - najit a zabit chyby
                      00019 ;
                      00020 ; chyby o kterych vim:
                      00021 ;       - Obcas se nechce vs1001k resetovat. Snad tomu pomuze mala hardwarova uprava.
                      00022 ;       - Naopak se nekdy stane, ze se resetuje samovolne, snad tomu pomuze pridani tlumivek na napajeni
                            .
                      00023 ;
                      00024 ; srpen 2005 - rijen 2005 Karry - lukas.karas@centrum.cz
                      00025 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00026 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00027 
                      00028 
                      00029 ;**********************************************************
                      00030 ;   VERZE 1.0b
                      00031 ;**********************************************************
                      00032 ; !!!!!!!! VSECHNY CASOVE SMYCKY JSOU POCITANY NA Fosc=16MHz !!!!!
                      00033 ; !!!!!!!! NASTAVENI USARTu TAKY !!!!!!!
                      00034         LIST            p=PIC16f877,C=132,n=60
2007   3F3A           00035         __CONFIG        _WDT_OFF & _HS_OSC & _PWRTE_OFF & _BODEN_OFF & _LVP_OFF 
                      00036                         ; LVP_OFF = RB3 jako digitalni I/O
                      00037         errorlevel -302         ; vypnuti Message [302]: Register in operand not in bank 0.
                      00038         errorlevel -306         ; vypnuti Message[306] : Crossing page boundary -- ensure page bits are 
                            set.
                      00039                                                 ; ! zjednoduseni vypisu, ale riziko prehlednuti chyby
                      00040 ;**********************************************************
                      00041 
                      00042         include "P16F877.inc"   ; definice blbosti kolem procesoru
                      00001         LIST
                      00002 ; P16F877.INC  Standard Header File, Version 1.00    Microchip Technology, Inc.
                      00373         LIST
                      00043         include "mp3.inc"               ; definice promennych, konstant a portu
                      00001 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00002 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00003 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00004 ; DEFINICE PORTU
                      00005 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00006 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE  2


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00007 ;**********************************************************
                      00008 ; ZAPOJENI PORTU:
                      00009 ;       portA - MP3 dekoder vs1001g
                      00010 ;                               5      4     3   2     1         0
                      00011 ;                               BSYNC  DREQ  CS  SCLK  SI/SDATA  SO
                      00012 ;               portB - ATA datova sbernice (dolnich 8 bitu)
                      00013 ;               7   .. 0
                      00014 ;               DD7 .. DD0
                      00015 ;               portD - ATA datova sbernice (hornich 8 bitu)
                      00016 ;               15   .. 8
                      00017 ;               DD15 .. DD8 
                      00018 ;               portC - adresove signaly ATA, ERROR_LED, a USART
                      00019 ;                               7          6         5     4     3          2    1    0
                      00020 ;                               USART out  USART in  CS1-  CS0-  ERROR_LED  DA2  DA1  DA0  
                      00021 ;                               (signaly se znaminkem minus jsou aktivni v logicke 0 !!!)
                      00022 ;               portE - ridici signaly ATA
                      00023 ;                               2       1      0
                      00024 ;                               DIOR-   DIOW-  RESET-
                      00025 ;                               (signaly se znaminkem minus jsou aktivni v logicke 0 !!!)
                      00026 ;**********************************************************
  00000005            00027 MP3_PORT                equ PORTA
  00000085            00028 MP3_PORT_TRIS   equ TRISA
                      00029 ; BITY MP3_PORT
                      00030 #define MP3_SO          MP3_PORT,0      ; serial output - tady dostavame z dekoderu data
                      00031 #define MP3_SI          MP3_PORT,1      ; serial input  - pokud MP3_CS=1, tak posilame mp3 data, pokud =
                            0, tak posilame prikaz
                      00032 #define MP3_SCLK        MP3_PORT,2      ; clock - nabezna hrana urcuje platnost dat pri seriovem prenosu
                      00033 #define MP3_CS          MP3_PORT,3      ; cable select  - pokud MP3_CS=1, tak po SI posilame mp3 data, p
                            okud =0, tak posilame prikaz
                      00034 #define MP3_DREQ        MP3_PORT,4      ; data request  - pokud =1, tak dekoder pozaduje dalsi mp3 data
                      00035 #define MP3_BSYNC       MP3_PORT,5      ; pro synchronizaci - ma byt nastaven pri prvnim prenasenem bitu
                             kazdeho bytu
                      00036 ;**********************************************************
                      00037 ; pokud jsem dobre pochopil dataSheat dekoderu vs1001, tak staci do nej jen cpat data, a kdyz skonci mp3
                            , tak odeslat 1024 nulovych bytu,
                      00038 ; softwarove resetovat a posilat dalsi mp3...
                      00039 ;
                      00040 ; popis registru obvodu vs1001 najdete na strane 22 dataSheatu 
                      00041 ; v jeho registrech jsou k dispozici data z hlavicky mp3, zdali mp3 ma spravny format, 
                      00042 ; ovladani hlasitosti a dalsi spousty uzitecnych informaci
                      00043 ;**********************************************************
                      00044 ; PORTY DISKU
  00000007            00045 ATA_ADDRESS             equ PORTC
  00000009            00046 ATA_CONTROL             equ PORTE
  00000006            00047 DATA_PORT_LOW           equ PORTB
  00000008            00048 DATA_PORT_HIGH          equ PORTD
                      00049 
                      00050 
  00000087            00051 ATA_ADDRESS_TRIS        equ TRISC
  00000089            00052 ATA_CONTROL_TRIS        equ TRISE
  00000086            00053 DATA_PORT_LOW_TRIS      equ TRISB
  00000088            00054 DATA_PORT_HIGH_TRIS     equ TRISD
                      00055 
                      00056 ; bity ATA_ADDRESS portu
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE  3


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00057 #define ERROR_LED       ATA_ADDRESS,3
                      00058 ; bity ATA_CONTROL portu
                      00059 #define ATA_RESET_N     ATA_CONTROL,0
                      00060 #define ATA_DIOW_N      ATA_CONTROL,1
                      00061 #define ATA_DIOR_N      ATA_CONTROL,2
                      00062 
                      00063 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00064 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00065 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00066 ; DEFINICE KONSTANT
                      00067 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00068 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00069 ; ADRESY ATA REGISTRU:
                      00070 ;                                                                       / CHS adressing
                      00071 ;   +-----------+--------------+-------------------+-----------------+
                      00072 ;   | CS0- CS1- |  DA2 DA1 DA0 | READ              | WRITE           |   
                      00073 ;   +-----------+--------------+-------------------+-----------------+
                      00074 ;   | 1    1    |  x   x   x   | data bush h.imped (validace prikazu)|
                      00075 ;   +-----------+--------------+-------------------+-----------------+
                      00076 ;   | 1    0    |  1   1   0   | alternate status  | device control  |
                      00077 ;   +-----------+--------------+-------------------+-----------------+
                      00078 ;   | 0    1    |  0   0   0   | data              | data            |
                      00079 ;   | 0    1    |  0   0   1   | error             | features        |
                      00080 ;   | 0    1    |  0   1   0   |             sector count            |
                      00081 ;   | 0    1    |  0   1   1   |             LBA bits 0-7            |  sector number
                      00082 ;   | 0    1    |  1   0   0   |             LBA bits 8-15           |  cilinder LOW 
                      00083 ;   | 0    1    |  1   0   1   |             LBA bits 16-23          |  cilinder HIGH
                      00084 ;   | 0    1    |  1   1   0   |         device / LBA bits 24-27*    |  device, head
                      00085 ;   | 0    1    |  1   1   1   | status            | command         |
                      00086 ;   +-----------+--------------+-------------------+-----------------+
                      00087 ;   | 0    0    |  0   0   0   | invalid addres    | invalid addres  |
                      00088 ;   +-----------+--------------+-------------------+-----------------+
                      00089 ;
                      00090 ;   * 7 6 5 4   3     2     1     0 
                      00091 ;     1 L 1 DEV LBA27 LBA26 LBA25 LBA24
                      00092 ;  L=1 -> aresa je LBA , L=0 -> adresa je CHS
                      00093 ;  DEV=0 -> master , DEV=1 -> SLAVE
                      00094 ;
                      00095 ;  pokud disk podporuje LBA 48, tak je zadavani adresy trochu odlisne od LBA27
                      00096 ;**********************************************************
                      00097 ; toto jsou definice adres ATA registru. Staci udat jejich adresu na ATA_ADDRESS port a dat prikaz ke ct
                            eni ci zapisu (DIOR- / DIOW-)
  00000016            00098 D_STATUS_A    equ b'00010110'
  00000016            00099 D_DEVICE_C    equ D_STATUS_A
  00000020            00100 D_DATA_R      equ b'00100000'
  00000021            00101 D_FEATURES    equ b'00100001'
  00000021            00102 D_ERROR       equ D_FEATURES
  00000022            00103 D_SECTOR_C    equ b'00100010'
  00000023            00104 D_LBA1        equ b'00100011'   ; LBA low
  00000024            00105 D_LBA2        equ b'00100100'   ; LBA middle
  00000025            00106 D_LBA3        equ b'00100101'   ; LBA high
  00000026            00107 D_DEVICE      equ b'00100110'
  00000027            00108 D_STATUS      equ b'00100111'
  00000027            00109 D_COMMAND     equ D_STATUS
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE  4


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00110 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00111 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00112 ; ROZLOZENI PAMETI PROGRAMU
                      00113 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00114 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00115 ;       page 0  0x0000 - 0x07FF
                      00116 ;                               - mp3.asm (hlavni smycka)
                      00117 ;                               - ata.asm
                      00118 ;                               - fat32.asm
                      00119 ;                               - aritmetic.asm
                      00120 ;       page 1  0x0800 - 0x0FFF
                      00121 ;                               - vs1001.asm
                      00122 ;                               - commands.asm
                      00123 ;       page 2  0x1000 - 0x17FF
                      00124 ;       page 3  0x1800 - 0x1FFF
                      00125 ;
                      00126 ; Vsechny podprogramy by mely nechat nastaven PCLATH na hodnotu jak se do nich vstoupilo...
                      00127 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00128 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00129 ; DEFINICE PROMENNYCH
                      00130 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00131 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00132 ; MAPA PAMETI: (368 bytu)
                      00133 ;       BANK 0:         0x000 - 0x01F = specialni registry,
                      00134 ;                               0x020 - 0x07F = misto (96bytu) pro nase registry:
                      00135 ;                                       0x020 - 0x034 -> 21bytu pro registry a parametry HDD
                      00136 ;                                       0x035 - 0x03a -> 6bytu pro parametry podprogramu (musime zajisti
                            t, abychom nepouzivali registry, ktere pouzivaji i podprogramy!!!)
                      00137 ;                                       0x03B - 0x04C -> parametry FATky
                      00138 ;                                       0x04D - 0x050 -> registry pro praci s VS1001
                      00139 ;                                       0x051 - 0xXXX -> ---------------------------
                      00140 ;                                       0x05F - 0x06F -> informace potrebne pro prehravani
                      00141 ;                               0x070 - 0x07F -> registry pro potreby preruseni (dostupne z kterekoliv b
                            anky)
                      00142 ;                                       0x070 - 0x072 -> 3 registry slouzici k zalohovani W, STATUS, FSR
                      00143 ;                                       0x073 - 0x076 -> registry pro prikazy a preruseni + zaloha pro P
                            CLATH
                      00144 ;                                       0x077         -> ---------------------------
                      00145 ;                                       0x078 - 0x07F -> 8 bytu zasobniku prikazu (obsahujici data prika
                            zu prisla po USARTU)
                      00146 ;
                      00147 ;       BANK 1:         0x080 - 0x09F = specialni registry,
                      00148 ;                               0x0A0 - 0x0EF = volne misto (80bytu)
                      00149 ;                                       0x0A0 - 0x0AC -> parametry a navratove hodnoty z aritmeto/logick
                            ych podprogramu
                      00150 ;                                       0x0AD - 0x0EF -> --------------------------- (67bytu)
                      00151 ;
                      00152 ;       BANK 2:         0x100 - 0x10F = specialni registry,
                      00153 ;                               0x110 - 0x16F = misto (96bytu) pro nase registry:
                      00154 ;                                       0x110 - 0x14F -> 64bytu BUFFER_2 (pro dlouhe nazvy souboru, tabu
                            lku oddilu, a treba pro cast fatky)
                      00155 ;                                       0x150         -> pri cteni dlouheho jmena potrebuju v bufferu2 6
                            5 bytu... (ten 65 je tady)
                      00156 ;                                       0x151 - 0x16F -> --------------------------- (31bytu)
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE  5


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00157 ;
                      00158 ;       BANK 3:         0x180 - 0x18F = specialni registry,
                      00159 ;                               0x190 - 0x1EF = misto (96bytu) pro nase registry:
                      00160 ;                                       0x190 - 0x1CF -> 64bytu BUFFER_1 (pro ruzna data pri cteni...)
                      00161 ;                                       0x1D0 - 0x1EF -> --------------------------- (32 bytu)
                      00162 
                      00163 ; prectena ci zapisovana data
  00000020            00164 DATA_L                  equ 0x020 ; res 1
  00000021            00165 DATA_H                  equ 0x021
                      00166 ; HODNOTY ATA REGISTRU 
  00000022            00167 ATA_STATUS_A    equ 0x022
  00000023            00168 DEVICE_C                equ 0x023
  00000024            00169 FEATURES                equ 0x024
  00000025            00170 ATA_ERROR               equ 0x025
  00000026            00171 SECTOR_C                equ 0x026
  00000027            00172 LBA1                    equ 0x027       ; alias  SECTOR_N
  00000028            00173 LBA2                    equ 0x028       ; alias  CILINDER_L
  00000029            00174 LBA3                    equ 0x029       ; alias  CILINDER_H
  0000002A            00175 LBA4                    equ 0x02a       ; toto neni registr ATA, ale pouze posledni cast aktualni adresy
  0000002B            00176 DEVICE                  equ 0x02b       ; alias  DEVICE_H
  0000002C            00177 ATA_STATUS              equ 0x02c
  0000002D            00178 COMMAND                 equ 0x02d
                      00179 ;**********************************************************
                      00180 ; BITY ATA REGISTRU
                      00181          ; ATA_STATUS register
  00000007            00182 BSY                             equ 7   ; = 1 -> disk je zaneprazdneny, ostatni registry nemusi obsahova
                            t pravdivou informaci
  00000006            00183 DRDY                    equ 6   ; = 1 -> disk ready (pripraven k praci)
  00000003            00184 DRQ                             equ 3   ; = 1 -> signalizuje, ze jsou pripravena data ke cteni 
  00000000            00185 ERR                             equ 0   ; = 1 -> pri provadeni posledniho prikazu doslo k chybe
                      00186          ; ATA_ERROR register
  00000002            00187 ABRT                    equ 2   ; = 1 -> prikaz aborted (spatny optkode prikazu)
                      00188          ; DEVICE_C (control) register
  00000002            00189 SRST                    equ 2   ; nastavime-li, provedeme soft. reset disku
  00000001            00190 nEIN                    equ 1   ; zakazuje preruseni disku (signal INTRQ)
  00000007            00191 HOB                             equ 7   ; tento bit DEVICE CONTROL se nastavuje pouze pokud disk podporu
                            je LBA 48 a cteme horni cast adresy LBA...
                      00192 ;**********************************************************
  0000002E            00193 ATA_ATTRIBUTES  equ 0x02e       ; Parametry hardisku. 
                      00194 ;Bity maji nasledujici vyznam:
  00000000            00195 ATA_OK                  equ 0   ; 0. bit = 1 -> disk je pritomen, zapnuty a funkcni :-)
  00000001            00196 LBA_SUPPORT             equ 1   ; 1. bit = 1 -> podpora LBA (pokud neni nastaven bit2, tak pouze LBA28 -
                            > disk do 120GB)
  00000002            00197 LBA48_SUPPORT   equ 2   ; 2. bit = 1 -> podpora LBA 48 (disk je zrejme vetsi jak 120GB)
  00000003            00198 BIG_SECTOR              equ 3   ; 3. bit = 1 -> velikost sektoru je vetsi nez 256 !!! (s takovym diskem 
                            zatim tento program neumi)
  00000004            00199 FAT32_LOAD              equ 4   ; 4. bit = 1 -> FATka byla uspesne analyzovana a udaje o ni jsou pravdiv
                            e
                      00200                                                 ; 5. bit  -> nepouzit
                      00201                                                 ; 6. bit  -> nepouzit (tyto tri bity treba pouziju pro v
                            lastnosti FATky)
  00000007            00202 APPLICABLE              equ 7   ; 7. bit = 1 -> disk je pro nas pouzitelny (LBA, sektor o 512B)
                      00203 
                      00204 
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE  6


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

  0000002F            00205 PARAM_MAX_LBA1  equ 0x02F               ; [4B] maximalni hodnota LBA (velikost disku)   
  00000030            00206 PARAM_MAX_LBA2  equ 0x030               ; tady pozor, disky mohou byt adresovany az LBA 48, MBR je ale o
                            mezen na LBA 32 (2TB)
  00000031            00207 PARAM_MAX_LBA3  equ 0x031               ; tak by nemelo smysl vsech 48b kdyz by se nevyuzily. (Navic jse
                            m disk vetsi nez 2TB nevidel :)
  00000032            00208 PARAM_MAX_LBA4  equ 0x032               ; (registr s indexem 1 ma nejnizsi vahu)
                      00209 
  00000033            00210 PARAM_SLOV_V_SEKTORU1   equ 0x33 ; [2B] disky mohou mit velikost sektoru vetsi nez 512 (256sl) 
  00000034            00211 PARAM_SLOV_V_SEKTORU2   equ 0x34 
                      00212 ; pokud je to zapsano takto, nejvyznamejsi bity jsou niz v paneti (PARAM_MAX_LBA + X)
                      00213 ; pokud je zapsano jako skupina LBA1, LBA2, LBA3, LBA4, tak nejvyznamejsi bity jsou v LBA4
                      00214 ;**********************************************************
                      00215 ; pomocne registry pouzivane v podprogramech 
                      00216 ; !!! MUSIME ZAJISTIT ABY NEBYLY POUZIVANY VE VNORENYCH PODPROGRAMECH !!!
  00000035            00217 TEMPW                   equ 0x035
  00000036            00218 TEMP1                   equ 0x036
  00000037            00219 TEMP2                   equ 0x037
  00000038            00220 TEMP3                   equ 0x038
  00000039            00221 TEMP4                   equ 0x039
  0000003A            00222 TEMP5                   equ 0x03A
                      00223 
                      00224 ; !!! pomocne promenne pro spozdovaci smycky jsou na stejnych mistech
                      00225 ; pouzito pro synchronizaci s prog. picdelay
  00000036            00226 TMP1                    equ 0x036
  00000037            00227 TMP2                    equ 0x037
  00000038            00228 TMP0                    equ 0x038
                      00229 ;**********************************************************
                      00230 ; registry pro praci s FATkou
  0000003B            00231 POZICE                  equ 0x03B               ; na ukladani aktualni pozice v slusteru, pripadne jine 
                            kokotiny
  0000003C            00232 CLUSTER1                equ 0x03C
  0000003D            00233 CLUSTER2                equ 0x03D
  0000003E            00234 CLUSTER3                equ 0x03E
  0000003F            00235 CLUSTER4                equ 0x03F
                      00236 
  00000040            00237 POCATEK_DAT1    equ 0x040
  00000041            00238 POCATEK_DAT2    equ 0x041
  00000042            00239 POCATEK_DAT3    equ 0x042
  00000043            00240 POCATEK_DAT4    equ 0x043
                      00241 
  00000044            00242 POCATEK_FAT1    equ 0x044
  00000045            00243 POCATEK_FAT2    equ 0x045
  00000046            00244 POCATEK_FAT3    equ 0x046
  00000047            00245 POCATEK_FAT4    equ 0x047
                      00246 
  00000048            00247 ROOT_DIR_CL1    equ 0x048
  00000049            00248 ROOT_DIR_CL2    equ 0x049
  0000004A            00249 ROOT_DIR_CL3    equ 0x04A
  0000004B            00250 ROOT_DIR_CL4    equ 0x04B
                      00251 
  0000004C            00252 CLUSTER_SIZE    equ 0x04C               ; velikost clusteru (pocet sektoru na cluster)
                      00253 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00254 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00255 ; DEFINICE PROMENNYCH a KONSTANT PRO PRACI S VS1001
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE  7


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00256 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00257 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00258 ; adresy registru VS1001
  00000000            00259 VSADDR_MODE                     equ .0          ; nastaveni VS1001
  00000001            00260 VSADDR_STATUS           equ .1          ; slouzi pouze pro zapnuti / vypnuti analogove casti (MUTE)
  00000003            00261 VSADDR_CLOCKF           equ .3          ; informuje dekoder o jeho krystalu. !! je nutne pro spravne dek
                            odovani !!
  00000004            00262 VSADDR_DECODE_TIME      equ .4          ; obsahuje cas dekodovani aktualni MP3 !! neaktualizuje se pri s
                            kocich (previjeni)
  00000005            00263 VSADDR_AUDATA           equ .5          ; obsahuje informace o datovem toku a vzorkovaci frekvenci MP3
                      00264         ; bit 15 = 1 => STEREO; = 0 => MONO
                      00265         ; bity 12-9 obsahuji vzorkovaci frekvenci v Hz
                      00266         ;       0000 -> neznama vzorkovaci frekvence
                      00267         ;       0001 -> 44 100
                      00268         ;       0010 -> 48 000
                      00269         ;       0011 -> 32 000
                      00270         ;       0100 -> 22 050
                      00271         ;       0101 -> 24 000 
                      00272         ;       0110 -> 16 000
                      00273         ;       0111 -> 11 025
                      00274         ;       1000 -> 12 000
                      00275         ;       1001 ->  8 000
                      00276         ; bity 8-0 obsahuji bitrate v kbps 
                      00277 
  00000006            00278 VSADDR_WRAM             equ .6                  ; Slouzi k zapisovani uzivatelskeho programu, dato se za
                            pise na adresu v WRAMADDR
  00000007            00279 VSADDR_WRAMADDR equ .7                  ; Adresuje uzivatelskou pamet dekoderu
  00000008            00280 VSADDR_HDAT0    equ .8                  ; Obsahuje informace ziskane z hlavicky MP3
  00000009            00281 VSADDR_HDAT1    equ .9                  ; Obsahuje informace ziskane z hlavicky MP3
  0000000A            00282 VSADDR_AIADDR   equ .10                 ; Start uzivatelskeho programu (vis. datasheet)
  0000000B            00283 VSADDR_VOL              equ .11                 ; ovladani hlasitosti (pro oba kanaly) Horni byte je lev
                            y kanal, dolni byte je pravy kanal
                      00284                                                                 ; (hodnota 0000h znamena hlasitost na ma
                            x., FF00h hraje pouze pravy kanal, FFFFh je ticho)
  0000000D            00285 VSADDR_AICTRL0  equ .13                 ; Registr pro ovladani uzivatelskeho programu
  0000000E            00286 VSADDR_AICTRL1  equ .14                 ; Registr pro ovladani uzivatelskeho programu
                      00287 ;**********************************************************
                      00288 ; registry pro praci s VS1001   
                      00289 ; dekoder VS1001 ma vsechny registry 16bitove, proto za jmeno pisu _L /_H (u nekterych registru potrebuj
                            i pouze jednu cast)
  0000004D            00290 VSREG_MODE_L    equ 0x04D
  0000004E            00291 VSREG_STATUS_L  equ 0x04E
  0000004F            00292 VSREG_VOL_L             equ 0x04F               ; pravy kanal
  00000050            00293 VSREG_VOL_H             equ 0x050               ; levy kanal
                      00294 ;                               equ 0x051
                      00295 ;                               equ 0x052
                      00296 ;                               equ 0x053
                      00297 ;                               equ 0x054
                      00298 ;                               equ 0x055
                      00299 ;                               equ 0x056
                      00300 ;                               equ 0x057
                      00301 ;                               equ 0x058
                      00302 ;**********************************************************
                      00303 ; registry pro ukladani nastaveni hledani
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE  8


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

  00000059            00304 HL_PARAMETRY    equ 0x059
                      00305 ;               0. bit = 0 > pokud hledáme soubory, tak pouze MP3
;                              1 > pok
                            ud hledáme soubory, vrací všechny soubory
;             1. bit = 0 > hledáme klasicky (nejdøíve 
                      00306 ;               3. bit = 0 > hledáme podle èísla záznamu buï následující èi pøedchozí záznam
;          
                                             1 > hledáme první záznam v adresáøi
                      00307 ;               4. bit = 0 > hledáme NÁSLEDUJÍCÍ záznam
;                                1 > hledáme PØE
                            DCHOZÍ záznam
                      00308 ;               7. bit - tento bit nelze nastavit uzivatelem
                      00309 ;                               = 0 > adresar je ROOT
                      00310 ;                               = 1 > adresar neni ROOT
                      00311 
  0000005A            00312 HL_ADR_CL1              equ 0x05A
  0000005B            00313 HL_ADR_CL2              equ 0x05B
  0000005C            00314 HL_ADR_CL3              equ 0x05C
  0000005D            00315 HL_ADR_CL4              equ 0x05D       ; v jakem adresari momentalne vyhledavame
                      00316 
  0000005E            00317 ZAZNAMU_vBUFFERU_DISKU  equ 0x05E       ; sem nam procedura SKOC_NA_ZAZNAM vraci kolik po sobe
                      00318                         ; jdoucich zaznamu nam nechala pripravenych v bufferu na disku
                      00319                         ; (znacne totiz zrychluje praci, protoze pokud chceme cist nasledujici zaznam a 
                            mame ho jiz 
                      00320                         ; v bufferu, memusime znova volat SKOC_NA_ZAZNAM ale rovnou FILE_INFO)
                      00321 ;XXXXXXXXX              equ 0x05F
                      00322 ;**********************************************************
                      00323 ; registry pro praci procedur v filesystem (dalsi registry pozivane proceduramy v filesystem jsou CLUSTE
                            R a POZICE)
  00000060            00324 ZAZNAM1                 equ 0x060
  00000061            00325 ZAZNAM2                 equ 0x061       ; poradi zaznamu v adresari
                      00326 ;**********************************************************
                      00327 ; informace potrebne pro prehravani
  00000062            00328 PREH_ADR_CL1            equ 0x062
  00000063            00329 PREH_ADR_CL2            equ 0x063
  00000064            00330 PREH_ADR_CL3            equ 0x064
  00000065            00331 PREH_ADR_CL4            equ 0x065       ; prni cluster adresare, ktery se prave prehrava...
                      00332 
  00000066            00333 PREH_ZAZNAM1            equ 0x066
  00000067            00334 PREH_ZAZNAM2            equ 0x067       ; poradi zaznamu v adresari ktery se zrovna prehrava (soubor mp3
                            )
                      00335 
  00000068            00336 PREH_CITAC_PREV         equ 0x068       ; pokud je mp3 previjena pomalu, sem se zapisuje kolik sektoru s
                            e jiz previnulo. 
                      00337                                                                 ; (Pøi pomalém pøevíjení je pomìr pøehra
                            ných sektorù ku pøeskoèeným 5:20.)
                      00338 
  00000069            00339 PREH_DATA_CL1           equ 0x069
  0000006A            00340 PREH_DATA_CL2           equ 0x06A
  0000006B            00341 PREH_DATA_CL3           equ 0x06B
  0000006C            00342 PREH_DATA_CL4           equ 0x06C       ; aktualni cluster, ktery se prehrava
  0000006D            00343 PREH_DATA_POZICE        equ 0x06D       ; sektor v clusteru, ktery se prehrava
                      00344 
  0000006E            00345 PREH_STAV0                      equ 0x06E       ; registr obsahuje informace o stavu aktualniho prehrava
                            ni
                      00346                                 ; 0. bit =      0 => stop nebo pausa (nic nehraje)
                      00347                                 ;                       1 => play            (nejaky soubor je prehravan
                            )
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE  9


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00348                                 ; 1. bit =      0 => neni zadny soubor k prehravani (nastaveni bitu play
                             nema zadny ucinek)
                      00349                                 ;                       1 => je soubor pripraven k prehravani (muze byt 
                            ale pauza - nic nehraje)
                      00350                                 ; 2. bit =      1 => je nastaven, kdyz se zmeni prehravany soubor (bez v
                            olani prikazu) do doby, nez prijde prikaz na dotaz STAVU... (81h)
                      00351                                 ; 3. bit =      0 => po skonceni souboru se pokracuje v prehravani (zavi
                            si na nastaveni repeatu)
                      00352                                 ;                       1 => po skonceni prehravani souboru se nic nepre
                            hrava (ceka se na prijeti prikazu k prehravani)
                      00353                                 ; 4. bit =      0 => repeat off
                      00354                                 ;                       1 => repeat on
                      00355                                 ; 5. bit =      0 => repeat adresare (prvni cluster adresare musi byt na
                            staven v PREH_ADDR_ZACATEK_CL[1-4] )
                      00356                                 ;                       1 => repeat souboru (po skonceni prehravani soub
                            oru se ten samy soubor zacne prehravat znova)
                      00357                                 ; 6. bit =      0 => 
                      00358                                 ;                       1 => rezervovano (pro nahodny vyber, nebo jiny r
                            ezim prehravani...)
                      00359                                 ; 7. bit =  0 => 
                      00360                                 ;                       1 => rezervovano
  0000006F            00361 PREH_STAV1                      equ 0x06F
                      00362                                 ; 0. bit =  0 => normalni prehravani
                      00363                                 ;                       1 => previjeni mp3 dopredu
                      00364                                 ; 1. bit =  0 => 
                      00365                                 ;                       1 => rezervovano (pro previjeni dozadu)
                      00366                                 ; 2. bit =      zpusob previjeni,       0 => previji se rychle, potichu
                      00367                                 ;                                                               1 => pre
                            viji se pomalu, vzdy se po nejake dobe kratky usek souboru prehraje
                      00368                                 ; 3. bit =      0 => normalni nastaveni zvuku
                      00369                                 ;                       1 => zvyrazneni basu a vysek (moznost dekoderu v
                            s1001 "bass/treble enhancer")
                      00370                                 ; 4. bit =      0 => NO MUTE
                      00371                                 ;                       1 => MUTE
                      00372                                 ; 5., 6., 7. bit 
                      00373                                 ;                       => rezervovano
                      00374 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00375 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00376 ; registry pro potreby preruseni + prace s prikazy (jsou totiz dostupne odkudkoliv)
  00000070            00377 TEMP_WORKING    equ 0x070
  00000071            00378 TEMP_STATUS             equ 0x071
  00000072            00379 TEMP_FSR                equ 0x072
  00000073            00380 PRIJATYCH_DAT   equ 0x073               ; ukazuje kolik je platnych dat v zasobniku prikazu (0 -> zasobn
                            ik je prazdny)
  00000074            00381 PRIJATE_DATO    equ 0x074               ; pomocna promenna v preruseni
  00000075            00382 STAV_PRIKAZU    equ 0x075               ; pomocny registr signalizujici stav prikazu umisteneho v zasobn
                            iku prikazu
                      00383                                                                 ; pokud zadna procedura nenastavi do 1, 
                            je prikaz v tuto chvili neplatny
                      00384                                                                 ; pokud prikaz je pro proceduru ale nama
                             zatim dost parametru, muji tento byt nastavit take do 1
  00000076            00385 TEMP_PCLATH             equ 0x076
                      00386 ; 0x078 - 0x07F         -> zasobnik prikazu (data prisla po USARTU)
                      00387 ;**********************************************************
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 10


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00388 ; BANK_1        s touto bankou pracuji procedury provadejici 32 bitove 
                      00389 ;                       aritmeto/logicke operace
  000000A0            00390 OPERAND_X1              equ 0x0A0
  000000A1            00391 OPERAND_X2              equ 0x0A1
  000000A2            00392 OPERAND_X3              equ 0x0A2
  000000A3            00393 OPERAND_X4              equ 0x0A3
                      00394 
  000000A4            00395 OPERAND_Y1              equ 0x0A4
  000000A5            00396 OPERAND_Y2              equ 0x0A5
  000000A6            00397 OPERAND_Y3              equ 0x0A6
  000000A7            00398 OPERAND_Y4              equ 0x0A7
                      00399 
  000000A8            00400 VYSLEDEK1               equ 0x0A8
  000000A9            00401 VYSLEDEK2               equ 0x0A9
  000000AA            00402 VYSLEDEK3               equ 0x0AA
  000000AB            00403 VYSLEDEK4               equ 0x0AB
                      00404 
  000000AC            00405 PRETECENI               equ 0x0AC
                      00406 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00407 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00408 ; MAKRA
                      00409 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00410 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00411 BANK_0  macro                                   ; prepnuti do banky 0 v pameti dat
                      00412                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
                      00413                 bcf     STATUS,RP0    
                      00414                 endm
                      00415 BANK_1  macro                                   ; prepnuti do banky 1 v pameti dat
                      00416                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
                      00417                 bsf     STATUS,RP0    
                      00418                 endm
                      00419 BANK_2  macro                                   ; prepnuti do banky 2 v pameti dat
                      00420                 bsf     STATUS,RP1              ; BANK2  RP1:RP0 = 10
                      00421                 bcf     STATUS,RP0    
                      00422                 endm
                      00423 BANK_3  macro                                   ; prepnuti do banky 3 v pameti dat
                      00424                 bsf     STATUS,RP1              ; BANK3  RP1:RP0 = 11
                      00425                 bsf     STATUS,RP0    
                      00426                 endm
                      00427 ; INDF_BANK_x slouzi k prepinani bank pro neprime adresovani pomoci INDF a FSR
                      00428 INDF_BANK_0     macro               
                      00429                         bcf STATUS,IRP    
                      00430                         endm
                      00431 INDF_BANK_1     macro               
                      00432                         bcf STATUS,IRP    
                      00433                         endm
                      00434 INDF_BANK_2     macro             
                      00435                         bsf STATUS,IRP    
                      00436                         endm
                      00437 INDF_BANK_3     macro             
                      00438                         bsf STATUS,IRP    
                      00439                         endm
                      00440 ;**********************************************************
                      00441 PROG_PAGE_0     macro             
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 11


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00442                         bcf PCLATH,3
                      00443                         bcf PCLATH,4
                      00444                         endm
                      00445 PROG_PAGE_1     macro             
                      00446                         bsf PCLATH,3
                      00447                         bcf PCLATH,4
                      00448                         endm
                      00449 PROG_PAGE_2     macro             
                      00450                         bcf PCLATH,3
                      00451                         bsf PCLATH,4
                      00452                         endm
                      00453 PROG_PAGE_3     macro             
                      00454                         bsf PCLATH,3
                      00455                         bsf PCLATH,4
                      00456                         endm
                      00457 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00044 
                      00045 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00046 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00047 ; PROGRAM
                      00048 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00049 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00050 ;**********************************************************
0000                  00051  org 0x0000                                     ; PAGE 0
0000   2810           00052         goto START
0004                  00053  org 0x0004                                     ; PAGE 0
0004   00F0           00054         movwf TEMP_WORKING
0005   0803           00055         movfw STATUS
0006   00F1           00056         movwf TEMP_STATUS
0007   0804           00057         movfw FSR
0008   00F2           00058         movwf TEMP_FSR
0009   080A           00059         movfw PCLATH
000A   00F6           00060         movwf TEMP_PCLATH
000B   018A           00061         clrf PCLATH
                      00062         BANK_0
000C   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
000D   1283               M                 bcf     STATUS,RP0    
                      00063         INDF_BANK_0
000E   1383               M                         bcf STATUS,IRP    
000F   29A5           00064         goto INTERRUPT
                      00065 ;**********************************************************
0010                  00066  org 0x0010                                     ; PAGE 0
                      00067         include "mp3.asm"               ; hlavni programova smycka
0010                  00001 START
0010   214A           00002         call INIT_CONFIG        ; nakonfiguruje preruseni, WDT, USART, pull ups...
0011   2137           00003         call INIT_PORT          ; nastavy trisy, a porty do vychozi polohy
                      00004 
0012   2337           00005         call DELAY_25us         ; chvili pockame, protoze napjeti zdroje co mam doma (stary PC-AT zdroj)
0013   2337           00006         call DELAY_25us         ; zezacatku dost kolisa...
0014   2337           00007         call DELAY_25us
                      00008 
0015   216D           00009         call POZDRAV                            ; abych se u kompu nenudil
                      00010 
                      00011         PROG_PAGE_1
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 12


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0016   158A               M                         bsf PCLATH,3
0017   120A               M                         bcf PCLATH,4
0018   20CE           00012         call VS_INIT
                      00013         PROG_PAGE_0
0019   118A               M                         bcf PCLATH,3
001A   120A               M                         bcf PCLATH,4
                      00014 
001B   2291           00015         call ATA_RESET                          ; resetujeme disk, koukneme zda tu nejakej mame
001C   1C2E           00016         btfss ATA_ATTRIBUTES,ATA_OK
001D   281B           00017         goto $-2                                        ; pokud neni pripojen disk, tak se jej pokousime
                             neustale najit...
001E   0000           00018         nop                                                     ; ...pokud tam zadny disk neni, tak bych
                            om se stejne ani sem nemeli dostat, protoze budem porad cekat na WAIT_FOR_READY
                      00019 
001F   22E4           00020         call IDENTIFY_DEVICE            ; koukneme co disk umi
                      00021 
0020                  00022 CEK_PRIKAZ_01h
                      00023         PROG_PAGE_1
0020   158A               M                         bsf PCLATH,3
0021   120A               M                         bcf PCLATH,4
0022   20DD           00024         call CEKEJ_PRIKAZ
                      00025         PROG_PAGE_0
0023   118A               M                         bcf PCLATH,3
0024   120A               M                         bcf PCLATH,4
                      00026 
                      00027 
0025   0878           00028         movfw 0x078                                     ; prvni byte prikazoveho zasobniku
0026   01F3           00029         clrf PRIJATYCH_DAT                      ; prikaz byl vybran -> prazdny zasobnik
0027   3C01           00030         sublw h'01'                                     ; ...pokud to byl prikaz 01h...
0028   1D03           00031         btfss STATUS,Z
0029   2820           00032         goto CEK_PRIKAZ_01h
                      00033 
002A   082E           00034         movfw ATA_ATTRIBUTES            ; ...vodesleme zpet vlastnosti disku a jeho jmenovku (vis. popis
                             protokolu)
002B   2165           00035         call WR_USART
002C   2180           00036         call ODESLI_MODEL_NUMBER        ; odesleme jmeno disku 
                      00037 
002D   2342           00038         call SCAN_MBR                           ; najdeme oddily s FAT32 a jejich seznam dame do bufferu
                             2
002E                  00039 CEK_PRIKAZ_02h_03h
                      00040         PROG_PAGE_1
002E   158A               M                         bsf PCLATH,3
002F   120A               M                         bcf PCLATH,4
0030   20DD           00041         call CEKEJ_PRIKAZ                       ; pockame si na prikaz
0031   01F5           00042         clrf STAV_PRIKAZU                       ; smazeme registr signalizujici platnost prikazu
0032   20E2           00043         call PRIKAZ_02h                         ; testujeme zda prisel prikaz 02h, pokud ano tak jej pro
                            vedeme a nastavime platnost prikazu
0033   2103           00044         call PRIKAZ_03h                         ; ---//---
                      00045         PROG_PAGE_0
0034   118A               M                         bcf PCLATH,3
0035   120A               M                         bcf PCLATH,4
0036   1C75           00046         btfss STAV_PRIKAZU,0            ; Pokud si zadna z procedur prikaz neprevzala, ...
0037   01F3           00047         clrf PRIJATYCH_DAT                      ; ...vymazeme zasobnik prikazu. (prikaz neni pro tuto ch
                            vili platny)
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 13


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0038   1E2E           00048         btfss ATA_ATTRIBUTES,FAT32_LOAD ; cekame dokud nedojde k nasteni nejakeho oddilu
0039   282E           00049         goto CEK_PRIKAZ_02h_03h         ; pokud byl oddil vporadku nacten, pokracujeme...
                      00050 
003A   01EE           00051         clrf PREH_STAV0
                      00052 ;*******************************************************************************************************
                            *************
                      00053 ;*******************************************************************************************************
                            *************
                      00054 ;*******************************************************************************************************
                            *************
                      00055 ;*******************************************************************************************************
                            *************
003B                  00056 BIG_LOOP
                      00057         ; Tady ta smycka beha po nacteni disku a nejake FATky porad dokola.
                      00058         ; Pri kazdem prubehu smyckou vyresime prikazy, ktere prisly, a pokud prehravame 
                      00059         ; nejakou mp3 tak dekoder nakrmime jednim sektorem...
                      00060         ; Mimo to musime v teto smycce osefovat, ze kdyz skonci mp3, nacteme dalsi...
003B   0873           00061         movfw PRIJATYCH_DAT
003C   39FF           00062         andlw h'FF'
003D   1903           00063         btfsc STATUS,Z
003E   2852           00064         goto BIG_LOOP__NENI_PRIKAZ
                      00065         
003F   01F5           00066         clrf STAV_PRIKAZU                       ; smazeme registr signalizujici platnost prikazu
                      00067         ; Pokud jsme tady, tak prisel nejaky prikaz, jdem predat prikaz jednotlivym proceduram
                      00068         PROG_PAGE_1
0040   158A               M                         bsf PCLATH,3
0041   120A               M                         bcf PCLATH,4
0042   2121           00069         call PRIKAZ_04h                         ; testujeme zda prisel prikaz 04h, pokud ano tak jej pro
                            vedeme a nastavime platnost prikazu
0043   212E           00070         call PRIKAZ_05h                         ; --- // ---
0044   215F           00071         call PRIKAZ_06h                         ; --- // ---
0045   2181           00072         call PRIKAZ_07h                         ; --- // ---
0046   21A8           00073         call PRIKAZ_08h                         ; --- // ---
0047   21D6           00074         call PRIKAZ_09h                         ; --- // ---
0048   2209           00075         call PRIKAZ_0Ah                         ; --- // ---
                      00076 
0049   2237           00077         call PRIKAZ_80h                         ; --- // ---
004A   2296           00078         call PRIKAZ_81h                         ; --- // ---
004B   22B5           00079         call PRIKAZ_82h                         ; --- // ---
004C   22CB           00080         call PRIKAZ_83h                         ; --- // ---
004D   22FF           00081         call PRIKAZ_84h                         ; --- // ---
                      00082         PROG_PAGE_0
004E   118A               M                         bcf PCLATH,3
004F   120A               M                         bcf PCLATH,4
                      00083         
0050   1C75           00084         btfss STAV_PRIKAZU,0            ; Pokud si zadna z procedur prikaz neprevzala, ...
0051   01F3           00085         clrf PRIJATYCH_DAT                      ; ...vymazeme zasobnik prikazu. (prikaz neni pro tuto ch
                            vili platny)
                      00086 
0052                  00087 BIG_LOOP__NENI_PRIKAZ
                      00088 
0052   1C6E           00089         btfss PREH_STAV0,0                      ; Pokud je zvoleno play,...
0053   28B0           00090         goto MP3_NOT_PLAY
                      00091 
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 14


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0054   1CEE           00092         btfss PREH_STAV0,1                      ; ...a je co prehravat...
0055   28B0           00093         goto MP3_NOT_PLAY
                      00094         
0056   086D           00095         movfw PREH_DATA_POZICE
0057   024C           00096         subwf CLUSTER_SIZE,W
0058   1D03           00097         btfss STATUS,Z                          ; ...podivame se zda jiz nejsme na konci clusteru...
0059   2873           00098         goto SEND_MP3_DATA
                      00099 
005A   0869           00100         movfw PREH_DATA_CL1                     ; ...pokud jo, tak si najdeme dalsi cluster v retezci.
005B   00BC           00101         movwf CLUSTER1
005C   086A           00102         movfw PREH_DATA_CL2
005D   00BD           00103         movwf CLUSTER2
005E   086B           00104         movfw PREH_DATA_CL3
005F   00BE           00105         movwf CLUSTER3
0060   086C           00106         movfw PREH_DATA_CL4
0061   00BF           00107         movwf CLUSTER4
                      00108 
0062   01ED           00109         clrf PREH_DATA_POZICE
0063   252C           00110         call NEXT_CLUSTER
0064   083C           00111         movfw CLUSTER1
0065   00E9           00112         movwf PREH_DATA_CL1
0066   083D           00113         movfw CLUSTER2
0067   00EA           00114         movwf PREH_DATA_CL2
0068   083E           00115         movfw CLUSTER3
0069   00EB           00116         movwf PREH_DATA_CL3
006A   083F           00117         movfw CLUSTER4
006B   00EC           00118         movwf PREH_DATA_CL4
                      00119         
006C   1C3B           00120         btfss POZICE,0                          ; Pokud byl cluster posledni v retezci...
006D   2873           00121         goto SEND_MP3_DATA
                      00122 
006E   20B1           00123         call DALSI_SKLADBA                      ; ...tak najdeme dalsi soubor co se ma prehrat (pokud je
                             nastaven repeat a dalsi kraviny)
                      00124         ; otestujeme zda se ma nejaka dalsi mp3 prehravat
006F   1C6E           00125         btfss PREH_STAV0,0                      ; Je zvoleno play?
0070   28B0           00126         goto MP3_NOT_PLAY
0071   1CEE           00127         btfss PREH_STAV0,1                      ; Je co prehravat?
0072   28B0           00128         goto MP3_NOT_PLAY
                      00129 
0073                  00130 SEND_MP3_DATA
0073   1C6F           00131         btfss PREH_STAV1,0                      ; 0. bit = 1 => previjeni mp3 dopredu
0074   288E           00132         goto NOT_MP3_REWIND_FORWARD
0075   14CD           00133         bsf VSREG_MODE_L,1                      ; fast forward on
                      00134 
0076   1D6F           00135         btfss PREH_STAV1,2                      ; 2. bit = 1 => previji se pomalu, vzdy se po nejake dob
                            e kratky usek souboru prehraje  
0077   2882           00136         goto MP3_REWIND_FORWARD
                      00137 
0078   0868           00138         movfw PREH_CITAC_PREV           ; MP3 previjime pomalu...
0079   3C14           00139         sublw .20                                       ; ...podivame se kolik sektoru jsme previnuly...
007A   1803           00140         btfsc STATUS,C                          ; ...pokud jich je vic jak 20...
007B   2882           00141         goto MP3_REWIND_FORWARD         ; 
                      00142         
007C   10CD           00143         bcf VSREG_MODE_L,1                      ; ...tak dalsi pustime normalne. (fast forward off)
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 15


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00144 
007D   0868           00145         movfw PREH_CITAC_PREV
007E   3C19           00146         sublw .25
007F   1D03           00147         btfss STATUS,Z                          ; pokud jsme jich uz normalne pustily 5, ... (25-20)
0080   2882           00148         goto MP3_REWIND_FORWARD
                      00149 
0081   01E8           00150         clrf PREH_CITAC_PREV            ; ...vymazeme citac previjeni (zas nejaky sektory pustime rychle
                            )
0082                  00151 MP3_REWIND_FORWARD
0082   3000           00152         movlw VSADDR_MODE
0083   00B6           00153         movwf TEMP1
0084   084D           00154         movfw VSREG_MODE_L
0085   00B7           00155         movwf TEMP2
0086   01B8           00156         clrf TEMP3
                      00157         PROG_PAGE_1     
0087   158A               M                         bsf PCLATH,3
0088   120A               M                         bcf PCLATH,4
0089   2063           00158         call VS_WR_REG
                      00159         PROG_PAGE_0
008A   118A               M                         bcf PCLATH,3
008B   120A               M                         bcf PCLATH,4
                      00160         
008C   196F           00161         btfsc PREH_STAV1,2                      ; 2. bit = 1 => previji se pomalu, vzdy se po nejake dob
                            e kratky usek souboru prehraje  
008D   0AE8           00162         incf PREH_CITAC_PREV,f
008E                  00163 NOT_MP3_REWIND_FORWARD
                      00164 
008E   0869           00165         movfw PREH_DATA_CL1                     ; Mame zjisteny cluster a jeho cast, kterou mame prehrav
                            at...
008F   00BC           00166         movwf CLUSTER1
0090   086A           00167         movfw PREH_DATA_CL2
0091   00BD           00168         movwf CLUSTER2
0092   086B           00169         movfw PREH_DATA_CL3
0093   00BE           00170         movwf CLUSTER3
0094   086C           00171         movfw PREH_DATA_CL4
0095   00BF           00172         movwf CLUSTER4
0096   086D           00173         movfw PREH_DATA_POZICE
0097   00BB           00174         movwf POZICE
                      00175 
0098   24C9           00176         call CLUSTER_TO_LBA                     ; zjistime si skutecnou polohu dat na disku...
0099   3001           00177         movlw .1
009A   00A6           00178         movwf SECTOR_C
009B   22AC           00179         call READ_SECTOR                        ; dame prikaz precist data...
                      00180 
009C   1585           00181         bsf MP3_CS                                      ; po SI posilam data
009D   3000           00182         movlw .0                                        ; posilame celkem 256 slov
009E   00B6           00183         movwf TEMP1             
009F                  00184 SEND_MP3_WORD
                      00185         PROG_PAGE_1
009F   158A               M                         bsf PCLATH,3
00A0   120A               M                         bcf PCLATH,4
00A1   20A5           00186         call WAIT_FOR_VSDREQ
                      00187         PROG_PAGE_0
00A2   118A               M                         bcf PCLATH,3
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 16


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

00A3   120A               M                         bcf PCLATH,4
00A4   2254           00188         call READ_DATA
00A5   0820           00189         movfw DATA_L
                      00190         PROG_PAGE_1
00A6   158A               M                         bsf PCLATH,3
00A7   120A               M                         bcf PCLATH,4
00A8   2000           00191         call VS_WR_BYTE
00A9   0821           00192         movfw DATA_H
00AA   2000           00193         call VS_WR_BYTE
                      00194         PROG_PAGE_0
00AB   118A               M                         bcf PCLATH,3
00AC   120A               M                         bcf PCLATH,4
00AD   0BB6           00195         decfsz TEMP1,f  
00AE   289F           00196         goto SEND_MP3_WORD
                      00197 
00AF   0AED           00198         incf PREH_DATA_POZICE,f
00B0                  00199 MP3_NOT_PLAY
                      00200 
00B0   283B           00201         goto BIG_LOOP
                      00202 ;*******************************************************************************************************
                            *************
                      00203 ;*******************************************************************************************************
                            *************
                      00204 ;*******************************************************************************************************
                            *************
                      00205 ;*******************************************************************************************************
                            *************
00B1                  00206 DALSI_SKLADBA
                      00207         ; tato procedura je volana, kdyz skonci mp3, aby nasla v adresari dalsi mp3 ktera se ma prehrava
                            t...
00B1   106E           00208         bcf PREH_STAV0,0                ; 0. bit =      0 => stop nebo pausa (nic nehraje)
00B2   10EE           00209         bcf PREH_STAV0,1                ; 1. bit =      0 => neni zadny soubor k prehravani (nastaveni b
                            itu play nema zadny ucinek)
00B3   116E           00210         bcf PREH_STAV0,2                ; 2. bit =      1 => je nastaven, kdyz se zmeni prehravany soubo
                            r (bez volani prikazu) do doby, nez prijde prikaz na dotaz STAVU... (81h)
00B4   106F           00211         bcf PREH_STAV1,0                ; 0. bit =  0 => normalni prehravani (mp3 se nepreviji)
00B5   19EE           00212         btfsc PREH_STAV0,3              ; 3. bit =      0 => po skonceni souboru se pokracuje v prehrava
                            ni (zavisi na nastaveni repeatu)
00B6   0008           00213         return
                      00214 
                      00215 ; PREH_STAV0
                      00216 ;       4. bit =        0 => repeat off
                      00217 ;                               1 => repeat on
                      00218 ;       5. bit =        0 => repeat adresare (prvni cluster adresare musi byt nastaven v PREH_ADDR_ZACAT
                            EK_CL[1-4] )
                      00219 ;                               1 => repeat souboru (po skonceni prehravani souboru se ten samy soubor z
                            acne prehravat znova)
00B7   1E6E           00220         btfss PREH_STAV0,4
00B8   28E2           00221         goto DALSI_SKLADBA_NO_R_S
00B9   1EEE           00222         btfss PREH_STAV0,5
00BA   28E2           00223         goto DALSI_SKLADBA_NO_R_S       
00BB                  00224 DALSI_SKLADBA_REPAT_SOUBORU
00BB   0862           00225         movfw PREH_ADR_CL1
00BC   00BC           00226         movwf CLUSTER1
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 17


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

00BD   0863           00227         movfw PREH_ADR_CL2
00BE   00BD           00228         movwf CLUSTER2
00BF   0864           00229         movfw PREH_ADR_CL3
00C0   00BE           00230         movwf CLUSTER3
00C1   0865           00231         movfw PREH_ADR_CL4
00C2   00BF           00232         movwf CLUSTER4
00C3   0866           00233         movfw PREH_ZAZNAM1
00C4   00E0           00234         movwf ZAZNAM1
00C5   0867           00235         movfw PREH_ZAZNAM2
00C6   00E1           00236         movwf ZAZNAM2
                      00237 
                      00238         PROG_PAGE_1
00C7   158A               M                         bsf PCLATH,3
00C8   120A               M                         bcf PCLATH,4
00C9   236B           00239         call SKOC_NA_ZAZNAM
                      00240         PROG_PAGE_0
00CA   118A               M                         bcf PCLATH,3
00CB   120A               M                         bcf PCLATH,4
00CC   183B           00241         btfsc POZICE,0                          ; tento test by tu byt nemusel, protoze jsme jiz tento s
                            oubor hrali, jeden ale nikdy nevi...
00CD   0008           00242         return
                      00243         PROG_PAGE_1
00CE   158A               M                         bsf PCLATH,3
00CF   120A               M                         bcf PCLATH,4
00D0   23E6           00244         call FILE_INFO
                      00245         PROG_PAGE_0
00D1   118A               M                         bcf PCLATH,3
00D2   120A               M                         bcf PCLATH,4
                      00246 
                      00247         INDF_BANK_2
00D3   1783               M                         bsf STATUS,IRP    
                      00248         ; ...nastavime jej jako prehravany soubor.
00D4   301C           00249         movlw 0x1C                                      ; 13. byte bufferu 2
00D5   0084           00250         movwf FSR
00D6   0800           00251         movfw INDF
00D7   00E9           00252         movwf PREH_DATA_CL1
00D8   0A84           00253         incf FSR,f
00D9   0800           00254         movfw INDF
00DA   00EA           00255         movwf PREH_DATA_CL2
00DB   0A84           00256         incf FSR,f
00DC   0800           00257         movfw INDF
00DD   00EB           00258         movwf PREH_DATA_CL3
00DE   0A84           00259         incf FSR,f
00DF   0800           00260         movfw INDF
00E0   00EC           00261         movwf PREH_DATA_CL4
00E1   2925           00262         goto DALSI_SKLADBA_PLAY         ; nic jineho nemusime nastavovat, protoze hrajeme ten samy soubo
                            r co predtim
00E2                  00263 DALSI_SKLADBA_NO_R_S
                      00264 ; PREH_STAV0
                      00265 ;       4. bit =        0 => repeat off
                      00266 ;                               1 => repeat on
                      00267 ;       5. bit =        0 => repeat adresare (prvni cluster adresare musi byt nastaven v PREH_ADDR_ZACAT
                            EK_CL[1-4] )
                      00268 ;                               1 => repeat souboru (po skonceni prehravani souboru se ten samy soubor z
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 18


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                            acne prehravat znova)
                      00269         ; tak ted jdem hledat dalsi soubor v adresari...
                      00270         
                      00271 ;       HL_PARAMETRY    -- parametry hledani
                      00272 ;       HL_ADR_CL[1-4]  -- prnvi cluster prohledavaneho adresare
                      00273 ;       ZAZNAM[1-2]             -- zaznam od ktereho hledame
00E2   3006           00274         movlw b'00000110'
00E3   00D9           00275         movwf HL_PARAMETRY
00E4   0862           00276         movfw PREH_ADR_CL1
00E5   00DA           00277         movwf HL_ADR_CL1
00E6   0863           00278         movfw PREH_ADR_CL2
00E7   00DB           00279         movwf HL_ADR_CL2
00E8   0864           00280         movfw PREH_ADR_CL3
00E9   00DC           00281         movwf HL_ADR_CL3
00EA   0865           00282         movfw PREH_ADR_CL4
00EB   00DD           00283         movwf HL_ADR_CL4
00EC   0866           00284         movfw PREH_ZAZNAM1
00ED   00E0           00285         movwf ZAZNAM1
00EE   0867           00286         movfw PREH_ZAZNAM2
00EF   00E1           00287         movwf ZAZNAM2
                      00288         
                      00289         PROG_PAGE_1
00F0   158A               M                         bsf PCLATH,3
00F1   120A               M                         bcf PCLATH,4
00F2   247E           00290         call HLEDEJ
                      00291         PROG_PAGE_0     
00F3   118A               M                         bcf PCLATH,3
00F4   120A               M                         bcf PCLATH,4
                      00292 
                      00293         INDF_BANK_2
00F5   1783               M                         bsf STATUS,IRP    
00F6   3030           00294         movlw 0x30
00F7   0084           00295         movwf FSR
00F8   0800           00296         movfw INDF
00F9   3C06           00297         sublw h'06'
00FA   1903           00298         btfsc STATUS,Z
00FB   2911           00299         goto DALSI_SKLADBA_MAME_SOUBOR
                      00300 
                      00301         ; zadny dalsi mp3 soubor v adresari neni...
00FC   1E6E           00302         btfss PREH_STAV0,4                              ; ..podivame se, zda neni nastaven repeat slozky
00FD   0008           00303         return
                      00304 
                      00305         ; je nastaven repeat slozky a uz neni co prehravat. Jdem hledat prvni mp3 ve slozce...
                      00306 
                      00307         ; HL_PARAMETRY
                      00308         ;               7. bit - tento bit nelze nastavit uzivatelem
                      00309         ;                               = 0 > adresar je ROOT
                      00310         ;                               = 1 > adresar neni ROOT 
00FE   3006           00311         movlw b'00000110'                               ; parametry hledani, pokud hledame prvni mp3 adr
                            esari ktery neni ROOT 
                      00312                                                                         ; (prvni zaznam je ukazatel na p
                            redchozi adresar)
00FF   1FD9           00313         btfss HL_PARAMETRY,7
0100   300E           00314         movlw b'00001110'                               ; parametry hledani, pokud hledame prvni mp3 v R
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 19


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                            OOT adresari (prvni zaznam)
0101   00D9           00315         movwf HL_PARAMETRY
                      00316 
0102   3001           00317         movlw h'01'                                             ; prvni cluster prohledavaneho adresare 
                            mame jiz nastaven,
0103   00E0           00318         movwf ZAZNAM1                                   ; parametry taky, ted jen zaznam od klereho hled
                            ame... 
0104   01E1           00319         clrf ZAZNAM2                                    ; (pokud hledame v ROOTu, hledame prvni zaznam)
                      00320 
                      00321         PROG_PAGE_1
0105   158A               M                         bsf PCLATH,3
0106   120A               M                         bcf PCLATH,4
0107   247E           00322         call HLEDEJ
                      00323         PROG_PAGE_0     
0108   118A               M                         bcf PCLATH,3
0109   120A               M                         bcf PCLATH,4
                      00324 
                      00325         INDF_BANK_2
010A   1783               M                         bsf STATUS,IRP    
010B   3030           00326         movlw 0x30
010C   0084           00327         movwf FSR
010D   0800           00328         movfw INDF
010E   3C06           00329         sublw h'06'
010F   1D03           00330         btfss STATUS,Z
0110   0008           00331         return                                                  ; sem bychom se nemeli dostat, protoze k
                            dyz uz neco hralo, tak tu nejaky soubor musi byt?!
                      00332         ;goto DALSI_SKLADBA_MAME_SOUBOR
0111                  00333 DALSI_SKLADBA_MAME_SOUBOR
                      00334         INDF_BANK_2
0111   1783               M                         bsf STATUS,IRP    
0112   303C           00335         movlw 0x3C
0113   0084           00336         movwf FSR
0114   0800           00337         movfw INDF
0115   00E9           00338         movwf PREH_DATA_CL1
0116   0A84           00339         incf FSR,f
0117   0800           00340         movfw INDF
0118   00EA           00341         movwf PREH_DATA_CL2
0119   0A84           00342         incf FSR,f
011A   0800           00343         movfw INDF
011B   00EB           00344         movwf PREH_DATA_CL3
011C   0A84           00345         incf FSR,f
011D   0800           00346         movfw INDF
011E   00EC           00347         movwf PREH_DATA_CL4
011F   0A84           00348         incf FSR,f
0120   0800           00349         movfw INDF
0121   00E6           00350         movwf PREH_ZAZNAM1
0122   0A84           00351         incf FSR,f
0123   0800           00352         movfw INDF
0124   00E7           00353         movwf PREH_ZAZNAM2
                      00354 
0125                  00355 DALSI_SKLADBA_PLAY
0125   01ED           00356         clrf PREH_DATA_POZICE
0126   146E           00357         bsf PREH_STAV0,0
0127   14EE           00358         bsf PREH_STAV0,1                        ; nastavime si vlastosti prehravani: (PREH_STAV[0-1])
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 20


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0128   156E           00359         bsf PREH_STAV0,2
                      00360 
                      00361         PROG_PAGE_1
0129   158A               M                         bsf PCLATH,3
012A   120A               M                         bcf PCLATH,4
012B   2079           00362         call VS_SOFT_RESET
                      00363 
012C   10CD           00364         bcf VSREG_MODE_L,1                      ; prehravame normalni rychlosti 
012D   106F           00365         bcf PREH_STAV1,0                        ; prehravame normalni rychlosti 
                      00366         
012E   3000           00367         movlw VSADDR_MODE
012F   00B6           00368         movwf TEMP1
0130   084D           00369         movfw VSREG_MODE_L
0131   00B7           00370         movwf TEMP2
0132   01B8           00371         clrf TEMP3
0133   2063           00372         call VS_WR_REG
                      00373         PROG_PAGE_0
0134   118A               M                         bcf PCLATH,3
0135   120A               M                         bcf PCLATH,4
                      00374         
0136   0008           00375         return
                      00376 ;*******************************************************************************************************
                            *************
0137                  00377 INIT_PORT
                      00378         BANK_1
0137   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0138   1683               M                 bsf     STATUS,RP0    
                      00379 
0139   3011           00380         movlw b'00010001'                       ; bity SO a DREQ jako vstupy (signaly z dekoderu)
                      00381 
013A   0085           00382         movwf MP3_PORT_TRIS
013B   3080           00383         movlw b'10000000'                       ; adresovani disku jako vystupy
013C   0087           00384         movwf ATA_ADDRESS_TRIS          
013D   3000           00385         movlw .0
013E   0089           00386         movwf ATA_CONTROL_TRIS          ; ovladani disku jako vystupy
013F   30FF           00387         movlw 0xff
0140   0086           00388         movwf DATA_PORT_LOW_TRIS        ; datovou sbernici jako vstupy
0141   0088           00389         movwf DATA_PORT_HIGH_TRIS       
                      00390         BANK_0
0142   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0143   1283               M                 bcf     STATUS,RP0    
                      00391         
0144   3007           00392         movlw b'00000111'       ; signal reset-, diow- a dior- jsou aktivni v log. 0 !!!
0145   0089           00393         movwf ATA_CONTROL
0146   3037           00394         movlw b'00110111'       ; CS1-, CS0- = 1 => datova sbernice disku je odpojena
0147   0087           00395         movwf ATA_ADDRESS
0148   0185           00396         clrf MP3_PORT   
0149   0008           00397         return
                      00398 ;**********************************************************
014A                  00399 INIT_CONFIG     ; nakonfiguruje preruseni, WDT, USART, pull ups....
                      00400         BANK_1
014A   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
014B   1683               M                 bsf     STATUS,RP0    
014C   30C7           00401         movlw b'11000111'       ; ...pull up a podobny koniny
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 21


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00402                 ; PORTB Pull-up Enable bit              1 = pull up enabled
                      00403                 ; Interrupt Edge Select bit             1 = interrupt on rising edge of RB0/INT pin
                      00404                 ; TMR0 Clock Source Select bit  0 = Internal instruction cycle clock (CLKO)
                      00405                 ; TMR0 Source Edge Select bit   0 = Increment on low-to-high transition on RA4/T0CKI pin
                      00406                 ; Prescaler Assignment bit              0 = Prescaler is assigned to the Timer0 module
                      00407                 ; PS2:PS0: Prescaler Rate Select bits   111 = TMR0 Rate 1 : 256; WDT Rate 1 : 128
014D   0081           00408         movwf OPTION_REG
                      00409         
014E   3020           00410         movlw b'00100000'       ; povolime preruseni od USARTu (kdyz neco dostanem)
014F   008C           00411         movwf PIE1      
0150   3000           00412         movlw b'00000000'       ; ostatni vnejsi preruseni vymaskujeme
0151   008D           00413         movwf PIE2                      
                      00414 
0152   30C0           00415         movlw b'11000000'       ; povolime preruseni na vnejsi zarizeni (USART)                         
0153   008B           00416         movwf INTCON
                      00417 
0154   3026           00418         movlw b'00100110'       ;konfigurace USARTu (asynchronni, 8bit, bez parity, rychle - (BRGH = 1))
0155   0098           00419         movwf TXSTA
                      00420         BANK_0
0156   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0157   1283               M                 bcf     STATUS,RP0    
0158   3090           00421         movlw b'10010000'       ;zapnu USART
0159   0098           00422         movwf RCSTA
                      00423         BANK_1
015A   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
015B   1683               M                 bsf     STATUS,RP0    
                      00424         ;movlw .129             ; Fosc = 20 MHz, BRGH=1 => rychlost = 9615 bps
015C   3067           00425         movlw .103                      ; Fosc = 16 MHz, BRGH=1 => rychlost = 9615 bps
015D   0099           00426         movwf SPBRG     
                      00427 
015E   3007           00428         movlw b'00000111'
015F   009F           00429         movwf ADCON1            ; vsechny vstupy (RA,RE) jako digitalni
                      00430         BANK_0  
0160   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0161   1283               M                 bcf     STATUS,RP0    
0162   019F           00431         clrf ADCON0                     ; pro jistotu (vypneme A/D prevodniky)
                      00432 
0163   01F3           00433         clrf PRIJATYCH_DAT      ; zasobnik prikazu prazdny...
0164   0008           00434         return
                      00435 ;**********************************************************
0165                  00436 WR_USART        ; odesle slovo ve workingu po USARTu
                      00437                         ; prijimani dat je reseno prez preruseni...
                      00438         BANK_1  
0165   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0166   1683               M                 bsf     STATUS,RP0    
0167   1C98           00439         btfss TXSTA,1 
0168   2965           00440         goto WR_USART   ; cekame do chvile nez bude pripraven transmit buffer 
                      00441 
                      00442         BANK_0  
0169   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
016A   1283               M                 bcf     STATUS,RP0    
016B   0099           00443         movwf TXREG
016C   0008           00444         return
                      00445 ;**********************************************************
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 22


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00446 ; tento podprogram bude pro budouci praci zbytecny, je zde jen proto, abych na PC videl ze program byl s
                            pusten...
016D                  00447 POZDRAV  ; odesle po seriove lince pozdrav
016D   3041           00448         movlw 'A'       
016E   2165           00449         call WR_USART
016F   3068           00450         movlw 'h'
0170   2165           00451         call WR_USART
0171   306F           00452         movlw 'o'
0172   2165           00453         call WR_USART
0173   306A           00454         movlw 'j'
0174   2165           00455         call WR_USART
0175   3021           00456         movlw '!'
0176   2165           00457         call WR_USART
0177   0008           00458         return
                      00459 ;**********************************************************
                      00460 ; odesle data, ktera jdou z disku USARTEM. Pocet dat je v reg. TEMP1
0178                  00461 ODESLI_DATA
0178   2254           00462         call READ_DATA  
0179   0820           00463         movfw DATA_L
017A   2165           00464         call WR_USART
017B   0821           00465         movfw DATA_H
017C   2165           00466         call WR_USART   
017D   0BB6           00467         decfsz TEMP1,F
017E   2978           00468         goto ODESLI_DATA
017F   0008           00469         return
                      00470 ;**********************************************************
0180                  00471 ODESLI_MODEL_NUMBER     ; Podprogram IDENTIFY_DEVICE nam do bufferu 1 hodil jmeno disku
                      00472                         ; mi jej ted odesleme USARTem, aby mohl byt zobrazen na displeji
                      00473         INDF_BANK_3     ; BUFFER_1 je v bance 3
0180   1783               M                         bsf STATUS,IRP    
0181   3090           00474         movlw 0x90      ; na adrese 90
0182   0084           00475         movwf FSR
0183   3014           00476         movlw .20       ; budeme odesilat 20 slov (40 znaku)
0184   00B6           00477         movwf TEMP1
0185                  00478 ODESLI_MODEL_NUMBER_ODESILANI
0185   0800           00479         movfw INDF
0186   00B7           00480         movwf TEMP2     ; data do bufferu byla vkladana stylem DATA_L, DATA_H, DATA_L, DATA_H...
0187   0A84           00481         incf FSR,F      ; ASCII hodnoty jsou ale razeny stylem DATA_H, DATA_L, DATA_H, DATA_L...
0188   0800           00482         movfw INDF      ; proto to pisu tak slozite...
0189   0A84           00483         incf FSR,F
                      00484         
018A   2165           00485         call WR_USART
018B   0837           00486         movfw TEMP2
018C   2165           00487         call WR_USART   
                      00488 
018D   0BB6           00489         decfsz TEMP1,F
018E   2985           00490         goto ODESLI_MODEL_NUMBER_ODESILANI
                      00491 
                      00492         INDF_BANK_0     
018F   1383               M                         bcf STATUS,IRP    
0190   0008           00493         return
                      00494 ;**********************************************************
0191                  00495 ODESLI_BUFF2_HIGH
                      00496         ; odesle z horni poloviny bufferu2 tolik bytu, kolik je v TEMP1
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 23


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00497         INDF_BANK_2     ; BUFFER_2 je v bance 2
0191   1783               M                         bsf STATUS,IRP    
0192   3030           00498         movlw 0x30      ; horni pulka od adresy 30h
0193   0084           00499         movwf FSR
0194                  00500 ODESLI_BUFF2_HIGH_ODESILANI
0194   0800           00501         movfw INDF
0195   2165           00502         call WR_USART
0196   0A84           00503         incf FSR,F      
0197   0BB6           00504         decfsz TEMP1,F
0198   2994           00505         goto ODESLI_BUFF2_HIGH_ODESILANI
                      00506 
                      00507         INDF_BANK_0             
0199   1383               M                         bcf STATUS,IRP    
019A   0008           00508         return
                      00509 ;**************************************************************************
019B                  00510 ODESLI_BUFFER2
                      00511         ; v TEMP1 ocakava hodnotu kolik bytu ma odeslat
                      00512         INDF_BANK_2     ; BUFFER_2 je v bance 2
019B   1783               M                         bsf STATUS,IRP    
019C   3010           00513         movlw 0x10      ; na adrese 10
019D   0084           00514         movwf FSR
019E                  00515 ODESLI_BUFFER2_ODESILANI
019E   0800           00516         movfw INDF
019F   2165           00517         call WR_USART
01A0   0A84           00518         incf FSR,F      
01A1   0BB6           00519         decfsz TEMP1,F
01A2   299E           00520         goto ODESLI_BUFFER2_ODESILANI
                      00521 
                      00522         INDF_BANK_0             
01A3   1383               M                         bcf STATUS,IRP    
01A4   0008           00523         return
                      00524 ;**********************************************************
01A5                  00525 INTERRUPT                                       ; sem se skace po zavolani preruseni (uz jsou vyreseny u
                            lohy dulezitych registru)
01A5   1E8C           00526         btfss PIR1,RCIF                 ; Meli bychom mit povoleno sice jen jedno preruseni (od USARTU),
                             jeden ale nikdy nevi, proto ten test
01A6   29B3           00527         goto END_OF_INTERRUPT   ; Pokud nejde o preruseni od USARTU, tak koncime...
01A7   081A           00528         movfw RCREG                             ; !!! vynulovat pøíznak !!!     
01A8   00F4           00529         movwf PRIJATE_DATO
                      00530 
01A9   0873           00531         movfw PRIJATYCH_DAT
01AA   3C07           00532         sublw .7                                ; pokud je v zasobniku uz plno (PRIJATYCH_DAT=8), tak ko
                            ncime
01AB   1C03           00533         btfss STATUS,C
01AC   29B3           00534         goto END_OF_INTERRUPT   ; Zasobnik je plny, nic prijimat nebudeme
                      00535 
01AD   0873           00536         movfw PRIJATYCH_DAT
01AE   3E78           00537         addlw 0x78                              ; zacatek zasobniku prikazu
01AF   0084           00538         movwf FSR
01B0   0874           00539         movfw PRIJATE_DATO              ; prijmuta data -> do W
01B1   0080           00540         movwf INDF                              ; prijate dato na prvni volne misto v zasobniku
                      00541         
01B2   0AF3           00542         incf  PRIJATYCH_DAT,F   ; pricteme k indikaci zasobniku
                      00543 ;       movlw '['
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 24


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00544 ;       call WR_USART
                      00545 ;       movfw PRIJATYCH_DAT
                      00546 ;       addlw .48
                      00547 ;       call WR_USART
                      00548 ;       movlw ']'
                      00549 ;       call WR_USART   
01B3                  00550 END_OF_INTERRUPT                        ; sem skocime kdyz mame vsechny veci kolem preruseni vyrizeny
01B3   0876           00551         movfw TEMP_PCLATH
01B4   008A           00552         movwf PCLATH
01B5   0872           00553         movfw TEMP_FSR
01B6   0084           00554         movwf FSR
01B7   0871           00555         movfw TEMP_STATUS
01B8   0083           00556         movwf STATUS
01B9   0870           00557         movfw TEMP_WORKING
01BA   0009           00558         retfie
                      00559 ;**********************************************************
01BB                  00560 DELAY_2ms
                      00561 ;Delay 8000 cycles
01BB   3013           00562         MOVLW 0x13  ;19 DEC
01BC   00B6           00563         MOVWF TMP1
01BD   308B           00564         MOVLW 0x8B  ;139 DEC
01BE   00B8           00565         MOVWF TMP0
01BF   0BB8           00566         DECFSZ TMP0,F
01C0   29BF           00567         GOTO $-1
01C1   0BB6           00568         DECFSZ TMP1,F
01C2   29BD           00569         GOTO $-5
                      00570 ;End of Delay   
01C3   0008           00571         return
                      00572 ;**********************************************************
01C4                  00573 DELAY_200ms
                      00574 ;Delay 197123 cycles
01C4   3000           00575         MOVLW 0x00  ;0 DEC
01C5   00B6           00576         MOVWF TMP1
01C6   3000           00577         MOVLW 0x00  ;0 DEC
01C7   00B8           00578         MOVWF TMP0
01C8   0BB8           00579         DECFSZ TMP0,F
01C9   29C8           00580         GOTO $-1
01CA   0BB6           00581         DECFSZ TMP1,F
01CB   29C8           00582         GOTO $-3
                      00583 ;End of Delay
01CC   0008           00584         return
                      00585 ;**********************************************************
01CD                  00586 DELAY_500ms
                      00587 ; (Fosc = 16 MHz , instr. cyklus= 0.25 us) 500 000us / 0.25 us = 2 000 000 instrukcnich cyklu
                      00588 ;Variables: TMP2, TMP1, TMP0
                      00589 ;Delay 2000000 cycles
01CD   3047           00590         MOVLW 0x47  ;71 DEC
01CE   00B7           00591         MOVWF TMP2
01CF   302B           00592         MOVLW 0x2B  ;43 DEC
01D0   00B6           00593         MOVWF TMP1
01D1   30D9           00594         MOVLW 0x0D9  ;217 DEC
01D2   00B8           00595         MOVWF TMP0
01D3   0BB8           00596         DECFSZ TMP0,F
01D4   29D3           00597         GOTO $-1
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 25


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

01D5   0BB6           00598         DECFSZ TMP1,F
01D6   29D1           00599         GOTO $-5
01D7   0BB7           00600         DECFSZ TMP2,F
01D8   29CF           00601         GOTO $-9
                      00602 ;End of Delay
01D9   0008           00603         return
                      00604 ;**********************************************************
                      00068         include "ata.asm"               ; podprogramy na ovladani ATA disku
                      00001 ;**********************************************************
                      00002 ;**********************************************************
                      00003 ;**********************************************************
                      00004 ; OBSLUZNE PODPROGRAMY PRO ATA
                      00005 ;**********************************************************
                      00006 ;**********************************************************
                      00007 ;**********************************************************
                      00008 
                      00009 ;**********************************************************
                      00010 ; cteni a zapis ATA registru 
                      00011 ;**********************************************************
01DA                  00012 RD_STATUS         
01DA   3027           00013         movlw D_STATUS      ; Status 
01DB   2231           00014         call RUTR 
01DC   00AC           00015         movwf ATA_STATUS
01DD   0008           00016         return
                      00017 ;*****************************************
01DE                  00018 RD_ERROR
01DE   3021           00019         movlw D_ERROR      ; Error
01DF   2231           00020         call RUTR
01E0   00A5           00021         movwf ATA_ERROR
01E1   0008           00022         return
                      00023 ;*****************************************
01E2                  00024 RD_STATUS_A     
01E2   3016           00025         movlw D_STATUS_A    ; Alternate Status 
01E3   2231           00026         call RUTR 
01E4   00A2           00027         movwf ATA_STATUS_A
01E5   0008           00028         return
                      00029 ;*****************************************
01E6                  00030 RD_SC
01E6   3022           00031         movlw D_SECTOR_C    ; Sector Count
01E7   2231           00032         call RUTR
01E8   00A6           00033         movwf SECTOR_C
01E9   0008           00034         return
                      00035 ;*****************************************
01EA                  00036 RD_LBA1
01EA   3023           00037         movlw D_LBA1    ; Sector Number 
01EB   2231           00038         call RUTR                
01EC   00A7           00039         movwf LBA1 
01ED   0008           00040         return
                      00041 ;*****************************************
01EE                  00042 RD_LBA2
01EE   3024           00043         movlw D_LBA2  ; Cylinder Low
01EF   2231           00044         call RUTR
01F0   00A8           00045         movwf LBA2
01F1   0008           00046         return
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 26


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00047 ;*****************************************
01F2                  00048 RD_LBA3
01F2   3025           00049         movlw D_LBA3  ; Cylinder High   
01F3   2231           00050         call RUTR
01F4   00A9           00051         movwf LBA3
01F5   0008           00052         return
                      00053 ;*****************************************
01F6                  00054 RD_DEVICE
01F6   3026           00055         movlw D_DEVICE  ; Device Head
01F7   2231           00056         call RUTR
01F8   00AB           00057         movwf DEVICE
01F9   0008           00058         return
                      00059 ;*****************************************
                      00060 ;*****************************************
01FA                  00061 WR_DC
01FA   0823           00062         movf DEVICE_C,w     ; Device Control
01FB   00B5           00063         movwf TEMPW
01FC   3016           00064         movlw D_DEVICE_C
01FD   223E           00065         call RUTW
01FE   0008           00066         return
                      00067 ;*****************************************
01FF                  00068 WR_COMMAND          
01FF   082D           00069         movf COMMAND,w      ; Command       
0200   00B5           00070         movwf TEMPW
0201   3027           00071         movlw D_COMMAND
0202   223E           00072         call RUTW
0203   0008           00073         return
                      00074 ;*****************************************
0204                  00075 WR_SC                    
0204   0826           00076     movf SECTOR_C,w     ; Sector Count
0205   00B5           00077         movwf TEMPW
0206   3022           00078         movlw D_SECTOR_C     
0207   223E           00079         call RUTW
0208   0008           00080         return
                      00081 ;*****************************************
0209                  00082 WR_LBA1
0209   0827           00083         movf LBA1,w     
020A   00B5           00084         movwf TEMPW
020B   3023           00085         movlw D_LBA1    
020C   223E           00086         call RUTW
020D   0008           00087         return
                      00088 ;*****************************************
020E                  00089 WR_LBA2
020E   0828           00090         movf LBA2,w   ; Cylinder Low
020F   00B5           00091         movwf TEMPW
0210   3024           00092         movlw D_LBA2
0211   223E           00093         call RUTW
0212   0008           00094         return
                      00095 ;*****************************************
0213                  00096 WR_LBA3
0213   0829           00097         movf LBA3,w   ; Cylinder High
0214   00B5           00098         movwf TEMPW
0215   3025           00099         movlw D_LBA3
0216   223E           00100         call RUTW
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 27


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0217   0008           00101         return
                      00102 ;*****************************************
0218                  00103 WR_DEVICE
0218   082B           00104         movf DEVICE,w     ; Device Head 
0219   00B5           00105         movwf TEMPW
021A   3026           00106         movlw D_DEVICE
021B   223E           00107         call RUTW
021C   0008           00108         return
                      00109 ;*****************************************
021D                  00110 WR_FEATURES
021D   0824           00111         movf FEATURES,w     ; Features
021E   00B5           00112         movwf TEMPW
021F   3021           00113         movlw D_FEATURES
0220   223E           00114         call RUTW
0221   0008           00115         return
                      00116 ;*****************************************
                      00117 ; zapise vsechny registry potrebne k vykonani prikazu (adresove registry a prikaz)
0222                  00118 WR_BLOCK
                      00119 ;       call WAIT_FOR_READY_FOR_COMMAND
0222   21DA           00120         call RD_STATUS
0223   182C           00121         btfsc ATA_STATUS,ERR
0224   2A29           00122         goto $+5                                        ; Nastal error disku. Co budeme delat? S*r*m* na
                             to a jdeme dal
0225   1BAC           00123         btfsc ATA_STATUS,BSY
0226   2A22           00124         goto $-4                                        ; Bsy <> 0, cekame dal 
0227   1F2C           00125         btfss ATA_STATUS,DRDY
0228   2A22           00126         goto $-6
                      00127 
0229   221D           00128         call WR_FEATURES
022A   2204           00129         call WR_SC
022B   2209           00130         call WR_LBA1
022C   220E           00131         call WR_LBA2
022D   2213           00132         call WR_LBA3
022E   2218           00133         call WR_DEVICE
022F   21FF           00134         call WR_COMMAND
0230   0008           00135         return
                      00136 ;*****************************************
                      00137 ; ve workingu mame adresu registru ktery mame precist, 
                      00138 ; pak v nem vracime jeho hodnotu...
0231                  00139 RUTR          
0231   0087           00140         movwf ATA_ADDRESS                  ; adresa pozadovaneho registru
                      00141 
                      00142         BANK_1
0232   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0233   1683               M                 bsf     STATUS,RP0    
0234   30FF           00143     movlw 0xFF
0235   0086           00144     movwf DATA_PORT_LOW_TRIS   ; z datove zbernice cteme
0236   0088           00145     movwf DATA_PORT_HIGH_TRIS
                      00146         BANK_0
0237   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0238   1283               M                 bcf     STATUS,RP0    
                      00147 
0239   1109           00148         bcf ATA_DIOR_N
023A   0000           00149     nop                                                 ; PIO delay min. 120ns (PIO 4)  
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 28


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

023B   0806           00150     movfw DATA_PORT_LOW                 ; Read DD0..D7 IDE
023C   1509           00151         bsf ATA_DIOR_N
                      00152 
023D   0008           00153     return
                      00154 ;**********************************************************
                      00155 ; ve workingu mame adresu registru ktery mame zapsat,
                      00156 ; a v reg. TEMPW hodnotu kterou mame do tohoto registru zapsat
023E                  00157 RUTW
023E   0087           00158         movwf ATA_ADDRESS
                      00159 
                      00160         BANK_1
023F   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0240   1683               M                 bsf     STATUS,RP0    
0241   3000           00161     movlw 0x0
0242   0086           00162     movwf DATA_PORT_LOW_TRIS   ; do datove sbernice zapisujeme
0243   0088           00163     movwf DATA_PORT_HIGH_TRIS
                      00164         BANK_0
0244   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0245   1283               M                 bcf     STATUS,RP0    
                      00165 
0246   0835           00166     movf TEMPW,w        
0247   0086           00167     movwf DATA_PORT_LOW                 ; Write DD0..DD7 IDE 
0248   0188           00168         clrf DATA_PORT_HIGH
                      00169 
0249   1089           00170         bcf ATA_DIOW_N
024A   0000           00171         nop
024B   1489           00172         bsf ATA_DIOW_N
                      00173           
                      00174         BANK_1
024C   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
024D   1683               M                 bsf     STATUS,RP0    
024E   30FF           00175     movlw 0xff
024F   0086           00176     movwf DATA_PORT_LOW_TRIS   ; datova sbernice na cteni
0250   0088           00177     movwf DATA_PORT_HIGH_TRIS
                      00178         BANK_0
0251   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0252   1283               M                 bcf     STATUS,RP0    
                      00179 
0253   0008           00180         return
                      00181 ;**********************************************************
0254                  00182 READ_DATA
                      00183 ;       call WAIT_FOR_DATA      ; tento odskok do dalsich podprogramu si nemohu, dovolit, protoze mam je
                            n 8bit STACK
                      00184         ; Wait: ( Bsy=0 AND Drq=1 ) OR err=1
                      00185         ; 7   6    5  4   3   2    1   0
                      00186         ; BSY DRDY DF DSC DRQ CORR IDX ERR
                      00187         ; (cekame az disk bude mit pro nas prichystana data)
0254   3027           00188         movlw D_STATUS      ; Status 
0255   2231           00189         call RUTR 
0256   00AC           00190         movwf ATA_STATUS
0257   182C           00191         btfsc ATA_STATUS,ERR
0258   2A5D           00192         goto READ_DATA_CTEME            ; Nastal error disku. Co budeme delat? S*r*m* na to a data prect
                            eme...
                      00193 
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 29


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0259   1BAC           00194         btfsc ATA_STATUS,BSY
025A   2A54           00195         goto READ_DATA                          ; Bsy <> 0, cekame dal 
                      00196         
025B   1DAC           00197         btfss ATA_STATUS,DRQ
025C   2A54           00198         goto READ_DATA                          ; Drq <> 1, cekame dal 
                      00199         
025D                  00200 READ_DATA_CTEME
                      00201 
025D   3020           00202     movlw D_DATA_R
025E   0087           00203         movwf ATA_ADDRESS
                      00204 
                      00205         BANK_1
025F   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0260   1683               M                 bsf     STATUS,RP0    
0261   30FF           00206     movlw 0xFF
0262   0086           00207     movwf DATA_PORT_LOW_TRIS   ; z datove zbernice cteme
0263   0088           00208     movwf DATA_PORT_HIGH_TRIS
                      00209         BANK_0
0264   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0265   1283               M                 bcf     STATUS,RP0    
                      00210 
0266   1109           00211         bcf ATA_DIOR_N
0267   0000           00212     nop                                                 ; PIO delay min. 120ns (PIO 4)  
0268   0000           00213         nop
0269   0806           00214     movfw DATA_PORT_LOW                 ; Read DD0..D7 IDE
026A   00A0           00215         movwf DATA_L
026B   0808           00216     movfw DATA_PORT_HIGH                ; Read DD8..D15 IDE
026C   00A1           00217         movwf DATA_H
026D   1509           00218         bsf ATA_DIOR_N
                      00219 
026E   0008           00220     return
                      00221 ;**********************************************************
                      00222 ; stava se, ze obcas nas zajima jen cast vracenych dat, tak ty ktere nas nezajimaji, preskocime
                      00223 ; ocakava parametr v registru TEMP1 (kolik slov ma preskocit)
                      00224 ; pokud TEMP1 = 0 tak preskoci 256 slov
026F                  00225 PRESKOC
026F   2254           00226         call READ_DATA
0270   0BB6           00227         decfsz TEMP1,F
0271   2A6F           00228         goto PRESKOC
0272   0008           00229         return
                      00230 ;**********************************************************
                      00231 ; rekne disku na ze pristi instrukce, registry, data.... budou pro mastera
0273                  00232 SELECT_DEVICE
0273   30E0           00233         movlw b'11100000'       ; adresy budou v LBA, budeme pracovat s masterem
0274   00AB           00234         movwf DEVICE
0275   2218           00235         call WR_DEVICE
0276   0008           00236         return
                      00237 ;**********************************************************
0277                  00238 ZAPIS_DO_BUFFERU_1      ; buffer1 ma 64B a je v bance 3 na adrese 0x190 - 0x1CF
                      00239                                         ; jako parametr dostanem TEMP1, kde je pocet bytu k zapisu
                      00240                                         ; maximalni hodnota v TEMP1 muze byt 32 (1 slovo = 2 byty)
                      00241         INDF_BANK_3             ; neprime adresovani na banku 3
0277   1783               M                         bsf STATUS,IRP    
0278   3090           00242         movlw 0x90              ; adresa ja 190, devaty byt urcuje banku (0,1 / 2,3) fsr je tedy 90
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 30


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0279   0084           00243         movwf FSR               
027A                  00244 ZAPIS_DO_BUFFERU_1__ZAPIS
027A   2254           00245         call READ_DATA
                      00246         
027B   0820           00247         movfw DATA_L
027C   0080           00248         movwf INDF
027D   0A84           00249         incf FSR,F
027E   0821           00250         movfw DATA_H
027F   0080           00251         movwf INDF
0280   0A84           00252         incf FSR,F
                      00253 
0281   0BB6           00254         decfsz TEMP1,F
0282   2A7A           00255         goto ZAPIS_DO_BUFFERU_1__ZAPIS
                      00256 
                      00257         INDF_BANK_0     
0283   1383               M                         bcf STATUS,IRP    
0284   0008           00258         return
                      00259 ;**********************************************************
0285                  00260 CLEAR_BUFFER2           ; BUFFER2 je 64bytu dat v bance 2 na adrese 0x110 - 0x14F
                      00261                                         ; pouziva TEMP1
0285   3040           00262         movlw .64
0286   00B6           00263         movwf TEMP1
                      00264         INDF_BANK_2             ; neprime adresovani na banku 2
0287   1783               M                         bsf STATUS,IRP    
0288   3010           00265         movlw 0x10
0289   0084           00266         movwf FSR
028A   3000           00267         movlw .0
                      00268 
028B                  00269 CLEAR_BEFFER2__CLEAR
028B   0080           00270         movwf INDF
028C   0A84           00271         incf FSR,F
028D   0BB6           00272         decfsz TEMP1,F
028E   2A8B           00273         goto CLEAR_BEFFER2__CLEAR
                      00274 
                      00275         INDF_BANK_0             ; neprime adresovani na banku 0
028F   1383               M                         bcf STATUS,IRP    
0290   0008           00276         return
                      00277 ;**********************************************************
0291                  00278 ATA_RESET
                      00279         ; Resetuje disk zjisti, zda vubec nejaky disk je pripojen
0291   01AE           00280         clrf ATA_ATTRIBUTES     ; registr obsahujici bity rikajici co disk umi
                      00281 
0292   1009           00282         bcf ATA_RESET_N         ; resetujeme disk
0293   2337           00283         call DELAY_25us         ; signal reset musi byt min. 25us
0294   1409           00284         bsf ATA_RESET_N         ; koncime s resetem disku
                      00285 
0295   233C           00286         call WAIT_FOR_READY     ; vynulujeme device bit v DEVICE registru (disk musi byt master!), ...
0296   2273           00287         call SELECT_DEVICE      ; ...nastavime bit L - LBA addressing
                      00288 
0297   233C           00289         call WAIT_FOR_READY
0298   3002           00290         movlw b'00000010'       ; zakazeme preruseni (ted mam na mysli signal INTRQ z disku)
0299   00A3           00291         movwf DEVICE_C          ; bit nIEN = 1 -> zakazeme preruseni disku (stejne nemame signal INTRQ p
                            ripojen)
029A   21FA           00292         call WR_DC                      ; zapiseme hodnotu do registru DEVICE CONTROL
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 31


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00293 
029B   30E0           00294         movlw b'11100000'       ; adresy budou v LBA, budeme pracovat s masterem
029C   00AB           00295         movwf DEVICE
029D   01A6           00296         clrf SECTOR_C
029E   01A7           00297         clrf LBA1       
029F   01A8           00298         clrf LBA2
02A0   01A9           00299         clrf LBA3
02A1   01A4           00300         clrf FEATURES
02A2   3000           00301         movlw h'00'                     ; code prikazu nop
02A3   00AD           00302         movwf COMMAND
02A4   2222           00303         call WR_BLOCK           ; ted provedeme prvni prikaz (nop) a podivame se co nam disk vrati
                      00304 
02A5   233C           00305         call WAIT_FOR_READY
02A6   21F6           00306         call RD_DEVICE          ; Precteme reg. device. Pokud je disk OK, tak by nam mel vratit to, co j
                            sme do nej predtim zapsaly
02A7   082B           00307         movfw DEVICE
02A8   3CE0           00308         sublw b'11100000'
02A9   1903           00309         btfsc STATUS,Z          ; pokud DEVICE <> b'11100000', tak tu bud disk nemame, nebo je nejakej r
                            ozsypanej, nebo je spatne svicivanej (treba SLAVE)
02AA   142E           00310         bsf ATA_ATTRIBUTES,ATA_OK       ; 0. bit = 1 -> disk je pritomen, zapnuty a funkcni...
                      00311 
02AB   0008           00312         return          
                      00313 ;**********************************************************
02AC                  00314 READ_SECTOR
                      00315         ; Tento podprogram prevezme parametry SECTOR_C (kolik sec. mame precist)
                      00316         ; a LBA1 - LBA4, kde je ulozena LBA adresa sectoru od ktereho mame cist
                      00317         ; Postara se o spravne zadani adresy do disku (LBA28 / LBA48) a zavolani prikazu ke cteni...
                      00318         ; Samotne cteni se musi obslouzit v jine casti programu (podle toho co cteme...)
                      00319 
                      00320 ;       call WAIT_FOR_READY
                      00321         ; Cekame az Bsy bit = 0 
02AC   21DA           00322         call RD_STATUS
02AD   182C           00323         btfsc ATA_STATUS,ERR
02AE   2AB1           00324         goto $+3                                        ; Nastal error disku. Co budeme delat? S*r*m* na
                             to a jdeme dal
02AF   1BAC           00325         btfsc ATA_STATUS,BSY
02B0   2AAC           00326         goto $-4                                        ; Bsy <> 0, cekame dal 
                      00327 
                      00328 
                      00329 ;       call SELECT_DEVICE
02B1   30E0           00330         movlw b'11100000'       ; adresy budou v LBA, budeme pracovat s masterem
02B2   00AB           00331         movwf DEVICE
02B3   2218           00332         call WR_DEVICE
                      00333 
                      00334 ;       call WAIT_FOR_READY_FOR_COMMAND
02B4   21DA           00335         call RD_STATUS
02B5   182C           00336         btfsc ATA_STATUS,ERR
02B6   2ABB           00337         goto $+5                                        ; Nastal error disku. Co budeme delat? S*r*m* na
                             to a jdeme dal
02B7   1BAC           00338         btfsc ATA_STATUS,BSY
02B8   2AB4           00339         goto $-4                                        ; Bsy <> 0, cekame dal 
02B9   1F2C           00340         btfss ATA_STATUS,DRDY
02BA   2AB4           00341         goto $-6
                      00342 
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 32


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

02BB   192E           00343         btfsc ATA_ATTRIBUTES,LBA48_SUPPORT
02BC   2ACC           00344         goto READ_SECTOR_LBA48
                      00345 
02BD                  00346 READ_SECTOR_LBA27               ; zadavani adresy v LBA28 je celkem jednoduche, LBA bity 24-27 jsou obsa
                            zene v dolnich 4 bitech DEVICE reg.
02BD   01A4           00347         clrf FEATURES
02BE   221D           00348         call WR_FEATURES
02BF   2204           00349         call WR_SC
02C0   2209           00350         call WR_LBA1
02C1   220E           00351         call WR_LBA2
02C2   2213           00352         call WR_LBA3
02C3   082A           00353         movfw LBA4                      ; Z nejvyssi casti adresy...
02C4   390F           00354         andlw b'00001111'       ; ...pouzijeme pouze dolni 4bity...
02C5   38E0           00355         iorlw b'11100000'       ; ...horni 3bity nastavime (LBA adresovani, master)...
02C6   00AB           00356         movwf DEVICE            ; ...a zapiseme do DEVICE.
02C7   2218           00357         call WR_DEVICE
02C8   3020           00358         movlw 0x20                      ; Read sector. OPCODE - 20h (with retries) or 21h (without retri
                            es)
02C9   00AD           00359         movwf COMMAND           ; ...podle me to znamena ze prikaz 20h se bude pri neuspechu pokouset zn
                            ova o cteni....
02CA   21FF           00360         call WR_COMMAND         ; ...protoze se v novejsich spicifacich jiz prikaz 21h nevyskytuje, pouz
                            ivam ke cteni 20h.
02CB   0008           00361         return
                      00362 
02CC                  00363 READ_SECTOR_LBA48
                      00364         ; !!! Pripominam ze to co zde pisu (o LBA48) vim ze specifikace ATA8, v praxi jsem LBA48 na zadn
                            em disku jeste nezkousel !!!
                      00365         ; Zadavani adresy pri LBA48 se o neco lisi nez LBA28. Do registru LBA 1,2,3 se data zadavaji 2x.
                             
                      00366         ; Prvi zadavani znamena horni cast adresy, druhe zadavani dolni cast adresy.
                      00367         ; Znova sem pisu ze v tomto programu vyuzijeme jen LBA o 32bitech (2TB) a ne celych LBA48
02CC   3000           00368         movlw .0
02CD   00B5           00369         movwf TEMPW
02CE   3022           00370         movlw D_SECTOR_C    ; vyssi cast parametru SECTOR_C = 0
02CF   223E           00371         call RUTW       
02D0   2204           00372         call WR_SC                      ; nizci cast parametru SECTOR_C
                      00373 
02D1   3000           00374         movlw .0
02D2   00B5           00375         movwf TEMPW
02D3   3025           00376         movlw D_LBA3            ; LBA bity 47:40
02D4   223E           00377         call RUTW
02D5   3000           00378         movlw .0
02D6   00B5           00379         movwf TEMPW
02D7   3024           00380         movlw D_LBA2            ; LBA bity 39:32
02D8   223E           00381         call RUTW
02D9   082A           00382         movfw LBA4
02DA   00B5           00383         movwf TEMPW
02DB   3023           00384         movlw D_LBA1            ; LBA bity 31:24
02DC   223E           00385         call RUTW
                      00386 
02DD   2213           00387         call WR_LBA3            ; LBA bity 23:16
02DE   220E           00388         call WR_LBA2            ; LBA bity 15:8
02DF   2209           00389         call WR_LBA1            ; LBA bity  7:0
02E0   3024           00390         movlw h'24'                     ; pri LBA48 se musi pouzit tohoto prikazu ke cteni (READ SECTOR(
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 33


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                            S) EXT - 24h, PIO data-in)
02E1   00AD           00391         movwf COMMAND
02E2   21FF           00392         call WR_COMMAND
02E3   0008           00393         return
                      00394 ;**********************************************************
02E4                  00395 IDENTIFY_DEVICE
                      00396         ; ted uz vime, ze mame pripojen nejaky disk, tento podprogram provede prikaz 
                      00397         ; identify device a zjisti co je disk zac. Nektere dulezite informace ulozi 
                      00398         ; (nastavi byty v ATA_ATTRIBUTES) a jmenovku disku hodi do bufferu
                      00399 
                      00400         ; rekneme disku, ze s nim chcem pracovat (s masterem)
02E4   233C           00401         call WAIT_FOR_READY
02E5   2273           00402         call SELECT_DEVICE
                      00403         
                      00404         ; podivame se zda tu vubec disk je a co podporuje (LBA)
02E6   233C           00405         call WAIT_FOR_READY     ; celame nez bude disk opet ready pro dalsi prikazy
                      00406 
02E7   30E0           00407         movlw b'11100000'       ; adresy budou v LBA, budeme pracovat s masterem
02E8   00AB           00408         movwf DEVICE
02E9   01A6           00409         clrf SECTOR_C
02EA   01A7           00410         clrf LBA1       
02EB   01A8           00411         clrf LBA2
02EC   01A9           00412         clrf LBA3
02ED   01A4           00413         clrf FEATURES
02EE   30EC           00414         movlw 0xEC                      ; code prikazu IDENTIFY DEVICE
02EF   00AD           00415         movwf COMMAND
02F0   2222           00416         call WR_BLOCK
                      00417 
                      00418         ; pokud se neco nepodelalo, dostanem 256 16ti bitovych slov kde je napsano co disk umi a co je t
                            o zac...
                      00419         ; slova cisluji od nuly, (tzn. ze slov je 0-255)
02F1   301B           00420         movlw .27               ; prvnich 27 slov je pro nas nepotrebnych
02F2   00B6           00421         movwf TEMP1
02F3   226F           00422         call PRESKOC
                      00423         
                      00424         ; [27-46] model mumber (ASCI retezec s nazvem disku)
                      00425         ; tady precteme 20 slov a rovnou je odesleme do pric
                      00426                 ; pokud nekde od disku dostavame ASCII retezec jsou data nasledujici: 
                      00427                 ; pr. disk nam posila string “Copyright”
                      00428                 ;               1. DATA_H = 'C' 
                      00429                 ;               1. DATA_l = 'o'
                      00430                 ;               2. DATA_H = 'P' 
                      00431                 ;               2. DATA_l = 'y'
02F4   3014           00432         movlw .20               ; dalsich 20 slov obsahuje 40 s ASCII znaku s nazvem disku
02F5   00B6           00433         movwf TEMP1
02F6   2277           00434         call ZAPIS_DO_BUFFERU_1
                      00435                 
                      00436         ; ted jsme uz precetli 47 slov z 256 :-)
02F7   3002           00437         movlw .2                ; dalsi 2 slova jsou nam k nicemu
02F8   00B6           00438         movwf TEMP1
02F9   226F           00439         call PRESKOC
                      00440                 
02FA   2254           00441         call READ_DATA  ; slovo 49 - capabilities (schopnosti)
                      00442                         ; 15:14 Reserved for the IDENTIFY PACKET DEVICE command.
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 34


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00443                         ;    13 1 = Standby timer values as specified in this standard are supported
                      00444                         ;       0 = Standby timer values shall be managed by the device
                      00445                         ;    12 Reserved for the IDENTIFY PACKET DEVICE command.
                      00446                         ;    11 1 = IORDY supported
                      00447                         ;       0 = IORDY may be supported
                      00448                         ;    10 1 = IORDY may be disabled
                      00449                         ;     9 1 = LBA supported
                      00450                         ;     8 1 = DMA supported.
                      00451                         ;   7:0 Retired 
02FB   18A1           00452         btfsc DATA_H,1  ;bit 9 = 1 -> LBA supported
02FC   14AE           00453         bsf ATA_ATTRIBUTES,LBA_SUPPORT
                      00454 
                      00455         ;precetli jsme 50 slov
02FD   300A           00456         movlw .10
02FE   00B6           00457         movwf TEMP1
02FF   226F           00458         call PRESKOC
                      00459         
0300   2254           00460         call READ_DATA  ; 60
0301   0820           00461         movfw DATA_L
0302   00AF           00462         movwf PARAM_MAX_LBA1            ; nejnizsi cast adresy
0303   0821           00463         movfw DATA_H
0304   00B0           00464         movwf PARAM_MAX_LBA2    
                      00465         
0305   2254           00466         call READ_DATA  ; 61
0306   0820           00467         movfw DATA_L
0307   00B1           00468         movwf PARAM_MAX_LBA3
0308   0821           00469         movfw DATA_H
0309   00B2           00470         movwf PARAM_MAX_LBA4            ; nejvyssi cast adresy
                      00471         
                      00472         ;precetli jsme 62 slov, zbyva 194
030A   3015           00473         movlw .21
030B   00B6           00474         movwf TEMP1
030C   226F           00475         call PRESKOC
                      00476 
                      00477         ; 83 slov, na rade je slovo 83 (pripominam ze slova jsou cislovana od nuly)
030D   2254           00478         call READ_DATA  ; 83 - command supported. Tady nas zajima bit 10 - 1 = 48-bit Address feature se
                            t supported
030E   1921           00479         btfsc DATA_H,2  ; pokud disk umi LBA 48 pripiseme tuto skutecnost do ATA_ATTRIBUTES
030F   152E           00480         bsf ATA_ATTRIBUTES,LBA48_SUPPORT
                      00481 
                      00482         ;precetli jsme 84 slov
0310   3010           00483         movlw .16
0311   00B6           00484         movwf TEMP1
0312   226F           00485         call PRESKOC
                      00486                 
0313   1D2E           00487         btfss ATA_ATTRIBUTES,LBA48_SUPPORT
0314   2B20           00488         goto INIT_ATA__NOT_SUPPORT_LBA48
                      00489                         ; pokud je podporovano LBA 48, nachazi se ve slovech [100-103] skutecny pocet se
                            ktoru 
                      00490                         ; do slov 60-61 by se sice vesel pocet sektoru u disku do 2TB, podle standardu s
                            e tam ale zapisuje pouze hodnota max pro LBA 28 (cca 120 GB)
                      00491                         ; mi precteme ale jen nejnizsi 2 slova, predpokladam totiz ze disk neni vetsi ja
                            k 2TB
0315   2254           00492                         call READ_DATA  ; 100
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 35


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0316   0820           00493                         movfw DATA_L
0317   00AF           00494                         movwf PARAM_MAX_LBA1            ; nejnizsi cast adresy
0318   0821           00495                         movfw DATA_H
0319   00B0           00496                         movwf PARAM_MAX_LBA2    
                      00497 
031A   2254           00498                         call READ_DATA  ; 101
031B   0820           00499                         movfw DATA_L
031C   00B1           00500                         movwf PARAM_MAX_LBA3
031D   0821           00501                         movfw DATA_H
031E   00B2           00502                         movwf PARAM_MAX_LBA4            ; nejvyssi cast adresy                  
031F   2B23           00503                 goto INIT_ATA__DALSI
0320                  00504 INIT_ATA__NOT_SUPPORT_LBA48
0320   3002           00505         movlw .2        ; 100, 101
0321   00B6           00506         movwf TEMP1
0322   226F           00507         call PRESKOC    
0323                  00508 INIT_ATA__DALSI
                      00509         ; precetli jsme 102 slov
0323   3004           00510         movlw .4        ; 102, 103, 104, 105
0324   00B6           00511         movwf TEMP1
0325   226F           00512         call PRESKOC
                      00513 
0326   2254           00514         call READ_DATA  ; slovo 106 - pokud bit 15=0 a bit 14=1, tak obsahuje pravdive informace
                      00515                                                 ; pro nas je podstatne, ze pokud je bit 12 = 1, tak sekt
                            or je vetsi nez 256 slov
                      00516                                                 ; pokud je sektor vetsi nez 256 slov, je jeho velikost v
                            e slovech [117-118]
0327   1BA1           00517         btfsc DATA_H,7
0328   2B2D           00518         goto INIT_ATA__DALSI2
0329   1F21           00519         btfss DATA_H,6
032A   2B2D           00520         goto INIT_ATA__DALSI2
032B   1A21           00521         btfsc DATA_H,4
032C   15AE           00522         bsf ATA_ATTRIBUTES,BIG_SECTOR
032D                  00523 INIT_ATA__DALSI2
                      00524         ; precteno 107, zbyva 149
032D   3095           00525         movlw .149      ; 107 - 256
032E   00B6           00526         movwf TEMP1
032F   226F           00527         call PRESKOC
                      00528                 
                      00529         ; ted vime co mame za disk, tak se na to jdem podivat...
                      00530         ; pokud disk splnuje vsechny nase pozadavky, tak nastavime 7 bit v ATA_ATTRIBUTES
0330   13AE           00531         bcf ATA_ATTRIBUTES,APPLICABLE   
0331   1CAE           00532         btfss ATA_ATTRIBUTES,LBA_SUPPORT
0332   0008           00533         return
                      00534         ; pokud jsme tady, disk podporuje LBA (dneska se jich uz moc nevidi, co by LBA neumeli)
0333   19AE           00535         btfsc ATA_ATTRIBUTES,BIG_SECTOR
0334   0008           00536         return
                      00537         ; mazec, disk ma velikost sektoru 256 slov, vetsi naroky na disk nemam :-)
0335   17AE           00538         bsf ATA_ATTRIBUTES,APPLICABLE ; disk umi to co potrebujeme...   
                      00539 
0336   0008           00540         return
                      00541 ;**************************************************************************
                      00542 ;**********************************************************
                      00543 ; CEKACI PROCEDURY
                      00544 ;**********************************************************
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 36


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0337                  00545 DELAY_25us
                      00546         ; pouziva TEMP1
                      00547         ; (Fosc = 20 MHz , instr. cyklus= 0.20 us) 25us / 0.20 us = 125 instrukcnich cyklu
                      00548         ; (Fosc = 16 MHz , instr. cyklus= 0.25 us) 25us / 0.25 us = 100 instrukcnich cyklu
                      00549         ; (Fosc = 04 MHz , instr. cyklus= 1.00 us) 25us / 1.00 us =  25 instrukcnich cyklu      
                      00550         ;MOVLW 0x2A  ;42 DEC -> Delay 127 cycles
0337   3021           00551         MOVLW 0x21   ;33 DEC -> Delay 100 cycles
                      00552         ;MOVLW 0x08  ;25 DEC -> Delay  25 cycles
0338   00B6           00553         MOVWF TEMP1
0339   0BB6           00554         DECFSZ TEMP1,F
033A   2B39           00555         GOTO $-1
                      00556         ;End of Delay
033B   0008           00557         return
                      00558 ;**************************************************************************
033C                  00559 WAIT_FOR_READY
                      00560         ; Cekame az Bsy bit = 0 
                      00561         ; (cekame az disk nebude zaneprazdnen)
033C   21DA           00562         call RD_STATUS
033D   082C           00563         movfw ATA_STATUS
033E   3980           00564         andlw b'10000000'
033F   1903           00565         btfsc STATUS,Z
0340   0008           00566         return
0341   2B3C           00567         goto WAIT_FOR_READY
                      00568 ;**************************************************************************
                      00569 ;WAIT_FOR_READY_FOR_COMMAND
                      00570 ;       call WAIT_FOR_READY
                      00571 ;       btfss ATA_STATUS,DRDY
                      00572 ;       goto WAIT_FOR_READY_FOR_COMMAND
                      00573 ;       return
                      00574 ;**************************************************************************
                      00069         include "fat32.asm"     ; podprogramy na nacteni a praci s FAT32
                      00001 ;**********************************************************
                      00002 ;**********************************************************
                      00003 ;**********************************************************
                      00004 ; OBSLUZNE PODPROGRAMY PRO FAT32, HLEDANI ODDILU
                      00005 ;**********************************************************
                      00006 ;**********************************************************
                      00007 ;**********************************************************
                      00008 
                      00009 ;**************************************************************************
0342                  00010 SCAN_MBR
                      00011         ; Tato procedura ma na prvni pohled jednoduchy ukol, podiva se do MBR a do BUFFERU 2 hodi nasled
                            ujici data:
                      00012         ; 4 x 16 bytovy zaznam, kde kazdy zaznam reprezentuje jeden oddil se systemem FAT32
                      00013         ; struktura zaznamu je nasledujici:             1  byt (pokud = 0 tak v zaznamu neni zaznam o od
                            dilu, pokud = FFh , je zaznam o oddilu)
                      00014         ;                                                                               4  byty = adresa
                             kde se nachazi spousteci zaznam oddilu
                      00015         ;                                                                               11 bytu = jmenov
                            ka oddilu s FAT32 (neni dulezita, jen aby bylo co vypsat na display :-)
0342   2285           00016         call CLEAR_BUFFER2
                      00017 
0343   01A7           00018         clrf LBA1
0344   01A8           00019         clrf LBA2
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 37


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0345   01A9           00020         clrf LBA3
0346   01AA           00021         clrf LBA4                               ; jako prvni cteme MBR
                      00022 
0347   01BB           00023         clrf POZICE                             ; kolik zaznamu o oddilech uz bylo zapsano do bufferu2
0348                  00024 SCAN_BR                                         
                      00025         ; tady na tom navesti mame zadanou adresu MBR nebo BR nejakeho rozsireneho oddilu
0348   3001           00026         movlw .1
0349   00A6           00027         movwf SECTOR_C
034A   22AC           00028         call READ_SECTOR                ; cteme MBR nebo BR rozsireneho oddilu
                      00029 
034B   30DF           00030         movlw .223                              ; 223 slov = 446 bytu
034C   00B6           00031         movwf TEMP1
034D   226F           00032         call PRESKOC                    ; na prvnich 446 bytech MBR je zavadeci program systemu (samozre
                            jme, pokud na disku system je)
034E   3020           00033         movlw .32
034F   00B6           00034         movwf TEMP1
0350   2277           00035         call ZAPIS_DO_BUFFERU_1 ; do bufferu si dame vsechny zaznamy BR (16*4=64bytu / 32slov)
0351   3001           00036         movlw .1
0352   00B6           00037         movwf TEMP1
0353   226F           00038         call PRESKOC
                      00039         ; tak ted jsme precetli cely MBR/BR a zaznamy o jeho oddilech mame v BEFFERU 1, tak se jdem na n
                            e podivat...
                      00040         
                      00041         ; Nejdriv si ale hodime aktualni LBA adresu do operandu Y pro aritmeticke operace
                      00042         INDF_BANK_1                             ; neprime adresovani na banku 1 (aritmeticke operace)
0354   1383               M                         bcf STATUS,IRP    
0355   30A4           00043         movlw 0xA4                              ; FSR na OPERAND_Y
0356   0084           00044         movwf FSR       
0357   0827           00045         movfw LBA1
0358   0080           00046         movwf INDF
0359   0A84           00047         incf FSR,F
035A   0828           00048         movfw LBA2
035B   0080           00049         movwf INDF
035C   0A84           00050         incf FSR,F
035D   0829           00051         movfw LBA3
035E   0080           00052         movwf INDF
035F   0A84           00053         incf FSR,F
0360   082A           00054         movfw LBA4
0361   0080           00055         movwf INDF
0362   0A84           00056         incf FSR,F
                      00057 
                      00058         INDF_BANK_3                             ; neprime adresovani na banku 3 (buffer 1)      
0363   1783               M                         bsf STATUS,IRP    
0364   3094           00059         movlw 0x94                              ; 90h (buffer1) + 4 (pozice kde je ulozen identifikator 
                            souboroveho systemu prvniho zaznamu BR)
0365   0084           00060         movwf FSR
0366   0800           00061         movfw INDF
0367   3C0C           00062         sublw h'0C'                             ; Pokud se FileSystem <> 0Ch...
0368   1D03           00063         btfss STATUS,Z
0369   3C01           00064         sublw .1                                ; ...ani 0Bh...
036A   1D03           00065         btfss STATUS,Z
036B   2B91           00066         goto SCAN_MBR__HLEDEJ_ROZSIRENY_ODDIL   ; ...tak hledej rozsireny oddil.
                      00067 
                      00068         ; pokud jsme v teto casti programu, tak prvni zaznam MBR/BR obsahuje oddil FAT32, s reprezentaci
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 38


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                             adres stylem LBA
                      00069         ; Tady pozor, v MBR/BR neni zapsana LBA adresa oddilu, ale relativni vzdalenost (offset) od MBR/
                            BR.
                      00070         ; To znamena, ze k adrese v (M)BR musime pricist offset oddilu.
                      00071         BANK_1
036C   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
036D   1683               M                 bsf     STATUS,RP0    
036E   3098           00072         movlw 0x98                              ; offset prvniho zaznamu 
036F   0084           00073         movwf FSR
0370   0800           00074         movfw INDF
0371   00A0           00075         movwf OPERAND_X1
0372   0A84           00076         incf FSR,F
0373   0800           00077         movfw INDF
0374   00A1           00078         movwf OPERAND_X2
0375   0A84           00079         incf FSR,F
0376   0800           00080         movfw INDF
0377   00A2           00081         movwf OPERAND_X3
0378   0A84           00082         incf FSR,F
0379   0800           00083         movfw INDF
037A   00A3           00084         movwf OPERAND_X4
                      00085         BANK_0
037B   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
037C   1283               M                 bcf     STATUS,RP0    
                      00086 
037D   25B4           00087         call SOUCET
                      00088 
                      00089         INDF_BANK_1                             ; neprime adresovani na banku 1 (aritmeticke operace)
037E   1383               M                         bcf STATUS,IRP    
037F   30A8           00090         movlw 0xA8                              ; FSR na VYSLEDEK
0380   0084           00091         movwf FSR       
0381   0800           00092         movfw INDF
0382   00A7           00093         movwf LBA1
0383   0A84           00094         incf FSR,F
0384   0800           00095         movfw INDF
0385   00A8           00096         movwf LBA2
0386   0A84           00097         incf FSR,F
0387   0800           00098         movfw INDF
0388   00A9           00099         movwf LBA3
0389   0A84           00100         incf FSR,F
038A   0800           00101         movfw INDF
038B   00AA           00102         movwf LBA4
038C   0A84           00103         incf FSR,F
                      00104 
038D   23BC           00105         call ZKONTROLUJ_ODDIL_FAT32     ; pokud skutecne adresa v LBA1-4 ukazuje na zacatek oddilu s FAT
                            32, tak da do bufferu2 jmenovku a adresu oddilu
                      00106         INDF_BANK_3
038E   1783               M                         bsf STATUS,IRP    
038F   30A4           00107         movlw 0xA4                                      ; 90h (buffer 1) + 16 (velikost 1. zaznamu) + 4 
                            (identifikator souboroveho systemu 2. zaznamu)
0390   0084           00108         movwf FSR
0391                  00109 SCAN_MBR__HLEDEJ_ROZSIRENY_ODDIL                ; jdem v zaznamech MBR/BR hledat rozsireny oddil
                      00110         ; pokud byl v prvnim zaznamu oddil typu FAT32, tak nam  tad FSR ukazuje na FileSystem 2. zaznamu
                            ...
                      00111         ; ...pokud 1. zaznam nebyl typu FAT32, tak nam FSR ukazuje na FileSystem 1. zaznamu.
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 39


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00112         ; Kazdopadne se ted podivame na dalsi zaznam a pokud obsahuje rozsireny oddil, skocime na jeho a
                            dresu a dame goto SCAN_BR ...
0391   0800           00113         movfw INDF
0392   3C05           00114         sublw h'05'                             ; Pokud se FileSystem <> 05h (rozsireny oddil CHS)...
0393   1D03           00115         btfss STATUS,Z
0394   3C0A           00116         sublw h'0A'                             ; ...ani se <> 0Fh (5+A=F) (rozsireny oddil LBA)...
0395   1D03           00117         btfss STATUS,Z
0396   2BBB           00118         goto SCAN_MBR__KONEC    ; ...tak koncime...
                      00119 
0397   0804           00120         movfw FSR                               ; ...pokud tu ale mame rozsireny oddil,...
0398   3E04           00121         addlw .4                                ; ...tak se jdem podivat na jeho adresu.
0399   0084           00122         movwf FSR
                      00123 
                      00124         BANK_1
039A   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
039B   1683               M                 bsf     STATUS,RP0    
                      00125         INDF_BANK_3
039C   1783               M                         bsf STATUS,IRP    
039D   0800           00126         movfw INDF
039E   00A0           00127         movwf OPERAND_X1
039F   0A84           00128         incf FSR,F
03A0   0800           00129         movfw INDF
03A1   00A1           00130         movwf OPERAND_X2
03A2   0A84           00131         incf FSR,F
03A3   0800           00132         movfw INDF
03A4   00A2           00133         movwf OPERAND_X3
03A5   0A84           00134         incf FSR,F
03A6   0800           00135         movfw INDF
03A7   00A3           00136         movwf OPERAND_X4
                      00137         BANK_0
03A8   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
03A9   1283               M                 bcf     STATUS,RP0    
                      00138 
03AA   25B4           00139         call SOUCET
                      00140 
                      00141         INDF_BANK_1                             ; neprime adresovani na banku 1 (aritmeticke operace)
03AB   1383               M                         bcf STATUS,IRP    
03AC   30A8           00142         movlw 0xA8                              ; FSR na VYSLEDEK
03AD   0084           00143         movwf FSR       
03AE   0800           00144         movfw INDF
03AF   00A7           00145         movwf LBA1
03B0   0A84           00146         incf FSR,F
03B1   0800           00147         movfw INDF
03B2   00A8           00148         movwf LBA2
03B3   0A84           00149         incf FSR,F
03B4   0800           00150         movfw INDF
03B5   00A9           00151         movwf LBA3
03B6   0A84           00152         incf FSR,F
03B7   0800           00153         movfw INDF
03B8   00AA           00154         movwf LBA4
03B9   0A84           00155         incf FSR,F
                      00156         
03BA   2B48           00157         goto SCAN_BR                    ; S rozirenym oddilem provedeme totez co s MBR
03BB                  00158 SCAN_MBR__KONEC
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 40


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

03BB   0008           00159         return
                      00160 ;**************************************************************************
03BC                  00161 ZKONTROLUJ_ODDIL_FAT32
                      00162         ; tak ted bychom mely mit v LBA 1-4 adresu spousteciho zaznamu oddilu s FAT32, tak to jdem overi
                            t...
                      00163         ; ...a pokud tam doopravdy spousteci zaznam je, tak dame jmenovku a informace do bufferu 2 na po
                            zici jaka je v rag. POZICE
                      00164         INDF_BANK_2
03BC   1783               M                         bsf STATUS,IRP    
03BD   083B           00165         movfw POZICE
03BE   00B6           00166         movwf TEMP1
03BF   1003           00167         bcf STATUS,C
03C0   0DB6           00168         rlf TEMP1,F
03C1   0DB6           00169         rlf TEMP1,F
03C2   0DB6           00170         rlf TEMP1,F
03C3   0DB6           00171         rlf TEMP1,F                             ; TEMP1 := POZICE *16
03C4   0836           00172         movfw TEMP1
03C5   3E11           00173         addlw 0x11                              ; TEMP1 + pozice bufferu 2 + 1 (pozice kam budeme do buf
                            feru 2 davat adresu oddilu)
03C6   0084           00174         movwf FSR
                      00175 
03C7   0827           00176         movfw LBA1
03C8   0080           00177         movwf INDF
03C9   0A84           00178         incf FSR,F
03CA   0828           00179         movfw LBA2
03CB   0080           00180         movwf INDF
03CC   0A84           00181         incf FSR,F
03CD   0829           00182         movfw LBA3
03CE   0080           00183         movwf INDF
03CF   0A84           00184         incf FSR,F
03D0   082A           00185         movfw LBA4
03D1   0080           00186         movwf INDF
03D2   0A84           00187         incf FSR,F                              ; adresa oddilu je ulozena do bufferu 2, ted tam jdem da
                            vat jmenovku oddilu
                      00188 
03D3   3001           00189         movlw .1
03D4   00A6           00190         movwf SECTOR_C
03D5   22AC           00191         call READ_SECTOR
03D6   3023           00192         movlw h'23'
03D7   00B6           00193         movwf TEMP1
03D8   226F           00194         call PRESKOC                    ; informace o FATce co nas ted zrovna moc nezejimaji
                      00195         ; na offsetu 47 je ulozena jmenovka oddilu (11znaku), ted jsme na offsetu 46
                      00196 
03D9   2254           00197         call READ_DATA
03DA   0821           00198         movfw DATA_H
03DB   0080           00199         movwf INDF                              ; 1. znak ze jmenovky svazku
03DC   0A84           00200         incf FSR,F
                      00201 
03DD   3005           00202         movlw .5                                ; dalsich 10 bytu je zbytek jmenovky
03DE   00B6           00203         movwf TEMP1
03DF                  00204 ZKONTROLUJ_ODDIL_FAT32__JMENOVKA
03DF   2254           00205         call READ_DATA
03E0   0820           00206         movfw DATA_L
03E1   0080           00207         movwf INDF
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 41


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

03E2   0A84           00208         incf FSR,F
03E3   0821           00209         movfw DATA_H
03E4   0080           00210         movwf INDF
03E5   0A84           00211         incf FSR,F
03E6   0BB6           00212         decfsz TEMP1,F
03E7   2BDF           00213         goto ZKONTROLUJ_ODDIL_FAT32__JMENOVKA
03E8   3010           00214         movlw .16
03E9   0284           00215         subwf FSR,F                                     ; aby fsr ukazoval na priznak o pravdivosti (FSR
                             := FSR - 16)
                      00216 
03EA   2254           00217         call READ_DATA
03EB   0820           00218         movfw DATA_L
03EC   3C46           00219         sublw 'F'               
03ED   1D03           00220         btfss STATUS,Z
03EE   2C04           00221         goto ZKONTROLUJ_ODDIL_FAT32__KONEC
03EF   0821           00222         movfw DATA_H
03F0   3C41           00223         sublw 'A'               
03F1   1D03           00224         btfss STATUS,Z
03F2   2C04           00225         goto ZKONTROLUJ_ODDIL_FAT32__KONEC
                      00226 
03F3   2254           00227         call READ_DATA
03F4   0820           00228         movfw DATA_L
03F5   3C54           00229         sublw 'T'               
03F6   1D03           00230         btfss STATUS,Z
03F7   2C04           00231         goto ZKONTROLUJ_ODDIL_FAT32__KONEC
03F8   0821           00232         movfw DATA_H
03F9   3C33           00233         sublw '3'               
03FA   1D03           00234         btfss STATUS,Z
03FB   2C04           00235         goto ZKONTROLUJ_ODDIL_FAT32__KONEC
                      00236 
03FC   2254           00237         call READ_DATA
03FD   0820           00238         movfw DATA_L
03FE   3C32           00239         sublw '2'
03FF   1D03           00240         btfss STATUS,Z
0400   2C04           00241         goto ZKONTROLUJ_ODDIL_FAT32__KONEC
                      00242         ; tak, ted uz opravdu vime, ze na tomto sektoru se nachazi spousteci zaznam svazku se souborovym
                             systemem FAT32
                      00243 
0401   30FF           00244         movlw h'FF'
0402   0080           00245         movwf INDF
0403   0ABB           00246         incf POZICE,F                           ; sektor skutecne obsahoval spousteci zaznam svazku...
0404                  00247 ZKONTROLUJ_ODDIL_FAT32__KONEC
0404   0008           00248         return
                      00249 ;**************************************************************************
0405                  00250 NACTI_FAT32
                      00251         ; V LBA1-4 bychom meli dostat adresu prvniho sektoru FAT32 oddilu, kde by se mely nalezat inform
                            ace o fatce
                      00252         ; pokud je FATka pro nas pouzitelna (Clustery nejsou moc velke, sektor = 512B ...) nastavime bit
                             FAT32_LOAD v ATA_ATTRIBUTES
0405   122E           00253         bcf ATA_ATTRIBUTES,FAT32_LOAD
0406   01C0           00254         clrf POCATEK_DAT1
0407   01C1           00255         clrf POCATEK_DAT2
0408   01C2           00256         clrf POCATEK_DAT3
0409   01C3           00257         clrf POCATEK_DAT4
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 42


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

040A   01C4           00258         clrf POCATEK_FAT1
040B   01C5           00259         clrf POCATEK_FAT2
040C   01C6           00260         clrf POCATEK_FAT3
040D   01C7           00261         clrf POCATEK_FAT4
040E   01C8           00262         clrf ROOT_DIR_CL1
040F   01C9           00263         clrf ROOT_DIR_CL2
0410   01CA           00264         clrf ROOT_DIR_CL3
0411   01CB           00265         clrf ROOT_DIR_CL4
                      00266 
                      00267 
0412   01A4           00268         clrf FEATURES
0413   3001           00269         movlw .1
0414   00A6           00270         movwf SECTOR_C
0415   22AC           00271         call READ_SECTOR
                      00272 
0416   3005           00273         movlw .5
0417   00B6           00274         movwf TEMP1
0418   226F           00275         call PRESKOC
                      00276 
0419   2254           00277         call READ_DATA                          ; 10 bytu precteno
041A   0821           00278         movfw DATA_H                            ; 11,12 byte - velikost sektoru (tady by melo byt 512, a
                            le co kdyby ne...)
041B   39FF           00279         andlw h'FF'
041C   1D03           00280         btfss STATUS,Z
041D   2CC8           00281         goto NACTI_FAT32__KONEC         ; pokud 11 byte neni nula, koncime (velikost sektoru se nerovna 
                            512)
                      00282 
041E   2254           00283         call READ_DATA                          ; ctu 12. a 13. byte
041F   0820           00284         movfw DATA_L
0420   3C02           00285         sublw h'02'
0421   1D03           00286         btfss STATUS,Z
0422   2CC8           00287         goto NACTI_FAT32__KONEC         ; pokud 12 byte neni 2, koncime (velikost sektoru se nerovna 512
                            )
                      00288 
0423   0821           00289         movfw DATA_H                            ; byte 13. SectorsPerCluster
0424   00CC           00290         movwf CLUSTER_SIZE
0425   3C20           00291         sublw .32                                       ; nas program neumi vic jak 32 (Velikost cluster
                            u = 16KB)
0426   1C03           00292         btfss STATUS,C
0427   2CC8           00293         goto NACTI_FAT32__KONEC         ; pokud mame clustery vetsi jak 16KB, tak koncime
                      00294 
0428   2254           00295         call READ_DATA                          ; ctu 14. a 15. byte
0429   0820           00296         movfw DATA_L
042A   00C4           00297         movwf POCATEK_FAT1                      ; tady se nachazi pocet rezervovanych sektoru, pak k ZAC
                            ATEK_FAT pricteme adresu zacatku sektoru a mame zacatek fat...
042B   0821           00298         movfw DATA_H
042C   00C5           00299         movwf POCATEK_FAT2
                      00300         
042D   2254           00301         call READ_DATA                          ; ctu 16. a 17. byte
042E   0820           00302         movfw DATA_L                            ; Pocet FAT. byva temer vzdy 2, kdyby ale ne, tak by nam
                             to delalo docela bordel...
042F   3C02           00303         sublw .2
0430   1D03           00304         btfss STATUS,Z
0431   2CC8           00305         goto NACTI_FAT32__KONEC
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 43


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00306 
0432   3009           00307         movlw .9
0433   00B6           00308         movwf TEMP1
0434   226F           00309         call PRESKOC                            ; 18 - 35
                      00310 
0435   2254           00311         call READ_DATA                          ; 36,37 -> velikost FAT (pocet sektoru)
0436   0820           00312         movfw DATA_L
0437   00C0           00313         movwf POCATEK_DAT1
0438   0821           00314         movfw DATA_H
0439   00C1           00315         movwf POCATEK_DAT2      
043A   2254           00316         call READ_DATA                          ; 38,39 -> velikost FAT (pocet sektoru)
043B   0820           00317         movfw DATA_L
043C   00C2           00318         movwf POCATEK_DAT3
043D   0821           00319         movfw DATA_H
043E   00C3           00320         movwf POCATEK_DAT4
                      00321 
043F   2254           00322         call READ_DATA                          ; 40,41
0440   2254           00323         call READ_DATA                          ; 42,43
                      00324 
0441   2254           00325         call READ_DATA                          ; 44,45
0442   0820           00326         movfw DATA_L
0443   00C8           00327         movwf ROOT_DIR_CL1
0444   0821           00328         movfw DATA_H
0445   00C9           00329         movwf ROOT_DIR_CL2
0446   2254           00330         call READ_DATA                          ; 46,47
0447   0820           00331         movfw DATA_L
0448   00CA           00332         movwf ROOT_DIR_CL3
0449   0821           00333         movfw DATA_H
044A   00CB           00334         movwf ROOT_DIR_CL4
                      00335 
044B   3011           00336         movlw .17
044C   00B6           00337         movwf TEMP1
044D   226F           00338         call PRESKOC                            ; 48 - 81
                      00339 
                      00340         ; ted jeste takova mala kontrola...
044E   2254           00341         call READ_DATA
044F   0820           00342         movfw DATA_L
0450   3C46           00343         sublw 'F'               
0451   1D03           00344         btfss STATUS,Z
0452   2CC8           00345         goto NACTI_FAT32__KONEC
0453   0821           00346         movfw DATA_H
0454   3C41           00347         sublw 'A'               
0455   1D03           00348         btfss STATUS,Z
0456   2CC8           00349         goto NACTI_FAT32__KONEC
0457   2254           00350         call READ_DATA
0458   0820           00351         movfw DATA_L
0459   3C54           00352         sublw 'T'               
045A   1D03           00353         btfss STATUS,Z
045B   2CC8           00354         goto NACTI_FAT32__KONEC
045C   0821           00355         movfw DATA_H
045D   3C33           00356         sublw '3'               
045E   1D03           00357         btfss STATUS,Z
045F   2CC8           00358         goto NACTI_FAT32__KONEC
0460   2254           00359         call READ_DATA
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 44


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0461   0820           00360         movfw DATA_L
0462   3C32           00361         sublw '2'
0463   1D03           00362         btfss STATUS,Z
0464   2CC8           00363         goto NACTI_FAT32__KONEC
                      00364         ; tak, ted uz opravdu vime, ze na tomto sektoru se nachazi spousteci zaznam svazku se souborovym
                             systemem FAT32...
                      00365         ; tak ted jdem vypocitat ty nejdulezitejsi cisla pro praci s FATkou...
                      00366 
                      00367         INDF_BANK_1                                     ; aritmeto/logicke operace
0465   1383               M                         bcf STATUS,IRP    
0466   30A0           00368         movlw 0xA0                                      ; OPERAND_X
0467   0084           00369         movwf FSR
0468   0844           00370         movfw POCATEK_FAT1
0469   0080           00371         movwf INDF
046A   0A84           00372         incf FSR,F
046B   0845           00373         movfw POCATEK_FAT2
046C   0080           00374         movwf INDF
046D   0A84           00375         incf FSR,F
046E   0846           00376         movfw POCATEK_FAT3
046F   0080           00377         movwf INDF
0470   0A84           00378         incf FSR,F
0471   0847           00379         movfw POCATEK_FAT4
0472   0080           00380         movwf INDF
0473   0A84           00381         incf FSR,F
0474   0827           00382         movfw LBA1                                      ; OPERAND_Y
0475   0080           00383         movwf INDF
0476   0A84           00384         incf FSR,F
0477   0828           00385         movfw LBA2
0478   0080           00386         movwf INDF
0479   0A84           00387         incf FSR,F
047A   0829           00388         movfw LBA3
047B   0080           00389         movwf INDF
047C   0A84           00390         incf FSR,F
047D   082A           00391         movfw LBA4
047E   0080           00392         movwf INDF
047F   0A84           00393         incf FSR,F
0480   25B4           00394         call SOUCET                                     ; pricteme k zacatku oddilu pocet rezervovanych 
                            sektoru (obvykle 32) a mame z toho POCATEK_FAT
0481   0800           00395         movfw INDF
0482   00C4           00396         movwf POCATEK_FAT1
0483   0A84           00397         incf FSR,F
0484   0800           00398         movfw INDF
0485   00C5           00399         movwf POCATEK_FAT2
0486   0A84           00400         incf FSR,F
0487   0800           00401         movfw INDF
0488   00C6           00402         movwf POCATEK_FAT3
0489   0A84           00403         incf FSR,F
048A   0800           00404         movfw INDF
048B   00C7           00405         movwf POCATEK_FAT4
048C   0A84           00406         incf FSR,F
                      00407 
                      00408         ; v POCATEK_DAT ted mame hodnotu "velikost fat", tu vynasobime 2 a pricteme POCATEK_FAT. Tak zis
                            kame POCATEK_DAT
048D   30A0           00409         movlw 0xA0                                      ; OPERAND_X
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 45


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

048E   0084           00410         movwf FSR
048F   0840           00411         movfw POCATEK_DAT1
0490   0080           00412         movwf INDF
0491   0A84           00413         incf FSR,F
0492   0841           00414         movfw POCATEK_DAT2
0493   0080           00415         movwf INDF
0494   0A84           00416         incf FSR,F
0495   0842           00417         movfw POCATEK_DAT3
0496   0080           00418         movwf INDF
0497   0A84           00419         incf FSR,F
0498   0843           00420         movfw POCATEK_DAT4
0499   0080           00421         movwf INDF
049A   0A84           00422         incf FSR,F
049B   2622           00423         call POSUNDOLEVA_1                      ; X := X * 2 -> POCATEK_DAT := 2 * "velikost fat"
                      00424                                                                 ; ted jeste staci pricist POCATEK_FAT
049C   0844           00425         movfw POCATEK_FAT1
049D   0080           00426         movwf INDF
049E   0A84           00427         incf FSR,F
049F   0845           00428         movfw POCATEK_FAT2
04A0   0080           00429         movwf INDF
04A1   0A84           00430         incf FSR,F
04A2   0846           00431         movfw POCATEK_FAT3
04A3   0080           00432         movwf INDF
04A4   0A84           00433         incf FSR,F
04A5   0847           00434         movfw POCATEK_FAT4
04A6   0080           00435         movwf INDF
04A7   0A84           00436         incf FSR,F
04A8   25B4           00437         call SOUCET
                      00438 
                      00439         ;   tady je pro me jedna zcela nepochopitelna vlastnost FATky, a to to, ze prvni dva zaznamy (nu
                            lty a prvni)
                      00440         ;   ve FAT tabulce jsou obsazeny nejakyma srotama (identifikator FATky), coz by nebylo to nejhor
                            si, ale data na disku
                      00441         ;   zacinaji jiz na nultym clusteru. (POCATEK_DAT) Dochazi tedy k tomu, ze nulty cluster na disk
                            u je reprezentovan na druhe
                      00442         ;   pozici ve fatce a to cislem dve!!! Od udaje ve fatce bychom musime tedy vzdy odecist hodnotu
                             2
                      00443         ;   a ziskali bychom skutecnou polohu dat na disku.... (Je to pekne na vyliz!!!!!!!!)
                      00444         ;   Ja to tady resim tak, ze zacatek dat posunu o 2 clustery niz (POCATEK_DAT := POCATEK_DAT - 2
                            *VELIKOST_CLUSTERU),
                      00445         ;   aby udaje souhlasily a my nemuseli nic prepocitavat. 
                      00446         ;   Pak tu nastava jeste jeden problem, ROOT adresar byva adresovan jako by byl na clusteru 0, p
                            roto pokazdy kdyz je 
                      00447         ;   nekde cislo clusteru 0, tak skocime na prvni cluster root adresare. (Vetsinou 2. cluster)
                      00448         ;   O tomto jevu jsem nikde necetl, ale proste to tak je. Z toho vyplyva, ze zadny soubor nemuze
                             byt na slusteru 1...
                      00449         
                      00450         ; Tak ted mame v POCATEK_DAT = POCATEK_FAT + (velikostFat * 2)
                      00451         ; a ted jeste musime odecist 2 * velikost_clusteru
                      00452 
04A9   0D4C           00453         rlf CLUSTER_SIZE,W              ; W := CLUSTER_SIZE * 2
                      00454         BANK_1
04AA   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
04AB   1683               M                 bsf     STATUS,RP0    
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 46


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

04AC   00A4           00455         movwf OPERAND_Y1
04AD   01A5           00456         clrf OPERAND_Y2
04AE   01A6           00457         clrf OPERAND_Y3
04AF   01A7           00458         clrf OPERAND_Y4
04B0   0828           00459         movfw VYSLEDEK1
04B1   00A0           00460         movwf OPERAND_X1
04B2   0829           00461         movfw VYSLEDEK2
04B3   00A1           00462         movwf OPERAND_X2
04B4   082A           00463         movfw VYSLEDEK3
04B5   00A2           00464         movwf OPERAND_X3
04B6   082B           00465         movfw VYSLEDEK4
04B7   00A3           00466         movwf OPERAND_X4
                      00467         BANK_0
04B8   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
04B9   1283               M                 bcf     STATUS,RP0    
04BA   25E0           00468         call ROZDIL                             ; VYSLEDEK := POCATEK_FAT + (2 * velikostFat) - (2 * CLU
                            STER_SIZE)
04BB   0800           00469         movfw INDF
04BC   00C0           00470         movwf POCATEK_DAT1
04BD   0A84           00471         incf FSR,F
04BE   0800           00472         movfw INDF
04BF   00C1           00473         movwf POCATEK_DAT2
04C0   0A84           00474         incf FSR,F
04C1   0800           00475         movfw INDF
04C2   00C2           00476         movwf POCATEK_DAT3
04C3   0A84           00477         incf FSR,F
04C4   0800           00478         movfw INDF
04C5   00C3           00479         movwf POCATEK_DAT4
04C6   0A84           00480         incf FSR,F
                      00481         
                      00482         ; Tak ted uz to konecne mame, muzeme se pustit do prohlizeni adresaru a souboru...
                      00483 
04C7   162E           00484         bsf ATA_ATTRIBUTES,FAT32_LOAD   
04C8                  00485 NACTI_FAT32__KONEC
04C8   0008           00486         return  
                      00487 ;**************************************************************************
04C9                  00488 CLUSTER_TO_LBA
                      00489         ; vezme hodnoty v CLUSTER[1-4] a POZICE (sektor v clusteru) a do LBA 1-4 vypocita skutecnou pozi
                            ci na disku
                      00490         ; pro spravnou funkci musi byt POZICE < CLUSTER_SIZE (POZICE muze byt v rozsahu 0 .. CLUSTER_SIZ
                            E - 1)
                      00491         ; LBA := POCATEK_DAT + (CLUSTER * CLUSTER_SIZE) + POZICE
                      00492         INDF_BANK_1                             ; neprime adresovani do banku1
04C9   1383               M                         bcf STATUS,IRP    
04CA   30A0           00493         movlw 0xA0                                      ; OPERAND_X
04CB   0084           00494         movwf FSR
04CC   083C           00495         movfw CLUSTER1
04CD   0080           00496         movwf INDF
04CE   0A84           00497         incf FSR,F
04CF   083D           00498         movfw CLUSTER2
04D0   0080           00499         movwf INDF
04D1   0A84           00500         incf FSR,F
04D2   083E           00501         movfw CLUSTER3
04D3   0080           00502         movwf INDF
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 47


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

04D4   0A84           00503         incf FSR,F
04D5   083F           00504         movfw CLUSTER4
04D6   0080           00505         movwf INDF
04D7   0A84           00506         incf FSR,F
                      00507 
                      00508         ; Nejdriv se koukneme zda-li CLUSTER se nerovna 0, to bychom pak vratily 
                      00509         ; pozici na prvnim clusteru root adresare...
04D8   26C9           00510         call NULA                                               ; if (X =  0) then PRETECENI := 0 else P
                            RETECENI := 1
                      00511         BANK_1
04D9   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
04DA   1683               M                 bsf     STATUS,RP0    
04DB   182C           00512         btfsc PRETECENI,0
04DC   2CED           00513         goto CLUSTER_TO_LBA_NO_ROOT
                      00514         BANK_0
04DD   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
04DE   1283               M                 bcf     STATUS,RP0    
04DF   30A0           00515         movlw 0xA0                                      ; OPERAND_X
04E0   0084           00516         movwf FSR
04E1   0848           00517         movfw ROOT_DIR_CL1
04E2   0080           00518         movwf INDF
04E3   0A84           00519         incf FSR,F
04E4   0849           00520         movfw ROOT_DIR_CL2
04E5   0080           00521         movwf INDF
04E6   0A84           00522         incf FSR,F
04E7   084A           00523         movfw ROOT_DIR_CL3
04E8   0080           00524         movwf INDF
04E9   0A84           00525         incf FSR,F
04EA   084B           00526         movfw ROOT_DIR_CL4
04EB   0080           00527         movwf INDF
04EC   0A84           00528         incf FSR,F
                      00529                 
04ED                  00530 CLUSTER_TO_LBA_NO_ROOT
                      00531         BANK_0
04ED   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
04EE   1283               M                 bcf     STATUS,RP0    
                      00532         ; CLUSTER_SIZE je vzdy exponentem 2 (1,2,4,8,16,32,64,128), proto tento jednoduchy zapis
04EF   18CC           00533         btfsc CLUSTER_SIZE,1            ; 2
04F0   2622           00534         call POSUNDOLEVA_1                      ; X := X * 2
04F1   194C           00535         btfsc CLUSTER_SIZE,2            ; 4
04F2   262A           00536         call POSUNDOLEVA_2                      ; X := X * 4
04F3   19CC           00537         btfsc CLUSTER_SIZE,3            ; 8
04F4   2633           00538         call POSUNDOLEVA_3                      ; X := X * 8
04F5   1A4C           00539         btfsc CLUSTER_SIZE,4            ; 16
04F6   263D           00540         call POSUNDOLEVA_4                      ; X := X * 4
04F7   1ACC           00541         btfsc CLUSTER_SIZE,5            ; 32
04F8   2648           00542         call POSUNDOLEVA_5                      ; X := X * 32
04F9   1B4C           00543         btfsc CLUSTER_SIZE,6            ; 64
04FA   2654           00544         call POSUNDOLEVA_6                      ; X := X * 64
04FB   1BCC           00545         btfsc CLUSTER_SIZE,7            ; 128
04FC   2661           00546         call POSUNDOLEVA_7                      ; X := X * 128
                      00547         
04FD   0840           00548         movfw POCATEK_DAT1
04FE   0080           00549         movwf INDF                                      ; OPERAND_Y
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 48


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

04FF   0A84           00550         incf FSR,F
0500   0841           00551         movfw POCATEK_DAT2
0501   0080           00552         movwf INDF
0502   0A84           00553         incf FSR,F
0503   0842           00554         movfw POCATEK_DAT3
0504   0080           00555         movwf INDF
0505   0A84           00556         incf FSR,F
0506   0843           00557         movfw POCATEK_DAT4
0507   0080           00558         movwf INDF
0508   0A84           00559         incf FSR,F
                      00560 
0509   25B4           00561         call SOUCET                                     ; VYSLEDEK := POCATEK_DAT + (CLUSTER * CLUSTER_S
                            IZE)
                      00562 
                      00563         ; zbyva tedy k vysledku pricist POZICE a dat nasledny vysledek do LBA    
050A   083B           00564         movfw POZICE
                      00565         BANK_1
050B   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
050C   1683               M                 bsf     STATUS,RP0    
050D   00A4           00566         movwf OPERAND_Y1
050E   01A5           00567         clrf OPERAND_Y2
050F   01A6           00568         clrf OPERAND_Y3
0510   01A7           00569         clrf OPERAND_Y4
0511   0828           00570         movfw VYSLEDEK1
0512   00A0           00571         movwf OPERAND_X1
0513   0829           00572         movfw VYSLEDEK2
0514   00A1           00573         movwf OPERAND_X2
0515   082A           00574         movfw VYSLEDEK3
0516   00A2           00575         movwf OPERAND_X3
0517   082B           00576         movfw VYSLEDEK4
0518   00A3           00577         movwf OPERAND_X4        
                      00578         BANK_0
0519   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
051A   1283               M                 bcf     STATUS,RP0    
051B   25B4           00579         call SOUCET
                      00580 
                      00581         INDF_BANK_1                             ; neprime adresovani do banku1
051C   1383               M                         bcf STATUS,IRP    
051D   30A8           00582         movlw 0xA8                                      ; VYSLEDEK
051E   0084           00583         movwf FSR
051F   0800           00584         movfw INDF
0520   00A7           00585         movwf LBA1
0521   0A84           00586         incf FSR,F
0522   0800           00587         movfw INDF
0523   00A8           00588         movwf LBA2
0524   0A84           00589         incf FSR,F
0525   0800           00590         movfw INDF
0526   00A9           00591         movwf LBA3
0527   0A84           00592         incf FSR,F
0528   0800           00593         movfw INDF
0529   00AA           00594         movwf LBA4
052A   0A84           00595         incf FSR,F
                      00596         
052B   0008           00597         return
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 49


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00598 ;**************************************************************************
052C                  00599 NEXT_CLUSTER
                      00600         ; V CLUSTER prijme cislo clusteru, podiva se do FATky na disku a v CLUSTER vrati 
                      00601         ; hodnotu clustru, ktery nasleduje v retezu clusteru.
                      00602         ; Pokud pozadovany cluster byl posledni v retezu vrati v reg. POZICE konstantu FFh
                      00603         ; Pokud soucasny cluster je prazdny (coz by se stat nemelo) vrati taky v POZICE FFh
                      00604         ; Jinak, pokud s vse povede, dame do POZICE 0
                      00605 
                      00606         ; ! PODPROGRAM NETESTUJE ZDA NEBYLO ZADANO VETSI CISLO NEZ JE POCET CLUSTERU !!!
                      00607         
052C   01BB           00608         clrf POZICE
                      00609         ; LBA := [(CLUSTER * 4) / 512 ] + POCATEK_FAT
                      00610         ; LBA := ( CLUSTER / 128 ) + POCATEK_FAT
                      00611         ; offset := CLUSTER mod 128 
                      00612         INDF_BANK_1                             ; neprime adresovani do banku1
052D   1383               M                         bcf STATUS,IRP    
052E   30A0           00613         movlw 0xA0                                      ; OPERAND_X
052F   0084           00614         movwf FSR
0530   083C           00615         movfw CLUSTER1
0531   0080           00616         movwf INDF
0532   0A84           00617         incf FSR,F
0533   083D           00618         movfw CLUSTER2
0534   0080           00619         movwf INDF
0535   0A84           00620         incf FSR,F
0536   083E           00621         movfw CLUSTER3
0537   0080           00622         movwf INDF
0538   0A84           00623         incf FSR,F
0539   083F           00624         movfw CLUSTER4
053A   0080           00625         movwf INDF
                      00626 
                      00627         ; Nejdriv se koukneme zda-li CLUSTER se nerovna 0, to pak musime jako cluster brat prvni cluster
                             ROOT adr.
053B   26C9           00628         call NULA                                               ; if (X =  0) then PRETECENI := 0 else P
                            RETECENI := 1
                      00629         BANK_1
053C   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
053D   1683               M                 bsf     STATUS,RP0    
053E   182C           00630         btfsc PRETECENI,0
053F   2D50           00631         goto NEXT_CLUSTER_NO_ROOT
                      00632         BANK_0
0540   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0541   1283               M                 bcf     STATUS,RP0    
0542   30A0           00633         movlw 0xA0                                      ; OPERAND_X
0543   0084           00634         movwf FSR
0544   0848           00635         movfw ROOT_DIR_CL1
0545   0080           00636         movwf INDF
0546   0A84           00637         incf FSR,F
0547   0849           00638         movfw ROOT_DIR_CL2
0548   0080           00639         movwf INDF
0549   0A84           00640         incf FSR,F
054A   084A           00641         movfw ROOT_DIR_CL3
054B   0080           00642         movwf INDF
054C   0A84           00643         incf FSR,F
054D   084B           00644         movfw ROOT_DIR_CL4
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 50


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

054E   0080           00645         movwf INDF
054F   0A84           00646         incf FSR,F
                      00647                 
0550                  00648 NEXT_CLUSTER_NO_ROOT
                      00649         BANK_0
0550   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0551   1283               M                 bcf     STATUS,RP0    
                      00650         
0552   26BA           00651         call POSUNDOPRAVA_7     ; X := X div 128  ; PRETECENI := X mod 128
0553   30AC           00652         movlw 0xAC                                      ; PRETECENI
0554   0084           00653         movwf FSR
0555   0800           00654         movfw INDF
0556   00B6           00655         movwf TEMP1
                      00656 
0557   30A4           00657         movlw 0xA4                                      ; OPERAND_Y
0558   0084           00658         movwf FSR
0559   0844           00659         movfw POCATEK_FAT1
055A   0080           00660         movwf INDF
055B   0A84           00661         incf FSR,F
055C   0845           00662         movfw POCATEK_FAT2
055D   0080           00663         movwf INDF
055E   0A84           00664         incf FSR,F
055F   0846           00665         movfw POCATEK_FAT3
0560   0080           00666         movwf INDF
0561   0A84           00667         incf FSR,F
0562   0847           00668         movfw POCATEK_FAT4
0563   0080           00669         movwf INDF
0564   0A84           00670         incf FSR,F
                      00671 
0565   25B4           00672         call SOUCET
                      00673         
0566   0800           00674         movfw INDF                                      ; FSR ukazuje na VYSLEDEK
0567   00A7           00675         movwf LBA1
0568   0A84           00676         incf FSR,F
0569   0800           00677         movfw INDF
056A   00A8           00678         movwf LBA2
056B   0A84           00679         incf FSR,F
056C   0800           00680         movfw INDF
056D   00A9           00681         movwf LBA3
056E   0A84           00682         incf FSR,F
056F   0800           00683         movfw INDF
0570   00AA           00684         movwf LBA4
0571   0A84           00685         incf FSR,F
                      00686         
0572   01A4           00687         clrf FEATURES
0573   3001           00688         movlw .1
0574   00A6           00689         movwf SECTOR_C
0575   22AC           00690         call READ_SECTOR
                      00691 
0576   1003           00692         bcf STATUS,C                            ; TEMP1 := CLUSTER mod 128 (TEMP1 je v intervalu 0..127)
0577   0D36           00693         rlf TEMP1,W                                     ; W := TEMP1 * 2
0578   00B6           00694         movwf TEMP1
0579   39FF           00695         andlw h'FF'
057A   1D03           00696         btfss STATUS,Z
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 51


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

057B   226F           00697         call PRESKOC                            ; pokud je zaznam o clusteru na nulte pozici v sektoru, 
                            nic preskakovat nebudem...
                      00698 
                      00699 
057C   30A0           00700         movlw 0xA0                                      ; OPERAND_X
057D   0084           00701         movwf FSR               
057E   2254           00702         call READ_DATA  
057F   0820           00703         movfw DATA_L
0580   0080           00704         movwf INDF
0581   00BC           00705         movwf CLUSTER1
0582   0A84           00706         incf FSR,F
0583   0821           00707         movfw DATA_H
0584   0080           00708         movwf INDF
0585   00BD           00709         movwf CLUSTER2
0586   0A84           00710         incf FSR,F      
0587   2254           00711         call READ_DATA  
0588   0820           00712         movfw DATA_L
0589   0080           00713         movwf INDF
058A   00BE           00714         movwf CLUSTER3
058B   0A84           00715         incf FSR,F
058C   0821           00716         movfw DATA_H
058D   0080           00717         movwf INDF
058E   00BF           00718         movwf CLUSTER4
058F   0A84           00719         incf FSR,F
                      00720 
                      00721         ; ted mame hodnotu clusteru ktery nam byl na pocatku predan v reg. CLUSTER, podivame se zda neby
                            l nasledkem 
                      00722         ; nejake chyby prazdny, nebo zda neni posledni v alokacnim retezu
0590   26C9           00723         call NULA                                               ; if (OPERAND_X =  0) then PRETECENI := 
                            0 else PRETECENI := 1
                      00724         BANK_1
0591   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0592   1683               M                 bsf     STATUS,RP0    
0593   182C           00725         btfsc PRETECENI,0
0594   2D9A           00726         goto NEXT_CLUSTER_NEPRAZDNY
                      00727         BANK_0
0595   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0596   1283               M                 bcf     STATUS,RP0    
0597   30FF           00728         movlw h'FF'
0598   00BB           00729         movwf POZICE
0599   2DB1           00730         goto NEXT_CLUSTER_KONEC                 ; Nevim sice jak by se toto mohlo stat, ale cluster byl 
                            prazdny, proto neni jiz co resit..
059A                  00731 NEXT_CLUSTER_NEPRAZDNY
                      00732         BANK_0
059A   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
059B   1283               M                 bcf     STATUS,RP0    
                      00733         ; Ted se podivame zda cluster nebyl posledni v alokacnim retezu -> cluster >= 0x0FFFFFF7
059C   30F7           00734         movlw 0xF7
059D   0080           00735         movwf INDF
059E   0A84           00736         incf FSR,F
059F   30FF           00737         movlw 0xFF
05A0   0080           00738         movwf INDF
05A1   0A84           00739         incf FSR,F
05A2   30FF           00740         movlw 0xFF
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 52


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

05A3   0080           00741         movwf INDF
05A4   0A84           00742         incf FSR,F
05A5   300F           00743         movlw 0x0F
05A6   0080           00744         movwf INDF
05A7   0A84           00745         incf FSR,F
                      00746         
05A8   25E0           00747         call ROZDIL                                             ; VYSLEDEK := X - Y 
                      00748                                                                         ; pri podteceni PRETECENI = 1 ( 
                            VYSLEDEK < 0 => PRETECENI = 1 )
                      00749         BANK_1
05A9   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
05AA   1683               M                 bsf     STATUS,RP0    
05AB   182C           00750         btfsc PRETECENI,0
05AC   2DB1           00751         goto NEXT_CLUSTER_KONEC
                      00752         BANK_0
05AD   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
05AE   1283               M                 bcf     STATUS,RP0    
05AF   30FF           00753         movlw h'FF'
05B0   00BB           00754         movwf POZICE
05B1                  00755 NEXT_CLUSTER_KONEC
                      00756         BANK_0
05B1   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
05B2   1283               M                 bcf     STATUS,RP0    
05B3   0008           00757         return
                      00758 ;**************************************************************************
                      00070         include "aritmetic.asm" ; podprogramy vykonavajici zakladni aritmetologicke operace
                      00001 ;**********************************************************
                      00002 ;**********************************************************
                      00003 ;**********************************************************
                      00004 ; Obsahuje podrogramy realizujici zakladni aritmeticke operace
                      00005 ; pouzivane v mp3 preprcavaci. Vsechny operace se provadi 
                      00006 ; s 32bitovymi cisly.
                      00007 ; 
                      00008 ; Pro praci aritmetickych procedur je rezervovana BANKA 1 !!!!!
                      00009 ;**********************************************************
                      00010 ;**********************************************************
                      00011 ;**********************************************************
05B4                  00012 SOUCET
                      00013 ; provede soucet hodnoty v registrech OPERAND_X[1..4] 
                      00014 ; s hodnotou v OPERAND_Y[1..4] a umisti do VYSLEDEK[1..4] 
                      00015 ; pokud dojde k preteceni, nastavi se PRETECENI do 1
                      00016 ; (byty s indexem 1 maji nejnizsi vahu)
                      00017         BANK_1
05B4   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
05B5   1683               M                 bsf     STATUS,RP0    
05B6   01AC           00018         clrf PRETECENI
                      00019 
05B7   0820           00020         movfw OPERAND_X1
05B8   0724           00021         addwf OPERAND_Y1,W
05B9   00A8           00022         movwf VYSLEDEK1
05BA   1803           00023         btfsc STATUS,C
05BB   14AC           00024                 bsf PRETECENI,1
                      00025 
05BC   0821           00026         movfw OPERAND_X2
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 53


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

05BD   0725           00027         addwf OPERAND_Y2,W
05BE   00A9           00028         movwf VYSLEDEK2
05BF   3001           00029         movlw .1
05C0   1803           00030         btfsc STATUS,C
05C1   142C           00031                 bsf PRETECENI,0
05C2   18AC           00032         btfsc PRETECENI,1
05C3   07A9           00033                 addwf VYSLEDEK2,F
05C4   1803           00034         btfsc STATUS,C
05C5   142C           00035                 bsf PRETECENI,0
05C6   10AC           00036         bcf PRETECENI,1
                      00037 
05C7   0822           00038         movfw OPERAND_X3
05C8   0726           00039         addwf OPERAND_Y3,W
05C9   00AA           00040         movwf VYSLEDEK3
05CA   3001           00041         movlw .1
05CB   1803           00042         btfsc STATUS,C
05CC   14AC           00043                 bsf PRETECENI,1
05CD   182C           00044         btfsc PRETECENI,0
05CE   07AA           00045                 addwf VYSLEDEK3,F
05CF   1803           00046         btfsc STATUS,C
05D0   14AC           00047                 bsf PRETECENI,1
05D1   102C           00048         bcf PRETECENI,0
                      00049 
05D2   0823           00050         movfw OPERAND_X4
05D3   0727           00051         addwf OPERAND_Y4,W
05D4   00AB           00052         movwf VYSLEDEK4
05D5   3001           00053         movlw .1
05D6   1803           00054         btfsc STATUS,C
05D7   142C           00055                 bsf PRETECENI,0
05D8   18AC           00056         btfsc PRETECENI,1
05D9   07AB           00057                 addwf VYSLEDEK4,F
05DA   1803           00058         btfsc STATUS,C
05DB   142C           00059                 bsf PRETECENI,0
05DC   10AC           00060         bcf PRETECENI,1 
                      00061 
                      00062         BANK_0
05DD   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
05DE   1283               M                 bcf     STATUS,RP0    
05DF   0008           00063         return
                      00064 ;**********************************************************
                      00065 ;**********************************************************
05E0                  00066 ROZDIL  ; VYSLEDEK := X - Y
                      00067                 ; pri podteceni PRETECENI = 1 ( VYSLEDEK < 0 => PRETECENI = 1 )
                      00068         BANK_1
05E0   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
05E1   1683               M                 bsf     STATUS,RP0    
05E2   01AC           00069         clrf PRETECENI
                      00070 
05E3   0824           00071         movfw OPERAND_Y1
05E4   0220           00072         subwf OPERAND_X1,W      ; W = X - Y     
05E5   00A8           00073         movwf VYSLEDEK1
05E6   1C03           00074         btfss STATUS,C
05E7   14AC           00075                 bsf PRETECENI,1
                      00076         
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 54


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

05E8   0825           00077         movfw OPERAND_Y2
05E9   0221           00078         subwf OPERAND_X2,W      ; W = X - Y     
05EA   00A9           00079         movwf VYSLEDEK2
05EB   3001           00080         movlw .1
05EC   1C03           00081         btfss STATUS,C
05ED   142C           00082                 bsf PRETECENI,0
05EE   18AC           00083         btfsc PRETECENI,1
05EF   02A9           00084                 subwf VYSLEDEK2,F
05F0   1C03           00085         btfss STATUS,C
05F1   142C           00086                 bsf PRETECENI,0
05F2   10AC           00087         bcf PRETECENI,1 
                      00088         
05F3   0826           00089         movfw OPERAND_Y3
05F4   0222           00090         subwf OPERAND_X3,W      ; W = X - Y     
05F5   00AA           00091         movwf VYSLEDEK3
05F6   3001           00092         movlw .1
05F7   1C03           00093         btfss STATUS,C
05F8   14AC           00094                 bsf PRETECENI,1
05F9   182C           00095         btfsc PRETECENI,0
05FA   02AA           00096                 subwf VYSLEDEK3,F
05FB   1C03           00097         btfss STATUS,C
05FC   14AC           00098                 bsf PRETECENI,1
05FD   102C           00099         bcf PRETECENI,0
                      00100         
05FE   0827           00101         movfw OPERAND_Y4
05FF   0223           00102         subwf OPERAND_X4,W      ; W = X - Y     
0600   00AB           00103         movwf VYSLEDEK4
0601   3001           00104         movlw .1
0602   1C03           00105         btfss STATUS,C
0603   142C           00106                 bsf PRETECENI,0
0604   18AC           00107         btfsc PRETECENI,1
0605   02AB           00108                 subwf VYSLEDEK4,F
0606   1C03           00109         btfss STATUS,C
0607   142C           00110                 bsf PRETECENI,0
0608   10AC           00111         bcf PRETECENI,1 
                      00112         
                      00113         BANK_0
0609   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
060A   1283               M                 bcf     STATUS,RP0    
060B   0008           00114         return
                      00115 ;**********************************************************
060C                  00116 DEKREMENTUJ     ; X := X - 1
                      00117         BANK_1
060C   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
060D   1683               M                 bsf     STATUS,RP0    
060E   3001           00118         movlw .1
                      00119 
060F   02A0           00120         subwf OPERAND_X1,f
0610   1803           00121         btfsc STATUS,C
0611   2E19           00122         goto DEKREMENTUJ_KONEC
                      00123         
0612   02A1           00124         subwf OPERAND_X2,f
0613   1803           00125         btfsc STATUS,C
0614   2E19           00126         goto DEKREMENTUJ_KONEC
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 55


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00127 
0615   02A2           00128         subwf OPERAND_X3,f
0616   1803           00129         btfsc STATUS,C
0617   2E19           00130         goto DEKREMENTUJ_KONEC
                      00131 
0618   02A3           00132         subwf OPERAND_X4,f
0619                  00133 DEKREMENTUJ_KONEC
                      00134         BANK_0
0619   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
061A   1283               M                 bcf     STATUS,RP0    
061B   0008           00135         return
                      00136 ;**********************************************************
061C                  00137 POSUNDOLEVA     ; X := (X * 2) mod 0xFFFFFFFF , PRETECENI := (X * 2) div 0xFFFFFFFF
                      00138                         ; tento podprogram nepouzivat, primo v hlavnim programu
                      00139                         ; musi se nastavit BANK_1 a vymazat PRETECENI!!!
                      00140                         ; (je pouze pro pouziti v nasobicich podprogramech)
                      00141                         ; pouzivat jen POSUNDOLEVA_1, 2, 3, 4 
061C   0DA0           00142         rlf OPERAND_X1,F
061D   0DA1           00143         rlf OPERAND_X2,F
061E   0DA2           00144         rlf OPERAND_X3,F
061F   0DA3           00145         rlf OPERAND_X4,F
0620   0DAC           00146         rlf PRETECENI,F 
0621   0008           00147         return
                      00148 ;**********************************************************
0622                  00149 POSUNDOLEVA_1   ; X := X * 2
                      00150                                 ; X > 0xFFFF FFFF => PRETECENI obsahuje bity navic
                      00151         BANK_1
0622   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0623   1683               M                 bsf     STATUS,RP0    
0624   01AC           00152         clrf PRETECENI
0625   1003           00153         bcf STATUS,C
                      00154         
0626   261C           00155         call POSUNDOLEVA
                      00156 
                      00157         BANK_0
0627   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0628   1283               M                 bcf     STATUS,RP0    
0629   0008           00158         return
                      00159 ;**********************************************************
062A                  00160 POSUNDOLEVA_2   ; X := X * 4
                      00161                                 ; X > 0xFFFF FFFF => PRETECENI obsahuje bity navic
                      00162         BANK_1
062A   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
062B   1683               M                 bsf     STATUS,RP0    
062C   01AC           00163         clrf PRETECENI
062D   1003           00164         bcf STATUS,C
                      00165         
062E   261C           00166         call POSUNDOLEVA
062F   261C           00167         call POSUNDOLEVA
                      00168 
                      00169         BANK_0
0630   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0631   1283               M                 bcf     STATUS,RP0    
0632   0008           00170         return
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 56


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00171 ;**********************************************************
0633                  00172 POSUNDOLEVA_3   ; X := X * 8
                      00173                                 ; X > 0xFFFF FFFF => PRETECENI obsahuje bity navic
                      00174         BANK_1
0633   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0634   1683               M                 bsf     STATUS,RP0    
0635   01AC           00175         clrf PRETECENI
0636   1003           00176         bcf STATUS,C
                      00177         
0637   261C           00178         call POSUNDOLEVA
0638   261C           00179         call POSUNDOLEVA
0639   261C           00180         call POSUNDOLEVA
                      00181 
                      00182         BANK_0
063A   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
063B   1283               M                 bcf     STATUS,RP0    
063C   0008           00183         return
                      00184 ;**********************************************************
063D                  00185 POSUNDOLEVA_4   ; X := X * 16
                      00186                                 ; X > 0xFFFF FFFF => PRETECENI obsahuje bity navic
                      00187         BANK_1
063D   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
063E   1683               M                 bsf     STATUS,RP0    
063F   01AC           00188         clrf PRETECENI
0640   1003           00189         bcf STATUS,C
                      00190         
0641   261C           00191         call POSUNDOLEVA
0642   261C           00192         call POSUNDOLEVA
0643   261C           00193         call POSUNDOLEVA
0644   261C           00194         call POSUNDOLEVA
                      00195 
                      00196         BANK_0
0645   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0646   1283               M                 bcf     STATUS,RP0    
0647   0008           00197         return
                      00198 ;**********************************************************
0648                  00199 POSUNDOLEVA_5   ; X := X * 32
                      00200                                 ; X > 0xFFFF FFFF => PRETECENI obsahuje bity navic
                      00201         BANK_1
0648   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0649   1683               M                 bsf     STATUS,RP0    
064A   01AC           00202         clrf PRETECENI
064B   1003           00203         bcf STATUS,C
                      00204         
064C   261C           00205         call POSUNDOLEVA
064D   261C           00206         call POSUNDOLEVA
064E   261C           00207         call POSUNDOLEVA
064F   261C           00208         call POSUNDOLEVA
0650   261C           00209         call POSUNDOLEVA
                      00210 
                      00211         BANK_0
0651   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0652   1283               M                 bcf     STATUS,RP0    
0653   0008           00212         return
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 57


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00213 ;**********************************************************
0654                  00214 POSUNDOLEVA_6   ; X := X * 64
                      00215                                 ; X > 0xFFFF FFFF => PRETECENI obsahuje bity navic
                      00216         BANK_1
0654   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0655   1683               M                 bsf     STATUS,RP0    
0656   01AC           00217         clrf PRETECENI
0657   1003           00218         bcf STATUS,C
                      00219         
0658   261C           00220         call POSUNDOLEVA
0659   261C           00221         call POSUNDOLEVA
065A   261C           00222         call POSUNDOLEVA
065B   261C           00223         call POSUNDOLEVA
065C   261C           00224         call POSUNDOLEVA
065D   261C           00225         call POSUNDOLEVA
                      00226 
                      00227         BANK_0
065E   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
065F   1283               M                 bcf     STATUS,RP0    
0660   0008           00228         return
                      00229 ;**********************************************************
0661                  00230 POSUNDOLEVA_7   ; X := X * 128
                      00231                                 ; X > 0xFFFF FFFF => PRETECENI obsahuje bity navic
                      00232         BANK_1
0661   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0662   1683               M                 bsf     STATUS,RP0    
0663   01AC           00233         clrf PRETECENI
0664   1003           00234         bcf STATUS,C
                      00235         
0665   261C           00236         call POSUNDOLEVA
0666   261C           00237         call POSUNDOLEVA
0667   261C           00238         call POSUNDOLEVA
0668   261C           00239         call POSUNDOLEVA
0669   261C           00240         call POSUNDOLEVA
066A   261C           00241         call POSUNDOLEVA
066B   261C           00242         call POSUNDOLEVA
                      00243 
                      00244         BANK_0
066C   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
066D   1283               M                 bcf     STATUS,RP0    
066E   0008           00245         return
                      00246 ;**********************************************************
066F                  00247 POSUNDOPRAVA    ; X := X div 2 , PRETECENI := X mod 2
                      00248                         ; tento podprogram nepouzivat, primo v hlavnim programu
                      00249                         ; musi se nastavit BANK_1 a vymazat PRETECENI!!!
                      00250                         ; (je pouze pro pouziti v nasobicich podprogramech)
                      00251                         ; pouzivat jen POSUNDOPRAVA_1, 2, 3, 4 
066F   1003           00252         bcf STATUS,C
0670   0CA3           00253         rrf OPERAND_X4,F
0671   0CA2           00254         rrf OPERAND_X3,F
0672   0CA1           00255         rrf OPERAND_X2,F
0673   0CA0           00256         rrf OPERAND_X1,F
0674   0008           00257         return
                      00258 ;**********************************************************
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 58


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0675                  00259 POSUNDOPRAVA_1  ; X := X div 2
                      00260                                 ; PRETECENI := X mod 2
                      00261         BANK_1
0675   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0676   1683               M                 bsf     STATUS,RP0    
0677   0820           00262         movfw OPERAND_X1
0678   3901           00263         andlw b'00000001'
0679   00AC           00264         movwf PRETECENI         ; PRETECENI := X mod 2
                      00265         
067A   266F           00266         call POSUNDOPRAVA
                      00267 
                      00268         BANK_0
067B   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
067C   1283               M                 bcf     STATUS,RP0    
067D   0008           00269         return
                      00270 ;**********************************************************
067E                  00271 POSUNDOPRAVA_2  ; X := X div 4
                      00272                                 ; PRETECENI := X mod 4
                      00273         BANK_1
067E   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
067F   1683               M                 bsf     STATUS,RP0    
0680   0820           00274         movfw OPERAND_X1
0681   3903           00275         andlw b'00000011'
0682   00AC           00276         movwf PRETECENI         ; PRETECENI := X mod 4
                      00277         
0683   266F           00278         call POSUNDOPRAVA
0684   266F           00279         call POSUNDOPRAVA
                      00280 
                      00281         BANK_0
0685   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0686   1283               M                 bcf     STATUS,RP0    
0687   0008           00282         return
                      00283 ;**********************************************************
0688                  00284 POSUNDOPRAVA_3  ; X := X div 8
                      00285                                 ; PRETECENI := X mod 8
                      00286         BANK_1
0688   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0689   1683               M                 bsf     STATUS,RP0    
068A   0820           00287         movfw OPERAND_X1
068B   3907           00288         andlw b'00000111'
068C   00AC           00289         movwf PRETECENI         ; PRETECENI := X mod 8
                      00290         
068D   266F           00291         call POSUNDOPRAVA
068E   266F           00292         call POSUNDOPRAVA
068F   266F           00293         call POSUNDOPRAVA
                      00294 
                      00295         BANK_0
0690   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0691   1283               M                 bcf     STATUS,RP0    
0692   0008           00296         return
                      00297 ;**********************************************************
0693                  00298 POSUNDOPRAVA_4  ; X := X div 16
                      00299                                 ; PRETECENI := X mod 16
                      00300         BANK_1
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 59


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0693   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0694   1683               M                 bsf     STATUS,RP0    
0695   0820           00301         movfw OPERAND_X1
0696   390F           00302         andlw b'00001111'
0697   00AC           00303         movwf PRETECENI         ; PRETECENI := X mod 16
                      00304         
0698   266F           00305         call POSUNDOPRAVA
0699   266F           00306         call POSUNDOPRAVA
069A   266F           00307         call POSUNDOPRAVA
069B   266F           00308         call POSUNDOPRAVA
                      00309 
                      00310         BANK_0
069C   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
069D   1283               M                 bcf     STATUS,RP0    
069E   0008           00311         return
                      00312 ;**********************************************************
069F                  00313 POSUNDOPRAVA_5  ; X := X div 32
                      00314                                 ; PRETECENI := X mod 32
                      00315         BANK_1
069F   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
06A0   1683               M                 bsf     STATUS,RP0    
06A1   0820           00316         movfw OPERAND_X1
06A2   391F           00317         andlw b'00011111'
06A3   00AC           00318         movwf PRETECENI         ; PRETECENI := X mod 32
                      00319         
06A4   266F           00320         call POSUNDOPRAVA
06A5   266F           00321         call POSUNDOPRAVA
06A6   266F           00322         call POSUNDOPRAVA
06A7   266F           00323         call POSUNDOPRAVA
06A8   266F           00324         call POSUNDOPRAVA
                      00325 
                      00326         BANK_0
06A9   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
06AA   1283               M                 bcf     STATUS,RP0    
06AB   0008           00327         return
                      00328 ;**********************************************************
06AC                  00329 POSUNDOPRAVA_6  ; X := X div 64
                      00330                                 ; PRETECENI := X mod 64
                      00331         BANK_1
06AC   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
06AD   1683               M                 bsf     STATUS,RP0    
06AE   0820           00332         movfw OPERAND_X1
06AF   393F           00333         andlw b'00111111'
06B0   00AC           00334         movwf PRETECENI         ; PRETECENI := X mod 64
                      00335         
06B1   266F           00336         call POSUNDOPRAVA
06B2   266F           00337         call POSUNDOPRAVA
06B3   266F           00338         call POSUNDOPRAVA
06B4   266F           00339         call POSUNDOPRAVA
06B5   266F           00340         call POSUNDOPRAVA
06B6   266F           00341         call POSUNDOPRAVA
                      00342 
                      00343         BANK_0
06B7   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 60


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

06B8   1283               M                 bcf     STATUS,RP0    
06B9   0008           00344         return
                      00345 ;**********************************************************
06BA                  00346 POSUNDOPRAVA_7  ; X := X div 128
                      00347                                 ; PRETECENI := X mod 128
                      00348         BANK_1
06BA   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
06BB   1683               M                 bsf     STATUS,RP0    
06BC   0820           00349         movfw OPERAND_X1
06BD   397F           00350         andlw b'01111111'
06BE   00AC           00351         movwf PRETECENI         ; PRETECENI := X mod 128
                      00352         
06BF   266F           00353         call POSUNDOPRAVA
06C0   266F           00354         call POSUNDOPRAVA
06C1   266F           00355         call POSUNDOPRAVA
06C2   266F           00356         call POSUNDOPRAVA
06C3   266F           00357         call POSUNDOPRAVA
06C4   266F           00358         call POSUNDOPRAVA
06C5   266F           00359         call POSUNDOPRAVA
                      00360 
                      00361         BANK_0
06C6   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
06C7   1283               M                 bcf     STATUS,RP0    
06C8   0008           00362         return
                      00363 ;**********************************************************
06C9                  00364 NULA    ; if (X =  0) then PRETECENI := 0
                      00365                 ; if (X <> 0) then PRETECENI := 1
                      00366                 ; obsah X zustane nezmenen
                      00367         BANK_1
06C9   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
06CA   1683               M                 bsf     STATUS,RP0    
06CB   01AC           00368         clrf PRETECENI
06CC   30FF           00369         movlw h'FF'     
                      00370 
06CD   05A0           00371         andwf OPERAND_X1,F
06CE   1D03           00372         btfss STATUS,Z
06CF   142C           00373                 bsf PRETECENI,0
06D0   05A1           00374         andwf OPERAND_X2,F
06D1   1D03           00375         btfss STATUS,Z
06D2   142C           00376                 bsf PRETECENI,0
06D3   05A2           00377         andwf OPERAND_X3,F
06D4   1D03           00378         btfss STATUS,Z
06D5   142C           00379                 bsf PRETECENI,0
06D6   05A3           00380         andwf OPERAND_X4,F
06D7   1D03           00381         btfss STATUS,Z
06D8   142C           00382                 bsf PRETECENI,0         
                      00383 
                      00384         BANK_0
06D9   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
06DA   1283               M                 bcf     STATUS,RP0    
06DB   0008           00385         return
                      00386 ;**********************************************************
                      00071  
0800                  00072  org 0x0800                                     ; PAGE 1
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 61


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00073 ;#IF VS1001==1
                      00074         include "vs1001.asm"    ; podprogramy na ovladani mp3 decoderu
                      00001 ;**********************************************************
                      00002 ;**********************************************************
                      00003 ;**********************************************************
                      00004 ; OBSLUZNE PODPROGRAMY PRO MP3 DECODER vs1001g
                      00005 ;**********************************************************
                      00006 ;**********************************************************
                      00007 ;**********************************************************
                      00008 
                      00009 ; MP3_PORT              
                      00010 ; MP3_PORT_TRIS 
                      00011 
                      00012 ; BITY MP3_PORT
                      00013 ; #define MP3_SO                MP3_PORT,0      ; serial output - tady dostavame z dekoderu data
                      00014 ; #define MP3_SI                MP3_PORT,1      ; serial input  - pokud MP3_CS=1, tak posilame mp3 data,
                             pokud =0, tak posilame prikaz
                      00015 ; #define MP3_SCLK              MP3_PORT,2      ; clock - nabezna hrana urcuje platnost dat pri seriovem
                             prenosu
                      00016 ; #define MP3_CS                MP3_PORT,3      ; cable select  - pokud MP3_CS=1, tak po SI posilame mp3
                             data, pokud =0, tak posilame prikaz
                      00017 ; #define MP3_DREQ              MP3_PORT,4      ; data request  - pokud =1, tak dekoder pozaduje dalsi m
                            p3 data (vic jak 32B)
                      00018 ; #define MP3_BSYNC             MP3_PORT,5      ; pro synchronizaci - ma byt nastaven pri prvnim prenase
                            nem bitu kazdeho bytu
                      00019 
                      00020 ;**********************************************************
                      00021 ; co nejrychleji vodesle hodnotu ve W smerem k dekoderu (obsluhuje signaly DSYNC, SI, SCLK)
0800                  00022 VS_WR_BYTE
                      00023         ; k praci pouziva TEMPW
0800   00B5           00024         movwf TEMPW             ; dato co mame odeslat si hodime do tempu...
                      00025 
0801   1685           00026         bsf MP3_BSYNC   ; bude nasledovat prvni bit bytu, proto nastavime BSYNC
                      00027 
                      00028         ; 7. bit bytu
0802   1105           00029         bcf MP3_SCLK    ; shodime SCLK
0803   1085           00030         bcf MP3_SI              ; nevime zda bit bude 0 nebo 1, SI nulujeme
0804   0DB5           00031         rlf TEMPW,f             ; odesilame od nejvyssiho bitu k nejnizsimu
0805   1803           00032         btfsc STATUS,C
0806   1485           00033         bsf MP3_SI
0807   1505           00034         bsf MP3_SCLK
0808   1285           00035         bcf MP3_BSYNC
                      00036         
                      00037         ; 6. bit bytu
0809   1105           00038         bcf MP3_SCLK    ; shodime SCLK
080A   1085           00039         bcf MP3_SI              ; nevime zda bit bude 0 nebo 1, SI nulujeme
080B   0DB5           00040         rlf TEMPW,f             ; odesilame od nejvyssiho bitu k nejnizsimu
080C   1803           00041         btfsc STATUS,C
080D   1485           00042         bsf MP3_SI
080E   1505           00043         bsf MP3_SCLK
                      00044 
                      00045         ; 5. bit bytu
080F   1105           00046         bcf MP3_SCLK    ; shodime SCLK
0810   1085           00047         bcf MP3_SI              ; nevime zda bit bude 0 nebo 1, SI nulujeme
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 62


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0811   0DB5           00048         rlf TEMPW,f             ; odesilame od nejvyssiho bitu k nejnizsimu
0812   1803           00049         btfsc STATUS,C
0813   1485           00050         bsf MP3_SI
0814   1505           00051         bsf MP3_SCLK
                      00052 
                      00053         ; 4. bit bytu
0815   1105           00054         bcf MP3_SCLK    ; shodime SCLK
0816   1085           00055         bcf MP3_SI              ; nevime zda bit bude 0 nebo 1, SI nulujeme
0817   0DB5           00056         rlf TEMPW,f             ; odesilame od nejvyssiho bitu k nejnizsimu
0818   1803           00057         btfsc STATUS,C
0819   1485           00058         bsf MP3_SI
081A   1505           00059         bsf MP3_SCLK
                      00060 
                      00061         ; 3. bit bytu
081B   1105           00062         bcf MP3_SCLK    ; shodime SCLK
081C   1085           00063         bcf MP3_SI              ; nevime zda bit bude 0 nebo 1, SI nulujeme
081D   0DB5           00064         rlf TEMPW,f             ; odesilame od nejvyssiho bitu k nejnizsimu
081E   1803           00065         btfsc STATUS,C
081F   1485           00066         bsf MP3_SI
0820   1505           00067         bsf MP3_SCLK
                      00068 
                      00069         ; 2. bit bytu
0821   1105           00070         bcf MP3_SCLK    ; shodime SCLK
0822   1085           00071         bcf MP3_SI              ; nevime zda bit bude 0 nebo 1, SI nulujeme
0823   0DB5           00072         rlf TEMPW,f             ; odesilame od nejvyssiho bitu k nejnizsimu
0824   1803           00073         btfsc STATUS,C
0825   1485           00074         bsf MP3_SI
0826   1505           00075         bsf MP3_SCLK
                      00076 
                      00077         ; 1. bit bytu
0827   1105           00078         bcf MP3_SCLK    ; shodime SCLK
0828   1085           00079         bcf MP3_SI              ; nevime zda bit bude 0 nebo 1, SI nulujeme
0829   0DB5           00080         rlf TEMPW,f             ; odesilame od nejvyssiho bitu k nejnizsimu
082A   1803           00081         btfsc STATUS,C
082B   1485           00082         bsf MP3_SI
082C   1505           00083         bsf MP3_SCLK
                      00084 
                      00085         ; 0. bit bytu
082D   1105           00086         bcf MP3_SCLK    ; shodime SCLK
082E   1085           00087         bcf MP3_SI              ; nevime zda bit bude 0 nebo 1, SI nulujeme
082F   0DB5           00088         rlf TEMPW,f             ; odesilame od nejvyssiho bitu k nejnizsimu
0830   1803           00089         btfsc STATUS,C
0831   1485           00090         bsf MP3_SI
0832   1505           00091         bsf MP3_SCLK
                      00092 
0833   1105           00093         bcf MP3_SCLK
0834   0008           00094         return
                      00095 ;**********************************************************
                      00096 ; co nejrychleji prijme dato z vs1001 a umisti jej do W
0835                  00097 VS_RD_BYTE
                      00098         ; k praci pouziva TEMPW
                      00099 
0835   01B5           00100         clrf TEMPW              ; vymazeme, sem budeme strkat dato co nam prijde...
0836   1105           00101         bcf MP3_SCLK    ; shodime SCLK
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 63


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0837   1685           00102         bsf MP3_BSYNC   ; bude nasledovat prvni bit bytu, proto nastavime BSYNC
0838   1003           00103         bcf STATUS,C    ; nulujeme priznak CARRY, staci to delat jen na zacatku, protoze TEMW mame prazd
                            ny...
                      00104 
                      00105         ; 7. bit bytu
0839   1505           00106         bsf MP3_SCLK    ; nabezna hrana SCLK
083A   1805           00107         btfsc MP3_SO
083B   1403           00108         bsf STATUS,C    ; pokud je SO v jednice nastavime C...
083C   0DB5           00109         rlf TEMPW,f
083D   1105           00110         bcf MP3_SCLK    ; shodime SCLK
                      00111 
083E   1285           00112         bcf MP3_BSYNC
                      00113 
                      00114         ; 6. bit bytu
083F   1505           00115         bsf MP3_SCLK    ; nabezna hrana SCLK
0840   1805           00116         btfsc MP3_SO
0841   1403           00117         bsf STATUS,C    ; pokud je SO v jednice nastavime C...
0842   0DB5           00118         rlf TEMPW,f
0843   1105           00119         bcf MP3_SCLK    ; shodime SCLK  
                      00120 
                      00121         ; 5. bit bytu
0844   1505           00122         bsf MP3_SCLK    ; nabezna hrana SCLK
0845   1805           00123         btfsc MP3_SO
0846   1403           00124         bsf STATUS,C    ; pokud je SO v jednice nastavime C...
0847   0DB5           00125         rlf TEMPW,f
0848   1105           00126         bcf MP3_SCLK    ; shodime SCLK  
                      00127 
                      00128         ; 4. bit bytu
0849   1505           00129         bsf MP3_SCLK    ; nabezna hrana SCLK
084A   1805           00130         btfsc MP3_SO
084B   1403           00131         bsf STATUS,C    ; pokud je SO v jednice nastavime C...
084C   0DB5           00132         rlf TEMPW,f
084D   1105           00133         bcf MP3_SCLK    ; shodime SCLK  
                      00134 
                      00135         ; 3. bit bytu
084E   1505           00136         bsf MP3_SCLK    ; nabezna hrana SCLK
084F   1805           00137         btfsc MP3_SO
0850   1403           00138         bsf STATUS,C    ; pokud je SO v jednice nastavime C...
0851   0DB5           00139         rlf TEMPW,f
0852   1105           00140         bcf MP3_SCLK    ; shodime SCLK  
                      00141 
                      00142         ; 2. bit bytu
0853   1505           00143         bsf MP3_SCLK    ; nabezna hrana SCLK
0854   1805           00144         btfsc MP3_SO
0855   1403           00145         bsf STATUS,C    ; pokud je SO v jednice nastavime C...
0856   0DB5           00146         rlf TEMPW,f
0857   1105           00147         bcf MP3_SCLK    ; shodime SCLK  
                      00148 
                      00149         ; 1. bit bytu
0858   1505           00150         bsf MP3_SCLK    ; nabezna hrana SCLK
0859   1805           00151         btfsc MP3_SO
085A   1403           00152         bsf STATUS,C    ; pokud je SO v jednice nastavime C...
085B   0DB5           00153         rlf TEMPW,f
085C   1105           00154         bcf MP3_SCLK    ; shodime SCLK  
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 64


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00155 
                      00156         ; 0. bit bytu
085D   1505           00157         bsf MP3_SCLK    ; nabezna hrana SCLK
085E   1805           00158         btfsc MP3_SO
085F   1403           00159         bsf STATUS,C    ; pokud je SO v jednice nastavime C...
0860   0D35           00160         rlf TEMPW,W
0861   1105           00161         bcf MP3_SCLK    ; shodime SCLK  
                      00162 
                      00163         ; movfw TEMPW ; tuto operaci jiz nemusime provadet, protoze jsme posledni rotaci hodily do W (rl
                            f TEMPW,W)
0862   0008           00164         return
                      00165 ;**********************************************************
                      00166 ; do TEMP1 dame adresu registru 
                      00167 ; do TEMP2 dame dolni slabiku zapisovaneho slova
                      00168 ; do TEMP3 dame horni slabiku zapisovaneho slova
0863                  00169 VS_WR_REG       ; zapise 16bitove slovo (TEMP2,TEMP3) do registru mp3 dekoderu (TEMP1)
                      00170                         ; 16bit dato se odesila od nejvyssiho bitu (15,14...8,7...1,0)
                      00171                         ; kde TEMP3 = bity 15-8 ; TEMP2 = bity 7-0
                      00172 ; pri praci pouziva TEMP1, TEMP2, TEMP3, TEMPW
0863   1185           00173         bcf MP3_CS                      ; po SI posilame prikaz
0864   3002           00174         movlw b'00000010'       ; write
0865   2000           00175         call VS_WR_BYTE 
0866   0836           00176         movfw TEMP1                     ; adresa zapisovaneho registru
0867   2000           00177         call VS_WR_BYTE
0868   0838           00178         movfw TEMP3             ; horni slabika
0869   2000           00179         call VS_WR_BYTE
086A   0837           00180         movfw TEMP2             ; dolni slabika
086B   2000           00181         call VS_WR_BYTE
086C   1585           00182         bsf MP3_CS
086D   0008           00183         return
                      00184 ;**********************************************************
                      00185 ; do TEMP1 dame adresu registru 
                      00186 ; v TEMP2 nam vrati dolni slabiku precteneho slova
                      00187 ; v TEMP3 nam vrati horni slabiku precteneho slova
086E                  00188 VS_RD_REG       ; precte 16bitove slovo (TEMP3,TEMP2) z registru mp3 dekoderu (TEMP1)
                      00189                         ; kde TEMP3 = bity 15-8 ; TEMP2 = bity 7-0
                      00190 ; pri praci pouziva TEMP1, TEMP2, TEMP3, TEMPW
086E   1185           00191         bcf MP3_CS                      ; po SI posilame prikaz
086F   3003           00192         movlw b'00000011'       ; read
0870   2000           00193         call VS_WR_BYTE 
0871   0836           00194         movfw TEMP1                     ; adresa cteneho registru
0872   2000           00195         call VS_WR_BYTE
0873   2035           00196         call VS_RD_BYTE
0874   00B8           00197         movwf TEMP3             ; horni slabika
0875   2035           00198         call VS_RD_BYTE
0876   00B7           00199         movwf TEMP2             ; dolni slabika
0877   1585           00200         bsf MP3_CS
0878   0008           00201         return
                      00202 ;**********************************************************
0879                  00203 VS_SOFT_RESET   ; provede softwarovy reset dekoderu (pri zapnuti a pote po skonceni kazde mp3)
                      00204         PROG_PAGE_0
0879   118A               M                         bcf PCLATH,3
087A   120A               M                         bcf PCLATH,4
087B   21C4           00205         call DELAY_200ms
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 65


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00206         PROG_PAGE_1
087C   158A               M                         bsf PCLATH,3
087D   120A               M                         bcf PCLATH,4
                      00207 
087E   3000           00208         movlw VSADDR_MODE
087F   00B6           00209         movwf TEMP1
0880   154D           00210         bsf VSREG_MODE_L,2      ; soft reset=1
0881   084D           00211         movfw VSREG_MODE_L
0882   00B7           00212         movwf TEMP2
0883   3000           00213         movlw .0                        ; MODE_H
0884   00B8           00214         movwf TEMP3
0885   2063           00215         call VS_WR_REG
                      00216 
                      00217         PROG_PAGE_0
0886   118A               M                         bcf PCLATH,3
0887   120A               M                         bcf PCLATH,4
0888   21BB           00218         call DELAY_2ms
                      00219         PROG_PAGE_1
0889   158A               M                         bsf PCLATH,3
088A   120A               M                         bcf PCLATH,4
088B   2096           00220         call VS_SEND_1024_NULL  
                      00221 
088C   114D           00222         bcf VSREG_MODE_L,2      ; soft reset=0
088D   0008           00223         return
                      00224 ;**********************************************************
088E                  00225 VS_SEND_32_NULL
088E   20A5           00226         call WAIT_FOR_VSDREQ
088F   3020           00227         movlw .32
0890   00B7           00228         movwf TEMP2
                      00229         
0891   3000           00230         movlw .0
0892   2000           00231         call VS_WR_BYTE
0893   0BB7           00232         decfsz TEMP2,F
0894   2891           00233         goto $-3
0895   0008           00234         return
                      00235 ;**********************************************************
0896                  00236 VS_SEND_1024_NULL
0896   1585           00237         bsf MP3_CS                      ; po SI posilam data
0897   3020           00238         movlw .32
0898   00B6           00239         movwf TEMP1
                      00240 
0899   208E           00241         call VS_SEND_32_NULL
089A   0BB6           00242         decfsz TEMP1,F
089B   2899           00243         goto $-2
                      00244          
089C   0008           00245         return
                      00246 ;**********************************************************
089D                  00247 VS_SET_VOLUME
089D   300B           00248         movlw VSADDR_VOL
089E   00B6           00249         movwf TEMP1
                      00250 
089F   084F           00251         movfw VSREG_VOL_L
08A0   00B7           00252         movwf TEMP2
08A1   0850           00253         movfw VSREG_VOL_H
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 66


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

08A2   00B8           00254         movwf TEMP3
08A3   2063           00255         call VS_WR_REG
08A4   0008           00256         return          
                      00257 ;**********************************************************
08A5                  00258 WAIT_FOR_VSDREQ
08A5   1E05           00259         btfss MP3_DREQ
08A6   28A5           00260         goto WAIT_FOR_VSDREQ
08A7   0008           00261         return
                      00262 ;**********************************************************
08A8                  00263 VS_END_BEEP
08A8   20A5           00264         call WAIT_FOR_VSDREQ
                      00265 
08A9   3045           00266         movlw h'45'
08AA   2000           00267         call VS_WR_BYTE
08AB   3078           00268         movlw h'78'
08AC   2000           00269         call VS_WR_BYTE
08AD   3069           00270         movlw h'69'
08AE   2000           00271         call VS_WR_BYTE
08AF   3074           00272         movlw h'74'                     ; odeslanim tohoto kodu sinusovku ukoncime...
08B0   2000           00273         call VS_WR_BYTE
08B1   3000           00274         movlw .0
08B2   2000           00275         call VS_WR_BYTE
08B3   3000           00276         movlw .0
08B4   2000           00277         call VS_WR_BYTE
08B5   3000           00278         movlw .0
08B6   2000           00279         call VS_WR_BYTE
08B7   3000           00280         movlw .0
08B8   2000           00281         call VS_WR_BYTE
                      00282 
08B9   0008           00283         return
                      00284 ;**********************************************************
08BA                  00285 VS_BEEP
08BA   2079           00286         call VS_SOFT_RESET
08BB   20A5           00287         call WAIT_FOR_VSDREQ
                      00288 
08BC   1585           00289         bsf MP3_CS                      ; po SI posilam data
08BD   3053           00290         movlw h'53'
08BE   2000           00291         call VS_WR_BYTE
08BF   30EF           00292         movlw h'EF'
08C0   2000           00293         call VS_WR_BYTE
08C1   306E           00294         movlw h'6E'
08C2   2000           00295         call VS_WR_BYTE
08C3   303E           00296         movlw .62                       ; ctyr bytova testovaci sekvence. Tento posledni byte znamena, 
08C4   2000           00297         call VS_WR_BYTE         ; ze s pouzitim vzorkovaci frekvence 16kHz bude generovan ton 1kHz
08C5   3000           00298         movlw .0
08C6   2000           00299         call VS_WR_BYTE
08C7   3000           00300         movlw .0
08C8   2000           00301         call VS_WR_BYTE
08C9   3000           00302         movlw .0
08CA   2000           00303         call VS_WR_BYTE
08CB   3000           00304         movlw .0                        ; testovaci kod musi byt nasledovan 4 nulamy
08CC   2000           00305         call VS_WR_BYTE
                      00306 
08CD   0008           00307         return
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 67


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00308 ;**********************************************************
08CE                  00309 VS_INIT
08CE   01CD           00310         clrf VSREG_MODE_L
08CF   01CE           00311         clrf VSREG_STATUS_L
08D0   3040           00312         movlw h'40'
08D1   00CF           00313         movwf VSREG_VOL_L               ; VOL=0x40 => nenastavuji maximalni hlasitost, protoze kdyz jsou
                             pripojena sluchatka, tak by z toho jeden ohluchl...
08D2   00D0           00314         movwf VSREG_VOL_H
                      00315 
08D3   2079           00316         call VS_SOFT_RESET              ; resetujeme
                      00317         
08D4   3003           00318         movlw .3
08D5   00BA           00319         movwf TEMP5
08D6   209D           00320         call VS_SET_VOLUME              ; nastavime hlasitost
08D7   20BA           00321         call VS_BEEP
08D8   0BBA           00322         decfsz TEMP5,f
08D9   28D6           00323         goto $-3
                      00324         ; asi proto, ze nemam osetreny hardwarovy reset dekoderu, se mu obcas nechce nastartovat....
                      00325         ; proto jej 5x za sebou resetuji a zapinam pokusnou sinusovku...
                      00326         
08DA   20A8           00327         call VS_END_BEEP
08DB   2079           00328         call VS_SOFT_RESET              ; resetujeme
                      00329 
08DC   0008           00330         return
                      00331 ;**********************************************************
                      00075 ;#ENDIF
                      00076         include "commands.asm"  ; podprogramy na obsluhu prikazu (od ridiciho procesoru)
                      00001 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
                      00002 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
                      00003 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
                      00004 ; tady jsou procedury resici jednotlive prikazy
                      00005 ; Pokud je v zasobniku prikaz pro nejakou proceduru, musi tato procedura nastavit byt STAV_PRIKAZU do 1 
                            (i kdyz treba nema vsechny parametry)
                      00006 ; Pokud procedura najde svuj prikaz a jsou prijate vsechny parametry, musi odeslat nejakou odpoved po US
                            ARTu a smazat reg. PRIJATYCH_DAT!!!
                      00007 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
08DD                  00008 CEKEJ_PRIKAZ                                    ; ceka dokud nedostaneme nejaky prikaz
08DD   0873           00009         movfw PRIJATYCH_DAT
08DE   39FF           00010         andlw h'FF'
08DF   1903           00011         btfsc STATUS,Z                          ; koukneme se zda prisel nejaky prikaz...
08E0   28DD           00012         goto CEKEJ_PRIKAZ
08E1   0008           00013         return
                      00014 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
08E2                  00015 PRIKAZ_02h                                              ; 02h - vrat oddily se systemem FAT32
08E2   0878           00016         movfw 0x078                                     ; prvni byte zasobniku prikazu
08E3   3C02           00017         sublw h'02'                                     
08E4   1D03           00018         btfss STATUS,Z
08E5   0008           00019         return                                          ; nebyl prijat prikaz 02h
08E6   1475           00020         bsf STAV_PRIKAZU,0                      ; mame tu prikaz 02h, nastavime byt STAV_REGISTRU
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 68


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

08E7   0873           00021         movfw PRIJATYCH_DAT
08E8   3C01           00022         sublw .1                                        ; pro prikaz 02h museji prijit 2 byty (prikaz + 
                            1 parametr)
08E9   1803           00023         btfsc STATUS,C
08EA   0008           00024         return                                          ; jeste nemame vsechny parametry
                      00025         ; Prisel prikaz 02h s jednim parametrem (vrat oddily se systemem FAT32)
                      00026 
08EB   0879           00027         movfw 0x079                                     ; parametr prikazu 02h (cislo svazku, jehoz para
                            metry chceme vratit)
08EC   3903           00028         andlw b'00000011'                       ; parametr musi byt v rozsahu 0-3
08ED   00B6           00029         movwf TEMP1
08EE   1003           00030         bcf STATUS,C
08EF   0DB6           00031         rlf TEMP1,F
08F0   0DB6           00032         rlf TEMP1,F
08F1   0DB6           00033         rlf TEMP1,F
08F2   0D36           00034         rlf TEMP1,W                                     ; parametr vynasobime 16
08F3   3E10           00035         addlw 0x10                                      ; buffer 2 je v bance 2 na adrese 0x10
08F4   0084           00036         movwf FSR
                      00037         INDF_BANK_2
08F5   1783               M                         bsf STATUS,IRP    
08F6   3010           00038         movlw .16                                       ; budeme odesilat 16 bytu
08F7   00B6           00039         movwf TEMP1
08F8                  00040 PRIKAZ_02h__ODESILANI_ODDILU
08F8   0800           00041         movfw INDF
                      00042         PROG_PAGE_0
08F9   118A               M                         bcf PCLATH,3
08FA   120A               M                         bcf PCLATH,4
08FB   2165           00043         call WR_USART
                      00044         PROG_PAGE_1
08FC   158A               M                         bsf PCLATH,3
08FD   120A               M                         bcf PCLATH,4
08FE   0A84           00045         incf FSR,F
08FF   0BB6           00046         decfsz TEMP1,F
0900   28F8           00047         goto PRIKAZ_02h__ODESILANI_ODDILU
0901   01F3           00048         clrf PRIJATYCH_DAT
0902   0008           00049         return
                      00050 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
0903                  00051 PRIKAZ_03h                                              ; 03h – nastav oddil
0903   0878           00052         movfw 0x078                                     ; prvni byte zasobniku prikazu
0904   3C03           00053         sublw h'03'                                     
0905   1D03           00054         btfss STATUS,Z
0906   0008           00055         return                                          ; nebyl prijat prikaz 03h
0907   1475           00056         bsf STAV_PRIKAZU,0                      ; mame tu prikaz 03h, nastavime byt STAV_REGISTRU
0908   0873           00057         movfw PRIJATYCH_DAT
0909   3C04           00058         sublw .4                                        ; pro prikaz 03h museji prijit 5 byty (prikaz + 
                            4byty parametr)
090A   1803           00059         btfsc STATUS,C
090B   0008           00060         return                                          ; jeste nemame vsechny parametry
                      00061         ; Prisel prikaz 03h s 4bytovym parametrem (nacti oddily se systemem FAT32)
                      00062 
090C   0879           00063         movfw 0x079                                     ; parametrem prikazu 03h ma byt 4bytova adresa z
                            acatku svazku, ktery se ma nacist
090D   00A7           00064         movwf LBA1
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 69


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

090E   087A           00065         movfw 0x07A
090F   00A8           00066         movwf LBA2
0910   087B           00067         movfw 0x07B
0911   00A9           00068         movwf LBA3
0912   087C           00069         movfw 0x07C
0913   00AA           00070         movwf LBA4
                      00071         PROG_PAGE_0
0914   118A               M                         bcf PCLATH,3
0915   120A               M                         bcf PCLATH,4
0916   2405           00072         call NACTI_FAT32                        ; nacte parametry zvoleneho oddilu
                      00073         PROG_PAGE_1
0917   158A               M                         bsf PCLATH,3
0918   120A               M                         bcf PCLATH,4
                      00074 
0919   082E           00075         movfw ATA_ATTRIBUTES
                      00076         PROG_PAGE_0
091A   118A               M                         bcf PCLATH,3
091B   120A               M                         bcf PCLATH,4
091C   2165           00077         call WR_USART
                      00078         PROG_PAGE_1
091D   158A               M                         bsf PCLATH,3
091E   120A               M                         bcf PCLATH,4
091F   01F3           00079         clrf PRIJATYCH_DAT                      ; vyprazdnime zasobnik
0920   0008           00080         return
                      00081 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
0921                  00082 PRIKAZ_04h                                              ; 04h – vrat velikost clusteru
0921   0878           00083         movfw 0x078                                     ; prvni byte zasobniku prikazu
0922   3C04           00084         sublw h'04'                                     
0923   1D03           00085         btfss STATUS,Z
0924   0008           00086         return                                          ; nebyl prijat prikaz 04h
0925   1475           00087         bsf STAV_PRIKAZU,0                      ; mame tu prikaz 04h, nastavime byt STAV_REGISTRU
                      00088         ; pro prikaz 04h nejsou definovany zadne parametry, proto jiz nic jineho netestujeme
                      00089 
0926   084C           00090         movfw CLUSTER_SIZE
                      00091         PROG_PAGE_0
0927   118A               M                         bcf PCLATH,3
0928   120A               M                         bcf PCLATH,4
0929   2165           00092         call WR_USART
                      00093         PROG_PAGE_1
092A   158A               M                         bsf PCLATH,3
092B   120A               M                         bcf PCLATH,4
092C   01F3           00094         clrf PRIJATYCH_DAT                      ; vyprazdnime zasobnik
092D   0008           00095         return
                      00096 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
092E                  00097 PRIKAZ_05h                                              ; 05h – zjisti, zda je cluster prvni v adresari
092E   0878           00098         movfw 0x078                                     ; prvni byte zasobniku prikazu
092F   3C05           00099         sublw h'05'
0930   1D03           00100         btfss STATUS,Z
0931   0008           00101         return                                          ; nebyl prijat prikaz 05h
0932   1475           00102         bsf STAV_PRIKAZU,0                      ; mame tu prikaz 05h, nastavime byt STAV_REGISTRU
0933   0873           00103         movfw PRIJATYCH_DAT
0934   3C06           00104         sublw .6                                        ; pro prikaz 05h musi prijit 7 bytu (prikaz + 6b
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 70


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                            ytu parametr)
0935   1803           00105         btfsc STATUS,C
0936   0008           00106         return                                          ; jeste nemame vsechny parametry
                      00107         ; Prisel prikaz 05h s 6bytovym parametrem 
                      00108 
0937   0879           00109         movfw 0x079                                     ; nejnizsi cast clusteru adresare
0938   00BC           00110         movwf CLUSTER1
0939   087A           00111         movfw 0x07A
093A   00BD           00112         movwf CLUSTER2
093B   087B           00113         movfw 0x07B
093C   00BE           00114         movwf CLUSTER3
093D   087C           00115         movfw 0x07C
093E   00BF           00116         movwf CLUSTER4
093F   2331           00117         call PRVNI_CL_ADRESARE
                      00118 
0940   1C3B           00119         btfss POZICE,0
0941   2948           00120         goto PRIKAZ_05h_PAR1_OK
                      00121 
0942                  00122 PRIKAZ_05h_PAR1_NOT_OK
                      00123         INDF_BANK_2
0942   1783               M                         bsf STATUS,IRP    
0943   3010           00124         movlw 0x10                                      ; 1. byte bufferu 2
0944   0084           00125         movwf FSR
0945   3081           00126         movlw h'81'                                     ; jako prvni byte odpovedi dame 81h (Zadany clus
                            ter neobsahuje adresar)
0946   0080           00127         movwf INDF
0947   2956           00128         goto PRIKAZ_05h_KONEC
0948                  00129 PRIKAZ_05h_PAR1_OK
                      00130 
0948   087D           00131         movfw 0x07D
0949   00E0           00132         movwf ZAZNAM1
094A   087E           00133         movfw 0x07E
094B   00E1           00134         movwf ZAZNAM2
                      00135 
094C   236B           00136         call SKOC_NA_ZAZNAM
094D   1C3B           00137         btfss POZICE,0
094E   2955           00138         goto PRIKAZ_05h_PAR2_OK
                      00139 
094F                  00140 PRIKAZ_05h_PAR2_NOT_OK
                      00141         INDF_BANK_2
094F   1783               M                         bsf STATUS,IRP    
0950   3010           00142         movlw 0x10                                      ; 1. byte bufferu 2
0951   0084           00143         movwf FSR
0952   3080           00144         movlw h'80'                                     ; jako prvni byte odpovedi dame 80h (Zadany zazn
                            am mimo rozsah)
0953   0080           00145         movwf INDF
0954   2956           00146         goto PRIKAZ_05h_KONEC
0955                  00147 PRIKAZ_05h_PAR2_OK
                      00148 
0955   23E6           00149         call FILE_INFO
                      00150 
0956                  00151 PRIKAZ_05h_KONEC
                      00152         ; At uz bylo v zaznamu cokoli, odesleme 16 bytu z BUFFERU 2
0956   3010           00153         movlw .16
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 71


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0957   00B6           00154         movwf TEMP1
                      00155         PROG_PAGE_0
0958   118A               M                         bcf PCLATH,3
0959   120A               M                         bcf PCLATH,4
095A   219B           00156         call ODESLI_BUFFER2                     ; odesleme si zaznam o souboru  
                      00157         PROG_PAGE_1
095B   158A               M                         bsf PCLATH,3
095C   120A               M                         bcf PCLATH,4
                      00158 
095D   01F3           00159         clrf PRIJATYCH_DAT                      ; vyprazdnime zasobnik prikazu
095E   0008           00160         return
                      00161 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
095F                  00162 PRIKAZ_06h                                              ; 06h – vrat cislo dalsiho clusteru v alokacnim 
                            retezu
095F   0878           00163         movfw 0x078                                     ; prvni byte zasobniku prikazu
0960   3C06           00164         sublw h'06'                                     
0961   1D03           00165         btfss STATUS,Z
0962   0008           00166         return                                          ; nebyl prijat prikaz 06h
0963   1475           00167         bsf STAV_PRIKAZU,0                      ; mame tu prikaz 06h, nastavime byt STAV_REGISTRU
0964   0873           00168         movfw PRIJATYCH_DAT
0965   3C04           00169         sublw .4                                        ; pro prikaz 06h museji prijit 5 bytu (prikaz + 
                            4byty parametr)
0966   1803           00170         btfsc STATUS,C
0967   0008           00171         return                                          ; jeste nemame vsechny parametry
                      00172         ; Prisel prikaz 06h s 4bytovym parametrem 
                      00173 
0968   0879           00174         movfw 0x079                                     ; nejnizsi cast clusteru
0969   00BC           00175         movwf CLUSTER1
096A   087A           00176         movfw 0x07A
096B   00BD           00177         movwf CLUSTER2
096C   087B           00178         movfw 0x07B
096D   00BE           00179         movwf CLUSTER3
096E   087C           00180         movfw 0x07C
096F   00BF           00181         movwf CLUSTER4
                      00182         PROG_PAGE_0
0970   118A               M                         bcf PCLATH,3
0971   120A               M                         bcf PCLATH,4
0972   252C           00183         call NEXT_CLUSTER
0973   083B           00184         movfw POZICE                            ; pokud POZICE = 00h, je vse v poradku (vratime c. dalsi
                            ho clusteru v retezci). 
                      00185                                                                 ; Pokud POZICE = FFh byl predany cluster
                             posledni v retezu, nebo byl prazdny...
0974   2165           00186         call WR_USART
0975   083C           00187         movfw CLUSTER1
0976   2165           00188         call WR_USART
0977   083D           00189         movfw CLUSTER2
0978   2165           00190         call WR_USART
0979   083E           00191         movfw CLUSTER3
097A   2165           00192         call WR_USART
097B   083F           00193         movfw CLUSTER4
097C   2165           00194         call WR_USART
                      00195         PROG_PAGE_1
097D   158A               M                         bsf PCLATH,3
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 72


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

097E   120A               M                         bcf PCLATH,4
                      00196         
097F   01F3           00197         clrf PRIJATYCH_DAT                      ; vyprazdnime zasobnik prikazu
0980   0008           00198         return
                      00199 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
0981                  00200 PRIKAZ_07h                                              ; 07h – cti cluster
0981   0878           00201         movfw 0x078                                     ; prvni byte zasobniku prikazu
0982   3C07           00202         sublw h'07'                                     
0983   1D03           00203         btfss STATUS,Z
0984   0008           00204         return                                          ; nebyl prijat prikaz 07h
0985   1475           00205         bsf STAV_PRIKAZU,0                      ; mame tu prikaz 07h, nastavime byt STAV_REGISTRU
0986   0873           00206         movfw PRIJATYCH_DAT
0987   3C04           00207         sublw .4                                        ; pro prikaz 07h museji prijit 5 bytu (prikaz + 
                            4byty parametr)
0988   1803           00208         btfsc STATUS,C
0989   0008           00209         return                                          ; jeste nemame vsechny parametry
                      00210         ; Prisel prikaz 06h s 4bytovym parametrem 
                      00211 
098A   0879           00212         movfw 0x079                                     ; nejnizsi cast clusteru
098B   00BC           00213         movwf CLUSTER1
098C   087A           00214         movfw 0x07A
098D   00BD           00215         movwf CLUSTER2
098E   087B           00216         movfw 0x07B
098F   00BE           00217         movwf CLUSTER3
0990   087C           00218         movfw 0x07C
0991   00BF           00219         movwf CLUSTER4
0992   01BB           00220         clrf POZICE
                      00221         PROG_PAGE_0
0993   118A               M                         bcf PCLATH,3
0994   120A               M                         bcf PCLATH,4
0995   24C9           00222         call CLUSTER_TO_LBA                     ; zjistime si skutecnou polohu pozadovaneho clusteru na 
                            disku...
0996   084C           00223         movfw CLUSTER_SIZE
0997   00A6           00224         movwf SECTOR_C                          ; tentokrat cteme cely cluster a ne sector
0998   22AC           00225         call READ_SECTOR;S
                      00226         PROG_PAGE_1
0999   158A               M                         bsf PCLATH,3
099A   120A               M                         bcf PCLATH,4
                      00227 
099B   084C           00228         movfw CLUSTER_SIZE
099C   00B7           00229         movwf TEMP2                                     ; kolik sektoru budeme odesilat
                      00230 
099D                  00231 PRIKAZ_07h__ODESLI_SECTOR
099D   3000           00232         movlw .0                                        ; budeme odesilat cely sector (256slov = 512bytu
                            )
099E   00B6           00233         movwf TEMP1
                      00234         PROG_PAGE_0
099F   118A               M                         bcf PCLATH,3
09A0   120A               M                         bcf PCLATH,4
09A1   2178           00235         call ODESLI_DATA
                      00236         PROG_PAGE_1
09A2   158A               M                         bsf PCLATH,3
09A3   120A               M                         bcf PCLATH,4
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 73


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

09A4   0BB7           00237         decfsz TEMP2,F                          ; a to tolikrat, kolik ma cluster sektroru
09A5   299D           00238         goto PRIKAZ_07h__ODESLI_SECTOR
                      00239         
09A6   01F3           00240         clrf PRIJATYCH_DAT                      ; vyprazdnime zasobnik prikazu
09A7   0008           00241         return
                      00242 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
09A8                  00243 PRIKAZ_08h                                              ; 08h – zjisti velikost souboru
09A8   0878           00244         movfw 0x078                                     ; prvni byte zasobniku prikazu
09A9   3C08           00245         sublw h'08'
09AA   1D03           00246         btfss STATUS,Z
09AB   0008           00247         return                                          ; nebyl prijat prikaz 08h
09AC   1475           00248         bsf STAV_PRIKAZU,0                      ; mame tu prikaz 08h, nastavime byt STAV_REGISTRU
09AD   0873           00249         movfw PRIJATYCH_DAT
09AE   3C06           00250         sublw .6                                        ; pro prikaz 08h musi prijit 7 bytu (prikaz + 6b
                            ytu parametr)
09AF   1803           00251         btfsc STATUS,C
09B0   0008           00252         return                                          ; jeste nemame vsechny parametry
                      00253         ; Prisel prikaz 08h s 6bytovym parametrem 
                      00254 
09B1   0879           00255         movfw 0x079                                     ; nejnizsi cast clusteru adresare
09B2   00BC           00256         movwf CLUSTER1
09B3   087A           00257         movfw 0x07A
09B4   00BD           00258         movwf CLUSTER2
09B5   087B           00259         movfw 0x07B
09B6   00BE           00260         movwf CLUSTER3
09B7   087C           00261         movfw 0x07C
09B8   00BF           00262         movwf CLUSTER4
09B9   2331           00263         call PRVNI_CL_ADRESARE
                      00264 
09BA   1C3B           00265         btfss POZICE,0
09BB   29BF           00266         goto PRIKAZ_08h_PAR1_OK
                      00267 
09BC                  00268 PRIKAZ_08h_PAR1_NOT_OK
09BC   3081           00269         movlw h'81'                                     ; jako prvni byte odpovedi dame 81h (Zadany clus
                            ter neobsahuje adresar)
09BD   00B6           00270         movwf TEMP1
09BE   29CB           00271         goto PRIKAZ_08h_KONEC
09BF                  00272 PRIKAZ_08h_PAR1_OK
                      00273 
09BF   087D           00274         movfw 0x07D
09C0   00E0           00275         movwf ZAZNAM1
09C1   087E           00276         movfw 0x07E
09C2   00E1           00277         movwf ZAZNAM2
                      00278 
09C3   236B           00279         call SKOC_NA_ZAZNAM
09C4   1C3B           00280         btfss POZICE,0
09C5   29C9           00281         goto PRIKAZ_08h_PAR2_OK
                      00282 
09C6                  00283 PRIKAZ_08h_PAR2_NOT_OK
09C6   3080           00284         movlw h'80'                                     ; jako prvni byte odpovedi dame 80h (Zadany zazn
                            am mimo rozsah)
09C7   00B6           00285         movwf TEMP1
09C8   29CB           00286         goto PRIKAZ_08h_KONEC
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 74


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

09C9                  00287 PRIKAZ_08h_PAR2_OK
                      00288 
09C9   2461           00289         call FILE_SIZE
09CA   01B6           00290         clrf TEMP1
                      00291 
09CB                  00292 PRIKAZ_08h_KONEC
                      00293         ; At uz bylo v zaznamu cokoli, odesleme 4 byty z BUFFERU 2
09CB   0836           00294         movfw TEMP1
                      00295         PROG_PAGE_0
09CC   118A               M                         bcf PCLATH,3
09CD   120A               M                         bcf PCLATH,4
09CE   2165           00296         call WR_USART
09CF   3004           00297         movlw .4
09D0   00B6           00298         movwf TEMP1
09D1   219B           00299         call ODESLI_BUFFER2                     ; odesleme si zaznam o souboru  
                      00300         PROG_PAGE_1
09D2   158A               M                         bsf PCLATH,3
09D3   120A               M                         bcf PCLATH,4
                      00301 
09D4   01F3           00302         clrf PRIJATYCH_DAT                      ; vyprazdnime zasobnik prikazu
09D5   0008           00303         return
                      00304 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
09D6                  00305 PRIKAZ_09h                                              ; 09h – nastav hledání
09D6   0878           00306         movfw 0x078                                     ; prvni byte zasobniku prikazu
09D7   3C09           00307         sublw h'09'
09D8   1D03           00308         btfss STATUS,Z
09D9   0008           00309         return                                          ; nebyl prijat prikaz 09h
09DA   1475           00310         bsf STAV_PRIKAZU,0                      ; mame tu prikaz 09h, nastavime byt STAV_REGISTRU
09DB   0873           00311         movfw PRIJATYCH_DAT
09DC   3C07           00312         sublw .7                                        ; pro prikaz 09h musi prijit 8 bytu (prikaz + 7b
                            ytu parametr)
09DD   1803           00313         btfsc STATUS,C
09DE   0008           00314         return                                          ; jeste nemame vsechny parametry
                      00315         ; Prisel prikaz 09h s 5bytovym parametrem 
                      00316 
09DF   0879           00317         movfw 0x079                                     ; nejnizsi cast clusteru adresare
09E0   00BC           00318         movwf CLUSTER1
09E1   087A           00319         movfw 0x07A
09E2   00BD           00320         movwf CLUSTER2
09E3   087B           00321         movfw 0x07B
09E4   00BE           00322         movwf CLUSTER3
09E5   087C           00323         movfw 0x07C
09E6   00BF           00324         movwf CLUSTER4
09E7   2331           00325         call PRVNI_CL_ADRESARE
                      00326 
09E8   183B           00327         btfsc POZICE,0
09E9   29FA           00328         goto PRIKAZ_09h_SPATNY_PAR
                      00329 
09EA   0879           00330         movfw 0x079                                     ; nejnizsi cast clusteru adresare
09EB   00DA           00331         movwf HL_ADR_CL1
09EC   087A           00332         movfw 0x07A
09ED   00DB           00333         movwf HL_ADR_CL2
09EE   087B           00334         movfw 0x07B
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 75


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

09EF   00DC           00335         movwf HL_ADR_CL3
09F0   087C           00336         movfw 0x07C
09F1   00DD           00337         movwf HL_ADR_CL4
                      00338 
09F2   087D           00339         movfw 0x07D
09F3   00E0           00340         movwf ZAZNAM1
09F4   087E           00341         movfw 0x07E
09F5   00E1           00342         movwf ZAZNAM2
                      00343 
09F6   087F           00344         movfw 0x07F
09F7   00D9           00345         movwf HL_PARAMETRY
                      00346 
09F8   247E           00347         call HLEDEJ             ; mocna procedura, ktera man podle zadanych parametru vyhleda pozadovany
                             zaznam 
                      00348                                         ; a umisti jej do bufferu2 na offset 32 (od zacatku bufferu)
09F9   2A00           00349         goto PRIKAZ_09h_KONEC
09FA                  00350 PRIKAZ_09h_SPATNY_PAR
                      00351         BANK_2
09FA   1703               M                 bsf     STATUS,RP1              ; BANK2  RP1:RP0 = 10
09FB   1283               M                 bcf     STATUS,RP0    
09FC   3081           00352         movlw h'81'
09FD   00B0           00353         movwf 0x130
                      00354         BANK_0
09FE   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
09FF   1283               M                 bcf     STATUS,RP0    
0A00                  00355 PRIKAZ_09h_KONEC
0A00   3012           00356         movlw .18
0A01   00B6           00357         movwf TEMP1     
                      00358 
                      00359         PROG_PAGE_0
0A02   118A               M                         bcf PCLATH,3
0A03   120A               M                         bcf PCLATH,4
0A04   2191           00360         call ODESLI_BUFF2_HIGH
                      00361         PROG_PAGE_1
0A05   158A               M                         bsf PCLATH,3
0A06   120A               M                         bcf PCLATH,4
                      00362 
0A07   01F3           00363         clrf PRIJATYCH_DAT                      ; vyprazdnime zasobnik prikazu
0A08   0008           00364         return
                      00365 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
0A09                  00366 PRIKAZ_0Ah                                              ; 0Ah – precti dlouhe jmeno
0A09   0878           00367         movfw 0x078                                     ; prvni byte zasobniku prikazu
0A0A   3C0A           00368         sublw h'0A'
0A0B   1D03           00369         btfss STATUS,Z
0A0C   0008           00370         return                                          ; nebyl prijat prikaz 0Ah
0A0D   1475           00371         bsf STAV_PRIKAZU,0                      ; mame tu prikaz 0Ah, nastavime byt STAV_REGISTRU
0A0E   0873           00372         movfw PRIJATYCH_DAT
0A0F   3C06           00373         sublw .6                                        ; pro prikaz 0Ah musi prijit 7 bytu (prikaz + 6b
                            ytu parametr)
0A10   1803           00374         btfsc STATUS,C
0A11   0008           00375         return                                          ; jeste nemame vsechny parametry
                      00376         ; Prisel prikaz 0Ah s 6bytovym parametrem 
                      00377 
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 76


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0A12   0879           00378         movfw 0x079                                     ; nejnizsi cast clusteru adresare
0A13   00DA           00379         movwf HL_ADR_CL1
0A14   00BC           00380         movwf CLUSTER1
0A15   087A           00381         movfw 0x07A
0A16   00DB           00382         movwf HL_ADR_CL2
0A17   00BD           00383         movwf CLUSTER2
0A18   087B           00384         movfw 0x07B
0A19   00DC           00385         movwf HL_ADR_CL3
0A1A   00BE           00386         movwf CLUSTER3
0A1B   087C           00387         movfw 0x07C
0A1C   00DD           00388         movwf HL_ADR_CL4
0A1D   00BF           00389         movwf CLUSTER4
0A1E   2331           00390         call PRVNI_CL_ADRESARE
                      00391 
0A1F   1C3B           00392         btfss POZICE,0
0A20   2A27           00393         goto PRIKAZ_0Ah_PAR1_OK
                      00394 
0A21                  00395 PRIKAZ_0Ah_PAR1_NOT_OK
                      00396         INDF_BANK_2
0A21   1783               M                         bsf STATUS,IRP    
0A22   3010           00397         movlw 0x10                                      ; 1. byte bufferu 2
0A23   0084           00398         movwf FSR
0A24   3081           00399         movlw h'81'                                     ; jako prvni byte odpovedi dame 81h (Zadany clus
                            ter neobsahuje adresar)
0A25   00BB           00400         movwf POZICE
0A26   2A2C           00401         goto PRIKAZ_0Ah_KONEC
0A27                  00402 PRIKAZ_0Ah_PAR1_OK
0A27   087D           00403         movfw 0x07D
0A28   00E0           00404         movwf ZAZNAM1
0A29   087E           00405         movfw 0x07E
0A2A   00E1           00406         movwf ZAZNAM2
                      00407 
0A2B   2655           00408         call LONG_NAME
0A2C                  00409 PRIKAZ_0Ah_KONEC
                      00410         PROG_PAGE_0
0A2C   118A               M                         bcf PCLATH,3
0A2D   120A               M                         bcf PCLATH,4
0A2E   083B           00411         movfw POZICE
0A2F   2165           00412         call WR_USART   
                      00413         ; At uz bylo v zaznamu cokoli, odesleme 65 bytu z BUFFERU 2
0A30   3041           00414         movlw .65
0A31   00B6           00415         movwf TEMP1
0A32   219B           00416         call ODESLI_BUFFER2                     ; odesleme si zaznam o souboru  
                      00417         PROG_PAGE_1
0A33   158A               M                         bsf PCLATH,3
0A34   120A               M                         bcf PCLATH,4
                      00418 
0A35   01F3           00419         clrf PRIJATYCH_DAT                      ; vyprazdnime zasobnik prikazu
0A36   0008           00420         return
                      00421 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
0A37                  00422 PRIKAZ_80h                                              ; 80h – hraj mp3 soubor
0A37   0878           00423         movfw 0x078                                     ; prvni byte zasobniku prikazu
0A38   3C80           00424         sublw h'80'
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 77


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0A39   1D03           00425         btfss STATUS,Z
0A3A   0008           00426         return                                          ; nebyl prijat prikaz 80h
0A3B   1475           00427         bsf STAV_PRIKAZU,0                      ; mame tu prikaz 80h, nastavime byt STAV_REGISTRU
0A3C   0873           00428         movfw PRIJATYCH_DAT
0A3D   3C06           00429         sublw .6                                        ; pro prikaz 80h musi prijit 7 bytu (prikaz + 6b
                            ytu parametr)
0A3E   1803           00430         btfsc STATUS,C
0A3F   0008           00431         return                                          ; jeste nemame vsechny parametry
                      00432         ; Prisel prikaz 80h s 6bytovym parametrem 
                      00433 
0A40   0879           00434         movfw 0x079                                     ; nejnizsi cast clusteru adresare
0A41   00BC           00435         movwf CLUSTER1
0A42   087A           00436         movfw 0x07A
0A43   00BD           00437         movwf CLUSTER2
0A44   087B           00438         movfw 0x07B
0A45   00BE           00439         movwf CLUSTER3
0A46   087C           00440         movfw 0x07C
0A47   00BF           00441         movwf CLUSTER4
0A48   2331           00442         call PRVNI_CL_ADRESARE
                      00443 
0A49   1C3B           00444         btfss POZICE,0
0A4A   2A51           00445         goto PRIKAZ_80h_PAR1_OK
                      00446 
0A4B                  00447 PRIKAZ_80h_PAR1_NOT_OK
                      00448         INDF_BANK_2
0A4B   1783               M                         bsf STATUS,IRP    
0A4C   3010           00449         movlw 0x10                                      ; 1. byte bufferu 2
0A4D   0084           00450         movwf FSR
0A4E   3081           00451         movlw h'81'                                     ; jako prvni byte odpovedi dame 81h (Zadany clus
                            ter neobsahuje adresar)
0A4F   0080           00452         movwf INDF
0A50   2A8B           00453         goto PRIKAZ_80h_KONEC
0A51                  00454 PRIKAZ_80h_PAR1_OK
                      00455 
0A51   087D           00456         movfw 0x07D
0A52   00E0           00457         movwf ZAZNAM1
0A53   087E           00458         movfw 0x07E
0A54   00E1           00459         movwf ZAZNAM2
                      00460 
0A55   236B           00461         call SKOC_NA_ZAZNAM
0A56   1C3B           00462         btfss POZICE,0
0A57   2A5E           00463         goto PRIKAZ_80h_PAR2_OK
                      00464 
0A58                  00465 PRIKAZ_80h_PAR2_NOT_OK
                      00466         INDF_BANK_2
0A58   1783               M                         bsf STATUS,IRP    
0A59   3010           00467         movlw 0x10                                      ; 1. byte bufferu 2
0A5A   0084           00468         movwf FSR
0A5B   3080           00469         movlw h'80'                                     ; jako prvni byte odpovedi dame 80h (Zadany zazn
                            am mimo rozsah)
0A5C   0080           00470         movwf INDF
0A5D   2A8B           00471         goto PRIKAZ_80h_KONEC
0A5E                  00472 PRIKAZ_80h_PAR2_OK
                      00473 
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 78


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0A5E   23E6           00474         call FILE_INFO
                      00475 
                      00476         INDF_BANK_2
0A5F   1783               M                         bsf STATUS,IRP    
0A60   3010           00477         movlw 0x10                                      ; 1. byte bufferu 2
0A61   0084           00478         movwf FSR
0A62   0800           00479         movfw INDF
0A63   3C06           00480         sublw h'06'                                     ; pokud na zadanem miste se nachazi soubor s pri
                            ponou mp3...
0A64   1D03           00481         btfss STATUS,Z
0A65   2A8B           00482         goto PRIKAZ_80h_KONEC
                      00483                         
                      00484         ; ...nastavime jej jako prehravany soubor.
0A66   301C           00485         movlw 0x1C                                      ; 13. byte bufferu 2
0A67   0084           00486         movwf FSR
0A68   0800           00487         movfw INDF
0A69   00E9           00488         movwf PREH_DATA_CL1
0A6A   0A84           00489         incf FSR,f
0A6B   0800           00490         movfw INDF
0A6C   00EA           00491         movwf PREH_DATA_CL2
0A6D   0A84           00492         incf FSR,f
0A6E   0800           00493         movfw INDF
0A6F   00EB           00494         movwf PREH_DATA_CL3
0A70   0A84           00495         incf FSR,f
0A71   0800           00496         movfw INDF
0A72   00EC           00497         movwf PREH_DATA_CL4
                      00498         
0A73   087D           00499         movfw 0x07D
0A74   00E6           00500         movwf PREH_ZAZNAM1
0A75   087E           00501         movfw 0x07E
0A76   00E7           00502         movwf PREH_ZAZNAM2
                      00503 
0A77   0879           00504         movfw 0x079                                     ; nejnizsi cast clusteru adresare
0A78   00E2           00505         movwf PREH_ADR_CL1
0A79   087A           00506         movfw 0x07A
0A7A   00E3           00507         movwf PREH_ADR_CL2
0A7B   087B           00508         movfw 0x07B
0A7C   00E4           00509         movwf PREH_ADR_CL3
0A7D   087C           00510         movfw 0x07C
0A7E   00E5           00511         movwf PREH_ADR_CL4
                      00512         ; aktualni prehravany soubor i prehravana slozka byly nastaveny...
                      00513 
0A7F   01ED           00514         clrf PREH_DATA_POZICE
0A80   146E           00515         bsf PREH_STAV0,0
0A81   14EE           00516         bsf PREH_STAV0,1                        ; nastavime si vlastosti prehravani: (PREH_STAV[0-1])
                      00517 
0A82   10CD           00518         bcf VSREG_MODE_L,1                      ; prehravame normalni rychlosti 
0A83   106F           00519         bcf PREH_STAV1,0                        ; prehravame normalni rychlosti 
                      00520         
0A84   2079           00521         call VS_SOFT_RESET
                      00522 
0A85   3000           00523         movlw VSADDR_MODE
0A86   00B6           00524         movwf TEMP1
0A87   084D           00525         movfw VSREG_MODE_L
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 79


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0A88   00B7           00526         movwf TEMP2
0A89   01B8           00527         clrf TEMP3
0A8A   2063           00528         call VS_WR_REG
                      00529 
0A8B                  00530 PRIKAZ_80h_KONEC
                      00531         ; At uz bylo v zaznamu cokoli, odesleme 1 byt z BUFFERU 2
                      00532         INDF_BANK_2
0A8B   1783               M                         bsf STATUS,IRP    
0A8C   3010           00533         movlw 0x10                                      ; 1. byte bufferu 2
0A8D   0084           00534         movwf FSR
0A8E   0800           00535         movfw INDF
                      00536         PROG_PAGE_0
0A8F   118A               M                         bcf PCLATH,3
0A90   120A               M                         bcf PCLATH,4
0A91   2165           00537         call WR_USART   
                      00538         PROG_PAGE_1
0A92   158A               M                         bsf PCLATH,3
0A93   120A               M                         bcf PCLATH,4
                      00539         
0A94   01F3           00540         clrf PRIJATYCH_DAT                      ; vyprazdnime zasobnik prikazu
0A95   0008           00541         return
                      00542 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
0A96                  00543 PRIKAZ_81h                                              ; 81h – vrat stav prehravaneho souboru
0A96   0878           00544         movfw 0x078                                     ; prvni byte zasobniku prikazu
0A97   3C81           00545         sublw h'81'
0A98   1D03           00546         btfss STATUS,Z
0A99   0008           00547         return                                          ; nebyl prijat prikaz 81h
0A9A   1475           00548         bsf STAV_PRIKAZU,0                      ; mame tu prikaz 81h, nastavime byt STAV_REGISTRU
                      00549         ; pro prikaz 81h nejsou definovany zadne parametry, proto jiz nic jineho netestujeme
                      00550 
0A9B   086E           00551         movfw PREH_STAV0
                      00552         PROG_PAGE_0
0A9C   118A               M                         bcf PCLATH,3
0A9D   120A               M                         bcf PCLATH,4
0A9E   2165           00553         call WR_USART
                      00554         PROG_PAGE_1
0A9F   158A               M                         bsf PCLATH,3
0AA0   120A               M                         bcf PCLATH,4
                      00555 
0AA1   086F           00556         movfw PREH_STAV1
                      00557         PROG_PAGE_0
0AA2   118A               M                         bcf PCLATH,3
0AA3   120A               M                         bcf PCLATH,4
0AA4   2165           00558         call WR_USART
                      00559         PROG_PAGE_1
0AA5   158A               M                         bsf PCLATH,3
0AA6   120A               M                         bcf PCLATH,4
                      00560 
0AA7   116E           00561         bcf PREH_STAV0,2                        ; 2. bit je nastaven, kdyz se zmeni prehravany soubor (b
                            ez volani prikazu) do doby, nez prijde prikaz na dotaz STAVU... (81h)
                      00562 
0AA8   3004           00563         movlw VSADDR_DECODE_TIME
0AA9   00B6           00564         movwf TEMP1
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 80


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0AAA   206E           00565         call VS_RD_REG                          ; zjistime si aktualni pozici v souboru v sekundach
0AAB   0837           00566         movfw TEMP2
                      00567         PROG_PAGE_0
0AAC   118A               M                         bcf PCLATH,3
0AAD   120A               M                         bcf PCLATH,4
0AAE   2165           00568         call WR_USART
0AAF   0838           00569         movfw TEMP3
0AB0   2165           00570         call WR_USART   
                      00571         PROG_PAGE_1
0AB1   158A               M                         bsf PCLATH,3
0AB2   120A               M                         bcf PCLATH,4
                      00572 
                      00573 ;       movlw VSADDR_STATUS
                      00574 ;       movwf TEMP1
                      00575 ;       call VS_RD_REG
                      00576 ;       movfw TEMP2
                      00577 ;       PROG_PAGE_0
                      00578 ;       call WR_USART
                      00579 ;       PROG_PAGE_1
                      00580 
0AB3   01F3           00581         clrf PRIJATYCH_DAT                      ; vyprazdnime zasobnik
0AB4   0008           00582         return
                      00583 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
0AB5                  00584 PRIKAZ_82h                                              ; 82h – nastav hlasitost
0AB5   0878           00585         movfw 0x078                                     ; prvni byte zasobniku prikazu
0AB6   3C82           00586         sublw h'82'
0AB7   1D03           00587         btfss STATUS,Z
0AB8   0008           00588         return                                          ; nebyl prijat prikaz 82h
0AB9   1475           00589         bsf STAV_PRIKAZU,0                      ; mame tu prikaz 82h, nastavime byt STAV_REGISTRU
0ABA   0873           00590         movfw PRIJATYCH_DAT
0ABB   3C02           00591         sublw .2                                        ; pro prikaz 82h museji prijit 3 byty (prikaz + 
                            2byty parametr)
0ABC   1803           00592         btfsc STATUS,C
0ABD   0008           00593         return                                          ; jeste nemame vsechny parametry
                      00594         ; Prisel prikaz 82h s 2bytovym parametrem 
                      00595 
0ABE   0879           00596         movfw 0x079                                     ; hlasitost pro levy kanal
0ABF   00D0           00597         movwf VSREG_VOL_H
0AC0   087A           00598         movfw 0x07A                                     ; hlasitost pro pravy kanal
0AC1   00CF           00599         movwf VSREG_VOL_L
0AC2   209D           00600         call VS_SET_VOLUME                      ; nastavime hlasitost   
                      00601 
0AC3   30FF           00602         movlw h'FF'
                      00603         PROG_PAGE_0
0AC4   118A               M                         bcf PCLATH,3
0AC5   120A               M                         bcf PCLATH,4
0AC6   2165           00604         call WR_USART
                      00605         PROG_PAGE_1
0AC7   158A               M                         bsf PCLATH,3
0AC8   120A               M                         bcf PCLATH,4
0AC9   01F3           00606         clrf PRIJATYCH_DAT                      ; vyprazdnime zasobnik
0ACA   0008           00607         return
                      00608 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 81


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                            XXXXXXXXXXXXXXXXXXXXX
0ACB                  00609 PRIKAZ_83h                                              ; 83h – vrat informace o prehravanem souboru
0ACB   0878           00610         movfw 0x078                                     ; prvni byte zasobniku prikazu
0ACC   3C83           00611         sublw h'83'
0ACD   1D03           00612         btfss STATUS,Z
0ACE   0008           00613         return                                          ; nebyl prijat prikaz 83h
0ACF   1475           00614         bsf STAV_PRIKAZU,0                      ; mame tu prikaz 83h, nastavime byt STAV_REGISTRU
                      00615         ; pro prikaz 83h nejsou definovane zadne parametry, proto jiz nic jineho netestujeme
                      00616 
0AD0   3005           00617         movlw VSADDR_AUDATA
0AD1   00B6           00618         movwf TEMP1
0AD2   206E           00619         call VS_RD_REG
0AD3   0837           00620         movfw TEMP2
                      00621         PROG_PAGE_0
0AD4   118A               M                         bcf PCLATH,3
0AD5   120A               M                         bcf PCLATH,4
0AD6   2165           00622         call WR_USART
0AD7   0838           00623         movfw TEMP3
0AD8   2165           00624         call WR_USART   
                      00625         PROG_PAGE_1
0AD9   158A               M                         bsf PCLATH,3
0ADA   120A               M                         bcf PCLATH,4
                      00626         ; odeslali jsme AUDATA
                      00627 
0ADB   3008           00628         movlw VSADDR_HDAT0
0ADC   00B6           00629         movwf TEMP1
0ADD   206E           00630         call VS_RD_REG
0ADE   0837           00631         movfw TEMP2
                      00632         PROG_PAGE_0
0ADF   118A               M                         bcf PCLATH,3
0AE0   120A               M                         bcf PCLATH,4
0AE1   2165           00633         call WR_USART
0AE2   0838           00634         movfw TEMP3
0AE3   2165           00635         call WR_USART   
                      00636         PROG_PAGE_1
0AE4   158A               M                         bsf PCLATH,3
0AE5   120A               M                         bcf PCLATH,4
                      00637         ; odeslali jsme HDAT0
                      00638 
0AE6   3009           00639         movlw VSADDR_HDAT1
0AE7   00B6           00640         movwf TEMP1
0AE8   206E           00641         call VS_RD_REG
0AE9   0837           00642         movfw TEMP2
                      00643         PROG_PAGE_0
0AEA   118A               M                         bcf PCLATH,3
0AEB   120A               M                         bcf PCLATH,4
0AEC   2165           00644         call WR_USART
0AED   0838           00645         movfw TEMP3
0AEE   2165           00646         call WR_USART   
                      00647         ; odeslali jsme HDAT1
                      00648 
0AEF   0862           00649         movfw PREH_ADR_CL1
0AF0   2165           00650         call WR_USART
0AF1   0863           00651         movfw PREH_ADR_CL2
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 82


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0AF2   2165           00652         call WR_USART
0AF3   0864           00653         movfw PREH_ADR_CL3
0AF4   2165           00654         call WR_USART
0AF5   0865           00655         movfw PREH_ADR_CL4
0AF6   2165           00656         call WR_USART
                      00657 
0AF7   0866           00658         movfw PREH_ZAZNAM1
0AF8   2165           00659         call WR_USART
0AF9   0867           00660         movfw PREH_ZAZNAM2
0AFA   2165           00661         call WR_USART
                      00662         PROG_PAGE_1
0AFB   158A               M                         bsf PCLATH,3
0AFC   120A               M                         bcf PCLATH,4
                      00663 
0AFD   01F3           00664         clrf PRIJATYCH_DAT                      ; vyprazdnime zasobnik
0AFE   0008           00665         return
                      00666 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
0AFF                  00667 PRIKAZ_84h                                              ; 84h – nastav stav prehravani
0AFF   0878           00668         movfw 0x078                                     ; prvni byte zasobniku prikazu
0B00   3C84           00669         sublw h'84'
0B01   1D03           00670         btfss STATUS,Z
0B02   0008           00671         return                                          ; nebyl prijat prikaz 84h
0B03   1475           00672         bsf STAV_PRIKAZU,0                      ; mame tu prikaz 84h, nastavime byt STAV_REGISTRU
0B04   0873           00673         movfw PRIJATYCH_DAT
0B05   3C02           00674         sublw .2                                        ; pro prikaz 8h museji prijit 3 byty (prikaz + 2
                            byty parametr)
0B06   1803           00675         btfsc STATUS,C
0B07   0008           00676         return                                          ; jeste nemame vsechny parametry
                      00677         ; Prisel prikaz 84h s 2bytovym parametrem 
                      00678 
0B08   086E           00679         movfw PREH_STAV0
0B09   3906           00680         andlw b'00000110'
0B0A   00EE           00681         movwf PREH_STAV0
0B0B   0879           00682         movfw 0x079                                     ; parametr 1
0B0C   39F9           00683         andlw b'11111001'                       ; nektere bity vymaskujeme (vsechny nelze ovladat prikaz
                            em)
0B0D   046E           00684         iorwf PREH_STAV0,w      
0B0E   00EE           00685         movwf PREH_STAV0
                      00686 
0B0F   087A           00687         movfw 0x07A                                     ; parametr 2
0B10   00EF           00688         movwf PREH_STAV1
                      00689 
0B11   10CD           00690         bcf VSREG_MODE_L,1                      ; prehravame normalni rychlosti (zda se mp3 prevyji je r
                            eseno v hlavni smycce podle stavu registru PREH_STAV1)
0B12   13CD           00691         bcf VSREG_MODE_L,7                      ;bass/treble enhancer
0B13   19EF           00692         btfsc PREH_STAV1,3                      ; 3. bit =      1 => zvyrazneni basu a vysek (moznost de
                            koderu vs1001 "bass/treble enhancer")
0B14   17CD           00693         bsf VSREG_MODE_L,7                      ;bass/treble enhancer
                      00694         
0B15   3000           00695         movlw VSADDR_MODE
0B16   00B6           00696         movwf TEMP1
0B17   084D           00697         movfw VSREG_MODE_L
0B18   00B7           00698         movwf TEMP2
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 83


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0B19   01B8           00699         clrf TEMP3
0B1A   2063           00700         call VS_WR_REG
                      00701         
0B1B   3001           00702         movlw VSADDR_STATUS
0B1C   206E           00703         call VS_RD_REG
0B1D   0837           00704         movfw TEMP2
0B1E   00CE           00705         movwf VSREG_STATUS_L
                      00706 
0B1F   114E           00707         bcf VSREG_STATUS_L,2            ; Bit 2 is analog powerdown bit.
0B20   1A6F           00708         btfsc PREH_STAV1,4                      ; 4. bit = 1 => MUTE
0B21   154E           00709         bsf VSREG_STATUS_L,2            ; Bit 2 is analog powerdown bit.
                      00710         
0B22   3001           00711         movlw VSADDR_STATUS
0B23   00B6           00712         movwf TEMP1
0B24   084E           00713         movfw VSREG_STATUS_L
0B25   00B7           00714         movwf TEMP2
0B26   01B8           00715         clrf TEMP3
0B27   2063           00716         call VS_WR_REG
                      00717 
                      00718         PROG_PAGE_0
0B28   118A               M                         bcf PCLATH,3
0B29   120A               M                         bcf PCLATH,4
0B2A   30FF           00719         movlw h'FF'
0B2B   2165           00720         call WR_USART
                      00721         PROG_PAGE_1
0B2C   158A               M                         bsf PCLATH,3
0B2D   120A               M                         bcf PCLATH,4
0B2E   01E8           00722         clrf PREH_CITAC_PREV
0B2F   01F3           00723         clrf PRIJATYCH_DAT                      ; vyprazdnime zasobnik
0B30   0008           00724         return
                      00725 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
                      00077         include "filesystem.asm"; podprogramy pro praci s adresari a setrideni obsahu adresaru
                      00001 ;**********************************************************
                      00002 ;**********************************************************
                      00003 ;**********************************************************
                      00004 ; podprogramy pro praci s adresari a setrideni obsahu adresaru
                      00005 ;**********************************************************
                      00006 ;**********************************************************
                      00007 ;**********************************************************
                      00008 
                      00009 ;**************************************************************************
0B31                  00010 PRVNI_CL_ADRESARE
                      00011         ; V CLUSTER[1-4] prijme cislo clusteru, zkontroluje, zda zadany sluster obsahuje 
                      00012         ; zacatek adresare
                      00013         ; V POZICE vrati 00h, pokud cluster je prvni cluster nejakeho adresare, FFh, pokud neobsahuje ad
                            resar
0B31   01BB           00014         clrf POZICE
                      00015 
0B32   083C           00016         movfw CLUSTER1
0B33   043D           00017         iorwf CLUSTER2,W
0B34   043E           00018         iorwf CLUSTER3,W
0B35   043F           00019         iorwf CLUSTER4,W
0B36   1903           00020         btfsc STATUS,Z
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 84


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0B37   0008           00021         return                          ; pokud CLUSTER[1-4]=0, tak se jedna o 1. cluster ROOT adr., pro
                            to nemusime dale resit co tam je...
                      00022         
                      00023         PROG_PAGE_0
0B38   118A               M                         bcf PCLATH,3
0B39   120A               M                         bcf PCLATH,4
0B3A   24C9           00024         call CLUSTER_TO_LBA
0B3B   3001           00025         movlw .1
0B3C   00A6           00026         movwf SECTOR_C
0B3D   22AC           00027         call READ_SECTOR        ; precteme udajny prvni sektor z prvniho clusteru adresare      
                      00028         PROG_PAGE_1
0B3E   158A               M                         bsf PCLATH,3
0B3F   120A               M                         bcf PCLATH,4
                      00029 
                      00030         ; Tady vychazime z toho, ze kazdy adresar krome ROOTu ma jako prvni zaznam ukazatel na sebe (jak
                            o jmeno je jedna tecka)
                      00031         ; Mohlo by se sice stat, ze bychom narazili na soubor, ktery zacina retezcem ".          " to by
                            ch ale neresil...
0B40   30FF           00032         movlw h'FF'
0B41   00BB           00033         movwf POZICE
                      00034 
                      00035         PROG_PAGE_0
0B42   118A               M                         bcf PCLATH,3
0B43   120A               M                         bcf PCLATH,4
0B44   2254           00036         call READ_DATA
                      00037         PROG_PAGE_1
0B45   158A               M                         bsf PCLATH,3
0B46   120A               M                         bcf PCLATH,4
0B47   0820           00038         movfw DATA_L
0B48   3C2E           00039         sublw '.'               ; 1. znak
0B49   1D03           00040         btfss STATUS,Z
0B4A   2B6A           00041         goto PRVNI_CL_ADRESARE_KONEC
0B4B   0821           00042         movfw DATA_H
0B4C   3C20           00043         sublw h'20'             ; 2. znak
0B4D   1D03           00044         btfss STATUS,Z
0B4E   2B6A           00045         goto PRVNI_CL_ADRESARE_KONEC
                      00046 
0B4F   3004           00047         movlw .4                ; dalsich 8 znaku maji byt mezery
0B50   00B6           00048         movwf TEMP1
                      00049         
0B51                  00050 PRVNI_CL_ADRESARE_MEZERY
                      00051         PROG_PAGE_0
0B51   118A               M                         bcf PCLATH,3
0B52   120A               M                         bcf PCLATH,4
0B53   2254           00052         call READ_DATA
                      00053         PROG_PAGE_1
0B54   158A               M                         bsf PCLATH,3
0B55   120A               M                         bcf PCLATH,4
0B56   0820           00054         movfw DATA_L
0B57   3C20           00055         sublw h'20'
0B58   1D03           00056         btfss STATUS,Z
0B59   2B6A           00057         goto PRVNI_CL_ADRESARE_KONEC
0B5A   0821           00058         movfw DATA_H
0B5B   3C20           00059         sublw h'20'
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 85


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0B5C   1D03           00060         btfss STATUS,Z
0B5D   2B6A           00061         goto PRVNI_CL_ADRESARE_KONEC
0B5E   0BB6           00062         decfsz TEMP1,f
0B5F   2B51           00063         goto PRVNI_CL_ADRESARE_MEZERY
                      00064 
                      00065         PROG_PAGE_0
0B60   118A               M                         bcf PCLATH,3
0B61   120A               M                         bcf PCLATH,4
0B62   2254           00066         call READ_DATA
                      00067         PROG_PAGE_1
0B63   158A               M                         bsf PCLATH,3
0B64   120A               M                         bcf PCLATH,4
0B65   0820           00068         movfw DATA_L
0B66   3C20           00069         sublw h'20'
0B67   1D03           00070         btfss STATUS,Z
0B68   2B6A           00071         goto PRVNI_CL_ADRESARE_KONEC
                      00072 
0B69   01BB           00073         clrf POZICE     
0B6A                  00074 PRVNI_CL_ADRESARE_KONEC
0B6A   0008           00075         return
                      00076 ;**************************************************************************
0B6B                  00077 SKOC_NA_ZAZNAM
                      00078         ; !!!! pozor, tato procedura potrebuje min. 5 mist ve STACKu (vcetne sama sebe)
                      00079 
                      00080         ; V CLUSTER[1-4] prijme cislo clusteru na kterem se nachazi zacatek adresare
                      00081         ; V ZAZNAM[1-2] prijme cislo zaznamu 
                      00082         ; - pokud ZAZNAM[1-2] ukazuji mimo adresar, vrati v POZICE FFh (jinak 00h)
                      00083         ; - pokud byl zaznam nalezen,
                      00084         ;       da disku prikaz k jeho precteni a skoci az k zaznamu...
                      00085         ;       ...v bufferu disku budeme mit teda 32bytu dat ktere prezentuji jeden zaznam ve slozce
0B6B   0860           00086         movfw ZAZNAM1
                      00087         BANK_1
0B6C   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0B6D   1683               M                 bsf     STATUS,RP0    
0B6E   00A0           00088         movwf OPERAND_X1
                      00089         BANK_0
0B6F   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0B70   1283               M                 bcf     STATUS,RP0    
0B71   0861           00090         movfw ZAZNAM2
                      00091         BANK_1
0B72   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0B73   1683               M                 bsf     STATUS,RP0    
0B74   00A1           00092         movwf OPERAND_X2
0B75   01A2           00093         clrf OPERAND_X3
0B76   01A3           00094         clrf OPERAND_X4
                      00095         BANK_0                                  ; OPERAND_X := ZAZNAM
0B77   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0B78   1283               M                 bcf     STATUS,RP0    
                      00096         
                      00097         PROG_PAGE_0
0B79   118A               M                         bcf PCLATH,3
0B7A   120A               M                         bcf PCLATH,4
0B7B   2693           00098         call POSUNDOPRAVA_4             ; OPERAND_X := OPERAND_X div 16
                      00099         ; tady mame v PRETECENI kolikaty zaznam v sektoru chceme
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 86


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00100         BANK_1
0B7C   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0B7D   1683               M                 bsf     STATUS,RP0    
0B7E   082C           00101         movfw PRETECENI
                      00102         BANK_0
0B7F   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0B80   1283               M                 bcf     STATUS,RP0    
0B81   00BA           00103         movwf TEMP5
                      00104 
0B82   18CC           00105         btfsc CLUSTER_SIZE,1            ; 2
0B83   2675           00106         call POSUNDOPRAVA_1                     ; X := X div 2
0B84   194C           00107         btfsc CLUSTER_SIZE,2            ; 4
0B85   267E           00108         call POSUNDOPRAVA_2                     ; X := X div 4
0B86   19CC           00109         btfsc CLUSTER_SIZE,3            ; 8
0B87   2688           00110         call POSUNDOPRAVA_3                     ; X := X div 8
0B88   1A4C           00111         btfsc CLUSTER_SIZE,4            ; 16
0B89   2693           00112         call POSUNDOPRAVA_4                     ; X := X div 4
0B8A   1ACC           00113         btfsc CLUSTER_SIZE,5            ; 32
0B8B   269F           00114         call POSUNDOPRAVA_5                     ; X := X div 32
0B8C   1B4C           00115         btfsc CLUSTER_SIZE,6            ; 64
0B8D   26AC           00116         call POSUNDOPRAVA_6                     ; X := X div 64
0B8E   1BCC           00117         btfsc CLUSTER_SIZE,7            ; 128
0B8F   26BA           00118         call POSUNDOPRAVA_7                     ; X := X div 128
                      00119         ; tady mame v PRETECENI na kolikatem sektoru v clusteru je hledany zaznam
                      00120         BANK_1
0B90   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0B91   1683               M                 bsf     STATUS,RP0    
0B92   082C           00121         movfw PRETECENI
                      00122         BANK_0
0B93   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0B94   1283               M                 bcf     STATUS,RP0    
0B95   00B9           00123         movwf TEMP4
                      00124 
                      00125         ; OPERAND_X := (ZAZNAM div 16) div CLUSTER_SIZE
                      00126         ; ted v OPERAND_X mame hodnotu kolik clusteru mame od zacatku adresare preskocit...
0B96                  00127 SKOC_NA_ZAZNAM_PRESKOC_CL
                      00128         PROG_PAGE_0
0B96   118A               M                         bcf PCLATH,3
0B97   120A               M                         bcf PCLATH,4
0B98   26C9           00129         call NULA
                      00130         PROG_PAGE_1
0B99   158A               M                         bsf PCLATH,3
0B9A   120A               M                         bcf PCLATH,4
                      00131         BANK_1
0B9B   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0B9C   1683               M                 bsf     STATUS,RP0    
0B9D   1C2C           00132         btfss PRETECENI,0
0B9E   2BC4           00133         goto SKOC_NA_ZAZNAM_MAME_CL     
                      00134         BANK_0
0B9F   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0BA0   1283               M                 bcf     STATUS,RP0    
                      00135 
                      00136         INDF_BANK_1
0BA1   1383               M                         bcf STATUS,IRP    
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 87


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0BA2   30A0           00137         movlw 0xA0
0BA3   0084           00138         movwf FSR
0BA4   0800           00139         movfw INDF
0BA5   00B7           00140         movwf TEMP2
0BA6   0A84           00141         incf FSR,F
0BA7   0800           00142         movfw INDF
0BA8   00B8           00143         movwf TEMP3
                      00144 
                      00145         PROG_PAGE_0
0BA9   118A               M                         bcf PCLATH,3
0BAA   120A               M                         bcf PCLATH,4
0BAB   252C           00146         call NEXT_CLUSTER
                      00147         PROG_PAGE_1
0BAC   158A               M                         bsf PCLATH,3
0BAD   120A               M                         bcf PCLATH,4
0BAE   183B           00148         btfsc POZICE,0          ; pokud s vse povedlo, mame v POZICE 0
0BAF   2BE3           00149         goto SKOC_NA_ZAZNAM_MIMO_ROZSAH
                      00150 
                      00151         INDF_BANK_1
0BB0   1383               M                         bcf STATUS,IRP    
0BB1   30A0           00152         movlw 0xA0
0BB2   0084           00153         movwf FSR
0BB3   0837           00154         movfw TEMP2
0BB4   0080           00155         movwf INDF
0BB5   0A84           00156         incf FSR,F
0BB6   0838           00157         movfw TEMP3
0BB7   0080           00158         movwf INDF
                      00159         BANK_1
0BB8   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0BB9   1683               M                 bsf     STATUS,RP0    
0BBA   01A2           00160         clrf OPERAND_X3
0BBB   01A3           00161         clrf OPERAND_X4
                      00162         BANK_0  
0BBC   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0BBD   1283               M                 bcf     STATUS,RP0    
                      00163 
                      00164         PROG_PAGE_0
0BBE   118A               M                         bcf PCLATH,3
0BBF   120A               M                         bcf PCLATH,4
0BC0   260C           00165         call DEKREMENTUJ
                      00166         PROG_PAGE_1
0BC1   158A               M                         bsf PCLATH,3
0BC2   120A               M                         bcf PCLATH,4
                      00167 
0BC3   2B96           00168         goto SKOC_NA_ZAZNAM_PRESKOC_CL
                      00169 
0BC4                  00170 SKOC_NA_ZAZNAM_MAME_CL
                      00171         BANK_0
0BC4   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0BC5   1283               M                 bcf     STATUS,RP0    
                      00172 
0BC6   0839           00173         movfw TEMP4                                     ; v kolikatem sektoru v clusteru je hledany zazn
                            am
0BC7   00BB           00174         movwf POZICE 
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 88


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00175         PROG_PAGE_0
0BC8   118A               M                         bcf PCLATH,3
0BC9   120A               M                         bcf PCLATH,4
0BCA   24C9           00176         call CLUSTER_TO_LBA                     ; zjistime si skutecnou polohu zaznamu na disku
0BCB   3001           00177         movlw .1
0BCC   00A6           00178         movwf SECTOR_C
0BCD   22AC           00179         call READ_SECTOR                        ; dame prikaz precist sektor
                      00180         PROG_PAGE_1
0BCE   158A               M                         bsf PCLATH,3
0BCF   120A               M                         bcf PCLATH,4
                      00181 
0BD0   3010           00182         movlw .16
0BD1   00DE           00183         movwf ZAZNAMU_vBUFFERU_DISKU
0BD2   083A           00184         movfw TEMP5
0BD3   02DE           00185         subwf ZAZNAMU_vBUFFERU_DISKU,f          ; ZAZNAMU_vBUFFERU_DISKU := 16 - TEMP5
                      00186 
0BD4   083A           00187         movfw TEMP5                                     ; kolikaty zaznam v casti adersare (sektoru) mam
                            e precist [0..15]
0BD5   390F           00188         andlw b'00001111'
0BD6   00B6           00189         movwf TEMP1                                     ; rozsah by mel byt spravne, pro jistotu jej ale
                             orizneme [0..15]
0BD7   39FF           00190         andlw h'FF'
0BD8   1903           00191         btfsc STATUS,Z                          ; pokud chceme prvni zaznam ze sektoru...
0BD9   2BE0           00192         goto SKOC_NA_ZAZNAM_MAME_ZAZNAM         ; ...koncime
                      00193 
0BDA   0EB6           00194         swapf TEMP1,F                           ; protoze kazdy zaznam o souboru ma 32B=16slov, tak musi
                            me TEMP1 vynasobit 16...
                      00195         PROG_PAGE_0
0BDB   118A               M                         bcf PCLATH,3
0BDC   120A               M                         bcf PCLATH,4
0BDD   226F           00196         call PRESKOC                            ; a tolik slov preskocit (tolik slov je pro nas nepotreb
                            nych)
                      00197         PROG_PAGE_1
0BDE   158A               M                         bsf PCLATH,3
0BDF   120A               M                         bcf PCLATH,4
                      00198 
0BE0                  00199 SKOC_NA_ZAZNAM_MAME_ZAZNAM
0BE0   3000           00200         movlw h'00'
0BE1   00BB           00201         movwf POZICE 
0BE2   2BE5           00202         goto SKOC_NA_ZAZNAM_KONEC
0BE3                  00203 SKOC_NA_ZAZNAM_MIMO_ROZSAH
0BE3   30FF           00204         movlw h'FF'
0BE4   00BB           00205         movwf POZICE 
0BE5                  00206 SKOC_NA_ZAZNAM_KONEC
0BE5   0008           00207         return
                      00208 ;**************************************************************************
0BE6                  00209 FILE_INFO
                      00210         ; z disku nam ted ma prijit 32bytu dat, ktere reprezentuji jeden zaznam ve slozce
                      00211         ; tato procedura zaznam precte, analyzuje, a do bufferu 2 da nasledujici informace:
                      00212         ;               1.     byte ->  = 00h -> zaznam je prazdny; 
                      00213         ;                                               = 01h -> zaznam je adresar; 
                      00214         ;                                               = 02h -> zaznam je soubor; 
                      00215         ;                                               = 06h -> zaznam je soubor s priponou MP3
                      00216         ;               2..9   byte -> 8 znaku dlouhe jmeno ("DOSovsky" tvar - napr. slouzka "dokumenty"
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 89


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                             = "DOKUME~1" )
                      00217         ;               10..12 byte -> u souboru tri znaky pripony (u adresaru vetsinou mezery - 20h 20h
                             20h)
                      00218         ;               13..16 byte -> 1. cluster souboru
                      00219         ; Pokud se jedna o adresar, a zaznam o pripone se nerovna 0x202020 (tri mezery), tak skutecne jm
                            eno adresare je : ADRESAR.PRI
                      00220         INDF_BANK_2
0BE6   1783               M                         bsf STATUS,IRP    
0BE7   3010           00221         movlw 0x10                                      ; 1. byte bufferu 2
0BE8   0084           00222         movwf FSR
0BE9   3000           00223         movlw .0                                        ; zatim nevime co zaznam obsahuje, tak ho oznaci
                            me jako prazdny
0BEA   0080           00224         movwf INDF
0BEB   0A84           00225         incf FSR,F      
                      00226 
0BEC   3005           00227         movlw .5                                        ; 5 slov = 10 bytu -> 8 znaku jmena souboru/sloz
                            ky + 2 znaky pripony
0BED   00B6           00228         movwf TEMP1
0BEE                  00229 FILE_INFO__READ_NAME
                      00230         PROG_PAGE_0
0BEE   118A               M                         bcf PCLATH,3
0BEF   120A               M                         bcf PCLATH,4
0BF0   2254           00231         call READ_DATA                          ; 2 znaky jmena souboru/slozky, nebo pripony souboru
                      00232         PROG_PAGE_1
0BF1   158A               M                         bsf PCLATH,3
0BF2   120A               M                         bcf PCLATH,4
0BF3   0820           00233         movfw DATA_L
0BF4   0080           00234         movwf INDF
0BF5   0A84           00235         incf FSR,F
0BF6   0821           00236         movfw DATA_H
0BF7   0080           00237         movwf INDF
0BF8   0A84           00238         incf FSR,F
0BF9   03B6           00239         decf TEMP1,F
0BFA   1D03           00240         btfss STATUS,Z
0BFB   2BEE           00241         goto FILE_INFO__READ_NAME       
                      00242 
                      00243         PROG_PAGE_0
0BFC   118A               M                         bcf PCLATH,3
0BFD   120A               M                         bcf PCLATH,4
0BFE   2254           00244         call READ_DATA                          ; posledni znak pripony a byt s atributy souboru
                      00245         PROG_PAGE_1
0BFF   158A               M                         bsf PCLATH,3
0C00   120A               M                         bcf PCLATH,4
0C01   0820           00246         movfw DATA_L
0C02   0080           00247         movwf INDF
                      00248 
0C03   3011           00249         movlw 0x11                                      ; 2. byte bufferu 2 -> 1. znak jmena souboru
0C04   0084           00250         movwf FSR
0C05   0800           00251         movfw INDF                                      ; ted ve W mame 1. znak jmena souboru/slozky
0C06   39FF           00252         andlw h'FF'
0C07   1903           00253         btfsc STATUS,Z
0C08   2C59           00254         goto FILE_INFO__CTI20_KONEC             ; pokud 1. znak jmena souboru = 00h, je zaznam prazdny
0C09   3CE5           00255         sublw h'E5'
0C0A   1903           00256         btfsc STATUS,Z
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 90


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0C0B   2C59           00257         goto FILE_INFO__CTI20_KONEC             ; pokud 1. znak jmena souboru = E5h, je zaznam prazdny
                      00258         
                      00259         ; pokud jsme tady, tak zaznam obsahuje soubor, adresar, dlouhe jmeno souboru, nebo jmenovku disk
                            u 
                      00260         ; (jsou dva zpusoby jak zapsat jmenovku svazku, bud do spousteciho zaznamu, nebo jako polozku RO
                            OT adresare)
0C0C   0821           00261         movfw DATA_H                            ; byt s atributy souboru
0C0D   390F           00262         andlw h'0F'
0C0E   3C0F           00263         sublw h'0F'                                     ; if (atributy and 0Fh) = 0Fh -> zaznam s dlouhy
                            m nazvem souboru
0C0F   1903           00264         btfsc STATUS,Z
0C10   2C59           00265         goto FILE_INFO__CTI20_KONEC             ; pokud zaznam je dlouhy nazav souboru, koncime
0C11   19A1           00266         btfsc DATA_H,3
0C12   2C59           00267         goto FILE_INFO__CTI20_KONEC             ; if (atributy and 08h) = 08h -> jmenovka disku
0C13   1A21           00268         btfsc DATA_H,4                          ; if (atributy and 16h) = 16h -> adresar
0C14   2C2A           00269         goto FILE_INFO__DIR
                      00270 
0C15   3002           00271         movlw h'02'                                     ; zaznam je soubor
0C16   00B6           00272         movwf TEMP1
                      00273         ; tady vime, ze zaznam je soubor, tak se podivame, zda to neni mp3
0C17   3019           00274         movlw 0x19                                      ; 10. byt bufferu 2 -> 1. znak pripony souboru
0C18   0084           00275         movwf FSR
                      00276 
0C19   0800           00277         movfw INDF
0C1A   3C4D           00278         sublw 'M'                                       ; (jmena souboru v "DOSovskem" tvaru maji vzdy v
                            elka pismena)
0C1B   1D03           00279         btfss STATUS,Z
0C1C   2C2C           00280         goto FILE_INFO__FILE
0C1D   0A84           00281         incf FSR,F
0C1E   0800           00282         movfw INDF
0C1F   3C50           00283         sublw 'P'
0C20   1D03           00284         btfss STATUS,Z
0C21   2C2C           00285         goto FILE_INFO__FILE
0C22   0A84           00286         incf FSR,F
0C23   0800           00287         movfw INDF
0C24   3C33           00288         sublw '3'
0C25   1D03           00289         btfss STATUS,Z
0C26   2C2C           00290         goto FILE_INFO__FILE
                      00291 
0C27   3006           00292         movlw h'06'                                     ; ted je jasne, ze soubor je mp3
0C28   00B6           00293         movwf TEMP1
0C29   2C2C           00294         goto FILE_INFO__FILE
                      00295 
0C2A                  00296 FILE_INFO__DIR
0C2A   3001           00297         movlw h'01'                                     ; zaznam je adresar
0C2B   00B6           00298         movwf TEMP1
                      00299 
0C2C                  00300 FILE_INFO__FILE
                      00301         ; tady mame v TEMP 1 jednu z nasledujicich hodnot:
                      00302         ; 01h -> zaznam je adresar; 02h -> zaznam je soubor; 06h -> zaznam je soubor s priponou MP3
0C2C   3010           00303         movlw 0x10                                      ; 1. byt bufferu 2 -> identifikace zaznamu
0C2D   0084           00304         movwf FSR
0C2E   0836           00305         movfw TEMP1
0C2F   0080           00306         movwf INDF
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 91


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00307 
0C30   3004           00308         movlw .4
0C31   00B6           00309         movwf TEMP1
                      00310         PROG_PAGE_0
0C32   118A               M                         bcf PCLATH,3
0C33   120A               M                         bcf PCLATH,4
0C34   226F           00311         call PRESKOC                            ; nasledujicich 8 bytu ze zaznamu je pro nas k nicemu (o
                            bsahuji cas posledni upravy, otevreni a buh vi co jeste...)
                      00312         PROG_PAGE_1
0C35   158A               M                         bsf PCLATH,3
0C36   120A               M                         bcf PCLATH,4
                      00313 
0C37   301E           00314         movlw 0x1E                                      ; 15. byt bufferu 2 -> 2. byt prvniho clusteru
0C38   0084           00315         movwf FSR
                      00316         PROG_PAGE_0
0C39   118A               M                         bcf PCLATH,3
0C3A   120A               M                         bcf PCLATH,4
0C3B   2254           00317         call READ_DATA                          ; jedno slovo -> horni cast cisla prvniho clusteru
                      00318         PROG_PAGE_1
0C3C   158A               M                         bsf PCLATH,3
0C3D   120A               M                         bcf PCLATH,4
0C3E   0820           00319         movfw DATA_L
0C3F   0080           00320         movwf INDF
0C40   0A84           00321         incf FSR,F
0C41   0821           00322         movfw DATA_H
0C42   0080           00323         movwf INDF
                      00324 
                      00325         PROG_PAGE_0
0C43   118A               M                         bcf PCLATH,3
0C44   120A               M                         bcf PCLATH,4
0C45   2254           00326         call READ_DATA                          ; cas vytvoreni   (1 word)
0C46   2254           00327         call READ_DATA                          ; datum vytvoreni (1 word)
                      00328 
0C47   301C           00329         movlw 0x1C                                      ; 13. byt bufferu 2 -> 0. byt prvniho clusteru
0C48   0084           00330         movwf FSR
0C49   2254           00331         call READ_DATA                          ; jedno slovo -> dolni cast cisla prvniho clusteru
                      00332         PROG_PAGE_1
0C4A   158A               M                         bsf PCLATH,3
0C4B   120A               M                         bcf PCLATH,4
0C4C   0820           00333         movfw DATA_L
0C4D   0080           00334         movwf INDF
0C4E   0A84           00335         incf FSR,F
0C4F   0821           00336         movfw DATA_H
0C50   0080           00337         movwf INDF
                      00338         
                      00339         ; Pak jsou v zaznamu jeste 4 byty, ktere obsahuji velikost souboru. Ty mi sice nepotrebujeme,
                      00340         ; musime je ale precist, aby jsme precetli vsech 32 bytu zaznamu
0C51   3002           00341         movlw .2
0C52   00B6           00342         movwf TEMP1
                      00343         PROG_PAGE_0
0C53   118A               M                         bcf PCLATH,3
0C54   120A               M                         bcf PCLATH,4
0C55   226F           00344         call PRESKOC
                      00345         PROG_PAGE_1
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 92


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0C56   158A               M                         bsf PCLATH,3
0C57   120A               M                         bcf PCLATH,4
0C58   0008           00346         return
0C59                  00347 FILE_INFO__CTI20_KONEC
0C59   300A           00348         movlw .10
0C5A   00B6           00349         movwf TEMP1
                      00350         PROG_PAGE_0
0C5B   118A               M                         bcf PCLATH,3
0C5C   120A               M                         bcf PCLATH,4
0C5D   226F           00351         call PRESKOC
                      00352         PROG_PAGE_1
0C5E   158A               M                         bsf PCLATH,3
0C5F   120A               M                         bcf PCLATH,4
0C60   0008           00353         return
                      00354 ;**************************************************************************
0C61                  00355 FILE_SIZE
                      00356         ; z disku nam ted ma prijit 32bytu dat, ktere reprezentuji jeden zaznam ve slozce
                      00357         ; Zaznam by mel byt soubor, podprogram toto nekontroluje (zda zaznam neni adresar)
                      00358         ; Na zacatek bufferu 1 da 4 byty obsahujici velikost zaznamu
0C61   300E           00359         movlw .14                                       ; my ted potrebujeme jen posledni 4 byty ze zazn
                            amu, tam se nachazi velikost souboru
0C62   00B6           00360         movwf TEMP1
                      00361         PROG_PAGE_0
0C63   118A               M                         bcf PCLATH,3
0C64   120A               M                         bcf PCLATH,4
0C65   226F           00362         call PRESKOC
                      00363         PROG_PAGE_1
0C66   158A               M                         bsf PCLATH,3
0C67   120A               M                         bcf PCLATH,4
                      00364 
                      00365         INDF_BANK_2
0C68   1783               M                         bsf STATUS,IRP    
0C69   3010           00366         movlw 0x10                                      ; 1. byte bufferu 1
0C6A   0084           00367         movwf FSR
                      00368 
                      00369         PROG_PAGE_0
0C6B   118A               M                         bcf PCLATH,3
0C6C   120A               M                         bcf PCLATH,4
0C6D   2254           00370         call READ_DATA
0C6E   0820           00371         movfw DATA_L
0C6F   0080           00372         movwf INDF
0C70   0A84           00373         incf FSR,F
0C71   0821           00374         movfw DATA_H
0C72   0080           00375         movwf INDF
0C73   0A84           00376         incf FSR,F
                      00377 
0C74   2254           00378         call READ_DATA
                      00379         PROG_PAGE_1
0C75   158A               M                         bsf PCLATH,3
0C76   120A               M                         bcf PCLATH,4
0C77   0820           00380         movfw DATA_L
0C78   0080           00381         movwf INDF
0C79   0A84           00382         incf FSR,F
0C7A   0821           00383         movfw DATA_H
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 93


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0C7B   0080           00384         movwf INDF
0C7C   0A84           00385         incf FSR,F
                      00386 
0C7D   0008           00387         return
                      00388 ;**************************************************************************
0C7E                  00389 HLEDEJ
                      00390 ; !!!! pozor, tato procedura potrebuje min. 6 mist ve STACKu (vcetne sama sebe)
                      00391 
                      00392 ; mocna procedura, ktera nam podle zadanych parametru vyhleda pozadovany zaznam 
                      00393 ; a umisti jej do bufferu2 na offset 32 (do horni poloviny bufferu)
                      00394 
                      00395 ; ZAZNAM V DRUHE POLOVINE BUFFERU2 MA NASLEDUJICI STRUKTURU:
                      00396 ;       1. byte:        = 00h -> zadny vyhovujici zaznam nebyl nalezen
                      00397 ;                               = 01h -> zaznam je adresar
                      00398 ;                               = 02h -> zaznam je soubor; 
                      00399 ;                               = 06h -> zaznam je soubor s priponou MP3
                      00400 ;       2..9   byte -> 8 znaku dlouhe jmeno ("DOSovsky" tvar - napr. slouzka "dokumenty" = "DOKUME~1" )
                      00401 ;       10..12 byte -> u souboru tri znaky pripony (u adresaru vetsinou mezery - 20h 20h 20h)
                      00402 ;       13..16 byte -> 1. cluster souboru
                      00403 ;       17..18 byte -> cislo zaznamu v adresari
                      00404 
                      00405 ;       HL_PARAMETRY    -- parametry hledani
                      00406 ;       HL_ADR_CL[1-4]  -- prnvi cluster prohledavaneho adresare
                      00407 ;       ZAZNAM[1-2]             -- zaznam od ktereho hledame
                      00408 
                      00409 ; Filozofie je takova, ze v bufferu 1 mame ulozen zaznam vuci kteremu vyhledavame (ZAZ_REF),
                      00410 ; v dolni polovine bufferu 2 mame ulozen zaznam, ktery jsme prave precetli (ZAZ_A)
                      00411 ; a v hodni polovine bufferu 2 zaznam, ktery zatim byl nejblize k pozadovanemu zaznamu (ZAZ_N).
                      00412 
                      00413 ; Hruby vyvojak by pak mohl vypadat takto:
                      00414 ;******************************************************************************************************
                      00415 ; if ((HL_PARAMETRY = [prvni]):
                      00416 ;       if (CLUSTER = ROOT):
                      00417 ;               HL_PARAMETRY := [dalsi]
                      00418 ;               ZAZ_REF := 0x0000000.....
                      00419 ;               goto hledej_hledani
                      00420 ;       else:
                      00421 ;               ZAZ_N naplnit daty ze zaznamu 1 // prvni polozkou vsech adresaru krome ROOTu jsou ".."
                      00422 ;               goto hledej_konec
                      00423 ;       endif;
                      00424 ; endif;
                      00425 
                      00426 ; if ((CLUSTER != ROOT) and (ZAZNAM<2)):
                      00427 ;               if (HL_PARAMETRY = [dalsi]):
                      00428 ;                       ZAZ_REF := 0x0000000.....
                      00429 ;                       goto hledej_hledani
                      00430 ;               else:
                      00431 ;                       goto hledej_konec
                      00432 ;               endif;
                      00433 ; endif;
                      00434 ;
                      00435 ; ZAZ_REF naplnit daty ze zaznamu ZAZNAM
                      00436 ; ZAZNAM := 0
                      00437 ; if (CLUSTER != ROOT):
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 94


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00438 ;               ZAZNAM :=2
                      00439 ; end;
                      00440 ;
                      00441 ; repeat
                      00442 ;       nacti_zaznam
                      00443 ;       IF     (hledame dalsi zaznam)     AND (ZAZ_A > ZAZ_REF) AND ((ZAZ_A < ZAZ_N) OR (ZAZ_N is empty)
                            ):
                      00444 ;                       ZAZ_N := ZAZ_A
                      00445 ;       ELSEIF (hledame predchozi zaznam) AND (ZAZ_A < ZAZ_REF) AND (ZAZ_A > ZAZ_N):
                      00446 ;                       ZAZ_N := ZAZ_A
                      00447 ;       ENDIF
                      00448 ;       zaznam++
                      00449 ; until (byl zaznam posledni)
                      00450 ;
                      00451 ; if (HL_PARAMETRY = [predchozi]) and (ZAZ_N = 00000) and (!ROOT):
                      00452 ;       ZAZ_N naplnit daty ze zaznamu 1
                      00453 ; endif;
                      00454 ; KONEC
                      00455 ;******************************************************************************************************
                      00456         PROG_PAGE_0
0C7E   118A               M                         bcf PCLATH,3
0C7F   120A               M                         bcf PCLATH,4
0C80   2285           00457         call CLEAR_BUFFER2              ; vymazeme si buffer2, abychom tam nemeli bordel
                      00458         PROG_PAGE_1
0C81   158A               M                         bsf PCLATH,3
0C82   120A               M                         bcf PCLATH,4
0C83   25E2           00459         call CLEAR_BUFFER1              ; vymazeme si buffer1, abychom tam nemeli bordel
                      00460 
0C84   085A           00461         movfw HL_ADR_CL1
0C85   00BC           00462         movwf CLUSTER1
0C86   085B           00463         movfw HL_ADR_CL2
0C87   00BD           00464         movwf CLUSTER2
0C88   085C           00465         movfw HL_ADR_CL3
0C89   00BE           00466         movwf CLUSTER3
0C8A   085D           00467         movfw HL_ADR_CL4
0C8B   00BF           00468         movwf CLUSTER4
                      00469 
                      00470         ; protoze to budeme v nasledujicim kodu potrebova, nastavime si 7. bit HL_PARAMETRY podle toho, 
                      00471         ; zda predany adresar je ROOT ci nikoliv
0C8C   13D9           00472         bcf HL_PARAMETRY,7
0C8D   30FF           00473         movlw h'FF'     
0C8E   05BC           00474         andwf CLUSTER1,F
0C8F   1D03           00475         btfss STATUS,Z
0C90   17D9           00476                 bsf HL_PARAMETRY,7
0C91   05BD           00477         andwf CLUSTER2,F
0C92   1D03           00478         btfss STATUS,Z
0C93   17D9           00479                 bsf HL_PARAMETRY,7
0C94   05BE           00480         andwf CLUSTER3,F
0C95   1D03           00481         btfss STATUS,Z
0C96   17D9           00482                 bsf HL_PARAMETRY,7
0C97   05BF           00483         andwf CLUSTER4,F
0C98   1D03           00484         btfss STATUS,Z
0C99   17D9           00485                 bsf HL_PARAMETRY,7
                      00486 
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 95


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00487 
0C9A   1DD9           00488         btfss HL_PARAMETRY,3                    ; if ((HL_PARAMETRY = [prvni]):
0C9B   2CA8           00489         goto HLEDEJ_NEHLEDAME_PRVNI
0C9C   1BD9           00490         btfsc HL_PARAMETRY,7                    ;               IF (CLUSTER = ROOT):
0C9D   2CA0           00491         goto HLEDEJ_ELSE1
0C9E   1259           00492         bcf HL_PARAMETRY,4
0C9F   2CBE           00493         goto HLEDEJ_HLEDANI
0CA0                  00494 HLEDEJ_ELSE1                                            ;               ELSE:
0CA0   3001           00495         movlw .1
0CA1   00E0           00496         movwf ZAZNAM1
0CA2   01E1           00497         clrf ZAZNAM2
0CA3   236B           00498         call SKOC_NA_ZAZNAM     
0CA4   23E6           00499         call FILE_INFO
0CA5   2510           00500         call ZAPIS_C_ZAZNAMU
0CA6   262C           00501         call BUF2_LOW_TO_HIGH
0CA7   2D0F           00502         goto HLEDEJ_KONEC                               ;               ENDIF;
0CA8                  00503 HLEDEJ_NEHLEDAME_PRVNI                          ; ENDIF 
                      00504 
0CA8   1FD9           00505         btfss HL_PARAMETRY,7
0CA9   2CB8           00506         goto HLEDEJ_IF2_ENDIF
0CAA   0861           00507         movfw ZAZNAM2 
0CAB   39FF           00508         andlw h'FF'
0CAC   1D03           00509         btfss STATUS,Z
0CAD   2CB8           00510         goto HLEDEJ_IF2_ENDIF
0CAE   0860           00511         movfw ZAZNAM1
0CAF   39FF           00512         andlw h'FF'
0CB0   1903           00513         btfsc STATUS,Z
0CB1   2CB5           00514         goto IF2
0CB2   3C01           00515         sublw .1
0CB3   1D03           00516         btfss STATUS,Z
0CB4   2CB8           00517         goto HLEDEJ_IF2_ENDIF                   ; if ((CLUSTER != ROOT) and (ZAZNAM < 2)):
0CB5                  00518 IF2
0CB5   1A59           00519         btfsc HL_PARAMETRY,4                    ;               if (HL_PARAMETRY = [predchozi]):
0CB6   2D0F           00520         goto HLEDEJ_KONEC                               ;               ... else:
0CB7   2CBE           00521         goto HLEDEJ_HLEDANI                             ;               ... endif;
0CB8                  00522 HLEDEJ_IF2_ENDIF                                        ; endif
                      00523 
0CB8   236B           00524         call SKOC_NA_ZAZNAM             ; - pokud ZAZNAM[1-2] ukazuji mimo adresar, vrati v POZICE FFh (
                            jinak 00h)
0CB9   183B           00525         btfsc POZICE,0
0CBA   2D0F           00526         goto HLEDEJ_KONEC       
0CBB   23E6           00527         call FILE_INFO
0CBC   2510           00528         call ZAPIS_C_ZAZNAMU    
0CBD   25EE           00529         call BUF2_TO_BUF1
                      00530 
0CBE                  00531 HLEDEJ_HLEDANI  
0CBE   01E0           00532         clrf ZAZNAM1
0CBF   01E1           00533         clrf ZAZNAM2
0CC0   1BD9           00534         btfsc HL_PARAMETRY,7
0CC1   14E0           00535         bsf ZAZNAM1,1                   ; if (!ROOT): ZAZNAM = 2; endif;
0CC2   01DE           00536         clrf ZAZNAMU_vBUFFERU_DISKU
0CC3                  00537 HLEDEJ_REPEAT
0CC3   085A           00538         movfw HL_ADR_CL1
0CC4   00BC           00539         movwf CLUSTER1
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 96


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0CC5   085B           00540         movfw HL_ADR_CL2
0CC6   00BD           00541         movwf CLUSTER2
0CC7   085C           00542         movfw HL_ADR_CL3
0CC8   00BE           00543         movwf CLUSTER3
0CC9   085D           00544         movfw HL_ADR_CL4
0CCA   00BF           00545         movwf CLUSTER4
                      00546 
                      00547 
0CCB   01BB           00548         clrf POZICE
0CCC   085E           00549         movfw ZAZNAMU_vBUFFERU_DISKU
0CCD   39FF           00550         andlw h'FF'
0CCE   1903           00551         btfsc STATUS,Z                  ; pokud jeste nejake po sobe jdouci zaznamy jsou pripraveny v bu
                            fferu disku, tak nemusime volat SKOC_NA_ZAZNAM
0CCF   236B           00552         call SKOC_NA_ZAZNAM             ; - pokud ZAZNAM[1-2] ukazuji mimo adresar, vrati v POZICE FFh (
                            jinak 00h)
0CD0   183B           00553         btfsc POZICE,0
0CD1   2CF4           00554         goto HLEDEJ_END_REPEAT
                      00555 
0CD2   03DE           00556         decf ZAZNAMU_vBUFFERU_DISKU,f   ; ted jeden zaznam precteme, proto jich bude v bufferu disku o j
                            eden min
0CD3   23E6           00557         call FILE_INFO
0CD4   2510           00558         call ZAPIS_C_ZAZNAMU
                      00559 
0CD5   0AE0           00560         incf ZAZNAM1,f
0CD6   1903           00561         btfsc STATUS,Z
0CD7   0AE1           00562         incf ZAZNAM2,f
                      00563 
0CD8   251D           00564         call VYHOVUJE_ZAZNAM
0CD9   1C36           00565         btfss TEMP1,0
0CDA   2CC3           00566         goto HLEDEJ_REPEAT
                      00567         
                      00568 ;       movlw .16
                      00569 ;       movwf TEMP1
                      00570 ;       PROG_PAGE_0
                      00571 ;       call ODESLI_BUFFER2                     ; odesleme si zaznam o souboru  
                      00572 ;       call DELAY_500ms    
                      00573 ;       PROG_PAGE_1
                      00574 
                      00575 ;       IF     (hledame dalsi zaznam)
                      00576 ;               IF (ZAZ_A > ZAZ_REF) AND ((ZAZ_A < ZAZ_N) OR (ZAZ_N is empty)):
                      00577 ;                       ZAZ_N := ZAZ_A
                      00578 ;               ENDIF
                      00579 ;       ELSEIF (hledame predchozi zaznam)
                      00580 ;               IF (ZAZ_A < ZAZ_REF) AND (ZAZ_A > ZAZ_N):
                      00581 ;                       ZAZ_N := ZAZ_A
                      00582 ;               ENDIF
                      00583 ;       ENDIF
0CDB   2552           00584         call COMPARE_BUFF1_BUFF2
                      00585         ; porovna nazvy souboru na zacatku bufferu1 s bufferem2
                      00586         ; pokud v abecede je driv nazev v bufferu1 da to TEMP1 0x01
                      00587         ; pokud v abecede je driv nazev v bufferu2 da to TEMP1 0x02
                      00588         ; pokud se nazvy shoduji da do TEMP1 0x00
0CDC   1A59           00589         btfsc HL_PARAMETRY,4            ;       IF     (hledame dalsi zaznam)
0CDD   2CED           00590         goto HLEDEJ_ELSE3
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 97


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0CDE   1C36           00591         btfss TEMP1,0                           ;               IF (ZAZ_A > ZAZ_REF)
0CDF   2CF3           00592         goto HLEDEJ_ENDIF3
                      00593 
                      00594         BANK_2
0CE0   1703               M                 bsf     STATUS,RP1              ; BANK2  RP1:RP0 = 10
0CE1   1283               M                 bcf     STATUS,RP0    
0CE2   0830           00595         movfw 0x30
                      00596         BANK_0
0CE3   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0CE4   1283               M                 bcf     STATUS,RP0    
0CE5   39FF           00597         andlw h'FF'
0CE6   1903           00598         btfsc STATUS,Z
0CE7   2CEB           00599         goto HLEDEJ_IF4
                      00600 
0CE8   253F           00601         call COMPARE_BUFF2_L_H
                      00602         ; porovna nazvy souboru na zacatku bufferu2 a na konci bufferu2
                      00603         ; pokud v abecede je driv nazev v horni polovine buff2 da to TEMP1 0x01
                      00604         ; pokud v abecede je driv nazev v dolni polovine buff2 da to TEMP1 0x02
                      00605         ; pokud se nazvy shoduji da do TEMP1 0x00
0CE9   1CB6           00606         btfss TEMP1,1
0CEA   2CF3           00607         goto HLEDEJ_ENDIF3
0CEB                  00608 HLEDEJ_IF4                                              ;               AND ((ZAZ_A < ZAZ_N) OR (ZAZ_N i
                            s empty)):
0CEB   262C           00609         call BUF2_LOW_TO_HIGH           ;                               ZAZ_N := ZAZ_A
0CEC   2CF3           00610         goto HLEDEJ_ENDIF3                      ;               ENDIF
0CED                  00611 HLEDEJ_ELSE3                                    ;       ELSEIF (hledame predchozi zaznam)
0CED   1CB6           00612         btfss TEMP1,1                           ;               IF (ZAZ_A < ZAZ_REF)
0CEE   2CF3           00613         goto HLEDEJ_ENDIF3
0CEF   253F           00614         call COMPARE_BUFF2_L_H
0CF0   1C36           00615         btfss TEMP1,0                           ;               AND (ZAZ_A > ZAZ_N):
0CF1   2CF3           00616         goto HLEDEJ_ENDIF3
0CF2   262C           00617         call BUF2_LOW_TO_HIGH           ;                               ZAZ_N := ZAZ_A
0CF3                  00618 HLEDEJ_ENDIF3                                   ;       ENDIF
                      00619         
0CF3   2CC3           00620         goto HLEDEJ_REPEAT
0CF4                  00621 HLEDEJ_END_REPEAT
                      00622 
                      00623 ; if (HL_PARAMETRY = [predchozi]) and (ZAZ_N = 00000) and (!ROOT):
                      00624 ;       ZAZ_N naplnit daty ze zaznamu 1
                      00625 ; endif;
0CF4   1E59           00626         btfss HL_PARAMETRY,4            ; if (HL_PARAMETRY = [predchozi])
0CF5   2D0F           00627         goto HLEDEJ_KONEC
0CF6   1FD9           00628         btfss HL_PARAMETRY,7            ;       and (!ROOT)
0CF7   2D0F           00629         goto HLEDEJ_KONEC
                      00630         BANK_2
0CF8   1703               M                 bsf     STATUS,RP1              ; BANK2  RP1:RP0 = 10
0CF9   1283               M                 bcf     STATUS,RP0    
0CFA   0830           00631         movfw 0x30
                      00632         BANK_0
0CFB   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0CFC   1283               M                 bcf     STATUS,RP0    
0CFD   39FF           00633         andlw h'FF'
0CFE   1D03           00634         btfss STATUS,Z                          ;       and (ZAZ_N is empty):
0CFF   2D0F           00635         goto HLEDEJ_KONEC
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 98


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00636 
0D00   085A           00637         movfw HL_ADR_CL1
0D01   00BC           00638         movwf CLUSTER1
0D02   085B           00639         movfw HL_ADR_CL2
0D03   00BD           00640         movwf CLUSTER2
0D04   085C           00641         movfw HL_ADR_CL3
0D05   00BE           00642         movwf CLUSTER3
0D06   085D           00643         movfw HL_ADR_CL4
0D07   00BF           00644         movwf CLUSTER4
0D08   3001           00645         movlw .1
0D09   00E0           00646         movwf ZAZNAM1
0D0A   01E1           00647         clrf ZAZNAM2
0D0B   236B           00648         call SKOC_NA_ZAZNAM     
0D0C   23E6           00649         call FILE_INFO
0D0D   2510           00650         call ZAPIS_C_ZAZNAMU
0D0E   262C           00651         call BUF2_LOW_TO_HIGH
                      00652 
0D0F                  00653 HLEDEJ_KONEC                                    ; endif;
0D0F   0008           00654         return
                      00655 ;**************************************************************************
0D10                  00656 ZAPIS_C_ZAZNAMU
                      00657         ; podprogram FILE_INFO nam dava vsechny mozny informace o souboru, krome cisla zaznamu, 
                      00658         ; proto si toto cislo musime zapsat sami do bufferu2
0D10   0860           00659         movfw ZAZNAM1
                      00660         BANK_2
0D11   1703               M                 bsf     STATUS,RP1              ; BANK2  RP1:RP0 = 10
0D12   1283               M                 bcf     STATUS,RP0    
0D13   00A0           00661         movwf 0x120
                      00662         BANK_0
0D14   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0D15   1283               M                 bcf     STATUS,RP0    
0D16   0861           00663         movfw ZAZNAM2
                      00664         BANK_2
0D17   1703               M                 bsf     STATUS,RP1              ; BANK2  RP1:RP0 = 10
0D18   1283               M                 bcf     STATUS,RP0    
0D19   00A1           00665         movwf 0x121
                      00666         BANK_0
0D1A   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0D1B   1283               M                 bcf     STATUS,RP0    
0D1C   0008           00667         return
                      00668 ;**************************************************************************
0D1D                  00669 VYHOVUJE_ZAZNAM
                      00670         ; pokud zaznam ZAZ_A v bufferu2 vyhovuje hledani, nastavi bit TEMP1,0
0D1D   01B6           00671         clrf TEMP1
                      00672         BANK_2
0D1E   1703               M                 bsf     STATUS,RP1              ; BANK2  RP1:RP0 = 10
0D1F   1283               M                 bcf     STATUS,RP0    
0D20   0810           00673         movfw 0x110
                      00674         BANK_0
0D21   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0D22   1283               M                 bcf     STATUS,RP0    
                      00675         ;               1.     byte ->  = 00h -> zaznam je prazdny; 
                      00676         ;                                               = 01h -> zaznam je adresar; 
                      00677         ;                                               = 02h -> zaznam je soubor; 
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 99


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00678         ;                                               = 06h -> zaznam je soubor s priponou MP3
0D23   00B7           00679         movwf TEMP2
0D24   39FF           00680         andlw h'FF'
0D25   1903           00681         btfsc STATUS,Z
0D26   0008           00682         return                          ; pokud je zaznam prazdny, tak jej proste neberem
                      00683 ;HL_PARAMETRY   equ 0x059
                      00684 ;               0. bit = 0 > pokud hledáme soubory, tak pouze MP3
;                              1 > pok
                            ud hledáme soubory, vrací všechny soubory
;             1. bit = 0 > hledáme klasicky (nejdøíve 
0D27   1CD9           00685         btfss HL_PARAMETRY,1
0D28   2D36           00686         goto VYHOV_ZAZ_SOUBiADR
0D29   1D59           00687         btfss HL_PARAMETRY,2
0D2A   2D33           00688         goto VYHOV_ZAZ_ONLY_ADR
0D2B   1C59           00689         btfss HL_PARAMETRY,0
0D2C   2D30           00690         goto VYHOV_ZAZ_ONLY_MP3
0D2D                  00691 VYHOV_ZAZ_ALL_FILES
0D2D   1C37           00692         btfss TEMP2,0
0D2E   1436           00693         bsf TEMP1,0
0D2F   0008           00694         return          
0D30                  00695 VYHOV_ZAZ_ONLY_MP3
0D30   1937           00696         btfsc TEMP2,2
0D31   1436           00697         bsf TEMP1,0
0D32   0008           00698         return
0D33                  00699 VYHOV_ZAZ_ONLY_ADR
0D33   1837           00700         btfsc TEMP2,0
0D34   1436           00701         bsf TEMP1,0
0D35   0008           00702         return
0D36                  00703 VYHOV_ZAZ_SOUBiADR
0D36   1C59           00704         btfss HL_PARAMETRY,0
0D37   2D3A           00705         goto VYHOV_ZAZ_SOUBiADR_MP3
0D38   1436           00706         bsf TEMP1,0
0D39   0008           00707         return
0D3A                  00708 VYHOV_ZAZ_SOUBiADR_MP3
0D3A   1837           00709         btfsc TEMP2,0
0D3B   1436           00710         bsf TEMP1,0
0D3C   1937           00711         btfsc TEMP2,2
0D3D   1436           00712         bsf TEMP1,0
0D3E   0008           00713         return
                      00714 ;**************************************************************************
0D3F                  00715 COMPARE_BUFF2_L_H
                      00716 ; porovna nazvy souboru na zacatku bufferu2 a na konci bufferu2
                      00717 ; pokud v abecede je driv nazev v horni polovine buff2 da to TEMP1 0x01
                      00718 ; pokud v abecede je driv nazev v dolni polovine buff2 da to TEMP1 0x02
                      00719 ; pokud se nazvy shoduji da do TEMP1 0x00
0D3F   01B6           00720         clrf TEMP1
                      00721         INDF_BANK_2                     ; stejne jako INDF_BANK_2
0D40   1783               M                         bsf STATUS,IRP    
                      00722         BANK_0
0D41   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0D42   1283               M                 bcf     STATUS,RP0    
0D43   3010           00723         movlw 0x10
0D44   0084           00724         movwf FSR
0D45   0800           00725         movfw INDF
0D46   3903           00726         andlw h'03'                     ; ted nerozlisuji mezi souborem mp3 a ostatnimi soubory
0D47   00B7           00727         movwf TEMP2
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 100


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00728 
0D48   3030           00729         movlw 0x30
0D49   0084           00730         movwf FSR
0D4A   0800           00731         movfw INDF
0D4B   3903           00732         andlw h'03'                     ; ted nerozlisuji mezi souborem mp3 a ostatnimi soubory 
0D4C   0237           00733         subwf TEMP2,W           ; prni byte z bufferu 2 - prvni byte z bufferu 1
                      00734 
0D4D   1903           00735         btfsc STATUS,Z
0D4E   2D65           00736         goto COMPARE_B1_B2_BYT2         ; prvni byt signalizujici typ byl shodny, pokracujeme bytem druh
                            ym (prvni byt nazvu)
0D4F   1C03           00737         btfss STATUS,C
0D50   2DDD           00738         goto COMPARE_B1_B2_BUFF2        ; hodnota v bufferu 1 byla vetsi, proto je v abecede dal...
0D51   2DD8           00739         goto COMPARE_B1_B2_BUFF1
                      00740 ; tato procedura je temer shodna s tou nasledujici, proto jen zadame jinou hodnotu do FSR
                      00741 ; (misto pro buffer1 na horni pulku bufferu2) a nechame probehnout stejny kus kodu...
                      00742 ;**************************************************************************
0D52                  00743 COMPARE_BUFF1_BUFF2
                      00744 ; porovna nazvy souboru na zacatku bufferu1 s bufferem2
                      00745 ; pokud v abecede je driv nazev v bufferu1 da to TEMP1 0x01
                      00746 ; pokud v abecede je driv nazev v bufferu2 da to TEMP1 0x02
                      00747 ; pokud se nazvy shoduji da do TEMP1 0x00
                      00748 
                      00749 ; zaznamy v obou bufferech vypadaji nasledovne:
                      00750 ;               1.     byte ->  = 00h -> zaznam je prazdny; 
                      00751 ;                                               = 01h -> zaznam je adresar; 
                      00752 ;                                               = 02h -> zaznam je soubor; 
                      00753 ;                                               = 06h -> zaznam je soubor s priponou MP3
                      00754 ;               2..9   byte -> 8 znaku dlouhe jmeno ("DOSovsky" tvar - napr. slouzka "dokumenty" = "DOKU
                            ME~1" )
                      00755 ;               10..12 byte -> u souboru tri znaky pripony (u adresaru vetsinou mezery - 20h 20h 20h)
                      00756 ;               13..16 byte -> 1. cluster souboru
0D52   01B6           00757         clrf TEMP1
                      00758         INDF_BANK_3                     ; stejne jako INDF_BANK_2
0D53   1783               M                         bsf STATUS,IRP    
                      00759         BANK_0
0D54   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0D55   1283               M                 bcf     STATUS,RP0    
0D56   3010           00760         movlw 0x10
0D57   0084           00761         movwf FSR
0D58   0800           00762         movfw INDF
0D59   3903           00763         andlw h'03'                     ; ted nerozlisuji mezi souborem mp3 a ostatnimi soubory
0D5A   00B7           00764         movwf TEMP2
                      00765 
0D5B   3090           00766         movlw 0x90
0D5C   0084           00767         movwf FSR
0D5D   0800           00768         movfw INDF
0D5E   3903           00769         andlw h'03'                     ; ted nerozlisuji mezi souborem mp3 a ostatnimi soubory 
0D5F   0237           00770         subwf TEMP2,W           ; prni byte z bufferu 2 - prvni byte z bufferu 1
                      00771 
0D60   1903           00772         btfsc STATUS,Z
0D61   2D65           00773         goto COMPARE_B1_B2_BYT2 ; prvni byt signalizujici typ byl shodny, pokracujeme bytem druhym (prvn
                            i byt nazvu)
0D62   1C03           00774         btfss STATUS,C
0D63   2DDD           00775         goto COMPARE_B1_B2_BUFF2        ; hodnota v bufferu 1 byla vetsi, proto je v abecede dal...
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 101


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0D64   2DD8           00776         goto COMPARE_B1_B2_BUFF1
                      00777 
0D65                  00778 COMPARE_B1_B2_BYT2
                      00779         BANK_2
0D65   1703               M                 bsf     STATUS,RP1              ; BANK2  RP1:RP0 = 10
0D66   1283               M                 bcf     STATUS,RP0    
0D67   0A84           00780         incf FSR,F
0D68   0800           00781         movfw INDF
0D69   0211           00782         subwf 0x111,W                           ; 2. byte z bufferu 2 - 2. byte z bufferu 1
0D6A   1903           00783         btfsc STATUS,Z
0D6B   2D6F           00784         goto COMPARE_B1_B2_BYT3
0D6C   1C03           00785         btfss STATUS,C
0D6D   2DDD           00786         goto COMPARE_B1_B2_BUFF2        ; hodnota v bufferu 1 byla vetsi, proto je v abecede dal...
0D6E   2DD8           00787         goto COMPARE_B1_B2_BUFF1
                      00788 
0D6F                  00789 COMPARE_B1_B2_BYT3
                      00790         BANK_2
0D6F   1703               M                 bsf     STATUS,RP1              ; BANK2  RP1:RP0 = 10
0D70   1283               M                 bcf     STATUS,RP0    
0D71   0A84           00791         incf FSR,F
0D72   0800           00792         movfw INDF
0D73   0212           00793         subwf 0x112,W                           ; 3. byte z bufferu 2 - 3. byte z bufferu 1
0D74   1903           00794         btfsc STATUS,Z
0D75   2D79           00795         goto COMPARE_B1_B2_BYT4
0D76   1C03           00796         btfss STATUS,C
0D77   2DDD           00797         goto COMPARE_B1_B2_BUFF2        ; hodnota v bufferu 1 byla vetsi, proto je v abecede dal...
0D78   2DD8           00798         goto COMPARE_B1_B2_BUFF1
                      00799 
0D79                  00800 COMPARE_B1_B2_BYT4
                      00801         BANK_2
0D79   1703               M                 bsf     STATUS,RP1              ; BANK2  RP1:RP0 = 10
0D7A   1283               M                 bcf     STATUS,RP0    
0D7B   0A84           00802         incf FSR,F
0D7C   0800           00803         movfw INDF
0D7D   0213           00804         subwf 0x113,W                           ; 4. byte z bufferu 2 - 4. byte z bufferu 1
0D7E   1903           00805         btfsc STATUS,Z
0D7F   2D83           00806         goto COMPARE_B1_B2_BYT5
0D80   1C03           00807         btfss STATUS,C
0D81   2DDD           00808         goto COMPARE_B1_B2_BUFF2        ; hodnota v bufferu 1 byla vetsi, proto je v abecede dal...
0D82   2DD8           00809         goto COMPARE_B1_B2_BUFF1
                      00810 
0D83                  00811 COMPARE_B1_B2_BYT5
                      00812         BANK_2
0D83   1703               M                 bsf     STATUS,RP1              ; BANK2  RP1:RP0 = 10
0D84   1283               M                 bcf     STATUS,RP0    
0D85   0A84           00813         incf FSR,F
0D86   0800           00814         movfw INDF
0D87   0214           00815         subwf 0x114,W                           ; 5. byte z bufferu 2 - 5. byte z bufferu 1
0D88   1903           00816         btfsc STATUS,Z
0D89   2D8D           00817         goto COMPARE_B1_B2_BYT6
0D8A   1C03           00818         btfss STATUS,C
0D8B   2DDD           00819         goto COMPARE_B1_B2_BUFF2        ; hodnota v bufferu 1 byla vetsi, proto je v abecede dal...
0D8C   2DD8           00820         goto COMPARE_B1_B2_BUFF1
                      00821 
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 102


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0D8D                  00822 COMPARE_B1_B2_BYT6
                      00823         BANK_2
0D8D   1703               M                 bsf     STATUS,RP1              ; BANK2  RP1:RP0 = 10
0D8E   1283               M                 bcf     STATUS,RP0    
0D8F   0A84           00824         incf FSR,F
0D90   0800           00825         movfw INDF
0D91   0215           00826         subwf 0x115,W                           ; 6. byte z bufferu 2 - 6. byte z bufferu 1
0D92   1903           00827         btfsc STATUS,Z
0D93   2D97           00828         goto COMPARE_B1_B2_BYT7
0D94   1C03           00829         btfss STATUS,C
0D95   2DDD           00830         goto COMPARE_B1_B2_BUFF2        ; hodnota v bufferu 1 byla vetsi, proto je v abecede dal...
0D96   2DD8           00831         goto COMPARE_B1_B2_BUFF1
                      00832 
0D97                  00833 COMPARE_B1_B2_BYT7
                      00834         BANK_2
0D97   1703               M                 bsf     STATUS,RP1              ; BANK2  RP1:RP0 = 10
0D98   1283               M                 bcf     STATUS,RP0    
0D99   0A84           00835         incf FSR,F
0D9A   0800           00836         movfw INDF
0D9B   0216           00837         subwf 0x116,W                           ; 7. byte z bufferu 2 - 7. byte z bufferu 1
0D9C   1903           00838         btfsc STATUS,Z
0D9D   2DA1           00839         goto COMPARE_B1_B2_BYT8
0D9E   1C03           00840         btfss STATUS,C
0D9F   2DDD           00841         goto COMPARE_B1_B2_BUFF2        ; hodnota v bufferu 1 byla vetsi, proto je v abecede dal...
0DA0   2DD8           00842         goto COMPARE_B1_B2_BUFF1
                      00843 
0DA1                  00844 COMPARE_B1_B2_BYT8
                      00845         BANK_2
0DA1   1703               M                 bsf     STATUS,RP1              ; BANK2  RP1:RP0 = 10
0DA2   1283               M                 bcf     STATUS,RP0    
0DA3   0A84           00846         incf FSR,F
0DA4   0800           00847         movfw INDF
0DA5   0217           00848         subwf 0x117,W                           ; 8. byte z bufferu 2 - 8. byte z bufferu 1
0DA6   1903           00849         btfsc STATUS,Z
0DA7   2DAB           00850         goto COMPARE_B1_B2_BYT9
0DA8   1C03           00851         btfss STATUS,C
0DA9   2DDD           00852         goto COMPARE_B1_B2_BUFF2        ; hodnota v bufferu 1 byla vetsi, proto je v abecede dal...
0DAA   2DD8           00853         goto COMPARE_B1_B2_BUFF1
                      00854 
0DAB                  00855 COMPARE_B1_B2_BYT9
                      00856         BANK_2
0DAB   1703               M                 bsf     STATUS,RP1              ; BANK2  RP1:RP0 = 10
0DAC   1283               M                 bcf     STATUS,RP0    
0DAD   0A84           00857         incf FSR,F
0DAE   0800           00858         movfw INDF
0DAF   0218           00859         subwf 0x118,W                           ; 9. byte z bufferu 2 - 9. byte z bufferu 1
0DB0   1903           00860         btfsc STATUS,Z
0DB1   2DB5           00861         goto COMPARE_B1_B2_BYT10
0DB2   1C03           00862         btfss STATUS,C
0DB3   2DDD           00863         goto COMPARE_B1_B2_BUFF2        ; hodnota v bufferu 1 byla vetsi, proto je v abecede dal...
0DB4   2DD8           00864         goto COMPARE_B1_B2_BUFF1
                      00865 
0DB5                  00866 COMPARE_B1_B2_BYT10
                      00867         BANK_2
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 103


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0DB5   1703               M                 bsf     STATUS,RP1              ; BANK2  RP1:RP0 = 10
0DB6   1283               M                 bcf     STATUS,RP0    
0DB7   0A84           00868         incf FSR,F
0DB8   0800           00869         movfw INDF
0DB9   0219           00870         subwf 0x119,W                           ; 10. byte z bufferu 2 - 10. byte z bufferu 1
0DBA   1903           00871         btfsc STATUS,Z
0DBB   2DBF           00872         goto COMPARE_B1_B2_BYT11
0DBC   1C03           00873         btfss STATUS,C
0DBD   2DDD           00874         goto COMPARE_B1_B2_BUFF2        ; hodnota v bufferu 1 byla vetsi, proto je v abecede dal...
0DBE   2DD8           00875         goto COMPARE_B1_B2_BUFF1
                      00876 
0DBF                  00877 COMPARE_B1_B2_BYT11
                      00878         BANK_2
0DBF   1703               M                 bsf     STATUS,RP1              ; BANK2  RP1:RP0 = 10
0DC0   1283               M                 bcf     STATUS,RP0    
0DC1   0A84           00879         incf FSR,F
0DC2   0800           00880         movfw INDF
0DC3   021A           00881         subwf 0x11A,W                           ; 11. byte z bufferu 2 - 11. byte z bufferu 1
0DC4   1903           00882         btfsc STATUS,Z
0DC5   2DC9           00883         goto COMPARE_B1_B2_BYT12
0DC6   1C03           00884         btfss STATUS,C
0DC7   2DDD           00885         goto COMPARE_B1_B2_BUFF2        ; hodnota v bufferu 1 byla vetsi, proto je v abecede dal...
0DC8   2DD8           00886         goto COMPARE_B1_B2_BUFF1
                      00887 
0DC9                  00888 COMPARE_B1_B2_BYT12
                      00889         BANK_2
0DC9   1703               M                 bsf     STATUS,RP1              ; BANK2  RP1:RP0 = 10
0DCA   1283               M                 bcf     STATUS,RP0    
0DCB   0A84           00890         incf FSR,F
0DCC   0800           00891         movfw INDF
0DCD   021B           00892         subwf 0x11B,W                           ; 12. byte z bufferu 2 - 12. byte z bufferu 1
0DCE   1903           00893         btfsc STATUS,Z
0DCF   2DD3           00894         goto COMPARE_B1_B2_SHODNE
0DD0   1C03           00895         btfss STATUS,C
0DD1   2DDD           00896         goto COMPARE_B1_B2_BUFF2        ; hodnota v bufferu 1 byla vetsi, proto je v abecede dal...
0DD2   2DD8           00897         goto COMPARE_B1_B2_BUFF1
                      00898 
0DD3                  00899 COMPARE_B1_B2_SHODNE
                      00900         BANK_0
0DD3   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0DD4   1283               M                 bcf     STATUS,RP0    
0DD5   3000           00901         movlw h'00'
0DD6   00B6           00902         movwf TEMP1     
0DD7   0008           00903         return
0DD8                  00904 COMPARE_B1_B2_BUFF1
                      00905         BANK_0
0DD8   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0DD9   1283               M                 bcf     STATUS,RP0    
0DDA   3001           00906         movlw h'01'
0DDB   00B6           00907         movwf TEMP1     
0DDC   0008           00908         return
0DDD                  00909 COMPARE_B1_B2_BUFF2
                      00910         BANK_0
0DDD   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 104


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0DDE   1283               M                 bcf     STATUS,RP0    
0DDF   3002           00911         movlw h'02'
0DE0   00B6           00912         movwf TEMP1
0DE1   0008           00913         return
                      00914 ;**************************************************************************
0DE2                  00915 CLEAR_BUFFER1           ; BUFFER1 je 64bytu dat v bance 3 na adrese 0x190 - 0x1CF
                      00916                                         ; pouziva TEMP1
0DE2   3040           00917         movlw .64
0DE3   00B6           00918         movwf TEMP1
                      00919         INDF_BANK_3             ; neprime adresovani na banku 3
0DE4   1783               M                         bsf STATUS,IRP    
0DE5   3090           00920         movlw 0x90
0DE6   0084           00921         movwf FSR
0DE7   3000           00922         movlw .0
                      00923 
0DE8                  00924 CLEAR_BEFFER1__CLEAR
0DE8   0080           00925         movwf INDF
0DE9   0A84           00926         incf FSR,F
0DEA   0BB6           00927         decfsz TEMP1,F
0DEB   2DE8           00928         goto CLEAR_BEFFER1__CLEAR
                      00929 
                      00930         INDF_BANK_0             ; neprime adresovani na banku 0
0DEC   1383               M                         bcf STATUS,IRP    
0DED   0008           00931         return
                      00932 ;**************************************************************************
0DEE                  00933 BUF2_TO_BUF1
                      00934         ; hodi 18 dat z dolni pulky bufferu 2 do dolni pulky bufferu 1
                      00935         ; 0x110 -> 0x190
                      00936         INDF_BANK_3
0DEE   1783               M                         bsf STATUS,IRP    
                      00937         BANK_2
0DEF   1703               M                 bsf     STATUS,RP1              ; BANK2  RP1:RP0 = 10
0DF0   1283               M                 bcf     STATUS,RP0    
0DF1   3090           00938         movlw 0x90
0DF2   0084           00939         movwf FSR
                      00940 
0DF3   0810           00941         movfw 0x110
0DF4   0080           00942         movwf INDF
0DF5   0A84           00943         incf FSR,F
0DF6   0811           00944         movfw 0x111
0DF7   0080           00945         movwf INDF
0DF8   0A84           00946         incf FSR,F
0DF9   0812           00947         movfw 0x112
0DFA   0080           00948         movwf INDF
0DFB   0A84           00949         incf FSR,F
0DFC   0813           00950         movfw 0x113
0DFD   0080           00951         movwf INDF
0DFE   0A84           00952         incf FSR,F
0DFF   0814           00953         movfw 0x114
0E00   0080           00954         movwf INDF
0E01   0A84           00955         incf FSR,F
0E02   0815           00956         movfw 0x115
0E03   0080           00957         movwf INDF
0E04   0A84           00958         incf FSR,F
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 105


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0E05   0816           00959         movfw 0x116
0E06   0080           00960         movwf INDF
0E07   0A84           00961         incf FSR,F
0E08   0817           00962         movfw 0x117
0E09   0080           00963         movwf INDF
0E0A   0A84           00964         incf FSR,F
0E0B   0818           00965         movfw 0x118
0E0C   0080           00966         movwf INDF
0E0D   0A84           00967         incf FSR,F
0E0E   0819           00968         movfw 0x119
0E0F   0080           00969         movwf INDF
0E10   0A84           00970         incf FSR,F
0E11   081A           00971         movfw 0x11A
0E12   0080           00972         movwf INDF
0E13   0A84           00973         incf FSR,F
0E14   081B           00974         movfw 0x11B
0E15   0080           00975         movwf INDF
0E16   0A84           00976         incf FSR,F
0E17   081C           00977         movfw 0x11C
0E18   0080           00978         movwf INDF
0E19   0A84           00979         incf FSR,F
0E1A   081D           00980         movfw 0x11D
0E1B   0080           00981         movwf INDF
0E1C   0A84           00982         incf FSR,F
0E1D   081E           00983         movfw 0x11E
0E1E   0080           00984         movwf INDF
0E1F   0A84           00985         incf FSR,F
0E20   081F           00986         movfw 0x11F
0E21   0080           00987         movwf INDF
0E22   0A84           00988         incf FSR,F
                      00989 
0E23   0820           00990         movfw 0x120
0E24   0080           00991         movwf INDF
0E25   0A84           00992         incf FSR,F
0E26   0821           00993         movfw 0x121
0E27   0080           00994         movwf INDF
0E28   0A84           00995         incf FSR,F
                      00996         BANK_0
0E29   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0E2A   1283               M                 bcf     STATUS,RP0    
0E2B   0008           00997         return
                      00998 ;**************************************************************************
0E2C                  00999 BUF2_LOW_TO_HIGH
                      01000         ; hodi 18 dat z dolni pulky bufferu 2 do horni pulky bufferu 2
                      01001         ; 0x110 - 0x121 -> 0x130 - 0x141
                      01002         BANK_2
0E2C   1703               M                 bsf     STATUS,RP1              ; BANK2  RP1:RP0 = 10
0E2D   1283               M                 bcf     STATUS,RP0    
0E2E   0810           01003         movfw 0x110
0E2F   00B0           01004         movwf 0x130
0E30   0811           01005         movfw 0x111
0E31   00B1           01006         movwf 0x131
0E32   0812           01007         movfw 0x112
0E33   00B2           01008         movwf 0x132
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 106


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0E34   0813           01009         movfw 0x113
0E35   00B3           01010         movwf 0x133
0E36   0814           01011         movfw 0x114
0E37   00B4           01012         movwf 0x134
0E38   0815           01013         movfw 0x115
0E39   00B5           01014         movwf 0x135
0E3A   0816           01015         movfw 0x116
0E3B   00B6           01016         movwf 0x136
0E3C   0817           01017         movfw 0x117
0E3D   00B7           01018         movwf 0x137
0E3E   0818           01019         movfw 0x118
0E3F   00B8           01020         movwf 0x138
0E40   0819           01021         movfw 0x119
0E41   00B9           01022         movwf 0x139
0E42   081A           01023         movfw 0x11A
0E43   00BA           01024         movwf 0x13A
0E44   081B           01025         movfw 0x11B
0E45   00BB           01026         movwf 0x13B
0E46   081C           01027         movfw 0x11C
0E47   00BC           01028         movwf 0x13C
0E48   081D           01029         movfw 0x11D
0E49   00BD           01030         movwf 0x13D
0E4A   081E           01031         movfw 0x11E
0E4B   00BE           01032         movwf 0x13E
0E4C   081F           01033         movfw 0x11F
0E4D   00BF           01034         movwf 0x13F
                      01035 
0E4E   0820           01036         movfw 0x120
0E4F   00C0           01037         movwf 0x140
0E50   0821           01038         movfw 0x121
0E51   00C1           01039         movwf 0x141
                      01040         BANK_0
0E52   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0E53   1283               M                 bcf     STATUS,RP0    
0E54   0008           01041         return
                      01042 ;**************************************************************************
0E55                  01043 LONG_NAME
                      01044 ; Tato procedura prevezme v HL_ADR_CL[1-4] cislo prvniho clusteru adresare a v ZAZNAM[1-2] cislo zaznamu
                             
                      01045 ; od kteremu se pokusi najit dlouhe jmeno. Toto dlouhe jmeno umisti do bufferu 2
                      01046 ; Dlouhe jmeno je ukonceno nulovym bytem. Pokud v bufferu 2 se nulovy byt nevyskytuje, je delka dlouheho
                      01047 ; jmena delsi ci rovna 64.
                      01048 ; V POZICE vraci 00h pri nenalezeni dlouheho jmena a 01h pri pravdepodobnem nalezeni dlouheho jmena.
                      01049 
                      01050 ; 64 znaku neni moc, neco se tam ale vejde "1-3. G & D - Purify (Gabriel & Dresden Remix) featuring Ball
                            igom"   (ingo.mp3)
                      01051 ; vyvojak:
                      01052 ;
                      01053 ; CLEAR_BUFFER2
                      01054 ;
                      01055 ; ZAZNAMU_vBUFFERU_DISKU := 0
                      01056 ; IF (ZAZNAM < 5):                                      // zaznamy cislujeme od 0, 
                      01057 ;       HL_PARAMETRY := ZAZNAM;
                      01058 ;       ZAZNAM := 0
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 107


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      01059 ; else:
                      01060 ;       ZAZNAM := ZAZNAM - 5                    // protoze chceme prohledat 5 predchozich
                      01061 ;       HL_PARAMETRY := 5
                      01062 ; endif
                      01063 ;
                      01064 ; while (HL_PARAMETRY <> 0)
                      01065 ;       if (ZAZNAMU_vBUFFERU_DISKU = 0):
                      01066 ;               SKOC_NA_ZAZNAM
                      01067 ;       endif;
                      01068 
                      01069 ;////////////////////
                      01070 ; if (BUFF1[0] != 0) and (BUFF1[0] != E5h) and (BUFF1[11] = 0Fh):
                      01071 ;               // v bufferu1 mame zaznam obsahujici dlouhe jmeno 
                      01072 ;               FSR := (HL_PARAMETRY * 13) + 3
                      01073 ;               INDF := BUFF1[1]
                      01074 ;               inc FSR
                      01075 ;               INDF := BUFF1[3]
                      01076 ;               inc FSR
                      01077 ;               ...
                      01078 ; else:
                      01079 ;               CLEAR_BUFFER2   // zaznam neobsahuje dlouhe jmeno, proto jsou vsechny predchozi zaznamy 
                            k nicemu
                      01080 ; endif;
                      01081 ;////////////////////
                      01082 
                      01083 ;       HL_PARAMETRY --
                      01084 ;       ZAZNAM ++
                      01085 ;       ZAZNAMU_vBUFFERU_DISKU --
                      01086 ; endwhile
                      01087         PROG_PAGE_0
0E55   118A               M                         bcf PCLATH,3
0E56   120A               M                         bcf PCLATH,4
0E57   2285           01088         call CLEAR_BUFFER2                              ;               CLEAR_BUFFER2   // zaznam neobsa
                            huje dlouhe jmeno, proto jsou vsechny predchozi zaznamy k nicemu
                      01089         PROG_PAGE_1
0E58   158A               M                         bsf PCLATH,3
0E59   120A               M                         bcf PCLATH,4
                      01090 
0E5A   01DE           01091         clrf ZAZNAMU_vBUFFERU_DISKU             ; ZAZNAMU_vBUFFERU_DISKU := 0
0E5B   01BB           01092         clrf POZICE
0E5C   0860           01093         movfw ZAZNAM1
0E5D   3C04           01094         sublw .4
0E5E   1C03           01095         btfss STATUS,C
0E5F   2E68           01096         goto LONG_NAME_ELSE1
0E60   0861           01097         movfw ZAZNAM2
0E61   39FF           01098         andlw h'FF'
0E62   1D03           01099         btfss STATUS,Z                                  ; IF (ZAZNAM < 5):                              
                                    // zaznamy cislujeme od 0, 
0E63   2E68           01100         goto LONG_NAME_ELSE1
                      01101 
0E64   0860           01102         movfw ZAZNAM1
0E65   00D9           01103         movwf HL_PARAMETRY                              ;       HL_PARAMETRY := ZAZNAM;
0E66   01E0           01104         clrf ZAZNAM1                                    ;       ZAZNAM := 0
0E67   2E6E           01105         goto LONG_NAME_ENDIF1
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 108


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0E68                  01106 LONG_NAME_ELSE1                                         ; else:
0E68   3005           01107         movlw .5
0E69   02E0           01108         subwf ZAZNAM1,F                                 ;       ZAZNAM := ZAZNAM - 5                    
                            // protoze chceme prohledat 5 predchozich
0E6A   1C03           01109         btfss STATUS,C
0E6B   03E1           01110         decf ZAZNAM2,F
0E6C   3005           01111         movlw .5
0E6D   00D9           01112         movwf HL_PARAMETRY                              ;       HL_PARAMETRY := 5
0E6E                  01113 LONG_NAME_ENDIF1                                        ; endif
                      01114 
0E6E                  01115 LONG_NAME_WHILE                                         ; while (HL_PARAMETRY <> 0)
0E6E   0859           01116         movfw HL_PARAMETRY
0E6F   39FF           01117         andlw h'FF'
0E70   1903           01118         btfsc STATUS,Z
0E71   2ED9           01119         goto LONG_NAME_ENDWHILE
                      01120         
0E72   085A           01121         movfw HL_ADR_CL1
0E73   00BC           01122         movwf CLUSTER1
0E74   085B           01123         movfw HL_ADR_CL2
0E75   00BD           01124         movwf CLUSTER2
0E76   085C           01125         movfw HL_ADR_CL3
0E77   00BE           01126         movwf CLUSTER3
0E78   085D           01127         movfw HL_ADR_CL4
0E79   00BF           01128         movwf CLUSTER4
                      01129 
0E7A   085E           01130         movfw ZAZNAMU_vBUFFERU_DISKU
0E7B   39FF           01131         andlw h'FF'
0E7C   1903           01132         btfsc STATUS,Z                                  ;       if (ZAZNAMU_vBUFFERU_DISKU = 0):
0E7D   236B           01133         call SKOC_NA_ZAZNAM                     ;               SKOC_NA_ZAZNAM  endif;
                      01134         
0E7E   183B           01135         btfsc POZICE,0          ; SKOC_NA_ZAZNAM - pokud ZAZNAM[1-2] ukazuji mimo adresar, vrati v POZIC
                            E FFh (jinak 00h)
0E7F   2EDC           01136         goto LONG_NAME_MIMO_ROZSAH
                      01137 
                      01138 ;////////////////////////////////
                      01139 ;       //tady probehne cteni zaznamu, zjisteni, zda jde o dlouhe jmeno a jeho cteni;   
0E80   3010           01140         movlw .16
0E81   00B6           01141         movwf TEMP1
                      01142         PROG_PAGE_0
0E82   118A               M                         bcf PCLATH,3
0E83   120A               M                         bcf PCLATH,4
0E84   2277           01143         call ZAPIS_DO_BUFFERU_1                 ; kazdy zaznam v adresari ma 32 bytu
                      01144         PROG_PAGE_1
0E85   158A               M                         bsf PCLATH,3
0E86   120A               M                         bcf PCLATH,4
                      01145 
                      01146         BANK_3
0E87   1703               M                 bsf     STATUS,RP1              ; BANK3  RP1:RP0 = 11
0E88   1683               M                 bsf     STATUS,RP0    
0E89   0810           01147         movfw 0x190
0E8A   39FF           01148         andlw h'FF'
0E8B   1903           01149         btfsc STATUS,Z
0E8C   2ECC           01150         goto LONG_NAME_ELSE2
0E8D   3CE5           01151         sublw h'E5'
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 109


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0E8E   1903           01152         btfsc STATUS,Z
0E8F   2ECC           01153         goto LONG_NAME_ELSE2
0E90   081B           01154         movfw 0x19B
0E91   3C0F           01155         sublw h'0F'
0E92   1D03           01156         btfss STATUS,Z
0E93   2ECC           01157         goto LONG_NAME_ELSE2
0E94                  01158 LONG_NAME_IF2                                           ; if (BUFF1[0] != 0) and (BUFF1[0] != E5h) and (
                            BUFF1[11] = 0Fh):
                      01159         BANK_0                                                  ;               // v bufferu1 mame zazna
                            m obsahujici dlouhe jmeno 
0E94   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0E95   1283               M                 bcf     STATUS,RP0    
0E96   0859           01160         movfw HL_PARAMETRY
0E97   00B6           01161         movwf TEMP1
0E98   3000           01162         movlw .0
0E99                  01163 LONG_NAME_NASOBENI
0E99   3E0D           01164         addlw .13
0E9A   0BB6           01165         decfsz TEMP1,f
0E9B   2E99           01166         goto LONG_NAME_NASOBENI
0E9C   3E03           01167         addlw .3        
0E9D   0084           01168         movwf FSR                                               ;               FSR := (HL_PARAMETRY * 1
                            3) + 3
                      01169 
                      01170         BANK_3
0E9E   1703               M                 bsf     STATUS,RP1              ; BANK3  RP1:RP0 = 11
0E9F   1683               M                 bsf     STATUS,RP0    
                      01171         INDF_BANK_2
0EA0   1783               M                         bsf STATUS,IRP    
0EA1   0811           01172         movfw 0x190+.1
0EA2   0080           01173         movwf INDF
0EA3   0A84           01174         incf FSR,F
0EA4   0813           01175         movfw 0x190+.3
0EA5   0080           01176         movwf INDF
0EA6   0A84           01177         incf FSR,F
0EA7   0815           01178         movfw 0x190+.5
0EA8   0080           01179         movwf INDF
0EA9   0A84           01180         incf FSR,F
0EAA   0817           01181         movfw 0x190+.7
0EAB   0080           01182         movwf INDF
0EAC   0A84           01183         incf FSR,F
0EAD   0819           01184         movfw 0x190+.9
0EAE   0080           01185         movwf INDF
0EAF   0A84           01186         incf FSR,F
0EB0   081E           01187         movfw 0x190+.14
0EB1   0080           01188         movwf INDF
0EB2   0A84           01189         incf FSR,F
0EB3   0820           01190         movfw 0x190+.16
0EB4   0080           01191         movwf INDF
0EB5   0A84           01192         incf FSR,F
0EB6   0822           01193         movfw 0x190+.18
0EB7   0080           01194         movwf INDF
0EB8   0A84           01195         incf FSR,F
0EB9   0824           01196         movfw 0x190+.20
0EBA   0080           01197         movwf INDF
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 110


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0EBB   0A84           01198         incf FSR,F
0EBC   0826           01199         movfw 0x190+.22
0EBD   0080           01200         movwf INDF
0EBE   0A84           01201         incf FSR,F
0EBF   0828           01202         movfw 0x190+.24
0EC0   0080           01203         movwf INDF
0EC1   0A84           01204         incf FSR,F
0EC2   082C           01205         movfw 0x190+.28
0EC3   0080           01206         movwf INDF
0EC4   0A84           01207         incf FSR,F
0EC5   082E           01208         movfw 0x190+.30
0EC6   0080           01209         movwf INDF
0EC7   0A84           01210         incf FSR,F
                      01211         INDF_BANK_0
0EC8   1383               M                         bcf STATUS,IRP    
                      01212         BANK_0
0EC9   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0ECA   1283               M                 bcf     STATUS,RP0    
0ECB   2ED3           01213         goto LONG_NAME_ENDIF2
0ECC                  01214 LONG_NAME_ELSE2                                         ; else:
                      01215         BANK_0
0ECC   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0ECD   1283               M                 bcf     STATUS,RP0    
                      01216         PROG_PAGE_0
0ECE   118A               M                         bcf PCLATH,3
0ECF   120A               M                         bcf PCLATH,4
0ED0   2285           01217         call CLEAR_BUFFER2                              ;               CLEAR_BUFFER2   // zaznam neobsa
                            huje dlouhe jmeno, proto jsou vsechny predchozi zaznamy k nicemu
                      01218         PROG_PAGE_1
0ED1   158A               M                         bsf PCLATH,3
0ED2   120A               M                         bcf PCLATH,4
0ED3                  01219 LONG_NAME_ENDIF2                                        ; endif;
                      01220 ;////////////////////////////////
                      01221 
0ED3   0AE0           01222         incf ZAZNAM1,F
0ED4   1903           01223         btfsc STATUS,Z
0ED5   0AE1           01224         incf ZAZNAM2,F                                  ;       ZAZNAM ++
0ED6   03D9           01225         decf HL_PARAMETRY,F                             ;       HL_PARAMETRY --
0ED7   03DE           01226         decf ZAZNAMU_vBUFFERU_DISKU,F   ;       ZAZNAMU_vBUFFERU_DISKU --
0ED8   2E6E           01227         goto LONG_NAME_WHILE
0ED9                  01228 LONG_NAME_ENDWHILE                                      ; endwhile
0ED9   3001           01229         movlw .1
0EDA   00BB           01230         movwf POZICE
0EDB   0008           01231         return
0EDC                  01232 LONG_NAME_MIMO_ROZSAH
0EDC   3000           01233         movlw .0
0EDD   00BB           01234         movwf POZICE
0EDE   0008           01235         return
                      01236 ;**************************************************************************
1000                  00078  org 0x1000                                     ; PAGE 2
1800                  00079  org 0x1800                                     ; PAGE 3
                      00080 ;**********************************************************
                      00081         END
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 111


SYMBOL TABLE
  LABEL                             VALUE 

ABRT                              00000002
ACKDT                             00000005
ACKEN                             00000004
ACKSTAT                           00000006
ADCON0                            0000001F
ADCON1                            0000009F
ADCS0                             00000006
ADCS1                             00000007
ADDEN                             00000003
ADFM                              00000007
ADIE                              00000006
ADIF                              00000006
ADON                              00000000
ADRESH                            0000001E
ADRESL                            0000009E
APPLICABLE                        00000007
ATA_ADDRESS                       00000007
ATA_ADDRESS_TRIS                  00000087
ATA_ATTRIBUTES                    0000002E
ATA_CONTROL                       00000009
ATA_CONTROL_TRIS                  00000089
ATA_DIOR_N                        ATA_CONTROL,2
ATA_DIOW_N                        ATA_CONTROL,1
ATA_ERROR                         00000025
ATA_OK                            00000000
ATA_RESET                         00000291
ATA_RESET_N                       ATA_CONTROL,0
ATA_STATUS                        0000002C
ATA_STATUS_A                      00000022
BANK_0                            
BANK_1                            
BANK_2                            
BANK_3                            
BCLIE                             00000003
BCLIF                             00000003
BF                                00000000
BIG_LOOP                          0000003B
BIG_LOOP__NENI_PRIKAZ             00000052
BIG_SECTOR                        00000003
BRGH                              00000002
BSY                               00000007
BUF2_LOW_TO_HIGH                  00000E2C
BUF2_TO_BUF1                      00000DEE
C                                 00000000
CCP1CON                           00000017
CCP1IE                            00000002
CCP1IF                            00000002
CCP1M0                            00000000
CCP1M1                            00000001
CCP1M2                            00000002
CCP1M3                            00000003
CCP1X                             00000005
CCP1Y                             00000004
CCP2CON                           0000001D
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 112


SYMBOL TABLE
  LABEL                             VALUE 

CCP2IE                            00000000
CCP2IF                            00000000
CCP2M0                            00000000
CCP2M1                            00000001
CCP2M2                            00000002
CCP2M3                            00000003
CCP2X                             00000005
CCP2Y                             00000004
CCPR1H                            00000016
CCPR1L                            00000015
CCPR2H                            0000001C
CCPR2L                            0000001B
CEKEJ_PRIKAZ                      000008DD
CEK_PRIKAZ_01h                    00000020
CEK_PRIKAZ_02h_03h                0000002E
CHS0                              00000003
CHS1                              00000004
CHS2                              00000005
CKE                               00000006
CKP                               00000004
CLEAR_BEFFER1__CLEAR              00000DE8
CLEAR_BEFFER2__CLEAR              0000028B
CLEAR_BUFFER1                     00000DE2
CLEAR_BUFFER2                     00000285
CLUSTER1                          0000003C
CLUSTER2                          0000003D
CLUSTER3                          0000003E
CLUSTER4                          0000003F
CLUSTER_SIZE                      0000004C
CLUSTER_TO_LBA                    000004C9
CLUSTER_TO_LBA_NO_ROOT            000004ED
COMMAND                           0000002D
COMPARE_B1_B2_BUFF1               00000DD8
COMPARE_B1_B2_BUFF2               00000DDD
COMPARE_B1_B2_BYT10               00000DB5
COMPARE_B1_B2_BYT11               00000DBF
COMPARE_B1_B2_BYT12               00000DC9
COMPARE_B1_B2_BYT2                00000D65
COMPARE_B1_B2_BYT3                00000D6F
COMPARE_B1_B2_BYT4                00000D79
COMPARE_B1_B2_BYT5                00000D83
COMPARE_B1_B2_BYT6                00000D8D
COMPARE_B1_B2_BYT7                00000D97
COMPARE_B1_B2_BYT8                00000DA1
COMPARE_B1_B2_BYT9                00000DAB
COMPARE_B1_B2_SHODNE              00000DD3
COMPARE_BUFF1_BUFF2               00000D52
COMPARE_BUFF2_L_H                 00000D3F
CREN                              00000004
CSRC                              00000007
D                                 00000005
DALSI_SKLADBA                     000000B1
DALSI_SKLADBA_MAME_SOUBOR         00000111
DALSI_SKLADBA_NO_R_S              000000E2
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 113


SYMBOL TABLE
  LABEL                             VALUE 

DALSI_SKLADBA_PLAY                00000125
DALSI_SKLADBA_REPAT_SOUBORU       000000BB
DATA_ADDRESS                      00000005
DATA_H                            00000021
DATA_L                            00000020
DATA_PORT_HIGH                    00000008
DATA_PORT_HIGH_TRIS               00000088
DATA_PORT_LOW                     00000006
DATA_PORT_LOW_TRIS                00000086
DC                                00000001
DEKREMENTUJ                       0000060C
DEKREMENTUJ_KONEC                 00000619
DELAY_200ms                       000001C4
DELAY_25us                        00000337
DELAY_2ms                         000001BB
DELAY_500ms                       000001CD
DEVICE                            0000002B
DEVICE_C                          00000023
DRDY                              00000006
DRQ                               00000003
D_A                               00000005
D_COMMAND                         00000027
D_DATA_R                          00000020
D_DEVICE                          00000026
D_DEVICE_C                        00000016
D_ERROR                           00000021
D_FEATURES                        00000021
D_LBA1                            00000023
D_LBA2                            00000024
D_LBA3                            00000025
D_SECTOR_C                        00000022
D_STATUS                          00000027
D_STATUS_A                        00000016
EEADR                             0000010D
EEADRH                            0000010F
EECON1                            0000018C
EECON2                            0000018D
EEDATA                            0000010C
EEDATH                            0000010E
EEIE                              00000004
EEIF                              00000004
EEPGD                             00000007
END_OF_INTERRUPT                  000001B3
ERR                               00000000
ERROR_LED                         ATA_ADDRESS,3
F                                 00000001
FAT32_LOAD                        00000004
FEATURES                          00000024
FERR                              00000002
FILE_INFO                         00000BE6
FILE_INFO__CTI20_KONEC            00000C59
FILE_INFO__DIR                    00000C2A
FILE_INFO__FILE                   00000C2C
FILE_INFO__READ_NAME              00000BEE
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 114


SYMBOL TABLE
  LABEL                             VALUE 

FILE_SIZE                         00000C61
FSR                               00000004
GCEN                              00000007
GIE                               00000007
GO                                00000002
GO_DONE                           00000002
HLEDEJ                            00000C7E
HLEDEJ_ELSE1                      00000CA0
HLEDEJ_ELSE3                      00000CED
HLEDEJ_ENDIF3                     00000CF3
HLEDEJ_END_REPEAT                 00000CF4
HLEDEJ_HLEDANI                    00000CBE
HLEDEJ_IF2_ENDIF                  00000CB8
HLEDEJ_IF4                        00000CEB
HLEDEJ_KONEC                      00000D0F
HLEDEJ_NEHLEDAME_PRVNI            00000CA8
HLEDEJ_REPEAT                     00000CC3
HL_ADR_CL1                        0000005A
HL_ADR_CL2                        0000005B
HL_ADR_CL3                        0000005C
HL_ADR_CL4                        0000005D
HL_PARAMETRY                      00000059
HOB                               00000007
I2C_DATA                          00000005
I2C_READ                          00000002
I2C_START                         00000003
I2C_STOP                          00000004
IBF                               00000007
IBOV                              00000005
IDENTIFY_DEVICE                   000002E4
IF2                               00000CB5
INDF                              00000000
INDF_BANK_0                       
INDF_BANK_1                       
INDF_BANK_2                       
INDF_BANK_3                       
INIT_ATA__DALSI                   00000323
INIT_ATA__DALSI2                  0000032D
INIT_ATA__NOT_SUPPORT_LBA48       00000320
INIT_CONFIG                       0000014A
INIT_PORT                         00000137
INTCON                            0000000B
INTE                              00000004
INTEDG                            00000006
INTERRUPT                         000001A5
INTF                              00000001
IRP                               00000007
LBA1                              00000027
LBA2                              00000028
LBA3                              00000029
LBA4                              0000002A
LBA48_SUPPORT                     00000002
LBA_SUPPORT                       00000001
LONG_NAME                         00000E55
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 115


SYMBOL TABLE
  LABEL                             VALUE 

LONG_NAME_ELSE1                   00000E68
LONG_NAME_ELSE2                   00000ECC
LONG_NAME_ENDIF1                  00000E6E
LONG_NAME_ENDIF2                  00000ED3
LONG_NAME_ENDWHILE                00000ED9
LONG_NAME_IF2                     00000E94
LONG_NAME_MIMO_ROZSAH             00000EDC
LONG_NAME_NASOBENI                00000E99
LONG_NAME_WHILE                   00000E6E
MP3_BSYNC                         MP3_PORT,5
MP3_CS                            MP3_PORT,3
MP3_DREQ                          MP3_PORT,4
MP3_NOT_PLAY                      000000B0
MP3_PORT                          00000005
MP3_PORT_TRIS                     00000085
MP3_REWIND_FORWARD                00000082
MP3_SCLK                          MP3_PORT,2
MP3_SI                            MP3_PORT,1
MP3_SO                            MP3_PORT,0
NACTI_FAT32                       00000405
NACTI_FAT32__KONEC                000004C8
NEXT_CLUSTER                      0000052C
NEXT_CLUSTER_KONEC                000005B1
NEXT_CLUSTER_NEPRAZDNY            0000059A
NEXT_CLUSTER_NO_ROOT              00000550
NOT_A                             00000005
NOT_ADDRESS                       00000005
NOT_BO                            00000000
NOT_BOR                           00000000
NOT_DONE                          00000002
NOT_MP3_REWIND_FORWARD            0000008E
NOT_PD                            00000003
NOT_POR                           00000001
NOT_RBPU                          00000007
NOT_RC8                           00000006
NOT_T1SYNC                        00000002
NOT_TO                            00000004
NOT_TX8                           00000006
NOT_W                             00000002
NOT_WRITE                         00000002
NULA                              000006C9
OBF                               00000006
ODESLI_BUFF2_HIGH                 00000191
ODESLI_BUFF2_HIGH_ODESILANI       00000194
ODESLI_BUFFER2                    0000019B
ODESLI_BUFFER2_ODESILANI          0000019E
ODESLI_DATA                       00000178
ODESLI_MODEL_NUMBER               00000180
ODESLI_MODEL_NUMBER_ODESILANI     00000185
OERR                              00000001
OPERAND_X1                        000000A0
OPERAND_X2                        000000A1
OPERAND_X3                        000000A2
OPERAND_X4                        000000A3
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 116


SYMBOL TABLE
  LABEL                             VALUE 

OPERAND_Y1                        000000A4
OPERAND_Y2                        000000A5
OPERAND_Y3                        000000A6
OPERAND_Y4                        000000A7
OPTION_REG                        00000081
P                                 00000004
PARAM_MAX_LBA1                    0000002F
PARAM_MAX_LBA2                    00000030
PARAM_MAX_LBA3                    00000031
PARAM_MAX_LBA4                    00000032
PARAM_SLOV_V_SEKTORU1             00000033
PARAM_SLOV_V_SEKTORU2             00000034
PCFG0                             00000000
PCFG1                             00000001
PCFG2                             00000002
PCFG3                             00000003
PCL                               00000002
PCLATH                            0000000A
PCON                              0000008E
PEIE                              00000006
PEN                               00000002
PIE1                              0000008C
PIE2                              0000008D
PIR1                              0000000C
PIR2                              0000000D
POCATEK_DAT1                      00000040
POCATEK_DAT2                      00000041
POCATEK_DAT3                      00000042
POCATEK_DAT4                      00000043
POCATEK_FAT1                      00000044
POCATEK_FAT2                      00000045
POCATEK_FAT3                      00000046
POCATEK_FAT4                      00000047
PORTA                             00000005
PORTB                             00000006
PORTC                             00000007
PORTD                             00000008
PORTE                             00000009
POSUNDOLEVA                       0000061C
POSUNDOLEVA_1                     00000622
POSUNDOLEVA_2                     0000062A
POSUNDOLEVA_3                     00000633
POSUNDOLEVA_4                     0000063D
POSUNDOLEVA_5                     00000648
POSUNDOLEVA_6                     00000654
POSUNDOLEVA_7                     00000661
POSUNDOPRAVA                      0000066F
POSUNDOPRAVA_1                    00000675
POSUNDOPRAVA_2                    0000067E
POSUNDOPRAVA_3                    00000688
POSUNDOPRAVA_4                    00000693
POSUNDOPRAVA_5                    0000069F
POSUNDOPRAVA_6                    000006AC
POSUNDOPRAVA_7                    000006BA
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 117


SYMBOL TABLE
  LABEL                             VALUE 

POZDRAV                           0000016D
POZICE                            0000003B
PR2                               00000092
PREH_ADR_CL1                      00000062
PREH_ADR_CL2                      00000063
PREH_ADR_CL3                      00000064
PREH_ADR_CL4                      00000065
PREH_CITAC_PREV                   00000068
PREH_DATA_CL1                     00000069
PREH_DATA_CL2                     0000006A
PREH_DATA_CL3                     0000006B
PREH_DATA_CL4                     0000006C
PREH_DATA_POZICE                  0000006D
PREH_STAV0                        0000006E
PREH_STAV1                        0000006F
PREH_ZAZNAM1                      00000066
PREH_ZAZNAM2                      00000067
PRESKOC                           0000026F
PRETECENI                         000000AC
PRIJATE_DATO                      00000074
PRIJATYCH_DAT                     00000073
PRIKAZ_02h                        000008E2
PRIKAZ_02h__ODESILANI_ODDILU      000008F8
PRIKAZ_03h                        00000903
PRIKAZ_04h                        00000921
PRIKAZ_05h                        0000092E
PRIKAZ_05h_KONEC                  00000956
PRIKAZ_05h_PAR1_NOT_OK            00000942
PRIKAZ_05h_PAR1_OK                00000948
PRIKAZ_05h_PAR2_NOT_OK            0000094F
PRIKAZ_05h_PAR2_OK                00000955
PRIKAZ_06h                        0000095F
PRIKAZ_07h                        00000981
PRIKAZ_07h__ODESLI_SECTOR         0000099D
PRIKAZ_08h                        000009A8
PRIKAZ_08h_KONEC                  000009CB
PRIKAZ_08h_PAR1_NOT_OK            000009BC
PRIKAZ_08h_PAR1_OK                000009BF
PRIKAZ_08h_PAR2_NOT_OK            000009C6
PRIKAZ_08h_PAR2_OK                000009C9
PRIKAZ_09h                        000009D6
PRIKAZ_09h_KONEC                  00000A00
PRIKAZ_09h_SPATNY_PAR             000009FA
PRIKAZ_0Ah                        00000A09
PRIKAZ_0Ah_KONEC                  00000A2C
PRIKAZ_0Ah_PAR1_NOT_OK            00000A21
PRIKAZ_0Ah_PAR1_OK                00000A27
PRIKAZ_80h                        00000A37
PRIKAZ_80h_KONEC                  00000A8B
PRIKAZ_80h_PAR1_NOT_OK            00000A4B
PRIKAZ_80h_PAR1_OK                00000A51
PRIKAZ_80h_PAR2_NOT_OK            00000A58
PRIKAZ_80h_PAR2_OK                00000A5E
PRIKAZ_81h                        00000A96
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 118


SYMBOL TABLE
  LABEL                             VALUE 

PRIKAZ_82h                        00000AB5
PRIKAZ_83h                        00000ACB
PRIKAZ_84h                        00000AFF
PROG_PAGE_0                       
PROG_PAGE_1                       
PROG_PAGE_2                       
PROG_PAGE_3                       
PRVNI_CL_ADRESARE                 00000B31
PRVNI_CL_ADRESARE_KONEC           00000B6A
PRVNI_CL_ADRESARE_MEZERY          00000B51
PS0                               00000000
PS1                               00000001
PS2                               00000002
PSA                               00000003
PSPIE                             00000007
PSPIF                             00000007
PSPMODE                           00000004
R                                 00000002
RBIE                              00000003
RBIF                              00000000
RC8_9                             00000006
RC9                               00000006
RCD8                              00000000
RCEN                              00000003
RCIE                              00000005
RCIF                              00000005
RCREG                             0000001A
RCSTA                             00000018
RD                                00000000
RD_DEVICE                         000001F6
RD_ERROR                          000001DE
RD_LBA1                           000001EA
RD_LBA2                           000001EE
RD_LBA3                           000001F2
RD_SC                             000001E6
RD_STATUS                         000001DA
RD_STATUS_A                       000001E2
READ_DATA                         00000254
READ_DATA_CTEME                   0000025D
READ_SECTOR                       000002AC
READ_SECTOR_LBA27                 000002BD
READ_SECTOR_LBA48                 000002CC
READ_WRITE                        00000002
ROOT_DIR_CL1                      00000048
ROOT_DIR_CL2                      00000049
ROOT_DIR_CL3                      0000004A
ROOT_DIR_CL4                      0000004B
ROZDIL                            000005E0
RP0                               00000005
RP1                               00000006
RSEN                              00000001
RUTR                              00000231
RUTW                              0000023E
RX9                               00000006
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 119


SYMBOL TABLE
  LABEL                             VALUE 

RX9D                              00000000
R_W                               00000002
S                                 00000003
SCAN_BR                           00000348
SCAN_MBR                          00000342
SCAN_MBR__HLEDEJ_ROZSIRENY_ODDIL  00000391
SCAN_MBR__KONEC                   000003BB
SECTOR_C                          00000026
SELECT_DEVICE                     00000273
SEN                               00000000
SEND_MP3_DATA                     00000073
SEND_MP3_WORD                     0000009F
SKOC_NA_ZAZNAM                    00000B6B
SKOC_NA_ZAZNAM_KONEC              00000BE5
SKOC_NA_ZAZNAM_MAME_CL            00000BC4
SKOC_NA_ZAZNAM_MAME_ZAZNAM        00000BE0
SKOC_NA_ZAZNAM_MIMO_ROZSAH        00000BE3
SKOC_NA_ZAZNAM_PRESKOC_CL         00000B96
SMP                               00000007
SOUCET                            000005B4
SPBRG                             00000099
SPEN                              00000007
SREN                              00000005
SRST                              00000002
SSPADD                            00000093
SSPBUF                            00000013
SSPCON                            00000014
SSPCON2                           00000091
SSPEN                             00000005
SSPIE                             00000003
SSPIF                             00000003
SSPM0                             00000000
SSPM1                             00000001
SSPM2                             00000002
SSPM3                             00000003
SSPOV                             00000006
SSPSTAT                           00000094
START                             00000010
STATUS                            00000003
STAV_PRIKAZU                      00000075
SYNC                              00000004
T0CS                              00000005
T0IE                              00000005
T0IF                              00000002
T0SE                              00000004
T1CKPS0                           00000004
T1CKPS1                           00000005
T1CON                             00000010
T1INSYNC                          00000002
T1OSCEN                           00000003
T1SYNC                            00000002
T2CKPS0                           00000000
T2CKPS1                           00000001
T2CON                             00000012
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 120


SYMBOL TABLE
  LABEL                             VALUE 

TEMP1                             00000036
TEMP2                             00000037
TEMP3                             00000038
TEMP4                             00000039
TEMP5                             0000003A
TEMPW                             00000035
TEMP_FSR                          00000072
TEMP_PCLATH                       00000076
TEMP_STATUS                       00000071
TEMP_WORKING                      00000070
TMP0                              00000038
TMP1                              00000036
TMP2                              00000037
TMR0                              00000001
TMR1CS                            00000001
TMR1H                             0000000F
TMR1IE                            00000000
TMR1IF                            00000000
TMR1L                             0000000E
TMR1ON                            00000000
TMR2                              00000011
TMR2IE                            00000001
TMR2IF                            00000001
TMR2ON                            00000002
TOUTPS0                           00000003
TOUTPS1                           00000004
TOUTPS2                           00000005
TOUTPS3                           00000006
TRISA                             00000085
TRISB                             00000086
TRISC                             00000087
TRISD                             00000088
TRISE                             00000089
TRISE0                            00000000
TRISE1                            00000001
TRISE2                            00000002
TRMT                              00000001
TX8_9                             00000006
TX9                               00000006
TX9D                              00000000
TXD8                              00000000
TXEN                              00000005
TXIE                              00000004
TXIF                              00000004
TXREG                             00000019
TXSTA                             00000098
UA                                00000001
VSADDR_AIADDR                     0000000A
VSADDR_AICTRL0                    0000000D
VSADDR_AICTRL1                    0000000E
VSADDR_AUDATA                     00000005
VSADDR_CLOCKF                     00000003
VSADDR_DECODE_TIME                00000004
VSADDR_HDAT0                      00000008
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 121


SYMBOL TABLE
  LABEL                             VALUE 

VSADDR_HDAT1                      00000009
VSADDR_MODE                       00000000
VSADDR_STATUS                     00000001
VSADDR_VOL                        0000000B
VSADDR_WRAM                       00000006
VSADDR_WRAMADDR                   00000007
VSREG_MODE_L                      0000004D
VSREG_STATUS_L                    0000004E
VSREG_VOL_H                       00000050
VSREG_VOL_L                       0000004F
VS_BEEP                           000008BA
VS_END_BEEP                       000008A8
VS_INIT                           000008CE
VS_RD_BYTE                        00000835
VS_RD_REG                         0000086E
VS_SEND_1024_NULL                 00000896
VS_SEND_32_NULL                   0000088E
VS_SET_VOLUME                     0000089D
VS_SOFT_RESET                     00000879
VS_WR_BYTE                        00000800
VS_WR_REG                         00000863
VYHOVUJE_ZAZNAM                   00000D1D
VYHOV_ZAZ_ALL_FILES               00000D2D
VYHOV_ZAZ_ONLY_ADR                00000D33
VYHOV_ZAZ_ONLY_MP3                00000D30
VYHOV_ZAZ_SOUBiADR                00000D36
VYHOV_ZAZ_SOUBiADR_MP3            00000D3A
VYSLEDEK1                         000000A8
VYSLEDEK2                         000000A9
VYSLEDEK3                         000000AA
VYSLEDEK4                         000000AB
W                                 00000000
WAIT_FOR_READY                    0000033C
WAIT_FOR_VSDREQ                   000008A5
WCOL                              00000007
WR                                00000001
WREN                              00000002
WRERR                             00000003
WR_BLOCK                          00000222
WR_COMMAND                        000001FF
WR_DC                             000001FA
WR_DEVICE                         00000218
WR_FEATURES                       0000021D
WR_LBA1                           00000209
WR_LBA2                           0000020E
WR_LBA3                           00000213
WR_SC                             00000204
WR_USART                          00000165
Z                                 00000002
ZAPIS_C_ZAZNAMU                   00000D10
ZAPIS_DO_BUFFERU_1                00000277
ZAPIS_DO_BUFFERU_1__ZAPIS         0000027A
ZAZNAM1                           00000060
ZAZNAM2                           00000061
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 122


SYMBOL TABLE
  LABEL                             VALUE 

ZAZNAMU_vBUFFERU_DISKU            0000005E
ZKONTROLUJ_ODDIL_FAT32            000003BC
ZKONTROLUJ_ODDIL_FAT32__JMENOVKA  000003DF
ZKONTROLUJ_ODDIL_FAT32__KONEC     00000404
_BODEN_OFF                        00003FBF
_BODEN_ON                         00003FFF
_CPD_OFF                          00003FFF
_CPD_ON                           00003EFF
_CP_ALL                           00000FCF
_CP_HALF                          00001FDF
_CP_OFF                           00003FFF
_CP_UPPER_256                     00002FEF
_DEBUG_OFF                        00003FFF
_DEBUG_ON                         000037FF
_HS_OSC                           00003FFE
_LP_OSC                           00003FFC
_LVP_OFF                          00003F7F
_LVP_ON                           00003FFF
_PWRTE_OFF                        00003FFF
_PWRTE_ON                         00003FF7
_RC_OSC                           00003FFF
_WDT_OFF                          00003FFB
_WDT_ON                           00003FFF
_WRT_ENABLE_OFF                   00003DFF
_WRT_ENABLE_ON                    00003FFF
_XT_OSC                           00003FFD
__16F877                          00000001
nEIN                              00000001


MEMORY USAGE MAP ('X' = Used,  '-' = Unused)

0000 : X---XXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0040 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0080 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
00C0 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0100 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0140 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0180 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
01C0 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0200 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0240 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0280 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
02C0 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0300 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0340 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0380 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 123


MEMORY USAGE MAP ('X' = Used,  '-' = Unused)


03C0 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0400 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0440 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0480 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
04C0 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0500 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0540 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0580 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
05C0 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0600 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0640 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0680 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
06C0 : XXXXXXXXXXXXXXXX XXXXXXXXXXXX---- ---------------- ----------------
0800 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0840 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0880 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
08C0 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0900 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0940 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0980 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
09C0 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0A00 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0A40 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0A80 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0AC0 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0B00 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0B40 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0B80 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0BC0 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0C00 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0C40 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0C80 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0CC0 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0D00 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0D40 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0D80 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0DC0 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0E00 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0E40 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0E80 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0EC0 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXX- ---------------- ----------------
2000 : -------X-------- ---------------- ---------------- ----------------

All other memory blocks unused.

Program Memory Words Used:  3512
Program Memory Words Free:  4680


MPASM 03.90 Released                               HLAVNI.ASM   1-2-2006  18:19:05         PAGE 124





Errors   :     0
Warnings :     0 reported,     0 suppressed
Messages :     0 reported,   352 suppressed

