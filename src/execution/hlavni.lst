MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE  1


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00001 ;   HLAVNI SOUBOR 
                      00002 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00003 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00004 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00005 ;  MP3 PREPRCAVAC
                      00006 ; ================
                      00007 ; 
                      00008 ; Program mp3 prehravace pouzivajici jako zdroj dat ATA disk.
                      00009 ; 
                      00010 ; Umi identifikovat disk, precist libovolny sektor, v MBR  najit oddily se systemem souboru FAT32, 
                      00011 ; nacist spousteci zaznam FAT32, praci s FAT32, komunikaci s vs1001 a prehravani mp3 pres vs1001.
                      00012 ;
                      00013 ;
                      00014 ; dodelat:
                      00015 ;       - previjeni souboru (alespon dopredu)
                      00016 ;       - po skonceni mp3 nacist dalsi mp3
                      00017 ;       - Nejak udelat aby soubory byly prehravany podle abecedy
                      00018 ;       - podporu ID3v1
                      00019 ;       - pak uz jen vychytavky...      (napr. do vs1001 naprogramovat ekvalizer a nejak ho ovladat...)
                      00020 ;
                      00021 ; srpen 2005 - rijen 2005 Karry - lukas.karas@centrum.cz
                      00022 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00023 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00024 
                      00025 
                      00026 ;**********************************************************
                      00027 ;   VERZE 0.8b
                      00028 ;**********************************************************
                      00029 ; !!!!!!!! VSECHNY CASOVE SMYCKY JSOU POCITANY NA Fosc=16MHz !!!!!
                      00030 ; !!!!!!!! NASTAVENI USARTu TAKY !!!!!!!
                      00031         LIST            p=PIC16f877,C=132,n=60
2007   3F3A           00032         __CONFIG        _WDT_OFF & _HS_OSC & _PWRTE_OFF & _BODEN_OFF & _LVP_OFF 
                      00033                         ; LVP_OFF = RB3 jako digitalni I/O
                      00034         errorlevel -302         ; vypnuti Message [302]: Register in operand not in bank 0.
                      00035         errorlevel -306         ; vypnuti Message[306] : Crossing page boundary -- ensure page bits are 
                            set.
                      00036                                                 ; ! zjednoduseni vypisu, ale riziko prehlednuti chyby
                      00037 
                      00038         #DEFINE VS1001 1        ; 1 = vs1001 pripojen, casti kodu pro vs1001 se prekladaji, ...
                      00039                                                 ; ...pokud 0 je pripojen pouze disk, na portA se nic nep
                            osila
                      00040 ;**********************************************************
                      00041 
                      00042         include "P16F877.inc"   ; definice blbosti kolem procesoru
                      00001         LIST
                      00002 ; P16F877.INC  Standard Header File, Version 1.00    Microchip Technology, Inc.
                      00373         LIST
                      00043         include "mp3.inc"               ; definice promennych, konstant a portu
                      00001 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00002 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00003 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00004 ; DEFINICE PORTU
                      00005 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00006 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE  2


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00007 ;**********************************************************
                      00008 ; ZAPOJENI PORTU:
                      00009 ;       portA - MP3 dekoder vs1001g
                      00010 ;                               5      4     3   2     1         0
                      00011 ;                               BSYNC  DREQ  CS  SCLK  SI/SDATA  SO
                      00012 ;               portB - ATA datova sbernice (dolnich 8 bitu)
                      00013 ;               7   .. 0
                      00014 ;               DD7 .. DD0
                      00015 ;               portD - ATA datova sbernice (hornich 8 bitu)
                      00016 ;               15   .. 8
                      00017 ;               DD15 .. DD8 
                      00018 ;               portC - adresove signaly ATA, ERROR_LED, a USART
                      00019 ;                               7          6         5     4     3          2    1    0
                      00020 ;                               USART out  USART in  CS1-  CS0-  ERROR_LED  DA2  DA1  DA0  
                      00021 ;                               (signaly se znaminkem minus jsou aktivni v logicke 0 !!!)
                      00022 ;               portE - ridici signaly ATA
                      00023 ;                               2       1      0
                      00024 ;                               DIOR-   DIOW-  RESET-
                      00025 ;                               (signaly se znaminkem minus jsou aktivni v logicke 0 !!!)
                      00026 ;**********************************************************
  00000005            00027 MP3_PORT                equ PORTA
  00000085            00028 MP3_PORT_TRIS   equ TRISA
                      00029 ; BITY MP3_PORT
                      00030 #define MP3_SO          MP3_PORT,0      ; serial output - tady dostavame z dekoderu data
                      00031 #define MP3_SI          MP3_PORT,1      ; serial input  - pokud MP3_CS=1, tak posilame mp3 data, pokud =
                            0, tak posilame prikaz
                      00032 #define MP3_SCLK        MP3_PORT,2      ; clock - nabezna hrana urcuje platnost dat pri seriovem prenosu
                      00033 #define MP3_CS          MP3_PORT,3      ; cable select  - pokud MP3_CS=1, tak po SI posilame mp3 data, p
                            okud =0, tak posilame prikaz
                      00034 #define MP3_DREQ        MP3_PORT,4      ; data request  - pokud =1, tak dekoder pozaduje dalsi mp3 data
                      00035 #define MP3_BSYNC       MP3_PORT,5      ; pro synchronizaci - ma byt nastaven pri prvnim prenasenem bitu
                             kazdeho bytu
                      00036 ;**********************************************************
                      00037 ; pokud jsem dobre pochopil dataSheat dekoderu vs1001, tak staci do nej jen cpat data, a kdyz skonci mp3
                            , tak odeslat 1024 nulovych bytu,
                      00038 ; softwarove resetovat a posilat dalsi mp3...
                      00039 ;
                      00040 ; popis registru obvodu vs1001 najdete na strane 22 dataSheatu 
                      00041 ; v jeho registrech jsou k dispozici data z hlavicky mp3, zdali mp3 ma spravny format, 
                      00042 ; ovladani hlasitosti a dalsi spousty uzitecnych informaci
                      00043 ;**********************************************************
                      00044 ; PORTY DISKU
  00000007            00045 ATA_ADDRESS             equ PORTC
  00000009            00046 ATA_CONTROL             equ PORTE
  00000006            00047 DATA_PORT_LOW           equ PORTB
  00000008            00048 DATA_PORT_HIGH          equ PORTD
                      00049 
                      00050 
  00000087            00051 ATA_ADDRESS_TRIS        equ TRISC
  00000089            00052 ATA_CONTROL_TRIS        equ TRISE
  00000086            00053 DATA_PORT_LOW_TRIS      equ TRISB
  00000088            00054 DATA_PORT_HIGH_TRIS     equ TRISD
                      00055 
                      00056 ; bity ATA_ADDRESS portu
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE  3


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00057 #define ERROR_LED       ATA_ADDRESS,3
                      00058 ; bity ATA_CONTROL portu
                      00059 #define ATA_RESET_N     ATA_CONTROL,0
                      00060 #define ATA_DIOW_N      ATA_CONTROL,1
                      00061 #define ATA_DIOR_N      ATA_CONTROL,2
                      00062 
                      00063 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00064 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00065 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00066 ; DEFINICE KONSTANT
                      00067 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00068 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00069 ; ADRESY ATA REGISTRU:
                      00070 ;                                                                       / CHS adressing
                      00071 ;   +-----------+--------------+-------------------+-----------------+
                      00072 ;   | CS0- CS1- |  DA2 DA1 DA0 | READ              | WRITE           |   
                      00073 ;   +-----------+--------------+-------------------+-----------------+
                      00074 ;   | 1    1    |  x   x   x   | data bush h.imped (validace prikazu)|
                      00075 ;   +-----------+--------------+-------------------+-----------------+
                      00076 ;   | 1    0    |  1   1   0   | alternate status  | device control  |
                      00077 ;   +-----------+--------------+-------------------+-----------------+
                      00078 ;   | 0    1    |  0   0   0   | data              | data            |
                      00079 ;   | 0    1    |  0   0   1   | error             | features        |
                      00080 ;   | 0    1    |  0   1   0   |             sector count            |
                      00081 ;   | 0    1    |  0   1   1   |             LBA bits 0-7            |  sector number
                      00082 ;   | 0    1    |  1   0   0   |             LBA bits 8-15           |  cilinder LOW 
                      00083 ;   | 0    1    |  1   0   1   |             LBA bits 16-23          |  cilinder HIGH
                      00084 ;   | 0    1    |  1   1   0   |         device / LBA bits 24-27*    |  device, head
                      00085 ;   | 0    1    |  1   1   1   | status            | command         |
                      00086 ;   +-----------+--------------+-------------------+-----------------+
                      00087 ;   | 0    0    |  0   0   0   | invalid addres    | invalid addres  |
                      00088 ;   +-----------+--------------+-------------------+-----------------+
                      00089 ;
                      00090 ;   * 7 6 5 4   3     2     1     0 
                      00091 ;     1 L 1 DEV LBA27 LBA26 LBA25 LBA24
                      00092 ;  L=1 -> aresa je LBA , L=0 -> adresa je CHS
                      00093 ;  DEV=0 -> master , DEV=1 -> SLAVE
                      00094 ;
                      00095 ;  pokud disk podporuje LBA 48, tak je zadavani adresy trochu odlisne od LBA27
                      00096 ;**********************************************************
                      00097 ; toto jsou definice adres ATA registru. Staci udat jejich adresu na ATA_ADDRESS port a dat prikaz ke ct
                            eni ci zapisu (DIOR- / DIOW-)
  00000016            00098 D_STATUS_A    equ b'00010110'
  00000016            00099 D_DEVICE_C    equ D_STATUS_A
  00000020            00100 D_DATA_R      equ b'00100000'
  00000021            00101 D_FEATURES    equ b'00100001'
  00000021            00102 D_ERROR       equ D_FEATURES
  00000022            00103 D_SECTOR_C    equ b'00100010'
  00000023            00104 D_LBA1        equ b'00100011'   ; LBA low
  00000024            00105 D_LBA2        equ b'00100100'   ; LBA middle
  00000025            00106 D_LBA3        equ b'00100101'   ; LBA high
  00000026            00107 D_DEVICE      equ b'00100110'
  00000027            00108 D_STATUS      equ b'00100111'
  00000027            00109 D_COMMAND     equ D_STATUS
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE  4


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00110 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00111 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00112 ; ROZLOZENI PAMETI PROGRAMU
                      00113 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00114 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00115 ;       page 0  0x0000 - 0x07FF
                      00116 ;                               - mp3.asm (hlavni smycka)
                      00117 ;                               - ata.asm
                      00118 ;                               - fat32.asm
                      00119 ;                               - aritmetic.asm
                      00120 ;       page 1  0x0800 - 0x0FFF
                      00121 ;                               - vs1001.asm
                      00122 ;                               - commands.asm
                      00123 ;       page 2  0x1000 - 0x17FF
                      00124 ;       page 3  0x1800 - 0x1FFF
                      00125 ;
                      00126 ; Vsechny podprogramy by mely nechat nastaven PCLATH na hodnotu jak se do nich vstoupilo...
                      00127 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00128 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00129 ; DEFINICE PROMENNYCH
                      00130 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00131 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00132 ; MAPA PAMETI: (368 bytu)
                      00133 ;       BANK 0:         0x000 - 0x01F = specialni registry,
                      00134 ;                               0x020 - 0x07F = misto (96bytu) pro nase registry:
                      00135 ;                                       0x020 - 0x034 -> 21bytu pro registry a parametry HDD
                      00136 ;                                       0x035 - 0x03a -> 6bytu pro parametry podprogramu (musime zajisti
                            t, abychom nepouzivali registry, ktere pouzivaji i podprogramy!!!)
                      00137 ;                                       0x03B - 0x04C -> parametry FATky
                      00138 ;                                       0x04D - 0x050 -> registry pro praci s VS1001
                      00139 ;                                       0x051 - 0x05E -> ---------------------------
                      00140 ;                                       0x05F - 0x06F -> informace potrebne pro prehravani
                      00141 ;                               0x070 - 0x07F -> registry pro potreby preruseni (dostupne z kterekoliv b
                            anky)
                      00142 ;                                       0x070 - 0x072 -> 3 registry slouzici k zalohovani W, STATUS, FSR
                      00143 ;                                       0x073 - 0x076 -> registry pro prikazy a preruseni + zaloha pro P
                            CLATH
                      00144 ;                                       0x077         -> ---------------------------
                      00145 ;                                       0x078 - 0x07F -> 8 bytu zasobniku prikazu (obsahujici data prika
                            zu prisla po USARTU)
                      00146 ;
                      00147 ;       BANK 1:         0x080 - 0x09F = specialni registry,
                      00148 ;                               0x0A0 - 0x0EF = volne misto (80bytu)
                      00149 ;                                       0x0A0 - 0x0AC -> parametry a navratove hodnoty z aritmeto/logick
                            ych podprogramu
                      00150 ;                                       0x0AD - 0x0EF -> --------------------------- (67bytu)
                      00151 ;
                      00152 ;       BANK 2:         0x100 - 0x10F = specialni registry,
                      00153 ;                               0x110 - 0x16F = misto (96bytu) pro nase registry:
                      00154 ;                                       0x110 - 0x14F -> 64bytu BUFFER_2 (pro dlouhe nazvy souboru, tabu
                            lku oddilu, a treba pro cast fatky)
                      00155 ;                                       0x150 - 0x16F -> --------------------------- (32bytu)
                      00156 ;
                      00157 ;       BANK 3:         0x180 - 0x18F = specialni registry,
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE  5


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00158 ;                               0x190 - 0x1EF = misto (96bytu) pro nase registry:
                      00159 ;                                       0x190 - 0x1CF -> 64bytu BUFFER_1 (pro ruzna data pri cteni...)
                      00160 ;                                       0x1D0 - 0x1EF -> --------------------------- (32 bytu)
                      00161 
                      00162 ; prectena ci zapisovana data
  00000020            00163 DATA_L                  equ 0x020 ; res 1
  00000021            00164 DATA_H                  equ 0x021
                      00165 ; HODNOTY ATA REGISTRU 
  00000022            00166 ATA_STATUS_A    equ 0x022
  00000023            00167 DEVICE_C                equ 0x023
  00000024            00168 FEATURES                equ 0x024
  00000025            00169 ATA_ERROR               equ 0x025
  00000026            00170 SECTOR_C                equ 0x026
  00000027            00171 LBA1                    equ 0x027       ; alias  SECTOR_N
  00000028            00172 LBA2                    equ 0x028       ; alias  CILINDER_L
  00000029            00173 LBA3                    equ 0x029       ; alias  CILINDER_H
  0000002A            00174 LBA4                    equ 0x02a       ; toto neni registr ATA, ale pouze posledni cast aktualni adresy
  0000002B            00175 DEVICE                  equ 0x02b       ; alias  DEVICE_H
  0000002C            00176 ATA_STATUS              equ 0x02c
  0000002D            00177 COMMAND                 equ 0x02d
                      00178 ;**********************************************************
                      00179 ; BITY ATA REGISTRU
                      00180          ; ATA_STATUS register
  00000007            00181 BSY                             equ 7   ; = 1 -> disk je zaneprazdneny, ostatni registry nemusi obsahova
                            t pravdivou informaci
  00000006            00182 DRDY                    equ 6   ; = 1 -> disk ready (pripraven k praci)
  00000003            00183 DRQ                             equ 3   ; = 1 -> signalizuje, ze jsou pripravena data ke cteni 
  00000000            00184 ERR                             equ 0   ; = 1 -> pri provadeni posledniho prikazu doslo k chybe
                      00185          ; ATA_ERROR register
  00000002            00186 ABRT                    equ 2   ; = 1 -> prikaz aborted (spatny optkode prikazu)
                      00187          ; DEVICE_C (control) register
  00000002            00188 SRST                    equ 2   ; nastavime-li, provedeme soft. reset disku
  00000001            00189 nEIN                    equ 1   ; zakazuje preruseni disku (signal INTRQ)
  00000007            00190 HOB                             equ 7   ; tento bit DEVICE CONTROL se nastavuje pouze pokud disk podporu
                            je LBA 48 a cteme horni cast adresy LBA...
                      00191 ;**********************************************************
  0000002E            00192 ATA_ATTRIBUTES  equ 0x02e       ; Parametry hardisku. 
                      00193 ;Bity maji nasledujici vyznam:
  00000000            00194 ATA_OK                  equ 0   ; 0. bit = 1 -> disk je pritomen, zapnuty a funkcni :-)
  00000001            00195 LBA_SUPPORT             equ 1   ; 1. bit = 1 -> podpora LBA (pokud neni nastaven bit2, tak pouze LBA28 -
                            > disk do 120GB)
  00000002            00196 LBA48_SUPPORT   equ 2   ; 2. bit = 1 -> podpora LBA 48 (disk je zrejme vetsi jak 120GB)
  00000003            00197 BIG_SECTOR              equ 3   ; 3. bit = 1 -> velikost sektoru je vetsi nez 256 !!! (s takovym diskem 
                            zatim tento program neumi)
  00000004            00198 FAT32_LOAD              equ 4   ; 4. bit = 1 -> FATka byla uspesne analyzovana a udaje o ni jsou pravdiv
                            e
                      00199                                                 ; 5. bit  -> nepouzit
                      00200                                                 ; 6. bit  -> nepouzit (tyto tri bity treba pouziju pro v
                            lastnosti FATky)
  00000007            00201 APPLICABLE              equ 7   ; 7. bit = 1 -> disk je pro nas pouzitelny (LBA, sektor o 512B)
                      00202 
                      00203 
  0000002F            00204 PARAM_MAX_LBA1  equ 0x02F               ; [4B] maximalni hodnota LBA (velikost disku)   
  00000030            00205 PARAM_MAX_LBA2  equ 0x030               ; tady pozor, disky mohou byt adresovany az LBA 48, MBR je ale o
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE  6


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                            mezen na LBA 32 (2TB)
  00000031            00206 PARAM_MAX_LBA3  equ 0x031               ; tak by nemelo smysl vsech 48b kdyz by se nevyuzily. (Navic jse
                            m disk vetsi nez 2TB nevidel :)
  00000032            00207 PARAM_MAX_LBA4  equ 0x032               ; (registr s indexem 1 ma nejnizsi vahu)
                      00208 
  00000033            00209 PARAM_SLOV_V_SEKTORU1   equ 0x33 ; [2B] disky mohou mit velikost sektoru vetsi nez 512 (256sl) 
  00000034            00210 PARAM_SLOV_V_SEKTORU2   equ 0x34 
                      00211 ; pokud je to zapsano takto, nejvyznamejsi bity jsou niz v paneti (PARAM_MAX_LBA + X)
                      00212 ; pokud je zapsano jako skupina LBA1, LBA2, LBA3, LBA4, tak nejvyznamejsi bity jsou v LBA4
                      00213 ;**********************************************************
                      00214 ; pomocne registry pouzivane v podprogramech 
                      00215 ; !!! MUSIME ZAJISTIT ABY NEBYLY POUZIVANY VE VNORENYCH PODPROGRAMECH !!!
  00000035            00216 TEMPW                   equ 0x035
  00000036            00217 TEMP1                   equ 0x036
  00000037            00218 TEMP2                   equ 0x037
  00000038            00219 TEMP3                   equ 0x038
  00000039            00220 TEMP4                   equ 0x039
  0000003A            00221 TEMP5                   equ 0x03A
                      00222 
                      00223 ; !!! pomocne promenne pro spozdovaci smycky jsou na stejnych mistech
                      00224 ; pouzito pro synchronizaci s prog. picdelay
  00000036            00225 TMP1                    equ 0x036
  00000037            00226 TMP2                    equ 0x037
  00000038            00227 TMP0                    equ 0x038
                      00228 ;**********************************************************
                      00229 ; registry pro praci s FATkou
  0000003B            00230 POZICE                  equ 0x03B               ; na ukladani aktualni pozice v slusteru, pripadne jine 
                            kokotiny
  0000003C            00231 CLUSTER1                equ 0x03C
  0000003D            00232 CLUSTER2                equ 0x03D
  0000003E            00233 CLUSTER3                equ 0x03E
  0000003F            00234 CLUSTER4                equ 0x03F
                      00235 
  00000040            00236 POCATEK_DAT1    equ 0x040
  00000041            00237 POCATEK_DAT2    equ 0x041
  00000042            00238 POCATEK_DAT3    equ 0x042
  00000043            00239 POCATEK_DAT4    equ 0x043
                      00240 
  00000044            00241 POCATEK_FAT1    equ 0x044
  00000045            00242 POCATEK_FAT2    equ 0x045
  00000046            00243 POCATEK_FAT3    equ 0x046
  00000047            00244 POCATEK_FAT4    equ 0x047
                      00245 
  00000048            00246 ROOT_DIR_CL1    equ 0x048
  00000049            00247 ROOT_DIR_CL2    equ 0x049
  0000004A            00248 ROOT_DIR_CL3    equ 0x04A
  0000004B            00249 ROOT_DIR_CL4    equ 0x04B
                      00250 
  0000004C            00251 CLUSTER_SIZE    equ 0x04C               ; velikost clusteru (pocet sektoru na cluster)
                      00252 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00253 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00254 ; DEFINICE PROMENNYCH a KONSTANT PRO PRACI S VS1001
                      00255 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00256 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE  7


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00257 ; adresy registru VS1001
  00000000            00258 VSADDR_MODE                     equ .0          ; nastaveni VS1001
  00000001            00259 VSADDR_STATUS           equ .1          ; slouzi pouze pro zapnuti / vypnuti analogove casti (MUTE)
  00000003            00260 VSADDR_CLOCKF           equ .3          ; informuje dekoder o jeho krystalu. !! je nutne pro spravne dek
                            odovani !!
  00000004            00261 VSADDR_DECODE_TIME      equ .4          ; obsahuje cas dekodovani aktualni MP3 !! neaktualizuje se pri s
                            kocich (previjeni)
  00000005            00262 VSADDR_AUDATA           equ .5          ; obsahuje informace o datovem toku a vzorkovaci frekvenci MP3
                      00263         ; bit 15 = 1 => STEREO; = 0 => MONO
                      00264         ; bity 12-9 obsahuji vzorkovaci frekvenci v Hz
                      00265         ;       0000 -> neznama vzorkovaci frekvence
                      00266         ;       0001 -> 44 100
                      00267         ;       0010 -> 48 000
                      00268         ;       0011 -> 32 000
                      00269         ;       0100 -> 22 050
                      00270         ;       0101 -> 24 000 
                      00271         ;       0110 -> 16 000
                      00272         ;       0111 -> 11 025
                      00273         ;       1000 -> 12 000
                      00274         ;       1001 ->  8 000
                      00275         ; bity 8-0 obsahuji bitrate v kbps 
                      00276 
  00000006            00277 VSADDR_WRAM             equ .6                  ; Slouzi k zapisovani uzivatelskeho programu, dato se za
                            pise na adresu v WRAMADDR
  00000007            00278 VSADDR_WRAMADDR equ .7                  ; Adresuje uzivatelskou pamet dekoderu
  00000008            00279 VSADDR_HDAT0    equ .8                  ; Obsahuje informace ziskane z hlavicky MP3
  00000009            00280 VSADDR_HDAT1    equ .9                  ; Obsahuje informace ziskane z hlavicky MP3
  0000000A            00281 VSADDR_AIADDR   equ .10                 ; Start uzivatelskeho programu (vis. datasheet)
  0000000B            00282 VSADDR_VOL              equ .11                 ; ovladani hlasitosti (pro oba kanaly) Horni byte je lev
                            y kanal, dolni byte je pravy kanal
                      00283                                                                 ; (hodnota 0000h znamena hlasitost na ma
                            x., FF00h hraje pouze pravy kanal, FFFFh je ticho)
  0000000D            00284 VSADDR_AICTRL0  equ .13                 ; Registr pro ovladani uzivatelskeho programu
  0000000E            00285 VSADDR_AICTRL1  equ .14                 ; Registr pro ovladani uzivatelskeho programu
                      00286 ;**********************************************************
                      00287 ; registry pro praci s VS1001   
                      00288 ; dekoder VS1001 ma vsechny registry 16bitove, proto za jmeno pisu _L /_H (u nekterych registru potrebuj
                            i pouze jednu cast)
  0000004D            00289 VSREG_MODE_L    equ 0x04D
  0000004E            00290 VSREG_STATUS_L  equ 0x04E
  0000004F            00291 VSREG_VOL_L             equ 0x04F               ; pravy kanal
  00000050            00292 VSREG_VOL_H             equ 0x050               ; levy kanal
                      00293 ;                               equ 0x051
                      00294 ;                               equ 0x052
                      00295 ;                               equ 0x053
                      00296 ;                               equ 0x054
                      00297 ;                               equ 0x055
                      00298 ;                               equ 0x056
                      00299 ;                               equ 0x057
                      00300 ;                               equ 0x058
                      00301 ;                               equ 0x059
                      00302 ;                               equ 0x05A
                      00303 ;                               equ 0x05B
                      00304 ;                               equ 0x05C
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE  8


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00305 ;                               equ 0x05D
  0000005E            00306 PREH_CITAC_PREV equ 0x05E               ; pokud je mp3 previjena pomalu, sem se zapisuje kolik sektoru s
                            e jiz previnulo. 
                      00307                                                                 ; pokud dosahne urcite velikosti, tak se
                             vzdy jeden sektor pusti normalni rychlosti...
  0000005F            00308 PREH_STAV1              equ 0x05F               ; popis registru je pod popisem registru PREH_STAV0
                      00309 ;**********************************************************
                      00310 ;**********************************************************
                      00311 ; informace potrebne pro prehravani
  00000060            00312 PREH_ADDR_CL1           equ 0x060
  00000061            00313 PREH_ADDR_CL2           equ 0x061
  00000062            00314 PREH_ADDR_CL3           equ 0x062
  00000063            00315 PREH_ADDR_CL4           equ 0x063
  00000064            00316 PREH_ADDR_POZICE        equ 0x064
  00000065            00317 PREH_ADDR_ZAZNAM        equ 0x065       ; zaznam v adresari ktery se zrovna prehrava (soubor mp3)
                      00318 
  00000066            00319 PREH_DATA_CL1           equ 0x066
  00000067            00320 PREH_DATA_CL2           equ 0x067
  00000068            00321 PREH_DATA_CL3           equ 0x068
  00000069            00322 PREH_DATA_CL4           equ 0x069
  0000006A            00323 PREH_DATA_POZICE        equ 0x06A       ; aktualni cluster, ktery se prehrava
                      00324 
  0000006B            00325 PREH_STAV0                      equ 0x06B       ; registr obsahuje informace o stavu aktualniho prehrava
                            ni
                      00326                                 ; 0. bit =      0 => stop nebo pausa (nic nehraje)
                      00327                                 ;                       1 => play            (nejaky soubor je prehravan
                            )
                      00328                                 ; 1. bit =      0 => neni zadny soubor k prehravani (nastaveni bitu play
                             nema zadny ucinek)
                      00329                                 ;                       1 => je soubor pripraven k prehravani (muze byt 
                            ale pauza - nic nehraje)
                      00330                                 ; 2. bit =      1 => je nastaven, kdyz se zmeni prehravany soubor (bez v
                            olani prikazu) do doby, nez prijde prikaz na dotaz STAVU... (81h)
                      00331                                 ; 3. bit =      0 => po skonceni souboru se pokracuje v prehravani (zavi
                            si na nastaveni repeatu)
                      00332                                 ;                       1 => po skonceni prehravani souboru se nic nepre
                            hrava (ceka se na prijeti prikazu k prehravani)
                      00333                                 ; 4. bit =      0 => repeat off
                      00334                                 ;                       1 => repeat on
                      00335                                 ; 5. bit =      0 => repeat adresare (prvni cluster adresare musi byt na
                            staven v PREH_ADDR_ZACATEK_CL[1-4] )
                      00336                                 ;                       1 => repeat souboru (po skonceni prehravani soub
                            oru se ten samy soubor zacne prehravat znova)
                      00337                                 ; 6. bit =      0 => 
                      00338                                 ;                       1 => rezervovano (pro nahodny vyber, nebo jiny r
                            ezim prehravani...)
                      00339                                 ; 7. bit =  0 => 
                      00340                                 ;                       1 => rezervovano
                      00341 ;PREH_STAV1                     equ 0x05F
                      00342                                 ; 0. bit =  0 => normalni prehravani
                      00343                                 ;                       1 => previjeni mp3 dopredu
                      00344                                 ; 1. bit =  0 => 
                      00345                                 ;                       1 => rezervovano (pro previjeni dozadu)
                      00346                                 ; 2. bit =      zpusob previjeni,       0 => previji se rychle, potichu
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE  9


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00347                                 ;                                                               1 => pre
                            viji se pomalu, vzdy se po nejake dobe kratky usek souboru prehraje
                      00348                                 ; 3. bit =      0 => normalni nastaveni zvuku
                      00349                                 ;                       1 => zvyrazneni basu a vysek (moznost dekoderu v
                            s1001 "bass/treble enhancer")
                      00350                                 ; 4. bit =      0 => NO MUTE
                      00351                                 ;                       1 => MUTE
                      00352                                 ; 5., 6., 7. bit 
                      00353                                 ;                       => rezervovano
                      00354 
                      00355 
  0000006C            00356 PREH_ADDR_ZACATEK_CL1   equ 0x06C
  0000006D            00357 PREH_ADDR_ZACATEK_CL2   equ 0x06D
  0000006E            00358 PREH_ADDR_ZACATEK_CL3   equ 0x06E
  0000006F            00359 PREH_ADDR_ZACATEK_CL4   equ 0x06F       ; prvni cluster adresare, jez se prave prehrava (pokud je nastav
                            en repeat adresare, tak se po dosazeni konce adresare zacne prehravat znova)
                      00360 
                      00361 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00362 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00363 ; registry pro potreby preruseni + prace s prikazy (jsou totiz dostupne odkudkoliv)
  00000070            00364 TEMP_WORKING    equ 0x070
  00000071            00365 TEMP_STATUS             equ 0x071
  00000072            00366 TEMP_FSR                equ 0x072
  00000073            00367 PRIJATYCH_DAT   equ 0x073               ; ukazuje kolik je platnych dat v zasobniku prikazu (0 -> zasobn
                            ik je prazdny)
  00000074            00368 PRIJATE_DATO    equ 0x074               ; pomocna promenna v preruseni
  00000075            00369 STAV_PRIKAZU    equ 0x075               ; pomocny registr signalizujici stav prikazu umisteneho v zasobn
                            iku prikazu
                      00370                                                                 ; pokud zadna procedura nenastavi do 1, 
                            je prikaz v tuto chvili neplatny
                      00371                                                                 ; pokud prikaz je pro proceduru ale nama
                             zatim dost parametru, muji tento byt nastavit take do 1
  00000076            00372 TEMP_PCLATH             equ 0x076
                      00373 ; 0x078 - 0x07F         -> zasobnik prikazu (data prisla po USARTU)
                      00374 ;**********************************************************
                      00375 ; BANK_1        s touto bankou pracuji procedury provadejici 32 bitove 
                      00376 ;                       aritmeto/logicke operace
  000000A0            00377 OPERAND_X1              equ 0x0A0
  000000A1            00378 OPERAND_X2              equ 0x0A1
  000000A2            00379 OPERAND_X3              equ 0x0A2
  000000A3            00380 OPERAND_X4              equ 0x0A3
                      00381 
  000000A4            00382 OPERAND_Y1              equ 0x0A4
  000000A5            00383 OPERAND_Y2              equ 0x0A5
  000000A6            00384 OPERAND_Y3              equ 0x0A6
  000000A7            00385 OPERAND_Y4              equ 0x0A7
                      00386 
  000000A8            00387 VYSLEDEK1               equ 0x0A8
  000000A9            00388 VYSLEDEK2               equ 0x0A9
  000000AA            00389 VYSLEDEK3               equ 0x0AA
  000000AB            00390 VYSLEDEK4               equ 0x0AB
                      00391 
  000000AC            00392 PRETECENI               equ 0x0AC
                      00393 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE 10


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00394 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00395 ; MAKRA
                      00396 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00397 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00398 BANK_0  macro                                   ; prepnuti do banky 0 v pameti dat
                      00399                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
                      00400                 bcf     STATUS,RP0    
                      00401                 endm
                      00402 BANK_1  macro                                   ; prepnuti do banky 1 v pameti dat
                      00403                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
                      00404                 bsf     STATUS,RP0    
                      00405                 endm
                      00406 BANK_2  macro                                   ; prepnuti do banky 2 v pameti dat
                      00407                 bsf     STATUS,RP1              ; BANK2  RP1:RP0 = 10
                      00408                 bcf     STATUS,RP0    
                      00409                 endm
                      00410 BANK_3  macro                                   ; prepnuti do banky 3 v pameti dat
                      00411                 bsf     STATUS,RP1              ; BANK3  RP1:RP0 = 11
                      00412                 bsf     STATUS,RP0    
                      00413                 endm
                      00414 ; INDF_BANK_x slouzi k prepinani bank pro neprime adresovani pomoci INDF a FSR
                      00415 INDF_BANK_0     macro               
                      00416                         bcf STATUS,IRP    
                      00417                         endm
                      00418 INDF_BANK_1     macro               
                      00419                         bcf STATUS,IRP    
                      00420                         endm
                      00421 INDF_BANK_2     macro             
                      00422                         bsf STATUS,IRP    
                      00423                         endm
                      00424 INDF_BANK_3     macro             
                      00425                         bsf STATUS,IRP    
                      00426                         endm
                      00427 ;**********************************************************
                      00428 PROG_PAGE_0     macro             
                      00429                         bcf PCLATH,3
                      00430                         bcf PCLATH,4
                      00431                         endm
                      00432 PROG_PAGE_1     macro             
                      00433                         bsf PCLATH,3
                      00434                         bcf PCLATH,4
                      00435                         endm
                      00436 PROG_PAGE_2     macro             
                      00437                         bcf PCLATH,3
                      00438                         bsf PCLATH,4
                      00439                         endm
                      00440 PROG_PAGE_3     macro             
                      00441                         bsf PCLATH,3
                      00442                         bsf PCLATH,4
                      00443                         endm
                      00444 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00044 
                      00045 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00046 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE 11


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00047 ; PROGRAM
                      00048 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00049 ;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                      00050 ;**********************************************************
0010                  00051  org 0x0010
                      00052         include "mp3.asm"               ; hlavni programova smycka
0010                  00001 START
0010   20C6           00002         call INIT_CONFIG        ; nakonfiguruje preruseni, WDT, USART, pull ups...
0011   20B3           00003         call INIT_PORT          ; nastavy trisy, a porty do vychozi polohy
                      00004 
0012   228F           00005         call DELAY_25us         ; chvili pockame, protoze napjeti zdroje co mam doma (stary PC-AT zdroj)
0013   228F           00006         call DELAY_25us         ; zezacatku dost kolisa...
0014   228F           00007         call DELAY_25us
                      00008 
0015   20E9           00009         call POZDRAV                            ; abych se u kompu nenudil
                      00010 
                      00011 #IF VS1001==1
                      00012         PROG_PAGE_1
0016   158A               M                         bsf PCLATH,3
0017   120A               M                         bcf PCLATH,4
0018   20CE           00013         call VS_INIT
                      00014         PROG_PAGE_0
0019   118A               M                         bcf PCLATH,3
001A   120A               M                         bcf PCLATH,4
                      00015 #ENDIF
                      00016 
001B   21F5           00017         call ATA_RESET                          ; resetujeme disk, koukneme zda tu nejakej mame
001C   1C2E           00018         btfss ATA_ATTRIBUTES,ATA_OK
001D   281B           00019         goto $-2                                        ; pokud neni pripojen disk, tak se jej pokousime
                             neustale najit...
001E   0000           00020         nop                                                     ; ...pokud tam zadny disk neni, tak bych
                            om se stejne ani sem nemeli dostat, protoze budem porad cekat na WAIT_FOR_READY
                      00021 
001F   223C           00022         call IDENTIFY_DEVICE            ; koukneme co disk umi
                      00023 
0020                  00024 CEK_PRIKAZ_01h
                      00025         PROG_PAGE_1
0020   158A               M                         bsf PCLATH,3
0021   120A               M                         bcf PCLATH,4
0022   20DD           00026         call CEKEJ_PRIKAZ
                      00027         PROG_PAGE_0
0023   118A               M                         bcf PCLATH,3
0024   120A               M                         bcf PCLATH,4
                      00028 
                      00029 
0025   0878           00030         movfw 0x078                                     ; prvni byte prikazoveho zasobniku
0026   01F3           00031         clrf PRIJATYCH_DAT                      ; prikaz byl vybran -> prazdny zasobnik
0027   3C01           00032         sublw h'01'                                     ; ...pokud to byl prikaz 01h...
0028   1D03           00033         btfss STATUS,Z
0029   2820           00034         goto CEK_PRIKAZ_01h
                      00035 
002A   082E           00036         movfw ATA_ATTRIBUTES            ; ...vodesleme zpet vlastnosti disku a jeho jmenovku (vis. popis
                             protokolu)
002B   20E1           00037         call WR_USART
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE 12


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

002C   20FC           00038         call ODESLI_MODEL_NUMBER        ; odesleme jmeno disku 
                      00039 
002D   22A7           00040         call SCAN_MBR                           ; najdeme oddily s FAT32 a jejich seznam dame do bufferu
                             2
002E                  00041 CEK_PRIKAZ_02h_03h
                      00042         PROG_PAGE_1
002E   158A               M                         bsf PCLATH,3
002F   120A               M                         bcf PCLATH,4
0030   20DD           00043         call CEKEJ_PRIKAZ                       ; pockame si na prikaz
0031   01F5           00044         clrf STAV_PRIKAZU                       ; smazeme registr signalizujici platnost prikazu
0032   20E2           00045         call PRIKAZ_02h                         ; testujeme zda prisel prikaz 02h, pokud ano tak jej pro
                            vedeme a nastavime platnost prikazu
0033   2103           00046         call PRIKAZ_03h                         ; ---//---
                      00047         PROG_PAGE_0
0034   118A               M                         bcf PCLATH,3
0035   120A               M                         bcf PCLATH,4
0036   1C75           00048         btfss STAV_PRIKAZU,0            ; Pokud si zadna z procedur prikaz neprevzala, ...
0037   01F3           00049         clrf PRIJATYCH_DAT                      ; ...vymazeme zasobnik prikazu. (prikaz neni pro tuto ch
                            vili platny)
0038   1E2E           00050         btfss ATA_ATTRIBUTES,FAT32_LOAD ; cekame dokud nedojde k nasteni nejakeho oddilu
0039   282E           00051         goto CEK_PRIKAZ_02h_03h         ; pokud byl oddil vporadku nacten, pokracujeme...
                      00052 
003A   01EB           00053         clrf PREH_STAV0
                      00054 ;*******************************************************************************************************
                            *************
                      00055 ;*******************************************************************************************************
                            *************
                      00056 ;*******************************************************************************************************
                            *************
                      00057 ;*******************************************************************************************************
                            *************
003B                  00058 BIG_LOOP
                      00059         ; Tady ta smycka beha po nacteni disku a nejake FATky porad dokola.
                      00060         ; Pri kazdem prubehu smyckou vyresime prikazy, ktere prisly, a pokud prehravame 
                      00061         ; nejakou mp3 tak dekoder nakrmime jednim sektorem...
                      00062         ; Mimo to musime v teto smycce osefovat, ze kdyz skonci mp3, nacteme dalsi...
003B   0873           00063         movfw PRIJATYCH_DAT
003C   39FF           00064         andlw h'FF'
003D   1903           00065         btfsc STATUS,Z
003E   2850           00066         goto BIG_LOOP__NENI_PRIKAZ
                      00067         
003F   01F5           00068         clrf STAV_PRIKAZU                       ; smazeme registr signalizujici platnost prikazu
                      00069         ; Pokud jsme tady, tak prisel nejaky prikaz, jdem predat prikaz jednotlivym proceduram
                      00070         PROG_PAGE_1
0040   158A               M                         bsf PCLATH,3
0041   120A               M                         bcf PCLATH,4
0042   2121           00071         call PRIKAZ_04h                         ; testujeme zda prisel prikaz 04h, pokud ano tak jej pro
                            vedeme a nastavime platnost prikazu
0043   212E           00072         call PRIKAZ_05h                         ; --- // ---
0044   2172           00073         call PRIKAZ_06h                         ; --- // ---
0045   2194           00074         call PRIKAZ_07h                         ; --- // ---
0046   21BB           00075         call PRIKAZ_08h                         ; --- // ---
                      00076 
0047   2204           00077         call PRIKAZ_80h                         ; --- // ---
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE 13


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0048   2268           00078         call PRIKAZ_81h                         ; --- // ---
0049   2287           00079         call PRIKAZ_82h                         ; --- // ---
004A   229D           00080         call PRIKAZ_83h                         ; --- // ---
004B   22C5           00081         call PRIKAZ_84h                         ; --- // ---
                      00082         PROG_PAGE_0
004C   118A               M                         bcf PCLATH,3
004D   120A               M                         bcf PCLATH,4
                      00083         
004E   1C75           00084         btfss STAV_PRIKAZU,0            ; Pokud si zadna z procedur prikaz neprevzala, ...
004F   01F3           00085         clrf PRIJATYCH_DAT                      ; ...vymazeme zasobnik prikazu. (prikaz neni pro tuto ch
                            vili platny)
                      00086 
0050                  00087 BIG_LOOP__NENI_PRIKAZ
                      00088 
                      00089 #IF VS1001==1                                   ; pokud mame pripojen dekoder,...
0050   1C6B           00090         btfss PREH_STAV0,0                      ; ...je zvoleno play,...
0051   28AE           00091         goto MP3_NOT_PLAY
                      00092 
0052   1CEB           00093         btfss PREH_STAV0,1                      ; ...a je co prehravat...
0053   28AE           00094         goto MP3_NOT_PLAY
                      00095         
0054   086A           00096         movfw PREH_DATA_POZICE
0055   024C           00097         subwf CLUSTER_SIZE,W
0056   1D03           00098         btfss STATUS,Z                          ; ...podivame se zda jiz nejsme na konci clusteru...
0057   2871           00099         goto SEND_MP3_DATA
                      00100 
0058   0866           00101         movfw PREH_DATA_CL1                     ; ...pokud jo, tak si najdeme dalsi cluster v retezci.
0059   00BC           00102         movwf CLUSTER1
005A   0867           00103         movfw PREH_DATA_CL2
005B   00BD           00104         movwf CLUSTER2
005C   0868           00105         movfw PREH_DATA_CL3
005D   00BE           00106         movwf CLUSTER3
005E   0869           00107         movfw PREH_DATA_CL4
005F   00BF           00108         movwf CLUSTER4
                      00109 
0060   01EA           00110         clrf PREH_DATA_POZICE
0061   248D           00111         call NEXT_CLUSTER
0062   083C           00112         movfw CLUSTER1
0063   00E6           00113         movwf PREH_DATA_CL1
0064   083D           00114         movfw CLUSTER2
0065   00E7           00115         movwf PREH_DATA_CL2
0066   083E           00116         movfw CLUSTER3
0067   00E8           00117         movwf PREH_DATA_CL3
0068   083F           00118         movfw CLUSTER4
0069   00E9           00119         movwf PREH_DATA_CL4
                      00120         
006A   1C3B           00121         btfss POZICE,0                          ; Pokud byl cluster posledni v retezci...
006B   2871           00122         goto SEND_MP3_DATA
                      00123 
006C   20AF           00124         call DALSI_SKLADBA                      ; ...tak najdeme dalsi soubor co se ma prehrat (pokud je
                             nastaven repeat a dalsi kraviny)
                      00125         ; otestujeme zda se ma nejaka dalsi mp3 prehravat
006D   1C6B           00126         btfss PREH_STAV0,0                      ; Je zvoleno play?
006E   28AE           00127         goto MP3_NOT_PLAY
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE 14


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

006F   1CEB           00128         btfss PREH_STAV0,1                      ; Je co prehravat?
0070   28AE           00129         goto MP3_NOT_PLAY
                      00130 
0071                  00131 SEND_MP3_DATA
0071   1C5F           00132         btfss PREH_STAV1,0                      ; 0. bit = 1 => previjeni mp3 dopredu
0072   288C           00133         goto NOT_MP3_REWIND_FORWARD
0073   14CD           00134         bsf VSREG_MODE_L,1                      ; fast forward on
                      00135 
0074   1D5F           00136         btfss PREH_STAV1,2                      ; 2. bit = 1 => previji se pomalu, vzdy se po nejake dob
                            e kratky usek souboru prehraje  
0075   2880           00137         goto MP3_REWIND_FORWARD
                      00138 
0076   085E           00139         movfw PREH_CITAC_PREV           ; MP3 previjime pomalu...
0077   3C14           00140         sublw .20                                       ; ...podivame se kolik sektoru jsme previnuly...
0078   1803           00141         btfsc STATUS,C                          ; ...pokud jich je vic jak 20...
0079   2880           00142         goto MP3_REWIND_FORWARD         ; 
                      00143         
007A   10CD           00144         bcf VSREG_MODE_L,1                      ; ...tak dalsi pustime normalne. (fast forward off)
                      00145 
007B   085E           00146         movfw PREH_CITAC_PREV
007C   3C19           00147         sublw .25
007D   1D03           00148         btfss STATUS,Z                          ; pokud jsme jich uz normalne pustily 5, ... (25-20)
007E   2880           00149         goto MP3_REWIND_FORWARD
                      00150 
007F   01DE           00151         clrf PREH_CITAC_PREV            ; ...vymazeme citac previjeni (zas nejaky sektory pustime rychle
                            )
0080                  00152 MP3_REWIND_FORWARD
0080   3000           00153         movlw VSADDR_MODE
0081   00B6           00154         movwf TEMP1
0082   084D           00155         movfw VSREG_MODE_L
0083   00B7           00156         movwf TEMP2
0084   01B8           00157         clrf TEMP3
                      00158         PROG_PAGE_1     
0085   158A               M                         bsf PCLATH,3
0086   120A               M                         bcf PCLATH,4
0087   2063           00159         call VS_WR_REG
                      00160         PROG_PAGE_0
0088   118A               M                         bcf PCLATH,3
0089   120A               M                         bcf PCLATH,4
                      00161         
008A   195F           00162         btfsc PREH_STAV1,2                      ; 2. bit = 1 => previji se pomalu, vzdy se po nejake dob
                            e kratky usek souboru prehraje  
008B   0ADE           00163         incf PREH_CITAC_PREV,f
008C                  00164 NOT_MP3_REWIND_FORWARD
                      00165 
008C   0866           00166         movfw PREH_DATA_CL1                     ; Mame zjisteny cluster a jeho cast, kterou mame prehrav
                            at...
008D   00BC           00167         movwf CLUSTER1
008E   0867           00168         movfw PREH_DATA_CL2
008F   00BD           00169         movwf CLUSTER2
0090   0868           00170         movfw PREH_DATA_CL3
0091   00BE           00171         movwf CLUSTER3
0092   0869           00172         movfw PREH_DATA_CL4
0093   00BF           00173         movwf CLUSTER4
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE 15


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0094   086A           00174         movfw PREH_DATA_POZICE
0095   00BB           00175         movwf POZICE
                      00176 
0096   242E           00177         call CLUSTER_TO_LBA                     ; zjistime si skutecnou polohu dat na disku...
0097   3001           00178         movlw .1
0098   00A6           00179         movwf SECTOR_C
0099   2210           00180         call READ_SECTOR                        ; dame prikaz precist data...
                      00181 
009A   1585           00182         bsf MP3_CS                                      ; po SI posilam data
009B   3000           00183         movlw .0                                        ; posilame celkem 256 slov
009C   00B6           00184         movwf TEMP1             
009D                  00185 SEND_MP3_WORD
                      00186         PROG_PAGE_1
009D   158A               M                         bsf PCLATH,3
009E   120A               M                         bcf PCLATH,4
009F   20A5           00187         call WAIT_FOR_VSDREQ
                      00188         PROG_PAGE_0
00A0   118A               M                         bcf PCLATH,3
00A1   120A               M                         bcf PCLATH,4
00A2   21C0           00189         call READ_DATA
00A3   0820           00190         movfw DATA_L
                      00191         PROG_PAGE_1
00A4   158A               M                         bsf PCLATH,3
00A5   120A               M                         bcf PCLATH,4
00A6   2000           00192         call VS_WR_BYTE
00A7   0821           00193         movfw DATA_H
00A8   2000           00194         call VS_WR_BYTE
                      00195         PROG_PAGE_0
00A9   118A               M                         bcf PCLATH,3
00AA   120A               M                         bcf PCLATH,4
00AB   0BB6           00196         decfsz TEMP1,f  
00AC   289D           00197         goto SEND_MP3_WORD
                      00198 
00AD   0AEA           00199         incf PREH_DATA_POZICE,f
00AE                  00200 MP3_NOT_PLAY
                      00201 #ENDIF
                      00202 
00AE   283B           00203         goto BIG_LOOP
                      00204 ;*******************************************************************************************************
                            *************
                      00205 ;*******************************************************************************************************
                            *************
                      00206 ;*******************************************************************************************************
                            *************
                      00207 ;*******************************************************************************************************
                            *************
00AF                  00208 DALSI_SKLADBA
00AF   106B           00209         bcf PREH_STAV0,0
00B0   10EB           00210         bcf PREH_STAV0,1
00B1   116B           00211         bcf PREH_STAV0,2        
00B2   0008           00212         return
                      00213 ;*******************************************************************************************************
                            *************
00B3                  00214 INIT_PORT
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE 16


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00215         BANK_1
00B3   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
00B4   1683               M                 bsf     STATUS,RP0    
                      00216 
                      00217 #IF VS1001==1
00B5   3011           00218         movlw b'00010001'                       ; bity SO a DREQ jako vstupy (signaly z dekoderu)
                      00219 #ELSE
                      00220         movlw 0xff
                      00221 #ENDIF
                      00222 
00B6   0085           00223         movwf MP3_PORT_TRIS
00B7   3080           00224         movlw b'10000000'                       ; adresovani disku jako vystupy
00B8   0087           00225         movwf ATA_ADDRESS_TRIS          
00B9   3000           00226         movlw .0
00BA   0089           00227         movwf ATA_CONTROL_TRIS          ; ovladani disku jako vystupy
00BB   30FF           00228         movlw 0xff
00BC   0086           00229         movwf DATA_PORT_LOW_TRIS        ; datovou sbernici jako vstupy
00BD   0088           00230         movwf DATA_PORT_HIGH_TRIS       
                      00231         BANK_0
00BE   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
00BF   1283               M                 bcf     STATUS,RP0    
                      00232         
00C0   3007           00233         movlw b'00000111'       ; signal reset-, diow- a dior- jsou aktivni v log. 0 !!!
00C1   0089           00234         movwf ATA_CONTROL
00C2   3037           00235         movlw b'00110111'       ; CS1-, CS0- = 1 => datova sbernice disku je odpojena
00C3   0087           00236         movwf ATA_ADDRESS
00C4   0185           00237         clrf MP3_PORT   
00C5   0008           00238         return
                      00239 ;**********************************************************
00C6                  00240 INIT_CONFIG     ; nakonfiguruje preruseni, WDT, USART, pull ups....
                      00241         BANK_1
00C6   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
00C7   1683               M                 bsf     STATUS,RP0    
00C8   30C7           00242         movlw b'11000111'       ; ...pull up a podobny koniny
                      00243                 ; PORTB Pull-up Enable bit              1 = pull up enabled
                      00244                 ; Interrupt Edge Select bit             1 = interrupt on rising edge of RB0/INT pin
                      00245                 ; TMR0 Clock Source Select bit  0 = Internal instruction cycle clock (CLKO)
                      00246                 ; TMR0 Source Edge Select bit   0 = Increment on low-to-high transition on RA4/T0CKI pin
                      00247                 ; Prescaler Assignment bit              0 = Prescaler is assigned to the Timer0 module
                      00248                 ; PS2:PS0: Prescaler Rate Select bits   111 = TMR0 Rate 1 : 256; WDT Rate 1 : 128
00C9   0081           00249         movwf OPTION_REG
                      00250         
00CA   3020           00251         movlw b'00100000'       ; povolime preruseni od USARTu (kdyz neco dostanem)
00CB   008C           00252         movwf PIE1      
00CC   3000           00253         movlw b'00000000'       ; ostatni vnejsi preruseni vymaskujeme
00CD   008D           00254         movwf PIE2                      
                      00255 
00CE   30C0           00256         movlw b'11000000'       ; povolime preruseni na vnejsi zarizeni (USART)                         
00CF   008B           00257         movwf INTCON
                      00258 
00D0   3026           00259         movlw b'00100110'       ;konfigurace USARTu (asynchronni, 8bit, bez parity, rychle - (BRGH = 1))
00D1   0098           00260         movwf TXSTA
                      00261         BANK_0
00D2   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE 17


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

00D3   1283               M                 bcf     STATUS,RP0    
00D4   3090           00262         movlw b'10010000'       ;zapnu USART
00D5   0098           00263         movwf RCSTA
                      00264         BANK_1
00D6   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
00D7   1683               M                 bsf     STATUS,RP0    
                      00265         ;movlw .129             ; Fosc = 20 MHz, BRGH=1 => rychlost = 9615 bps
00D8   3067           00266         movlw .103                      ; Fosc = 16 MHz, BRGH=1 => rychlost = 9615 bps
00D9   0099           00267         movwf SPBRG     
                      00268 
00DA   3007           00269         movlw b'00000111'
00DB   009F           00270         movwf ADCON1            ; vsechny vstupy (RA,RE) jako digitalni
                      00271         BANK_0  
00DC   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
00DD   1283               M                 bcf     STATUS,RP0    
00DE   019F           00272         clrf ADCON0                     ; pro jistotu (vypneme A/D prevodniky)
                      00273 
00DF   01F3           00274         clrf PRIJATYCH_DAT      ; zasobnik prikazu prazdny...
00E0   0008           00275         return
                      00276 ;**********************************************************
00E1                  00277 WR_USART        ; odesle slovo ve workingu po USARTu
                      00278                         ; prijimani dat je reseno prez preruseni...
                      00279         BANK_1  
00E1   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
00E2   1683               M                 bsf     STATUS,RP0    
00E3   1C98           00280         btfss TXSTA,1 
00E4   28E1           00281         goto WR_USART   ; cekame do chvile nez bude pripraven transmit buffer 
                      00282 
                      00283         BANK_0  
00E5   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
00E6   1283               M                 bcf     STATUS,RP0    
00E7   0099           00284         movwf TXREG
00E8   0008           00285         return
                      00286 ;**********************************************************
                      00287 ; tento podprogram bude pro budouci praci zbytecny, je zde jen proto, abych na PC videl ze program byl s
                            pusten...
00E9                  00288 POZDRAV  ; odesle po seriove lince pozdrav
00E9   3041           00289         movlw 'A'       
00EA   20E1           00290         call WR_USART
00EB   3068           00291         movlw 'h'
00EC   20E1           00292         call WR_USART
00ED   306F           00293         movlw 'o'
00EE   20E1           00294         call WR_USART
00EF   306A           00295         movlw 'j'
00F0   20E1           00296         call WR_USART
00F1   3021           00297         movlw '!'
00F2   20E1           00298         call WR_USART
00F3   0008           00299         return
                      00300 ;**********************************************************
                      00301 ; odesle data, ktera jdou z disku USARTEM. Pocet dat je v reg. TEMP1
00F4                  00302 ODESLI_DATA
00F4   21C0           00303         call READ_DATA  
00F5   0820           00304         movfw DATA_L
00F6   20E1           00305         call WR_USART
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE 18


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

00F7   0821           00306         movfw DATA_H
00F8   20E1           00307         call WR_USART   
00F9   0BB6           00308         decfsz TEMP1,F
00FA   28F4           00309         goto ODESLI_DATA
00FB   0008           00310         return
                      00311 ;**********************************************************
00FC                  00312 ODESLI_MODEL_NUMBER     ; Podprogram IDENTIFY_DEVICE nam do bufferu 1 hodil jmeno disku
                      00313                         ; mi jej ted odesleme USARTem, aby mohl byt zobrazen na displeji
                      00314         INDF_BANK_3     ; BUFFER_1 je v bance 3
00FC   1783               M                         bsf STATUS,IRP    
00FD   3090           00315         movlw 0x90      ; na adrese 90
00FE   0084           00316         movwf FSR
00FF   3014           00317         movlw .20       ; budeme odesilat 20 slov (40 znaku)
0100   00B6           00318         movwf TEMP1
0101                  00319 ODESLI_MODEL_NUMBER_ODESILANI
0101   0800           00320         movfw INDF
0102   00B7           00321         movwf TEMP2     ; data do bufferu byla vkladana stylem DATA_L, DATA_H, DATA_L, DATA_H...
0103   0A84           00322         incf FSR,F      ; ASCII hodnoty jsou ale razeny stylem DATA_H, DATA_L, DATA_H, DATA_L...
0104   0800           00323         movfw INDF      ; proto to pisu tak slozite...
0105   0A84           00324         incf FSR,F
                      00325         
0106   20E1           00326         call WR_USART
0107   0837           00327         movfw TEMP2
0108   20E1           00328         call WR_USART   
                      00329 
0109   0BB6           00330         decfsz TEMP1,F
010A   2901           00331         goto ODESLI_MODEL_NUMBER_ODESILANI
                      00332 
                      00333         INDF_BANK_0     
010B   1383               M                         bcf STATUS,IRP    
010C   0008           00334         return
                      00335 ;**********************************************************
010D                  00336 ODESLI_BUFFER2
                      00337         ; v TEMP1 ocakava hodnotu kolik bytu ma odeslat
                      00338         INDF_BANK_2     ; BUFFER_2 je v bance 2
010D   1783               M                         bsf STATUS,IRP    
010E   3010           00339         movlw 0x10      ; na adrese 10
010F   0084           00340         movwf FSR
0110                  00341 ODESLI_BUFFER2_ODESILANI
0110   0800           00342         movfw INDF
0111   20E1           00343         call WR_USART
0112   0A84           00344         incf FSR,F      
0113   0BB6           00345         decfsz TEMP1,F
0114   2910           00346         goto ODESLI_BUFFER2_ODESILANI
                      00347 
                      00348         INDF_BANK_0             
0115   1383               M                         bcf STATUS,IRP    
0116   0008           00349         return
                      00350 ;**********************************************************
0117                  00351 INTERRUPT                                       ; sem se skace po zavolani preruseni (uz jsou vyreseny u
                            lohy dulezitych registru)
0117   1E8C           00352         btfss PIR1,RCIF                 ; Meli bychom mit povoleno sice jen jedno preruseni (od USARTU),
                             jeden ale nikdy nevi, proto ten test
0118   2925           00353         goto END_OF_INTERRUPT   ; Pokud nejde o preruseni od USARTU, tak koncime...
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE 19


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0119   081A           00354         movfw RCREG                             ; !!! vynulovat pznak !!!     
011A   00F4           00355         movwf PRIJATE_DATO
                      00356 
011B   0873           00357         movfw PRIJATYCH_DAT
011C   3C07           00358         sublw .7                                ; pokud je v zasobniku uz plno (PRIJATYCH_DAT=8), tak ko
                            ncime
011D   1C03           00359         btfss STATUS,C
011E   2925           00360         goto END_OF_INTERRUPT   ; Zasobnik je plny, nic prijimat nebudeme
                      00361 
011F   0873           00362         movfw PRIJATYCH_DAT
0120   3E78           00363         addlw 0x78                              ; zacatek zasobniku prikazu
0121   0084           00364         movwf FSR
0122   0874           00365         movfw PRIJATE_DATO              ; prijmuta data -> do W
0123   0080           00366         movwf INDF                              ; prijate dato na prvni volne misto v zasobniku
                      00367         
0124   0AF3           00368         incf  PRIJATYCH_DAT,F   ; pricteme k indikaci zasobniku
                      00369 ;       movlw '['
                      00370 ;       call WR_USART
                      00371 ;       movfw PRIJATYCH_DAT
                      00372 ;       addlw .48
                      00373 ;       call WR_USART
                      00374 ;       movlw ']'
                      00375 ;       call WR_USART   
0125                  00376 END_OF_INTERRUPT                        ; sem skocime kdyz mame vsechny veci kolem preruseni vyrizeny
0125   0876           00377         movfw TEMP_PCLATH
0126   008A           00378         movwf PCLATH
0127   0872           00379         movfw TEMP_FSR
0128   0084           00380         movwf FSR
0129   0871           00381         movfw TEMP_STATUS
012A   0083           00382         movwf STATUS
012B   0870           00383         movfw TEMP_WORKING
012C   0009           00384         retfie
                      00385 ;**********************************************************
012D                  00386 DELAY_2ms
                      00387 ;Delay 8000 cycles
012D   3013           00388         MOVLW 0x13  ;19 DEC
012E   00B6           00389         MOVWF TMP1
012F   308B           00390         MOVLW 0x8B  ;139 DEC
0130   00B8           00391         MOVWF TMP0
0131   0BB8           00392         DECFSZ TMP0,F
0132   2931           00393         GOTO $-1
0133   0BB6           00394         DECFSZ TMP1,F
0134   292F           00395         GOTO $-5
                      00396 ;End of Delay   
0135   0008           00397         return
                      00398 ;**********************************************************
0136                  00399 DELAY_200ms
                      00400 ;Delay 197123 cycles
0136   3000           00401         MOVLW 0x00  ;0 DEC
0137   00B6           00402         MOVWF TMP1
0138   3000           00403         MOVLW 0x00  ;0 DEC
0139   00B8           00404         MOVWF TMP0
013A   0BB8           00405         DECFSZ TMP0,F
013B   293A           00406         GOTO $-1
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE 20


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

013C   0BB6           00407         DECFSZ TMP1,F
013D   293A           00408         GOTO $-3
                      00409 ;End of Delay
013E   0008           00410         return
                      00411 ;**********************************************************
013F                  00412 DELAY_500ms
                      00413 ; (Fosc = 16 MHz , instr. cyklus= 0.25 us) 500 000us / 0.25 us = 2 000 000 instrukcnich cyklu
                      00414 ;Variables: TMP2, TMP1, TMP0
                      00415 ;Delay 2000000 cycles
013F   3047           00416         MOVLW 0x47  ;71 DEC
0140   00B7           00417         MOVWF TMP2
0141   302B           00418         MOVLW 0x2B  ;43 DEC
0142   00B6           00419         MOVWF TMP1
0143   30D9           00420         MOVLW 0x0D9  ;217 DEC
0144   00B8           00421         MOVWF TMP0
0145   0BB8           00422         DECFSZ TMP0,F
0146   2945           00423         GOTO $-1
0147   0BB6           00424         DECFSZ TMP1,F
0148   2943           00425         GOTO $-5
0149   0BB7           00426         DECFSZ TMP2,F
014A   2941           00427         GOTO $-9
                      00428 ;End of Delay
014B   0008           00429         return
                      00430 ;**********************************************************
                      00053         include "ata.asm"               ; podprogramy na ovladani ATA disku
                      00001 ;**********************************************************
                      00002 ;**********************************************************
                      00003 ;**********************************************************
                      00004 ; OBSLUZNE PODPROGRAMY PRO ATA
                      00005 ;**********************************************************
                      00006 ;**********************************************************
                      00007 ;**********************************************************
                      00008 
                      00009 ;**********************************************************
                      00010 ; cteni a zapis ATA registru 
                      00011 ;**********************************************************
014C                  00012 RD_STATUS         
014C   3027           00013         movlw D_STATUS      ; Status 
014D   219D           00014         call RUTR 
014E   00AC           00015         movwf ATA_STATUS
014F   0008           00016         return
                      00017 ;*****************************************
0150                  00018 RD_ERROR
0150   3021           00019         movlw D_ERROR      ; Error
0151   219D           00020         call RUTR
0152   00A5           00021         movwf ATA_ERROR
0153   0008           00022         return
                      00023 ;*****************************************
0154                  00024 RD_STATUS_A     
0154   3016           00025         movlw D_STATUS_A    ; Alternate Status 
0155   219D           00026         call RUTR 
0156   00A2           00027         movwf ATA_STATUS_A
0157   0008           00028         return
                      00029 ;*****************************************
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE 21


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0158                  00030 RD_SC
0158   3022           00031         movlw D_SECTOR_C    ; Sector Count
0159   219D           00032         call RUTR
015A   00A6           00033         movwf SECTOR_C
015B   0008           00034         return
                      00035 ;*****************************************
015C                  00036 RD_LBA1
015C   3023           00037         movlw D_LBA1    ; Sector Number 
015D   219D           00038         call RUTR                
015E   00A7           00039         movwf LBA1 
015F   0008           00040         return
                      00041 ;*****************************************
0160                  00042 RD_LBA2
0160   3024           00043         movlw D_LBA2  ; Cylinder Low
0161   219D           00044         call RUTR
0162   00A8           00045         movwf LBA2
0163   0008           00046         return
                      00047 ;*****************************************
0164                  00048 RD_LBA3
0164   3025           00049         movlw D_LBA3  ; Cylinder High   
0165   219D           00050         call RUTR
0166   00A9           00051         movwf LBA3
0167   0008           00052         return
                      00053 ;*****************************************
0168                  00054 RD_DEVICE
0168   3026           00055         movlw D_DEVICE  ; Device Head
0169   219D           00056         call RUTR
016A   00AB           00057         movwf DEVICE
016B   0008           00058         return
                      00059 ;*****************************************
                      00060 ;*****************************************
016C                  00061 WR_DC
016C   0823           00062         movf DEVICE_C,w     ; Device Control
016D   00B5           00063         movwf TEMPW
016E   3016           00064         movlw D_DEVICE_C
016F   21AA           00065         call RUTW
0170   0008           00066         return
                      00067 ;*****************************************
0171                  00068 WR_COMMAND          
0171   082D           00069         movf COMMAND,w      ; Command       
0172   00B5           00070         movwf TEMPW
0173   3027           00071         movlw D_COMMAND
0174   21AA           00072         call RUTW
0175   0008           00073         return
                      00074 ;*****************************************
0176                  00075 WR_SC                    
0176   0826           00076     movf SECTOR_C,w     ; Sector Count
0177   00B5           00077         movwf TEMPW
0178   3022           00078         movlw D_SECTOR_C     
0179   21AA           00079         call RUTW
017A   0008           00080         return
                      00081 ;*****************************************
017B                  00082 WR_LBA1
017B   0827           00083         movf LBA1,w     
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE 22


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

017C   00B5           00084         movwf TEMPW
017D   3023           00085         movlw D_LBA1    
017E   21AA           00086         call RUTW
017F   0008           00087         return
                      00088 ;*****************************************
0180                  00089 WR_LBA2
0180   0828           00090         movf LBA2,w   ; Cylinder Low
0181   00B5           00091         movwf TEMPW
0182   3024           00092         movlw D_LBA2
0183   21AA           00093         call RUTW
0184   0008           00094         return
                      00095 ;*****************************************
0185                  00096 WR_LBA3
0185   0829           00097         movf LBA3,w   ; Cylinder High
0186   00B5           00098         movwf TEMPW
0187   3025           00099         movlw D_LBA3
0188   21AA           00100         call RUTW
0189   0008           00101         return
                      00102 ;*****************************************
018A                  00103 WR_DEVICE
018A   082B           00104         movf DEVICE,w     ; Device Head 
018B   00B5           00105         movwf TEMPW
018C   3026           00106         movlw D_DEVICE
018D   21AA           00107         call RUTW
018E   0008           00108         return
                      00109 ;*****************************************
018F                  00110 WR_FEATURES
018F   0824           00111         movf FEATURES,w     ; Features
0190   00B5           00112         movwf TEMPW
0191   3021           00113         movlw D_FEATURES
0192   21AA           00114         call RUTW
0193   0008           00115         return
                      00116 ;*****************************************
                      00117 ; zapise vsechny registry potrebne k vykonani prikazu (adresove registry a prikaz)
0194                  00118 WR_BLOCK
0194   22A3           00119         call WAIT_FOR_READY_FOR_COMMAND
0195   218F           00120         call WR_FEATURES
0196   2176           00121         call WR_SC
0197   217B           00122         call WR_LBA1
0198   2180           00123         call WR_LBA2
0199   2185           00124         call WR_LBA3
019A   218A           00125         call WR_DEVICE
019B   2171           00126         call WR_COMMAND
019C   0008           00127         return
                      00128 ;*****************************************
                      00129 ; ve workingu mame adresu registru ktery mame precist, 
                      00130 ; pak v nem vracime jeho hodnotu...
019D                  00131 RUTR          
019D   0087           00132         movwf ATA_ADDRESS                  ; adresa pozadovaneho registru
                      00133 
                      00134         BANK_1
019E   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
019F   1683               M                 bsf     STATUS,RP0    
01A0   30FF           00135     movlw 0xFF
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE 23


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

01A1   0086           00136     movwf DATA_PORT_LOW_TRIS   ; z datove zbernice cteme
01A2   0088           00137     movwf DATA_PORT_HIGH_TRIS
                      00138         BANK_0
01A3   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
01A4   1283               M                 bcf     STATUS,RP0    
                      00139 
01A5   1109           00140         bcf ATA_DIOR_N
01A6   0000           00141     nop                                                 ; PIO delay min. 120ns (PIO 4)  
01A7   0806           00142     movfw DATA_PORT_LOW                 ; Read DD0..D7 IDE
01A8   1509           00143         bsf ATA_DIOR_N
                      00144 
01A9   0008           00145     return
                      00146 ;**********************************************************
                      00147 ; ve workingu mame adresu registru ktery mame zapsat,
                      00148 ; a v reg. TEMPW hodnotu kterou mame do tohoto registru zapsat
01AA                  00149 RUTW
01AA   0087           00150         movwf ATA_ADDRESS
                      00151 
                      00152         BANK_1
01AB   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
01AC   1683               M                 bsf     STATUS,RP0    
01AD   3000           00153     movlw 0x0
01AE   0086           00154     movwf DATA_PORT_LOW_TRIS   ; do datove sbernice zapisujeme
01AF   0088           00155     movwf DATA_PORT_HIGH_TRIS
                      00156         BANK_0
01B0   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
01B1   1283               M                 bcf     STATUS,RP0    
                      00157 
01B2   0835           00158     movf TEMPW,w        
01B3   0086           00159     movwf DATA_PORT_LOW                 ; Write DD0..DD7 IDE 
01B4   0188           00160         clrf DATA_PORT_HIGH
                      00161 
01B5   1089           00162         bcf ATA_DIOW_N
01B6   0000           00163         nop
01B7   1489           00164         bsf ATA_DIOW_N
                      00165           
                      00166         BANK_1
01B8   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
01B9   1683               M                 bsf     STATUS,RP0    
01BA   30FF           00167     movlw 0xff
01BB   0086           00168     movwf DATA_PORT_LOW_TRIS   ; datova sbernice na cteni
01BC   0088           00169     movwf DATA_PORT_HIGH_TRIS
                      00170         BANK_0
01BD   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
01BE   1283               M                 bcf     STATUS,RP0    
                      00171 
01BF   0008           00172         return
                      00173 ;**********************************************************
01C0                  00174 READ_DATA
01C0   2294           00175         call WAIT_FOR_DATA
                      00176 
01C1   3020           00177     movlw D_DATA_R
01C2   0087           00178         movwf ATA_ADDRESS
                      00179 
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE 24


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00180         BANK_1
01C3   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
01C4   1683               M                 bsf     STATUS,RP0    
01C5   30FF           00181     movlw 0xFF
01C6   0086           00182     movwf DATA_PORT_LOW_TRIS   ; z datove zbernice cteme
01C7   0088           00183     movwf DATA_PORT_HIGH_TRIS
                      00184         BANK_0
01C8   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
01C9   1283               M                 bcf     STATUS,RP0    
                      00185 
01CA   1109           00186         bcf ATA_DIOR_N
01CB   0000           00187     nop                                                 ; PIO delay min. 120ns (PIO 4)  
01CC   0000           00188         nop
01CD   0806           00189     movfw DATA_PORT_LOW                 ; Read DD0..D7 IDE
01CE   00A0           00190         movwf DATA_L
01CF   0808           00191     movfw DATA_PORT_HIGH                ; Read DD8..D15 IDE
01D0   00A1           00192         movwf DATA_H
01D1   1509           00193         bsf ATA_DIOR_N
                      00194 
01D2   0008           00195     return
                      00196 ;**********************************************************
                      00197 ; stava se, ze obcas nas zajima jen cast vracenych dat, tak ty ktere nas nezajimaji, preskocime
                      00198 ; ocakava parametr v registru TEMP1 (kolik slov ma preskocit)
                      00199 ; pokud TEMP1 = 0 tak preskoci 256 slov
01D3                  00200 PRESKOC
01D3   21C0           00201         call READ_DATA
01D4   0BB6           00202         decfsz TEMP1,F
01D5   29D3           00203         goto PRESKOC
01D6   0008           00204         return
                      00205 ;**********************************************************
                      00206 ; rekne disku na ze pristi instrukce, registry, data.... budou pro mastera
01D7                  00207 SELECT_DEVICE
01D7   30E0           00208         movlw b'11100000'       ; adresy budou v LBA, budeme pracovat s masterem
01D8   00AB           00209         movwf DEVICE
01D9   218A           00210         call WR_DEVICE
01DA   0008           00211         return
                      00212 ;**********************************************************
01DB                  00213 ZAPIS_DO_BUFFERU_1      ; buffer1 ma 64B a je v bance 3 na adrese 0x190 - 0x1CF
                      00214                                         ; jako parametr dostanem TEMP1, kde je pocet bytu k zapisu
                      00215                                         ; maximalni hodnota v TEMP1 muze byt 32 (1 slovo = 2 byty)
                      00216         INDF_BANK_3             ; neprime adresovani na banku 3
01DB   1783               M                         bsf STATUS,IRP    
01DC   3090           00217         movlw 0x90              ; adresa ja 190, devaty byt urcuje banku (0,1 / 2,3) fsr je tedy 90
01DD   0084           00218         movwf FSR               
01DE                  00219 ZAPIS_DO_BUFFERU_1__ZAPIS
01DE   21C0           00220         call READ_DATA
                      00221         
01DF   0820           00222         movfw DATA_L
01E0   0080           00223         movwf INDF
01E1   0A84           00224         incf FSR,F
01E2   0821           00225         movfw DATA_H
01E3   0080           00226         movwf INDF
01E4   0A84           00227         incf FSR,F
                      00228 
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE 25


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

01E5   0BB6           00229         decfsz TEMP1,F
01E6   29DE           00230         goto ZAPIS_DO_BUFFERU_1__ZAPIS
                      00231 
                      00232         INDF_BANK_0     
01E7   1383               M                         bcf STATUS,IRP    
01E8   0008           00233         return
                      00234 ;**********************************************************
01E9                  00235 CLEAR_BUFFER2           ; BUFFER2 je 64bytu dat v bance 2 na adrese 0x110 - 0x14F
                      00236                                         ; pouziva TEMP1
01E9   3040           00237         movlw .64
01EA   00B6           00238         movwf TEMP1
                      00239         INDF_BANK_2             ; neprime adresovani na banku 2
01EB   1783               M                         bsf STATUS,IRP    
01EC   3010           00240         movlw 0x10
01ED   0084           00241         movwf FSR
01EE   3000           00242         movlw .0
                      00243 
01EF                  00244 CLEAR_BEFFER2__CLEAR
01EF   0080           00245         movwf INDF
01F0   0A84           00246         incf FSR,F
01F1   0BB6           00247         decfsz TEMP1,F
01F2   29EF           00248         goto CLEAR_BEFFER2__CLEAR
                      00249 
                      00250         INDF_BANK_0             ; neprime adresovani na banku 0
01F3   1383               M                         bcf STATUS,IRP    
01F4   0008           00251         return
                      00252 ;**********************************************************
01F5                  00253 ATA_RESET
                      00254         ; Resetuje disk zjisti, zda vubec nejaky disk je pripojen
01F5   01AE           00255         clrf ATA_ATTRIBUTES     ; registr obsahujici bity rikajici co disk umi
                      00256 
01F6   1009           00257         bcf ATA_RESET_N         ; resetujeme disk
01F7   228F           00258         call DELAY_25us         ; signal reset musi byt min. 25us
01F8   1409           00259         bsf ATA_RESET_N         ; koncime s resetem disku
                      00260 
01F9   229D           00261         call WAIT_FOR_READY     ; vynulujeme device bit v DEVICE registru (disk musi byt master!), ...
01FA   21D7           00262         call SELECT_DEVICE      ; ...nastavime bit L - LBA addressing
                      00263 
01FB   229D           00264         call WAIT_FOR_READY
01FC   3002           00265         movlw b'00000010'       ; zakazeme preruseni (ted mam na mysli signal INTRQ z disku)
01FD   00A3           00266         movwf DEVICE_C          ; bit nIEN = 1 -> zakazeme preruseni disku (stejne nemame signal INTRQ p
                            ripojen)
01FE   216C           00267         call WR_DC                      ; zapiseme hodnotu do registru DEVICE CONTROL
                      00268 
01FF   30E0           00269         movlw b'11100000'       ; adresy budou v LBA, budeme pracovat s masterem
0200   00AB           00270         movwf DEVICE
0201   01A6           00271         clrf SECTOR_C
0202   01A7           00272         clrf LBA1       
0203   01A8           00273         clrf LBA2
0204   01A9           00274         clrf LBA3
0205   01A4           00275         clrf FEATURES
0206   3000           00276         movlw h'00'                     ; code prikazu nop
0207   00AD           00277         movwf COMMAND
0208   2194           00278         call WR_BLOCK           ; ted provedeme prvni prikaz (nop) a podivame se co nam disk vrati
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE 26


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00279 
0209   229D           00280         call WAIT_FOR_READY
020A   2168           00281         call RD_DEVICE          ; Precteme reg. device. Pokud je disk OK, tak by nam mel vratit to, co j
                            sme do nej predtim zapsaly
020B   082B           00282         movfw DEVICE
020C   3CE0           00283         sublw b'11100000'
020D   1903           00284         btfsc STATUS,Z          ; pokud DEVICE <> b'11100000', tak tu bud disk nemame, nebo je nejakej r
                            ozsypanej, nebo je spatne svicivanej (treba SLAVE)
020E   142E           00285         bsf ATA_ATTRIBUTES,ATA_OK       ; 0. bit = 1 -> disk je pritomen, zapnuty a funkcni...
                      00286 
020F   0008           00287         return          
                      00288 ;**********************************************************
0210                  00289 READ_SECTOR
                      00290         ; Tento podprogram prevezme parametry SECTOR_C (kolik sec. mame precist)
                      00291         ; a LBA1 - LBA4, kde je ulozena LBA adresa sectoru od ktereho mame cist
                      00292         ; Postara se o spravne zadani adresy do disku (LBA28 / LBA48) a zavolani prikazu ke cteni...
                      00293         ; Samotne cteni se musi obslouzit v jine casti programu (podle toho co cteme...)
0210   229D           00294         call WAIT_FOR_READY
0211   21D7           00295         call SELECT_DEVICE
0212   22A3           00296         call WAIT_FOR_READY_FOR_COMMAND
0213   192E           00297         btfsc ATA_ATTRIBUTES,LBA48_SUPPORT
0214   2A24           00298         goto READ_SECTOR_LBA48
                      00299 
0215                  00300 READ_SECTOR_LBA27               ; zadavani adresy v LBA28 je celkem jednoduche, LBA bity 24-27 jsou obsa
                            zene v dolnich 4 bitech DEVICE reg.
0215   01A4           00301         clrf FEATURES
0216   218F           00302         call WR_FEATURES
0217   2176           00303         call WR_SC
0218   217B           00304         call WR_LBA1
0219   2180           00305         call WR_LBA2
021A   2185           00306         call WR_LBA3
021B   082A           00307         movfw LBA4                      ; Z nejvyssi casti adresy...
021C   390F           00308         andlw b'00001111'       ; ...pouzijeme pouze dolni 4bity...
021D   38E0           00309         iorlw b'11100000'       ; ...horni 3bity nastavime (LBA adresovani, master)...
021E   00AB           00310         movwf DEVICE            ; ...a zapiseme do DEVICE.
021F   218A           00311         call WR_DEVICE
0220   3020           00312         movlw 0x20                      ; Read sector. OPCODE - 20h (with retries) or 21h (without retri
                            es)
0221   00AD           00313         movwf COMMAND           ; ...podle me to znamena ze prikaz 20h se bude pri neuspechu pokouset zn
                            ova o cteni....
0222   2171           00314         call WR_COMMAND         ; ...protoze se v novejsich spicifacich jiz prikaz 21h nevyskytuje, pouz
                            ivam ke cteni 20h.
0223   0008           00315         return
                      00316 
0224                  00317 READ_SECTOR_LBA48
                      00318         ; !!! Pripominam ze to co zde pisu (o LBA48) vim ze specifikace ATA8, v praxi jsem LBA48 na zadn
                            em disku jeste nezkousel !!!
                      00319         ; Zadavani adresy pri LBA48 se o neco lisi nez LBA28. Do registru LBA 1,2,3 se data zadavaji 2x.
                             
                      00320         ; Prvi zadavani znamena horni cast adresy, druhe zadavani dolni cast adresy.
                      00321         ; Znova sem pisu ze v tomto programu vyuzijeme jen LBA o 32bitech (2TB) a ne celych LBA48
0224   3000           00322         movlw .0
0225   00B5           00323         movwf TEMPW
0226   3022           00324         movlw D_SECTOR_C    ; vyssi cast parametru SECTOR_C = 0
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE 27


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0227   21AA           00325         call RUTW       
0228   2176           00326         call WR_SC                      ; nizci cast parametru SECTOR_C
                      00327 
0229   3000           00328         movlw .0
022A   00B5           00329         movwf TEMPW
022B   3025           00330         movlw D_LBA3            ; LBA bity 47:40
022C   21AA           00331         call RUTW
022D   3000           00332         movlw .0
022E   00B5           00333         movwf TEMPW
022F   3024           00334         movlw D_LBA2            ; LBA bity 39:32
0230   21AA           00335         call RUTW
0231   082A           00336         movfw LBA4
0232   00B5           00337         movwf TEMPW
0233   3023           00338         movlw D_LBA1            ; LBA bity 31:24
0234   21AA           00339         call RUTW
                      00340 
0235   2185           00341         call WR_LBA3            ; LBA bity 23:16
0236   2180           00342         call WR_LBA2            ; LBA bity 15:8
0237   217B           00343         call WR_LBA1            ; LBA bity  7:0
0238   3024           00344         movlw h'24'                     ; pri LBA48 se musi pouzit tohoto prikazu ke cteni (READ SECTOR(
                            S) EXT - 24h, PIO data-in)
0239   00AD           00345         movwf COMMAND
023A   2171           00346         call WR_COMMAND
023B   0008           00347         return
                      00348 ;**********************************************************
023C                  00349 IDENTIFY_DEVICE
                      00350         ; ted uz vime, ze mame pripojen nejaky disk, tento podprogram provede prikaz 
                      00351         ; identify device a zjisti co je disk zac. Nektere dulezite informace ulozi 
                      00352         ; (nastavi byty v ATA_ATTRIBUTES) a jmenovku disku hodi do bufferu
                      00353 
                      00354         ; rekneme disku, ze s nim chcem pracovat (s masterem)
023C   229D           00355         call WAIT_FOR_READY
023D   21D7           00356         call SELECT_DEVICE
                      00357         
                      00358         ; podivame se zda tu vubec disk je a co podporuje (LBA)
023E   229D           00359         call WAIT_FOR_READY     ; celame nez bude disk opet ready pro dalsi prikazy
                      00360 
023F   30E0           00361         movlw b'11100000'       ; adresy budou v LBA, budeme pracovat s masterem
0240   00AB           00362         movwf DEVICE
0241   01A6           00363         clrf SECTOR_C
0242   01A7           00364         clrf LBA1       
0243   01A8           00365         clrf LBA2
0244   01A9           00366         clrf LBA3
0245   01A4           00367         clrf FEATURES
0246   30EC           00368         movlw 0xEC                      ; code prikazu IDENTIFY DEVICE
0247   00AD           00369         movwf COMMAND
0248   2194           00370         call WR_BLOCK
                      00371 
                      00372         ; pokud se neco nepodelalo, dostanem 256 16ti bitovych slov kde je napsano co disk umi a co je t
                            o zac...
                      00373         ; slova cisluji od nuly, (tzn. ze slov je 0-255)
0249   301B           00374         movlw .27               ; prvnich 27 slov je pro nas nepotrebnych
024A   00B6           00375         movwf TEMP1
024B   21D3           00376         call PRESKOC
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE 28


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00377         
                      00378         ; [27-46] model mumber (ASCI retezec s nazvem disku)
                      00379         ; tady precteme 20 slov a rovnou je odesleme do pric
                      00380                 ; pokud nekde od disku dostavame ASCII retezec jsou data nasledujici: 
                      00381                 ; pr. disk nam posila string Copyright
                      00382                 ;               1. DATA_H = 'C' 
                      00383                 ;               1. DATA_l = 'o'
                      00384                 ;               2. DATA_H = 'P' 
                      00385                 ;               2. DATA_l = 'y'
024C   3014           00386         movlw .20               ; dalsich 20 slov obsahuje 40 s ASCII znaku s nazvem disku
024D   00B6           00387         movwf TEMP1
024E   21DB           00388         call ZAPIS_DO_BUFFERU_1
                      00389                 
                      00390         ; ted jsme uz precetli 47 slov z 256 :-)
024F   3002           00391         movlw .2                ; dalsi 2 slova jsou nam k nicemu
0250   00B6           00392         movwf TEMP1
0251   21D3           00393         call PRESKOC
                      00394                 
0252   21C0           00395         call READ_DATA  ; slovo 49 - capabilities (schopnosti)
                      00396                         ; 15:14 Reserved for the IDENTIFY PACKET DEVICE command.
                      00397                         ;    13 1 = Standby timer values as specified in this standard are supported
                      00398                         ;       0 = Standby timer values shall be managed by the device
                      00399                         ;    12 Reserved for the IDENTIFY PACKET DEVICE command.
                      00400                         ;    11 1 = IORDY supported
                      00401                         ;       0 = IORDY may be supported
                      00402                         ;    10 1 = IORDY may be disabled
                      00403                         ;     9 1 = LBA supported
                      00404                         ;     8 1 = DMA supported.
                      00405                         ;   7:0 Retired 
0253   18A1           00406         btfsc DATA_H,1  ;bit 9 = 1 -> LBA supported
0254   14AE           00407         bsf ATA_ATTRIBUTES,LBA_SUPPORT
                      00408 
                      00409         ;precetli jsme 50 slov
0255   300A           00410         movlw .10
0256   00B6           00411         movwf TEMP1
0257   21D3           00412         call PRESKOC
                      00413         
0258   21C0           00414         call READ_DATA  ; 60
0259   0820           00415         movfw DATA_L
025A   00AF           00416         movwf PARAM_MAX_LBA1            ; nejnizsi cast adresy
025B   0821           00417         movfw DATA_H
025C   00B0           00418         movwf PARAM_MAX_LBA2    
                      00419         
025D   21C0           00420         call READ_DATA  ; 61
025E   0820           00421         movfw DATA_L
025F   00B1           00422         movwf PARAM_MAX_LBA3
0260   0821           00423         movfw DATA_H
0261   00B2           00424         movwf PARAM_MAX_LBA4            ; nejvyssi cast adresy
                      00425         
                      00426         ;precetli jsme 62 slov, zbyva 194
0262   3015           00427         movlw .21
0263   00B6           00428         movwf TEMP1
0264   21D3           00429         call PRESKOC
                      00430 
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE 29


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00431         ; 83 slov, na rade je slovo 83 (pripominam ze slova jsou cislovana od nuly)
0265   21C0           00432         call READ_DATA  ; 83 - command supported. Tady nas zajima bit 10 - 1 = 48-bit Address feature se
                            t supported
0266   1921           00433         btfsc DATA_H,2  ; pokud disk umi LBA 48 pripiseme tuto skutecnost do ATA_ATTRIBUTES
0267   152E           00434         bsf ATA_ATTRIBUTES,LBA48_SUPPORT
                      00435 
                      00436         ;precetli jsme 84 slov
0268   3010           00437         movlw .16
0269   00B6           00438         movwf TEMP1
026A   21D3           00439         call PRESKOC
                      00440                 
026B   1D2E           00441         btfss ATA_ATTRIBUTES,LBA48_SUPPORT
026C   2A78           00442         goto INIT_ATA__NOT_SUPPORT_LBA48
                      00443                         ; pokud je podporovano LBA 48, nachazi se ve slovech [100-103] skutecny pocet se
                            ktoru 
                      00444                         ; do slov 60-61 by se sice vesel pocet sektoru u disku do 2TB, podle standardu s
                            e tam ale zapisuje pouze hodnota max pro LBA 28 (cca 120 GB)
                      00445                         ; mi precteme ale jen nejnizsi 2 slova, predpokladam totiz ze disk neni vetsi ja
                            k 2TB
026D   21C0           00446                         call READ_DATA  ; 100
026E   0820           00447                         movfw DATA_L
026F   00AF           00448                         movwf PARAM_MAX_LBA1            ; nejnizsi cast adresy
0270   0821           00449                         movfw DATA_H
0271   00B0           00450                         movwf PARAM_MAX_LBA2    
                      00451 
0272   21C0           00452                         call READ_DATA  ; 101
0273   0820           00453                         movfw DATA_L
0274   00B1           00454                         movwf PARAM_MAX_LBA3
0275   0821           00455                         movfw DATA_H
0276   00B2           00456                         movwf PARAM_MAX_LBA4            ; nejvyssi cast adresy                  
0277   2A7B           00457                 goto INIT_ATA__DALSI
0278                  00458 INIT_ATA__NOT_SUPPORT_LBA48
0278   3002           00459         movlw .2        ; 100, 101
0279   00B6           00460         movwf TEMP1
027A   21D3           00461         call PRESKOC    
027B                  00462 INIT_ATA__DALSI
                      00463         ; precetli jsme 102 slov
027B   3004           00464         movlw .4        ; 102, 103, 104, 105
027C   00B6           00465         movwf TEMP1
027D   21D3           00466         call PRESKOC
                      00467 
027E   21C0           00468         call READ_DATA  ; slovo 106 - pokud bit 15=0 a bit 14=1, tak obsahuje pravdive informace
                      00469                                                 ; pro nas je podstatne, ze pokud je bit 12 = 1, tak sekt
                            or je vetsi nez 256 slov
                      00470                                                 ; pokud je sektor vetsi nez 256 slov, je jeho velikost v
                            e slovech [117-118]
027F   1BA1           00471         btfsc DATA_H,7
0280   2A85           00472         goto INIT_ATA__DALSI2
0281   1F21           00473         btfss DATA_H,6
0282   2A85           00474         goto INIT_ATA__DALSI2
0283   1A21           00475         btfsc DATA_H,4
0284   15AE           00476         bsf ATA_ATTRIBUTES,BIG_SECTOR
0285                  00477 INIT_ATA__DALSI2
                      00478         ; precteno 107, zbyva 149
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE 30


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0285   3095           00479         movlw .149      ; 107 - 256
0286   00B6           00480         movwf TEMP1
0287   21D3           00481         call PRESKOC
                      00482                 
                      00483         ; ted vime co mame za disk, tak se na to jdem podivat...
                      00484         ; pokud disk splnuje vsechny nase pozadavky, tak nastavime 7 bit v ATA_ATTRIBUTES
0288   13AE           00485         bcf ATA_ATTRIBUTES,APPLICABLE   
0289   1CAE           00486         btfss ATA_ATTRIBUTES,LBA_SUPPORT
028A   0008           00487         return
                      00488         ; pokud jsme tady, disk podporuje LBA (dneska se jich uz moc nevidi, co by LBA neumeli)
028B   19AE           00489         btfsc ATA_ATTRIBUTES,BIG_SECTOR
028C   0008           00490         return
                      00491         ; mazec, disk ma velikost sektoru 256 slov, vetsi naroky na disk nemam :-)
028D   17AE           00492         bsf ATA_ATTRIBUTES,APPLICABLE ; disk umi to co potrebujeme...   
                      00493 
028E   0008           00494         return
                      00495 ;**************************************************************************
                      00496 ;**********************************************************
                      00497 ; CEKACI PROCEDURY
                      00498 ;**********************************************************
028F                  00499 DELAY_25us
                      00500         ; pouziva TEMP1
                      00501         ; (Fosc = 20 MHz , instr. cyklus= 0.20 us) 25us / 0.20 us = 125 instrukcnich cyklu
                      00502         ; (Fosc = 16 MHz , instr. cyklus= 0.25 us) 25us / 0.25 us = 100 instrukcnich cyklu
                      00503         ; (Fosc = 04 MHz , instr. cyklus= 1.00 us) 25us / 1.00 us =  25 instrukcnich cyklu      
                      00504         ;MOVLW 0x2A  ;42 DEC -> Delay 127 cycles
028F   3021           00505         MOVLW 0x21   ;33 DEC -> Delay 100 cycles
                      00506         ;MOVLW 0x08  ;25 DEC -> Delay  25 cycles
0290   00B6           00507         MOVWF TEMP1
0291   0BB6           00508         DECFSZ TEMP1,F
0292   2A91           00509         GOTO $-1
                      00510         ;End of Delay
0293   0008           00511         return
                      00512 ;**************************************************************************
0294                  00513 WAIT_FOR_DATA
                      00514         ; Wait: ( Bsy=0 AND Drq=1 ) OR err=1
                      00515         ; 7   6    5  4   3   2    1   0
                      00516         ; BSY DRDY DF DSC DRQ CORR IDX ERR
                      00517         ; (cekame az disk bude mit pro nas prichystana data)
0294   229D           00518         call WAIT_FOR_READY
0295   082C           00519         movfw ATA_STATUS
0296   3988           00520         andlw b'10001000'
0297   3C08           00521         sublw b'00001000'
0298   1903           00522         btfsc STATUS,Z
0299   0008           00523         return
029A   1C2C           00524         btfss ATA_STATUS,ERR
029B   2A94           00525         goto WAIT_FOR_DATA
029C   0008           00526         return
                      00527 ;**************************************************************************
029D                  00528 WAIT_FOR_READY
                      00529         ; Cekame az Bsy bit = 0 
                      00530         ; (cekame az disk nebude zaneprazdnen)
029D   214C           00531         call RD_STATUS
029E   082C           00532         movfw ATA_STATUS
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE 31


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

029F   3980           00533         andlw b'10000000'
02A0   1903           00534         btfsc STATUS,Z
02A1   0008           00535         return
02A2   2A9D           00536         goto WAIT_FOR_READY
                      00537 ;**************************************************************************
02A3                  00538 WAIT_FOR_READY_FOR_COMMAND
02A3   229D           00539         call WAIT_FOR_READY
02A4   1F2C           00540         btfss ATA_STATUS,DRDY
02A5   2AA3           00541         goto WAIT_FOR_READY_FOR_COMMAND
02A6   0008           00542         return
                      00543 ;**************************************************************************
                      00054         include "fat32.asm"     ; podprogramy na nacteni a praci s FAT32
                      00001 ;**********************************************************
                      00002 ;**********************************************************
                      00003 ;**********************************************************
                      00004 ; OBSLUZNE PODPROGRAMY PRO FAT32, HLEDANI ODDILU
                      00005 ;**********************************************************
                      00006 ;**********************************************************
                      00007 ;**********************************************************
                      00008 
                      00009 ;**************************************************************************
02A7                  00010 SCAN_MBR
                      00011         ; Tato procedura ma na prvni pohled jednoduchy ukol, podiva se do MBR a do BUFFERU 2 hodi nasled
                            ujici data:
                      00012         ; 4 x 16 bytovy zaznam, kde kazdy zaznam reprezentuje jeden oddil se systemem FAT32
                      00013         ; struktura zaznamu je nasledujici:             1  byt (pokud = 0 tak v zaznamu neni zaznam o od
                            dilu, pokud = FFh , je zaznam o oddilu)
                      00014         ;                                                                               4  byty = adresa
                             kde se nachazi spousteci zaznam oddilu
                      00015         ;                                                                               11 bytu = jmenov
                            ka oddilu s FAT32 (neni dulezita, jen aby bylo co vypsat na display :-)
02A7   21E9           00016         call CLEAR_BUFFER2
                      00017 
02A8   01A7           00018         clrf LBA1
02A9   01A8           00019         clrf LBA2
02AA   01A9           00020         clrf LBA3
02AB   01AA           00021         clrf LBA4                               ; jako prvni cteme MBR
                      00022 
02AC   01BB           00023         clrf POZICE                             ; kolik zaznamu o oddilech uz bylo zapsano do bufferu2
02AD                  00024 SCAN_BR                                         
                      00025         ; tady na tom navesti mame zadanou adresu MBR nebo BR nejakeho rozsireneho oddilu
02AD   3001           00026         movlw .1
02AE   00A6           00027         movwf SECTOR_C
02AF   2210           00028         call READ_SECTOR                ; cteme MBR nebo BR rozsireneho oddilu
                      00029 
02B0   30DF           00030         movlw .223                              ; 223 slov = 446 bytu
02B1   00B6           00031         movwf TEMP1
02B2   21D3           00032         call PRESKOC                    ; na prvnich 446 bytech MBR je zavadeci program systemu (samozre
                            jme, pokud na disku system je)
02B3   3020           00033         movlw .32
02B4   00B6           00034         movwf TEMP1
02B5   21DB           00035         call ZAPIS_DO_BUFFERU_1 ; do bufferu si dame vsechny zaznamy BR (16*4=64bytu / 32slov)
02B6   3001           00036         movlw .1
02B7   00B6           00037         movwf TEMP1
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE 32


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

02B8   21D3           00038         call PRESKOC
                      00039         ; tak ted jsme precetli cely MBR/BR a zaznamy o jeho oddilech mame v BEFFERU 1, tak se jdem na n
                            e podivat...
                      00040         
                      00041         ; Nejdriv si ale hodime aktualni LBA adresu do operandu Y pro aritmeticke operace
                      00042         INDF_BANK_1                             ; neprime adresovani na banku 1 (aritmeticke operace)
02B9   1383               M                         bcf STATUS,IRP    
02BA   30A4           00043         movlw 0xA4                              ; FSR na OPERAND_Y
02BB   0084           00044         movwf FSR       
02BC   0827           00045         movfw LBA1
02BD   0080           00046         movwf INDF
02BE   0A84           00047         incf FSR,F
02BF   0828           00048         movfw LBA2
02C0   0080           00049         movwf INDF
02C1   0A84           00050         incf FSR,F
02C2   0829           00051         movfw LBA3
02C3   0080           00052         movwf INDF
02C4   0A84           00053         incf FSR,F
02C5   082A           00054         movfw LBA4
02C6   0080           00055         movwf INDF
02C7   0A84           00056         incf FSR,F
                      00057 
                      00058         INDF_BANK_3                             ; neprime adresovani na banku 3 (buffer 1)      
02C8   1783               M                         bsf STATUS,IRP    
02C9   3094           00059         movlw 0x94                              ; 90h (buffer1) + 4 (pozice kde je ulozen identifikator 
                            souboroveho systemu prvniho zaznamu BR)
02CA   0084           00060         movwf FSR
02CB   0800           00061         movfw INDF
02CC   3C0C           00062         sublw h'0C'                             ; Pokud se FileSystem <> 0Ch...
02CD   1D03           00063         btfss STATUS,Z
02CE   3C01           00064         sublw .1                                ; ...ani 0Bh...
02CF   1D03           00065         btfss STATUS,Z
02D0   2AF6           00066         goto SCAN_MBR__HLEDEJ_ROZSIRENY_ODDIL   ; ...tak hledej rozsireny oddil.
                      00067 
                      00068         ; pokud jsme v teto casti programu, tak prvni zaznam MBR/BR obsahuje oddil FAT32, s reprezentaci
                             adres stylem LBA
                      00069         ; Tady pozor, v MBR/BR neni zapsana LBA adresa oddilu, ale relativni vzdalenost (offset) od MBR/
                            BR.
                      00070         ; To znamena, ze k adrese v (M)BR musime pricist offset oddilu.
                      00071         BANK_1
02D1   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
02D2   1683               M                 bsf     STATUS,RP0    
02D3   3098           00072         movlw 0x98                              ; offset prvniho zaznamu 
02D4   0084           00073         movwf FSR
02D5   0800           00074         movfw INDF
02D6   00A0           00075         movwf OPERAND_X1
02D7   0A84           00076         incf FSR,F
02D8   0800           00077         movfw INDF
02D9   00A1           00078         movwf OPERAND_X2
02DA   0A84           00079         incf FSR,F
02DB   0800           00080         movfw INDF
02DC   00A2           00081         movwf OPERAND_X3
02DD   0A84           00082         incf FSR,F
02DE   0800           00083         movfw INDF
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE 33


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

02DF   00A3           00084         movwf OPERAND_X4
                      00085         BANK_0
02E0   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
02E1   1283               M                 bcf     STATUS,RP0    
                      00086 
02E2   2582           00087         call SOUCET
                      00088 
                      00089         INDF_BANK_1                             ; neprime adresovani na banku 1 (aritmeticke operace)
02E3   1383               M                         bcf STATUS,IRP    
02E4   30A8           00090         movlw 0xA8                              ; FSR na VYSLEDEK
02E5   0084           00091         movwf FSR       
02E6   0800           00092         movfw INDF
02E7   00A7           00093         movwf LBA1
02E8   0A84           00094         incf FSR,F
02E9   0800           00095         movfw INDF
02EA   00A8           00096         movwf LBA2
02EB   0A84           00097         incf FSR,F
02EC   0800           00098         movfw INDF
02ED   00A9           00099         movwf LBA3
02EE   0A84           00100         incf FSR,F
02EF   0800           00101         movfw INDF
02F0   00AA           00102         movwf LBA4
02F1   0A84           00103         incf FSR,F
                      00104 
02F2   2321           00105         call ZKONTROLUJ_ODDIL_FAT32     ; pokud skutecne adresa v LBA1-4 ukazuje na zacatek oddilu s FAT
                            32, tak da do bufferu2 jmenovku a adresu oddilu
                      00106         INDF_BANK_3
02F3   1783               M                         bsf STATUS,IRP    
02F4   30A4           00107         movlw 0xA4                                      ; 90h (buffer 1) + 16 (velikost 1. zaznamu) + 4 
                            (identifikator souboroveho systemu 2. zaznamu)
02F5   0084           00108         movwf FSR
02F6                  00109 SCAN_MBR__HLEDEJ_ROZSIRENY_ODDIL                ; jdem v zaznamech MBR/BR hledat rozsireny oddil
                      00110         ; pokud byl v prvnim zaznamu oddil typu FAT32, tak nam  tad FSR ukazuje na FileSystem 2. zaznamu
                            ...
                      00111         ; ...pokud 1. zaznam nebyl typu FAT32, tak nam FSR ukazuje na FileSystem 1. zaznamu.
                      00112         ; Kazdopadne se ted podivame na dalsi zaznam a pokud obsahuje rozsireny oddil, skocime na jeho a
                            dresu a dame goto SCAN_BR ...
02F6   0800           00113         movfw INDF
02F7   3C05           00114         sublw h'05'                             ; Pokud se FileSystem <> 05h (rozsireny oddil CHS)...
02F8   1D03           00115         btfss STATUS,Z
02F9   3C0A           00116         sublw h'0A'                             ; ...ani se <> 0Fh (5+A=F) (rozsireny oddil LBA)...
02FA   1D03           00117         btfss STATUS,Z
02FB   2B20           00118         goto SCAN_MBR__KONEC    ; ...tak koncime...
                      00119 
02FC   0804           00120         movfw FSR                               ; ...pokud tu ale mame rozsireny oddil,...
02FD   3E04           00121         addlw .4                                ; ...tak se jdem podivat na jeho adresu.
02FE   0084           00122         movwf FSR
                      00123 
                      00124         BANK_1
02FF   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0300   1683               M                 bsf     STATUS,RP0    
                      00125         INDF_BANK_3
0301   1783               M                         bsf STATUS,IRP    
0302   0800           00126         movfw INDF
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE 34


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0303   00A0           00127         movwf OPERAND_X1
0304   0A84           00128         incf FSR,F
0305   0800           00129         movfw INDF
0306   00A1           00130         movwf OPERAND_X2
0307   0A84           00131         incf FSR,F
0308   0800           00132         movfw INDF
0309   00A2           00133         movwf OPERAND_X3
030A   0A84           00134         incf FSR,F
030B   0800           00135         movfw INDF
030C   00A3           00136         movwf OPERAND_X4
                      00137         BANK_0
030D   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
030E   1283               M                 bcf     STATUS,RP0    
                      00138 
030F   2582           00139         call SOUCET
                      00140 
                      00141         INDF_BANK_1                             ; neprime adresovani na banku 1 (aritmeticke operace)
0310   1383               M                         bcf STATUS,IRP    
0311   30A8           00142         movlw 0xA8                              ; FSR na VYSLEDEK
0312   0084           00143         movwf FSR       
0313   0800           00144         movfw INDF
0314   00A7           00145         movwf LBA1
0315   0A84           00146         incf FSR,F
0316   0800           00147         movfw INDF
0317   00A8           00148         movwf LBA2
0318   0A84           00149         incf FSR,F
0319   0800           00150         movfw INDF
031A   00A9           00151         movwf LBA3
031B   0A84           00152         incf FSR,F
031C   0800           00153         movfw INDF
031D   00AA           00154         movwf LBA4
031E   0A84           00155         incf FSR,F
                      00156         
031F   2AAD           00157         goto SCAN_BR                    ; S rozirenym oddilem provedeme totez co s MBR
0320                  00158 SCAN_MBR__KONEC
0320   0008           00159         return
                      00160 ;**************************************************************************
0321                  00161 ZKONTROLUJ_ODDIL_FAT32
                      00162         ; tak ted bychom mely mit v LBA 1-4 adresu spousteciho zaznamu oddilu s FAT32, tak to jdem overi
                            t...
                      00163         ; ...a pokud tam doopravdy spousteci zaznam je, tak dame jmenovku a informace do bufferu 2 na po
                            zici jaka je v rag. POZICE
                      00164         INDF_BANK_2
0321   1783               M                         bsf STATUS,IRP    
0322   083B           00165         movfw POZICE
0323   00B6           00166         movwf TEMP1
0324   1003           00167         bcf STATUS,C
0325   0DB6           00168         rlf TEMP1,F
0326   0DB6           00169         rlf TEMP1,F
0327   0DB6           00170         rlf TEMP1,F
0328   0DB6           00171         rlf TEMP1,F                             ; TEMP1 := POZICE *16
0329   0836           00172         movfw TEMP1
032A   3E11           00173         addlw 0x11                              ; TEMP1 + pozice bufferu 2 + 1 (pozice kam budeme do buf
                            feru 2 davat adresu oddilu)
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE 35


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

032B   0084           00174         movwf FSR
                      00175 
032C   0827           00176         movfw LBA1
032D   0080           00177         movwf INDF
032E   0A84           00178         incf FSR,F
032F   0828           00179         movfw LBA2
0330   0080           00180         movwf INDF
0331   0A84           00181         incf FSR,F
0332   0829           00182         movfw LBA3
0333   0080           00183         movwf INDF
0334   0A84           00184         incf FSR,F
0335   082A           00185         movfw LBA4
0336   0080           00186         movwf INDF
0337   0A84           00187         incf FSR,F                              ; adresa oddilu je ulozena do bufferu 2, ted tam jdem da
                            vat jmenovku oddilu
                      00188 
0338   3001           00189         movlw .1
0339   00A6           00190         movwf SECTOR_C
033A   2210           00191         call READ_SECTOR
033B   3023           00192         movlw h'23'
033C   00B6           00193         movwf TEMP1
033D   21D3           00194         call PRESKOC                    ; informace o FATce co nas ted zrovna moc nezejimaji
                      00195         ; na offsetu 47 je ulozena jmenovka oddilu (11znaku), ted jsme na offsetu 46
                      00196 
033E   21C0           00197         call READ_DATA
033F   0821           00198         movfw DATA_H
0340   0080           00199         movwf INDF                              ; 1. znak ze jmenovky svazku
0341   0A84           00200         incf FSR,F
                      00201 
0342   3005           00202         movlw .5                                ; dalsich 10 bytu je zbytek jmenovky
0343   00B6           00203         movwf TEMP1
0344                  00204 ZKONTROLUJ_ODDIL_FAT32__JMENOVKA
0344   21C0           00205         call READ_DATA
0345   0820           00206         movfw DATA_L
0346   0080           00207         movwf INDF
0347   0A84           00208         incf FSR,F
0348   0821           00209         movfw DATA_H
0349   0080           00210         movwf INDF
034A   0A84           00211         incf FSR,F
034B   0BB6           00212         decfsz TEMP1,F
034C   2B44           00213         goto ZKONTROLUJ_ODDIL_FAT32__JMENOVKA
034D   3010           00214         movlw .16
034E   0284           00215         subwf FSR,F                                     ; aby fsr ukazoval na priznak o pravdivosti (FSR
                             := FSR - 16)
                      00216 
034F   21C0           00217         call READ_DATA
0350   0820           00218         movfw DATA_L
0351   3C46           00219         sublw 'F'               
0352   1D03           00220         btfss STATUS,Z
0353   2B69           00221         goto ZKONTROLUJ_ODDIL_FAT32__KONEC
0354   0821           00222         movfw DATA_H
0355   3C41           00223         sublw 'A'               
0356   1D03           00224         btfss STATUS,Z
0357   2B69           00225         goto ZKONTROLUJ_ODDIL_FAT32__KONEC
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE 36


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00226 
0358   21C0           00227         call READ_DATA
0359   0820           00228         movfw DATA_L
035A   3C54           00229         sublw 'T'               
035B   1D03           00230         btfss STATUS,Z
035C   2B69           00231         goto ZKONTROLUJ_ODDIL_FAT32__KONEC
035D   0821           00232         movfw DATA_H
035E   3C33           00233         sublw '3'               
035F   1D03           00234         btfss STATUS,Z
0360   2B69           00235         goto ZKONTROLUJ_ODDIL_FAT32__KONEC
                      00236 
0361   21C0           00237         call READ_DATA
0362   0820           00238         movfw DATA_L
0363   3C32           00239         sublw '2'
0364   1D03           00240         btfss STATUS,Z
0365   2B69           00241         goto ZKONTROLUJ_ODDIL_FAT32__KONEC
                      00242         ; tak, ted uz opravdu vime, ze na tomto sektoru se nachazi spousteci zaznam svazku se souborovym
                             systemem FAT32
                      00243 
0366   30FF           00244         movlw h'FF'
0367   0080           00245         movwf INDF
0368   0ABB           00246         incf POZICE,F                           ; sektor skutecne obsahoval spousteci zaznam svazku...
0369                  00247 ZKONTROLUJ_ODDIL_FAT32__KONEC
0369   0008           00248         return
                      00249 ;**************************************************************************
036A                  00250 NACTI_FAT32
                      00251         ; V LBA1-4 bychom meli dostat adresu prvniho sektoru FAT32 oddilu, kde by se mely nalezat inform
                            ace o fatce
                      00252         ; pokud je FATka pro nas pouzitelna (Clustery nejsou moc velke, sektor = 512B ...) nastavime bit
                             FAT32_LOAD v ATA_ATTRIBUTES
036A   122E           00253         bcf ATA_ATTRIBUTES,FAT32_LOAD
036B   01C0           00254         clrf POCATEK_DAT1
036C   01C1           00255         clrf POCATEK_DAT2
036D   01C2           00256         clrf POCATEK_DAT3
036E   01C3           00257         clrf POCATEK_DAT4
036F   01C4           00258         clrf POCATEK_FAT1
0370   01C5           00259         clrf POCATEK_FAT2
0371   01C6           00260         clrf POCATEK_FAT3
0372   01C7           00261         clrf POCATEK_FAT4
0373   01C8           00262         clrf ROOT_DIR_CL1
0374   01C9           00263         clrf ROOT_DIR_CL2
0375   01CA           00264         clrf ROOT_DIR_CL3
0376   01CB           00265         clrf ROOT_DIR_CL4
                      00266 
                      00267 
0377   01A4           00268         clrf FEATURES
0378   3001           00269         movlw .1
0379   00A6           00270         movwf SECTOR_C
037A   2210           00271         call READ_SECTOR
                      00272 
037B   3005           00273         movlw .5
037C   00B6           00274         movwf TEMP1
037D   21D3           00275         call PRESKOC
                      00276 
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE 37


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

037E   21C0           00277         call READ_DATA                          ; 10 bytu precteno
037F   0821           00278         movfw DATA_H                            ; 11,12 byte - velikost sektoru (tady by melo byt 512, a
                            le co kdyby ne...)
0380   39FF           00279         andlw h'FF'
0381   1D03           00280         btfss STATUS,Z
0382   2C2D           00281         goto NACTI_FAT32__KONEC         ; pokud 11 byte neni nula, koncime (velikost sektoru se nerovna 
                            512)
                      00282 
0383   21C0           00283         call READ_DATA                          ; ctu 12. a 13. byte
0384   0820           00284         movfw DATA_L
0385   3C02           00285         sublw h'02'
0386   1D03           00286         btfss STATUS,Z
0387   2C2D           00287         goto NACTI_FAT32__KONEC         ; pokud 12 byte neni 2, koncime (velikost sektoru se nerovna 512
                            )
                      00288 
0388   0821           00289         movfw DATA_H                            ; byte 13. SectorsPerCluster
0389   00CC           00290         movwf CLUSTER_SIZE
038A   3C20           00291         sublw .32                                       ; nas program neumi vic jak 32 (Velikost cluster
                            u = 16KB)
038B   1C03           00292         btfss STATUS,C
038C   2C2D           00293         goto NACTI_FAT32__KONEC         ; pokud mame clustery vetsi jak 16KB, tak koncime
                      00294 
038D   21C0           00295         call READ_DATA                          ; ctu 14. a 15. byte
038E   0820           00296         movfw DATA_L
038F   00C4           00297         movwf POCATEK_FAT1                      ; tady se nachazi pocet rezervovanych sektoru, pak k ZAC
                            ATEK_FAT pricteme adresu zacatku sektoru a mame zacatek fat...
0390   0821           00298         movfw DATA_H
0391   00C5           00299         movwf POCATEK_FAT2
                      00300         
0392   21C0           00301         call READ_DATA                          ; ctu 16. a 17. byte
0393   0820           00302         movfw DATA_L                            ; Pocet FAT. byva temer vzdy 2, kdyby ale ne, tak by nam
                             to delalo docela bordel...
0394   3C02           00303         sublw .2
0395   1D03           00304         btfss STATUS,Z
0396   2C2D           00305         goto NACTI_FAT32__KONEC
                      00306 
0397   3009           00307         movlw .9
0398   00B6           00308         movwf TEMP1
0399   21D3           00309         call PRESKOC                            ; 18 - 35
                      00310 
039A   21C0           00311         call READ_DATA                          ; 36,37 -> velikost FAT (pocet sektoru)
039B   0820           00312         movfw DATA_L
039C   00C0           00313         movwf POCATEK_DAT1
039D   0821           00314         movfw DATA_H
039E   00C1           00315         movwf POCATEK_DAT2      
039F   21C0           00316         call READ_DATA                          ; 38,39 -> velikost FAT (pocet sektoru)
03A0   0820           00317         movfw DATA_L
03A1   00C2           00318         movwf POCATEK_DAT3
03A2   0821           00319         movfw DATA_H
03A3   00C3           00320         movwf POCATEK_DAT4
                      00321 
03A4   21C0           00322         call READ_DATA                          ; 40,41
03A5   21C0           00323         call READ_DATA                          ; 42,43
                      00324 
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE 38


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

03A6   21C0           00325         call READ_DATA                          ; 44,45
03A7   0820           00326         movfw DATA_L
03A8   00C8           00327         movwf ROOT_DIR_CL1
03A9   0821           00328         movfw DATA_H
03AA   00C9           00329         movwf ROOT_DIR_CL2
03AB   21C0           00330         call READ_DATA                          ; 46,47
03AC   0820           00331         movfw DATA_L
03AD   00CA           00332         movwf ROOT_DIR_CL3
03AE   0821           00333         movfw DATA_H
03AF   00CB           00334         movwf ROOT_DIR_CL4
                      00335 
03B0   3011           00336         movlw .17
03B1   00B6           00337         movwf TEMP1
03B2   21D3           00338         call PRESKOC                            ; 48 - 81
                      00339 
                      00340         ; ted jeste takova mala kontrola...
03B3   21C0           00341         call READ_DATA
03B4   0820           00342         movfw DATA_L
03B5   3C46           00343         sublw 'F'               
03B6   1D03           00344         btfss STATUS,Z
03B7   2C2D           00345         goto NACTI_FAT32__KONEC
03B8   0821           00346         movfw DATA_H
03B9   3C41           00347         sublw 'A'               
03BA   1D03           00348         btfss STATUS,Z
03BB   2C2D           00349         goto NACTI_FAT32__KONEC
03BC   21C0           00350         call READ_DATA
03BD   0820           00351         movfw DATA_L
03BE   3C54           00352         sublw 'T'               
03BF   1D03           00353         btfss STATUS,Z
03C0   2C2D           00354         goto NACTI_FAT32__KONEC
03C1   0821           00355         movfw DATA_H
03C2   3C33           00356         sublw '3'               
03C3   1D03           00357         btfss STATUS,Z
03C4   2C2D           00358         goto NACTI_FAT32__KONEC
03C5   21C0           00359         call READ_DATA
03C6   0820           00360         movfw DATA_L
03C7   3C32           00361         sublw '2'
03C8   1D03           00362         btfss STATUS,Z
03C9   2C2D           00363         goto NACTI_FAT32__KONEC
                      00364         ; tak, ted uz opravdu vime, ze na tomto sektoru se nachazi spousteci zaznam svazku se souborovym
                             systemem FAT32...
                      00365         ; tak ted jdem vypocitat ty nejdulezitejsi cisla pro praci s FATkou...
                      00366 
                      00367         INDF_BANK_1                                     ; aritmeto/logicke operace
03CA   1383               M                         bcf STATUS,IRP    
03CB   30A0           00368         movlw 0xA0                                      ; OPERAND_X
03CC   0084           00369         movwf FSR
03CD   0844           00370         movfw POCATEK_FAT1
03CE   0080           00371         movwf INDF
03CF   0A84           00372         incf FSR,F
03D0   0845           00373         movfw POCATEK_FAT2
03D1   0080           00374         movwf INDF
03D2   0A84           00375         incf FSR,F
03D3   0846           00376         movfw POCATEK_FAT3
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE 39


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

03D4   0080           00377         movwf INDF
03D5   0A84           00378         incf FSR,F
03D6   0847           00379         movfw POCATEK_FAT4
03D7   0080           00380         movwf INDF
03D8   0A84           00381         incf FSR,F
03D9   0827           00382         movfw LBA1                                      ; OPERAND_Y
03DA   0080           00383         movwf INDF
03DB   0A84           00384         incf FSR,F
03DC   0828           00385         movfw LBA2
03DD   0080           00386         movwf INDF
03DE   0A84           00387         incf FSR,F
03DF   0829           00388         movfw LBA3
03E0   0080           00389         movwf INDF
03E1   0A84           00390         incf FSR,F
03E2   082A           00391         movfw LBA4
03E3   0080           00392         movwf INDF
03E4   0A84           00393         incf FSR,F
03E5   2582           00394         call SOUCET                                     ; pricteme k zacatku oddilu pocet rezervovanych 
                            sektoru (obvykle 32) a mame z toho POCATEK_FAT
03E6   0800           00395         movfw INDF
03E7   00C4           00396         movwf POCATEK_FAT1
03E8   0A84           00397         incf FSR,F
03E9   0800           00398         movfw INDF
03EA   00C5           00399         movwf POCATEK_FAT2
03EB   0A84           00400         incf FSR,F
03EC   0800           00401         movfw INDF
03ED   00C6           00402         movwf POCATEK_FAT3
03EE   0A84           00403         incf FSR,F
03EF   0800           00404         movfw INDF
03F0   00C7           00405         movwf POCATEK_FAT4
03F1   0A84           00406         incf FSR,F
                      00407 
                      00408         ; v POCATEK_DAT ted mame hodnotu "velikost fat", tu vynasobime 2 a pricteme POCATEK_FAT. Tak zis
                            kame POCATEK_DAT
03F2   30A0           00409         movlw 0xA0                                      ; OPERAND_X
03F3   0084           00410         movwf FSR
03F4   0840           00411         movfw POCATEK_DAT1
03F5   0080           00412         movwf INDF
03F6   0A84           00413         incf FSR,F
03F7   0841           00414         movfw POCATEK_DAT2
03F8   0080           00415         movwf INDF
03F9   0A84           00416         incf FSR,F
03FA   0842           00417         movfw POCATEK_DAT3
03FB   0080           00418         movwf INDF
03FC   0A84           00419         incf FSR,F
03FD   0843           00420         movfw POCATEK_DAT4
03FE   0080           00421         movwf INDF
03FF   0A84           00422         incf FSR,F
0400   25DA           00423         call POSUNDOLEVA_1                      ; X := X * 2 -> POCATEK_DAT := 2 * "velikost fat"
                      00424                                                                 ; ted jeste staci pricist POCATEK_FAT
0401   0844           00425         movfw POCATEK_FAT1
0402   0080           00426         movwf INDF
0403   0A84           00427         incf FSR,F
0404   0845           00428         movfw POCATEK_FAT2
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE 40


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0405   0080           00429         movwf INDF
0406   0A84           00430         incf FSR,F
0407   0846           00431         movfw POCATEK_FAT3
0408   0080           00432         movwf INDF
0409   0A84           00433         incf FSR,F
040A   0847           00434         movfw POCATEK_FAT4
040B   0080           00435         movwf INDF
040C   0A84           00436         incf FSR,F
040D   2582           00437         call SOUCET
                      00438 
                      00439         ;   tady je pro me jedna zcela nepochopitelna vlastnost FATky, a to to, ze prvni dva zaznamy (nu
                            lty a prvni)
                      00440         ;   ve FAT tabulce jsou obsazeny nejakyma srotama (identifikator FATky), coz by nebylo to nejhor
                            si, ale data na disku
                      00441         ;   zacinaji jiz na nultym clusteru. (POCATEK_DAT) Dochazi tedy k tomu, ze nulty cluster na disk
                            u je reprezentovan na druhe
                      00442         ;   pozici ve fatce a to cislem dve!!! Od udaje ve fatce bychom musime tedy vzdy odecist hodnotu
                             2
                      00443         ;   a ziskali bychom skutecnou polohu dat na disku.... (Je to pekne na vyliz!!!!!!!!)
                      00444         ;   Ja to tady resim tak, ze zacatek dat posunu o 2 clustery niz (POCATEK_DAT := POCATEK_DAT - 2
                            *VELIKOST_CLUSTERU),
                      00445         ;   aby udaje souhlasily a my nemuseli nic prepocitavat. 
                      00446         ;   Pak tu nastava jeste jeden problem, ROOT adresar byva adresovan jako by byl na clusteru 0, p
                            roto pokazdy kdyz je 
                      00447         ;   nekde cislo clusteru 0, tak skocime na prvni cluster root adresare. (Vetsinou 2. cluster)
                      00448         ;   O tomto jevu jsem nikde necetl, ale proste to tak je. Z toho vyplyva, ze zadny soubor nemuze
                             byt na slusteru 1...
                      00449         
                      00450         ; Tak ted mame v POCATEK_DAT = POCATEK_FAT + (velikostFat * 2)
                      00451         ; a ted jeste musime odecist 2 * velikost_clusteru
                      00452 
040E   0D4C           00453         rlf CLUSTER_SIZE,W              ; W := CLUSTER_SIZE * 2
                      00454         BANK_1
040F   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0410   1683               M                 bsf     STATUS,RP0    
0411   00A4           00455         movwf OPERAND_Y1
0412   01A5           00456         clrf OPERAND_Y2
0413   01A6           00457         clrf OPERAND_Y3
0414   01A7           00458         clrf OPERAND_Y4
0415   0828           00459         movfw VYSLEDEK1
0416   00A0           00460         movwf OPERAND_X1
0417   0829           00461         movfw VYSLEDEK2
0418   00A1           00462         movwf OPERAND_X2
0419   082A           00463         movfw VYSLEDEK3
041A   00A2           00464         movwf OPERAND_X3
041B   082B           00465         movfw VYSLEDEK4
041C   00A3           00466         movwf OPERAND_X4
                      00467         BANK_0
041D   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
041E   1283               M                 bcf     STATUS,RP0    
041F   25AB           00468         call ROZDIL                             ; VYSLEDEK := POCATEK_FAT + (2 * velikostFat) - (2 * CLU
                            STER_SIZE)
0420   0800           00469         movfw INDF
0421   00C0           00470         movwf POCATEK_DAT1
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE 41


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0422   0A84           00471         incf FSR,F
0423   0800           00472         movfw INDF
0424   00C1           00473         movwf POCATEK_DAT2
0425   0A84           00474         incf FSR,F
0426   0800           00475         movfw INDF
0427   00C2           00476         movwf POCATEK_DAT3
0428   0A84           00477         incf FSR,F
0429   0800           00478         movfw INDF
042A   00C3           00479         movwf POCATEK_DAT4
042B   0A84           00480         incf FSR,F
                      00481         
                      00482         ; Tak ted uz to konecne mame, muzeme se pustit do prohlizeni adresaru a souboru...
                      00483 
042C   162E           00484         bsf ATA_ATTRIBUTES,FAT32_LOAD   
042D                  00485 NACTI_FAT32__KONEC
042D   0008           00486         return  
                      00487 ;**************************************************************************
042E                  00488 CLUSTER_TO_LBA
                      00489         ; vezme hodnoty v CLUSTER 1-4 a POZICE (sektor v clusteru) a do LBA 1-4 vypocita skutecnou pozic
                            i na disku
                      00490         ; pro spravnou funkci musi byt POZICE < CLUSTER_SIZE (POZICE muze byt v rozsahu 0 .. CLUSTER_SIZ
                            E - 1)
                      00491         ; LBA := POCATEK_DAT + (CLUSTER * CLUSTER_SIZE) + POZICE
                      00492         INDF_BANK_1                             ; neprime adresovani do banku1
042E   1383               M                         bcf STATUS,IRP    
042F   30A0           00493         movlw 0xA0                                      ; OPERAND_X
0430   0084           00494         movwf FSR
0431   083C           00495         movfw CLUSTER1
0432   0080           00496         movwf INDF
0433   0A84           00497         incf FSR,F
0434   083D           00498         movfw CLUSTER2
0435   0080           00499         movwf INDF
0436   0A84           00500         incf FSR,F
0437   083E           00501         movfw CLUSTER3
0438   0080           00502         movwf INDF
0439   0A84           00503         incf FSR,F
043A   083F           00504         movfw CLUSTER4
043B   0080           00505         movwf INDF
043C   0A84           00506         incf FSR,F
                      00507 
                      00508         ; Nejdriv se koukneme zda-li CLUSTER se nerovna 0, to bychom pak vratily 
                      00509         ; pozici na prvnim clusteru root adresare...
043D   2681           00510         call NULA                                               ; if (X =  0) then PRETECENI := 0 else P
                            RETECENI := 1
                      00511         BANK_1
043E   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
043F   1683               M                 bsf     STATUS,RP0    
0440   182C           00512         btfsc PRETECENI,0
0441   2C52           00513         goto CLUSTER_TO_LBA_NO_ROOT
                      00514         BANK_0
0442   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0443   1283               M                 bcf     STATUS,RP0    
0444   30A0           00515         movlw 0xA0                                      ; OPERAND_X
0445   0084           00516         movwf FSR
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE 42


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0446   0848           00517         movfw ROOT_DIR_CL1
0447   0080           00518         movwf INDF
0448   0A84           00519         incf FSR,F
0449   0849           00520         movfw ROOT_DIR_CL2
044A   0080           00521         movwf INDF
044B   0A84           00522         incf FSR,F
044C   084A           00523         movfw ROOT_DIR_CL3
044D   0080           00524         movwf INDF
044E   0A84           00525         incf FSR,F
044F   084B           00526         movfw ROOT_DIR_CL4
0450   0080           00527         movwf INDF
0451   0A84           00528         incf FSR,F
                      00529                 
0452                  00530 CLUSTER_TO_LBA_NO_ROOT
                      00531         BANK_0
0452   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0453   1283               M                 bcf     STATUS,RP0    
                      00532         ; CLUSTER_SIZE je vzdy exponentem 2 (1,2,4,8,16,32), proto tento jednoduchy zapis
0454   18CC           00533         btfsc CLUSTER_SIZE,1            ; 2
0455   25DA           00534         call POSUNDOLEVA_1                      ; X := X * 2
0456   194C           00535         btfsc CLUSTER_SIZE,2            ; 4
0457   25E2           00536         call POSUNDOLEVA_2                      ; X := X * 4
0458   19CC           00537         btfsc CLUSTER_SIZE,3            ; 8
0459   25EB           00538         call POSUNDOLEVA_3                      ; X := X * 8
045A   1A4C           00539         btfsc CLUSTER_SIZE,4            ; 16
045B   25F5           00540         call POSUNDOLEVA_4                      ; X := X * 4
045C   1ACC           00541         btfsc CLUSTER_SIZE,5            ; 32
045D   2600           00542         call POSUNDOLEVA_5                      ; X := X * 32
                      00543         
045E   0840           00544         movfw POCATEK_DAT1
045F   0080           00545         movwf INDF                                      ; OPERAND_Y
0460   0A84           00546         incf FSR,F
0461   0841           00547         movfw POCATEK_DAT2
0462   0080           00548         movwf INDF
0463   0A84           00549         incf FSR,F
0464   0842           00550         movfw POCATEK_DAT3
0465   0080           00551         movwf INDF
0466   0A84           00552         incf FSR,F
0467   0843           00553         movfw POCATEK_DAT4
0468   0080           00554         movwf INDF
0469   0A84           00555         incf FSR,F
                      00556 
046A   2582           00557         call SOUCET                                     ; VYSLEDEK := POCATEK_DAT + (CLUSTER * CLUSTER_S
                            IZE)
                      00558 
                      00559         ; zbyva tedy k vysledku pricist POZICE a dat nasledny vysledek do LBA    
046B   083B           00560         movfw POZICE
                      00561         BANK_1
046C   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
046D   1683               M                 bsf     STATUS,RP0    
046E   00A4           00562         movwf OPERAND_Y1
046F   01A5           00563         clrf OPERAND_Y2
0470   01A6           00564         clrf OPERAND_Y3
0471   01A7           00565         clrf OPERAND_Y4
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE 43


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0472   0828           00566         movfw VYSLEDEK1
0473   00A0           00567         movwf OPERAND_X1
0474   0829           00568         movfw VYSLEDEK2
0475   00A1           00569         movwf OPERAND_X2
0476   082A           00570         movfw VYSLEDEK3
0477   00A2           00571         movwf OPERAND_X3
0478   082B           00572         movfw VYSLEDEK4
0479   00A3           00573         movwf OPERAND_X4        
                      00574         BANK_0
047A   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
047B   1283               M                 bcf     STATUS,RP0    
047C   2582           00575         call SOUCET
                      00576 
                      00577         INDF_BANK_1                             ; neprime adresovani do banku1
047D   1383               M                         bcf STATUS,IRP    
047E   30A8           00578         movlw 0xA8                                      ; VYSLEDEK
047F   0084           00579         movwf FSR
0480   0800           00580         movfw INDF
0481   00A7           00581         movwf LBA1
0482   0A84           00582         incf FSR,F
0483   0800           00583         movfw INDF
0484   00A8           00584         movwf LBA2
0485   0A84           00585         incf FSR,F
0486   0800           00586         movfw INDF
0487   00A9           00587         movwf LBA3
0488   0A84           00588         incf FSR,F
0489   0800           00589         movfw INDF
048A   00AA           00590         movwf LBA4
048B   0A84           00591         incf FSR,F
                      00592         
048C   0008           00593         return
                      00594 ;**************************************************************************
048D                  00595 NEXT_CLUSTER
                      00596         ; V CLUSTER prijme cislo clusteru, podiva se do FATky na disku a v CLUSTER vrati 
                      00597         ; hodnotu clustru, ktery nasleduje v retezu clusteru.
                      00598         ; Pokud pozadovany cluster byl posledni v retezu vrati v reg. POZICE konstantu FFh
                      00599         ; Pokud soucasny cluster je prazdny (coz by se stat nemelo) vrati taky v POZICE FFh
                      00600         ; Jinak, pokud s vse povede, dame do POZICE 0
                      00601 
                      00602         ; ! PODPROGRAM NETESTUJE ZDA NEBYLO ZADANO VETSI CISLO NEZ JE POCET CLUSTERU !!!
                      00603         
048D   01BB           00604         clrf POZICE
                      00605         ; LBA := [(CLUSTER * 4) / 512 ] + POCATEK_FAT
                      00606         ; LBA := ( CLUSTER / 128 ) + POCATEK_FAT
                      00607         ; offset := CLUSTER mod 128 
                      00608         INDF_BANK_1                             ; neprime adresovani do banku1
048E   1383               M                         bcf STATUS,IRP    
048F   30A0           00609         movlw 0xA0                                      ; OPERAND_X
0490   0084           00610         movwf FSR
0491   083C           00611         movfw CLUSTER1
0492   0080           00612         movwf INDF
0493   0A84           00613         incf FSR,F
0494   083D           00614         movfw CLUSTER2
0495   0080           00615         movwf INDF
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE 44


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0496   0A84           00616         incf FSR,F
0497   083E           00617         movfw CLUSTER3
0498   0080           00618         movwf INDF
0499   0A84           00619         incf FSR,F
049A   083F           00620         movfw CLUSTER4
049B   0080           00621         movwf INDF
                      00622 
                      00623         ; Nejdriv se koukneme zda-li CLUSTER se nerovna 0, to pak musime jako cluster brat prvni cluster
                             ROOT adr.
049C   2681           00624         call NULA                                               ; if (X =  0) then PRETECENI := 0 else P
                            RETECENI := 1
                      00625         BANK_1
049D   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
049E   1683               M                 bsf     STATUS,RP0    
049F   182C           00626         btfsc PRETECENI,0
04A0   2CB1           00627         goto NEXT_CLUSTER_NO_ROOT
                      00628         BANK_0
04A1   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
04A2   1283               M                 bcf     STATUS,RP0    
04A3   30A0           00629         movlw 0xA0                                      ; OPERAND_X
04A4   0084           00630         movwf FSR
04A5   0848           00631         movfw ROOT_DIR_CL1
04A6   0080           00632         movwf INDF
04A7   0A84           00633         incf FSR,F
04A8   0849           00634         movfw ROOT_DIR_CL2
04A9   0080           00635         movwf INDF
04AA   0A84           00636         incf FSR,F
04AB   084A           00637         movfw ROOT_DIR_CL3
04AC   0080           00638         movwf INDF
04AD   0A84           00639         incf FSR,F
04AE   084B           00640         movfw ROOT_DIR_CL4
04AF   0080           00641         movwf INDF
04B0   0A84           00642         incf FSR,F
                      00643                 
04B1                  00644 NEXT_CLUSTER_NO_ROOT
                      00645         BANK_0
04B1   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
04B2   1283               M                 bcf     STATUS,RP0    
                      00646         
04B3   2672           00647         call POSUNDOPRAVA_7     ; X := X div 128  ; PRETECENI := X mod 128
04B4   30AC           00648         movlw 0xAC                                      ; PRETECENI
04B5   0084           00649         movwf FSR
04B6   0800           00650         movfw INDF
04B7   00B6           00651         movwf TEMP1
                      00652 
04B8   30A4           00653         movlw 0xA4                                      ; OPERAND_Y
04B9   0084           00654         movwf FSR
04BA   0844           00655         movfw POCATEK_FAT1
04BB   0080           00656         movwf INDF
04BC   0A84           00657         incf FSR,F
04BD   0845           00658         movfw POCATEK_FAT2
04BE   0080           00659         movwf INDF
04BF   0A84           00660         incf FSR,F
04C0   0846           00661         movfw POCATEK_FAT3
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE 45


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

04C1   0080           00662         movwf INDF
04C2   0A84           00663         incf FSR,F
04C3   0847           00664         movfw POCATEK_FAT4
04C4   0080           00665         movwf INDF
04C5   0A84           00666         incf FSR,F
                      00667 
04C6   2582           00668         call SOUCET
                      00669         
04C7   0800           00670         movfw INDF                                      ; FSR ukazuje na VYSLEDEK
04C8   00A7           00671         movwf LBA1
04C9   0A84           00672         incf FSR,F
04CA   0800           00673         movfw INDF
04CB   00A8           00674         movwf LBA2
04CC   0A84           00675         incf FSR,F
04CD   0800           00676         movfw INDF
04CE   00A9           00677         movwf LBA3
04CF   0A84           00678         incf FSR,F
04D0   0800           00679         movfw INDF
04D1   00AA           00680         movwf LBA4
04D2   0A84           00681         incf FSR,F
                      00682         
04D3   01A4           00683         clrf FEATURES
04D4   3001           00684         movlw .1
04D5   00A6           00685         movwf SECTOR_C
04D6   2210           00686         call READ_SECTOR
                      00687 
04D7   1003           00688         bcf STATUS,C                            ; TEMP1 := CLUSTER mod 128 (TEMP1 je v intervalu 0..127)
04D8   0D36           00689         rlf TEMP1,W                                     ; W := TEMP1 * 2
04D9   00B6           00690         movwf TEMP1
04DA   39FF           00691         andlw h'FF'
04DB   1D03           00692         btfss STATUS,Z
04DC   21D3           00693         call PRESKOC                            ; pokud je zaznam o clusteru na nulte pozici v sektoru, 
                            nic preskakovat nebudem...
                      00694 
                      00695 
04DD   30A0           00696         movlw 0xA0                                      ; OPERAND_X
04DE   0084           00697         movwf FSR               
04DF   21C0           00698         call READ_DATA  
04E0   0820           00699         movfw DATA_L
04E1   0080           00700         movwf INDF
04E2   00BC           00701         movwf CLUSTER1
04E3   0A84           00702         incf FSR,F
04E4   0821           00703         movfw DATA_H
04E5   0080           00704         movwf INDF
04E6   00BD           00705         movwf CLUSTER2
04E7   0A84           00706         incf FSR,F      
04E8   21C0           00707         call READ_DATA  
04E9   0820           00708         movfw DATA_L
04EA   0080           00709         movwf INDF
04EB   00BE           00710         movwf CLUSTER3
04EC   0A84           00711         incf FSR,F
04ED   0821           00712         movfw DATA_H
04EE   0080           00713         movwf INDF
04EF   00BF           00714         movwf CLUSTER4
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE 46


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

04F0   0A84           00715         incf FSR,F
                      00716 
                      00717         ; ted mame hodnotu clusteru ktery nam byl na pocatku predan v reg. CLUSTER, podivame se zda neby
                            l nasledkem 
                      00718         ; nejake chyby prazdny, nebo zda neni posledni v alokacnim retezu
04F1   2681           00719         call NULA                                               ; if (OPERAND_X =  0) then PRETECENI := 
                            0 else PRETECENI := 1
                      00720         BANK_1
04F2   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
04F3   1683               M                 bsf     STATUS,RP0    
04F4   182C           00721         btfsc PRETECENI,0
04F5   2CFB           00722         goto NEXT_CLUSTER_NEPRAZDNY
                      00723         BANK_0
04F6   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
04F7   1283               M                 bcf     STATUS,RP0    
04F8   30FF           00724         movlw h'FF'
04F9   00BB           00725         movwf POZICE
04FA   2D12           00726         goto NEXT_CLUSTER_KONEC                 ; Nevim sice jak by se toto mohlo stat, ale cluster byl 
                            prazdny, proto neni jiz co resit..
04FB                  00727 NEXT_CLUSTER_NEPRAZDNY
                      00728         BANK_0
04FB   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
04FC   1283               M                 bcf     STATUS,RP0    
                      00729         ; Ted se podivame zda cluster nebyl posledni v alokacnim retezu -> cluster >= 0x0FFFFFF7
04FD   30F7           00730         movlw 0xF7
04FE   0080           00731         movwf INDF
04FF   0A84           00732         incf FSR,F
0500   30FF           00733         movlw 0xFF
0501   0080           00734         movwf INDF
0502   0A84           00735         incf FSR,F
0503   30FF           00736         movlw 0xFF
0504   0080           00737         movwf INDF
0505   0A84           00738         incf FSR,F
0506   300F           00739         movlw 0x0F
0507   0080           00740         movwf INDF
0508   0A84           00741         incf FSR,F
                      00742         
0509   25AB           00743         call ROZDIL                                             ; VYSLEDEK := X - Y 
                      00744                                                                         ; pri podteceni PRETECENI = 1 ( 
                            VYSLEDEK < 0 => PRETECENI = 1 )
                      00745         BANK_1
050A   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
050B   1683               M                 bsf     STATUS,RP0    
050C   182C           00746         btfsc PRETECENI,0
050D   2D12           00747         goto NEXT_CLUSTER_KONEC
                      00748         BANK_0
050E   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
050F   1283               M                 bcf     STATUS,RP0    
0510   30FF           00749         movlw h'FF'
0511   00BB           00750         movwf POZICE
0512                  00751 NEXT_CLUSTER_KONEC
                      00752         BANK_0
0512   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0513   1283               M                 bcf     STATUS,RP0    
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE 47


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0514   0008           00753         return
                      00754 ;**************************************************************************
0515                  00755 FILE_INFO
                      00756         ; z disku nam ted ma prijit 32bytu dat, ktere reprezentuji jeden zaznam ve slozce
                      00757         ; tato procedura zaznam precte, analyzuje, a do bufferu 2 da nasledujici informace:
                      00758         ;               1.     byte -> = 00h -> zaznam je prazdny; = 01h -> zaznam je adresar; 02h -> za
                            znam je soubor; 06h -> zaznam je soubor s priponou MP3
                      00759         ;               2..9   byte -> 8 znaku dlouhe jmeno ("DOSovsky" tvar - napr. slouzka "dokumenty"
                             = "DOKUME~1" )
                      00760         ;               10..12 byte -> u souboru tri znaky pripony (u adresaru vetsinou mezery - 20h 20h
                             20h)
                      00761         ;               13..16 byte -> 1. cluster souboru
                      00762         ; Pokud se jedna o adresar, a zaznam o pripone se nerovna 0x202020 (tri mezery), tak skutecne jm
                            eno adresare je : ADRESAR.PRI
                      00763         INDF_BANK_2
0515   1783               M                         bsf STATUS,IRP    
0516   3010           00764         movlw 0x10                                      ; 1. byte bufferu 2
0517   0084           00765         movwf FSR
0518   3000           00766         movlw .0                                        ; zatim nevime co zaznam obsahuje, tak ho oznaci
                            me jako prazdny
0519   0080           00767         movwf INDF
051A   0A84           00768         incf FSR,F      
                      00769 
051B   3005           00770         movlw .5                                        ; 5 slov = 10 bytu -> 8 znaku jmena souboru/sloz
                            ky + 2 znaky pripony
051C   00B6           00771         movwf TEMP1
051D                  00772 FILE_INFO__READ_NAME
051D   21C0           00773         call READ_DATA                          ; 2 znaky jmena souboru/slozky, nebo pripony souboru
051E   0820           00774         movfw DATA_L
051F   0080           00775         movwf INDF
0520   0A84           00776         incf FSR,F
0521   0821           00777         movfw DATA_H
0522   0080           00778         movwf INDF
0523   0A84           00779         incf FSR,F
0524   03B6           00780         decf TEMP1,F
0525   1D03           00781         btfss STATUS,Z
0526   2D1D           00782         goto FILE_INFO__READ_NAME       
                      00783 
0527   21C0           00784         call READ_DATA                          ; posledni znak pripony a byt s atributy souboru
0528   0820           00785         movfw DATA_L
0529   0080           00786         movwf INDF
                      00787 
052A   3011           00788         movlw 0x11                                      ; 2. byte bufferu 2 -> 1. znak jmena souboru
052B   0084           00789         movwf FSR
052C   0800           00790         movfw INDF                                      ; ted ve W mame 1. znak jmena souboru/slozky
052D   39FF           00791         andlw h'FF'
052E   1903           00792         btfsc STATUS,Z
052F   2D6C           00793         goto FILE_INFO__KONEC           ; pokud 1. znak jmena souboru = 00h, je zaznam prazdny
0530   3CE5           00794         sublw h'E5'
0531   1903           00795         btfsc STATUS,Z
0532   2D6C           00796         goto FILE_INFO__KONEC           ; pokud 1. znak jmena souboru = E5h, je zaznam prazdny
                      00797         
                      00798         ; pokud jsme tady, tak zaznam obsahuje soubor, adresar, dlouhe jmeno souboru, nebo jmenovku disk
                            u 
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE 48


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00799         ; (jsou dva zpusoby jak zapsat jmenovku svazku, bud do spousteciho zaznamu, nebo jako polozku RO
                            OT adresare)
0533   0821           00800         movfw DATA_H                            ; byt s atributy souboru
0534   390F           00801         andlw h'0F'
0535   3C0F           00802         sublw h'0F'                                     ; if (atributy and 0Fh) = 0Fh -> zaznam s dlouhy
                            m nazvem souboru
0536   1903           00803         btfsc STATUS,Z
0537   2D6C           00804         goto FILE_INFO__KONEC           ; pokud zaznam je dlouhy nazav souboru, koncime
0538   19A1           00805         btfsc DATA_H,3
0539   2D6C           00806         goto FILE_INFO__KONEC           ; if (atributy and 08h) = 08h -> jmenovka disku
053A   1A21           00807         btfsc DATA_H,4                          ; if (atributy and 16h) = 16h -> adresar
053B   2D51           00808         goto FILE_INFO__DIR
                      00809 
053C   3002           00810         movlw h'02'                                     ; zaznam je soubor
053D   00B6           00811         movwf TEMP1
                      00812         ; tady vime, ze zaznam je soubor, tak se podivame, zda to neni mp3
053E   3019           00813         movlw 0x19                                      ; 10. byt bufferu 2 -> 1. znak pripony souboru
053F   0084           00814         movwf FSR
                      00815 
0540   0800           00816         movfw INDF
0541   3C4D           00817         sublw 'M'                                       ; (jmena souboru v "DOSovskem" tvaru maji vzdy v
                            elka pismena)
0542   1D03           00818         btfss STATUS,Z
0543   2D53           00819         goto FILE_INFO__FILE
0544   0A84           00820         incf FSR,F
0545   0800           00821         movfw INDF
0546   3C50           00822         sublw 'P'
0547   1D03           00823         btfss STATUS,Z
0548   2D53           00824         goto FILE_INFO__FILE
0549   0A84           00825         incf FSR,F
054A   0800           00826         movfw INDF
054B   3C33           00827         sublw '3'
054C   1D03           00828         btfss STATUS,Z
054D   2D53           00829         goto FILE_INFO__FILE
                      00830 
054E   3006           00831         movlw h'06'                                     ; ted je jasne, ze soubor je mp3
054F   00B6           00832         movwf TEMP1
0550   2D53           00833         goto FILE_INFO__FILE
                      00834 
0551                  00835 FILE_INFO__DIR
0551   3001           00836         movlw h'01'                                     ; zaznam je adresar
0552   00B6           00837         movwf TEMP1
                      00838 
0553                  00839 FILE_INFO__FILE
                      00840         ; tady mame v TEMP 1 jednu z nasledujicich hodnot:
                      00841         ; 01h -> zaznam je adresar; 02h -> zaznam je soubor; 06h -> zaznam je soubor s priponou MP3
0553   3010           00842         movlw 0x10                                      ; 1. byt bufferu 2 -> identifikace zaznamu
0554   0084           00843         movwf FSR
0555   0836           00844         movfw TEMP1
0556   0080           00845         movwf INDF
                      00846 
0557   3004           00847         movlw .4
0558   00B6           00848         movwf TEMP1
0559   21D3           00849         call PRESKOC                            ; nasledujicich 8 bytu ze zaznamu je pro nas k nicemu (o
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE 49


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                            bsahuji cas posledni upravy, otevreni a buh vi co jeste...)
                      00850 
055A   301E           00851         movlw 0x1E                                      ; 15. byt bufferu 2 -> 2. byt prvniho clusteru
055B   0084           00852         movwf FSR
055C   21C0           00853         call READ_DATA                          ; jedno slovo -> horni cast cisla prvniho clusteru
055D   0820           00854         movfw DATA_L
055E   0080           00855         movwf INDF
055F   0A84           00856         incf FSR,F
0560   0821           00857         movfw DATA_H
0561   0080           00858         movwf INDF
                      00859 
0562   21C0           00860         call READ_DATA                          ; cas vytvoreni   (1 word)
0563   21C0           00861         call READ_DATA                          ; datum vytvoreni (1 word)
                      00862 
0564   301C           00863         movlw 0x1C                                      ; 13. byt bufferu 2 -> 0. byt prvniho clusteru
0565   0084           00864         movwf FSR
0566   21C0           00865         call READ_DATA                          ; jedno slovo -> dolni cast cisla prvniho clusteru
0567   0820           00866         movfw DATA_L
0568   0080           00867         movwf INDF
0569   0A84           00868         incf FSR,F
056A   0821           00869         movfw DATA_H
056B   0080           00870         movwf INDF
                      00871         
                      00872         ; Pak jsou v zaznamu jeste 4 byty, ktere obsahuji velikost souboru. Ty mi ale nepotrebujeme...  
056C                  00873 FILE_INFO__KONEC
056C   0008           00874         return
                      00875 ;**************************************************************************
056D                  00876 FILE_SIZE
                      00877         ; z disku nam ted ma prijit 32bytu dat, ktere reprezentuji jeden zaznam ve slozce
                      00878         ; Zaznam by mel byt soubor, podprogram toto nekontroluje (zda zaznam neni adresar)
                      00879         ; Na zacatek bufferu 1 da 4 byty obsahujici velikost zaznamu
056D   300E           00880         movlw .14                                       ; my ted potrebujeme jen posledni 4 byty ze zazn
                            amu, tam se nachazi velikost souboru
056E   00B6           00881         movwf TEMP1
056F   21D3           00882         call PRESKOC
                      00883 
                      00884         INDF_BANK_2
0570   1783               M                         bsf STATUS,IRP    
0571   3010           00885         movlw 0x10                                      ; 1. byte bufferu 1
0572   0084           00886         movwf FSR
                      00887 
0573   21C0           00888         call READ_DATA
0574   0820           00889         movfw DATA_L
0575   0080           00890         movwf INDF
0576   0A84           00891         incf FSR,F
0577   0821           00892         movfw DATA_H
0578   0080           00893         movwf INDF
0579   0A84           00894         incf FSR,F
                      00895 
057A   21C0           00896         call READ_DATA
057B   0820           00897         movfw DATA_L
057C   0080           00898         movwf INDF
057D   0A84           00899         incf FSR,F
057E   0821           00900         movfw DATA_H
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE 50


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

057F   0080           00901         movwf INDF
0580   0A84           00902         incf FSR,F
                      00903 
0581   0008           00904         return
                      00905 ;**************************************************************************
                      00055         include "aritmetic.asm" ; podprogramy vykonavajici zakladni aritmetologicke operace
                      00001 ;**********************************************************
                      00002 ;**********************************************************
                      00003 ;**********************************************************
                      00004 ; Obsahuje podrogramy realizujici zakladni aritmeticke operace
                      00005 ; pouzivane v mp3 preprcavaci. Vsechny operace se provadi 
                      00006 ; s 32bitovymi cisly.
                      00007 ; 
                      00008 ; Pro praci aritmetickych procedur je rezervovana BANKA 1 !!!!!
                      00009 ;**********************************************************
                      00010 ;**********************************************************
                      00011 ;**********************************************************
0582                  00012 SOUCET
                      00013 ; provede soucet hodnoty v registrech OPERAND_X[1..4] 
                      00014 ; s hodnotou v OPERAND_Y[1..4] a umisti do VYSLEDEK[1..4] 
                      00015 ; pokud dojde k preteceni, nastavi se PRETECENI do 1
                      00016 ; (byty s indexem 1 maji nejnizsi vahu)
                      00017         BANK_1
0582   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0583   1683               M                 bsf     STATUS,RP0    
0584   01AC           00018         clrf PRETECENI
                      00019 
0585   0820           00020         movfw OPERAND_X1
0586   0724           00021         addwf OPERAND_Y1,W
0587   00A8           00022         movwf VYSLEDEK1
0588   1803           00023         btfsc STATUS,C
0589   14AC           00024                 bsf PRETECENI,1
                      00025 
058A   0821           00026         movfw OPERAND_X2
058B   0725           00027         addwf OPERAND_Y2,W
058C   00A9           00028         movwf VYSLEDEK2
058D   1803           00029         btfsc STATUS,C
058E   142C           00030                 bsf PRETECENI,0
058F   18AC           00031         btfsc PRETECENI,1
0590   0AA9           00032                 incf VYSLEDEK2,F
0591   1803           00033         btfsc STATUS,C
0592   142C           00034                 bsf PRETECENI,0
0593   10AC           00035         bcf PRETECENI,1
                      00036 
0594   0822           00037         movfw OPERAND_X3
0595   0726           00038         addwf OPERAND_Y3,W
0596   00AA           00039         movwf VYSLEDEK3
0597   1803           00040         btfsc STATUS,C
0598   14AC           00041                 bsf PRETECENI,1
0599   182C           00042         btfsc PRETECENI,0
059A   0AAA           00043                 incf VYSLEDEK3,F
059B   1803           00044         btfsc STATUS,C
059C   14AC           00045                 bsf PRETECENI,1
059D   102C           00046         bcf PRETECENI,0
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE 51


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00047 
059E   0823           00048         movfw OPERAND_X4
059F   0727           00049         addwf OPERAND_Y4,W
05A0   00AB           00050         movwf VYSLEDEK4
05A1   1803           00051         btfsc STATUS,C
05A2   142C           00052                 bsf PRETECENI,0
05A3   18AC           00053         btfsc PRETECENI,1
05A4   0AAB           00054                 incf VYSLEDEK4,F
05A5   1803           00055         btfsc STATUS,C
05A6   142C           00056                 bsf PRETECENI,0
05A7   10AC           00057         bcf PRETECENI,1 
                      00058 
                      00059         BANK_0
05A8   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
05A9   1283               M                 bcf     STATUS,RP0    
05AA   0008           00060         return
                      00061 ;**********************************************************
                      00062 ;**********************************************************
05AB                  00063 ROZDIL  ; VYSLEDEK := X - Y
                      00064                 ; pri podteceni PRETECENI = 1 ( VYSLEDEK < 0 => PRETECENI = 1 )
                      00065         BANK_1
05AB   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
05AC   1683               M                 bsf     STATUS,RP0    
05AD   01AC           00066         clrf PRETECENI
                      00067 
05AE   0824           00068         movfw OPERAND_Y1
05AF   0220           00069         subwf OPERAND_X1,W      ; W = X - Y     
05B0   00A8           00070         movwf VYSLEDEK1
05B1   1C03           00071         btfss STATUS,C
05B2   14AC           00072                 bsf PRETECENI,1
                      00073         
05B3   0825           00074         movfw OPERAND_Y2
05B4   0221           00075         subwf OPERAND_X2,W      ; W = X - Y     
05B5   00A9           00076         movwf VYSLEDEK2
05B6   1C03           00077         btfss STATUS,C
05B7   142C           00078                 bsf PRETECENI,0
05B8   18AC           00079         btfsc PRETECENI,1
05B9   03A9           00080                 decf VYSLEDEK2,F
05BA   1C03           00081         btfss STATUS,C
05BB   142C           00082                 bsf PRETECENI,0
05BC   10AC           00083         bcf PRETECENI,1 
                      00084         
05BD   0826           00085         movfw OPERAND_Y3
05BE   0222           00086         subwf OPERAND_X3,W      ; W = X - Y     
05BF   00AA           00087         movwf VYSLEDEK3
05C0   1C03           00088         btfss STATUS,C
05C1   14AC           00089                 bsf PRETECENI,1
05C2   182C           00090         btfsc PRETECENI,0
05C3   03AA           00091                 decf VYSLEDEK3,F
05C4   1C03           00092         btfss STATUS,C
05C5   14AC           00093                 bsf PRETECENI,1
05C6   102C           00094         bcf PRETECENI,0
                      00095         
05C7   0827           00096         movfw OPERAND_Y4
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE 52


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

05C8   0223           00097         subwf OPERAND_X4,W      ; W = X - Y     
05C9   00AB           00098         movwf VYSLEDEK4
05CA   1C03           00099         btfss STATUS,C
05CB   142C           00100                 bsf PRETECENI,0
05CC   18AC           00101         btfsc PRETECENI,1
05CD   03AB           00102                 decf VYSLEDEK4,F
05CE   1C03           00103         btfss STATUS,C
05CF   142C           00104                 bsf PRETECENI,0
05D0   10AC           00105         bcf PRETECENI,1 
                      00106         
                      00107         BANK_0
05D1   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
05D2   1283               M                 bcf     STATUS,RP0    
05D3   0008           00108         return
                      00109 ;**********************************************************
05D4                  00110 POSUNDOLEVA     ; X := (X * 2) mod 0xFFFFFFFF , PRETECENI := (X * 2) div 0xFFFFFFFF
                      00111                         ; tento podprogram nepouzivat, primo v hlavnim programu
                      00112                         ; musi se nastavit BANK_1 a vymazat PRETECENI!!!
                      00113                         ; (je pouze pro pouziti v nasobicich podprogramech)
                      00114                         ; pouzivat jen POSUNDOLEVA_1, 2, 3, 4 
05D4   0DA0           00115         rlf OPERAND_X1,F
05D5   0DA1           00116         rlf OPERAND_X2,F
05D6   0DA2           00117         rlf OPERAND_X3,F
05D7   0DA3           00118         rlf OPERAND_X4,F
05D8   0DAC           00119         rlf PRETECENI,F 
05D9   0008           00120         return
                      00121 ;**********************************************************
05DA                  00122 POSUNDOLEVA_1   ; X := X * 2
                      00123                                 ; X > 0xFFFF FFFF => PRETECENI obsahuje bity navic
                      00124         BANK_1
05DA   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
05DB   1683               M                 bsf     STATUS,RP0    
05DC   01AC           00125         clrf PRETECENI
05DD   1003           00126         bcf STATUS,C
                      00127         
05DE   25D4           00128         call POSUNDOLEVA
                      00129 
                      00130         BANK_0
05DF   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
05E0   1283               M                 bcf     STATUS,RP0    
05E1   0008           00131         return
                      00132 ;**********************************************************
05E2                  00133 POSUNDOLEVA_2   ; X := X * 4
                      00134                                 ; X > 0xFFFF FFFF => PRETECENI obsahuje bity navic
                      00135         BANK_1
05E2   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
05E3   1683               M                 bsf     STATUS,RP0    
05E4   01AC           00136         clrf PRETECENI
05E5   1003           00137         bcf STATUS,C
                      00138         
05E6   25D4           00139         call POSUNDOLEVA
05E7   25D4           00140         call POSUNDOLEVA
                      00141 
                      00142         BANK_0
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE 53


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

05E8   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
05E9   1283               M                 bcf     STATUS,RP0    
05EA   0008           00143         return
                      00144 ;**********************************************************
05EB                  00145 POSUNDOLEVA_3   ; X := X * 8
                      00146                                 ; X > 0xFFFF FFFF => PRETECENI obsahuje bity navic
                      00147         BANK_1
05EB   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
05EC   1683               M                 bsf     STATUS,RP0    
05ED   01AC           00148         clrf PRETECENI
05EE   1003           00149         bcf STATUS,C
                      00150         
05EF   25D4           00151         call POSUNDOLEVA
05F0   25D4           00152         call POSUNDOLEVA
05F1   25D4           00153         call POSUNDOLEVA
                      00154 
                      00155         BANK_0
05F2   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
05F3   1283               M                 bcf     STATUS,RP0    
05F4   0008           00156         return
                      00157 ;**********************************************************
05F5                  00158 POSUNDOLEVA_4   ; X := X * 16
                      00159                                 ; X > 0xFFFF FFFF => PRETECENI obsahuje bity navic
                      00160         BANK_1
05F5   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
05F6   1683               M                 bsf     STATUS,RP0    
05F7   01AC           00161         clrf PRETECENI
05F8   1003           00162         bcf STATUS,C
                      00163         
05F9   25D4           00164         call POSUNDOLEVA
05FA   25D4           00165         call POSUNDOLEVA
05FB   25D4           00166         call POSUNDOLEVA
05FC   25D4           00167         call POSUNDOLEVA
                      00168 
                      00169         BANK_0
05FD   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
05FE   1283               M                 bcf     STATUS,RP0    
05FF   0008           00170         return
                      00171 ;**********************************************************
0600                  00172 POSUNDOLEVA_5   ; X := X * 32
                      00173                                 ; X > 0xFFFF FFFF => PRETECENI obsahuje bity navic
                      00174         BANK_1
0600   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0601   1683               M                 bsf     STATUS,RP0    
0602   01AC           00175         clrf PRETECENI
0603   1003           00176         bcf STATUS,C
                      00177         
0604   25D4           00178         call POSUNDOLEVA
0605   25D4           00179         call POSUNDOLEVA
0606   25D4           00180         call POSUNDOLEVA
0607   25D4           00181         call POSUNDOLEVA
0608   25D4           00182         call POSUNDOLEVA
                      00183 
                      00184         BANK_0
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE 54


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0609   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
060A   1283               M                 bcf     STATUS,RP0    
060B   0008           00185         return
                      00186 ;**********************************************************
060C                  00187 POSUNDOLEVA_6   ; X := X * 64
                      00188                                 ; X > 0xFFFF FFFF => PRETECENI obsahuje bity navic
                      00189         BANK_1
060C   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
060D   1683               M                 bsf     STATUS,RP0    
060E   01AC           00190         clrf PRETECENI
060F   1003           00191         bcf STATUS,C
                      00192         
0610   25D4           00193         call POSUNDOLEVA
0611   25D4           00194         call POSUNDOLEVA
0612   25D4           00195         call POSUNDOLEVA
0613   25D4           00196         call POSUNDOLEVA
0614   25D4           00197         call POSUNDOLEVA
0615   25D4           00198         call POSUNDOLEVA
                      00199 
                      00200         BANK_0
0616   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0617   1283               M                 bcf     STATUS,RP0    
0618   0008           00201         return
                      00202 ;**********************************************************
0619                  00203 POSUNDOLEVA_7   ; X := X * 128
                      00204                                 ; X > 0xFFFF FFFF => PRETECENI obsahuje bity navic
                      00205         BANK_1
0619   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
061A   1683               M                 bsf     STATUS,RP0    
061B   01AC           00206         clrf PRETECENI
061C   1003           00207         bcf STATUS,C
                      00208         
061D   25D4           00209         call POSUNDOLEVA
061E   25D4           00210         call POSUNDOLEVA
061F   25D4           00211         call POSUNDOLEVA
0620   25D4           00212         call POSUNDOLEVA
0621   25D4           00213         call POSUNDOLEVA
0622   25D4           00214         call POSUNDOLEVA
0623   25D4           00215         call POSUNDOLEVA
                      00216 
                      00217         BANK_0
0624   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0625   1283               M                 bcf     STATUS,RP0    
0626   0008           00218         return
                      00219 ;**********************************************************
0627                  00220 POSUNDOPRAVA    ; X := X div 2 , PRETECENI := X mod 2
                      00221                         ; tento podprogram nepouzivat, primo v hlavnim programu
                      00222                         ; musi se nastavit BANK_1 a vymazat PRETECENI!!!
                      00223                         ; (je pouze pro pouziti v nasobicich podprogramech)
                      00224                         ; pouzivat jen POSUNDOPRAVA_1, 2, 3, 4 
0627   1003           00225         bcf STATUS,C
0628   0CA3           00226         rrf OPERAND_X4,F
0629   0CA2           00227         rrf OPERAND_X3,F
062A   0CA1           00228         rrf OPERAND_X2,F
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE 55


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

062B   0CA0           00229         rrf OPERAND_X1,F
062C   0008           00230         return
                      00231 ;**********************************************************
062D                  00232 POSUNDOPRAVA_1  ; X := X div 2
                      00233                                 ; PRETECENI := X mod 2
                      00234         BANK_1
062D   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
062E   1683               M                 bsf     STATUS,RP0    
062F   0820           00235         movfw OPERAND_X1
0630   3901           00236         andlw b'00000001'
0631   00AC           00237         movwf PRETECENI         ; PRETECENI := X mod 2
                      00238         
0632   2627           00239         call POSUNDOPRAVA
                      00240 
                      00241         BANK_0
0633   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0634   1283               M                 bcf     STATUS,RP0    
0635   0008           00242         return
                      00243 ;**********************************************************
0636                  00244 POSUNDOPRAVA_2  ; X := X div 4
                      00245                                 ; PRETECENI := X mod 4
                      00246         BANK_1
0636   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0637   1683               M                 bsf     STATUS,RP0    
0638   0820           00247         movfw OPERAND_X1
0639   3903           00248         andlw b'00000011'
063A   00AC           00249         movwf PRETECENI         ; PRETECENI := X mod 4
                      00250         
063B   2627           00251         call POSUNDOPRAVA
063C   2627           00252         call POSUNDOPRAVA
                      00253 
                      00254         BANK_0
063D   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
063E   1283               M                 bcf     STATUS,RP0    
063F   0008           00255         return
                      00256 ;**********************************************************
0640                  00257 POSUNDOPRAVA_3  ; X := X div 8
                      00258                                 ; PRETECENI := X mod 8
                      00259         BANK_1
0640   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0641   1683               M                 bsf     STATUS,RP0    
0642   0820           00260         movfw OPERAND_X1
0643   3907           00261         andlw b'00000111'
0644   00AC           00262         movwf PRETECENI         ; PRETECENI := X mod 8
                      00263         
0645   2627           00264         call POSUNDOPRAVA
0646   2627           00265         call POSUNDOPRAVA
0647   2627           00266         call POSUNDOPRAVA
                      00267 
                      00268         BANK_0
0648   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0649   1283               M                 bcf     STATUS,RP0    
064A   0008           00269         return
                      00270 ;**********************************************************
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE 56


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

064B                  00271 POSUNDOPRAVA_4  ; X := X div 16
                      00272                                 ; PRETECENI := X mod 16
                      00273         BANK_1
064B   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
064C   1683               M                 bsf     STATUS,RP0    
064D   0820           00274         movfw OPERAND_X1
064E   390F           00275         andlw b'00001111'
064F   00AC           00276         movwf PRETECENI         ; PRETECENI := X mod 16
                      00277         
0650   2627           00278         call POSUNDOPRAVA
0651   2627           00279         call POSUNDOPRAVA
0652   2627           00280         call POSUNDOPRAVA
0653   2627           00281         call POSUNDOPRAVA
                      00282 
                      00283         BANK_0
0654   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0655   1283               M                 bcf     STATUS,RP0    
0656   0008           00284         return
                      00285 ;**********************************************************
0657                  00286 POSUNDOPRAVA_5  ; X := X div 32
                      00287                                 ; PRETECENI := X mod 32
                      00288         BANK_1
0657   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0658   1683               M                 bsf     STATUS,RP0    
0659   0820           00289         movfw OPERAND_X1
065A   391F           00290         andlw b'00011111'
065B   00AC           00291         movwf PRETECENI         ; PRETECENI := X mod 32
                      00292         
065C   2627           00293         call POSUNDOPRAVA
065D   2627           00294         call POSUNDOPRAVA
065E   2627           00295         call POSUNDOPRAVA
065F   2627           00296         call POSUNDOPRAVA
0660   2627           00297         call POSUNDOPRAVA
                      00298 
                      00299         BANK_0
0661   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0662   1283               M                 bcf     STATUS,RP0    
0663   0008           00300         return
                      00301 ;**********************************************************
0664                  00302 POSUNDOPRAVA_6  ; X := X div 64
                      00303                                 ; PRETECENI := X mod 64
                      00304         BANK_1
0664   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0665   1683               M                 bsf     STATUS,RP0    
0666   0820           00305         movfw OPERAND_X1
0667   393F           00306         andlw b'00111111'
0668   00AC           00307         movwf PRETECENI         ; PRETECENI := X mod 64
                      00308         
0669   2627           00309         call POSUNDOPRAVA
066A   2627           00310         call POSUNDOPRAVA
066B   2627           00311         call POSUNDOPRAVA
066C   2627           00312         call POSUNDOPRAVA
066D   2627           00313         call POSUNDOPRAVA
066E   2627           00314         call POSUNDOPRAVA
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE 57


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00315 
                      00316         BANK_0
066F   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0670   1283               M                 bcf     STATUS,RP0    
0671   0008           00317         return
                      00318 ;**********************************************************
0672                  00319 POSUNDOPRAVA_7  ; X := X div 128
                      00320                                 ; PRETECENI := X mod 128
                      00321         BANK_1
0672   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0673   1683               M                 bsf     STATUS,RP0    
0674   0820           00322         movfw OPERAND_X1
0675   397F           00323         andlw b'01111111'
0676   00AC           00324         movwf PRETECENI         ; PRETECENI := X mod 128
                      00325         
0677   2627           00326         call POSUNDOPRAVA
0678   2627           00327         call POSUNDOPRAVA
0679   2627           00328         call POSUNDOPRAVA
067A   2627           00329         call POSUNDOPRAVA
067B   2627           00330         call POSUNDOPRAVA
067C   2627           00331         call POSUNDOPRAVA
067D   2627           00332         call POSUNDOPRAVA
                      00333 
                      00334         BANK_0
067E   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
067F   1283               M                 bcf     STATUS,RP0    
0680   0008           00335         return
                      00336 ;**********************************************************
0681                  00337 NULA    ; if (X =  0) then PRETECENI := 0
                      00338                 ; if (X <> 0) then PRETECENI := 1
                      00339                 ; obsah X zustane nezmenen
                      00340         BANK_1
0681   1303               M                 bcf     STATUS,RP1              ; BANK1  RP1:RP0 = 01
0682   1683               M                 bsf     STATUS,RP0    
0683   01AC           00341         clrf PRETECENI
0684   30FF           00342         movlw h'FF'     
                      00343 
0685   05A0           00344         andwf OPERAND_X1,F
0686   1D03           00345         btfss STATUS,Z
0687   142C           00346                 bsf PRETECENI,0
0688   05A1           00347         andwf OPERAND_X2,F
0689   1D03           00348         btfss STATUS,Z
068A   142C           00349                 bsf PRETECENI,0
068B   05A2           00350         andwf OPERAND_X3,F
068C   1D03           00351         btfss STATUS,Z
068D   142C           00352                 bsf PRETECENI,0
068E   05A3           00353         andwf OPERAND_X4,F
068F   1D03           00354         btfss STATUS,Z
0690   142C           00355                 bsf PRETECENI,0         
                      00356 
                      00357         BANK_0
0691   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
0692   1283               M                 bcf     STATUS,RP0    
0693   0008           00358         return
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE 58


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00359 ;**********************************************************
                      00056  
0800                  00057  org 0x0800                                     ; !!!! PAGE 1
                      00058 ;#IF VS1001==1
                      00059         include "vs1001.asm"    ; podprogramy na ovladani mp3 decoderu
                      00001 ;**********************************************************
                      00002 ;**********************************************************
                      00003 ;**********************************************************
                      00004 ; OBSLUZNE PODPROGRAMY PRO MP3 DECODER vs1001g
                      00005 ;**********************************************************
                      00006 ;**********************************************************
                      00007 ;**********************************************************
                      00008 
                      00009 ; MP3_PORT              
                      00010 ; MP3_PORT_TRIS 
                      00011 
                      00012 ; BITY MP3_PORT
                      00013 ; #define MP3_SO                MP3_PORT,0      ; serial output - tady dostavame z dekoderu data
                      00014 ; #define MP3_SI                MP3_PORT,1      ; serial input  - pokud MP3_CS=1, tak posilame mp3 data,
                             pokud =0, tak posilame prikaz
                      00015 ; #define MP3_SCLK              MP3_PORT,2      ; clock - nabezna hrana urcuje platnost dat pri seriovem
                             prenosu
                      00016 ; #define MP3_CS                MP3_PORT,3      ; cable select  - pokud MP3_CS=1, tak po SI posilame mp3
                             data, pokud =0, tak posilame prikaz
                      00017 ; #define MP3_DREQ              MP3_PORT,4      ; data request  - pokud =1, tak dekoder pozaduje dalsi m
                            p3 data (vic jak 32B)
                      00018 ; #define MP3_BSYNC             MP3_PORT,5      ; pro synchronizaci - ma byt nastaven pri prvnim prenase
                            nem bitu kazdeho bytu
                      00019 
                      00020 ;**********************************************************
                      00021 ; co nejrychleji vodesle hodnotu ve W smerem k dekoderu (obsluhuje signaly DSYNC, SI, SCLK)
0800                  00022 VS_WR_BYTE
                      00023         ; k praci pouziva TEMPW
0800   00B5           00024         movwf TEMPW             ; dato co mame odeslat si hodime do tempu...
                      00025 
0801   1685           00026         bsf MP3_BSYNC   ; bude nasledovat prvni bit bytu, proto nastavime BSYNC
                      00027 
                      00028         ; 7. bit bytu
0802   1105           00029         bcf MP3_SCLK    ; shodime SCLK
0803   1085           00030         bcf MP3_SI              ; nevime zda bit bude 0 nebo 1, SI nulujeme
0804   0DB5           00031         rlf TEMPW,f             ; odesilame od nejvyssiho bitu k nejnizsimu
0805   1803           00032         btfsc STATUS,C
0806   1485           00033         bsf MP3_SI
0807   1505           00034         bsf MP3_SCLK
0808   1285           00035         bcf MP3_BSYNC
                      00036         
                      00037         ; 6. bit bytu
0809   1105           00038         bcf MP3_SCLK    ; shodime SCLK
080A   1085           00039         bcf MP3_SI              ; nevime zda bit bude 0 nebo 1, SI nulujeme
080B   0DB5           00040         rlf TEMPW,f             ; odesilame od nejvyssiho bitu k nejnizsimu
080C   1803           00041         btfsc STATUS,C
080D   1485           00042         bsf MP3_SI
080E   1505           00043         bsf MP3_SCLK
                      00044 
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE 59


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00045         ; 5. bit bytu
080F   1105           00046         bcf MP3_SCLK    ; shodime SCLK
0810   1085           00047         bcf MP3_SI              ; nevime zda bit bude 0 nebo 1, SI nulujeme
0811   0DB5           00048         rlf TEMPW,f             ; odesilame od nejvyssiho bitu k nejnizsimu
0812   1803           00049         btfsc STATUS,C
0813   1485           00050         bsf MP3_SI
0814   1505           00051         bsf MP3_SCLK
                      00052 
                      00053         ; 4. bit bytu
0815   1105           00054         bcf MP3_SCLK    ; shodime SCLK
0816   1085           00055         bcf MP3_SI              ; nevime zda bit bude 0 nebo 1, SI nulujeme
0817   0DB5           00056         rlf TEMPW,f             ; odesilame od nejvyssiho bitu k nejnizsimu
0818   1803           00057         btfsc STATUS,C
0819   1485           00058         bsf MP3_SI
081A   1505           00059         bsf MP3_SCLK
                      00060 
                      00061         ; 3. bit bytu
081B   1105           00062         bcf MP3_SCLK    ; shodime SCLK
081C   1085           00063         bcf MP3_SI              ; nevime zda bit bude 0 nebo 1, SI nulujeme
081D   0DB5           00064         rlf TEMPW,f             ; odesilame od nejvyssiho bitu k nejnizsimu
081E   1803           00065         btfsc STATUS,C
081F   1485           00066         bsf MP3_SI
0820   1505           00067         bsf MP3_SCLK
                      00068 
                      00069         ; 2. bit bytu
0821   1105           00070         bcf MP3_SCLK    ; shodime SCLK
0822   1085           00071         bcf MP3_SI              ; nevime zda bit bude 0 nebo 1, SI nulujeme
0823   0DB5           00072         rlf TEMPW,f             ; odesilame od nejvyssiho bitu k nejnizsimu
0824   1803           00073         btfsc STATUS,C
0825   1485           00074         bsf MP3_SI
0826   1505           00075         bsf MP3_SCLK
                      00076 
                      00077         ; 1. bit bytu
0827   1105           00078         bcf MP3_SCLK    ; shodime SCLK
0828   1085           00079         bcf MP3_SI              ; nevime zda bit bude 0 nebo 1, SI nulujeme
0829   0DB5           00080         rlf TEMPW,f             ; odesilame od nejvyssiho bitu k nejnizsimu
082A   1803           00081         btfsc STATUS,C
082B   1485           00082         bsf MP3_SI
082C   1505           00083         bsf MP3_SCLK
                      00084 
                      00085         ; 0. bit bytu
082D   1105           00086         bcf MP3_SCLK    ; shodime SCLK
082E   1085           00087         bcf MP3_SI              ; nevime zda bit bude 0 nebo 1, SI nulujeme
082F   0DB5           00088         rlf TEMPW,f             ; odesilame od nejvyssiho bitu k nejnizsimu
0830   1803           00089         btfsc STATUS,C
0831   1485           00090         bsf MP3_SI
0832   1505           00091         bsf MP3_SCLK
                      00092 
0833   1105           00093         bcf MP3_SCLK
0834   0008           00094         return
                      00095 ;**********************************************************
                      00096 ; co nejrychleji prijme dato z vs1001 a umisti jej do W
0835                  00097 VS_RD_BYTE
                      00098         ; k praci pouziva TEMPW
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE 60


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00099 
0835   01B5           00100         clrf TEMPW              ; vymazeme, sem budeme strkat dato co nam prijde...
0836   1105           00101         bcf MP3_SCLK    ; shodime SCLK
0837   1685           00102         bsf MP3_BSYNC   ; bude nasledovat prvni bit bytu, proto nastavime BSYNC
0838   1003           00103         bcf STATUS,C    ; nulujeme priznak CARRY, staci to delat jen na zacatku, protoze TEMW mame prazd
                            ny...
                      00104 
                      00105         ; 7. bit bytu
0839   1505           00106         bsf MP3_SCLK    ; nabezna hrana SCLK
083A   1805           00107         btfsc MP3_SO
083B   1403           00108         bsf STATUS,C    ; pokud je SO v jednice nastavime C...
083C   0DB5           00109         rlf TEMPW,f
083D   1105           00110         bcf MP3_SCLK    ; shodime SCLK
                      00111 
083E   1285           00112         bcf MP3_BSYNC
                      00113 
                      00114         ; 6. bit bytu
083F   1505           00115         bsf MP3_SCLK    ; nabezna hrana SCLK
0840   1805           00116         btfsc MP3_SO
0841   1403           00117         bsf STATUS,C    ; pokud je SO v jednice nastavime C...
0842   0DB5           00118         rlf TEMPW,f
0843   1105           00119         bcf MP3_SCLK    ; shodime SCLK  
                      00120 
                      00121         ; 5. bit bytu
0844   1505           00122         bsf MP3_SCLK    ; nabezna hrana SCLK
0845   1805           00123         btfsc MP3_SO
0846   1403           00124         bsf STATUS,C    ; pokud je SO v jednice nastavime C...
0847   0DB5           00125         rlf TEMPW,f
0848   1105           00126         bcf MP3_SCLK    ; shodime SCLK  
                      00127 
                      00128         ; 4. bit bytu
0849   1505           00129         bsf MP3_SCLK    ; nabezna hrana SCLK
084A   1805           00130         btfsc MP3_SO
084B   1403           00131         bsf STATUS,C    ; pokud je SO v jednice nastavime C...
084C   0DB5           00132         rlf TEMPW,f
084D   1105           00133         bcf MP3_SCLK    ; shodime SCLK  
                      00134 
                      00135         ; 3. bit bytu
084E   1505           00136         bsf MP3_SCLK    ; nabezna hrana SCLK
084F   1805           00137         btfsc MP3_SO
0850   1403           00138         bsf STATUS,C    ; pokud je SO v jednice nastavime C...
0851   0DB5           00139         rlf TEMPW,f
0852   1105           00140         bcf MP3_SCLK    ; shodime SCLK  
                      00141 
                      00142         ; 2. bit bytu
0853   1505           00143         bsf MP3_SCLK    ; nabezna hrana SCLK
0854   1805           00144         btfsc MP3_SO
0855   1403           00145         bsf STATUS,C    ; pokud je SO v jednice nastavime C...
0856   0DB5           00146         rlf TEMPW,f
0857   1105           00147         bcf MP3_SCLK    ; shodime SCLK  
                      00148 
                      00149         ; 1. bit bytu
0858   1505           00150         bsf MP3_SCLK    ; nabezna hrana SCLK
0859   1805           00151         btfsc MP3_SO
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE 61


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

085A   1403           00152         bsf STATUS,C    ; pokud je SO v jednice nastavime C...
085B   0DB5           00153         rlf TEMPW,f
085C   1105           00154         bcf MP3_SCLK    ; shodime SCLK  
                      00155 
                      00156         ; 0. bit bytu
085D   1505           00157         bsf MP3_SCLK    ; nabezna hrana SCLK
085E   1805           00158         btfsc MP3_SO
085F   1403           00159         bsf STATUS,C    ; pokud je SO v jednice nastavime C...
0860   0D35           00160         rlf TEMPW,W
0861   1105           00161         bcf MP3_SCLK    ; shodime SCLK  
                      00162 
                      00163         ; movfw TEMPW ; tuto operaci jiz nemusime provadet, protoze jsme posledni rotaci hodily do W (rl
                            f TEMPW,W)
0862   0008           00164         return
                      00165 ;**********************************************************
                      00166 ; do TEMP1 dame adresu registru 
                      00167 ; do TEMP2 dame dolni slabiku zapisovaneho slova
                      00168 ; do TEMP3 dame horni slabiku zapisovaneho slova
0863                  00169 VS_WR_REG       ; zapise 16bitove slovo (TEMP2,TEMP3) do registru mp3 dekoderu (TEMP1)
                      00170                         ; 16bit dato se odesila od nejvyssiho bitu (15,14...8,7...1,0)
                      00171                         ; kde TEMP3 = bity 15-8 ; TEMP2 = bity 7-0
                      00172 ; pri praci pouziva TEMP1, TEMP2, TEMP3, TEMPW
0863   1185           00173         bcf MP3_CS                      ; po SI posilame prikaz
0864   3002           00174         movlw b'00000010'       ; write
0865   2000           00175         call VS_WR_BYTE 
0866   0836           00176         movfw TEMP1                     ; adresa zapisovaneho registru
0867   2000           00177         call VS_WR_BYTE
0868   0838           00178         movfw TEMP3             ; horni slabika
0869   2000           00179         call VS_WR_BYTE
086A   0837           00180         movfw TEMP2             ; dolni slabika
086B   2000           00181         call VS_WR_BYTE
086C   1585           00182         bsf MP3_CS
086D   0008           00183         return
                      00184 ;**********************************************************
                      00185 ; do TEMP1 dame adresu registru 
                      00186 ; v TEMP2 nam vrati dolni slabiku precteneho slova
                      00187 ; v TEMP3 nam vrati horni slabiku precteneho slova
086E                  00188 VS_RD_REG       ; precte 16bitove slovo (TEMP3,TEMP2) z registru mp3 dekoderu (TEMP1)
                      00189                         ; kde TEMP3 = bity 15-8 ; TEMP2 = bity 7-0
                      00190 ; pri praci pouziva TEMP1, TEMP2, TEMP3, TEMPW
086E   1185           00191         bcf MP3_CS                      ; po SI posilame prikaz
086F   3003           00192         movlw b'00000011'       ; read
0870   2000           00193         call VS_WR_BYTE 
0871   0836           00194         movfw TEMP1                     ; adresa cteneho registru
0872   2000           00195         call VS_WR_BYTE
0873   2035           00196         call VS_RD_BYTE
0874   00B8           00197         movwf TEMP3             ; horni slabika
0875   2035           00198         call VS_RD_BYTE
0876   00B7           00199         movwf TEMP2             ; dolni slabika
0877   1585           00200         bsf MP3_CS
0878   0008           00201         return
                      00202 ;**********************************************************
0879                  00203 VS_SOFT_RESET   ; provede softwarovy reset dekoderu (pri zapnuti a pote po skonceni kazde mp3)
                      00204         PROG_PAGE_0
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE 62


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0879   118A               M                         bcf PCLATH,3
087A   120A               M                         bcf PCLATH,4
087B   2136           00205         call DELAY_200ms
                      00206         PROG_PAGE_1
087C   158A               M                         bsf PCLATH,3
087D   120A               M                         bcf PCLATH,4
                      00207 
087E   3000           00208         movlw VSADDR_MODE
087F   00B6           00209         movwf TEMP1
0880   154D           00210         bsf VSREG_MODE_L,2      ; soft reset=1
0881   084D           00211         movfw VSREG_MODE_L
0882   00B7           00212         movwf TEMP2
0883   3000           00213         movlw .0                        ; MODE_H
0884   00B8           00214         movwf TEMP3
0885   2063           00215         call VS_WR_REG
                      00216 
                      00217         PROG_PAGE_0
0886   118A               M                         bcf PCLATH,3
0887   120A               M                         bcf PCLATH,4
0888   212D           00218         call DELAY_2ms
                      00219         PROG_PAGE_1
0889   158A               M                         bsf PCLATH,3
088A   120A               M                         bcf PCLATH,4
088B   2096           00220         call VS_SEND_1024_NULL  
                      00221 
088C   114D           00222         bcf VSREG_MODE_L,2      ; soft reset=0
088D   0008           00223         return
                      00224 ;**********************************************************
088E                  00225 VS_SEND_32_NULL
088E   20A5           00226         call WAIT_FOR_VSDREQ
088F   3020           00227         movlw .32
0890   00B7           00228         movwf TEMP2
                      00229         
0891   3000           00230         movlw .0
0892   2000           00231         call VS_WR_BYTE
0893   0BB7           00232         decfsz TEMP2,F
0894   2891           00233         goto $-3
0895   0008           00234         return
                      00235 ;**********************************************************
0896                  00236 VS_SEND_1024_NULL
0896   1585           00237         bsf MP3_CS                      ; po SI posilam data
0897   3020           00238         movlw .32
0898   00B6           00239         movwf TEMP1
                      00240 
0899   208E           00241         call VS_SEND_32_NULL
089A   0BB6           00242         decfsz TEMP1,F
089B   2899           00243         goto $-2
                      00244          
089C   0008           00245         return
                      00246 ;**********************************************************
089D                  00247 VS_SET_VOLUME
089D   300B           00248         movlw VSADDR_VOL
089E   00B6           00249         movwf TEMP1
                      00250 
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE 63


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

089F   084F           00251         movfw VSREG_VOL_L
08A0   00B7           00252         movwf TEMP2
08A1   0850           00253         movfw VSREG_VOL_H
08A2   00B8           00254         movwf TEMP3
08A3   2063           00255         call VS_WR_REG
08A4   0008           00256         return          
                      00257 ;**********************************************************
08A5                  00258 WAIT_FOR_VSDREQ
08A5   1E05           00259         btfss MP3_DREQ
08A6   28A5           00260         goto WAIT_FOR_VSDREQ
08A7   0008           00261         return
                      00262 ;**********************************************************
08A8                  00263 VS_END_BEEP
08A8   20A5           00264         call WAIT_FOR_VSDREQ
                      00265 
08A9   3045           00266         movlw h'45'
08AA   2000           00267         call VS_WR_BYTE
08AB   3078           00268         movlw h'78'
08AC   2000           00269         call VS_WR_BYTE
08AD   3069           00270         movlw h'69'
08AE   2000           00271         call VS_WR_BYTE
08AF   3074           00272         movlw h'74'                     ; odeslanim tohoto kodu sinusovku ukoncime...
08B0   2000           00273         call VS_WR_BYTE
08B1   3000           00274         movlw .0
08B2   2000           00275         call VS_WR_BYTE
08B3   3000           00276         movlw .0
08B4   2000           00277         call VS_WR_BYTE
08B5   3000           00278         movlw .0
08B6   2000           00279         call VS_WR_BYTE
08B7   3000           00280         movlw .0
08B8   2000           00281         call VS_WR_BYTE
                      00282 
08B9   0008           00283         return
                      00284 ;**********************************************************
08BA                  00285 VS_BEEP
08BA   2079           00286         call VS_SOFT_RESET
08BB   20A5           00287         call WAIT_FOR_VSDREQ
                      00288 
08BC   1585           00289         bsf MP3_CS                      ; po SI posilam data
08BD   3053           00290         movlw h'53'
08BE   2000           00291         call VS_WR_BYTE
08BF   30EF           00292         movlw h'EF'
08C0   2000           00293         call VS_WR_BYTE
08C1   306E           00294         movlw h'6E'
08C2   2000           00295         call VS_WR_BYTE
08C3   303E           00296         movlw .62                       ; ctyr bytova testovaci sekvence. Tento posledni byte znamena, 
08C4   2000           00297         call VS_WR_BYTE         ; ze s pouzitim vzorkovaci frekvence 16kHz bude generovan ton 1kHz
08C5   3000           00298         movlw .0
08C6   2000           00299         call VS_WR_BYTE
08C7   3000           00300         movlw .0
08C8   2000           00301         call VS_WR_BYTE
08C9   3000           00302         movlw .0
08CA   2000           00303         call VS_WR_BYTE
08CB   3000           00304         movlw .0                        ; testovaci kod musi byt nasledovan 4 nulamy
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE 64


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

08CC   2000           00305         call VS_WR_BYTE
                      00306 
08CD   0008           00307         return
                      00308 ;**********************************************************
08CE                  00309 VS_INIT
08CE   01CD           00310         clrf VSREG_MODE_L
08CF   01CE           00311         clrf VSREG_STATUS_L
08D0   3040           00312         movlw h'40'
08D1   00CF           00313         movwf VSREG_VOL_L               ; VOL=0x40 => nenastavuji maximalni hlasitost, protoze kdyz jsou
                             pripojena sluchatka, tak by z toho jeden ohluchl...
08D2   00D0           00314         movwf VSREG_VOL_H
                      00315 
08D3   2079           00316         call VS_SOFT_RESET              ; resetujeme
                      00317         
08D4   3003           00318         movlw .3
08D5   00BA           00319         movwf TEMP5
08D6   209D           00320         call VS_SET_VOLUME              ; nastavime hlasitost
08D7   20BA           00321         call VS_BEEP
08D8   0BBA           00322         decfsz TEMP5,f
08D9   28D6           00323         goto $-3
                      00324         ; asi proto, ze nemam osetreny hardwarovy reset dekoderu, se mu obcas nechce nastartovat....
                      00325         ; proto jej 5x za sebou resetuji a zapinam pokusnou sinusovku...
                      00326         
08DA   20A8           00327         call VS_END_BEEP
08DB   2079           00328         call VS_SOFT_RESET              ; resetujeme
                      00329 
08DC   0008           00330         return
                      00331 ;**********************************************************
                      00060 ;#ENDIF
                      00061         include "commands.asm"  ; podprogramy na obsluhu prikazu (od ridiciho procesoru)
                      00001 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
                      00002 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
                      00003 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
                      00004 ; tady jsou procedury resici jednotlive prikazy
                      00005 ; Pokud je v zasobniku prikaz pro nejakou proceduru, musi tato procedura nastavit byt STAV_PRIKAZU do 1 
                            (i kdyz treba nema vsechny parametry)
                      00006 ; Pokud procedura najde svuj prikaz a jsou prijate vsechny parametry, musi odeslat nejakou odpoved po US
                            ARTu a smazat reg. PRIJATYCH_DAT!!!
                      00007 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
08DD                  00008 CEKEJ_PRIKAZ                                    ; ceka dokud nedostaneme nejaky prikaz
08DD   0873           00009         movfw PRIJATYCH_DAT
08DE   39FF           00010         andlw h'FF'
08DF   1903           00011         btfsc STATUS,Z                          ; koukneme se zda prisel nejaky prikaz...
08E0   28DD           00012         goto CEKEJ_PRIKAZ
08E1   0008           00013         return
                      00014 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
08E2                  00015 PRIKAZ_02h                                              ; 02h - vrat oddily se systemem FAT32
08E2   0878           00016         movfw 0x078                                     ; prvni byte zasobniku prikazu
08E3   3C02           00017         sublw h'02'                                     
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE 65


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

08E4   1D03           00018         btfss STATUS,Z
08E5   0008           00019         return                                          ; nebyl prijat prikaz 02h
08E6   1475           00020         bsf STAV_PRIKAZU,0                      ; mame tu prikaz 02h, nastavime byt STAV_REGISTRU
08E7   0873           00021         movfw PRIJATYCH_DAT
08E8   3C01           00022         sublw .1                                        ; pro prikaz 02h museji prijit 2 byty (prikaz + 
                            1 parametr)
08E9   1803           00023         btfsc STATUS,C
08EA   0008           00024         return                                          ; jeste nemame vsechny parametry
                      00025         ; Prisel prikaz 02h s jednim parametrem (vrat oddily se systemem FAT32)
                      00026 
08EB   0879           00027         movfw 0x079                                     ; parametr prikazu 02h (cislo svazku, jehoz para
                            metry chceme vratit)
08EC   3903           00028         andlw b'00000011'                       ; parametr musi byt v rozsahu 0-3
08ED   00B6           00029         movwf TEMP1
08EE   1003           00030         bcf STATUS,C
08EF   0DB6           00031         rlf TEMP1,F
08F0   0DB6           00032         rlf TEMP1,F
08F1   0DB6           00033         rlf TEMP1,F
08F2   0D36           00034         rlf TEMP1,W                                     ; parametr vynasobime 16
08F3   3E10           00035         addlw 0x10                                      ; buffer 2 je v bance 2 na adrese 0x10
08F4   0084           00036         movwf FSR
                      00037         INDF_BANK_2
08F5   1783               M                         bsf STATUS,IRP    
08F6   3010           00038         movlw .16                                       ; budeme odesilat 16 bytu
08F7   00B6           00039         movwf TEMP1
08F8                  00040 PRIKAZ_02h__ODESILANI_ODDILU
08F8   0800           00041         movfw INDF
                      00042         PROG_PAGE_0
08F9   118A               M                         bcf PCLATH,3
08FA   120A               M                         bcf PCLATH,4
08FB   20E1           00043         call WR_USART
                      00044         PROG_PAGE_1
08FC   158A               M                         bsf PCLATH,3
08FD   120A               M                         bcf PCLATH,4
08FE   0A84           00045         incf FSR,F
08FF   0BB6           00046         decfsz TEMP1,F
0900   28F8           00047         goto PRIKAZ_02h__ODESILANI_ODDILU
0901   01F3           00048         clrf PRIJATYCH_DAT
0902   0008           00049         return
                      00050 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
0903                  00051 PRIKAZ_03h                                              ; 03h  nastav oddil
0903   0878           00052         movfw 0x078                                     ; prvni byte zasobniku prikazu
0904   3C03           00053         sublw h'03'                                     
0905   1D03           00054         btfss STATUS,Z
0906   0008           00055         return                                          ; nebyl prijat prikaz 03h
0907   1475           00056         bsf STAV_PRIKAZU,0                      ; mame tu prikaz 03h, nastavime byt STAV_REGISTRU
0908   0873           00057         movfw PRIJATYCH_DAT
0909   3C04           00058         sublw .4                                        ; pro prikaz 03h museji prijit 5 byty (prikaz + 
                            4byty parametr)
090A   1803           00059         btfsc STATUS,C
090B   0008           00060         return                                          ; jeste nemame vsechny parametry
                      00061         ; Prisel prikaz 03h s 4bytovym parametrem (nacti oddily se systemem FAT32)
                      00062 
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE 66


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

090C   0879           00063         movfw 0x079                                     ; parametrem prikazu 03h ma byt 4bytova adresa z
                            acatku svazku, ktery se ma nacist
090D   00A7           00064         movwf LBA1
090E   087A           00065         movfw 0x07A
090F   00A8           00066         movwf LBA2
0910   087B           00067         movfw 0x07B
0911   00A9           00068         movwf LBA3
0912   087C           00069         movfw 0x07C
0913   00AA           00070         movwf LBA4
                      00071         PROG_PAGE_0
0914   118A               M                         bcf PCLATH,3
0915   120A               M                         bcf PCLATH,4
0916   236A           00072         call NACTI_FAT32                        ; nacte parametry zvoleneho oddilu
                      00073         PROG_PAGE_1
0917   158A               M                         bsf PCLATH,3
0918   120A               M                         bcf PCLATH,4
                      00074 
0919   082E           00075         movfw ATA_ATTRIBUTES
                      00076         PROG_PAGE_0
091A   118A               M                         bcf PCLATH,3
091B   120A               M                         bcf PCLATH,4
091C   20E1           00077         call WR_USART
                      00078         PROG_PAGE_1
091D   158A               M                         bsf PCLATH,3
091E   120A               M                         bcf PCLATH,4
091F   01F3           00079         clrf PRIJATYCH_DAT                      ; vyprazdnime zasobnik
0920   0008           00080         return
                      00081 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
0921                  00082 PRIKAZ_04h                                              ; 04h  vrat velikost clusteru
0921   0878           00083         movfw 0x078                                     ; prvni byte zasobniku prikazu
0922   3C04           00084         sublw h'04'                                     
0923   1D03           00085         btfss STATUS,Z
0924   0008           00086         return                                          ; nebyl prijat prikaz 04h
0925   1475           00087         bsf STAV_PRIKAZU,0                      ; mame tu prikaz 04h, nastavime byt STAV_REGISTRU
                      00088         ; pro prikaz 04h nejsou definovany zadne parametry, proto jiz nic jineho netestujeme
                      00089 
0926   084C           00090         movfw CLUSTER_SIZE
                      00091         PROG_PAGE_0
0927   118A               M                         bcf PCLATH,3
0928   120A               M                         bcf PCLATH,4
0929   20E1           00092         call WR_USART
                      00093         PROG_PAGE_1
092A   158A               M                         bsf PCLATH,3
092B   120A               M                         bcf PCLATH,4
092C   01F3           00094         clrf PRIJATYCH_DAT                      ; vyprazdnime zasobnik
092D   0008           00095         return
                      00096 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
092E                  00097 PRIKAZ_05h                                              ; 05h  vrat jmeno a adresu souboru
092E   0878           00098         movfw 0x078                                     ; prvni byte zasobniku prikazu
092F   3C05           00099         sublw h'05'                                     
0930   1D03           00100         btfss STATUS,Z
0931   0008           00101         return                                          ; nebyl prijat prikaz 05h
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE 67


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0932   1475           00102         bsf STAV_PRIKAZU,0                      ; mame tu prikaz 05h, nastavime byt STAV_REGISTRU
0933   0873           00103         movfw PRIJATYCH_DAT
0934   3C06           00104         sublw .6                                        ; pro prikaz 05h museji prijit 7 bytu (prikaz + 
                            6byty parametr)
0935   1803           00105         btfsc STATUS,C
0936   0008           00106         return                                          ; jeste nemame vsechny parametry
                      00107         ; Prisel prikaz 05h s 6bytovym parametrem 
                      00108 
0937   087D           00109         movfw 0x07D                                     ; 5. parametr prikazu (cast adresare) Muze byt v
                             rozsahu 0..[CLUSTER_SIZE -1]
0938   00BB           00110         movwf POZICE
0939   024C           00111         subwf CLUSTER_SIZE,W            ; W := CLUSTER_SIZE - [sektor v clusteru]
                      00112                                                                 ; pokud W <= 0 tak je 5. parametr mimo r
                            ozsah. Prvni byte odpovedi bude 80h
093A   1903           00113         btfsc STATUS,Z                          ; pokud neni vysledek nula...
093B   2944           00114         goto PRIKAZ_05h__PAR_OK         ; ...je parametr OK
093C   1803           00115         btfsc STATUS,C                          ; Pokud neni vysledek zaporny...
093D   2944           00116         goto PRIKAZ_05h__PAR_OK         ; ...je parametr OK
                      00117 
                      00118         ;Parametr byl zadan prilis velky (v jednom clusteru je CLUSTER_SIZE * 16 zaznamu)
093E                  00119 PRIKAZ_05h__PAR_NOT_OK
                      00120         INDF_BANK_2
093E   1783               M                         bsf STATUS,IRP    
093F   3010           00121         movlw 0x10                                      ; 1. byte bufferu 2
0940   0084           00122         movwf FSR
0941   3080           00123         movlw h'80'                                     ; jako prvni byte odpovedi dame 80h (parametr by
                            l prilis velky)
0942   0080           00124         movwf INDF
0943   2969           00125         goto PRIKAZ_05h__KONEC
0944                  00126 PRIKAZ_05h__PAR_OK      
                      00127         ; Parametr "castClusteru" byl zadan spravne, jdem se podivat zda parametr "CisloZaznamu" je v ro
                            zsahu 0..15
0944   087E           00128         movfw 0x07E                                     ; kolikaty zaznam v casti adersare (sektoru) mam
                            e precist
0945   39F0           00129         andlw b'11110000'
0946   1D03           00130         btfss STATUS,Z                          ; pokud je parametr vetsi jak 15...
0947   293E           00131         goto PRIKAZ_05h__PAR_NOT_OK     ; ...tak odesleme jako prvni byte odpovedi 80h
                      00132 
                      00133         ; Jdem precist sektor clusteru, v kterem se nachazi pozadovany zaznam. Cislo tohoto sektoru (off
                            set v clusteru) mame v POZICE.
0948   0879           00134         movfw 0x079                                     ; nejnizsi cast clusteru adresare
0949   00BC           00135         movwf CLUSTER1
094A   087A           00136         movfw 0x07A
094B   00BD           00137         movwf CLUSTER2
094C   087B           00138         movfw 0x07B
094D   00BE           00139         movwf CLUSTER3
094E   087C           00140         movfw 0x07C
094F   00BF           00141         movwf CLUSTER4
                      00142         PROG_PAGE_0
0950   118A               M                         bcf PCLATH,3
0951   120A               M                         bcf PCLATH,4
0952   242E           00143         call CLUSTER_TO_LBA                     ; zjistime si skutecnou polohu zaznamu na disku
0953   3001           00144         movlw .1
0954   00A6           00145         movwf SECTOR_C
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE 68


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0955   2210           00146         call READ_SECTOR                        ; dame prikaz jej precist
                      00147         PROG_PAGE_1
0956   158A               M                         bsf PCLATH,3
0957   120A               M                         bcf PCLATH,4
                      00148 
0958   087E           00149         movfw 0x07E                                     ; kolikaty zaznam v casti adersare (sektoru) mam
                            e precist
0959   390F           00150         andlw b'00001111'
095A   00B6           00151         movwf TEMP1                                     ; rozsah by mel byt spravne, pro jistotu jej ale
                             orizneme [0..15]
095B   39FF           00152         andlw h'FF'
095C   1903           00153         btfsc STATUS,Z                          ; pokud chceme prvni soubor ze sektoru...
095D   2964           00154         goto PRIKAZ_05h__MAME_SOUBOR    ; ...skocime rovnou na jeho cteni.
                      00155 
095E   0EB6           00156         swapf TEMP1,F                           ; protoze kazdy zaznam o souboru ma 32B=16slov, tak musi
                            me TEMP1 vynasobit 16...
                      00157         PROG_PAGE_0
095F   118A               M                         bcf PCLATH,3
0960   120A               M                         bcf PCLATH,4
0961   21D3           00158         call PRESKOC                            ; a tolik slov preskocit (tolik slov je pro nas nepotreb
                            nych)
                      00159         PROG_PAGE_1
0962   158A               M                         bsf PCLATH,3
0963   120A               M                         bcf PCLATH,4
0964                  00160 PRIKAZ_05h__MAME_SOUBOR
                      00161         PROG_PAGE_0
0964   118A               M                         bcf PCLATH,3
0965   120A               M                         bcf PCLATH,4
0966   2515           00162         call FILE_INFO
                      00163         PROG_PAGE_1
0967   158A               M                         bsf PCLATH,3
0968   120A               M                         bcf PCLATH,4
0969                  00164 PRIKAZ_05h__KONEC
                      00165         ; At uz bylo v zaznamu cokoli, odesleme 16 bytu z BUFFERU 2
                      00166 
0969   3010           00167         movlw .16
096A   00B6           00168         movwf TEMP1
                      00169         PROG_PAGE_0
096B   118A               M                         bcf PCLATH,3
096C   120A               M                         bcf PCLATH,4
096D   210D           00170         call ODESLI_BUFFER2                     ; odesleme si zaznam o souboru  
                      00171         PROG_PAGE_1
096E   158A               M                         bsf PCLATH,3
096F   120A               M                         bcf PCLATH,4
                      00172 
0970   01F3           00173         clrf PRIJATYCH_DAT                      ; vyprazdnime zasobnik prikazu
0971   0008           00174         return
                      00175 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
0972                  00176 PRIKAZ_06h                                              ; 06h  vrat cislo dalsiho clusteru v alokacnim 
                            retezu
0972   0878           00177         movfw 0x078                                     ; prvni byte zasobniku prikazu
0973   3C06           00178         sublw h'06'                                     
0974   1D03           00179         btfss STATUS,Z
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE 69


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0975   0008           00180         return                                          ; nebyl prijat prikaz 06h
0976   1475           00181         bsf STAV_PRIKAZU,0                      ; mame tu prikaz 06h, nastavime byt STAV_REGISTRU
0977   0873           00182         movfw PRIJATYCH_DAT
0978   3C04           00183         sublw .4                                        ; pro prikaz 06h museji prijit 5 bytu (prikaz + 
                            4byty parametr)
0979   1803           00184         btfsc STATUS,C
097A   0008           00185         return                                          ; jeste nemame vsechny parametry
                      00186         ; Prisel prikaz 06h s 4bytovym parametrem 
                      00187 
097B   0879           00188         movfw 0x079                                     ; nejnizsi cast clusteru
097C   00BC           00189         movwf CLUSTER1
097D   087A           00190         movfw 0x07A
097E   00BD           00191         movwf CLUSTER2
097F   087B           00192         movfw 0x07B
0980   00BE           00193         movwf CLUSTER3
0981   087C           00194         movfw 0x07C
0982   00BF           00195         movwf CLUSTER4
                      00196         PROG_PAGE_0
0983   118A               M                         bcf PCLATH,3
0984   120A               M                         bcf PCLATH,4
0985   248D           00197         call NEXT_CLUSTER
0986   083B           00198         movfw POZICE                            ; pokud POZICE = 00h, je vse v poradku (vratime c. dalsi
                            ho clusteru v retezci). 
                      00199                                                                 ; Pokud POZICE = FFh byl predany cluster
                             posledni v retezu, nebo byl prazdny...
0987   20E1           00200         call WR_USART
0988   083C           00201         movfw CLUSTER1
0989   20E1           00202         call WR_USART
098A   083D           00203         movfw CLUSTER2
098B   20E1           00204         call WR_USART
098C   083E           00205         movfw CLUSTER3
098D   20E1           00206         call WR_USART
098E   083F           00207         movfw CLUSTER4
098F   20E1           00208         call WR_USART
                      00209         PROG_PAGE_1
0990   158A               M                         bsf PCLATH,3
0991   120A               M                         bcf PCLATH,4
                      00210         
0992   01F3           00211         clrf PRIJATYCH_DAT                      ; vyprazdnime zasobnik prikazu
0993   0008           00212         return
                      00213 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
0994                  00214 PRIKAZ_07h                                              ; 07h  cti cluster
0994   0878           00215         movfw 0x078                                     ; prvni byte zasobniku prikazu
0995   3C07           00216         sublw h'07'                                     
0996   1D03           00217         btfss STATUS,Z
0997   0008           00218         return                                          ; nebyl prijat prikaz 07h
0998   1475           00219         bsf STAV_PRIKAZU,0                      ; mame tu prikaz 07h, nastavime byt STAV_REGISTRU
0999   0873           00220         movfw PRIJATYCH_DAT
099A   3C04           00221         sublw .4                                        ; pro prikaz 07h museji prijit 5 bytu (prikaz + 
                            4byty parametr)
099B   1803           00222         btfsc STATUS,C
099C   0008           00223         return                                          ; jeste nemame vsechny parametry
                      00224         ; Prisel prikaz 06h s 4bytovym parametrem 
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE 70


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00225 
099D   0879           00226         movfw 0x079                                     ; nejnizsi cast clusteru
099E   00BC           00227         movwf CLUSTER1
099F   087A           00228         movfw 0x07A
09A0   00BD           00229         movwf CLUSTER2
09A1   087B           00230         movfw 0x07B
09A2   00BE           00231         movwf CLUSTER3
09A3   087C           00232         movfw 0x07C
09A4   00BF           00233         movwf CLUSTER4
09A5   01BB           00234         clrf POZICE
                      00235         PROG_PAGE_0
09A6   118A               M                         bcf PCLATH,3
09A7   120A               M                         bcf PCLATH,4
09A8   242E           00236         call CLUSTER_TO_LBA                     ; zjistime si skutecnou polohu pozadovaneho clusteru na 
                            disku...
09A9   084C           00237         movfw CLUSTER_SIZE
09AA   00A6           00238         movwf SECTOR_C                          ; tentokrat cteme cely cluster a ne sector
09AB   2210           00239         call READ_SECTOR;S
                      00240         PROG_PAGE_1
09AC   158A               M                         bsf PCLATH,3
09AD   120A               M                         bcf PCLATH,4
                      00241 
09AE   084C           00242         movfw CLUSTER_SIZE
09AF   00B7           00243         movwf TEMP2                                     ; kolik sektoru budeme odesilat
                      00244 
09B0                  00245 PRIKAZ_07h__ODESLI_SECTOR
09B0   3000           00246         movlw .0                                        ; budeme odesilat cely sector (256slov = 512bytu
                            )
09B1   00B6           00247         movwf TEMP1
                      00248         PROG_PAGE_0
09B2   118A               M                         bcf PCLATH,3
09B3   120A               M                         bcf PCLATH,4
09B4   20F4           00249         call ODESLI_DATA
                      00250         PROG_PAGE_1
09B5   158A               M                         bsf PCLATH,3
09B6   120A               M                         bcf PCLATH,4
09B7   0BB7           00251         decfsz TEMP2,F                          ; a to tolikrat, kolik ma cluster sektroru
09B8   29B0           00252         goto PRIKAZ_07h__ODESLI_SECTOR
                      00253         
09B9   01F3           00254         clrf PRIJATYCH_DAT                      ; vyprazdnime zasobnik prikazu
09BA   0008           00255         return
                      00256 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
09BB                  00257 PRIKAZ_08h                                              ; 08h  vrat velikost souboru
09BB   0878           00258         movfw 0x078                                     ; prvni byte zasobniku prikazu
09BC   3C08           00259         sublw h'08'                                     
09BD   1D03           00260         btfss STATUS,Z
09BE   0008           00261         return                                          ; nebyl prijat prikaz 08h
09BF   1475           00262         bsf STAV_PRIKAZU,0                      ; mame tu prikaz 08h, nastavime byt STAV_REGISTRU
09C0   0873           00263         movfw PRIJATYCH_DAT
09C1   3C06           00264         sublw .6                                        ; pro prikaz 08h museji prijit 7 bytu (prikaz + 
                            6byty parametr)
09C2   1803           00265         btfsc STATUS,C
09C3   0008           00266         return                                          ; jeste nemame vsechny parametry
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE 71


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00267         ; Prisel prikaz 08h s 6bytovym parametrem 
                      00268 
09C4   087D           00269         movfw 0x07D                                     ; 5. parametr prikazu (cast adresare) Muze byt v
                             rozsahu 0..[CLUSTER_SIZE -1]
09C5   00BB           00270         movwf POZICE
09C6   024C           00271         subwf CLUSTER_SIZE,W            ; W := CLUSTER_SIZE - [sektor v clusteru]
                      00272                                                                 ; pokud W <= 0 tak je 5. parametr mimo r
                            ozsah. Prvni byte odpovedi bude 80h
09C7   1903           00273         btfsc STATUS,Z                          ; pokud neni vysledek nula...
09C8   29CE           00274         goto PRIKAZ_08h__PAR_OK         ; ...je parametr OK
09C9   1803           00275         btfsc STATUS,C                          ; Pokud neni vysledek zaporny...
09CA   29CE           00276         goto PRIKAZ_08h__PAR_OK         ; ...je parametr OK
                      00277 
                      00278         ;Parametr byl zadan prilis velky (v jednom clusteru je CLUSTER_SIZE * 16 zaznamu)
09CB                  00279 PRIKAZ_08h__PAR_NOT_OK
09CB   3080           00280         movlw h'80'                                     ; jako prvni byte odpovedi dame 80h (parametr by
                            l prilis velky)
09CC   00B7           00281         movwf TEMP2
09CD   29F5           00282         goto PRIKAZ_08h__KONEC
09CE                  00283 PRIKAZ_08h__PAR_OK      
                      00284         ; Parametr "castClusteru" byl zadan spravne, jdem se podivat zda parametr "CisloZaznamu" je v ro
                            zsahu 0..15
09CE   087E           00285         movfw 0x07E                                     ; kolikaty zaznam v casti adersare (sektoru) mam
                            e precist
09CF   39F0           00286         andlw b'11110000'
09D0   1D03           00287         btfss STATUS,Z                          ; pokud je parametr vetsi jak 15...
09D1   29CB           00288         goto PRIKAZ_08h__PAR_NOT_OK     ; ...tak odesleme jako prvni byte odpovedi 80h
                      00289 
                      00290         ; Jdem precist sektor clusteru, v kterem se nachazi pozadovany zaznam. Cislo tohoto sektoru (off
                            set v clusteru) mame v POZICE.
09D2   0879           00291         movfw 0x079                                     ; nejnizsi cast clusteru adresare
09D3   00BC           00292         movwf CLUSTER1
09D4   087A           00293         movfw 0x07A
09D5   00BD           00294         movwf CLUSTER2
09D6   087B           00295         movfw 0x07B
09D7   00BE           00296         movwf CLUSTER3
09D8   087C           00297         movfw 0x07C
09D9   00BF           00298         movwf CLUSTER4
                      00299         PROG_PAGE_0
09DA   118A               M                         bcf PCLATH,3
09DB   120A               M                         bcf PCLATH,4
09DC   242E           00300         call CLUSTER_TO_LBA                     ; zjistime si skutecnou polohu zaznamu na disku
09DD   3001           00301         movlw .1
09DE   00A6           00302         movwf SECTOR_C
09DF   2210           00303         call READ_SECTOR                        ; dame prikaz jej precist
                      00304         PROG_PAGE_1
09E0   158A               M                         bsf PCLATH,3
09E1   120A               M                         bcf PCLATH,4
                      00305 
09E2   087E           00306         movfw 0x07E                                     ; kolikaty zaznam v casti adersare (sektoru) mam
                            e precist
09E3   390F           00307         andlw b'00001111'
09E4   00B6           00308         movwf TEMP1                                     ; rozsah by mel byt spravne, pro jistotu jej ale
                             orizneme [0..15]
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE 72


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

09E5   39FF           00309         andlw h'FF'
09E6   1903           00310         btfsc STATUS,Z                          ; pokud chceme prvni soubor ze sektoru...
09E7   29EE           00311         goto PRIKAZ_08h__MAME_SOUBOR    ; ...skocime rovnou na jeho cteni.
                      00312 
09E8   0EB6           00313         swapf TEMP1,F                           ; protoze kazdy zaznam o souboru ma 32B=16slov, tak musi
                            me TEMP1 vynasobit 16...
                      00314         PROG_PAGE_0
09E9   118A               M                         bcf PCLATH,3
09EA   120A               M                         bcf PCLATH,4
09EB   21D3           00315         call PRESKOC                            ; a tolik slov preskocit (tolik slov je pro nas nepotreb
                            nych)
                      00316         PROG_PAGE_1
09EC   158A               M                         bsf PCLATH,3
09ED   120A               M                         bcf PCLATH,4
09EE                  00317 PRIKAZ_08h__MAME_SOUBOR
09EE   3000           00318         movlw h'00'                                     ; jako prvni byte odpovedi dame 00h -> spravne p
                            arametry
09EF   00B7           00319         movwf TEMP2
                      00320         PROG_PAGE_0
09F0   118A               M                         bcf PCLATH,3
09F1   120A               M                         bcf PCLATH,4
09F2   256D           00321         call FILE_SIZE
                      00322         PROG_PAGE_1
09F3   158A               M                         bsf PCLATH,3
09F4   120A               M                         bcf PCLATH,4
09F5                  00323 PRIKAZ_08h__KONEC
09F5   0837           00324         movfw TEMP2
                      00325         PROG_PAGE_0
09F6   118A               M                         bcf PCLATH,3
09F7   120A               M                         bcf PCLATH,4
09F8   20E1           00326         call WR_USART                           ; signalizace stavu odpovedi
                      00327         PROG_PAGE_1
09F9   158A               M                         bsf PCLATH,3
09FA   120A               M                         bcf PCLATH,4
                      00328 
09FB   3004           00329         movlw .4
09FC   00B6           00330         movwf TEMP1
                      00331         PROG_PAGE_0
09FD   118A               M                         bcf PCLATH,3
09FE   120A               M                         bcf PCLATH,4
09FF   210D           00332         call ODESLI_BUFFER2                     ; odesleme si velikost souboru
                      00333         PROG_PAGE_1
0A00   158A               M                         bsf PCLATH,3
0A01   120A               M                         bcf PCLATH,4
                      00334 
0A02   01F3           00335         clrf PRIJATYCH_DAT                      ; vyprazdnime zasobnik prikazu
0A03   0008           00336         return
                      00337 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
0A04                  00338 PRIKAZ_80h                                              ; 80h  hraj mp3 soubor
0A04   0878           00339         movfw 0x078                                     ; prvni byte zasobniku prikazu
0A05   3C80           00340         sublw h'80'
0A06   1D03           00341         btfss STATUS,Z
0A07   0008           00342         return                                          ; nebyl prijat prikaz 80h
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE 73


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0A08   1475           00343         bsf STAV_PRIKAZU,0                      ; mame tu prikaz 80h, nastavime byt STAV_REGISTRU
0A09   0873           00344         movfw PRIJATYCH_DAT
0A0A   3C06           00345         sublw .6                                        ; pro prikaz 80h museji prijit 7 bytu (prikaz + 
                            6byty parametr)
0A0B   1803           00346         btfsc STATUS,C
0A0C   0008           00347         return                                          ; jeste nemame vsechny parametry
                      00348         ; Prisel prikaz 08h s 6bytovym parametrem 
                      00349 
0A0D   087D           00350         movfw 0x07D                                     ; 5. parametr prikazu (cast adresare) Muze byt v
                             rozsahu 0..[CLUSTER_SIZE -1]
0A0E   00BB           00351         movwf POZICE
0A0F   024C           00352         subwf CLUSTER_SIZE,W            ; W := CLUSTER_SIZE - [sektor v clusteru]
                      00353                                                                 ; pokud W <= 0 tak je 5. parametr mimo r
                            ozsah. Prvni byte odpovedi bude 80h
0A10   1903           00354         btfsc STATUS,Z                          ; pokud neni vysledek nula...
0A11   2A1A           00355         goto PRIKAZ_80h__PAR_OK         ; ...je parametr OK
0A12   1803           00356         btfsc STATUS,C                          ; Pokud neni vysledek zaporny...
0A13   2A1A           00357         goto PRIKAZ_80h__PAR_OK         ; ...je parametr OK
                      00358 
                      00359         ;Parametr byl zadan prilis velky (v jednom clusteru je CLUSTER_SIZE * 16 zaznamu)
0A14                  00360 PRIKAZ_80h__PAR_NOT_OK
                      00361         INDF_BANK_2
0A14   1783               M                         bsf STATUS,IRP    
0A15   3010           00362         movlw 0x10                                      ; 1. byte bufferu 2
0A16   0084           00363         movwf FSR
0A17   3080           00364         movlw h'80'                                     ; jako prvni byte odpovedi dame 80h (parametr by
                            l prilis velky)
0A18   0080           00365         movwf INDF
0A19   2A5D           00366         goto PRIKAZ_80h__KONEC
0A1A                  00367 PRIKAZ_80h__PAR_OK      
                      00368         ; Parametr "castClusteru" byl zadan spravne, jdem se podivat zda parametr "CisloZaznamu" je v ro
                            zsahu 0..15
0A1A   087E           00369         movfw 0x07E                                     ; kolikaty zaznam v casti adersare (sektoru) mam
                            e precist
0A1B   39F0           00370         andlw b'11110000'
0A1C   1D03           00371         btfss STATUS,Z                          ; pokud je parametr vetsi jak 15...
0A1D   2A14           00372         goto PRIKAZ_80h__PAR_NOT_OK     ; ...tak odesleme jako prvni byte odpovedi 80h
                      00373 
                      00374         ; Jdem precist sektor clusteru, v kterem se nachazi pozadovany zaznam. Cislo tohoto sektoru (off
                            set v clusteru) mame v POZICE.
0A1E   0879           00375         movfw 0x079                                     ; nejnizsi cast clusteru adresare
0A1F   00BC           00376         movwf CLUSTER1
0A20   087A           00377         movfw 0x07A
0A21   00BD           00378         movwf CLUSTER2
0A22   087B           00379         movfw 0x07B
0A23   00BE           00380         movwf CLUSTER3
0A24   087C           00381         movfw 0x07C
0A25   00BF           00382         movwf CLUSTER4
                      00383         PROG_PAGE_0
0A26   118A               M                         bcf PCLATH,3
0A27   120A               M                         bcf PCLATH,4
0A28   242E           00384         call CLUSTER_TO_LBA                     ; zjistime si skutecnou polohu zaznamu na disku
0A29   3001           00385         movlw .1
0A2A   00A6           00386         movwf SECTOR_C
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE 74


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0A2B   2210           00387         call READ_SECTOR                        ; dame prikaz jej precist
                      00388         PROG_PAGE_1
0A2C   158A               M                         bsf PCLATH,3
0A2D   120A               M                         bcf PCLATH,4
                      00389 
0A2E   087E           00390         movfw 0x07E                                     ; kolikaty zaznam v casti adersare (sektoru) mam
                            e precist
0A2F   390F           00391         andlw b'00001111'
0A30   00B6           00392         movwf TEMP1                                     ; rozsah by mel byt spravne, pro jistotu jej ale
                             orizneme [0..15]
0A31   39FF           00393         andlw h'FF'
0A32   1903           00394         btfsc STATUS,Z                          ; pokud chceme prvni soubor ze sektoru...
0A33   2A38           00395         goto PRIKAZ_80h__MAME_SOUBOR    ; ...skocime rovnou na jeho cteni.
                      00396 
0A34   0EB6           00397         swapf TEMP1,F                           ; protoze kazdy zaznam o souboru ma 32B=16slov, tak musi
                            me TEMP1 vynasobit 16...
                      00398         PROG_PAGE_0
0A35   118A               M                         bcf PCLATH,3
0A36   120A               M                         bcf PCLATH,4
0A37   21D3           00399         call PRESKOC                            ; a tolik slov preskocit (tolik slov je pro nas nepotreb
                            nych)
0A38                  00400 PRIKAZ_80h__MAME_SOUBOR
                      00401         PROG_PAGE_0
0A38   118A               M                         bcf PCLATH,3
0A39   120A               M                         bcf PCLATH,4
0A3A   2515           00402         call FILE_INFO
                      00403         PROG_PAGE_1
0A3B   158A               M                         bsf PCLATH,3
0A3C   120A               M                         bcf PCLATH,4
                      00404 
                      00405         INDF_BANK_2
0A3D   1783               M                         bsf STATUS,IRP    
0A3E   3010           00406         movlw 0x10                                      ; 1. byte bufferu 2
0A3F   0084           00407         movwf FSR
0A40   0800           00408         movfw INDF
0A41   3C06           00409         sublw h'06'                                     ; pokud na zadanem miste se nachazi soubor s pri
                            ponou mp3...
0A42   1D03           00410         btfss STATUS,Z
0A43   2A5D           00411         goto PRIKAZ_80h__KONEC
                      00412                         
                      00413         ; ...nastavime jej jako prehravany soubor.
0A44   301C           00414         movlw 0x1C                                      ; 13. byte bufferu 2
0A45   0084           00415         movwf FSR
0A46   0800           00416         movfw INDF
0A47   00E6           00417         movwf PREH_DATA_CL1
0A48   0A84           00418         incf FSR,f
0A49   0800           00419         movfw INDF
0A4A   00E7           00420         movwf PREH_DATA_CL2
0A4B   0A84           00421         incf FSR,f
0A4C   0800           00422         movfw INDF
0A4D   00E8           00423         movwf PREH_DATA_CL3
0A4E   0A84           00424         incf FSR,f
0A4F   0800           00425         movfw INDF
0A50   00E9           00426         movwf PREH_DATA_CL4
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE 75


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00427         
0A51   01EA           00428         clrf PREH_DATA_POZICE
0A52   146B           00429         bsf PREH_STAV0,0
0A53   14EB           00430         bsf PREH_STAV0,1
                      00431 
0A54   10CD           00432         bcf VSREG_MODE_L,1                      ; prehravame normalni rychlosti 
0A55   105F           00433         bcf PREH_STAV1,0                        ; prehravame normalni rychlosti 
                      00434         
0A56   2079           00435         call VS_SOFT_RESET
                      00436 
0A57   3000           00437         movlw VSADDR_MODE
0A58   00B6           00438         movwf TEMP1
0A59   084D           00439         movfw VSREG_MODE_L
0A5A   00B7           00440         movwf TEMP2
0A5B   01B8           00441         clrf TEMP3
0A5C   2063           00442         call VS_WR_REG
                      00443 
0A5D                  00444 PRIKAZ_80h__KONEC
                      00445         INDF_BANK_2
0A5D   1783               M                         bsf STATUS,IRP    
0A5E   3010           00446         movlw 0x10                                      ; 1. byte bufferu 2
0A5F   0084           00447         movwf FSR
0A60   0800           00448         movfw INDF
                      00449         PROG_PAGE_0
0A61   118A               M                         bcf PCLATH,3
0A62   120A               M                         bcf PCLATH,4
0A63   20E1           00450         call WR_USART   
                      00451         PROG_PAGE_1
0A64   158A               M                         bsf PCLATH,3
0A65   120A               M                         bcf PCLATH,4
                      00452         
0A66   01F3           00453         clrf PRIJATYCH_DAT                      ; vyprazdnime zasobnik prikazu
0A67   0008           00454         return
                      00455 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
0A68                  00456 PRIKAZ_81h                                              ; 81h  vrat stav prehravaneho souboru
0A68   0878           00457         movfw 0x078                                     ; prvni byte zasobniku prikazu
0A69   3C81           00458         sublw h'81'
0A6A   1D03           00459         btfss STATUS,Z
0A6B   0008           00460         return                                          ; nebyl prijat prikaz 81h
0A6C   1475           00461         bsf STAV_PRIKAZU,0                      ; mame tu prikaz 81h, nastavime byt STAV_REGISTRU
                      00462         ; pro prikaz 81h nejsou definovany zadne parametry, proto jiz nic jineho netestujeme
                      00463 
0A6D   086B           00464         movfw PREH_STAV0
                      00465         PROG_PAGE_0
0A6E   118A               M                         bcf PCLATH,3
0A6F   120A               M                         bcf PCLATH,4
0A70   20E1           00466         call WR_USART
                      00467         PROG_PAGE_1
0A71   158A               M                         bsf PCLATH,3
0A72   120A               M                         bcf PCLATH,4
                      00468 
0A73   085F           00469         movfw PREH_STAV1
                      00470         PROG_PAGE_0
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE 76


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0A74   118A               M                         bcf PCLATH,3
0A75   120A               M                         bcf PCLATH,4
0A76   20E1           00471         call WR_USART
                      00472         PROG_PAGE_1
0A77   158A               M                         bsf PCLATH,3
0A78   120A               M                         bcf PCLATH,4
                      00473 
0A79   116B           00474         bcf PREH_STAV0,2                        ; 2. bit je nastaven, kdyz se zmeni prehravany soubor (b
                            ez volani prikazu) do doby, nez prijde prikaz na dotaz STAVU... (81h)
                      00475 
0A7A   3004           00476         movlw VSADDR_DECODE_TIME
0A7B   00B6           00477         movwf TEMP1
0A7C   206E           00478         call VS_RD_REG                          ; zjistime si aktualni pozici v souboru v sekundach
0A7D   0837           00479         movfw TEMP2
                      00480         PROG_PAGE_0
0A7E   118A               M                         bcf PCLATH,3
0A7F   120A               M                         bcf PCLATH,4
0A80   20E1           00481         call WR_USART
0A81   0838           00482         movfw TEMP3
0A82   20E1           00483         call WR_USART   
                      00484         PROG_PAGE_1
0A83   158A               M                         bsf PCLATH,3
0A84   120A               M                         bcf PCLATH,4
                      00485 
                      00486 ;       movlw VSADDR_STATUS
                      00487 ;       movwf TEMP1
                      00488 ;       call VS_RD_REG
                      00489 ;       movfw TEMP2
                      00490 ;       PROG_PAGE_0
                      00491 ;       call WR_USART
                      00492 ;       PROG_PAGE_1
                      00493 
0A85   01F3           00494         clrf PRIJATYCH_DAT                      ; vyprazdnime zasobnik
0A86   0008           00495         return
                      00496 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
0A87                  00497 PRIKAZ_82h                                              ; 82h  nastav hlasitost
0A87   0878           00498         movfw 0x078                                     ; prvni byte zasobniku prikazu
0A88   3C82           00499         sublw h'82'
0A89   1D03           00500         btfss STATUS,Z
0A8A   0008           00501         return                                          ; nebyl prijat prikaz 82h
0A8B   1475           00502         bsf STAV_PRIKAZU,0                      ; mame tu prikaz 82h, nastavime byt STAV_REGISTRU
0A8C   0873           00503         movfw PRIJATYCH_DAT
0A8D   3C02           00504         sublw .2                                        ; pro prikaz 82h museji prijit 3 byty (prikaz + 
                            2byty parametr)
0A8E   1803           00505         btfsc STATUS,C
0A8F   0008           00506         return                                          ; jeste nemame vsechny parametry
                      00507         ; Prisel prikaz 82h s 2bytovym parametrem 
                      00508 
0A90   0879           00509         movfw 0x079                                     ; hlasitost pro levy kanal
0A91   00D0           00510         movwf VSREG_VOL_H
0A92   087A           00511         movfw 0x07A                                     ; hlasitost pro pravy kanal
0A93   00CF           00512         movwf VSREG_VOL_L
0A94   209D           00513         call VS_SET_VOLUME                      ; nastavime hlasitost   
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE 77


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00514 
0A95   30FF           00515         movlw h'FF'
                      00516         PROG_PAGE_0
0A96   118A               M                         bcf PCLATH,3
0A97   120A               M                         bcf PCLATH,4
0A98   20E1           00517         call WR_USART
                      00518         PROG_PAGE_1
0A99   158A               M                         bsf PCLATH,3
0A9A   120A               M                         bcf PCLATH,4
0A9B   01F3           00519         clrf PRIJATYCH_DAT                      ; vyprazdnime zasobnik
0A9C   0008           00520         return
                      00521 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
0A9D                  00522 PRIKAZ_83h                                              ; 83h  vrat informace o prehravanem souboru
0A9D   0878           00523         movfw 0x078                                     ; prvni byte zasobniku prikazu
0A9E   3C83           00524         sublw h'83'
0A9F   1D03           00525         btfss STATUS,Z
0AA0   0008           00526         return                                          ; nebyl prijat prikaz 83h
0AA1   1475           00527         bsf STAV_PRIKAZU,0                      ; mame tu prikaz 83h, nastavime byt STAV_REGISTRU
                      00528         ; pro prikaz 83h nejsou definovane zadne parametry, proto jiz nic jineho netestujeme
                      00529 
0AA2   3005           00530         movlw VSADDR_AUDATA
0AA3   00B6           00531         movwf TEMP1
0AA4   206E           00532         call VS_RD_REG
0AA5   0837           00533         movfw TEMP2
                      00534         PROG_PAGE_0
0AA6   118A               M                         bcf PCLATH,3
0AA7   120A               M                         bcf PCLATH,4
0AA8   20E1           00535         call WR_USART
0AA9   0838           00536         movfw TEMP3
0AAA   20E1           00537         call WR_USART   
                      00538         PROG_PAGE_1
0AAB   158A               M                         bsf PCLATH,3
0AAC   120A               M                         bcf PCLATH,4
                      00539         ; odeslali jsme AUDATA
                      00540 
0AAD   3008           00541         movlw VSADDR_HDAT0
0AAE   00B6           00542         movwf TEMP1
0AAF   206E           00543         call VS_RD_REG
0AB0   0837           00544         movfw TEMP2
                      00545         PROG_PAGE_0
0AB1   118A               M                         bcf PCLATH,3
0AB2   120A               M                         bcf PCLATH,4
0AB3   20E1           00546         call WR_USART
0AB4   0838           00547         movfw TEMP3
0AB5   20E1           00548         call WR_USART   
                      00549         PROG_PAGE_1
0AB6   158A               M                         bsf PCLATH,3
0AB7   120A               M                         bcf PCLATH,4
                      00550         ; odeslali jsme HDAT0
                      00551 
0AB8   3009           00552         movlw VSADDR_HDAT1
0AB9   00B6           00553         movwf TEMP1
0ABA   206E           00554         call VS_RD_REG
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE 78


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0ABB   0837           00555         movfw TEMP2
                      00556         PROG_PAGE_0
0ABC   118A               M                         bcf PCLATH,3
0ABD   120A               M                         bcf PCLATH,4
0ABE   20E1           00557         call WR_USART
0ABF   0838           00558         movfw TEMP3
0AC0   20E1           00559         call WR_USART   
                      00560         PROG_PAGE_1
0AC1   158A               M                         bsf PCLATH,3
0AC2   120A               M                         bcf PCLATH,4
                      00561         ; odeslali jsme HDAT1
                      00562 
0AC3   01F3           00563         clrf PRIJATYCH_DAT                      ; vyprazdnime zasobnik
0AC4   0008           00564         return
                      00565 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
0AC5                  00566 PRIKAZ_84h                                              ; 84h  nastav stav prehravani
0AC5   0878           00567         movfw 0x078                                     ; prvni byte zasobniku prikazu
0AC6   3C84           00568         sublw h'84'
0AC7   1D03           00569         btfss STATUS,Z
0AC8   0008           00570         return                                          ; nebyl prijat prikaz 84h
0AC9   1475           00571         bsf STAV_PRIKAZU,0                      ; mame tu prikaz 84h, nastavime byt STAV_REGISTRU
0ACA   0873           00572         movfw PRIJATYCH_DAT
0ACB   3C02           00573         sublw .2                                        ; pro prikaz 8h museji prijit 3 byty (prikaz + 2
                            byty parametr)
0ACC   1803           00574         btfsc STATUS,C
0ACD   0008           00575         return                                          ; jeste nemame vsechny parametry
                      00576         ; Prisel prikaz 84h s 2bytovym parametrem 
                      00577 
0ACE   086B           00578         movfw PREH_STAV0
0ACF   3906           00579         andlw b'00000110'
0AD0   00EB           00580         movwf PREH_STAV0
0AD1   0879           00581         movfw 0x079                                     ; parametr 1
0AD2   39F9           00582         andlw b'11111001'                       ; nektere bity vymaskujeme (vsechny nelze ovladat prikaz
                            em)
0AD3   046B           00583         iorwf PREH_STAV0,w      
0AD4   00EB           00584         movwf PREH_STAV0
                      00585 
0AD5   087A           00586         movfw 0x07A                                     ; parametr 2
0AD6   00DF           00587         movwf PREH_STAV1
                      00588 
0AD7   10CD           00589         bcf VSREG_MODE_L,1                      ; prehravame normalni rychlosti (zda se mp3 prevyji je r
                            eseno v hlavni smycce podle stavu registru PREH_STAV1)
0AD8   13CD           00590         bcf VSREG_MODE_L,7                      ;bass/treble enhancer
0AD9   19DF           00591         btfsc PREH_STAV1,3                      ; 3. bit =      1 => zvyrazneni basu a vysek (moznost de
                            koderu vs1001 "bass/treble enhancer")
0ADA   17CD           00592         bsf VSREG_MODE_L,7                      ;bass/treble enhancer
                      00593         
0ADB   3000           00594         movlw VSADDR_MODE
0ADC   00B6           00595         movwf TEMP1
0ADD   084D           00596         movfw VSREG_MODE_L
0ADE   00B7           00597         movwf TEMP2
0ADF   01B8           00598         clrf TEMP3
0AE0   2063           00599         call VS_WR_REG
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE 79


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00600         
0AE1   3001           00601         movlw VSADDR_STATUS
0AE2   206E           00602         call VS_RD_REG
0AE3   0837           00603         movfw TEMP2
0AE4   00CE           00604         movwf VSREG_STATUS_L
                      00605 
0AE5   114E           00606         bcf VSREG_STATUS_L,2            ; Bit 2 is analog powerdown bit.
0AE6   1A5F           00607         btfsc PREH_STAV1,4                      ; 4. bit = 1 => MUTE
0AE7   154E           00608         bsf VSREG_STATUS_L,2            ; Bit 2 is analog powerdown bit.
                      00609         
0AE8   3001           00610         movlw VSADDR_STATUS
0AE9   00B6           00611         movwf TEMP1
0AEA   084E           00612         movfw VSREG_STATUS_L
0AEB   00B7           00613         movwf TEMP2
0AEC   01B8           00614         clrf TEMP3
0AED   2063           00615         call VS_WR_REG
                      00616 
                      00617         PROG_PAGE_0
0AEE   118A               M                         bcf PCLATH,3
0AEF   120A               M                         bcf PCLATH,4
0AF0   30FF           00618         movlw h'FF'
0AF1   20E1           00619         call WR_USART
                      00620         PROG_PAGE_1
0AF2   158A               M                         bsf PCLATH,3
0AF3   120A               M                         bcf PCLATH,4
0AF4   01DE           00621         clrf PREH_CITAC_PREV
0AF5   01F3           00622         clrf PRIJATYCH_DAT                      ; vyprazdnime zasobnik
0AF6   0008           00623         return
                      00624 ; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                            XXXXXXXXXXXXXXXXXXXXX
                      00062 ;**********************************************************
0000                  00063  org 0x0000
0000   2810           00064         goto START
0004                  00065  org 0x0004
0004   00F0           00066         movwf TEMP_WORKING
0005   0803           00067         movfw STATUS
0006   00F1           00068         movwf TEMP_STATUS
0007   0804           00069         movfw FSR
0008   00F2           00070         movwf TEMP_FSR
0009   080A           00071         movfw PCLATH
000A   00F6           00072         movwf TEMP_PCLATH
000B   018A           00073         clrf PCLATH
                      00074         BANK_0
000C   1303               M                 bcf     STATUS,RP1              ; BANK0  RP1:RP0 = 00
000D   1283               M                 bcf     STATUS,RP0    
                      00075         INDF_BANK_0
000E   1383               M                         bcf STATUS,IRP    
000F   2917           00076         goto INTERRUPT
                      00077 ;**********************************************************
                      00078         END
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE 80


SYMBOL TABLE
  LABEL                             VALUE 

ABRT                              00000002
ACKDT                             00000005
ACKEN                             00000004
ACKSTAT                           00000006
ADCON0                            0000001F
ADCON1                            0000009F
ADCS0                             00000006
ADCS1                             00000007
ADDEN                             00000003
ADFM                              00000007
ADIE                              00000006
ADIF                              00000006
ADON                              00000000
ADRESH                            0000001E
ADRESL                            0000009E
APPLICABLE                        00000007
ATA_ADDRESS                       00000007
ATA_ADDRESS_TRIS                  00000087
ATA_ATTRIBUTES                    0000002E
ATA_CONTROL                       00000009
ATA_CONTROL_TRIS                  00000089
ATA_DIOR_N                        ATA_CONTROL,2
ATA_DIOW_N                        ATA_CONTROL,1
ATA_ERROR                         00000025
ATA_OK                            00000000
ATA_RESET                         000001F5
ATA_RESET_N                       ATA_CONTROL,0
ATA_STATUS                        0000002C
ATA_STATUS_A                      00000022
BANK_0                            
BANK_1                            
BANK_2                            
BANK_3                            
BCLIE                             00000003
BCLIF                             00000003
BF                                00000000
BIG_LOOP                          0000003B
BIG_LOOP__NENI_PRIKAZ             00000050
BIG_SECTOR                        00000003
BRGH                              00000002
BSY                               00000007
C                                 00000000
CCP1CON                           00000017
CCP1IE                            00000002
CCP1IF                            00000002
CCP1M0                            00000000
CCP1M1                            00000001
CCP1M2                            00000002
CCP1M3                            00000003
CCP1X                             00000005
CCP1Y                             00000004
CCP2CON                           0000001D
CCP2IE                            00000000
CCP2IF                            00000000
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE 81


SYMBOL TABLE
  LABEL                             VALUE 

CCP2M0                            00000000
CCP2M1                            00000001
CCP2M2                            00000002
CCP2M3                            00000003
CCP2X                             00000005
CCP2Y                             00000004
CCPR1H                            00000016
CCPR1L                            00000015
CCPR2H                            0000001C
CCPR2L                            0000001B
CEKEJ_PRIKAZ                      000008DD
CEK_PRIKAZ_01h                    00000020
CEK_PRIKAZ_02h_03h                0000002E
CHS0                              00000003
CHS1                              00000004
CHS2                              00000005
CKE                               00000006
CKP                               00000004
CLEAR_BEFFER2__CLEAR              000001EF
CLEAR_BUFFER2                     000001E9
CLUSTER1                          0000003C
CLUSTER2                          0000003D
CLUSTER3                          0000003E
CLUSTER4                          0000003F
CLUSTER_SIZE                      0000004C
CLUSTER_TO_LBA                    0000042E
CLUSTER_TO_LBA_NO_ROOT            00000452
COMMAND                           0000002D
CREN                              00000004
CSRC                              00000007
D                                 00000005
DALSI_SKLADBA                     000000AF
DATA_ADDRESS                      00000005
DATA_H                            00000021
DATA_L                            00000020
DATA_PORT_HIGH                    00000008
DATA_PORT_HIGH_TRIS               00000088
DATA_PORT_LOW                     00000006
DATA_PORT_LOW_TRIS                00000086
DC                                00000001
DELAY_200ms                       00000136
DELAY_25us                        0000028F
DELAY_2ms                         0000012D
DELAY_500ms                       0000013F
DEVICE                            0000002B
DEVICE_C                          00000023
DRDY                              00000006
DRQ                               00000003
D_A                               00000005
D_COMMAND                         00000027
D_DATA_R                          00000020
D_DEVICE                          00000026
D_DEVICE_C                        00000016
D_ERROR                           00000021
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE 82


SYMBOL TABLE
  LABEL                             VALUE 

D_FEATURES                        00000021
D_LBA1                            00000023
D_LBA2                            00000024
D_LBA3                            00000025
D_SECTOR_C                        00000022
D_STATUS                          00000027
D_STATUS_A                        00000016
EEADR                             0000010D
EEADRH                            0000010F
EECON1                            0000018C
EECON2                            0000018D
EEDATA                            0000010C
EEDATH                            0000010E
EEIE                              00000004
EEIF                              00000004
EEPGD                             00000007
END_OF_INTERRUPT                  00000125
ERR                               00000000
ERROR_LED                         ATA_ADDRESS,3
F                                 00000001
FAT32_LOAD                        00000004
FEATURES                          00000024
FERR                              00000002
FILE_INFO                         00000515
FILE_INFO__DIR                    00000551
FILE_INFO__FILE                   00000553
FILE_INFO__KONEC                  0000056C
FILE_INFO__READ_NAME              0000051D
FILE_SIZE                         0000056D
FSR                               00000004
GCEN                              00000007
GIE                               00000007
GO                                00000002
GO_DONE                           00000002
HOB                               00000007
I2C_DATA                          00000005
I2C_READ                          00000002
I2C_START                         00000003
I2C_STOP                          00000004
IBF                               00000007
IBOV                              00000005
IDENTIFY_DEVICE                   0000023C
INDF                              00000000
INDF_BANK_0                       
INDF_BANK_1                       
INDF_BANK_2                       
INDF_BANK_3                       
INIT_ATA__DALSI                   0000027B
INIT_ATA__DALSI2                  00000285
INIT_ATA__NOT_SUPPORT_LBA48       00000278
INIT_CONFIG                       000000C6
INIT_PORT                         000000B3
INTCON                            0000000B
INTE                              00000004
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE 83


SYMBOL TABLE
  LABEL                             VALUE 

INTEDG                            00000006
INTERRUPT                         00000117
INTF                              00000001
IRP                               00000007
LBA1                              00000027
LBA2                              00000028
LBA3                              00000029
LBA4                              0000002A
LBA48_SUPPORT                     00000002
LBA_SUPPORT                       00000001
MP3_BSYNC                         MP3_PORT,5
MP3_CS                            MP3_PORT,3
MP3_DREQ                          MP3_PORT,4
MP3_NOT_PLAY                      000000AE
MP3_PORT                          00000005
MP3_PORT_TRIS                     00000085
MP3_REWIND_FORWARD                00000080
MP3_SCLK                          MP3_PORT,2
MP3_SI                            MP3_PORT,1
MP3_SO                            MP3_PORT,0
NACTI_FAT32                       0000036A
NACTI_FAT32__KONEC                0000042D
NEXT_CLUSTER                      0000048D
NEXT_CLUSTER_KONEC                00000512
NEXT_CLUSTER_NEPRAZDNY            000004FB
NEXT_CLUSTER_NO_ROOT              000004B1
NOT_A                             00000005
NOT_ADDRESS                       00000005
NOT_BO                            00000000
NOT_BOR                           00000000
NOT_DONE                          00000002
NOT_MP3_REWIND_FORWARD            0000008C
NOT_PD                            00000003
NOT_POR                           00000001
NOT_RBPU                          00000007
NOT_RC8                           00000006
NOT_T1SYNC                        00000002
NOT_TO                            00000004
NOT_TX8                           00000006
NOT_W                             00000002
NOT_WRITE                         00000002
NULA                              00000681
OBF                               00000006
ODESLI_BUFFER2                    0000010D
ODESLI_BUFFER2_ODESILANI          00000110
ODESLI_DATA                       000000F4
ODESLI_MODEL_NUMBER               000000FC
ODESLI_MODEL_NUMBER_ODESILANI     00000101
OERR                              00000001
OPERAND_X1                        000000A0
OPERAND_X2                        000000A1
OPERAND_X3                        000000A2
OPERAND_X4                        000000A3
OPERAND_Y1                        000000A4
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE 84


SYMBOL TABLE
  LABEL                             VALUE 

OPERAND_Y2                        000000A5
OPERAND_Y3                        000000A6
OPERAND_Y4                        000000A7
OPTION_REG                        00000081
P                                 00000004
PARAM_MAX_LBA1                    0000002F
PARAM_MAX_LBA2                    00000030
PARAM_MAX_LBA3                    00000031
PARAM_MAX_LBA4                    00000032
PARAM_SLOV_V_SEKTORU1             00000033
PARAM_SLOV_V_SEKTORU2             00000034
PCFG0                             00000000
PCFG1                             00000001
PCFG2                             00000002
PCFG3                             00000003
PCL                               00000002
PCLATH                            0000000A
PCON                              0000008E
PEIE                              00000006
PEN                               00000002
PIE1                              0000008C
PIE2                              0000008D
PIR1                              0000000C
PIR2                              0000000D
POCATEK_DAT1                      00000040
POCATEK_DAT2                      00000041
POCATEK_DAT3                      00000042
POCATEK_DAT4                      00000043
POCATEK_FAT1                      00000044
POCATEK_FAT2                      00000045
POCATEK_FAT3                      00000046
POCATEK_FAT4                      00000047
PORTA                             00000005
PORTB                             00000006
PORTC                             00000007
PORTD                             00000008
PORTE                             00000009
POSUNDOLEVA                       000005D4
POSUNDOLEVA_1                     000005DA
POSUNDOLEVA_2                     000005E2
POSUNDOLEVA_3                     000005EB
POSUNDOLEVA_4                     000005F5
POSUNDOLEVA_5                     00000600
POSUNDOLEVA_6                     0000060C
POSUNDOLEVA_7                     00000619
POSUNDOPRAVA                      00000627
POSUNDOPRAVA_1                    0000062D
POSUNDOPRAVA_2                    00000636
POSUNDOPRAVA_3                    00000640
POSUNDOPRAVA_4                    0000064B
POSUNDOPRAVA_5                    00000657
POSUNDOPRAVA_6                    00000664
POSUNDOPRAVA_7                    00000672
POZDRAV                           000000E9
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE 85


SYMBOL TABLE
  LABEL                             VALUE 

POZICE                            0000003B
PR2                               00000092
PREH_ADDR_CL1                     00000060
PREH_ADDR_CL2                     00000061
PREH_ADDR_CL3                     00000062
PREH_ADDR_CL4                     00000063
PREH_ADDR_POZICE                  00000064
PREH_ADDR_ZACATEK_CL1             0000006C
PREH_ADDR_ZACATEK_CL2             0000006D
PREH_ADDR_ZACATEK_CL3             0000006E
PREH_ADDR_ZACATEK_CL4             0000006F
PREH_ADDR_ZAZNAM                  00000065
PREH_CITAC_PREV                   0000005E
PREH_DATA_CL1                     00000066
PREH_DATA_CL2                     00000067
PREH_DATA_CL3                     00000068
PREH_DATA_CL4                     00000069
PREH_DATA_POZICE                  0000006A
PREH_STAV0                        0000006B
PREH_STAV1                        0000005F
PRESKOC                           000001D3
PRETECENI                         000000AC
PRIJATE_DATO                      00000074
PRIJATYCH_DAT                     00000073
PRIKAZ_02h                        000008E2
PRIKAZ_02h__ODESILANI_ODDILU      000008F8
PRIKAZ_03h                        00000903
PRIKAZ_04h                        00000921
PRIKAZ_05h                        0000092E
PRIKAZ_05h__KONEC                 00000969
PRIKAZ_05h__MAME_SOUBOR           00000964
PRIKAZ_05h__PAR_NOT_OK            0000093E
PRIKAZ_05h__PAR_OK                00000944
PRIKAZ_06h                        00000972
PRIKAZ_07h                        00000994
PRIKAZ_07h__ODESLI_SECTOR         000009B0
PRIKAZ_08h                        000009BB
PRIKAZ_08h__KONEC                 000009F5
PRIKAZ_08h__MAME_SOUBOR           000009EE
PRIKAZ_08h__PAR_NOT_OK            000009CB
PRIKAZ_08h__PAR_OK                000009CE
PRIKAZ_80h                        00000A04
PRIKAZ_80h__KONEC                 00000A5D
PRIKAZ_80h__MAME_SOUBOR           00000A38
PRIKAZ_80h__PAR_NOT_OK            00000A14
PRIKAZ_80h__PAR_OK                00000A1A
PRIKAZ_81h                        00000A68
PRIKAZ_82h                        00000A87
PRIKAZ_83h                        00000A9D
PRIKAZ_84h                        00000AC5
PROG_PAGE_0                       
PROG_PAGE_1                       
PROG_PAGE_2                       
PROG_PAGE_3                       
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE 86


SYMBOL TABLE
  LABEL                             VALUE 

PS0                               00000000
PS1                               00000001
PS2                               00000002
PSA                               00000003
PSPIE                             00000007
PSPIF                             00000007
PSPMODE                           00000004
R                                 00000002
RBIE                              00000003
RBIF                              00000000
RC8_9                             00000006
RC9                               00000006
RCD8                              00000000
RCEN                              00000003
RCIE                              00000005
RCIF                              00000005
RCREG                             0000001A
RCSTA                             00000018
RD                                00000000
RD_DEVICE                         00000168
RD_ERROR                          00000150
RD_LBA1                           0000015C
RD_LBA2                           00000160
RD_LBA3                           00000164
RD_SC                             00000158
RD_STATUS                         0000014C
RD_STATUS_A                       00000154
READ_DATA                         000001C0
READ_SECTOR                       00000210
READ_SECTOR_LBA27                 00000215
READ_SECTOR_LBA48                 00000224
READ_WRITE                        00000002
ROOT_DIR_CL1                      00000048
ROOT_DIR_CL2                      00000049
ROOT_DIR_CL3                      0000004A
ROOT_DIR_CL4                      0000004B
ROZDIL                            000005AB
RP0                               00000005
RP1                               00000006
RSEN                              00000001
RUTR                              0000019D
RUTW                              000001AA
RX9                               00000006
RX9D                              00000000
R_W                               00000002
S                                 00000003
SCAN_BR                           000002AD
SCAN_MBR                          000002A7
SCAN_MBR__HLEDEJ_ROZSIRENY_ODDIL  000002F6
SCAN_MBR__KONEC                   00000320
SECTOR_C                          00000026
SELECT_DEVICE                     000001D7
SEN                               00000000
SEND_MP3_DATA                     00000071
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE 87


SYMBOL TABLE
  LABEL                             VALUE 

SEND_MP3_WORD                     0000009D
SMP                               00000007
SOUCET                            00000582
SPBRG                             00000099
SPEN                              00000007
SREN                              00000005
SRST                              00000002
SSPADD                            00000093
SSPBUF                            00000013
SSPCON                            00000014
SSPCON2                           00000091
SSPEN                             00000005
SSPIE                             00000003
SSPIF                             00000003
SSPM0                             00000000
SSPM1                             00000001
SSPM2                             00000002
SSPM3                             00000003
SSPOV                             00000006
SSPSTAT                           00000094
START                             00000010
STATUS                            00000003
STAV_PRIKAZU                      00000075
SYNC                              00000004
T0CS                              00000005
T0IE                              00000005
T0IF                              00000002
T0SE                              00000004
T1CKPS0                           00000004
T1CKPS1                           00000005
T1CON                             00000010
T1INSYNC                          00000002
T1OSCEN                           00000003
T1SYNC                            00000002
T2CKPS0                           00000000
T2CKPS1                           00000001
T2CON                             00000012
TEMP1                             00000036
TEMP2                             00000037
TEMP3                             00000038
TEMP4                             00000039
TEMP5                             0000003A
TEMPW                             00000035
TEMP_FSR                          00000072
TEMP_PCLATH                       00000076
TEMP_STATUS                       00000071
TEMP_WORKING                      00000070
TMP0                              00000038
TMP1                              00000036
TMP2                              00000037
TMR0                              00000001
TMR1CS                            00000001
TMR1H                             0000000F
TMR1IE                            00000000
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE 88


SYMBOL TABLE
  LABEL                             VALUE 

TMR1IF                            00000000
TMR1L                             0000000E
TMR1ON                            00000000
TMR2                              00000011
TMR2IE                            00000001
TMR2IF                            00000001
TMR2ON                            00000002
TOUTPS0                           00000003
TOUTPS1                           00000004
TOUTPS2                           00000005
TOUTPS3                           00000006
TRISA                             00000085
TRISB                             00000086
TRISC                             00000087
TRISD                             00000088
TRISE                             00000089
TRISE0                            00000000
TRISE1                            00000001
TRISE2                            00000002
TRMT                              00000001
TX8_9                             00000006
TX9                               00000006
TX9D                              00000000
TXD8                              00000000
TXEN                              00000005
TXIE                              00000004
TXIF                              00000004
TXREG                             00000019
TXSTA                             00000098
UA                                00000001
VS1001                            1
VSADDR_AIADDR                     0000000A
VSADDR_AICTRL0                    0000000D
VSADDR_AICTRL1                    0000000E
VSADDR_AUDATA                     00000005
VSADDR_CLOCKF                     00000003
VSADDR_DECODE_TIME                00000004
VSADDR_HDAT0                      00000008
VSADDR_HDAT1                      00000009
VSADDR_MODE                       00000000
VSADDR_STATUS                     00000001
VSADDR_VOL                        0000000B
VSADDR_WRAM                       00000006
VSADDR_WRAMADDR                   00000007
VSREG_MODE_L                      0000004D
VSREG_STATUS_L                    0000004E
VSREG_VOL_H                       00000050
VSREG_VOL_L                       0000004F
VS_BEEP                           000008BA
VS_END_BEEP                       000008A8
VS_INIT                           000008CE
VS_RD_BYTE                        00000835
VS_RD_REG                         0000086E
VS_SEND_1024_NULL                 00000896
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE 89


SYMBOL TABLE
  LABEL                             VALUE 

VS_SEND_32_NULL                   0000088E
VS_SET_VOLUME                     0000089D
VS_SOFT_RESET                     00000879
VS_WR_BYTE                        00000800
VS_WR_REG                         00000863
VYSLEDEK1                         000000A8
VYSLEDEK2                         000000A9
VYSLEDEK3                         000000AA
VYSLEDEK4                         000000AB
W                                 00000000
WAIT_FOR_DATA                     00000294
WAIT_FOR_READY                    0000029D
WAIT_FOR_READY_FOR_COMMAND        000002A3
WAIT_FOR_VSDREQ                   000008A5
WCOL                              00000007
WR                                00000001
WREN                              00000002
WRERR                             00000003
WR_BLOCK                          00000194
WR_COMMAND                        00000171
WR_DC                             0000016C
WR_DEVICE                         0000018A
WR_FEATURES                       0000018F
WR_LBA1                           0000017B
WR_LBA2                           00000180
WR_LBA3                           00000185
WR_SC                             00000176
WR_USART                          000000E1
Z                                 00000002
ZAPIS_DO_BUFFERU_1                000001DB
ZAPIS_DO_BUFFERU_1__ZAPIS         000001DE
ZKONTROLUJ_ODDIL_FAT32            00000321
ZKONTROLUJ_ODDIL_FAT32__JMENOVKA  00000344
ZKONTROLUJ_ODDIL_FAT32__KONEC     00000369
_BODEN_OFF                        00003FBF
_BODEN_ON                         00003FFF
_CPD_OFF                          00003FFF
_CPD_ON                           00003EFF
_CP_ALL                           00000FCF
_CP_HALF                          00001FDF
_CP_OFF                           00003FFF
_CP_UPPER_256                     00002FEF
_DEBUG_OFF                        00003FFF
_DEBUG_ON                         000037FF
_HS_OSC                           00003FFE
_LP_OSC                           00003FFC
_LVP_OFF                          00003F7F
_LVP_ON                           00003FFF
_PWRTE_OFF                        00003FFF
_PWRTE_ON                         00003FF7
_RC_OSC                           00003FFF
_WDT_OFF                          00003FFB
_WDT_ON                           00003FFF
_WRT_ENABLE_OFF                   00003DFF
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE 90


SYMBOL TABLE
  LABEL                             VALUE 

_WRT_ENABLE_ON                    00003FFF
_XT_OSC                           00003FFD
__16F877                          00000001
nEIN                              00000001


MEMORY USAGE MAP ('X' = Used,  '-' = Unused)

0000 : X---XXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0040 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0080 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
00C0 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0100 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0140 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0180 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
01C0 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0200 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0240 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0280 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
02C0 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0300 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0340 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0380 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
03C0 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0400 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0440 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0480 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
04C0 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0500 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0540 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0580 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
05C0 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0600 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0640 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0680 : XXXXXXXXXXXXXXXX XXXX------------ ---------------- ----------------
0800 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0840 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0880 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
08C0 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0900 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0940 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0980 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
09C0 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0A00 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0A40 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0A80 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0AC0 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXX---------
MPASM 03.90 Released                               HLAVNI.ASM   12-23-2005  11:34:24         PAGE 91


MEMORY USAGE MAP ('X' = Used,  '-' = Unused)


2000 : -------X-------- ---------------- ---------------- ----------------

All other memory blocks unused.

Program Memory Words Used:  2440
Program Memory Words Free:  5752


Errors   :     0
Warnings :     0 reported,     0 suppressed
Messages :     0 reported,   215 suppressed

